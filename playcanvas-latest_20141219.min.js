/*
 PlayCanvas Engine v0.163.0-dev
 revision 33398df

 http://playcanvas.com
 Copyright 2011-2014 PlayCanvas Ltd. All rights reserved.
 Do not distribute.
 Contains: https://github.com/tildeio/rsvp.js - see page for license information
*/
var pc={config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(d){var a,b=[],c=d.length;for(a=0;a<c;++a)b.push(d[a]);return b},type:function(d){if(null===d)return"null";var a=typeof d;return"undefined"==a||"number"==a||"string"==a||"boolean"==a?a:_typeLookup[Object.prototype.toString.call(d)]},extend:function(d,a){var b,c;for(b in a)c=a[b],d[b]="object"==pc.type(c)?pc.extend({},c):
"array"==pc.type(c)?pc.extend([],c):c;return d},isDefined:function(d){return void 0!==d}},_typeLookup=function(){var d={},a,b="Array Object Function Date RegExp Float32Array".split(" ");for(a=0;a<b.length;++a)d["[object "+b[a]+"]"]=b[a].toLowerCase();return d}();"undefined"!==typeof exports&&(exports.pc=pc);(function(){if("undefined"!==typeof document){var d=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenchange",!0,!1,null);document.dispatchEvent(a)},a=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitfullscreenchange",d,!1);document.addEventListener("mozfullscreenchange",d,!1);document.addEventListener("MSFullscreenChange",d,!1);document.addEventListener("webkitfullscreenerror",
a,!1);document.addEventListener("mozfullscreenerror",a,!1);document.addEventListener("MSFullscreenError",a,!1);Element.prototype.requestFullscreen=Element.prototype.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen||function(){};document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;document.fullscreenElement||
Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}});document.fullscreenEnabled||Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,get:function(){return document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}})();pc.extend(pc,function(){var d=function(){this.data=new Float32Array(4);3<=arguments.length?(this.data[0]=arguments[0],this.data[1]=arguments[1],this.data[2]=arguments[2],this.data[3]=4<=arguments.length?arguments[3]:1):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=1)};d.prototype={clone:function(){return new pc.Color(this.r,this.g,this.b,this.a)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},set:function(a,b,c,e){var g=this.data;g[0]=a;
g[1]=b;g[2]=c;g[3]=void 0===e?1:e;return this},fromString:function(a){var b=parseInt(a.replace("#","0x"));7<a.length?a=pc.math.intToBytes32(b):(a=pc.math.intToBytes24(b),a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return this},toString:function(a){var b="#"+(16777216+(parseInt(255*this.r)<<16)+(parseInt(255*this.g)<<8)+parseInt(255*this.b)).toString(16).slice(1);!0===a&&(a=parseInt(255*this.a).toString(16),b=this.a<16/255?b+("0"+a):b+a);return b}};Object.defineProperty(d.prototype,"r",
{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"g",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(d.prototype,"b",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d.prototype,"a",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});return{Color:d}}());pc.guid=function(){return{create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var a=16*Math.random()|0;return("x"==d?a:a&3|8).toString(16)})}}}();pc.time=function(){var d=function(){this._isRunning=!1;this._b=this._a=0};d.prototype.start=function(){this._isRunning=!0;this._a=(new Date).getTime()};d.prototype.stop=function(){this._isRunning=!1;this._b=(new Date).getTime()};d.prototype.getMilliseconds=function(){return this._b-this._a};return{Timer:d,now:function(){return(new Date).getTime()}}}();pc.extend(pc,function(){return{createURI:function(d){var a="";if((d.authority||d.scheme)&&(d.host||d.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(d.host&&d.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(d.path&&d.hostpath)throw Error("Can't have 'path' and 'hostpath' option");d.scheme&&(a+=d.scheme+":");d.authority&&(a+="//"+d.authority);d.host&&(a+=d.host);d.path&&(a+=d.path);d.hostpath&&(a+=d.hostpath);d.query&&(a+="?"+d.query);
d.fragment&&(a+="#"+d.fragment);return a},URI:function(d){d=d.match(/^(([^:\/?\#]+):)?(\/\/([^\/?\#]*))?([^?\#]*)(\?([^\#]*))?(\#(.*))?/);this.scheme=d[2];this.authority=d[4];this.path=d[5];this.query=d[7];this.fragment=d[9];this.toString=function(){var a="";this.scheme&&(a+=this.scheme+":");this.authority&&(a+="//"+this.authority);a+=this.path;this.query&&(a+="?"+this.query);this.fragment&&(a+="#"+this.fragment);return a};this.getQuery=function(){var a,b,c={};this.query&&(a=decodeURIComponent(this.query).split("&"),
a.forEach(function(a){b=a.split("=");c[b[0]]=b[1]},this));return c};this.setQuery=function(a){q="";for(var b in a)a.hasOwnProperty(b)&&(""!==q&&(q+="&"),q+=encodeURIComponent(b)+"="+encodeURIComponent(a[b]));this.query=q}}}}());pc.extend(pc,function(){return{log:{write:function(d){console.log(d)},open:function(){pc.log.write(Date())},info:function(d){console.info("INFO:    "+d)},debug:function(d){console.debug("DEBUG:   "+d)},error:function(d){console.error("ERROR:   "+d)},warning:function(d){console.warn("WARNING: "+d)},alert:function(d){pc.log.write("ALERT:   "+d);alert(d)},assert:function(d,a){!1===d&&(pc.log.write("ASSERT:  "+a),alert("ASSERT failed: "+a))}}}}());
var logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;Function.prototype.extendsFrom=function(d){var a,b,c=function(){};a=this;b=function(){d.apply(this,arguments);a.apply(this,arguments);this.constructor=a};b._super=d.prototype;c.prototype=d.prototype;b.prototype=new c;return b};pc.extend(pc,function(){return{inherits:function(d,a){var b=function(){},c=function(){a.apply(this,arguments);d.apply(this,arguments)};c._super=a.prototype;b.prototype=a.prototype;c.prototype=new b;return c}}}());Function.prototype.bind||(Function.prototype.bind=function(d){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be fBound is not callable");var a=Array.prototype.slice.call(arguments,1),b=this,c=function(){},e=function(){return b.apply(this instanceof c?this:d||window,a.concat(Array.prototype.slice.call(arguments)))};c.prototype=this.prototype;e.prototype=new c;return e});pc.path=function(){return{delimiter:"/",join:function(){var d,a=arguments.length,b=arguments[0];for(d=0;d<a-1;++d){var c=arguments[d],e=arguments[d+1];if(!pc.isDefined(c)||!pc.isDefined(e))throw Error("undefined argument to pc.path.join");b=e[0]===pc.path.delimiter?e:c&&e&&c[c.length-1]!==pc.path.delimiter&&e[0]!==pc.path.delimiter?b+(pc.path.delimiter+e):b+e}return b},split:function(d){var d=d.split(pc.path.delimiter),a=d.slice(d.length-1)[0];return[d.slice(0,d.length-1).join(pc.path.delimiter),
a]},getBasename:function(d){return pc.path.split(d)[1]},getDirectory:function(d){d=d.split(pc.path.delimiter);return d.slice(0,d.length-1).join(pc.path.delimiter)},getExtension:function(d){var a=d.split(".").pop();return a!==d?"."+a:""},isRelativePath:function(d){return"/"!==d.charAt(0)&&null===d.match(/:\/\//)},extractPath:function(d){var a=".",b=d.split("/"),c=0;if(1<b.length){!1===pc.path.isRelativePath(d)&&(a="");for(c=0;c<b.length-1;++c)a+="/"+b[c]}return a}}}();pc.string=function(){return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:this.ASCII_LOWERCASE+this.ASCII_UPPERCASE,format:function(d){var a=0,b,c=pc.makeArray(arguments);c.shift();for(a=0;a<c.length;a++)b=RegExp("\\{"+a+"\\}","gi"),d=d.replace(b,c[a]);return d},startsWith:function(d,a){return 0===d.indexOf(a)},endsWith:function(d,a){return-1!==d.lastIndexOf(a,d.length-a.length)},toBool:function(d,a){if("true"===d)return!0;if(a){if("false"===
d)return!1;throw Error("Not a boolean string");}return!1}}}();pc.extend(pc,function(){return{json:{parse:function(d,a){return JSON.parse(d,a)},stringify:function(d,a,b){return JSON.stringify(d,function(b,e){this[b]instanceof Float32Array&&(e=pc.makeArray(this[b]));return a?a(b,e):e},b)}}}}());pc.cookie=function(){return{set:function(d,a,b){b=b||{};d=d+"="+a;b.path&&(d+=";path="+b.path);b.domain&&(d+=";domain="+b.domain);b.path&&(d+=";path="+b.path);b.secure&&(d+=";secure");d=b.lifetime?d+(";max-age="+86400*b.lifetime):d+";max-age=86400";document.cookie=d},get:function(d){var a,b=document.cookie.split(";"),c,e=b.length;for(c=0;c<e;c++)if(a=b[c].trim(),pc.string.startsWith(a,d))return a.split("=")[1]},remove:function(d,a){a.lifetime=0;pc.cookie.set(d,"",a)}}}();pc.debug=function(){var d=null,a=null,b=null,c=null;return{display:function(e){d||(d=document.createElement("table"),a=document.createElement("tr"),b=document.createElement("td"),c=document.createElement("td"),d.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",d.style.top="0px",d.style.left="0px",d.style.border="thin solid #cccccc",document.body.appendChild(d));d.innerHTML="";for(var g in e){var f=a.cloneNode(),k=b.cloneNode(),h=c.cloneNode();k.textContent=g;h.textContent=
e[g];f.appendChild(k);f.appendChild(h);d.appendChild(f)}}}}();pc.extend(pc,function(){var d=function(a,c){this.objects=[];this.ctor=a;this.name=c.name;this.useNew=void 0===c.useNew||c.useNew;if(this.metrics=c.metrics)this.used=this.total=0};d.prototype={_construct:function(a,c){function e(){return a.apply(this,c)}e.prototype=a.prototype;return new e},allocate:function(){var a;this.objects.length?(a=this.objects.pop(),this.ctor.apply(a,arguments),this.metrics&&this.used++):(a=this.useNew?this._construct(this.ctor,arguments):this.ctor.apply(this,arguments),this.metrics&&
(this.total++,this.used++));return a},free:function(a){this.objects.push(a);this.metrics&&this.used--;if(a.onFree)a.onFree()},usage:function(){return pc.string.format("{0} - total: {1}, used: {2}",this.name,this.total,this.used)}};var a=function(a,c){this._constructor=a;this._pool=[];this._count=0;this._resize(c)};a.prototype={_resize:function(a){if(a>this._pool.length)for(var c=this._pool.length;c<a;c++)this._pool[c]=new this._constructor},allocate:function(){this._count>=this._pool.length&&this._resize(2*
this._pool.length);return this._pool[this._count++]},freeAll:function(){this._count=0}};return{AllocatePool:a,ObjectPool:d}}());pc.events=function(){var d={attach:function(a){var b=pc.events;a.on=b.on;a.off=b.off;a.fire=b.fire;a.hasEvent=b.hasEvent;a.bind=b.on;a.unbind=b.off;return a},on:function(a,b,c){if("string"!=pc.type(a))throw new TypeError("Event name must be a string");var e=this._callbacks||(this._callbacks={});(e[a]||(e[a]=[])).push({callback:b,scope:c||this});return this},off:function(a,b,c){var e=this._callbacks;if(e){if(b){a=e[a];if(!a)return this;for(e=0;e<a.length;e++)if(a[e].callback===b&&(!c||c===a[e].scope))a.splice(e,
1),e--}else e[a]=[];return this}},fire:function(a){var b,c,e,g;if(this._callbacks&&this._callbacks[a]&&(c=this._callbacks[a].length)){e=pc.makeArray(arguments);e.shift();g=this._callbacks[a].slice();for(b=0;b<c;++b)g[b].callback.apply(g[b].scope,e)}return this},hasEvent:function(a){return void 0!==this._callbacks&&void 0!==this._callbacks[a]&&0<this._callbacks[a].length}};d.bind=d.on;d.unbind=d.off;return d}();pc.dom=function(){return{getWidth:function(d){return d.offsetWidth},getHeight:function(d){return d.offsetHeight},setText:function(d,a){d.textContent?d.textContent=a:d.innerText&&(d.innerText=a)},getText:function(d){return d.textContent||d.innerText}}}();pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(d,a,b){return d>=b?b:d<=a?a:d},intToBytes24:function(d){return[d>>16&255,d>>8&255,d&255]},intToBytes32:function(d){return[d>>24&255,d>>16&255,d>>8&255,d&255]},bytesToInt24:function(d,a,b){d.length&&(b=d[2],a=d[1],d=d[0]);return d<<16|a<<8|b},bytesToInt32:function(d,a,b,c){d.length&&(c=d[3],b=d[2],a=d[1],d=d[0]);return(d<<24|a<<16|b<<8|c)>>>32},lerp:function(d,a,b){return d+(a-d)*pc.math.clamp(b,0,1)},lerpAngle:function(d,a,b){180<
a-d&&(a-=360);-180>a-d&&(a+=360);return pc.math.lerp(d,a,pc.math.clamp(b,0,1))},powerOfTwo:function(d){return 0!==d&&!(d&d-1)},nextPowerOfTwo:function(d){d--;d|=d>>1;d|=d>>2;d|=d>>4;d|=d>>8;d|=d>>16;d++;return d},random:function(d,a){return Math.random()*(a-d)+d},smoothstep:function(d,a,b){if(b<=d)return 0;if(b>=a)return 1;b=(b-d)/(a-d);return b*b*(3-2*b)},smootherstep:function(d,a,b){if(b<=d)return 0;if(b>=a)return 1;b=(b-d)/(a-d);return b*b*b*(b*(6*b-15)+10)}};pc.math.intToBytes=pc.math.intToBytes32;
pc.math.bytesToInt=pc.math.bytesToInt32;pc.extend(pc,function(){var d=function(){this.data=new Float32Array(2);2===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*
a[0]+b[1]*a[1]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]},lerp:function(a,b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);e[1]=a[1]+c*(b[1]-a[1]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];
return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;return this},set:function(a,b){var c=this.data;c[0]=a;c[1]=b;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1);return function(){return a}}()});Object.defineProperty(d,"RIGHT",{get:function(){var a=new d(1,0);return function(){return a}}()});Object.defineProperty(d,"UP",{get:function(){var a=new d(0,1);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0);return function(){return a}}()});
return{Vec2:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(3);3===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];g[2]=c[2]+e[2];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];return this},
cross:function(a,b){var c,e,g,f,d,h,l;c=a.data;e=b.data;g=this.data;f=c[0];d=c[1];c=c[2];h=e[0];l=e[1];e=e[2];g[0]=d*e-l*c;g[1]=c*h-e*f;g[2]=f*l-h*d;return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},lerp:function(a,
b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);e[1]=a[1]+c*(b[1]-a[1]);e[2]=a[2]+c*(b[2]-a[2]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];g[2]=c[2]*e[2];return this},normalize:function(){return this.scale(1/this.length())},project:function(a){var b=this.data,a=a.data,c=(b[0]*a[0]+b[1]*a[1]+b[2]*a[2])/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);b[0]=a[0]*c;
b[1]=a[1]*c;b[2]=a[2]*c;return this},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;return this},set:function(a,b,c){var e=this.data;e[0]=a;e[1]=b;e[2]=c;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];g[2]=c[2]-e[2];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(d.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d,"BACK",{get:function(){var a=new d(0,0,1);return function(){return a}}()});Object.defineProperty(d,"DOWN",{get:function(){var a=new d(0,-1,0);return function(){return a}}()});Object.defineProperty(d,"FORWARD",{get:function(){var a=
new d(0,0,-1);return function(){return a}}()});Object.defineProperty(d,"LEFT",{get:function(){var a=new d(-1,0,0);return function(){return a}}()});Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1,1);return function(){return a}}()});Object.defineProperty(d,"RIGHT",{get:function(){var a=new d(1,0,0);return function(){return a}}()});Object.defineProperty(d,"UP",{get:function(){var a=new d(0,1,0);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,
0,0);return function(){return a}}()});return{Vec3:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(4);4===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];b[3]+=a[3];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];g[2]=c[2]+e[2];g[3]=c[3]+e[3];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;
b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},lerp:function(a,b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);
e[1]=a[1]+c*(b[1]-a[1]);e[2]=a[2]+c*(b[2]-a[2]);e[3]=a[3]+c*(b[3]-a[3]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];b[3]*=a[3];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];g[2]=c[2]*e[2];g[3]=c[3]*e[3];return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return this},set:function(a,b,c,e){var g=this.data;g[0]=a;g[1]=b;g[2]=
c;g[3]=e;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];b[3]-=a[3];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];g[2]=c[2]-e[2];g[3]=c[3]-e[3];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+", "+this.data[3]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},
set:function(a){this.data[1]=a}});Object.defineProperty(d.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d.prototype,"w",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1,1,1);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0);return function(){return a}}()});return{Vec4:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(9);9===arguments.length?this.data.set(arguments):this.setIdentity()};d.prototype={clone:function(){return(new pc.Mat3).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===
a[8]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&1===a[4]&&0===a[5]&&0===a[6]&&0===a[7]&&1===a[8]},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},toString:function(){for(var a="[",b=0;9>b;b++)a+=this.data[b],a+=9!==b?", ":"";return a+"]"},transpose:function(){var a=this.data,b;b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=
a[7];a[7]=b;return this}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat3:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(16);16===arguments.length?this.data.set(arguments):this.setIdentity()},a,b,c;a=new pc.Vec3;b=new pc.Vec3;c=new pc.Vec3;var e,g,f;e=new pc.Vec3;g=new pc.Vec3;f=new pc.Vec3;var k=new pc.Vec3;d.prototype={add2:function(a,b){var c=a.data,e=b.data,f=this.data;f[0]=c[0]+e[0];f[1]=c[1]+e[1];f[2]=c[2]+e[2];f[3]=c[3]+e[3];f[4]=c[4]+e[4];f[5]=c[5]+e[5];f[6]=c[6]+e[6];f[7]=c[7]+e[7];f[8]=c[8]+e[8];f[9]=c[9]+e[9];f[10]=c[10]+e[10];f[11]=c[11]+
e[11];f[12]=c[12]+e[12];f[13]=c[13]+e[13];f[14]=c[14]+e[14];f[15]=c[15]+e[15];return this},add:function(a){return this.add2(this,a)},clone:function(){return(new pc.Mat4).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===
a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var c,e,f,g,d,k,z,s,v,A,x,E,D,I,M,y,B,H,C,J;y=a.data;var G=b.data,K=this.data;c=y[0];e=y[1];f=y[2];
g=y[3];d=y[4];k=y[5];z=y[6];s=y[7];v=y[8];A=y[9];x=y[10];E=y[11];D=y[12];I=y[13];M=y[14];y=y[15];B=G[0];H=G[1];C=G[2];J=G[3];K[0]=c*B+d*H+v*C+D*J;K[1]=e*B+k*H+A*C+I*J;K[2]=f*B+z*H+x*C+M*J;K[3]=g*B+s*H+E*C+y*J;B=G[4];H=G[5];C=G[6];J=G[7];K[4]=c*B+d*H+v*C+D*J;K[5]=e*B+k*H+A*C+I*J;K[6]=f*B+z*H+x*C+M*J;K[7]=g*B+s*H+E*C+y*J;B=G[8];H=G[9];C=G[10];J=G[11];K[8]=c*B+d*H+v*C+D*J;K[9]=e*B+k*H+A*C+I*J;K[10]=f*B+z*H+x*C+M*J;K[11]=g*B+s*H+E*C+y*J;B=G[12];H=G[13];C=G[14];J=G[15];K[12]=c*B+d*H+v*C+D*J;K[13]=e*B+
k*H+A*C+I*J;K[14]=f*B+z*H+x*C+M*J;K[15]=g*B+s*H+E*C+y*J;return this},mul:function(a){return this.mul2(this,a)},transformPoint:function(a,b){var c=this.data,e=a.data,b=void 0===b?new pc.Vec3:b;return b.set(e[0]*c[0]+e[1]*c[4]+e[2]*c[8]+c[12],e[0]*c[1]+e[1]*c[5]+e[2]*c[9]+c[13],e[0]*c[2]+e[1]*c[6]+e[2]*c[10]+c[14])},transformVector:function(a,b){var c=this.data,e=a.data,b=void 0===b?new pc.Vec3:b;return b.set(e[0]*c[0]+e[1]*c[4]+e[2]*c[8],e[0]*c[1]+e[1]*c[5]+e[2]*c[9],e[0]*c[2]+e[1]*c[6]+e[2]*c[10])},
setLookAt:function(e,f,g){c.sub2(e,f).normalize();b.copy(g).normalize();a.cross(b,c).normalize();b.cross(c,a);f=this.data;f[0]=a.x;f[1]=a.y;f[2]=a.z;f[3]=0;f[4]=b.x;f[5]=b.y;f[6]=b.z;f[7]=0;f[8]=c.x;f[9]=c.y;f[10]=c.z;f[11]=0;f[12]=e.x;f[13]=e.y;f[14]=e.z;f[15]=1;return this},setFrustum:function(a,b,c,e,f,g){var d,k,z,s,v;d=2*f;k=b-a;z=e-c;s=g-f;v=this.data;v[0]=d/k;v[1]=0;v[2]=0;v[3]=0;v[4]=0;v[5]=d/z;v[6]=0;v[7]=0;v[8]=(b+a)/k;v[9]=(e+c)/z;v[10]=(-g-f)/s;v[11]=-1;v[12]=0;v[13]=0;v[14]=-d*g/s;v[15]=
0;return this},setPerspective:function(a,b,c,e){a=c*Math.tan(a*Math.PI/360);b*=a;return this.setFrustum(-b,b,-a,a,c,e)},setOrtho:function(a,b,c,e,f,g){var d=this.data;d[0]=2/(b-a);d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=2/(e-c);d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=-2/(g-f);d[11]=0;d[12]=-(b+a)/(b-a);d[13]=-(e+c)/(e-c);d[14]=-(g+f)/(g-f);d[15]=1;return this},setFromAxisAngle:function(a,b){var c,e,f,g,d,k,z,s,v,b=b*pc.math.DEG_TO_RAD;c=a.x;e=a.y;f=a.z;g=Math.cos(b);d=Math.sin(b);k=1-g;z=k*c;s=k*e;v=this.data;
v[0]=z*c+g;v[1]=z*e+d*f;v[2]=z*f-d*e;v[3]=0;v[4]=z*e-d*f;v[5]=s*e+g;v[6]=s*f+d*c;v[7]=0;v[8]=z*f+d*e;v[9]=s*f-c*d;v[10]=k*f*f+g;v[11]=0;v[12]=0;v[13]=0;v[14]=0;v[15]=1;return this},setTranslate:function(a,b,c){var e=this.data;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=a;e[13]=b;e[14]=c;e[15]=1;return this},setScale:function(a,b,c){var e=this.data;e[0]=a;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=b;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=c;e[11]=0;e[12]=0;e[13]=0;e[14]=
0;e[15]=1;return this},invert:function(){var a,b,c,e,f,g,d,k,z,s,v,A,x,E,D,I,M,y,B,H,C,J,G,K,P,Q,N,L,R,O;O=this.data;a=O[0];b=O[1];c=O[2];e=O[3];f=O[4];g=O[5];d=O[6];k=O[7];z=O[8];s=O[9];v=O[10];A=O[11];x=O[12];E=O[13];D=O[14];I=O[15];M=a*g-b*f;y=a*d-c*f;B=a*k-e*f;H=b*d-c*g;C=b*k-e*g;J=c*k-e*d;G=z*E-s*x;K=z*D-v*x;P=z*I-A*x;Q=s*D-v*E;N=s*I-A*E;L=v*I-A*D;R=1/(M*L-y*N+B*Q+H*P-C*K+J*G);O[0]=(g*L-d*N+k*Q)*R;O[1]=(-b*L+c*N-e*Q)*R;O[2]=(E*J-D*C+I*H)*R;O[3]=(-s*J+v*C-A*H)*R;O[4]=(-f*L+d*P-k*K)*R;O[5]=(a*
L-c*P+e*K)*R;O[6]=(-x*J+D*B-I*y)*R;O[7]=(z*J-v*B+A*y)*R;O[8]=(f*N-g*P+k*G)*R;O[9]=(-a*N+b*P-e*G)*R;O[10]=(x*C-E*B+I*M)*R;O[11]=(-z*C+s*B-A*M)*R;O[12]=(-f*Q+g*K-d*G)*R;O[13]=(a*Q-b*K+c*G)*R;O[14]=(-x*H+E*y-D*M)*R;O[15]=(z*H-s*y+v*M)*R;return this},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},setTRS:function(a,b,c){var e,f,g,d,k,z,s,v,A,x,E,D,I;e=a.x;f=a.y;a=a.z;g=b.x;d=b.y;k=
b.z;z=b.w;b=c.x;s=c.y;c=c.z;v=g+g;A=d+d;x=k+k;E=g*v;D=g*A;g*=x;I=d*A;d*=x;k*=x;v*=z;A*=z;z*=x;x=this.data;x[0]=(1-(I+k))*b;x[1]=(D+z)*b;x[2]=(g-A)*b;x[3]=0;x[4]=(D-z)*s;x[5]=(1-(E+k))*s;x[6]=(d+v)*s;x[7]=0;x[8]=(g+A)*c;x[9]=(d-v)*c;x[10]=(1-(E+I))*c;x[11]=0;x[12]=e;x[13]=f;x[14]=a;x[15]=1;return this},transpose:function(){var a,b=this.data;a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return this},
invertTo3x3:function(a){var b,c,e,f,g,d,k,z,s,v;s=this.data;v=a.data;a=s[10]*s[5]-s[6]*s[9];b=-s[10]*s[1]+s[2]*s[9];c=s[6]*s[1]-s[2]*s[5];e=-s[10]*s[4]+s[6]*s[8];f=s[10]*s[0]-s[2]*s[8];g=-s[6]*s[0]+s[2]*s[4];d=s[9]*s[4]-s[5]*s[8];k=-s[9]*s[0]+s[1]*s[8];z=s[5]*s[0]-s[1]*s[4];s=s[0]*a+s[1]*e+s[2]*d;if(0===s)return console.warn("pc.Mat4#invertTo3x3: Matrix not invertible"),this;s=1/s;v[0]=s*a;v[1]=s*b;v[2]=s*c;v[3]=s*e;v[4]=s*f;v[5]=s*g;v[6]=s*d;v[7]=s*k;v[8]=s*z;return this},getTranslation:function(a){a=
void 0===a?new pc.Vec3:a;return a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[8],this.data[9],this.data[10])},getScale:function(a){a=void 0===a?new pc.Vec3:a;this.getX(e);this.getY(g);this.getZ(f);a.set(e.length(),g.length(),f.length());
return a},setFromEulerAngles:function(a,b,c){var e,f,g,d,a=a*pc.math.DEG_TO_RAD,b=b*pc.math.DEG_TO_RAD,c=c*pc.math.DEG_TO_RAD;e=Math.sin(-a);a=Math.cos(-a);f=Math.sin(-b);b=Math.cos(-b);g=Math.sin(-c);c=Math.cos(-c);d=this.data;d[0]=b*c;d[1]=-b*g;d[2]=f;d[3]=0;d[4]=a*g+c*e*f;d[5]=a*c-e*f*g;d[6]=-b*e;d[7]=0;d[8]=e*g-a*c*f;d[9]=c*e+a*f*g;d[10]=a*b;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return this},getEulerAngles:function(a){var b,c,e,f,g,d,a=void 0===a?new pc.Vec3:a;this.getScale(k);e=k.x;b=k.y;f=
k.z;g=this.data;c=Math.asin(-g[2]/e);d=0.5*Math.PI;c<d?c>-d?(b=Math.atan2(g[6]/b,g[10]/f),e=Math.atan2(g[1]/e,g[0]/e)):(e=0,b=-Math.atan2(g[4]/b,g[5]/b)):(e=0,b=Math.atan2(g[4]/b,g[5]/b));return a.set(b,c,e).scale(pc.math.RAD_TO_DEG)},toString:function(){var a,b;b="[";for(a=0;16>a;a+=1)b+=this.data[a],b+=15!==a?", ":"";return b+"]"}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat4:d}}());pc.extend(pc,function(){var d=function(a,b,c,e){this.x=void 0===a?0:a;this.y=void 0===b?0:b;this.z=void 0===c?0:c;this.w=void 0===e?1:e};d.prototype={clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},getEulerAngles:function(a){var b,c,e,g,f,d,a=void 0===a?new pc.Vec3:
a;e=this.x;g=this.y;f=this.z;d=this.w;c=2*(d*g-e*f);-0.99999>=c?(b=2*Math.atan2(e,d),c=-Math.PI/2,e=0):0.99999<=c?(b=2*Math.atan2(e,d),c=Math.PI/2,e=0):(b=Math.atan2(2*(d*e+g*f),1-2*(e*e+g*g)),c=Math.asin(c),e=Math.atan2(2*(d*f+e*g),1-2*(g*g+f*f)));return a.set(b,c,e).scale(pc.math.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){var a,b,c,e;a=this.x;b=this.y;c=this.z;e=this.w;return Math.sqrt(a*a+b*b+c*c+e*e)},lengthSq:function(){var a=this.data;return a[0]*a[0]+
a[1]*a[1]+a[2]*a[2]},mul:function(a){var b,c,e,g,f,d,h;b=this.x;c=this.y;e=this.z;g=this.w;f=a.x;d=a.y;h=a.z;a=a.w;this.x=g*f+b*a+c*h-e*d;this.y=g*d+c*a+e*f-b*h;this.z=g*h+e*a+b*d-c*f;this.w=g*a-b*f-c*d-e*h;return this},mul2:function(a,b){var c,e,g,f,d,h,l,n;c=a.x;e=a.y;g=a.z;f=a.w;d=b.x;h=b.y;l=b.z;n=b.w;this.x=f*d+c*n+e*l-g*h;this.y=f*h+e*n+g*d-c*l;this.z=f*l+g*n+c*h-e*d;this.w=f*n-c*d-e*h-g*l;return this},normalize:function(){var a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=
a,this.y*=a,this.z*=a,this.w*=a);return this},set:function(a,b,c,e){this.x=a;this.y=b;this.z=c;this.w=e;return this},setFromAxisAngle:function(a,b){var c,e,b=b*0.5*pc.math.DEG_TO_RAD;c=Math.sin(b);e=Math.cos(b);this.x=c*a.x;this.y=c*a.y;this.z=c*a.z;this.w=e;return this},setFromEulerAngles:function(a,b,c){var e,g,f;e=0.5*pc.math.DEG_TO_RAD;a*=e;b*=e;c*=e;e=Math.sin(a);a=Math.cos(a);g=Math.sin(b);b=Math.cos(b);f=Math.sin(c);c=Math.cos(c);this.x=e*b*c-a*g*f;this.y=a*g*c+e*b*f;this.z=a*b*f-e*g*c;this.w=
a*b*c+e*g*f;return this},setFromMat4:function(a){var b,c,e,g,f,d,h,l,n,r,m,a=a.data;b=a[0];c=a[1];e=a[2];g=a[4];f=a[5];d=a[6];h=a[8];l=a[9];a=a[10];n=1/Math.sqrt(b*b+c*c+e*e);r=1/Math.sqrt(g*g+f*f+d*d);m=1/Math.sqrt(h*h+l*l+a*a);b*=n;c*=n;e*=n;g*=r;f*=r;d*=r;h*=m;l*=m;a*=m;n=b+f+a;0<=n?(b=Math.sqrt(n+1),this.w=0.5*b,b=0.5/b,this.x=(d-l)*b,this.y=(h-e)*b,this.z=(c-g)*b):b>f?b>a?(b=Math.sqrt(b-(f+a)+1),this.x=0.5*b,b=0.5/b,this.w=(d-l)*b,this.y=(c+g)*b,this.z=(e+h)*b):(b=Math.sqrt(a-(b+f)+1),this.z=
0.5*b,b=0.5/b,this.w=(c-g)*b,this.x=(h+e)*b,this.y=(l+d)*b):f>a?(b=Math.sqrt(f-(a+b)+1),this.y=0.5*b,b=0.5/b,this.w=(h-e)*b,this.z=(d+l)*b,this.x=(g+c)*b):(b=Math.sqrt(a-(b+f)+1),this.z=0.5*b,b=0.5/b,this.w=(c-g)*b,this.x=(h+e)*b,this.y=(l+d)*b);return this},slerp:function(a,b,c){var e,g,f,d,h,l;e=a.x;g=a.y;f=a.z;a=a.w;d=b.x;h=b.y;l=b.z;var b=b.w,n=a*b+e*d+g*h+f*l;0>n&&(b=-b,d=-d,h=-h,l=-l,n=-n);if(1<=Math.abs(n))return this.w=a,this.x=e,this.y=g,this.z=f,this;var r=Math.acos(n),m=Math.sqrt(1-n*n);
if(0.001>Math.abs(m))return this.w=0.5*a+0.5*b,this.x=0.5*e+0.5*d,this.y=0.5*g+0.5*h,this.z=0.5*f+0.5*l,this;n=Math.sin((1-c)*r)/m;c=Math.sin(c*r)/m;this.w=a*n+b*c;this.x=e*n+d*c;this.y=g*n+h*c;this.z=f*n+l*c;return this},transformVector:function(a,b){void 0===b&&(b=new pc.Vec3);var c=a.x,e=a.y,g=a.z,f=this.x,d=this.y,h=this.z,l=this.w,n=l*c+d*g-h*e,r=l*e+h*c-f*g,m=l*g+f*e-d*c,c=-f*c-d*e-h*g;b.x=n*l+c*-f+r*-h-m*-d;b.y=r*l+c*-d+m*-f-n*-h;b.z=m*l+c*-h+n*-d-r*-f;return b},toString:function(){return"["+
this.x+", "+this.y+", "+this.z+", "+this.w+"]"}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0);return function(){return a}}()});return{Quat:d}}());pc.extend(pc,function(){var d=function(a){this.keys=[];this.type=1;this.tension=0.5;if(a)for(var b=0;b<a.length-1;b+=2)this.keys.push([a[b],a[b+1]]);this.sort()};d.prototype={add:function(a,b){for(var c=this.keys,e=c.length,g=0;g<e&&!(c[g][0]>a);g++);c=[a,b];this.keys.splice(g,0,c);return c},get:function(a){return this.keys[a]},sort:function(){this.keys.sort(function(a,b){return a[0]-b[0]})},value:function(a){var b=this.keys;if(!b.length)return 0;if(a<b[0][0])return b[0][1];if(a>b[b.length-1][0])return b[b.length-
1][1];for(var c=0,e=b.length?b[0][1]:0,g=1,f=0,d=0,h=b.length;d<h;d++){if(b[d][0]===a)return b[d][1];f=b[d][1];if(a<b[d][0]){g=b[d][0];break}c=b[d][0];e=b[d][1]}h=g-c;a=0===h?0:(a-c)/h;if(1===this.type)a*=a*(3-2*a);else if(2===this.type||3===this.type){var h=e+(e-f),l=f+(f-e),n=g=c=g-c;0<d&&(d-=1);0<d&&(h=b[d-1][1],g=b[d][0]-b[d-1][0]);b.length>d+1&&(c=b[d+1][0]-b[d][0]);b.length>d+2&&(n=b[d+2][0]-b[d+1][0],l=b[d+2][1]);h=e+(h-e)*c/g;l=f+(l-f)*c/n;return 2===this.type?this._interpolateCatmullRom(h,
e,f,l,a):this._interpolateCardinal(h,e,f,l,a,this.tension)}return pc.math.lerp(e,f,a)},_interpolateHermite:function(a,b,c,e,g){var f=g*g,d=g*g*g;return a*(2*d-3*f+1)+b*(-2*d+3*f)+c*(d-2*f+g)+e*(d-f)},_interpolateCardinal:function(a,b,c,e,g,f){return this._interpolateHermite(b,c,f*(c-a),f*(e-b),g)},_interpolateCatmullRom:function(a,b,c,e,g){return this._interpolateCardinal(a,b,c,e,g,0.5)},closest:function(a){for(var b=this.keys,c=b.length,e=2,g=null,f=0;f<c;f++){var d=Math.abs(a-b[f][0]);if(e>=d)e=
d,g=b[f];else break}return g},clone:function(){var a=new pc.Curve;a.keys=pc.extend(a.keys,this.keys);a.type=this.type;return a},quantize:function(a){for(var a=Math.max(a,2),b=new Float32Array(a),c=1/(a-1),e=0;e<a;e++){var g=this.value(c*e);b[e]=g}return b}};Object.defineProperty(d.prototype,"length",{get:function(){return this.keys.length}});return{Curve:d,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3}}());pc.extend(pc,function(){var d=function(){var a;this.curves=[];this._type=pc.CURVE_SMOOTHSTEP;if(1<arguments.length)for(a=0;a<arguments.length;a++)this.curves.push(new pc.Curve(arguments[a]));else if(0===arguments.length)this.curves.push(new pc.Curve);else{var b=arguments[0];if("number"===pc.type(b))for(a=0;a<b;a++)this.curves.push(new pc.Curve);else for(a=0;a<b.length;a++)this.curves.push(new pc.Curve(b[a]))}};d.prototype={get:function(a){return this.curves[a]},value:function(a,b){var c=this.curves.length,
b=b||[];b.length=c;for(var e=0;e<c;e++)b[e]=this.curves[e].value(a);return b},clone:function(){var a=new pc.CurveSet;a.curves=[];for(var b=0;b<this.curves.length;b++)a.curves.push(this.curves[b].clone());a._type=this._type;return a},quantize:function(a){for(var a=Math.max(a,2),b=this.curves.length,c=new Float32Array(a*b),e=1/(a-1),g=[],f=0;f<a;f++){var d=this.value(e*f,g);if(1==b)c[f]=d[0];else for(var h=0;h<b;h++)c[f*b+h]=d[h]}return c}};Object.defineProperty(d.prototype,"length",{get:function(){return this.curves.length}});
Object.defineProperty(d.prototype,"type",{get:function(){return this._type},set:function(a){this._type=a;for(var b=0;b<this.curves.length;b++)this.curves[b].type=a}});return{CurveSet:d}}());pc.shape=function(){var d=function(){};d.prototype={containsPoint:function(){throw Error("Shape hasn't implemented containsPoint");}};return{Shape:d,Type:{CAPSULE:"Capsule",CONE:"Cone",CYLINDER:"Cylinder",CIRCLE:"Circle",RECT:"Rect"}}}();pc.shape.intersection=function(){return{aabbAabb:function(d,a){var b=d.getMax(),c=d.getMin(),e=a.getMax(),g=a.getMin();return c[0]<=e[0]&&b[0]>=g[0]&&c[1]<=e[1]&&b[1]>=g[1]&&c[2]<=e[2]&&b[2]>=g[2]},rayAabb:function(d,a,b){var c=new pc.Vec3,e,g=new pc.Vec3;e=new pc.Vec3;c.sub2(d,b.center);d=new pc.Vec3(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z));e.mul2(c,a);if(d.x>b.halfExtents.x&&0<=e.x||d.y>b.halfExtents.y&&0<=e.y||d.z>b.halfExtents.z&&0<=e.z)return!1;e=new pc.Vec3(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z));
g.cross(a,c);g.set(Math.abs(g.x),Math.abs(g.y),Math.abs(g.z));return g.x>b.halfExtents.y*e.z+b.halfExtents.z*e.y||g.y>b.halfExtents.x*e.z+b.halfExtents.z*e.x||g.z>b.halfExtents.x*e.y+b.halfExtents.y*e.x?!1:!0},raySphere:function(d,a,b,c){var e=new pc.Vec3,g=0,f=0,k=0,k=0,c=c||{};e.sub2(d,b.center);if(e.dot(e)<b.radius*b.radius)return c.success=!0,c.t=0,!0;g=a.dot(a);f=2*a.dot(e);k=b.center.dot(b.center);k+=d.dot(d);k-=2*b.center.dot(d);k-=b.radius*b.radius;k=f*f-4*g*k;if(0>k)return c.success=!1,c.t=
0,!1;c.success=!0;c.t=(-f-Math.sqrt(k))/(2*g);return!0},rayTriangle:function(d,a,b,c){var e=d.clone().sub(b.v0),e=-b.n.dot(e),g=b.n.dot(a);if(1E-8>Math.fabs(g))return 0===e?2:0;e/=g;if(0>e)return 0;a=a.clone().scale(e);c.add2(d,a);c=(new pc.Vec3).sub2(c,b.v0);d=c.dot(b.u);c=c.dot(b.v);a=(b.uv*c-b.vv*d)/b.d;if(0>a||1<a)return 0;b=(b.uv*d-b.uu*c)/b.d;return 0>b||1<a+b?0:1}}}();pc.extend(pc.shape,function(){pc.shape.Type.AABB="Aabb";var d=function(a,b){this.center=a||new pc.Vec3(0,0,0);this.halfExtents=b||new pc.Vec3(0.5,0.5,0.5);this.type=pc.shape.Type.AABB},d=pc.inherits(d,pc.shape.Shape);d.prototype.add=function(a){var b=this.center,c=this.halfExtents,e=b.x-c.x,g=b.x+c.x,f=b.y-c.y,d=b.y+c.y,h=b.z-c.z,l=b.z+c.z,n=a.center,r=a.halfExtents,a=n.x-r.x,m=n.x+r.x,w=n.y-r.y,u=n.y+r.y,F=n.z-r.z,n=n.z+r.z;a<e&&(e=a);m>g&&(g=m);w<f&&(f=w);u>d&&(d=u);F<h&&(h=F);n>l&&(l=n);b.set(e+
g,f+d,h+l).scale(0.5);c.set(g-e,d-f,l-h).scale(0.5)};d.prototype.copy=function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type};d.prototype.setMinMax=function(a,b){this.center.add2(b,a).scale(0.5);this.halfExtents.sub2(b,a).scale(0.5)};d.prototype.getMin=function(){return this.center.clone().sub(this.halfExtents)};d.prototype.getMax=function(){return this.center.clone().add(this.halfExtents)};d.prototype.containsPoint=function(a){var b=this.getMin(),c=this.getMax(),
e;for(e=0;3>e;++e)if(a.data[e]<b.data[e]||a.data[e]>c.data[e])return!1;return!0};d.prototype.setFromTransformedAabb=function(a,b){var c=this.center,e=this.halfExtents,g=a.center.data,f=a.halfExtents.data,b=b.data,d=b[0],h=b[4],l=b[8],n=b[1],r=b[5],m=b[9],w=b[2],u=b[6],F=b[10],z=Math.abs(d),s=Math.abs(h),v=Math.abs(l),A=Math.abs(n),x=Math.abs(r),E=Math.abs(m),D=Math.abs(w),I=Math.abs(u),M=Math.abs(F);c.set(b[12]+d*g[0]+h*g[1]+l*g[2],b[13]+n*g[0]+r*g[1]+m*g[2],b[14]+w*g[0]+u*g[1]+F*g[2]);e.set(z*f[0]+
s*f[1]+v*f[2],A*f[0]+x*f[1]+E*f[2],D*f[0]+I*f[1]+M*f[2])};d.prototype.compute=function(a){for(var b=new pc.Vec3(a[0],a[1],a[2]),c=new pc.Vec3(a[0],a[1],a[2]),e=a.length/3,g=1;g<e;g++){var f=a[3*g+0],d=a[3*g+1],h=a[3*g+2];f<b.x&&(b.x=f);d<b.y&&(b.y=d);h<b.z&&(b.z=h);f>c.x&&(c.x=f);d>c.y&&(c.y=d);h>c.z&&(c.z=h)}this.setMinMax(b,c)};return{Aabb:d}}());pc.extend(pc.shape,function(){function d(a,b){this.transform=void 0===a?new pc.Mat4:a;this.halfExtents=void 0===b?new pc.Vec3(0.5,0.5,0.5):b;this.type=pc.shape.Type.BOX}pc.shape.Type.BOX="Box";var a=new pc.Vec3,b=new pc.Vec3,c=new pc.Mat4,e=new pc.Mat4,d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(g){this.transform.getTranslation(a);var f=this.getHalfExtents();c.copy(this.transform);b.copy(f).scale(2);e.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,b);c.mul(e).invert();c.transformPoint(g,
b);return-0.5>b.x||0.5<b.x||-0.5>b.y||0.5<b.y||-0.5>b.z||0.5<b.z?!1:!0};d.prototype.getHalfExtents=function(){return this.halfExtents};return{Box:d}}());pc.extend(pc.shape,function(){pc.shape.Type.FRUSTUM="Frustum";var d=new pc.Mat4,a=function(a,c){a=a||(new pc.Mat4).setPerspective(90,16/9,0.1,1E3);c=c||new pc.Mat4;this.planes=[];for(var e=0;6>e;e++)this.planes[e]=[];this.update(a,c);this.type=pc.shape.Type.FRUSTUM},a=pc.inherits(a,pc.shape.Shape);a.prototype.update=function(a,c){d.mul2(a,c);var e=d.data;this.planes[0][0]=e[3]-e[0];this.planes[0][1]=e[7]-e[4];this.planes[0][2]=e[11]-e[8];this.planes[0][3]=e[15]-e[12];t=Math.sqrt(this.planes[0][0]*
this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=t;this.planes[0][1]/=t;this.planes[0][2]/=t;this.planes[0][3]/=t;this.planes[1][0]=e[3]+e[0];this.planes[1][1]=e[7]+e[4];this.planes[1][2]=e[11]+e[8];this.planes[1][3]=e[15]+e[12];t=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=t;this.planes[1][1]/=t;this.planes[1][2]/=t;this.planes[1][3]/=t;this.planes[2][0]=
e[3]+e[1];this.planes[2][1]=e[7]+e[5];this.planes[2][2]=e[11]+e[9];this.planes[2][3]=e[15]+e[13];t=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=t;this.planes[2][1]/=t;this.planes[2][2]/=t;this.planes[2][3]/=t;this.planes[3][0]=e[3]-e[1];this.planes[3][1]=e[7]-e[5];this.planes[3][2]=e[11]-e[9];this.planes[3][3]=e[15]-e[13];t=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+
this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=t;this.planes[3][1]/=t;this.planes[3][2]/=t;this.planes[3][3]/=t;this.planes[4][0]=e[3]-e[2];this.planes[4][1]=e[7]-e[6];this.planes[4][2]=e[11]-e[10];this.planes[4][3]=e[15]-e[14];t=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=t;this.planes[4][1]/=t;this.planes[4][2]/=t;this.planes[4][3]/=t;this.planes[5][0]=e[3]+e[2];this.planes[5][1]=e[7]+e[6];this.planes[5][2]=
e[11]+e[10];this.planes[5][3]=e[15]+e[14];t=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=t;this.planes[5][1]/=t;this.planes[5][2]/=t;this.planes[5][3]/=t};a.prototype.containsPoint=function(a){for(var c=0;6>c;c++)if(0>=this.planes[c][0]*a.x+this.planes[c][1]*a.y+this.planes[c][2]*a.z+this.planes[c][3])return!1;return!0};a.prototype.containsSphere=function(a){var c=0,e;for(p=0;6>p;p++){e=this.planes[p][0]*
a.center.x+this.planes[p][1]*a.center.y+this.planes[p][2]*a.center.z+this.planes[p][3];if(e<=-a.radius)return 0;e>a.radius&&c++}return 6===c?2:1};return{Frustum:a}}());pc.extend(pc.shape,function(){pc.shape.Type.PLANE="Plane";var d=function(a,b){this.normal=b||new pc.Vec3(0,0,1);this.point=a||new pc.Vec3(0,0,0);this.d=-this.normal.dot(this.point);this.type=pc.shape.Type.PLANE},d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(){return!1};d.prototype.distance=function(a){return this.normal.dot(a)+this.d};d.prototype.intersect=function(a,b){var c=this.distance(a),e=this.distance(b);return c/(c-e)};d.prototype.intersectPosition=function(a,b){var c=
this.intersect(a,b),e=new pc.Vec3;e.lerp(a,b,c);return e};return{Plane:d}}());pc.extend(pc.shape,function(){function d(a,b){this.center=void 0===a?new pc.Vec3(0,0,0):a;this.radius=void 0===b?1:b;this.type=pc.shape.Type.SPHERE}pc.shape.Type.SPHERE="Sphere";var d=pc.inherits(d,pc.shape.Shape),a=d.prototype,b=new pc.Vec3;a.containsPoint=function(a){var a=b.sub2(a,this.center).lengthSq(),e=this.radius;return a<e*e};d.prototype.compute=function(a){var b,g=a.length/3,f=new pc.Vec3(0,0,0),d=new pc.Vec3(0,0,0),h=new pc.Vec3(0,0,0);for(b=0;b<g;b++)f.set(a[3*b],a[3*b+1],a[3*b+2]),h.addSelf(f),
0===b%100&&(h.scale(1/g),d.add(h),h.set(0,0,0));h.scale(1/g);d.add(h);this.center.copy(d);d=0;h=new pc.Vec3(0,0,0);for(b=0;b<g;b++)f.set(a[3*b],a[3*b+1],a[3*b+2]),h.sub2(f,this.center),d=Math.max(h.lengthSq(),d);this.radius=Math.sqrt(d)};d.prototype.intersectRay=function(a,b){var g=a.clone().sub(this.center),f=g.dot(b),g=g.dot(g)-this.radius*this.radius;if(0<g&&0<f)return null;g=f*f-g;if(0>g)return null;t=Math.abs(-f-Math.sqrt(g));return b.clone().scale(t).add(a)};return{Sphere:d}}());pc.extend(pc.shape,function(){pc.shape.Type.TORUS="Torus";var d=function(a,b,c){this.transform=a;this.iradius=b;this.oradius=c;this.type=pc.shape.Type.TORUS},d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(){throw Error("Not implemented yet");};return{Torus:d}}());pc.resources={};pc.extend(pc.resources,function(){var d=function(){void 0===window.RSVP&&logERROR("Missing RSVP library");this._types={};this._handlers={};this._requests={};this._cache={};this._hashes={};this._canonicals={};this._sequence=this._loaded=this._requested=0;this.cache=!0;pc.events.attach(this)};d.prototype={createFileRequest:function(a,c){return new this._types[c](a)},registerHandler:function(a,c){var e=new a;if(""===e.type)throw Error("ResourceRequests must have a type");this._types[e.type]=a;this._handlers[e.type]=
c;c.setLoader(this)},request:function(a,c){var c=c||{},e=this,g=c.parent;c.cache=e.cache;return new pc.promise.Promise(function(f,d){var h,l;void 0===a.length&&(a=[a]);var n=[],r=[];h=0;for(l=a.length;h<l;h++){var m=e._findExistingRequest(a[h]);m!==a[h]&&(m.data=a[h].data);e._makeCanonical(m);r.push(e._request(m,c));n.push(m);g&&g.children.push(m)}var w=function(a,b){var c=[],g=[];b.forEach(function(a){a.children.forEach(function(a){g.push(a);c.push.apply(c,a.promises)})});c.length?pc.promise.all(c).then(function(){w(a,
g,c)},function(a){d(a)}):(e.fire("complete",a),f(a))};pc.promise.all(r).then(function(a){w(a,n,r)},function(a){d(a)})})},open:function(a,c,e){a=new a;return this._handlers[a.type].open(c,a,e)},registerHash:function(a,c){this._hashes[c]||(this._hashes[c]=a);this._canonicals[a]||(this._canonicals[a]=c)},unregisterHash:function(a){var c=this.getHash(a);c&&(delete this._canonicals[c],delete this._hashes[a])},getHash:function(a){return this._hashes[a]},addToCache:function(a,c){var e=this.getHash(a);e&&
(this._cache[e]=c)},getFromCache:function(a){return(a=this.getHash(a))?this._cache[a]:null},removeFromCache:function(a){if(a=this.getHash(a))delete this._cache[a];else return null},resetProgress:function(){this._loaded=this._requested=0},_request:function(a,c){var e=this,g={};for(key in c)g[key]=c[key];null===a.id&&(a.id=this._sequence++);this.fire("request",a);a.promises.length?a.promises.push(new pc.promise.Promise(function(c){a.promises[0].then(function(g){g=e._postOpen(g,a);c(g)})})):a.promises[0]=
new pc.promise.Promise(function(c,d){var h=e._handlers[a.type];if(h){var l=e.getFromCache(a.canonical);l&&(void 0===a.Type||l instanceof a.Type)?(l=e._postOpen(l,a),c(l)):h.load(a,g).then(function(h){try{var l=e._open(h,a,g);l&&(l=e._postOpen(l,a));c(l)}catch(m){d(m)}},function(c){e.fire("error",a,c);d(c)})}else h="Missing handler for type: "+a.type,e.fire("error",a,h),d(h)});e._requests[a.canonical]=a;this._requested++;return a.promises[a.promises.length-1]},_open:function(a,c,e){return this._handlers[c.type].open(a,
c,e)},_postOpen:function(a,c){this.addToCache(c.canonical,a);a=this._handlers[c.type].clone(a,c);delete this._requests[c.canonical];this._loaded++;this.fire("progress",this._loaded/this._requested);this.fire("load",c,a);return a},_makeCanonical:function(a){var c=this.getHash(a.identifier);a.canonical=c&&this._canonicals[c]?this._canonicals[c]:a.identifier},_findExistingRequest:function(a){var c=this._requests[a.canonical];return c?c.type!==a.type||c.result||a.result?a:c:a}};var a=function(){};a.prototype=
{setLoader:function(a){this._loader=a},load:function(){throw Error("Not implemented");},open:function(){throw Error("Not implemented");},clone:function(a){return a}};return{ResourceLoader:d,ResourceHandler:a,ResourceRequest:function(a,c,e){this.id=null;this.canonical=a;this.alternatives=[];this.promises=[];this.children=[];this.data=c;this.result=e;this.identifier=a}}}());pc.extend(pc.resources,function(){var d=function(a,b){b.on("request",this.handleRequest,this);b.on("load",this.handleLoad,this);b.on("error",this.handleError,this);b.on("progress",this.handleProgress,this);this.addCss();this._element=a;this._domCreate()};d.prototype={addCss:function(){var a=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=".pc-resourceloaderdisplay-root {\n   font-family: sans-serif;\n   font-size: 0.7em;\n   color: #aaa;\n   border-collapse: collapse;\n   position: absolute;\n   top: 10px;\n   left: 10px;\n   background-color: black;\n   opacity: 0.6;\n}\n.pc-resourceloaderdisplay-root td {\n   border: 1px solid #aaa;\n}\n.pc-resourceloaderdisplay-subtable {\n   border-collapse: collapse;\n}";
else{var b=document.createTextNode(".pc-resourceloaderdisplay-root {\n   font-family: sans-serif;\n   font-size: 0.7em;\n   color: #aaa;\n   border-collapse: collapse;\n   position: absolute;\n   top: 10px;\n   left: 10px;\n   background-color: black;\n   opacity: 0.6;\n}\n.pc-resourceloaderdisplay-root td {\n   border: 1px solid #aaa;\n}\n.pc-resourceloaderdisplay-subtable {\n   border-collapse: collapse;\n}");a.appendChild(b)}},handleRequest:function(a){console.warn("request: "+a.id);this._domAddRequest(a)},
handleLoad:function(a){console.warn("load: "+a.id);if(a=document.getElementsByClassName("pc-resourcesloaderdisplay-progress-"+a.id))for(var b=0;b<a.length;b++)a[b].textContent="100%"},handleError:function(a,b){var c=document.getElementsByClassName("pc-resourcesloaderdisplay-progress-"+a.id);if(c)for(var e=0;e<c.length;e++)c[e].textContent=b},handleProgress:function(){},_domCreate:function(){this._rootTable=document.createElement("table");this._rootTable.setAttribute("class","pc-resourceloaderdisplay-root");
this._element.appendChild(this._rootTable)},_domAddRequest:function(a){var b="pc-resourcesloaderdisplay-progress-"+a.id,c=document.createElement("tr"),e=document.createElement("td");e.textContent=a.identifier;a=document.createElement("td");a.className=b;a.textContent="0%";c.appendChild(e);c.appendChild(a);this._rootTable.appendChild(c)},_sanitizeId:function(a){return a.replace(/\//,"").replace(/\./,"")}};return{ResourceLoaderDisplay:d}}());pc.extend(pc.resources,function(){var d=function(a){this.cache={};this.loader=a};d.prototype={getTexture:function(a){return(a=this.loader.getHash(a))&&this.cache[a]?this.cache[a]:null},addTexture:function(a,b){var c=this.loader.getHash(a);c&&(this.cache[c]=b)}};return{TextureCache:d}}());(function(){var d={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CLEARFLAG_COLOR:1,
CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,
PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",
SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",
SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,
UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16};pc.extend(pc,d);pc.gfx={};pc.extend(pc.gfx,d)})();pc.extend(pc,function(){var d=function(a){this.name=a;this.value=null;this.versionObject=new pc.VersionedObject};d.prototype={setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(){return this.value}};return{ScopeId:d}}());pc.extend(pc,function(){var d=function(a){this.name=a;this.variables={};this.namespaces={}};d.prototype={resolve:function(a){!1===this.variables.hasOwnProperty(a)&&(this.variables[a]=new pc.ScopeId(a));return this.variables[a]},getSubSpace:function(a){!1===this.namespaces.hasOwnProperty(a)&&(this.namespaces[a]=new pc.ScopeSpace(a),logDEBUG("Added ScopeSpace: "+a));return this.namespaces[a]}};return{ScopeSpace:d}}());pc.extend(pc,function(){var d=function(){this.revision=this.globalId=0};d.prototype={equals:function(a){return this.globalId===a.globalId&&this.revision===a.revision},notequals:function(a){return this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}};return{Version:d}}());pc.extend(pc,function(){var d=0,a=function(){d++;this.version=new pc.Version;this.version.globalId=d};a.prototype={increment:function(){this.version.revision++}};return{VersionedObject:a}}());pc.extend(pc,function(){function d(f,g){this.index=0;switch(g.dataType){case pc.ELEMENTTYPE_INT8:this.array=new Int8Array(f,g.offset);break;case pc.ELEMENTTYPE_UINT8:this.array=new Uint8Array(f,g.offset);break;case pc.ELEMENTTYPE_INT16:this.array=new Int16Array(f,g.offset);break;case pc.ELEMENTTYPE_UINT16:this.array=new Uint16Array(f,g.offset);break;case pc.ELEMENTTYPE_INT32:this.array=new Int32Array(f,g.offset);break;case pc.ELEMENTTYPE_UINT32:this.array=new Uint32Array(f,g.offset);break;case pc.ELEMENTTYPE_FLOAT32:this.array=
new Float32Array(f,g.offset)}switch(g.numComponents){case 1:this.set=a;break;case 2:this.set=b;break;case 3:this.set=c;break;case 4:this.set=e}}function a(a){this.array[this.index]=a}function b(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function c(a,b,c){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c}function e(a,b,c,e){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c;this.array[this.index+3]=e}function g(a){this.vertexBuffer=
a;this.buffer=this.vertexBuffer.lock();this.setters=[];this.element={};for(var a=this.vertexBuffer.getFormat(),b=0;b<a.elements.length;b++){var c=a.elements[b];this.setters[b]=new d(this.buffer,c);this.element[c.name]=this.setters[b]}}g.prototype={next:function(){for(var a=0,b=this.setters,c=this.setters.length,e=this.vertexBuffer.getFormat();a<c;){var g=b[a++];g.index+=e.size/g.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}};return{VertexIterator:g}}());pc.extend(pc,function(){var d=[];d[pc.ELEMENTTYPE_INT8]=1;d[pc.ELEMENTTYPE_UINT8]=1;d[pc.ELEMENTTYPE_INT16]=2;d[pc.ELEMENTTYPE_UINT16]=2;d[pc.ELEMENTTYPE_INT32]=4;d[pc.ELEMENTTYPE_UINT32]=4;d[pc.ELEMENTTYPE_FLOAT32]=4;return{VertexFormat:function(a,b){var c;this.elements=[];c=this.size=0;for(var e=b.length;c<e;c++){var g=b[c],g={name:g.semantic,offset:0,stride:0,stream:-1,scopeId:a.scope.resolve(g.semantic),dataType:g.type,numComponents:g.components,normalize:void 0===g.normalize?!1:g.normalize,size:g.components*
d[g.type]};this.elements.push(g);this.size+=g.size}var f=0;c=0;for(e=this.elements.length;c<e;c++)g=this.elements[c],g.offset=f,g.stride=this.size,f+=g.size}}}());pc.extend(pc,function(){var d=function(a,b,c,e){this.usage=e||pc.BUFFER_STATIC;this.format=b;this.numVertices=c;this.numBytes=b.size*c;this.device=a;this.bufferId=this.device.gl.createBuffer();this.storage=new ArrayBuffer(this.numBytes)};d.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId)},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var a=
this.device.gl,b;switch(this.usage){case pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)}};return{VertexBuffer:d}}());pc.extend(pc,function(){var d=function(a,b,c,e){this.usage=e||pc.BUFFER_STATIC;this.format=b;this.numIndices=c;this.device=a;a=this.device.gl;this.bufferId=a.createBuffer();var g;b===pc.INDEXFORMAT_UINT8?(g=1,this.glFormat=a.UNSIGNED_BYTE):b===pc.INDEXFORMAT_UINT16?(g=2,this.glFormat=a.UNSIGNED_SHORT):b===pc.INDEXFORMAT_UINT32&&(g=4,this.glFormat=a.UNSIGNED_INT);this.storage=new ArrayBuffer(this.numIndices*g)};d.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId)},getFormat:function(){return this.format},
getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl,b;switch(this.usage){case pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)}};return{IndexBuffer:d}}());pc.extend(pc,function(){var d=function(a,b){this.device=a;var c=4,e=4,g=pc.PIXELFORMAT_R8_G8_B8_A8,f=!1,d=!0,h=!1;void 0!==b&&(c=void 0!==b.width?b.width:c,e=void 0!==b.height?b.height:e,g=void 0!==b.format?b.format:g,f=void 0!==b.cubemap?b.cubemap:f,d=void 0!==b.autoMipmap?b.autoMipmap:d,h=void 0!==b.hdr?b.hdr:h);this.name=null;this.autoMipmap=d;this.hdr=h;this._cubemap=f;this._format=g;this._compressed=g===pc.PIXELFORMAT_DXT1||g===pc.PIXELFORMAT_DXT3||g===pc.PIXELFORMAT_DXT5;this._width=c||4;this._height=
e||4;this._addressV=this._addressU=pc.ADDRESS_REPEAT;this._minFilter=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)?pc.FILTER_LINEAR_MIPMAP_LINEAR:pc.FILTER_LINEAR;this._magFilter=pc.FILTER_LINEAR;this._anisotropy=1;this._levels=f?[[null,null,null,null,null,null]]:[null];this._lockedLevel=-1;this._needsUpload=!0};Object.defineProperty(d.prototype,"minFilter",{get:function(){return this._minFilter},set:function(a){if(!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))a===
pc.FILTER_NEAREST||a===pc.FILTER_LINEAR||(logWARNING("Invalid minification filter mode set on non power of two texture. Forcing linear addressing."),a=pc.FILTER_LINEAR);this._minFilter=a}});Object.defineProperty(d.prototype,"magFilter",{get:function(){return this._magFilter},set:function(a){a===pc.FILTER_NEAREST||a===pc.FILTER_LINEAR||logWARNING("Invalid magnification filter mode. Must be set to FILTER_NEAREST or FILTER_LINEAR.");this._magFilter=a}});Object.defineProperty(d.prototype,"addressU",{get:function(){return this._addressU},
set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in U set on non power of two texture. Forcing clamp to edge addressing."),a=pc.ADDRESS_CLAMP_TO_EDGE;this._addressU=a}});Object.defineProperty(d.prototype,"addressV",{get:function(){return this._addressV},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in V set on non power of two texture. Forcing clamp to edge addressing."),
a=pc.ADDRESS_CLAMP_TO_EDGE;this._addressV=a}});Object.defineProperty(d.prototype,"anisotropy",{get:function(){return this._anisotropy},set:function(a){this._anisotropy=a}});Object.defineProperty(d.prototype,"width",{get:function(){return this._width}});Object.defineProperty(d.prototype,"height",{get:function(){return this._height}});Object.defineProperty(d.prototype,"format",{get:function(){return this._format}});Object.defineProperty(d.prototype,"cubemap",{get:function(){return this._cubemap}});
pc.extend(d.prototype,{bind:function(){},destroy:function(){this._glTextureId&&this.device.gl.deleteTexture(this._glTextureId)},lock:function(a){a=a||{level:0,face:0,mode:pc.TEXTURELOCK_WRITE};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=0);void 0===a.mode&&(a.mode=pc.TEXTURELOCK_WRITE);this._lockedLevel=a.level;if(null===this._levels[a.level])switch(this._format){case pc.PIXELFORMAT_A8:case pc.PIXELFORMAT_L8:this._levels[a.level]=new Uint8Array(this._width*this._height);break;case pc.PIXELFORMAT_L8_A8:this._levels[a.level]=
new Uint8Array(2*this._width*this._height);break;case pc.PIXELFORMAT_R5_G6_B5:case pc.PIXELFORMAT_R5_G5_B5_A1:case pc.PIXELFORMAT_R4_G4_B4_A4:this._levels[a.level]=new Uint16Array(this._width*this._height);break;case pc.PIXELFORMAT_R8_G8_B8:this._levels[a.level]=new Uint8Array(3*this._width*this._height);break;case pc.PIXELFORMAT_R8_G8_B8_A8:this._levels[a.level]=new Uint8Array(4*this._width*this._height);break;case pc.PIXELFORMAT_DXT1:this._levels[a.level]=new Uint8Array(8*Math.floor((this._width+
3)/4)*Math.floor((this._height+3)/4));break;case pc.PIXELFORMAT_DXT3:case pc.PIXELFORMAT_DXT5:this._levels[a.level]=new Uint8Array(16*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case pc.PIXELFORMAT_RGB16F:case pc.PIXELFORMAT_RGB32F:this._levels[a.level]=new Float32Array(3*this._width*this._height);break;case pc.PIXELFORMAT_RGBA16F:case pc.PIXELFORMAT_RGBA32F:this._levels[a.level]=new Float32Array(4*this._width*this._height)}return this._levels[a.level]},recover:function(){},
load:function(a,b){if(this._cubemap){var c=a.map(function(a){return new pc.resources.ImageRequest(a)});b.request(c).then(function(a){this.setSource(a)}.bind(this))}else c=new pc.resources.ImageRequest(a),b.request(c).then(function(a){this.setSource(a[0])}.bind(this))},setSource:function(a){if(this._cubemap){logASSERT("[object Array]"===Object.prototype.toString.apply(a),"pc.Texture: setSource: supplied source is not an array");logASSERT(6===a.length,"pc.Texture: setSource: supplied source does not have 6 entries.");
for(var b=0,c=!0,e=a[0].width,g=a[0].height,f=0;6>f;f++)(a[f]instanceof HTMLCanvasElement||a[f]instanceof HTMLImageElement||a[f]instanceof HTMLVideoElement)&&b++,a[f].width!==e&&(c=!1),a[f].height!==g&&(c=!1);logASSERT(6===b,"pc.Texture: setSource: Not all supplied source elements are of required type (canvas, image or video).");logASSERT(c,"pc.Texture: setSource: Not all supplied source elements share the same dimensions.");this._width=a[0].width;this._height=a[0].height}else logASSERT(a instanceof
HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement,"pc.Texture: setSource: supplied source is not an instance of HTMLCanvasElement, HTMLImageElement or HTMLVideoElement."),this._width=a.width,this._height=a.height;this._levels[0]=a;this.upload();this.minFilter=this._minFilter;this.magFilter=this._magFilter;this.addressu=this._addressu;this.addressv=this._addressv},getSource:function(){return this._levels[0]},unlock:function(){logASSERT(-1!==this._lockedLevel,"Attempting to unlock a texture that is not locked");
this.upload();this._lockedLevel=-1},upload:function(){this._needsUpload=!0}});return{Texture:d}}());pc.extend(pc,function(){var d={depth:!0,face:0},a=function(a,c,e){this._device=a;this._colorBuffer=c;e=void 0!==e?e:d;this._face=void 0!==e.face?e.face:0;this._depth=void 0!==e.depth?e.depth:!0};a.prototype={bind:function(){},destroy:function(){var a=this._device.gl;a.deleteFramebuffer(this._frameBuffer);this._depthBuffer&&a.deleteRenderbuffer(this._depthBuffer)},unbind:function(){}};Object.defineProperty(a.prototype,"colorBuffer",{get:function(){return this._colorBuffer}});Object.defineProperty(a.prototype,
"face",{get:function(){return this._face}});Object.defineProperty(a.prototype,"width",{get:function(){return this._colorBuffer.width}});Object.defineProperty(a.prototype,"height",{get:function(){return this._colorBuffer.height}});return{RenderTarget:a}}());pc.extend(pc,function(){return{ShaderInput:function(d,a,b,c){this.locationId=c;this.scopeId=d.scope.resolve(a);this.version=new pc.Version;this.dataType=b;this.array=[]}}}());pc.extend(pc,function(){function d(a,c,e){var g=a.createShader(c);a.shaderSource(g,e);a.compileShader(g);if(!a.getShaderParameter(g,a.COMPILE_STATUS)){for(var f=a.getShaderInfoLog(g),d=logERROR,a="Failed to compile "+(c===a.VERTEX_SHADER?"vertex":"fragment")+" shader:\n\n",e=e.split("\n"),c=0,h=e.length;c<h;c++)e[c]=c+1+":\t"+e[c];e=e.join("\n");d(a+e+"\n\n"+f)}return g}var a=function(a,c){this.device=a;this.definition=c;var e=this.device.gl,g=d(e,e.VERTEX_SHADER,c.vshader),f=d(e,e.FRAGMENT_SHADER,
c.fshader),k=e.createProgram();e.attachShader(k,g);e.attachShader(k,f);e.linkProgram(k);if(!e.getProgramParameter(k,e.LINK_STATUS)){var h=e.getProgramInfoLog(k);logERROR("Failed to link shader program. Error: "+h)}this.program=k;e.deleteShader(g);e.deleteShader(f);this.attributes=[];this.uniforms=[];this.samplers=[];g=0;f={};f[e.BOOL]=pc.UNIFORMTYPE_BOOL;f[e.INT]=pc.UNIFORMTYPE_INT;f[e.FLOAT]=pc.UNIFORMTYPE_FLOAT;f[e.FLOAT_VEC2]=pc.UNIFORMTYPE_VEC2;f[e.FLOAT_VEC3]=pc.UNIFORMTYPE_VEC3;f[e.FLOAT_VEC4]=
pc.UNIFORMTYPE_VEC4;f[e.INT_VEC2]=pc.UNIFORMTYPE_IVEC2;f[e.INT_VEC3]=pc.UNIFORMTYPE_IVEC3;f[e.INT_VEC4]=pc.UNIFORMTYPE_IVEC4;f[e.BOOL_VEC2]=pc.UNIFORMTYPE_BVEC2;f[e.BOOL_VEC3]=pc.UNIFORMTYPE_BVEC3;f[e.BOOL_VEC4]=pc.UNIFORMTYPE_BVEC4;f[e.FLOAT_MAT2]=pc.UNIFORMTYPE_MAT2;f[e.FLOAT_MAT3]=pc.UNIFORMTYPE_MAT3;f[e.FLOAT_MAT4]=pc.UNIFORMTYPE_MAT4;f[e.SAMPLER_2D]=pc.UNIFORMTYPE_TEXTURE2D;f[e.SAMPLER_CUBE]=pc.UNIFORMTYPE_TEXTURECUBE;for(var l=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES);g<l;)k=e.getActiveAttrib(this.program,
g++),h=e.getAttribLocation(this.program,k.name),void 0===c.attributes[k.name]&&console.error('Vertex shader attribute "'+k.name+'" is not mapped to a semantic in shader definition.'),k=new pc.ShaderInput(a,c.attributes[k.name],f[k.type],h),this.attributes.push(k);g=0;for(l=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS);g<l;)k=e.getActiveUniform(this.program,g++),h=e.getUniformLocation(this.program,k.name),k.type===e.SAMPLER_2D||k.type===e.SAMPLER_CUBE?this.samplers.push(new pc.ShaderInput(a,
k.name,f[k.type],h)):this.uniforms.push(new pc.ShaderInput(a,k.name,f[k.type],h))};a.prototype={destroy:function(){this.device.gl.deleteProgram(this.program)}};return{Shader:a}}());pc.extend(pc,function(){var d=function(a){this._device=a;this._cache={};this._generators={}};d.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=b)};d.prototype.unregister=function(a){this.isRegistered(a)&&delete this._generators[a]};d.prototype.isRegistered=function(a){return void 0!==this._generators[a]};d.prototype.getProgram=function(a,b){var c=this._generators[a];if(void 0===c)return logERROR("No program library functions registered for: "+a),null;var e=c.generateKey(g,
b),g=this._cache[e];if(!g)var g=this._device,c=c.createShaderDefinition(g,b),g=this._cache[e]=new pc.Shader(g,c);return g};return{ProgramLibrary:d}}());pc.extend(pc,function(){function d(a){this.name="UnsupportedBrowserError";this.message=a||""}function a(a){this.name="ContextCreationError";this.message=a||""}d.prototype=Error.prototype;a.prototype=Error.prototype;var b=function(){logWARNING("Context lost.")},c=function(){logINFO("Context restored.")},e=function(a,b){var c=a.width,e=a.height;if(c>b||e>b){var g=b/Math.max(c,e),d=Math.floor(c*g),g=Math.floor(e*g);console.warn("Image dimensions larger than max supported texture size of "+b+". Resizing from "+
c+", "+e+" to "+d+", "+g+".");var m=document.createElement("canvas");m.width=d;m.height=g;m.getContext("2d").drawImage(a,0,0,c,e,0,0,d,g);return m}return a},g=function(a){this.gl=void 0;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision="highp";this.attributesInvalidated=!0;this.boundBuffer=null;this.enabledAttributes={};this.textureUnits=[];this.commitFunction={};if(!window.WebGLRenderingContext)throw new pc.UnsupportedBrowserError;for(var e={alpha:!1},g=["webgl",
"experimental-webgl"],d=null,n=0;n<g.length;n++){try{d=a.getContext(g[n],e)}catch(r){}if(d)break}var m=this.gl=d;if(!this.gl)throw new pc.ContextCreationError;a.addEventListener("webglcontextlost",b,!1);a.addEventListener("webglcontextrestored",c,!1);this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision="highp";this.maxTextureSize=m.getParameter(m.MAX_TEXTURE_SIZE);this.maxCubeMapSize=m.getParameter(m.MAX_CUBE_MAP_TEXTURE_SIZE);a=m.getShaderPrecisionFormat(m.VERTEX_SHADER,
m.HIGH_FLOAT);g=m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.MEDIUM_FLOAT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.LOW_FLOAT);e=m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.HIGH_FLOAT);d=m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.MEDIUM_FLOAT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.LOW_FLOAT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.HIGH_INT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.MEDIUM_INT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.LOW_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,
m.HIGH_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.MEDIUM_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.LOW_INT);g=0<g.precision&&0<d.precision;0<a.precision&&0<e.precision||(g?(this.precision="mediump",console.warn("WARNING: highp not supported, using mediump")):(this.precision="lowp",console.warn("WARNING: highp and mediump not supported, using lowp")));this.defaultClearOptions={color:[0,0,0,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.glAddress=[m.REPEAT,m.CLAMP_TO_EDGE,
m.MIRRORED_REPEAT];this.glBlendEquation=[m.FUNC_ADD,m.FUNC_SUBTRACT,m.FUNC_REVERSE_SUBTRACT];this.glBlendFunction=[m.ZERO,m.ONE,m.SRC_COLOR,m.ONE_MINUS_SRC_COLOR,m.DST_COLOR,m.ONE_MINUS_DST_COLOR,m.SRC_ALPHA,m.SRC_ALPHA_SATURATE,m.ONE_MINUS_SRC_ALPHA,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA];this.glClearFlag=[0,m.COLOR_BUFFER_BIT,m.DEPTH_BUFFER_BIT,m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT|
m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT];this.glFilter=[m.NEAREST,m.LINEAR,m.NEAREST_MIPMAP_NEAREST,m.NEAREST_MIPMAP_LINEAR,m.LINEAR_MIPMAP_NEAREST,m.LINEAR_MIPMAP_LINEAR];this.glPrimitive=[m.POINTS,m.LINES,m.LINE_LOOP,m.LINE_STRIP,m.TRIANGLES,m.TRIANGLE_STRIP,m.TRIANGLE_FAN];this.glType=[m.BYTE,m.UNSIGNED_BYTE,m.SHORT,m.UNSIGNED_SHORT,m.INT,m.UNSIGNED_INT,m.FLOAT];this.extTextureFloat=m.getExtension("OES_texture_float");this.extTextureHalfFloat=m.getExtension("OES_texture_half_float");this.maxVertexTextures=
m.getParameter(m.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures;this.extTextureFloatRenderable=!!this.extTextureFloat;this.extTextureFloat&&(a=m.createTexture(),m.bindTexture(m.TEXTURE_2D,a),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE),m.texImage2D(m.TEXTURE_2D,
0,m.RGBA,2,2,0,m.RGBA,m.FLOAT,null),e=m.createFramebuffer(),m.bindFramebuffer(m.FRAMEBUFFER,e),m.framebufferTexture2D(m.FRAMEBUFFER,m.COLOR_ATTACHMENT0,m.TEXTURE_2D,a,0),m.bindTexture(m.TEXTURE_2D,null),m.checkFramebufferStatus(m.FRAMEBUFFER)!=m.FRAMEBUFFER_COMPLETE&&(this.extTextureFloatRenderable=!1));this.extTextureLod=m.getExtension("EXT_shader_texture_lod");this.fragmentUniformsCount=m.getParameter(m.MAX_FRAGMENT_UNIFORM_VECTORS);this.samplerCount=m.getParameter(m.MAX_TEXTURE_IMAGE_UNITS);this.extDepthTexture=
null;(this.extStandardDerivatives=m.getExtension("OES_standard_derivatives"))&&m.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,m.NICEST);this.extTextureFilterAnisotropic=m.getExtension("EXT_texture_filter_anisotropic");this.extTextureFilterAnisotropic||(this.extTextureFilterAnisotropic=m.getExtension("WEBKIT_EXT_texture_filter_anisotropic"));if(this.extCompressedTextureS3TC=m.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")){a=m.getParameter(m.COMPRESSED_TEXTURE_FORMATS);
for(e=0;e<a.length;e++);}this.maxDrawBuffers=(this.extDrawBuffers=m.getExtension("EXT_draw_buffers"))?m.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_EXT):1;this.maxColorAttachments=this.extDrawBuffers?m.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_EXT):1;this.renderTarget=null;this.scope=new pc.ScopeSpace("Device");this.commitFunction={};this.commitFunction[pc.UNIFORMTYPE_BOOL]=function(a,b){m.uniform1i(a,b)};this.commitFunction[pc.UNIFORMTYPE_INT]=function(a,b){m.uniform1i(a,b)};this.commitFunction[pc.UNIFORMTYPE_FLOAT]=
function(a,b){"number"==typeof b?m.uniform1f(a,b):m.uniform1fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC2]=function(a,b){m.uniform2fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC3]=function(a,b){m.uniform3fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC4]=function(a,b){m.uniform4fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC2]=function(a,b){m.uniform2iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC2]=function(a,b){m.uniform2iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC3]=function(a,b){m.uniform3iv(a,
b)};this.commitFunction[pc.UNIFORMTYPE_BVEC3]=function(a,b){m.uniform3iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC4]=function(a,b){m.uniform4iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC4]=function(a,b){m.uniform4iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_MAT2]=function(a,b){m.uniformMatrix2fv(a,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT3]=function(a,b){m.uniformMatrix3fv(a,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT4]=function(a,b){m.uniformMatrix4fv(a,!1,b)};this.setBlending(!1);this.setBlendFunction(pc.BLENDMODE_ONE,
pc.BLENDMODE_ZERO);this.setBlendEquation(pc.BLENDEQUATION_ADD);this.setColorWrite(!0,!0,!0,!0);this.setCullMode(pc.CULLFACE_BACK);this.setDepthTest(!0);this.setDepthWrite(!0);this.setClearDepth(1);this.setClearColor(0,0,0,0);m.enable(m.SCISSOR_TEST);this.programLib=new pc.ProgramLibrary(this);for(var w in pc.programlib)this.programLib.register(w,pc.programlib[w]);w=m.getParameter(m.MAX_VERTEX_UNIFORM_VECTORS);w=w-16-8;w-=1;w-=16;this.boneLimit=Math.floor(w/4);110<this.boneLimit&&(this.boneLimit=110);
pc.events.attach(this);this.boundBuffer=null;this.textureUnits=[];this.attributesInvalidated=!0;this.enabledAttributes={};w=m.createBuffer();a=new ArrayBuffer(16);m.bindBuffer(m.ARRAY_BUFFER,w);m.bufferData(m.ARRAY_BUFFER,a,m.STATIC_DRAW);m.getError();m.vertexAttribPointer(0,4,m.UNSIGNED_BYTE,!1,4,0);this.supportsUnsignedByte=0===m.getError();m.deleteBuffer(w)};g.prototype={setViewport:function(a,b,c,e){this.gl.viewport(a,b,c,e)},setScissor:function(a,b,c,e){this.gl.scissor(a,b,c,e)},getProgramLibrary:function(){return this.programLib},
setProgramLibrary:function(a){this.programLib=a},updateBegin:function(){var a=this.gl;this.indexBuffer=this.boundBuffer=null;var b=this.renderTarget;if(b)if(b._glFrameBuffer)a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer);else switch(b._glFrameBuffer=a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer),b._colorBuffer._glTextureId||this.setTexture(b._colorBuffer,0),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,b._colorBuffer._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+b._face:
a.TEXTURE_2D,b._colorBuffer._glTextureId,0),b._depth&&(b._glDepthBuffer||(b._glDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,b._glDepthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b.width,b.height),a.bindRenderbuffer(a.RENDERBUFFER,null),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,b._glDepthBuffer)),a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");
break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}else a.bindFramebuffer(a.FRAMEBUFFER,null);for(a=0;16>a;a++)this.textureUnits[a]=null},updateEnd:function(){var a=this.gl;this.renderTarget&&a.bindFramebuffer(a.FRAMEBUFFER,null)},initializeTexture:function(a){var b=
this.gl;a._glTextureId=b.createTexture();a._glTarget=a._cubemap?b.TEXTURE_CUBE_MAP:b.TEXTURE_2D;switch(a._format){case pc.PIXELFORMAT_A8:a._glFormat=b.ALPHA;a._glInternalFormat=b.ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8:a._glFormat=b.LUMINANCE;a._glInternalFormat=b.LUMINANCE;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8_A8:a._glFormat=b.LUMINANCE_ALPHA;a._glInternalFormat=b.LUMINANCE_ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R5_G6_B5:a._glFormat=
b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_SHORT_5_6_5;break;case pc.PIXELFORMAT_R5_G5_B5_A1:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_5_5_5_1;break;case pc.PIXELFORMAT_R4_G4_B4_A4:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_4_4_4_4;break;case pc.PIXELFORMAT_R8_G8_B8:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R8_G8_B8_A8:a._glFormat=b.RGBA;a._glInternalFormat=
b.RGBA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_DXT1:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGB;a._glInternalFormat=ext.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.PIXELFORMAT_DXT3:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case pc.PIXELFORMAT_DXT5:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case pc.PIXELFORMAT_RGB16F:ext=this.extTextureHalfFloat;
a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=ext.HALF_FLOAT_OES;break;case pc.PIXELFORMAT_RGBA16F:ext=this.extTextureHalfFloat;a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=ext.HALF_FLOAT_OES;break;case pc.PIXELFORMAT_RGB32F:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_RGBA32F:a._glFormat=b.RGBA,a._glInternalFormat=b.RGBA,a._glPixelType=b.FLOAT}},uploadTexture:function(a){for(var b=this.gl,c=0,g;a._levels[c]||0==c;){g=a._levels[c];
1==c&&b.generateMipmap(a._glTarget);if(a._cubemap){var d;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);if(g[0]instanceof HTMLCanvasElement||g[0]instanceof HTMLImageElement||g[0]instanceof HTMLVideoElement)for(d=0;6>d;d++){var r=g[d];if(r instanceof HTMLImageElement&&(r.width>this.maxCubeMapSize||r.height>this.maxCubeMapSize))r=e(r,this.maxCubeMapSize);b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+d,c,a._glInternalFormat,a._glFormat,a._glPixelType,r)}else for(d=
0;6>d;d++)b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+d,c,a._glInternalFormat,a._width,a._height,0,a._glFormat,a._glPixelType,g[d])}else if(g instanceof HTMLCanvasElement||g instanceof HTMLImageElement||g instanceof HTMLVideoElement){if(g instanceof HTMLImageElement&&(g.width>this.maxTextureSize||g.height>this.maxTextureSize))g=e(g,this.maxTextureSize);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,a._glFormat,
a._glPixelType,g)}else b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),a._compressed?b.compressedTexImage2D(b.TEXTURE_2D,c,a._glInternalFormat,a._width,a._height,0,g):b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,a._width,a._height,0,a._glFormat,a._glPixelType,g);c++}a.autoMipmap&&(pc.math.powerOfTwo(a._width)&&pc.math.powerOfTwo(a._height)&&1===a._levels.length)&&b.generateMipmap(a._glTarget)},setTexture:function(a,b){var c=this.gl;a._glTextureId||this.initializeTexture(a);c.activeTexture(c.TEXTURE0+b);
this.textureUnits[b]!==a&&(c.bindTexture(a._glTarget,a._glTextureId),this.textureUnits[b]=a);c.texParameteri(a._glTarget,c.TEXTURE_MIN_FILTER,this.glFilter[a._minFilter]);c.texParameteri(a._glTarget,c.TEXTURE_MAG_FILTER,this.glFilter[a._magFilter]);c.texParameteri(a._glTarget,c.TEXTURE_WRAP_S,this.glAddress[a._addressU]);c.texParameteri(a._glTarget,c.TEXTURE_WRAP_T,this.glAddress[a._addressV]);var e=this.extTextureFilterAnisotropic;if(e){var g=a.anisotropy,g=Math.min(g,this.maxAnisotropy);c.texParameterf(a._glTarget,
e.TEXTURE_MAX_ANISOTROPY_EXT,g)}a._needsUpload&&(this.uploadTexture(a),a._needsUpload=!1)},draw:function(a){var b=this.gl,c,e,g,d,m,w,u;c=this.shader;u=c.samplers;var F=c.uniforms;if(this.attributesInvalidated){w=c.attributes;c=0;for(g=w.length;c<g;c++)e=w[c],d=e.scopeId.value,null!==d&&(m=this.vertexBuffers[d.stream],this.boundBuffer!==m.bufferId&&(b.bindBuffer(b.ARRAY_BUFFER,m.bufferId),this.boundBuffer=m.bufferId),this.enabledAttributes[e.locationId]||(b.enableVertexAttribArray(e.locationId),this.enabledAttributes[e.locationId]=
!0),b.vertexAttribPointer(e.locationId,d.numComponents,this.glType[d.dataType],d.normalize,d.stride,d.offset));this.attributesInvalidated=!1}c=textureUnit=0;for(g=u.length;c<g;c++)if(d=u[c],m=d.scopeId.value,m instanceof pc.Texture)w=m,this.setTexture(w,textureUnit),d.slot!==textureUnit&&(b.uniform1i(d.locationId,textureUnit),d.slot=textureUnit),textureUnit++;else{d.array.length=0;numTexures=m.length;for(e=0;e<numTexures;e++)w=m[e],this.setTexture(w,textureUnit),d.array[e]=textureUnit,textureUnit++;
b.uniform1iv(d.locationId,d.array)}c=0;for(g=F.length;c<g;c++)if(u=F[c],e=u.scopeId,d=u.version,m=e.versionObject.version,d.globalId!==m.globalId||d.revision!==m.revision)if(d.globalId=m.globalId,d.revision=m.revision,null!==e.value)this.commitFunction[u.dataType](u.locationId,e.value);a.indexed?b.drawElements(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,2*a.base):b.drawArrays(this.glPrimitive[a.type],a.base,a.count)},clear:function(a){var b=this.defaultClearOptions,a=a||b,c=void 0===
a.flags?b.flags:a.flags;if(0!==c){var e=this.gl;if(c&pc.CLEARFLAG_COLOR){var g=void 0===a.color?b.color:a.color;this.setClearColor(g[0],g[1],g[2],g[3])}c&pc.CLEARFLAG_DEPTH&&(this.setClearDepth(void 0===a.depth?b.depth:a.depth),this.depthWrite||e.depthMask(!0));e.clear(this.glClearFlag[c]);c&pc.CLEARFLAG_DEPTH&&(this.depthWrite||e.depthMask(!1))}},readPixels:function(a,b,c,e,g){var d=this.gl;d.readPixels(a,b,c,e,d.RGBA,d.UNSIGNED_BYTE,g)},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),
this.clearDepth=a)},setClearColor:function(a,b,c,e){if(a!==this.clearRed||b!==this.clearGreen||c!==this.clearBlue||e!==this.clearAlpha)this.gl.clearColor(a,b,c,e),this.clearRed=a,this.clearGreen=b,this.clearBlue=c,this.clearAlpha=e},setRenderTarget:function(a){this.renderTarget=a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=
a}},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,c,e){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==c||this.writeAlpha!==e)this.gl.colorMask(a,b,c,e),this.writeRed=a,this.writeGreen=b,this.writeBlue=c,this.writeAlpha=e},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=
a}},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b},setBlendEquation:function(a){this.blendEquation!==a&&(this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a)},setCullMode:function(a){if(this.cullMode!==a){var b=this.gl;switch(a){case pc.CULLFACE_NONE:b.disable(b.CULL_FACE);break;case pc.CULLFACE_FRONT:b.enable(b.CULL_FACE);b.cullFace(b.FRONT);break;case pc.CULLFACE_BACK:b.enable(b.CULL_FACE);
b.cullFace(b.BACK);break;case pc.CULLFACE_FRONTANDBACK:b.enable(b.CULL_FACE),b.cullFace(b.FRONT_AND_BACK)}this.cullMode=a}},setIndexBuffer:function(a){if(this.indexBuffer!==a){this.indexBuffer=a;var b=this.gl;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a?a.bufferId:null)}},setVertexBuffer:function(a,b){if(this.vertexBuffers[b]!==a){this.vertexBuffers[b]=a;for(var c=0,e=a.getFormat().elements,g=e.length;c<g;){var d=e[c++];d.stream=b;d.scopeId.setValue(d)}this.attributesInvalidated=!0}},setShader:function(a){a!==
this.shader&&(this.shader=a,this.gl.useProgram(a.program),this.attributesInvalidated=!0)},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(a){this.boneLimit=a},enableValidation:function(){console.warn("enableValidation: This function is deprecated and will be removed shortly.")},validate:function(){console.warn("validate: This function is deprecated and will be removed shortly.")},resizeCanvas:function(a,b){this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)}};
Object.defineProperty(g.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}});Object.defineProperty(g.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(g.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});Object.defineProperty(g.prototype,"maxAnisotropy",{get:function(){var a;return function(){if(void 0===
a){a=1;var b=this.gl,c=this.extTextureFilterAnisotropic;c&&(a=b.getParameter(c.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}return a}}()});return{UnsupportedBrowserError:d,ContextCreationError:a,GraphicsDevice:g,precalculatedTangents:!0}}());pc.extend(pc,function(){var d={},a={};d.collectAttribs=function(a){for(var c={},e=0,g=a.indexOf("attribute");0<=g;){var d=a.indexOf(";",g),k=a.lastIndexOf(" ",d),d=a.substr(k+1,d-(k+1));"aPosition"==d?c.aPosition=pc.SEMANTIC_POSITION:(c[d]="ATTR"+e,e++);g=a.indexOf("attribute",g+1)}return c};d.createShader=function(a,c,e){c=d[c];e=pc.programlib.getSnippet(a,"fs_precision")+"\n"+d[e];attribs=this.collectAttribs(c);return new pc.Shader(a,{attributes:attribs,vshader:c,fshader:e})};d.createShaderFromCode=
function(b,c,e,g){var d=a[g];if(void 0!=d)return d;e=pc.programlib.getSnippet(b,"fs_precision")+"\n"+e;attribs=this.collectAttribs(c);a[g]=new pc.Shader(b,{attributes:attribs,vshader:c,fshader:e});return a[g]};return{shaderChunks:d}}());pc.extend(pc,function(){var d=null;return{drawQuadWithShader:function(a,b,c){if(null==d){var e=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.ELEMENTTYPE_FLOAT32}]);d=new pc.VertexBuffer(a,e,4);e=new pc.VertexIterator(d);e.element[pc.SEMANTIC_POSITION].set(-1,-1);e.next();e.element[pc.SEMANTIC_POSITION].set(1,-1);e.next();e.element[pc.SEMANTIC_POSITION].set(-1,1);e.next();e.element[pc.SEMANTIC_POSITION].set(1,1);e.end()}a.setRenderTarget(b);a.updateBegin();e=null!==b?b.width:
a.width;b=null!==b?b.height:a.height;a.setViewport(0,0,e,b);a.setScissor(0,0,e,b);b=a.getDepthTest();e=a.getDepthWrite();a.setDepthTest(!1);a.setDepthWrite(!1);a.setVertexBuffer(d,0);a.setShader(c);a.draw({type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});a.setDepthTest(b);a.setDepthWrite(e);a.updateEnd()}}}());pc.shaderChunks.particle_halflambertPS="\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n\n\n";pc.shaderChunks.normalVS="vec3 getNormal(inout vsInternalData data) {\n    data.normalMatrix = matrix_normal;\n    return normalize(data.normalMatrix * vertex_normal);\n}\n\n";pc.shaderChunks.particle_blendNormalPS="\n    if (a < 0.01) discard;\n";pc.shaderChunks.normalMapPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpMapFactor;\nvoid getNormal(inout psInternalData data) {\n    vec3 normalMap = texture2D(texture_normalMap, $UV).xyz * 2.0 - 1.0;\n    data.normalMap = normalMap;\n    data.normalW = data.TBN * normalMap;\n}\n\n";
pc.shaderChunks.reflectionPrefilteredCubeLodPS="#extension GL_EXT_shader_texture_lod : enable\n\nuniform samplerCube texture_prefilteredCubeMap128;\nuniform float material_reflectionFactor;\n\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvoid addCubemapReflection(inout psInternalData data) {\n\n    float bias = saturate(1.0 - data.glossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeamsStretch(data.reflDirW, bias, 128.0);\n\n    vec3 refl = decodeRGBM( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) );\n\n    data.reflection += vec4(refl, material_reflectionFactor);\n}\n\n";
pc.shaderChunks.particle_blendMultiplyPS="\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n\n";pc.shaderChunks.particle_meshVS="\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, angle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, angle, rotMatrix);\n\n    billboard(particlePos, quadXY, localMat);\n\n\n";pc.shaderChunks.combineDiffuseSpecularNoReflPS="vec3 combineColor(inout psInternalData data) {\n    return data.albedo * data.diffuseLight + data.specularLight * data.specularity;\n}\n\n";
pc.shaderChunks.gamma1_0PS="vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\n\nfloat gammaCorrectInput(float color) {\n    return color;\n}\n\n";pc.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS="uniform vec3 material_ambient;\nvec3 combineColor(inout psInternalData data) {\n    return (data.diffuseLight - light_globalAmbient) * data.albedo + data.specularLight * data.specularity + material_ambient * light_globalAmbient;\n}\n\n";
pc.shaderChunks.reflectionSpherePS="uniform mat4 matrix_view;\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectionFactor;\nvoid addSpheremapReflection(inout psInternalData data) {\n\n    vec3 reflDirV = (mat3(matrix_view) * data.reflDirW).xyz;\n\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n    data.reflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectionFactor);\n}\n\n\n";
pc.shaderChunks.specularAaToksvigPS="float antiAliasGlossiness(inout psInternalData data, float power) {\n    float rlen = 1.0 / saturate(length(data.normalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n\n";pc.shaderChunks.fresnelComplexPS="// More physically-based Fresnel\nuniform float material_fresnelFactor; // should be IOR\nvoid getFresnel(inout psInternalData data) {\n    float cosThetaI = max(dot(data.normalW, data.viewDirW), 0.0);\n    float n = material_fresnelFactor;\n\n    float cosThetaT = sqrt(max(0.0, 1.0 - (1.0 - cosThetaI * cosThetaI) / (n * n)));\n    float nCosThetaT = n * cosThetaT;\n    float nCosThetaI = n * cosThetaI;\n\n    float rS = abs((cosThetaI - nCosThetaT) / (cosThetaI + nCosThetaT));\n    float rP = abs((cosThetaT - nCosThetaI) / (cosThetaT + nCosThetaI));\n    rS *= rS;\n    rP *= rP;\n\n    data.specularity *= (rS + rP) / 2.0;\n}\n\n";
pc.shaderChunks.ambientPrefilteredCubeLodPS="vec3 fixSeamsStretch(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvoid addAmbient(inout psInternalData data) {\n    vec3 fixedReflDir = fixSeamsStretch(data.normalW, 1.0 - 1.0 / 4.0);\n    data.diffuseLight = decodeRGBM( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) );\n}\n\n";
pc.shaderChunks.particle_endPS="    rgb = addFog(data, rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n";pc.shaderChunks.particleVS="attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform mat4 matrix_view;\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY, out mat3 localMat) {\n    vec3 viewUp = matrix_viewInverse[1].xyz;\n    vec3 posCam = matrix_viewInverse[3].xyz;\n\n    mat3 billMat;\n    billMat[2] = normalize(InstanceCoords - posCam);\n    billMat[0] = normalize(cross(viewUp, billMat[2]));\n    billMat[1] = -viewUp;\n    vec3 pos = billMat * vec3(quadXY, 0);\n\n    localMat = billMat;\n\n    return pos;\n}\n\nvoid main(void) {\n    vec2 quadXY = particle_vertexData.xy;\n    float id = floor(particle_vertexData.w);\n\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    vec4 particleTex = texture2D(particleTexOUT, vec2(id / numParticlesPot, 0.25));\n    vec3 pos = particleTex.xyz;\n    float angle = particleTex.w;\n\n    vec4 particleTex2 = texture2D(particleTexOUT, vec2(id / numParticlesPot, 0.75));\n    vec3 particleVelocity = particleTex2.xyz;\n    vec2 velocityV = normalize((mat3(matrix_view) * particleVelocity).xy); // should be removed by compiler if align/stretch is not used\n    float life = particleTex2.w;\n\n    float particleLifetime = lifetime;\n\n    if (life <= 0.0 || life > particleLifetime) quadXY = vec2(0,0);\n    float nlife = clamp(life / particleLifetime, 0.0, 1.0);\n\n    vec3 paramDiv;\n    vec4 params =                 tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5,    (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0),    nlife);\n\n    vec3 particlePos = pos;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData.xyz;\n\n    mat2 rotMatrix;\n    mat3 localMat;\n\n\n";
pc.shaderChunks.lightSpecularPhongPS="float getLightSpecular(inout psInternalData data) {\n    float specPow = data.glossiness;\n\n    specPow = antiAliasGlossiness(data, specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(data.reflDirW, -data.lightDirNormW), 0.0), specPow + 0.0001);\n}\n\n";pc.shaderChunks.particle_pointAlongVS="    angle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n\n";
pc.shaderChunks.fogExpPS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(inout psInternalData data, vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.albedoColorPS="uniform vec3 material_diffuse;\nvoid getAlbedo(inout psInternalData data) {\n    data.albedo = material_diffuse.rgb;\n}\n\n";
pc.shaderChunks.opacityTexPS="uniform sampler2D texture_opacityMap;\nvoid getOpacity(inout psInternalData data) {\n    vec4 tex = texture2D(texture_opacityMap, $UV);\n    data.alpha = tex.r;\n}\n\n";pc.shaderChunks.particle_wrapVS="\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n\n\n";
pc.shaderChunks.particle_TBNVS="\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    localMat[2] *= -1.0;\n    ParticleMat = localMat * rot3;\n\n\n\n\n";pc.shaderChunks.particle_lambertPS="\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n\n\n";pc.shaderChunks.normalVertexPS="void getNormal(inout psInternalData data) {\n    data.normalW = normalize(vNormalW);\n}\n\n";
pc.shaderChunks.specularAaNonePS="float antiAliasGlossiness(inout psInternalData data, float power) {\n    return power;\n}\n\n";pc.shaderChunks.shadowPS="float unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\nvoid _getShadowCoordOrtho(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.z += shadowParams.z;\n    data.shadowCoord = projPos.xyz;\n}\n\nvoid _getShadowCoordPersp(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    projPos.z += shadowParams.z;\n    data.shadowCoord = projPos.xyz;\n}\n\nvoid getShadowCoordOrtho(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(data, shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(data, shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - data.lightPosW, data.lightDirNormW)); // fov?\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -data.lightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(data, shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -data.lightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(data, shadowMatrix, shadowParams, wPos);\n}\n\nbool shadowContained(psInternalData data) {\n    bvec4 containedVec = bvec4(data.shadowCoord.x >= 0.0, data.shadowCoord.x <= 1.0, data.shadowCoord.y >= 0.0, data.shadowCoord.y <= 1.0);\n    return all(bvec2(all(containedVec), data.shadowCoord.z <= 1.0));\n}\n\nfloat getShadow(inout psInternalData data, sampler2D shadowMap, vec3 shadowParams) {\n    if (shadowContained(data)) {\n        float depth = unpackFloat(texture2D(shadowMap, data.shadowCoord.xy));\n        return (depth < data.shadowCoord.z) ? 0.0 : 1.0;\n    }\n    return 1.0;\n}\n\nvec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\nvec3 greaterThan2(vec3 a, vec3 b) {\n    return clamp((a - b)*1000.0, 0.0, 1.0); // softer version\n}\n\nfloat getShadowPCF3x3(inout psInternalData data, sampler2D shadowMap, vec3 shadowParams) {\n    if (shadowContained(data)) {\n        float shadowAccum = 0.0;\n        vec3 shadowCoord = data.shadowCoord;\n\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float dx0 = -xoffset;\n        float dx1 = xoffset;\n\n        mat3 shadowKernel;\n        mat3 depthKernel;\n\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n        shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n        shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\n        vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\n        shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n        shadowAccum = dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n\n        return shadowAccum;\n    }\n    return 1.0;\n}\n\n/*float getShadowPoint(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams) {\n    return float(unpackFloat(textureCube(shadowMap, data.lightDirNormW)) > (length(data.lightDirW)/shadowParams.w + shadowParams.z));\n}*/\n\nfloat _getShadowPoint(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n\n    mat3 shadowKernel;\n    mat3 depthKernel;\n\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n    vec3 shadowZ = vec3(length(dir) / shadowParams.w + shadowParams.z);\n\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat getShadowPoint(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(data, shadowMap, shadowParams, data.lightDirW);\n}\n\nfloat getShadowPointNormalOffset(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams) {\n    float distScale = length(data.lightDirW);\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -data.lightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - data.lightPosW;\n\n    return _getShadowPoint(data, shadowMap, shadowParams, dir);\n}\n\n";
pc.shaderChunks.particle_normalVS="\n    Normal = normalize(localPos - localMat[2]);\n\n\n";pc.shaderChunks.reflectionSphereLowPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectionFactor;\nvoid addSpheremapReflection(inout psInternalData data) {\n\n    vec3 reflDirV = vNormalV;\n\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    data.reflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectionFactor);\n}\n\n";pc.shaderChunks.rgbmPS="vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n\n";
pc.shaderChunks.endPS="   gl_FragColor.rgb = combineColor(data);\n   gl_FragColor.rgb += getEmission(data);\n   gl_FragColor.rgb = addFog(data, gl_FragColor.rgb);\n   gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n   gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   gl_FragColor.a = data.alpha;\n";pc.shaderChunks.emissionColorPS="uniform vec3 material_emissive;\nvec3 getEmission(inout psInternalData data) {\n    return material_emissive;\n}\n\n";pc.shaderChunks.startPS="\nvoid main(void) {\n    psInternalData data;\n\tdata.diffuseLight = vec3(0);\n\tdata.specularLight = vec3(0);\n    data.reflection = vec4(0);\n\n\n";
pc.shaderChunks.particleUpdaterRespawnPS="    if (life > particleLifetime && gl_FragCoord.y >= 1.0) {\n        tex.w = -particleRate * gl_FragCoord.x;\n    }\n\n";pc.shaderChunks.uv1VS="\nvec2 getUv1(inout vsInternalData data) {\n    return vertex_texCoord1;\n}\n";pc.shaderChunks.fresnelSimplePS="// Easily tweakable but not very correct Fresnel\nuniform float material_fresnelFactor;\nvoid getFresnel(inout psInternalData data) {\n    float fresnel = 1.0 - max(dot(data.normalW, data.viewDirW), 0.0);\n    data.specularity *= pow(fresnel, material_fresnelFactor);\n}\n\n";
pc.shaderChunks.glossinessFloatPS="uniform float material_shininess;\nvoid getGlossiness(inout psInternalData data) {\n    data.glossiness = material_shininess;\n}\n\n";pc.shaderChunks.particle_billboardVS="\n    quadXY = rotate(quadXY, angle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY, localMat);\n\n";pc.shaderChunks.particle_cpuVS="attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\nattribute vec2 particle_vertexData4;     // X = velocity.z, W = particle ID\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nvarying vec4 texCoordsAlphaLife;\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY, out mat3 localMat)\n{\n    vec3 viewUp = matrix_viewInverse[1].xyz;\n    vec3 posCam = matrix_viewInverse[3].xyz;\n\n    mat3 billMat;\n    billMat[2] = normalize(InstanceCoords - posCam);\n    billMat[0] = normalize(cross(viewUp, billMat[2]));\n    billMat[1] = -viewUp;\n    vec3 pos = billMat * vec3(quadXY, 0);\n\n    localMat = billMat;\n\n    return pos;\n}\n\n\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 pos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 particleVelocity = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData4.x);\n    vec2 velocityV = normalize((mat3(matrix_view) * particleVelocity).xy); // should be removed by compiler if align/stretch is not used\n\n    vec2 quadXY = vertPos.xy;\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n\n    mat2 rotMatrix;\n    mat3 localMat;\n\n    float angle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n\n";
pc.shaderChunks.aoBakedPS="uniform sampler2D texture_aoMap;\nvoid applyAO(inout psInternalData data) {\n    data.ao = texture2D(texture_aoMap, $UV).g;\n    data.diffuseLight *= data.ao;\n}\n\nvoid occludeSpecular(inout psInternalData data) {\n    // fake specular occlusion from AO\n    float specPow = exp2(data.glossiness * 4.0); // 0 - 128\n    specPow = max(specPow, 0.0001);\n    float specOcc = saturate(pow(data.ao * (data.glossiness + 1.0), specPow));\n\n    data.specularLight *= specOcc;\n    data.reflection *= specOcc;\n}\n\n";
pc.shaderChunks.glossinessTexFloatPS="uniform sampler2D texture_glossMap;\nuniform float material_shininess;\nvoid getGlossiness(inout psInternalData data) {\n    vec4 tex = texture2D(texture_glossMap, $UV);\n    data.glossiness = material_shininess * tex.r;\n}\n\n";pc.shaderChunks.fogExp2PS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(inout psInternalData data, vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";
pc.shaderChunks.tangentBinormalVS="\nvec3 getTangent(inout vsInternalData data) {\n    return normalize(data.normalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal(inout vsInternalData data) {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n\n";pc.shaderChunks.albedoTexPS="uniform sampler2D texture_diffuseMap;\nvoid getAlbedo(inout psInternalData data) {\n    vec4 tex = texture2DSRGB(texture_diffuseMap, $UV);\n    data.albedo = tex.rgb;\n}\n\n";pc.shaderChunks.normalSkinnedVS="vec3 getNormal(inout vsInternalData data) {\n    data.normalMatrix = mat3(data.modelMatrix[0].xyz, data.modelMatrix[1].xyz, data.modelMatrix[2].xyz);\n    return normalize(data.normalMatrix * vertex_normal);\n}\n\n";
pc.shaderChunks.lightDiffuseLambertPS="float getLightDiffuse(inout psInternalData data) {\n    return max(dot(data.normalW, -data.lightDirNormW), 0.0);\n}\n\n";pc.shaderChunks.skyboxHDRPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, vViewDir);\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n";pc.shaderChunks.skyboxPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, vViewDir);\n}\n\n";
pc.shaderChunks.opacityFloatPS="uniform float material_opacity;\nvoid getOpacity(inout psInternalData data) {\n    data.alpha = material_opacity;\n}\n\n";pc.shaderChunks.particleUpdaterStartPS="varying vec2 vUv0;\n\nuniform sampler2D particleTexIN;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform mat3 spawnBounds;\nuniform mat3 emitterMatrix;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform vec3 emitterScale;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n\n    vec4 tex = texture2D(particleTexIN, vec2(vUv0.x, 0.25));\n    vec4 tex2 = texture2D(particleTexIN, vec2(vUv0.x, 0.75));\n\n    float rndFactor = fract(sin(gl_FragCoord.x + 0.5 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    float particleLifetime = lifetime;\n    float life = tex2.w + delta;\n    float particleRate = rate + rateDiv * rndFactor;\n\n    if (life > 0.0) {\n        float nlife = clamp(life / particleLifetime, 0.0, 1.0);\n        vec3 localVelocityDiv;\n        vec3 velocityDiv;\n        vec3 paramDiv;\n        vec3 localVelocity =    tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv).xyz;\n        vec3 velocity =         tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv).xyz;\n\n        localVelocity +=        (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor3;\n        velocity +=             (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor3.zxy;\n\n        if (gl_FragCoord.y < 1.0) {\n            // Current particle state\n            vec4 params =           tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\n            float rotSpeed = params.x;\n            float rotSpeedDiv = paramDiv.y;\n\n            rotSpeed +=             (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor3.y;\n\n            tex.xyz += (emitterMatrix * localVelocity.xyz + velocity.xyz * emitterScale) * delta;\n            tex.w += rotSpeed * delta;\n        } else {\n            // Velocity\n            tex.xyz = (emitterMatrix * localVelocity.xyz + velocity.xyz * emitterScale);\n        }\n    }\n\n    if (gl_FragCoord.y < 1.0) {\n        if (life <= 0.0 || life > particleLifetime) {\n            vec3 inBounds = fract( vec3(rndFactor, rndFactor*10.0, rndFactor*100.0) + frameRandom );\n            tex.xyz = emitterPos + spawnBounds * (inBounds - vec3(0.5));\n            tex.w = mix(startAngle, startAngle2, rndFactor);\n        }\n    } else {\n        tex.w = life;\n    }\n\n";
pc.shaderChunks.viewNormalVS="\nuniform mat4 matrix_view;\nvec3 getViewNormal(inout vsInternalData data) {\n    return mat3(matrix_view) * vNormalW;\n}\n";pc.shaderChunks.transformVS="mat4 getModelMatrix(inout vsInternalData data) {\n    return matrix_model;\n}\n\nvec4 getPosition(inout vsInternalData data) {\n    data.modelMatrix = getModelMatrix(data);\n    vec4 posW = data.modelMatrix * vec4(vertex_position, 1.0);\n    data.positionW = posW.xyz;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition(inout vsInternalData data) {\n    return data.positionW;\n}\n\n";
pc.shaderChunks.uv0VS="\nvec2 getUv0(inout vsInternalData data) {\n    return vertex_texCoord0;\n}\n";pc.shaderChunks.particle_normalMapPS="\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n\n\n\n\n";pc.shaderChunks.tonemappingLinearPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n\n";pc.shaderChunks.particleUpdaterOnStopPS="    if (life < 0.0 && gl_FragCoord.y >= 1.0) {\n        tex.w = particleLifetime + 1.0;\n    }\n\n";
pc.shaderChunks.opacityTexFloatPS="uniform sampler2D texture_opacityMap;\nuniform float material_opacity;\nvoid getOpacity(inout psInternalData data) {\n    vec4 tex = texture2D(texture_opacityMap, $UV);\n    data.alpha = tex.r * material_opacity;\n}\n\n";pc.shaderChunks.baseVS="\n// Compiler should remove unneeded stuff\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform vec3 view_position;\n\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\nvarying vec3 vTangentW;\nvarying vec3 vBinormalW;\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec4 vVertexColor;\nvarying vec3 vNormalV;\n\nstruct vsInternalData {\n    vec3 positionW;\n    mat4 modelMatrix;\n    mat3 normalMatrix;\n};\n\n";
pc.shaderChunks.particleUpdaterEndPS="\n    gl_FragColor = tex;\n}\n";pc.shaderChunks.combineDiffuseSpecularNoConservePS="vec3 combineColor(inout psInternalData data) {\n    return data.albedo * data.diffuseLight + (data.specularLight + data.reflection.rgb * data.reflection.a) * data.specularity;\n}\n\n";pc.shaderChunks.particle_softPS="\n    vec2 screenTC = gl_FragCoord.xy / screenSize.xy;\n    float depth = unpackFloat( texture2D(uDepthMap, screenTC) ) * camera_far;\n    float particleDepth = gl_FragCoord.z / gl_FragCoord.w;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n\n";
pc.shaderChunks.basePS="\n// Compiler should remove unneeded stuff\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\nvarying vec3 vTangentW;\nvarying vec3 vBinormalW;\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec4 vVertexColor;\nvarying vec3 vNormalV;\n\nstruct psInternalData {\n    vec3 albedo;\n    vec3 specularity;\n    float glossiness;\n    vec3 emission;\n    vec3 normalW;\n    mat3 TBN;\n    vec3 viewDirW;\n    vec3 reflDirW;\n    vec3 diffuseLight;\n    vec3 specularLight;\n    vec4 reflection;\n    float alpha;\n    vec3 lightDirNormW;\n    vec3 lightDirW;\n    vec3 lightPosW;\n    float atten;\n    vec3 shadowCoord;\n    vec2 uvOffset;\n    vec3 normalMap;\n    float ao;\n};\n\nvoid getViewDir(inout psInternalData data) {\n    data.viewDirW = normalize(view_position - vPositionW);\n}\n\nvoid getReflDir(inout psInternalData data) {\n    data.reflDirW = normalize(-reflect(data.viewDirW, data.normalW));\n}\n\nvoid getLightDirPoint(inout psInternalData data, vec3 lightPosW) {\n    data.lightDirW = vPositionW - lightPosW;\n    data.lightDirNormW = normalize(data.lightDirW);\n    data.lightPosW = lightPosW;\n}\n\nfloat getFalloffLinear(inout psInternalData data, float lightRadius) {\n    float d = length(data.lightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n\nfloat square(float x) {\n    return x*x;\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat getFalloffInvSquared(inout psInternalData data, float lightRadius) {\n    float sqrDist = dot(data.lightDirW, data.lightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n    return falloff;\n}\n\nfloat getSpotEffect(inout psInternalData data, vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(data.lightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n\n";
pc.shaderChunks.specularityColorPS="uniform vec3 material_specular;\nvoid getSpecularity(inout psInternalData data) {\n    data.specularity = material_specular;\n}\n\n";pc.shaderChunks.combineDiffuseSpecularPS="vec3 combineColor(inout psInternalData data) {\n    return mix(data.albedo * data.diffuseLight, data.specularLight + data.reflection.rgb * data.reflection.a, data.specularity);\n}\n\n";pc.shaderChunks.particlePS="varying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap;\nuniform sampler2D internalTex3;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform vec4 screenSize;\nuniform float camera_far;\nuniform float softening;\nuniform float colorMult;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n\nvoid main(void) {\n    psInternalData data;\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(internalTex3, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n\n    ramp.a += texCoordsAlphaLife.z;\n\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n\n";
pc.shaderChunks.combineDiffusePS="vec3 combineColor(inout psInternalData data) {\n    return data.albedo * data.diffuseLight;\n}\n\n";pc.shaderChunks.specularityTexPS="uniform sampler2D texture_specularMap;\nvoid getSpecularity(inout psInternalData data) {\n    vec4 tex = texture2D(texture_specularMap, $UV);\n    data.specularity = tex.rgb;\n}\n\n";pc.shaderChunks.lightSpecularBlinnPS="// Energy-conserving (hopefully) Blinn-Phong\nfloat getLightSpecular(inout psInternalData data) {\n    vec3 h = normalize( -data.lightDirNormW + data.viewDirW );\n    float nh = max( dot( h, data.normalW ), 0.0 );\n\n    float specPow = exp2(data.glossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(data, specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n\n";
pc.shaderChunks.TBNPS="void getTBN(inout psInternalData data) {\n    data.TBN = mat3(normalize(vTangentW), normalize(vBinormalW), normalize(vNormalW));\n}\n\n";pc.shaderChunks.gamma2_2PS="vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\n\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return pow(color, vec3(0.45));\n}\n\n";
pc.shaderChunks.transformSkinnedVS="mat4 getModelMatrix(inout vsInternalData data) {\n    return             vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n}\n\nvec4 getPosition(inout vsInternalData data) {\n    data.modelMatrix = getModelMatrix(data);\n    vec4 posW = data.modelMatrix * vec4(vertex_position, 1.0);\n    data.positionW = posW.xyz / posW.w;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition(inout vsInternalData data) {\n    return data.positionW;\n}\n\n";
pc.shaderChunks.normalMapFloatPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpMapFactor;\nvoid getNormal(inout psInternalData data) {\n    vec3 normalMap = texture2D(texture_normalMap, $UV).xyz * 2.0 - 1.0;\n    data.normalMap = normalMap;\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpMapFactor));\n    data.normalW = data.TBN * normalMap;\n}\n\n";pc.shaderChunks.albedoTexColorPS="uniform sampler2D texture_diffuseMap;\nuniform vec3 material_diffuse;\nvoid getAlbedo(inout psInternalData data) {\n    vec4 tex = texture2DSRGB(texture_diffuseMap, $UV);\n    data.albedo = tex.rgb * material_diffuse;\n}\n\n";
pc.shaderChunks.reflectionPrefilteredCubePS="uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\nuniform samplerCube texture_prefilteredCubeMap4;\nuniform float material_reflectionFactor;\n\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvoid addCubemapReflection(inout psInternalData data) {\n\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n\n    float bias = saturate(1.0 - data.glossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n\n    vec3 fixedReflDir = fixSeamsStretch(data.reflDirW, bias, 128.0);\n\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = decodeRGBM(cubeFinal);\n\n    data.reflection += vec4(refl, material_reflectionFactor);\n}\n\n";
pc.shaderChunks.particle_lightingPS="\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n\n    rgb *= light;\n\n\n";pc.shaderChunks.fogNonePS="vec3 addFog(inout psInternalData data, vec3 color) {\n    return color;\n}\n\n\n";pc.shaderChunks.skyboxPrefilteredCubePS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n";
pc.shaderChunks.particle_blendAddPS="\n    rgb *= gammaCorrectInput(a);\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n\n";pc.shaderChunks.fogLinearPS="uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(inout psInternalData data, vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n";
pc.shaderChunks.specularityTexColorPS="uniform sampler2D texture_specularMap;\nuniform vec3 material_specular;\nvoid getSpecularity(inout psInternalData data) {\n    vec4 tex = texture2D(texture_specularMap, $UV);\n    data.specularity = tex.rgb * material_specular;\n}\n\n";pc.shaderChunks.ambientPrefilteredCubePS="vec3 fixSeamsStretch(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\n\nvoid addAmbient(inout psInternalData data) {\n    vec3 fixedReflDir = fixSeamsStretch(data.normalW, 1.0 - 1.0 / 4.0);\n    data.diffuseLight = decodeRGBM(textureCube(texture_prefilteredCubeMap4, fixedReflDir));\n}\n";
pc.shaderChunks.ambientConstantPS="\nvoid addAmbient(inout psInternalData data) {\n    data.diffuseLight = light_globalAmbient;\n}\n";pc.shaderChunks.startVS="\nvoid main(void) {\n    vsInternalData data;\n\n    gl_Position = getPosition(data);\n";pc.shaderChunks.particle_cpu_endVS="\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n}\n\n";pc.shaderChunks.combineDiffuseSpecularOldPS="vec3 combineColor(inout psInternalData data) {\n    return mix(data.albedo * data.diffuseLight + data.specularLight * data.specularity, data.reflection.rgb, data.reflection.a);\n}\n\n";
pc.shaderChunks.lightmapSinglePS="uniform sampler2D texture_lightMap;\nvoid addLightmap(inout psInternalData data) {\n    data.diffuseLight += texture2D(texture_lightMap, vUv1).rgb;\n}\n\n";pc.shaderChunks.emissionTexPS="uniform sampler2D texture_emissiveMap;\nvec3 getEmission(inout psInternalData data) {\n    vec4 tex = texture2D(texture_emissiveMap, $UV);\n    return tex.rgb;\n}\n\n";pc.shaderChunks.reflectionCubePS="uniform samplerCube texture_cubeMap;\nuniform float material_reflectionFactor;\nvoid addCubemapReflection(inout psInternalData data) {\n    data.reflection += vec4($textureCubeSAMPLE(texture_cubeMap, data.reflDirW).rgb, material_reflectionFactor);\n}\n\n";
pc.shaderChunks.fullscreenQuadVS="attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.5, 1.0);\n    vUv0 = aPosition.xy*0.5+0.5;\n}\n\n";pc.shaderChunks.particle_endVS="\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n}\n";pc.shaderChunks.tonemappingFilmicPS="const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\n\nuniform float exposure;\n\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n\n    return color;\n}\n\n";
pc.shaderChunks.tonemappingNonePS="vec3 toneMap(vec3 color) {\n    return color;\n}\n\n";pc.shaderChunks.parallaxPS="uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax(inout psInternalData data) {\n    float parallaxScale = material_heightMapFactor;\n    const float parallaxBias = 0.01;\n\n    float height = texture2D(texture_heightMap, $UV).r * parallaxScale - parallaxBias;\n    vec3 viewDirT = data.viewDirW * data.TBN;\n\n    data.uvOffset = min(height * viewDirT.xy, vec2(parallaxBias));\n}\n\n";
pc.shaderChunks.fresnelSchlickPS="// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel(inout psInternalData data) {\n    float fresnel = 1.0 - max(dot(data.normalW, data.viewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= data.glossiness * data.glossiness;\n    data.specularity = data.specularity + (1.0 - data.specularity) * fresnel;\n}\n\n";pc.shaderChunks.emissionTexColorPS="uniform sampler2D texture_emissiveMap;\nuniform vec3 material_emissive;\nvec3 getEmission(inout psInternalData data) {\n    vec4 tex = texture2D(texture_emissiveMap, $UV);\n    return tex.rgb * material_emissive;\n}\n\n";
pc.shaderChunks.particle_stretchVS="    vec3 moveDir = particleVelocity * stretch;\n    vec3 posPrev = pos - moveDir;\n    posPrev += particlePosMoved;\n\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\n    particlePos = mix(particlePos, posPrev, interpolation);\n\n";pc.shaderChunks.glossinessTexPS="uniform sampler2D texture_glossMap;\nvoid getGlossiness(inout psInternalData data) {\n    vec4 tex = texture2D(texture_glossMap, $UV);\n    data.glossiness = tex.r;\n}\n\n";pc.extend(pc.shaderChunks,function(){return{defaultGamma:pc.shaderChunks.gamma1_0PS,defaultTonemapping:pc.shaderChunks.tonemappingLinearPS}}());pc.programlib={getSnippet:function(d,a){var b="";switch(a){case "common_main_begin":b+="void main(void)\n{\n";break;case "common_main_end":b+="}\n";break;case "fs_alpha_test_decl":b+="uniform float alpha_ref;\n";break;case "fs_alpha_test":b+="    if (gl_FragColor.a < alpha_ref) discard;\n\n";break;case "fs_clamp":b+="    gl_FragColor = clamp(gl_FragColor, 0.0, 1.0);\n";break;case "fs_flat_color_decl":b+="uniform vec4 uColor;\n";break;case "fs_flat_color":b+="    gl_FragColor = uColor;\n";break;case "fs_fog_linear_decl":case "fs_fog_exp_decl":case "fs_fog_exp2_decl":b+=
"uniform vec3 fog_color;\n";b="fs_fog_linear_decl"===a?b+"uniform float fog_start;\nuniform float fog_end;\n\n":b+"uniform float fog_density;\n\n";break;case "fs_fog_linear":case "fs_fog_exp":case "fs_fog_exp2":b+="    float depth = gl_FragCoord.z / gl_FragCoord.w;\n";b="fs_fog_linear"===a?b+"    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n":"fs_fog_exp"===a?b+"    float fogFactor = exp(-depth * fog_density);\n":b+"    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n";
b+="    fogFactor = clamp(fogFactor, 0.0, 1.0);\n";b+="    gl_FragColor.rgb = mix(fog_color, gl_FragColor.rgb, fogFactor);\n";break;case "fs_precision":b+="precision "+d.precision+" float;\n\n";break;case "fs_height_map_funcs":b+="vec3 perturb_normal( vec3 N, vec3 p, vec2 uv )\n";b+="{\n";b+="    vec3 dp1 = dFdx( p );\n";b+="    vec3 dp2 = dFdy( p );\n";b+="    vec2 duv1 = dFdx( uv );\n";b+="    vec2 duv2 = dFdy( uv );\n\n";b+="    vec3 dp2perp = cross( dp2, N );\n";b+="    vec3 dp1perp = cross( N, dp1 );\n\n";
b+="    const float bumpScale = 0.125;\n";b+="    float Hll = bumpScale * texture2D( texture_heightMap, uv ).x;\n";b+="    float dBx = bumpScale * texture2D( texture_heightMap, uv + duv1 ).x - Hll;\n";b+="    float dBy = bumpScale * texture2D( texture_heightMap, uv + duv2 ).x - Hll;\n\n";b+="    float fDet = dot( dp1, dp2perp );\n";b+="    vec3 vGrad = sign( fDet ) * ( dBx * dp2perp + dBy * dp1perp );\n";b+="    return normalize( abs( fDet ) * N - vGrad );\n";b+="}\n\n";break;case "fs_normal_map_funcs":pc.precalculatedTangents||
(b+="mat3 cotangent_frame( vec3 N, vec3 p, vec2 uv )\n",b+="{\n",b+="    vec3 dp1 = dFdx( p );\n",b+="    vec3 dp2 = dFdy( p );\n",b+="    vec2 duv1 = dFdx( uv );\n",b+="    vec2 duv2 = dFdy( uv );\n\n",b+="    vec3 dp2perp = cross( dp2, N );\n",b+="    vec3 dp1perp = cross( N, dp1 );\n",b+="    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n",b+="    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n",b+="    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n",b+="    return mat3( T * invmax, B * invmax, N );\n",
b+="}\n\n",b+="vec3 perturb_normal( vec3 N, vec3 V, vec2 uv )\n",b+="{\n",b+="    vec3 map = texture2D( texture_normalMap, uv ).xyz;\n",b+="    map = map * 255./127. - 128./127.;\n",b+="    map.xy = map.xy * material_bumpMapFactor;\n",b+="    mat3 TBN = cotangent_frame( N, -V, uv );\n",b+="    return normalize( TBN * map );\n",b+="}\n\n");break;case "vs_skin_decl":b=d.supportsBoneTextures?b+"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\n\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n\n    y = dy * (y + 0.5);\n\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n\n    mat4 bone = mat4(v1, v2, v3, v4);\n\n    return bone;\n}":
b+["attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n","uniform mat4 matrix_pose["+d.getBoneLimit()+"];","\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n\n    return bone;\n}"].join("\n");b+="\n\n";break;case "vs_transform_decl":b+="attribute vec3 vertex_position;\n",b+="uniform mat4 matrix_model;\n",b+="uniform mat4 matrix_viewProjection;\n\n"}return b}};pc.programlib.basic={generateKey:function(d,a){var b="basic";a.fog&&(b+="_fog");a.alphaTest&&(b+="_atst");a.vertexColors&&(b+="_vcol");a.diffuseMap&&(b+="_diff");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.vertexColors&&(b.vertex_color=pc.SEMANTIC_COLOR);a.diffuseMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var c=pc.programlib.getSnippet,e;e=""+
c(d,"vs_transform_decl");a.skin&&(e+=c(d,"vs_skin_decl"));a.vertexColors&&(e+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");a.diffuseMap&&(e+="attribute vec2 vertex_texCoord0;\n",e+="varying vec2 vUv0;\n");e+=c(d,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",
e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):e+="    mat4 modelMatrix = matrix_model;\n";e+="\n";e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.vertexColors&&(e+="    vColor = vertex_color;\n");a.diffuseMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=c(d,"common_main_end");e=c(d,"fs_precision");e=a.vertexColors?e+"varying vec4 vColor;\n":e+"uniform vec4 uColor;\n";
a.diffuseMap&&(e+="varying vec2 vUv0;\n",e+="uniform sampler2D texture_diffuseMap;\n");a.fog&&(e+=c(d,"fs_fog_decl"));a.alphatest&&(e+=c(d,"fs_alpha_test_decl"));e+=c(d,"common_main_begin");e=a.vertexColors?e+"    gl_FragColor = vColor;\n":e+"    gl_FragColor = uColor;\n";a.diffuseMap&&(e+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");a.alphatest&&(e+=c(d,"fs_alpha_test"));e+=c(d,"fs_clamp");a.fog&&(e+=c(d,"fs_fog"));e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.programlib.depth={generateKey:function(d,a){var b="depth";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var c=pc.programlib.getSnippet,e;e=""+c(d,"vs_transform_decl");a.skin&&(e+=c(d,"vs_skin_decl"));a.opacityMap&&(e+="attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");
e+=c(d,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):e+="    mat4 modelMatrix = matrix_model;\n";e+="\n";e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";
e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.opacityMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=c(d,"common_main_end");e=c(d,"fs_precision");e+="uniform float camera_near;\n";e+="uniform float camera_far;\n";e+="vec4 packFloat(float depth)\n";e+="{\n";e+="    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n";e+="    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n";e+="    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n";
e+="    res -= res.xxyz * bit_mask;\n";e+="    return res;\n";e+="}\n\n";e+=c(d,"common_main_begin");e+="float depth = gl_FragCoord.z / gl_FragCoord.w;\n";e+="gl_FragColor = packFloat(depth / camera_far);\n";e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.programlib.depthrgba={generateKey:function(d,a){var b="depthrgba";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");a.point&&(b+="_pnt");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var c=pc.programlib.getSnippet,e;e=""+c(d,"vs_transform_decl");a.skin&&(e+=c(d,"vs_skin_decl"));a.opacityMap&&(e+=
"attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");a.point&&(e+="uniform vec3 view_position;\n\n",e+="uniform float light_radius;\n\n",e+="varying vec3 worldPos;\n\n");e+=c(d,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):
e+="    mat4 modelMatrix = matrix_model;\n";e+="\n";e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.opacityMap&&(e+="    vUv0 = vertex_texCoord0;\n");a.point&&(e+="    worldPos = positionW.xyz;\n");var g=e+=c(d,"common_main_end");e=c(d,"fs_precision");a.opacityMap&&(e+="varying vec2 vUv0;\n\n",e+="uniform sampler2D texture_opacityMap;\n\n");a.point&&(e+="varying vec3 worldPos;\n\n",e+="uniform vec3 view_position;\n\n",
e+="uniform float light_radius;\n\n");e+="vec4 packFloat(float depth)\n";e+="{\n";e+="    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n";e+="    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n";e+="    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n";e+="    res -= res.xxyz * bit_mask;\n";e+="    return res;\n";e+="}\n\n";e+=c(d,"common_main_begin");a.opacityMap&&(e+="    if (texture2D(texture_opacityMap, vUv0).r < 0.25) discard;\n\n");
e=a.point?e+"   gl_FragData[0] = packFloat(distance(view_position, worldPos) / light_radius);\n":e+"    gl_FragData[0] = packFloat(gl_FragCoord.z);\n";e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.programlib.particle={generateKey:function(d,a){var b="particle";for(prop in a)a.hasOwnProperty(prop)&&(b+=a[prop]);return b},createShaderDefinition:function(d,a){var b=pc.programlib.getSnippet,c=pc.shaderChunks,e="",b=b(d,"fs_precision")+"\n";a.useCpu?(1==a.normal&&(e+="\nvarying vec3 Normal;\n"),2==a.normal&&(e+="\nvarying mat3 ParticleMat;\n"),e+=c.particle_cpuVS,a.alignToMotion&&(e+=c.particle_pointAlongVS),e+=a.mesh?c.particle_meshVS:c.particle_billboardVS,1==a.normal&&(e+=c.particle_normalVS),
2==a.normal&&(e+=c.particle_TBNVS),0<a.stretch&&(e+=c.particle_stretchVS),e+=c.particle_cpu_endVS):(1==a.normal&&(e+="\nvarying vec3 Normal;\n"),2==a.normal&&(e+="\nvarying mat3 ParticleMat;\n"),e+=c.particleVS,a.wrap&&(e+=c.particle_wrapVS),a.alignToMotion&&(e+=c.particle_pointAlongVS),e+=a.mesh?c.particle_meshVS:c.particle_billboardVS,1==a.normal&&(e+=c.particle_normalVS),2==a.normal&&(e+=c.particle_TBNVS),0<a.stretch&&(e+=c.particle_stretchVS),e+=c.particle_endVS);0<a.normal&&(1==a.normal?b+="\nvarying vec3 Normal;\n":
2==a.normal&&(b+="\nvarying mat3 ParticleMat;\n"),b+="\nuniform vec3 lightCube[6];\n");0==a.normal&&"none"==a.fog&&(a.srgb=!1);b+=a.srgb?c.gamma2_2PS:c.gamma1_0PS;b=b+"struct psInternalData {float dummy;};\n"+c.defaultTonemapping;b="linear"===a.fog?b+c.fogLinearPS:"exp"===a.fog?b+c.fogExpPS:"exp2"===a.fog?b+c.fogExp2PS:b+c.fogNonePS;2==a.normal&&(b+="\nuniform sampler2D normalMap;\n");0<a.soft&&(b+="\nuniform sampler2D uDepthMap;\n");b+=c.particlePS;0<a.soft&&(b+=c.particle_softPS);1==a.normal&&(b+=
"\nvec3 normal = Normal;\n");2==a.normal&&(b+=c.particle_normalMapPS);0<a.normal&&(b+=a.halflambert?c.particle_halflambertPS:c.particle_lambertPS);0<a.normal&&(b+=c.particle_lightingPS);a.blend==pc.scene.BLEND_NORMAL?b+=c.particle_blendNormalPS:a.blend==pc.scene.BLEND_ADDITIVE?b+=c.particle_blendAddPS:a.blend==pc.scene.BLEND_MULTIPLICATIVE&&(b+=c.particle_blendMultiplyPS);b+=c.particle_endPS;return{attributes:pc.shaderChunks.collectAttribs(e),vshader:e,fshader:b}}};pc.programlib.phong={generateKey:function(d,a){var b=[],c="phong";for(prop in a)if("lights"===prop)for(var e=0;e<a.lights.length;e++)b.push(a.lights[e].getType()+"_"+(a.lights[e].getCastShadows()?1:0)+"_"+a.lights[e].getFalloffMode()+"_"+!!a.lights[e].getNormalOffsetBias());else a[prop]&&b.push(prop);b.sort();for(prop in b)c+="_"+b[prop]+":"+a[b[prop]];return c},_setMapTransform:function(d,a,b){d[0]+="uniform vec4 texture_"+a+"MapTransform;\n";d[3][b]||(d[1]+="varying vec2 vUv0_"+b+";\n",d[2]+="   vUv0_"+
b+"   = uv0 * texture_"+a+"MapTransform.xy + texture_"+a+"MapTransform.zw;\n",d[3][b]=!0);return d},_uvSource:function(d){return 0==d?"vUv0":"vUv0_"+d},createShaderDefinition:function(d,a){var b,c=0<a.lights.length,e=a.cubeMap||a.sphereMap||a.prefilteredCubemap,g=pc.precalculatedTangents,f=d.extTextureLod&&16>d.samplerCount;if(a.cubeMap||a.prefilteredCubemap)a.sphereMap=null;a.shadingModel===pc.scene.SPECULAR_PHONG?(a.fresnelModel=0,a.specularAA=!1):a.fresnelModel=0===a.fresnelModel?pc.scene.FRESNEL_SCHLICK:
a.fresnelModel;this.options=a;var k=pc.programlib.getSnippet,h,l,n="",r=pc.shaderChunks;h=""+r.baseVS;var m={vertex_position:pc.SEMANTIC_POSITION};l="   vPositionW    = getWorldPosition(data);\n";if(c||e)m.vertex_normal=pc.SEMANTIC_NORMAL,l+="   vNormalW    = getNormal(data);\n",a.sphereMap&&16>=d.fragmentUniformsCount&&(h+=r.viewNormalVS,l+="   vNormalV    = getViewNormal(data);\n"),a.normalMap&&g&&(m.vertex_tangent=pc.SEMANTIC_TANGENT,h+=r.tangentBinormalVS,l+="   vTangentW   = getTangent(data);\n   vBinormalW  = getBinormal(data);\n");
if(a.diffuseMap||a.specularMap||a.glossMap||a.emissiveMap||a.normalMap||a.heightMap||a.opacityMap)if(m.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0,h+=r.uv0VS,l+="   vec2 uv0        = getUv0(data);\n",l=[h,n,l,[]],a.diffuseMapTransform&&this._setMapTransform(l,"diffuse",a.diffuseMapTransform),a.normalMapTransform&&this._setMapTransform(l,"normal",a.normalMapTransform),a.heightMapTransform&&this._setMapTransform(l,"height",a.heightMapTransform),a.opacityMapTransform&&this._setMapTransform(l,"opacity",a.opacityMapTransform),
a.useSpecular&&(a.specularMapTransform&&this._setMapTransform(l,"specular",a.specularMapTransform),a.glossMapTransform&&this._setMapTransform(l,"gloss",a.glossMapTransform)),a.emissiveMapTransform&&this._setMapTransform(l,"emissive",a.emissiveMapTransform),h=l[0]+l[1],n=l[1],l=l[2],a.diffuseMap&&!a.diffuseMapTransform||a.normalMap&&!a.normalMapTransform||a.heightMap&&!a.heightMapTransform||a.opacityMap&&!a.opacityMapTransform||a.specularMap&&!a.specularMapTransform||a.emissiveMap&&!a.emissiveMapTransform||
a.glossMap&&!a.glossMapTransform)l+="   vUv0        = uv0;\n";if(a.lightMap||a.aoMap&&1===a.aoUvSet)m.vertex_texCoord1=pc.SEMANTIC_TEXCOORD1,h+=r.uv1VS,l+="   vUv1        = getUv1(data);\n";a.vertexColors&&(m.vertex_color=pc.SEMANTIC_COLOR);if(a.skin){if(m.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,m.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES,h+=k(d,"vs_skin_decl"),h+=r.transformSkinnedVS,c||e)h+=r.normalSkinnedVS}else if(h+=r.transformVS,c||e)h+=r.normalVS;h=h+"\n"+r.startVS;h+=l;l=h+="}";h=k(d,
"fs_precision");h+=r.basePS;h+=n;for(b=n=0;b<a.lights.length;b++){var w=a.lights[b].getType();h+="uniform vec3 light"+b+"_color;\n";w==pc.scene.LIGHTTYPE_DIRECTIONAL?h+="uniform vec3 light"+b+"_direction;\n":(h+="uniform vec3 light"+b+"_position;\n",h+="uniform float light"+b+"_radius;\n",w==pc.scene.LIGHTTYPE_SPOT&&(h+="uniform vec3 light"+b+"_spotDirection;\n",h+="uniform float light"+b+"_innerConeAngle;\n",h+="uniform float light"+b+"_outerConeAngle;\n"));a.lights[b].getCastShadows()&&(h+="uniform mat4 light"+
b+"_shadowMatrix;\n",h=w==pc.scene.LIGHTTYPE_POINT?h+("uniform vec4 light"+b+"_shadowParams;\n"):h+("uniform vec3 light"+b+"_shadowParams;\n"),h=w==pc.scene.LIGHTTYPE_POINT?h+("uniform samplerCube light"+b+"_shadowMap;\n"):h+("uniform sampler2D light"+b+"_shadowMap;\n"),n++)}a.alphaTest&&(h+=k(d,"fs_alpha_test_decl"));h+="\n";b=a.heightMap?" + data.uvOffset":"";a.normalMap&&g?(g=this._uvSource(a.normalMapTransform)+b,h+=r.normalMapFloatPS.replace(/\$UV/g,g),h+=r.TBNPS):h+=r.normalVertexPS;h+=r.defaultGamma;
h+=r.defaultTonemapping;h="linear"===a.fog?h+r.fogLinearPS:"exp"===a.fog?h+r.fogExpPS:"exp2"===a.fog?h+r.fogExp2PS:h+r.fogNonePS;a.hdrReflection&&(h+=r.rgbmPS);a.diffuseMap?(g=this._uvSource(a.diffuseMapTransform)+b,h=a.blendMapsWithColors&&a.needsDiffuseColor?h+r.albedoTexColorPS.replace(/\$UV/g,g):h+r.albedoTexPS.replace(/\$UV/g,g)):h+=r.albedoColorPS;a.useSpecular&&(h=a.specularAA&&a.normalMap?h+r.specularAaToksvigPS:h+r.specularAaNonePS,a.specularMap?(g=this._uvSource(a.specularMapTransform)+
b,h=a.blendMapsWithColors&&a.needsSpecularColor?h+r.specularityTexColorPS.replace(/\$UV/g,g):h+r.specularityTexPS.replace(/\$UV/g,g)):h+=r.specularityColorPS,0<a.fresnelModel&&(a.fresnelModel===pc.scene.FRESNEL_SIMPLE?h+=r.fresnelSimplePS:a.fresnelModel===pc.scene.FRESNEL_SCHLICK?h+=r.fresnelSchlickPS:a.fresnelModel===pc.scene.FRESNEL_COMPLEX&&(h+=r.fresnelComplexPS)));a.glossMap?(g=this._uvSource(a.glossMapTransform)+b,h=a.blendMapsWithColors&&a.needsGlossFloat?h+r.glossinessTexFloatPS.replace(/\$UV/g,
g):h+r.glossinessTexPS.replace(/\$UV/g,g)):h+=r.glossinessFloatPS;a.opacityMap?(g=this._uvSource(a.opacityMapTransform)+b,h=a.blendMapsWithColors&&a.needsOpacityFloat?h+r.opacityTexFloatPS.replace(/\$UV/g,g):h+r.opacityTexPS.replace(/\$UV/g,g)):h+=r.opacityFloatPS;a.emissiveMap?(g=this._uvSource(a.emissiveMapTransform)+b,h=a.blendMapsWithColors&&a.needsEmissiveColor?h+r.emissionTexColorPS.replace(/\$UV/g,g):h+r.emissionTexPS.replace(/\$UV/g,g)):h+=r.emissionColorPS;a.heightMap&&(a.normalMap||(h+=
r.TBNPS),h+=r.parallaxPS.replace(/\$UV/g,this._uvSource(a.heightMapTransform)));a.cubeMap&&(h=a.prefilteredCubemap?f?h+r.reflectionPrefilteredCubeLodPS:h+r.reflectionPrefilteredCubePS:h+r.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,a.hdrReflection?"textureCubeRGBM":"textureCubeSRGB"));a.sphereMap&&(g=16<d.fragmentUniformsCount?r.reflectionSpherePS:r.reflectionSphereLowPS,g=g.replace(/\$texture2DSAMPLE/g,a.hdrReflection?"texture2DRGBM":"texture2DSRGB"),h+=g);a.lightMap&&(h+=r.lightmapSinglePS);
a.aoMap&&(h+=r.aoBakedPS.replace(/\$UV/g,0===a.aoUvSet?"vUv0":"vUv1"));h=a.prefilteredCubemap?f?h+r.ambientPrefilteredCubeLodPS:h+r.ambientPrefilteredCubePS:h+r.ambientConstantPS;a.modulateAmbient&&(h+="uniform vec3 material_ambient;\n");0<n&&(h+=r.shadowPS);h+=r.lightDiffuseLambertPS;a.useSpecular?(h+=a.shadingModel===pc.scene.SPECULAR_PHONG?r.lightSpecularPhongPS:r.lightSpecularBlinnPS,h=a.sphereMap||a.cubeMap||0<a.fresnelModel?0<a.fresnelModel?a.conserveEnergy?h+r.combineDiffuseSpecularPS:h+r.combineDiffuseSpecularNoConservePS:
h+r.combineDiffuseSpecularOldPS:a.diffuseMap?h+r.combineDiffuseSpecularNoReflPS:h+r.combineDiffuseSpecularNoReflSeparateAmbientPS):h+=r.combineDiffusePS;h+=r.startPS;if(c||e){h+="   getViewDir(data);\n";if(a.heightMap||a.normalMap)h+="   getTBN(data);\n";a.heightMap&&(h+="   getParallax(data);\n");h+="   getNormal(data);\n";a.useSpecular&&(h+="   getReflDir(data);\n")}h+="   getAlbedo(data);\n";if(c&&a.useSpecular||e)h+="   getSpecularity(data);\n",h+="   getGlossiness(data);\n",0<a.fresnelModel&&
(h+="   getFresnel(data);\n");h+="   getOpacity(data);\n";a.alphaTest&&(h+="   if (data.alpha < alpha_ref) discard;");a.lightMap&&(h+="    addLightmap(data);\n");h+="   addAmbient(data);\n";a.modulateAmbient&&(h+="   data.diffuseLight *= material_ambient;\n");a.aoMap&&(h+="    applyAO(data);\n");if(c||e){a.cubeMap?h+="   addCubemapReflection(data);\n":a.sphereMap&&(h+="   addSpheremapReflection(data);\n");for(b=0;b<a.lights.length;b++)w=a.lights[b].getType(),w==pc.scene.LIGHTTYPE_DIRECTIONAL?(h+=
"   data.lightDirNormW = light"+b+"_direction;\n",h+="   data.atten = 1.0;\n"):(h+="   getLightDirPoint(data, light"+b+"_position);\n",h=a.lights[b].getFalloffMode()==pc.scene.LIGHTFALLOFF_LINEAR?h+("   data.atten = getFalloffLinear(data, light"+b+"_radius);\n"):h+("   data.atten = getFalloffInvSquared(data, light"+b+"_radius);\n"),w==pc.scene.LIGHTTYPE_SPOT&&(h+="   data.atten *= getSpotEffect(data, light"+b+"_spotDirection, light"+b+"_innerConeAngle, light"+b+"_outerConeAngle);\n")),h+="   data.atten *= getLightDiffuse(data);\n",
a.lights[b].getCastShadows()&&(w==pc.scene.LIGHTTYPE_POINT?(c="(data, light"+b+"_shadowMap, light"+b+"_shadowParams);\n",h=a.lights[b].getNormalOffsetBias()?h+("   data.atten *= getShadowPointNormalOffset"+c):h+("   data.atten *= getShadowPoint"+c)):(c="(data, light"+b+"_shadowMatrix, light"+b+"_shadowParams);\n",h=a.lights[b].getNormalOffsetBias()?w==pc.scene.LIGHTTYPE_SPOT?h+("   getShadowCoordPerspNormalOffset"+c):h+("   getShadowCoordOrthoNormalOffset"+c):w==pc.scene.LIGHTTYPE_SPOT?h+("   getShadowCoordPersp"+
c):h+("   getShadowCoordOrtho"+c),h+="   data.atten *= getShadowPCF3x3(data, light"+b+"_shadowMap, light"+b+"_shadowParams);\n")),h+="   data.diffuseLight += data.atten * light"+b+"_color;\n",a.useSpecular&&(h+="   data.atten *= getLightSpecular(data);\n",h+="   data.specularLight += data.atten * light"+b+"_color;\n"),h+="\n"}h+="\n";a.aoMap&&a.occludeSpecular&&(h+="    occludeSpecular(data);\n");h+=r.endPS;h+=k(d,"fs_clamp");h+=k(d,"common_main_end");return{attributes:m,vshader:l,fshader:h}}};pc.programlib.pick={generateKey:function(d,a){var b="pick";a.skin&&(b+="_skin");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);var c=pc.programlib.getSnippet,e;e=""+c(d,"vs_transform_decl");a.skin&&(e+=c(d,"vs_skin_decl"));e+=c(d,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",
e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):e+="    mat4 modelMatrix = matrix_model;\n";e+="\n";e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";var g=e+=c(d,"common_main_end");e=c(d,"fs_precision");e+=c(d,"fs_flat_color_decl");e+=c(d,"common_main_begin");e+=c(d,"fs_flat_color");
e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.programlib.skybox={generateKey:function(d,a){return"skybox"+a.hdr+a.prefiltered+""+a.toneMapping+""+a.gamma},createShaderDefinition:function(d,a){var b=pc.programlib.getSnippet,c=pc.shaderChunks;return{attributes:{aPosition:pc.SEMANTIC_POSITION},vshader:"attribute vec3 aPosition;\n\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\n\nvarying vec3 vViewDir;\n\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projection * view * vec4(aPosition, 1.0);\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n}",
fshader:b(d,"fs_precision")+(a.hdr?c.defaultGamma+c.defaultTonemapping+c.rgbmPS+(a.prefiltered?c.skyboxPrefilteredCubePS:c.skyboxHDRPS):c.skyboxPS)}}};pc.extend(pc.gfx,{defaultGamma:pc.defaultGamma,defaultTonemapping:pc.defaultTonemapping,drawQuadWithShader:pc.drawQuadWithShader,precalculatedTangents:pc.precalculatedTangents,programlib:pc.programlib,shaderChunks:pc.shaderChunks,ContextCreationError:pc.ContextCreationError,Device:pc.GraphicsDevice,IndexBuffer:pc.IndexBuffer,ProgramLibrary:pc.ProgramLibrary,RenderTarget:pc.RenderTarget,ScopeId:pc.ScopeId,Shader:pc.Shader,ShaderInput:pc.ShaderInput,Texture:pc.Texture,UnsupportedBrowserError:pc.UnsupportedBrowserError,
VertexBuffer:pc.VertexBuffer,VertexFormat:pc.VertexFormat,VertexIterator:pc.VertexIterator});pc.posteffect={};
pc.extend(pc.posteffect,function(){var d=function(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=pc.posteffect.createFullscreenQuad(a);this.needsDepthBuffer=!1};d.prototype={render:function(){}};return{PostEffect:d,createFullscreenQuad:function(a){var b=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.ELEMENTTYPE_FLOAT32}]),a=new pc.VertexBuffer(a,b,4),b=new pc.VertexIterator(a);b.element[pc.SEMANTIC_POSITION].set(-1,-1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,-1);
b.next();b.element[pc.SEMANTIC_POSITION].set(-1,1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,1);b.end();return a},drawFullscreenQuad:function(a,b,c,e,g){a.setRenderTarget(b);a.updateBegin();var d=null!==b?b.width:a.width,b=null!==b?b.height:a.height,k=0,h=0;g&&(k=g.x*d,h=g.y*b,d*=g.z,b*=g.w);a.setViewport(k,h,d,b);a.setScissor(k,h,d,b);g=a.getBlending();d=a.getDepthTest();b=a.getDepthWrite();a.setBlending(!1);a.setDepthTest(!1);a.setDepthWrite(!1);a.setVertexBuffer(c,0);a.setShader(e);a.draw({type:pc.PRIMITIVE_TRISTRIP,
base:0,count:4,indexed:!1});a.setBlending(g);a.setDepthTest(d);a.setDepthWrite(b);a.updateEnd()}}}());pc.extend(pc.posteffect,function(){function d(a,b){this.context=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;b.on("set_rect",this.onCameraRectChanged,this)}d.prototype={_createOffscreenTarget:function(a){var b=this.camera.rect,b=new pc.Texture(this.context.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:Math.floor(b.z*this.context.graphicsDevice.width*this.renderTargetScale),height:Math.floor(b.w*this.context.graphicsDevice.height*
this.renderTargetScale)});b.minFilter=pc.FILTER_NEAREST;b.magFilter=pc.FILTER_NEAREST;b.addressU=pc.ADDRESS_CLAMP_TO_EDGE;b.addressV=pc.ADDRESS_CLAMP_TO_EDGE;return new pc.RenderTarget(this.context.graphicsDevice,b,{depth:a})},_setDepthTarget:function(a){this.depthTarget!==a&&(this.depthTarget&&this.depthTarget.destroy(),this.depthTarget=a);this.camera.camera._depthTarget=a},setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},addEffect:function(a){var b=0===this.effects.length,
c=this.effects,e={effect:a,inputTarget:this._createOffscreenTarget(b),outputTarget:null};a.needsDepthBuffer&&(this.depthTarget||this._setDepthTarget(this._createOffscreenTarget(!0)),a.depthMap=this.depthTarget.colorBuffer);b&&(this.camera.renderTarget=e.inputTarget);c.push(e);a=c.length;1<a&&(c[a-2].outputTarget=e.inputTarget);this.enable()},removeEffect:function(a){for(var b=-1,c=0,e=this.effects.length;c<e;c++)if(this.effects[c].effect===a){b=c;break}0<=b&&(0<b?this.effects[b-1].outputTarget=b+
1<this.effects.length?this.effects[b+1].inputTarget:null:1<this.effects.length&&(this.effects[1].inputTarget._depth||(this.effects[1].inputTarget.destroy(),this.effects[1].inputTarget=this._createOffscreenTarget(!0)),this.camera.renderTarget=this.effects[1].inputTarget),this.effects[b].inputTarget.destroy(),this.effects.splice(b,1));if(this.depthTarget){a=!1;c=0;for(e=this.effects.length;c<e;c++)if(this.effects[c].effect.needsDepthBuffer){a=!0;break}a||this._setDepthTarget(null)}0===this.effects.length&&
this.disable()},destroy:function(){this.depthTarget&&(this.depthTarget.destroy(),this.depthTarget=null);for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].inputTarget.destroy();this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var a=this.effects,b=this.camera;this.context.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);b.camera.setRect(0,0,1,1);this.command=new pc.scene.Command(pc.scene.LAYER_FX,pc.scene.BLEND_NONE,function(){if(this.enabled&&
b.data.isRendering){var c=null,e=a.length;if(e){b.renderTarget=a[0].inputTarget;this._setDepthTarget(this.depthTarget);for(var g=0;g<e;g++){var d=a[g];g===e-1&&(c=b.rect);d.effect.render(d.inputTarget,d.outputTarget,c)}}}}.bind(this));this.context.scene.drawCalls.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1;this.context.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this.camera.renderTarget=null;this.camera.camera._depthTarget=null;var a=this.camera.rect;
this.camera.camera.setRect(a.x,a.y,a.z,a.w);a=this.context.scene.drawCalls.indexOf(this.command);0<=a&&this.context.scene.drawCalls.splice(a,1)}},_onCanvasResized:function(){this.resizeTimeout&&clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(this.resizeRenderTargets.bind(this),500)},resizeRenderTargets:function(){var a=this.camera.rect,b=Math.floor(a.z*this.context.graphicsDevice.width*this.renderTargetScale),a=Math.floor(a.w*this.context.graphicsDevice.height*this.renderTargetScale),
c=this.effects;this.depthTarget&&(this.depthTarget.width!==b&&this.depthTarget.height!==a)&&this._setDepthTarget(this._createOffscreenTarget(!0));for(var e=0,g=c.length;e<g;e++){var d=c[e];if(d.inputTarget.width!==b||d.inputTarget.height!==a)d.inputTarget.destroy(),d.inputTarget=this._createOffscreenTarget(d.effect.needsDepthBuffer||0===e),d.effect.needsDepthBuffer&&(d.depthMap=this.depthTarget),0<e?c[e-1].outputTarget=d.inputTarget:this.camera.renderTarget=d.inputTarget}},onCameraRectChanged:function(){this.enabled&&
(this.camera.camera.setRect(0,0,1,1),this.resizeRenderTargets())}};return{PostEffectQueue:d}}());pc.scene={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:3,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2",TONEMAP_LINEAR:0,TONEMAP_FILMIC:1,SPECULAR_PHONG:0,SPECULAR_BLINN:1,FRESNEL_NONE:0,FRESNEL_SIMPLE:1,FRESNEL_SCHLICK:2,FRESNEL_COMPLEX:3};
pc.extend(pc.scene,function(){var d=function(){this.drawCalls=[];this.shadowCasters=[];this.fog=pc.scene.FOG_NONE;this.fogColor=new pc.Color(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new pc.Color(0,0,0);this._gammaCorrection=!1;this._toneMapping=0;this.exposure=1;this._skyboxModel=this._skyboxCubeMap=this._prefilteredCubeMap4=this._prefilteredCubeMap8=this._prefilteredCubeMap16=this._prefilteredCubeMap32=this._prefilteredCubeMap64=this._prefilteredCubeMap128=null;
this._models=[];this._lights=[];this._globalLights=[];this._localLights=[[],[]];this.updateShaders=!0};Object.defineProperty(d.prototype,"fog",{get:function(){return this._fog},set:function(a){a!==this._fog&&(this._fog=a,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(a){a!==this._gammaCorrection&&(this._gammaCorrection=a,pc.shaderChunks.defaultGamma=a?pc.shaderChunks.gamma2_2PS:pc.shaderChunks.gamma1_0PS,this.updateShaders=
!0)}});Object.defineProperty(d.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(a){a!==this._toneMapping&&(this._toneMapping=a,pc.shaderChunks.defaultTonemapping=a?pc.shaderChunks.tonemappingFilmicPS:pc.shaderChunks.tonemappingLinearPS,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"skybox",{get:function(){return this._skyboxCubeMap},set:function(a){a!==this._skyboxCubeMap&&(this._skyboxCubeMap=a,this._skyboxModel&&this.containsModel(this._skyboxModel)&&
this.removeModel(this._skyboxModel),this._skyboxModel=null,this.updateShaders=!0)}});d.prototype._updateShaders=function(a){var b;if(this._skyboxCubeMap&&!this._skyboxModel){var c=new pc.scene.Material,e=this;c.updateShader=function(){var b=a.getProgramLibrary().getProgram("skybox",{hdr:e._skyboxCubeMap.hdr,prefiltered:e._skyboxCubeMap.hdr,gamma:e.gammaCorrection,toneMapping:e.toneMapping});this.setShader(b)};c.updateShader();c.setParameter("texture_cubeMap",this._skyboxCubeMap);c.cull=pc.CULLFACE_NONE;
b=new pc.scene.GraphNode;var g=pc.scene.procedural.createBox(a),c=new pc.scene.MeshInstance(b,g,c),g=new pc.scene.Model;g.graph=b;g.meshInstances=[c];this._skyboxModel=g;this.addModel(g)}c=[];g=this.drawCalls;for(b=0;b<g.length;b++){var d=g[b];void 0!==d.material&&-1===c.indexOf(d.material)&&c.push(d.material)}for(b=0;b<c.length;b++)c[b].updateShader(a,this)};d.prototype.getModels=function(){return this._models};d.prototype.addModel=function(a){var b;if(-1===this._models.indexOf(a)){this._models.push(a);
var c=a.getMaterials();for(b=0;b<c.length;b++)c[b].scene=this;var e=a.meshInstances.length;for(b=0;b<e;b++)c=a.meshInstances[b],-1===this.drawCalls.indexOf(c)&&this.drawCalls.push(c),c.castShadow&&-1===this.shadowCasters.indexOf(c)&&this.shadowCasters.push(c);a=a.getLights();b=0;for(len=a.length;b<len;b++)this.addLight(a[b])}};d.prototype.removeModel=function(a){var b,c=this._models.indexOf(a);if(-1!==c){this._models.splice(c,1);c=a.getMaterials();for(b=0;b<c.length;b++)c[b].scene=null;var e,g=a.meshInstances.length;
for(b=0;b<g;b++)e=a.meshInstances[b],c=this.drawCalls.indexOf(e),-1!==c&&this.drawCalls.splice(c,1),e.castShadow&&(c=this.shadowCasters.indexOf(e),-1!==c&&this.shadowCasters.splice(c,1));a=a.getLights();b=0;for(len=a.length;b<len;b++)this.removeLight(a[b])}};d.prototype.containsModel=function(a){return 0<=this._models.indexOf(a)};d.prototype.addLight=function(a){-1!==this._lights.indexOf(a)?console.warn("pc.scene.Scene#addLight: light is already in the scene"):(this._lights.push(a),a._scene=this,
this.updateShaders=!0)};d.prototype.removeLight=function(a){var b=this._lights.indexOf(a);-1===b?console.warn("pc.scene.Scene#removeLight: light is not in the scene"):(this._lights.splice(b,1),a._scene=null,this.updateShaders=!0)};d.prototype.update=function(){for(var a=0,b=this._models.length;a<b;a++)this._models[a].getGraph().syncHierarchy()};return{Scene:d}}());pc.extend(pc.scene,function(){function d(a,b){return a.distSqr&&b.distSqr?b.distSqr-a.distSqr:b.key-a.key}function a(a,b){var c;if(b.getType()===pc.scene.LIGHTTYPE_POINT){c=b._shadowResolution;c=new pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:c,height:c,cubemap:!0,autoMipmap:!1});c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(var e=[],g=0;6>g;g++){var d=new pc.RenderTarget(a,c,{face:g,depth:!0});e.push(d)}c=
e;b._shadowCamera.setRenderTarget(c[0]);b._shadowCubeMap=c}else c=new pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:b._shadowResolution,height:b._shadowResolution,autoMipmap:!1}),c.minFilter=pc.FILTER_NEAREST,c.magFilter=pc.FILTER_NEAREST,c.addressU=pc.ADDRESS_CLAMP_TO_EDGE,c.addressV=pc.ADDRESS_CLAMP_TO_EDGE,c=new pc.RenderTarget(a,c,!0),b._shadowCamera.setRenderTarget(c)}function b(a){this.device=a;a=this.device.getProgramLibrary();this._depthProgStatic=a.getProgram("depthrgba",{skin:!1,
opacityMap:!1});this._depthProgSkin=a.getProgram("depthrgba",{skin:!0,opacityMap:!1});this._depthProgStaticOp=a.getProgram("depthrgba",{skin:!1,opacityMap:!0});this._depthProgSkinOp=a.getProgram("depthrgba",{skin:!0,opacityMap:!0});this._depthShaderStatic=a.getProgram("depth",{skin:!1});this._depthShaderSkin=a.getProgram("depth",{skin:!0});this._depthProgStaticPoint=a.getProgram("depthrgba",{skin:!1,opacityMap:!1,point:!0});this._depthProgSkinPoint=a.getProgram("depthrgba",{skin:!0,opacityMap:!1,
point:!0});this._depthProgStaticOpPoint=a.getProgram("depthrgba",{skin:!1,opacityMap:!0,point:!0});this._depthProgSkinOpPoint=a.getProgram("depthrgba",{skin:!0,opacityMap:!0,point:!0});a=this.device.scope;this.projId=a.resolve("matrix_projection");this.viewId=a.resolve("matrix_view");this.viewId3=a.resolve("matrix_view3");this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=a.resolve("matrix_viewProjection");this.viewPosId=a.resolve("view_position");this.nearClipId=a.resolve("camera_near");
this.farClipId=a.resolve("camera_far");this.lightRadiusId=a.resolve("light_radius");this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");this.modelMatrixId=a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");this.boneTextureId=a.resolve("texture_poseMap");this.boneTextureSizeId=a.resolve("texture_poseMapSize");this.alphaTestId=a.resolve("alpha_ref");
this.shadowEnableId=a.resolve("shadow_enable");this._shadowAabb=new pc.shape.Aabb;this._sceneAabb=new pc.shape.Aabb;this._shadowState={blend:!1};this.centroid=new pc.Vec3;this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3)}var c=(new pc.Mat4).setScale(0.5,0.5,0.5),e=(new pc.Mat4).setTranslate(0.5,0.5,0.5),g=(new pc.Mat4).mul2(e,c),f=(new pc.Mat4).setFromAxisAngle(pc.Vec3.RIGHT,-90),k=new pc.Mat4,h=new pc.Mat4,l=new pc.Mat4,n=new pc.Mat4,r=new pc.Mat3,m=new pc.Mat4,w=new pc.Mat4,
u=[];for(i=0;8>i;i++)u.push(new pc.Vec3);pc.extend(b.prototype,{setCamera:function(a){var b=a.getProjectionMatrix();this.projId.setValue(b.data);var c=a.getWorldTransform();this.viewInvId.setValue(c.data);n.copy(c).invert();this.viewId.setValue(n.data);r.data[0]=n.data[0];r.data[1]=n.data[1];r.data[2]=n.data[2];r.data[3]=n.data[4];r.data[4]=n.data[5];r.data[5]=n.data[6];r.data[6]=n.data[8];r.data[7]=n.data[9];r.data[8]=n.data[10];this.viewId3.setValue(r.data);m.mul2(b,n);this.viewProjId.setValue(m.data);
this.viewPosId.setValue(a.getPosition().data);this.nearClipId.setValue(a.getNearClip());this.farClipId.setValue(a.getFarClip());a._frustum.update(b,n);var b=this.device,e=a.getRenderTarget();b.setRenderTarget(e);b.updateBegin();var c=a.getRect(),g=e?e.width:b.width,d=e?e.height:b.height,e=Math.floor(c.x*g),f=Math.floor(c.y*d),g=Math.floor(c.width*g),c=Math.floor(c.height*d);b.setViewport(e,f,g,c);b.setScissor(e,f,g,c);b.clear(a.getClearOptions())},dispatchGlobalLights:function(a){var b=a._globalLights,
c=b.length,e,g=this.device.scope;this.ambientColor[0]=a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;if(a.gammaCorrection)for(e=0;3>e;e++)this.ambientColor[e]=Math.pow(this.ambientColor[e],2.2);g.resolve("light_globalAmbient").setValue(this.ambientColor);g.resolve("exposure").setValue(a.exposure);for(e=0;e<c;e++){var d=b[e],f=d.getWorldTransform(),h="light"+e;g.resolve(h+"_color").setValue(a.gammaCorrection?d._linearFinalColor.data:d._finalColor.data);
f.getY(d._direction).scale(-1);g.resolve(h+"_direction").setValue(d._direction.normalize().data);d.getCastShadows()&&(f=this.device.extDepthTexture?d._shadowCamera._renderTarget._depthTexture:d._shadowCamera._renderTarget.colorBuffer,g.resolve(h+"_shadowMap").setValue(f),g.resolve(h+"_shadowMatrix").setValue(d._shadowMatrix.data),g.resolve(h+"_shadowParams").setValue([d._shadowResolution,d._normalOffsetBias,d._shadowBias]))}},dispatchLocalLights:function(a){var b,c,e,g,d;b=a._localLights;g=b[pc.scene.LIGHTTYPE_POINT-
1];var f=b[pc.scene.LIGHTTYPE_SPOT-1],h=a._globalLights.length,k=g.length,l=f.length,n=this.device.scope;for(b=0;b<k;b++)e=g[b],c=e.getWorldTransform(),d="light"+(h+b),n.resolve(d+"_radius").setValue(e._attenuationEnd),n.resolve(d+"_color").setValue(a.gammaCorrection?e._linearFinalColor.data:e._finalColor.data),c.getTranslation(e._position),n.resolve(d+"_position").setValue(e._position.data),e.getCastShadows()&&(c=this.device.extDepthTexture?e._shadowCamera._renderTarget._depthTexture:e._shadowCamera._renderTarget.colorBuffer,
n.resolve(d+"_shadowMap").setValue(c),n.resolve(d+"_shadowMatrix").setValue(e._shadowMatrix.data),n.resolve(d+"_shadowParams").setValue([e._shadowResolution,e._normalOffsetBias,e._shadowBias,e.getAttenuationEnd()]));for(b=0;b<l;b++)g=f[b],c=g.getWorldTransform(),d="light"+(h+k+b),n.resolve(d+"_innerConeAngle").setValue(g._innerConeAngleCos),n.resolve(d+"_outerConeAngle").setValue(g._outerConeAngleCos),n.resolve(d+"_radius").setValue(g._attenuationEnd),n.resolve(d+"_color").setValue(a.gammaCorrection?
g._linearFinalColor.data:g._finalColor.data),c.getTranslation(g._position),n.resolve(d+"_position").setValue(g._position.data),c.getY(g._direction).scale(-1),n.resolve(d+"_spotDirection").setValue(g._direction.data),g.getCastShadows()&&(c=this.device.extDepthTexture?g._shadowCamera._renderTarget._depthTexture:g._shadowCamera._renderTarget.colorBuffer,n.resolve(d+"_shadowMap").setValue(c),n.resolve(d+"_shadowMatrix").setValue(g._shadowMatrix.data),n.resolve(d+"_shadowParams").setValue([g._shadowResolution,
g._normalOffsetBias,g._shadowBias]))},render:function(b,c){var e=this.device,n=e.scope;b._activeCamera=c;b.updateShaders&&(b._updateShaders(e),b.updateShaders=!1);var m=b._lights,r=b.drawCalls,E=b.shadowCasters,D,I,M,y,B,H,C,J=null;D=0;for(numDrawCalls=b.drawCalls.length;D<numDrawCalls;D++)y=b.drawCalls[D],y.skinInstance&&y.skinInstance.updateMatrixPalette();b._globalLights.length=0;b._localLights[0].length=0;for(D=b._localLights[1].length=0;D<m.length;D++){var G=m[D];G.getEnabled()&&(G.getType()===
pc.scene.LIGHTTYPE_DIRECTIONAL?b._globalLights.push(G):b._localLights[G.getType()===pc.scene.LIGHTTYPE_POINT?0:1].push(G))}G=c.getPosition();D=0;for(numDrawCalls=r.length;D<numDrawCalls;D++)if(y=r[D],!y.command&&(B=y,B.layer===pc.scene.LAYER_WORLD))if(B.material.blendType===pc.scene.BLEND_NORMAL||B.material.blendType===pc.scene.BLEND_PREMULTIPLIED){B.syncAabb();var K=B.aabb.center,P=K.x-G.x;y=K.y-G.y;K=K.z-G.z;B.distSqr=P*P+y*y+K*K}else void 0!==B.distSqr&&delete B.distSqr;r.sort(d);if(c._depthTarget){G=
c.getRenderTarget();c.setRenderTarget(c._depthTarget);this.setCamera(c);P=e.getBlending();e.setBlending(!1);D=0;for(numDrawCalls=r.length;D<numDrawCalls;D++){y=r[D];if(!y.command&&y.drawToDepth){B=y;H=B.mesh;this.modelMatrixId.setValue(B.node.worldTransform.data);if(B.skinInstance){if(e.supportsBoneTextures){this.boneTextureId.setValue(B.skinInstance.boneTexture);var Q=B.skinInstance.boneTexture.width,N=B.skinInstance.boneTexture.height;this.boneTextureSizeId.setValue([Q,N])}else this.poseMatrixId.setValue(B.skinInstance.matrixPalette);
e.setShader(this._depthShaderSkin)}else e.setShader(this._depthShaderStatic);B=B.renderStyle;e.setVertexBuffer(H.vertexBuffer,0);e.setIndexBuffer(H.indexBuffer[B]);e.draw(H.primitive[B])}c.setRenderTarget(G)}e.setBlending(P)}for(D=0;D<m.length;D++)if(G=m[D],P=G.getType(),G.getCastShadows()&&G.getEnabled()){y=e;K=G;B=K._shadowCamera;I=void 0;null===B?(B=K,I=pc.CLEARFLAG_DEPTH,y.extDepthTexture||(I|=pc.CLEARFLAG_COLOR),H=new pc.scene.CameraNode,H.setClearOptions({color:[1,1,1,1],depth:1,flags:I}),B=
B._shadowCamera=H,a(y,K)):(I=B.getRenderTarget(),(I.width!==K._shadowResolution||I.height!==K._shadowResolution)&&a(y,K));y=B;var K=1,L;if(P===pc.scene.LIGHTTYPE_DIRECTIONAL){I=G.getShadowDistance();B=c;H=this.centroid;H.set(0,0,0.5*-(I+B._nearClip));B.getWorldTransform().transformPoint(H,H);y.setPosition(this.centroid);y.setRotation(G.getRotation());y.rotateLocal(-90,0,0);B=c;H=u;M=B;C=M.getNearClip();Q=M.getFov()*Math.PI/180;N=M.getAspectRatio();M=M.getProjection();var R=L=void 0,R=M===pc.scene.Projection.PERSPECTIVE?
Math.tan(Q/2)*C:B._orthoHeight;L=R*N;H[0].x=L;H[0].y=-R;H[0].z=-C;H[1].x=L;H[1].y=R;H[1].z=-C;H[2].x=-L;H[2].y=R;H[2].z=-C;H[3].x=-L;H[3].y=-R;H[3].z=-C;M===pc.scene.Projection.PERSPECTIVE&&(R=Math.tan(Q/2)*I,L=R*N);H[4].x=L;H[4].y=-R;H[4].z=-I;H[5].x=L;H[5].y=R;H[5].z=-I;H[6].x=-L;H[6].y=R;H[6].z=-I;H[7].x=-L;H[7].y=-R;H[7].z=-I;k.copy(y.getWorldTransform());B=k.invert();w.mul2(B,c.worldTransform);for(I=0;8>I;I++)w.transformPoint(u[I],u[I]);B=H=C=1E6;Q=N=M=-1E6;for(I=0;8>I;I++)L=u[I],L.x<B&&(B=L.x),
L.x>Q&&(Q=L.x),L.y<H&&(H=L.y),L.y>N&&(N=L.y),L.z<C&&(C=L.z),L.z>M&&(M=L.z);y.translateLocal(0.5*-(Q+B),0.5*(N+H),M+0.25*(M-C));k.copy(y.getWorldTransform());y.setProjection(pc.scene.Projection.ORTHOGRAPHIC);y.setNearClip(0);y.setFarClip(1.5*(M-C));y.setAspectRatio((Q-B)/(N-H));y.setOrthoHeight(0.5*(N-H))}else P===pc.scene.LIGHTTYPE_SPOT?(y.setProjection(pc.scene.Projection.PERSPECTIVE),y.setNearClip(G.getAttenuationEnd()/1E3),y.setFarClip(G.getAttenuationEnd()),y.setAspectRatio(1),y.setFov(2*G.getOuterConeAngle()),
k.mul2(G.worldTransform,f)):P===pc.scene.LIGHTTYPE_POINT&&(y.setProjection(pc.scene.Projection.PERSPECTIVE),y.setNearClip(G.getAttenuationEnd()/1E3),y.setFarClip(G.getAttenuationEnd()),y.setAspectRatio(1),y.setFov(90),K=6,this.viewPosId.setValue(y.getPosition().data),this.lightRadiusId.setValue(G.getAttenuationEnd()));P!=pc.scene.LIGHTTYPE_POINT&&(h.copy(k).invert(),l.mul2(y.getProjectionMatrix(),h),G._shadowMatrix.mul2(g,l),y.worldTransform.copy(k));for(L=0;L<K;L++){P===pc.scene.LIGHTTYPE_POINT&&
(0===L?y.setEulerAngles(0,90,180):1===L?y.setEulerAngles(0,-90,180):2===L?y.setEulerAngles(90,0,0):3===L?y.setEulerAngles(-90,0,0):4===L?y.setEulerAngles(0,180,180):5===L&&y.setEulerAngles(0,0,180),y.setPosition(G.getPosition()),y.setRenderTarget(G._shadowCubeMap[L]));this.setCamera(y);e.setBlending(!1);e.setColorWrite(!0,!0,!0,!0);e.setDepthWrite(!0);e.setDepthTest(!0);e.extDepthTexture&&e.setColorWrite(!1,!1,!1,!1);I=0;for(M=E.length;I<M;I++)B=E[I],H=B.mesh,C=B.material,e.setCullMode(C.cull),this.modelMatrixId.setValue(B.node.worldTransform.data),
C.opacityMap&&n.resolve("texture_opacityMap").setValue(C.opacityMap),B.skinInstance?(e.supportsBoneTextures?(this.boneTextureId.setValue(B.skinInstance.boneTexture),Q=B.skinInstance.boneTexture.width,N=B.skinInstance.boneTexture.height,this.boneTextureSizeId.setValue([Q,N])):this.poseMatrixId.setValue(B.skinInstance.matrixPalette),P===pc.scene.LIGHTTYPE_POINT?e.setShader(C.opacityMap?this._depthProgSkinOpPoint:this._depthProgSkinPoint):e.setShader(C.opacityMap?this._depthProgSkinOp:this._depthProgSkin)):
P===pc.scene.LIGHTTYPE_POINT?e.setShader(C.opacityMap?this._depthProgStaticOpPoint:this._depthProgStaticPoint):e.setShader(C.opacityMap?this._depthProgStaticOp:this._depthProgStatic),B=B.renderStyle,e.setVertexBuffer(H.vertexBuffer,0),e.setIndexBuffer(H.indexBuffer[B]),e.draw(H.primitive[B])}}this.setCamera(c);this.dispatchGlobalLights(b);this.dispatchLocalLights(b);if(b.fog!==pc.scene.FOG_NONE){this.fogColor[0]=b.fogColor.r;this.fogColor[1]=b.fogColor.g;this.fogColor[2]=b.fogColor.b;if(b.gammaCorrection)for(D=
0;3>D;D++)this.fogColor[D]=Math.pow(this.fogColor[D],2.2);this.fogColorId.setValue(this.fogColor);b.fog===pc.scene.FOG_LINEAR?(this.fogStartId.setValue(b.fogStart),this.fogEndId.setValue(b.fogEnd)):this.fogDensityId.setValue(b.fogDensity)}D=0;for(numDrawCalls=r.length;D<numDrawCalls;D++)if(y=r[D],y.command)y.command();else{B=y;H=B.mesh;C=B.material;n=B.node.worldTransform;m=B.normalMatrix;n.invertTo3x3(m);m.transpose();this.modelMatrixId.setValue(n.data);this.normalMatrixId.setValue(m.data);B.skinInstance&&
(e.supportsBoneTextures?(this.boneTextureId.setValue(B.skinInstance.boneTexture),Q=B.skinInstance.boneTexture.width,N=B.skinInstance.boneTexture.height,this.boneTextureSizeId.setValue([Q,N])):this.poseMatrixId.setValue(B.skinInstance.matrixPalette));this.shadowEnableId.setValue(B.receiveShadow);if(C!==J){C.shader||C.updateShader(e,b);e.setShader(C.shader);var J=C.parameters,O;for(O in J)n=J[O],n.scopeId||(n.scopeId=e.scope.resolve(O)),n.scopeId.setValue(n.data);this.alphaTestId.setValue(C.alphaTest);
e.setBlending(C.blend);e.setBlendFunction(C.blendSrc,C.blendDst);e.setBlendEquation(C.blendEquation);e.setColorWrite(C.redWrite,C.greenWrite,C.blueWrite,C.alphaWrite);e.setCullMode(C.cull);e.setDepthWrite(C.depthWrite);e.setDepthTest(C.depthTest)}e.setVertexBuffer(H.vertexBuffer,0);B=B.renderStyle;e.setIndexBuffer(H.indexBuffer[B]);e.draw(H.primitive[B]);J=C}}});return{ForwardRenderer:b}}());pc.extend(pc.scene,function(){var d=function(a){this.name=a||"Untitled";this._labels={};this.localPosition=new pc.Vec3(0,0,0);this.localRotation=new pc.Quat(0,0,0,1);this.localScale=new pc.Vec3(1,1,1);this.localEulerAngles=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.rotation=new pc.Quat(0,0,0,1);this.eulerAngles=new pc.Vec3(0,0,0);this.localTransform=new pc.Mat4;this.dirtyLocal=!1;this.worldTransform=new pc.Mat4;this.dirtyWorld=!1;this._right=new pc.Vec3;this._up=new pc.Vec3;this._forward=
new pc.Vec3;this._parent=null;this._children=[];this._enabledInHierarchy=this._enabled=!0};Object.defineProperty(d.prototype,"right",{get:function(){return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(d.prototype,"up",{get:function(){return this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(d.prototype,"forward",{get:function(){return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(d.prototype,
"forwards",{get:function(){console.log("pc.GraphNode#forwards is DEPRECATED. Use pc.GraphNode#forward instead.");return this.forward}});Object.defineProperty(d.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,(!this._parent||this._parent.enabled)&&this._notifyHierarchyStateChanged(this,a))}});pc.extend(d.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);for(var c=a._children,e=
0,g=c.length;e<g;e++)c[e]._enabled&&this._notifyHierarchyStateChanged(c[e],b)},_onHierarchyStateChanged:function(a){this._enabledInHierarchy=a},_cloneInternal:function(a){a.name=this.name;a._labels=pc.extend(this._labels,{});a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);
a.dirtyLocal=this.dirtyLocal;a.worldTransform.copy(this.worldTransform);a.dirtyWorld=this.dirtyWorld;a._enabled=this._enabled;a._enabledInHierarchy=this._enabledInHierarchy},clone:function(){var a=new pc.scene.GraphNode;this._cloneInternal(a);return a},find:function(a,b){var c,e=this.getChildren(),g=e.length,d=[];this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b&&d.push(this));for(c=0;c<g;++c)d=d.concat(e[c].find(a,b));return d},findOne:function(a,b){var c,e=this.getChildren(),g=e.length,
d=null;if(this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b))return this;for(c=0;c<g;++c)if(d=e[c].findOne(a,b),null!==d)return d;return null},findByName:function(a){if(this.name===a)return this;for(var b=0;b<this._children.length;b++){var c=this._children[b].findByName(a);if(null!==c)return c}return null},findByPath:function(a){for(var a=a.split("/"),b=this,c=null,e=0,g=a.length;e<g&&b;e++){for(var d=a[e],c=null,b=b._children,k=0,h=b.length;k<h;k++)if(b[k].name==d){c=b[k];break}b=c}return c},
getPath:function(){var a=this._parent;if(a){for(var b=this.name;a&&a._parent;)b=pc.string.format("{0}/{1}",a.name,b),a=a._parent;return b}return""},getRoot:function(){var a=this.getParent();if(!a)return this;for(;a.getParent();)a=a.getParent();return a},getParent:function(){return this._parent},getChildren:function(){return this._children},getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);
return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);return this.localTransform},getName:function(){return this.name},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},
getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation},getWorldTransform:function(){var a=[];return function(){var b=this;for(a.length=0;null!==b;)a.push(b),b=b._parent;for(b=a.length-1;0<=b;b--)a[b].sync();return this.worldTransform}}(),reparent:function(a,b){var c=this.getParent();c&&c.removeChild(this);a&&(0<=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(){var a,b,c;switch(arguments.length){case 1:a=arguments[0].x;b=arguments[0].y;
c=arguments[0].z;break;case 3:a=arguments[0],b=arguments[1],c=arguments[2]}this.localRotation.setFromEulerAngles(a,b,c);this.dirtyLocal=!0},setLocalPosition:function(){1===arguments.length?this.localPosition.copy(arguments[0]):this.localPosition.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setLocalRotation:function(a){1===arguments.length?this.localRotation.copy(arguments[0]):this.localRotation.set(arguments[0],arguments[1],arguments[2],arguments[3]);this.dirtyLocal=!0},setLocalScale:function(){1===
arguments.length?this.localScale.copy(arguments[0]):this.localScale.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setName:function(a){this.name=a},setPosition:function(){var a=new pc.Vec3,b=new pc.Mat4;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2]);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this.dirtyLocal=!0}}(),setRotation:function(){var a=
new pc.Quat,b=new pc.Quat;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2],arguments[3]);if(null===this._parent)this.localRotation.copy(a);else{var c=this._parent.getRotation();b.copy(c).invert();this.localRotation.copy(b).mul(a)}this.dirtyLocal=!0}}(),setEulerAngles:function(){var a=new pc.Quat;return function(){var b,c,e;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0],c=arguments[1],
e=arguments[2]}this.localRotation.setFromEulerAngles(b,c,e);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,this.localRotation));this.dirtyLocal=!0}}(),addChild:function(a){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.push(a);this._onInsertChild(a)},addChildAndSaveTransform:function(a){var b=a.getPosition(),c=a.getRotation(),e=a.getParent();e&&e.removeChild(a);void 0==this.tmpMat4&&(this.tmpMat4=new pc.Mat4,this.tmpQuat=
new pc.Quat);a.setPosition(this.tmpMat4.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(this.tmpQuat.copy(this.getRotation()).invert().mul(c));this._children.push(a);this._onInsertChild(a)},insertChild:function(a,b){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=this;var b=a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,
b));a.dirtyWorld=!0},removeChild:function(a){var b,c=this._children.length;a._parent=null;for(b=0;b<c;++b)if(this._children[b]===a){this._children.splice(b,1);break}},addLabel:function(a){this._labels[a]=!0},getLabels:function(){return Object.keys(this._labels)},hasLabel:function(a){return!!this._labels[a]},removeLabel:function(a){delete this._labels[a]},findByLabel:function(a,b){var c,e=this._children.length,b=b||[];this.hasLabel(a)&&b.push(this);for(c=0;c<e;++c)b=this._children[c].findByLabel(a,
b);return b},sync:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);if(this.dirtyWorld){null===this._parent?this.worldTransform.copy(this.localTransform):this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this.dirtyWorld=!1;for(var a=0,b=this._children.length;a<b;a++)this._children[a].dirtyWorld=!0}},syncHierarchy:function(){var a=function(){if(this._enabled){this.sync();for(var b=
this._children,c=0,e=b.length;c<e;c++)a.call(b[c])}};return a}(),lookAt:function(){var a=new pc.Mat4,b=new pc.Vec3,c=new pc.Vec3,e=new pc.Quat;return function(){switch(arguments.length){case 1:b.copy(arguments[0]);c.copy(pc.Vec3.UP);break;case 2:b.copy(arguments[0]);c.copy(arguments[1]);break;case 3:b.set(arguments[0],arguments[1],arguments[2]);c.copy(pc.Vec3.UP);break;case 6:b.set(arguments[0],arguments[1],arguments[2]),c.set(arguments[3],arguments[4],arguments[5])}a.setLookAt(this.getPosition(),
b,c);e.setFromMat4(a);this.setRotation(e)}}(),translate:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}a.add(this.getPosition());this.setPosition(a)}}(),translateLocal:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}this.localRotation.transformVector(a,a);this.localPosition.add(a);
this.dirtyLocal=!0}}(),rotate:function(){var a=new pc.Quat,b=new pc.Quat;return function(){var c,e,g;switch(arguments.length){case 1:c=arguments[0].x;e=arguments[0].y;g=arguments[0].z;break;case 3:c=arguments[0],e=arguments[1],g=arguments[2]}a.setFromEulerAngles(c,e,g);null===this._parent?this.localRotation.mul2(a,this.localRotation):(c=this.getRotation(),e=this._parent.getRotation(),b.copy(e).invert(),a.mul2(b,a),this.localRotation.mul2(a,c));this.dirtyLocal=!0}}(),rotateLocal:function(){var a=new pc.Quat;
return function(){var b,c,e;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0],c=arguments[1],e=arguments[2]}a.setFromEulerAngles(b,c,e);this.localRotation.mul(a);this.dirtyLocal=!0}}()});return{GraphNode:d}}());pc.scene.Projection={PERSPECTIVE:0,ORTHOGRAPHIC:1};
pc.extend(pc.scene,function(){var d=function(){this._projection=pc.scene.Projection.PERSPECTIVE;this._nearClip=0.1;this._farClip=1E4;this._fov=45;this._orthoHeight=10;this._aspect=16/9;this._projMatDirty=!0;this._projMat=new pc.Mat4;this._viewMat=new pc.Mat4;this._viewProjMat=new pc.Mat4;this._rect={x:0,y:0,width:1,height:1};this._frustum=new pc.shape.Frustum(this._projMat,this._viewMat);this._renderTarget=null;this._clearOptions={color:[186/255,186/255,177/255,1],depth:1,flags:pc.CLEARFLAG_COLOR|
pc.CLEARFLAG_DEPTH}},d=pc.inherits(d,pc.scene.GraphNode);pc.extend(d.prototype,{_cloneInternal:function(a){d._super._cloneInternal.call(this,a);a.setProjection(this.getProjection());a.setNearClip(this.getNearClip());a.setFarClip(this.getFarClip());a.setFov(this.getFov());a.setAspectRatio(this.getAspectRatio());a.setRenderTarget(this.getRenderTarget());a.setClearOptions(this.getClearOptions())},clone:function(){var a=new pc.scene.CameraNode;this._cloneInternal(a);return a},worldToScreen:function(a){var b,
c=this.getWorldTransform().clone().invert();pvm=new pc.Mat4;width=this._renderTarget.getWidth();height=this._renderTarget.getHeight();point2d=new pc.Vec3;b=(new pc.Mat4).setPerspective(this._fov,width/height,this._nearClip,this._farClip);pvm.mul2(b,c);pvm.transformPoint(a,point2d);point2d.x=width/2+width/2*point2d.x;point2d.y=height-(height/2+height/2*point2d.y);point2d.z=point2d.z;return point2d},screenToWorld:function(a,b,c,e,g,d){void 0===d&&(d=new pc.Vec3);var k=this.getProjectionMatrix(),h=this.getWorldTransform();
this._viewMat.copy(h);this._viewMat.invert();this._viewProjMat.mul2(k,this._viewMat);k=this._viewProjMat.clone().invert();this._projection===pc.scene.Projection.PERSPECTIVE?(b=new pc.Vec3(2*(a/e)-1,2*((g-b)/g)-1,1),a=k.transformPoint(b),a.scale(1/(b.x*k.data[3]+b.y*k.data[7]+b.z*k.data[11]+k.data[15])),c/=this._farClip,d.lerp(this.getPosition(),a,c)):(c=new pc.Vec3(2*(a/e)-1,2*((g-b)/g)-1,2*((this._farClip-c)/(this._farClip-this._nearClip))-1),k.transformPoint(c,d));return d},getAspectRatio:function(){return this._aspect},
getClearOptions:function(){return this._clearOptions},getFarClip:function(){return this._farClip},getFov:function(){return this._fov},getFrustum:function(){return this._frustum},getNearClip:function(){return this._nearClip},getOrthoHeight:function(){return this._orthoHeight},getProjection:function(){return this._projection},getProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===pc.scene.Projection.PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,
this._farClip);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,b,-a,a,this._nearClip,this._farClip)}this._projMatDirty=!1}return this._projMat},getRect:function(){return this._rect},getRenderTarget:function(){return this._renderTarget},setAspectRatio:function(a){this._aspect=a;this._projMatDirty=!0},setClearOptions:function(a){this._clearOptions=a},setFarClip:function(a){this._farClip=a;this._projMatDirty=!0},setFov:function(a){this._fov=a;this._projMatDirty=!0},setNearClip:function(a){this._nearClip=
a;this._projMatDirty=!0},setOrthoHeight:function(a){this._orthoHeight=a;this._projMatDirty=!0},setProjection:function(a){this._projection=a;this._projMatDirty=!0},setRect:function(a,b,c,e){this._rect.x=a;this._rect.y=b;this._rect.width=c;this._rect.height=e},setRenderTarget:function(a){this._renderTarget=a}});return{CameraNode:d}}());pc.extend(pc.scene,function(){var d=function(){this._type=pc.scene.LIGHTTYPE_DIRECTIONAL;this._color=new pc.Color(0.8,0.8,0.8);this._intensity=1;this._enabled=this._castShadows=!1;this._attenuationEnd=this._attenuationStart=10;this._falloffMode=0;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new pc.Vec3(0.8,0.8,0.8);this._linearFinalColor=new pc.Vec3;this._position=new pc.Vec3(0,0,0);this._direction=new pc.Vec3(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/
180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new pc.Mat4;this._shadowDistance=40;this._shadowResolution=1024;this._shadowBias=-5E-4;this._normalOffsetBias=0;this._scene=null},d=pc.inherits(d,pc.scene.GraphNode);pc.extend(d.prototype,{_cloneInternal:function(a){d._super._cloneInternal.call(this,a);a.setType(this.getType());a.setColor(this.getColor());a.setIntensity(this.getIntensity());a.setCastShadows(this.getCastShadows());a.setEnabled(this.getEnabled());
a.setAttenuationStart(this.getAttenuationStart());a.setAttenuationEnd(this.getAttenuationEnd());a.setFalloffMode(this.getFalloffMode());a.setInnerConeAngle(this.getInnerConeAngle());a.setOuterConeAngle(this.getOuterConeAngle());a.setShadowBias(this.getShadowBias());a.setNormalOffsetBias(this.getNormalOffsetBias());a.setShadowResolution(this.getShadowResolution());a.setShadowDistance(this.getShadowDistance())},clone:function(){var a=new pc.scene.LightNode;this._cloneInternal(a);return a},getAttenuationEnd:function(){return this._attenuationEnd},
getAttenuationStart:function(){return this._attenuationStart},getFalloffMode:function(){return this._falloffMode},getCastShadows:function(){return this._castShadows},getColor:function(){return this._color},getEnabled:function(){return this._enabled},getInnerConeAngle:function(){return this._innerConeAngle},getIntensity:function(){return this._intensity},getOuterConeAngle:function(){return this._outerConeAngle},getShadowBias:function(){return this._shadowBias},getNormalOffsetBias:function(){return this._normalOffsetBias},
getShadowDistance:function(){return this._shadowDistance},getShadowResolution:function(){return this._shadowResolution},getType:function(){return this._type},setAttenuationEnd:function(a){this._attenuationEnd=a},setAttenuationStart:function(a){this._attenuationStart=a},setFalloffMode:function(a){this._falloffMode=a;null!==this._scene&&(this._scene.updateShaders=!0)},setCastShadows:function(a){this._castShadows=a;null!==this._scene&&(this._scene.updateShaders=!0)},setColor:function(){var a,b,c;1===
arguments.length?(a=arguments[0].r,b=arguments[0].g,c=arguments[0].b):3===arguments.length&&(a=arguments[0],b=arguments[1],c=arguments[2]);this._color.set(a,b,c);var e=this._intensity;this._finalColor.set(a*e,b*e,c*e);for(a=0;3>a;a++)this._linearFinalColor.data[a]=1<=e?Math.pow(this._finalColor.data[a]/e,2.2)*e:Math.pow(this._finalColor.data[a],2.2)},setEnabled:function(a){this._enabled!==a&&(this._enabled=a,null!==this._scene&&(this._scene.updateShaders=!0))},setInnerConeAngle:function(a){this._innerConeAngle=
a;this._innerConeAngleCos=Math.cos(a*Math.PI/180)},setIntensity:function(a){this._intensity=a;var b=this._color,a=this._intensity;this._finalColor.set(b.r*a,b.g*a,b.b*a);for(b=0;3>b;b++)this._linearFinalColor.data[b]=1<=a?Math.pow(this._finalColor.data[b]/a,2.2)*a:Math.pow(this._finalColor.data[b],2.2)},setOuterConeAngle:function(a){this._outerConeAngle=a;this._outerConeAngleCos=Math.cos(a*Math.PI/180)},setShadowBias:function(a){this._shadowBias=a},setNormalOffsetBias:function(a){if(!this._normalOffsetBias&&
a||this._normalOffsetBias&&!a)this._scene.updateShaders=!0;this._normalOffsetBias=a},setShadowDistance:function(a){this._shadowDistance=a},setShadowResolution:function(a){this._shadowResolution=a},setType:function(a){this._type=a}});return{LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,LightNode:d}}());pc.extend(pc.scene,function(){var d=0,a=function(){this.name="Untitled";this.id=d++;this.shader=null;this.parameters={};this.alphaTest=0;this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;this.cull=pc.CULLFACE_BACK;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=this.depthWrite=this.depthTest=!0;this.meshInstances=[]};Object.defineProperty(a.prototype,"blendType",{get:function(){return!this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&
this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.scene.BLEND_NONE:this.blend&&this.blendSrc===pc.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.scene.BLEND_NORMAL:this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.scene.BLEND_ADDITIVE:this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===
pc.BLENDEQUATION_ADD?pc.scene.BLEND_MULTIPLICATIVE:this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.scene.BLEND_PREMULTIPLIED:pc.scene.BLEND_NORMAL},set:function(a){switch(a){case pc.scene.BLEND_NONE:this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.scene.BLEND_NORMAL:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=
pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.scene.BLEND_PREMULTIPLIED:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.scene.BLEND_ADDITIVE:this.blend=!0;this.blendDst=this.blendSrc=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.scene.BLEND_MULTIPLICATIVE:this.blend=!0,this.blendSrc=pc.BLENDMODE_DST_COLOR,this.blendDst=pc.BLENDMODE_ZERO,
this.blendEquation=pc.BLENDEQUATION_ADD}this._updateMeshInstanceKeys()}});a.prototype._cloneInternal=function(a){a.name=this.name;a.id=d++;a.shader=null;a.parameters={};a.alphaTest=this.alphaTest;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.redWrite=this.redWrite;a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite;a.meshInstances=[]};
a.prototype.clone=function(){var a=new pc.scene.Material;this._cloneInternal(a);return a};a.prototype._updateMeshInstanceKeys=function(){var a,c=this.meshInstances;for(a=0;a<c.length;a++)c[a].updateKey()};a.prototype.updateShader=function(){};a.prototype.getName=function(){return this.name};a.prototype.setName=function(a){this.name=a};a.prototype.clearParameters=function(){this.parameters={}};a.prototype.getParameters=function(){return this.parameters};a.prototype.getParameter=function(a){return this.parameters[a]};
a.prototype.setParameter=function(a,c){var e=this.parameters[a];e?e.data=c:this.parameters[a]={scopeId:null,data:c}};a.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};a.prototype.setParameters=function(){for(var a in this.parameters){var c=this.parameters[a];c.scopeId||(c.scopeId=device.scope.resolve(a));c.scopeId.setValue(c.data)}};a.prototype.getShader=function(){return this.shader};a.prototype.setShader=function(a){this.shader=a};a.prototype.update=function(){throw Error("Not Implemented in base class");
};a.prototype.init=function(){throw Error("Not Implemented in base class");};return{Material:a}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.update()},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.BasicMaterial;Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data);this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(a){var b=
{skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("basic",b)}});return{BasicMaterial:d}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.DepthMaterial;Material.prototype._cloneInternal.call(this,a);a.update();return a},update:function(){},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("depth",b)}});return{DepthMaterial:d}}());pc.extend(pc.scene,function(){new pc.Vec3;new pc.Vec3;var d,a=function(a){if(a.data){if(a.data instanceof pc.Texture)return a.data;throw Error("PhongMaterial.init() expects textures to already be created");}return null},b=function(a){return new pc.Vec2(a.data[0],a.data[1])},c=function(a){return new pc.Color(a.data[0],a.data[1],a.data[2])};d=pc.inherits(function(){this.reset();this.update()},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.PhongMaterial;pc.scene.Material.prototype._cloneInternal.call(this,
a);a.ambient.copy(this.ambient);a.diffuse.copy(this.diffuse);a.diffuseMap=this.diffuseMap;a.diffuseMapTiling=this.diffuseMapTiling?this.diffuseMapTiling.clone():new pc.Vec2(1,1);a.diffuseMapOffset=this.diffuseMapOffset?this.diffuseMapOffset.clone():new pc.Vec2(0,0);a.diffuseMapTransform=this.diffuseMapTransform?this.diffuseMapTransform.clone():null;a.specular.copy(this.specular);a.specularMap=this.specularMap;a.specularMapTiling=this.specularMapTiling?this.specularMapTiling.clone():new pc.Vec2(1,
1);a.specularMapOffset=this.specularMapOffset?this.specularMapOffset.clone():new pc.Vec2(0,0);a.specularMapTransform=this.specularMapTransform?this.specularMapTransform.clone():null;a.shininess=this.shininess;a.glossMap=this.glossMap;a.glossMapTiling=this.glossMapTiling?this.glossMapTiling.clone():new pc.Vec2(1,1);a.glossMapOffset=this.glossMapOffset?this.glossMapOffset.clone():new pc.Vec2(0,0);a.glossMapTransform=this.glossMapTransform?this.glossMapTransform.clone():null;a.emissive.copy(this.emissive);
a.emissiveMap=this.emissiveMap;a.emissiveMapTiling=this.emissiveMapTiling?this.emissiveMapTiling.clone():new pc.Vec2(1,1);a.emissiveMapOffset=this.emissiveMapOffset?this.emissiveMapOffset.clone():new pc.Vec2(0,0);a.emissiveMapTransform=this.emissiveMapTransform?this.emissiveMapTransform.clone():null;a.opacity=this.opacity;a.opacityMap=this.opacityMap;a.opacityMapTiling=this.opacityMapTiling?this.opacityMapTiling.clone():new pc.Vec2(1,1);a.opacityMapOffset=this.opacityMapOffset?this.opacityMapOffset.clone():
new pc.Vec2(0,0);a.opacityMapTransform=this.opacityMapTransform?this.opacityMapTransform.clone():null;a.blendType=this.blendType;a.normalMap=this.normalMap;a.normalMapTransform=this.normalMapTransform?this.normalMapTransform.clone():null;a.normalMapTiling=this.normalMapTiling?this.normalMapTiling.clone():new pc.Vec2(1,1);a.normalMapOffset=this.normalMapOffset?this.normalMapOffset.clone():new pc.Vec2(0,0);a.heightMap=this.heightMap;a.heightMapTransform=this.heightMapTransform?this.heightMapTransform.clone():
null;a.heightMapTiling=this.heightMapTiling?this.heightMapTiling.clone():new pc.Vec2(1,1);a.heightMapOffset=this.heightMapOffset?this.heightMapOffset.clone():new pc.Vec2(0,0);a.bumpiness=this.bumpiness;a.heightMapFactor=this.heightMapFactor;a.cubeMap=this.cubeMap;a.prefilteredCubeMap128=this.prefilteredCubeMap128;a.prefilteredCubeMap64=this.prefilteredCubeMap64;a.prefilteredCubeMap32=this.prefilteredCubeMap32;a.prefilteredCubeMap16=this.prefilteredCubeMap16;a.prefilteredCubeMap8=this.prefilteredCubeMap8;
a.prefilteredCubeMap4=this.prefilteredCubeMap4;a.sphereMap=this.sphereMap;a.reflectivity=this.reflectivity;a.lightMap=this.lightMap;a.aoMap=this.aoMap;a.aoUvSet=this.aoUvSet;a.fresnelFactor=this.fresnelFactor;a.blendMapsWithColors=this.blendMapsWithColors;a.specularAntialias=this.specularAntialias;a.conserveEnergy=this.conserveEnergy;a.occludeSpecular=this.occludeSpecular;a.shadingModel=this.shadingModel;a.fresnelModel=this.fresnelModel;a.ambientTint=this.ambientTint;a.diffuseMapTint=this.diffuseMapTint;
a.specularMapTint=this.specularMapTint;a.emissiveMapTint=this.emissiveMapTint;a.emissiveIntensity=this.emissiveIntensity;a.update();return a},init:function(e){this.reset();this.name=e.name;for(var g=0;g<e.parameters.length;g++){var d=e.parameters[g];switch(d.name){case "ambient":this.ambient=c(d);break;case "diffuse":this.diffuse=c(d);break;case "diffuseMap":this.diffuseMap=a(d);break;case "diffuseMapTiling":this.diffuseMapTiling=b(d);break;case "diffuseMapOffset":this.diffuseMapOffset=b(d);break;
case "specular":this.specular=c(d);break;case "specularMap":this.specularMap=a(d);break;case "specularMapTiling":this.specularMapTiling=b(d);break;case "specularMapOffset":this.specularMapOffset=b(d);break;case "shininess":this.shininess=d.data;break;case "glossMap":this.glossMap=a(d);break;case "glossMapTiling":this.glossMapTiling=b(d);break;case "glossMapOffset":this.glossMapOffset=b(d);break;case "emissive":this.emissive=c(d);break;case "emissiveMap":this.emissiveMap=a(d);break;case "emissiveMapTiling":this.emissiveMapTiling=
b(d);break;case "emissiveMapOffset":this.emissiveMapOffset=b(d);break;case "opacity":this.opacity=d.data;break;case "opacityMap":this.opacityMap=a(d);break;case "opacityMapTiling":this.opacityMapTiling=b(d);break;case "opacityMapOffset":this.opacityMapOffset=b(d);break;case "normalMap":this.normalMap=a(d);break;case "normalMapTiling":this.normalMapTiling=b(d);break;case "normalMapOffset":this.normalMapOffset=b(d);break;case "heightMap":this.heightMap=a(d);break;case "heightMapTiling":this.heightMapTiling=
b(d);break;case "heightMapOffset":this.heightMapOffset=b(d);break;case "bumpMapFactor":this.bumpiness=d.data;break;case "heightMapFactor":this.heightMapFactor=d.data;break;case "cubeMap":this.cubeMap=a(d);break;case "prefilteredCubeMap128":this.prefilteredCubeMap128=a(d);break;case "prefilteredCubeMap64":this.prefilteredCubeMap64=a(d);break;case "prefilteredCubeMap32":this.prefilteredCubeMap32=a(d);break;case "prefilteredCubeMap16":this.prefilteredCubeMap16=a(d);break;case "prefilteredCubeMap8":this.prefilteredCubeMap8=
a(d);break;case "prefilteredCubeMap4":this.prefilteredCubeMap4=a(d);break;case "sphereMap":this.sphereMap=a(d);break;case "reflectivity":this.reflectivity=d.data;break;case "lightMap":this.lightMap=a(d);break;case "aoMap":this.aoMap=a(d);break;case "aoUvSet":this.aoUvSet=d.data;break;case "ambientTint":this.ambientTint=d.data;break;case "diffuseMapTint":this.diffuseMapTint=d.data;break;case "specularMapTint":this.specularMapTint=d.data;break;case "emissiveMapTint":this.emissiveMapTint=d.data;break;
case "emissiveIntensity":this.emissiveIntensity=d.data;break;case "depthTest":this.depthTest=d.data;break;case "depthWrite":this.depthWrite=d.data;break;case "cull":this.cull=d.data;break;case "blendType":this.blendType=d.data;break;case "blendMapsWithColors":this.blendMapsWithColors=d.data;break;case "specularAntialias":this.specularAntialias=d.data;break;case "conserveEnergy":this.conserveEnergy=d.data;break;case "occludeSpecular":this.occludeSpecular=d.data;break;case "shadingModel":this.shadingModel=
d.data;break;case "fresnelModel":this.fresnelModel=d.data;break;case "fresnelFactor":this.fresnelFactor=d.data}}this.update()},reset:function(){this.ambient=new pc.Color(0.7,0.7,0.7);this.diffuse=new pc.Color(1,1,1);this.diffuseMap=null;this.diffuseMapTiling=new pc.Vec2(1,1);this.diffuseMapOffset=new pc.Vec2(0,0);this.diffuseMapTransform=null;this.specular=new pc.Color(0,0,0);this.specularMap=null;this.specularMapTiling=new pc.Vec2(1,1);this.specularMapOffset=new pc.Vec2(0,0);this.specularMapTransform=
null;this.shininess=25;this.glossMap=null;this.glossMapTiling=new pc.Vec2(1,1);this.glossMapOffset=new pc.Vec2(0,0);this.glossMapTransform=null;this.emissive=new pc.Color(0,0,0);this.emissiveMap=null;this.emissiveMapTiling=new pc.Vec2(1,1);this.emissiveMapOffset=new pc.Vec2(0,0);this.emissiveMapTransform=null;this.opacity=1;this.opacityMap=null;this.opacityMapTiling=new pc.Vec2(1,1);this.opacityMapOffset=new pc.Vec2(0,0);this.opacityMapTransform=null;this.blendType=pc.scene.BLEND_NONE;this.normalMapTransform=
this.normalMap=null;this.normalMapTiling=new pc.Vec2(1,1);this.normalMapOffset=new pc.Vec2(0,0);this.heightMap=null;this.heightMapTiling=new pc.Vec2(1,1);this.heightMapOffset=new pc.Vec2(0,0);this.heightMapTransform=null;this.heightMapFactor=this.bumpiness=1;this.sphereMap=this.prefilteredCubeMap4=this.prefilteredCubeMap8=this.prefilteredCubeMap16=this.prefilteredCubeMap32=this.prefilteredCubeMap64=this.prefilteredCubeMap128=this.cubeMap=null;this.reflectivity=1;this.aoMap=this.lightMap=null;this.aoUvSet=
0;this.blendMapsWithColors=!0;this.specularAntialias=!1;this.occludeSpecular=this.conserveEnergy=!0;this.shadingModel=pc.scene.SPECULAR_PHONG;this.fresnelModel=pc.scene.FRESNEL_NONE;this.fresnelFactor=0;this.emissiveMapTint=this.specularMapTint=this.diffuseMapTint=this.ambientTint=!1;this.emissiveIntensity=1;this.ambientUniform=new Float32Array(3);this.diffuseUniform=new Float32Array(3);this.specularUniform=new Float32Array(3);this.emissiveUniform=new Float32Array(3)},_updateMapTransform:function(a,
b,c){a=a||new pc.Vec4;a.set(b.x,b.y,c.x,c.y);return 1==a.x&&1==a.y&&0==a.z&&0==a.w?null:a},_collectLights:function(a,b,c){for(var d=0;d<b.length;d++)b[d].getEnabled()&&b[d].getType()==a&&c.push(b[d])},update:function(){this.clearParameters();this.ambientUniform[0]=this.ambient.r;this.ambientUniform[1]=this.ambient.g;this.ambientUniform[2]=this.ambient.b;this.setParameter("material_ambient",this.ambientUniform);this.diffuseMap&&(this.setParameter("texture_diffuseMap",this.diffuseMap),(this.diffuseMapTransform=
this._updateMapTransform(this.diffuseMapTransform,this.diffuseMapTiling,this.diffuseMapOffset))&&this.setParameter("texture_diffuseMapTransform",this.diffuseMapTransform.data));if(!this.diffuseMap||this.blendMapsWithColors&&this.diffuseMapTint)this.diffuseUniform[0]=this.diffuse.r,this.diffuseUniform[1]=this.diffuse.g,this.diffuseUniform[2]=this.diffuse.b,this.setParameter("material_diffuse",this.diffuseUniform);this.specularMap&&(this.setParameter("texture_specularMap",this.specularMap),(this.specularMapTransform=
this._updateMapTransform(this.specularMapTransform,this.specularMapTiling,this.specularMapOffset))&&this.setParameter("texture_specularMapTransform",this.specularMapTransform.data));if(!this.specularMap||this.blendMapsWithColors&&this.specularMapTint)this.specularUniform[0]=this.specular.r,this.specularUniform[1]=this.specular.g,this.specularUniform[2]=this.specular.b,this.setParameter("material_specular",this.specularUniform);this.glossMap&&(this.setParameter("texture_glossMap",this.glossMap),(this.glossMapTransform=
this._updateMapTransform(this.glossMapTransform,this.glossMapTiling,this.glossMapOffset))&&this.setParameter("texture_glossMapTransform",this.glossMapTransform.data));if(!this.glossMap||this.blendMapsWithColors)this.shadingModel===pc.scene.SPECULAR_PHONG?this.setParameter("material_shininess",Math.pow(2,0.11*this.shininess)):this.setParameter("material_shininess",0.01*this.shininess);this.emissiveMap&&(this.setParameter("texture_emissiveMap",this.emissiveMap),(this.emissiveMapTransform=this._updateMapTransform(this.emissiveMapTransform,
this.emissiveMapTiling,this.emissiveMapOffset))&&this.setParameter("texture_emissiveMapTransform",this.emissiveMapTransform.data));if(!this.emissiveMap||this.blendMapsWithColors&&this.emissiveMapTint)this.emissiveUniform[0]=this.emissive.r*this.emissiveIntensity,this.emissiveUniform[1]=this.emissive.g*this.emissiveIntensity,this.emissiveUniform[2]=this.emissive.b*this.emissiveIntensity,this.setParameter("material_emissive",this.emissiveUniform);this.opacityMap&&(this.setParameter("texture_opacityMap",
this.opacityMap),(this.opacityMapTransform=this._updateMapTransform(this.opacityMapTransform,this.opacityMapTiling,this.opacityMapOffset))&&this.setParameter("texture_opacityMapTransform",this.opacityMapTransform.data));(!this.opacityMap||this.blendMapsWithColors)&&this.setParameter("material_opacity",this.opacity);this.normalMap&&(this.setParameter("texture_normalMap",this.normalMap),(this.normalMapTransform=this._updateMapTransform(this.normalMapTransform,this.normalMapTiling,this.normalMapOffset))&&
this.setParameter("texture_normalMapTransform",this.normalMapTransform.data));this.heightMap&&(this.setParameter("texture_heightMap",this.heightMap),(this.heightMapTransform=this._updateMapTransform(this.heightMapTransform,this.heightMapTiling,this.heightMapOffset))&&this.setParameter("texture_heightMapTransform",this.heightMapTransform.data));this.normalMap&&this.setParameter("material_bumpMapFactor",this.bumpiness);this.heightMap&&this.setParameter("material_heightMapFactor",0.025*this.heightMapFactor);
this.cubeMap&&this.setParameter("texture_cubeMap",this.cubeMap);this.prefilteredCubeMap128&&this.setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128);this.prefilteredCubeMap64&&this.setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64);this.prefilteredCubeMap32&&this.setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32);this.prefilteredCubeMap16&&this.setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16);this.prefilteredCubeMap8&&
this.setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8);this.prefilteredCubeMap4&&this.setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4);this.sphereMap&&this.setParameter("texture_sphereMap",this.sphereMap);this.setParameter("material_reflectionFactor",this.reflectivity);0<this.fresnelFactor&&this.setParameter("material_fresnelFactor",this.fresnelFactor);this.lightMap&&this.setParameter("texture_lightMap",this.lightMap);this.aoMap&&this.setParameter("texture_aoMap",
this.aoMap);this.shader=null},_getMapTransformID:function(a){if(!a)return 0;var b,c,d;for(b=0;b<this._mapXForms.length;b++){d=!0;for(c=0;c<a.data.length;c++)if(this._mapXForms[b][c]!=a.data[c]){d=!1;break}if(d)return b+1}b=this._mapXForms.length;this._mapXForms[b]=[];for(c=0;c<a.data.length;c++)this._mapXForms[b][c]=a.data[c];return b+1},updateShader:function(a,b){var c;c=b._lights;this._mapXForms=[];var d=this.prefilteredCubeMap128?this.prefilteredCubeMap128:b._prefilteredCubeMap128,h=this.prefilteredCubeMap64?
this.prefilteredCubeMap64:b._prefilteredCubeMap64,l=this.prefilteredCubeMap32?this.prefilteredCubeMap32:b._prefilteredCubeMap32,n=this.prefilteredCubeMap16?this.prefilteredCubeMap16:b._prefilteredCubeMap16,r=this.prefilteredCubeMap8?this.prefilteredCubeMap8:b._prefilteredCubeMap8,m=this.prefilteredCubeMap4?this.prefilteredCubeMap4:b._prefilteredCubeMap4,w=d&&h&&l&&n&&r&&m;if(w&&(a.extTextureLod&&16>a.samplerCount)&&!d._prefilteredMips){d.autoMipmap=!1;l=[d,h,l,n,r,m];for(h=1;6>h;h++)d._levels[h]=
l[h]._levels[0];d.upload();d._prefilteredMips=!0}d===b._prefilteredCubeMap128&&(this.setParameter("texture_prefilteredCubeMap128",b._prefilteredCubeMap128),this.setParameter("texture_prefilteredCubeMap64",b._prefilteredCubeMap64),this.setParameter("texture_prefilteredCubeMap32",b._prefilteredCubeMap32),this.setParameter("texture_prefilteredCubeMap16",b._prefilteredCubeMap16),this.setParameter("texture_prefilteredCubeMap8",b._prefilteredCubeMap8),this.setParameter("texture_prefilteredCubeMap4",b._prefilteredCubeMap4));
d={fog:b.fog,gamma:b.gammaCorrection,toneMap:b.toneMapping,blendMapsWithColors:this.blendMapsWithColors,skin:!!this.meshInstances[0].skinInstance,modulateAmbient:this.ambientTint,diffuseMap:!!this.diffuseMap,diffuseMapTransform:this._getMapTransformID(this.diffuseMapTransform),needsDiffuseColor:(1!=this.diffuse.r||1!=this.diffuse.g||1!=this.diffuse.b)&&this.diffuseMapTint,specularMap:!!this.specularMap,specularMapTransform:this._getMapTransformID(this.specularMapTransform),needsSpecularColor:(1!=
this.specular.r||1!=this.specular.g||1!=this.specular.b)&&this.specularMapTint,glossMap:!!this.glossMap,glossMapTransform:this._getMapTransformID(this.glossMapTransform),needsGlossFloat:!0,emissiveMap:!!this.emissiveMap,emissiveMapTransform:this._getMapTransformID(this.emissiveMapTransform),needsEmissiveColor:(1!=this.emissive.r||1!=this.emissive.g||1!=this.emissive.b||1!=this.emissiveIntensity)&&this.emissiveMapTint,opacityMap:!!this.opacityMap,opacityMapTransform:this._getMapTransformID(this.opacityMapTransform),
needsOpacityFloat:1!=this.opacity,normalMap:!!this.normalMap,normalMapTransform:this._getMapTransformID(this.normalMapTransform),needsNormalFloat:1!=this.bumpiness,heightMap:!!this.heightMap,heightMapTransform:this._getMapTransformID(this.heightMapTransform),sphereMap:!!this.sphereMap,cubeMap:!!this.cubeMap||w,lightMap:!!this.lightMap,aoMap:!!this.aoMap,aoUvSet:this.aoUvSet,useSpecular:!!this.specularMap||!(0===this.specular.r&&0===this.specular.g&&0===this.specular.b)||!!this.sphereMap||!!this.cubeMap||
w,hdrReflection:w?d.hdr:this.cubeMap?this.cubeMap.hdr:this.sphereMap?this.sphereMap.hdr:!1,prefilteredCubemap:w,specularAA:this.specularAntialias,conserveEnergy:this.conserveEnergy,occludeSpecular:this.occludeSpecular,shadingModel:this.shadingModel,fresnelModel:this.fresnelModel};this._mapXForms=null;w=[];this._collectLights(pc.scene.LIGHTTYPE_DIRECTIONAL,c,w);this._collectLights(pc.scene.LIGHTTYPE_POINT,c,w);this._collectLights(pc.scene.LIGHTTYPE_SPOT,c,w);d.lights=w;if(b.gammaCorrection)for(c=0;3>
c;c++)this.ambientUniform[c]=Math.pow(this.ambient.data[c],2.2),this.diffuseUniform[c]=Math.pow(this.diffuse.data[c],2.2),this.specularUniform[c]=Math.pow(this.specular.data[c],2.2),this.emissiveUniform[c]=Math.pow(this.emissive.data[c],2.2)*this.emissiveIntensity;this.shader=a.getProgramLibrary().getProgram("phong",d)}});return{PhongMaterial:d}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.update()},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.PickMaterial;Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data)},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("pick",
b)}});return{PickMaterial:d}}());pc.extend(pc.scene,function(){var d=function(a,b,c){this.node=a;this.mesh=b;this.material=c;this.layer=pc.scene.LAYER_WORLD;this.renderStyle=pc.scene.RENDERSTYLE_SOLID;this.castShadow=!1;this.drawToDepth=this.receiveShadow=!0;this.key=0;this.updateKey();this.skinInstance=null;this.aabb=new pc.shape.Aabb;this.normalMatrix=new pc.Mat3};Object.defineProperty(d.prototype,"aabb",{get:function(){this._aabb.setFromTransformedAabb(this.mesh.aabb,this.node.worldTransform);return this._aabb},set:function(a){this._aabb=
a}});Object.defineProperty(d.prototype,"material",{get:function(){return this._material},set:function(a){if(this._material){var b=this._material.meshInstances,c=b.indexOf(this);-1!==c&&b.splice(c,1)}this._material=a;this._material.meshInstances.push(this);this.updateKey()}});Object.defineProperty(d.prototype,"layer",{get:function(){return this._layer},set:function(a){this._layer=a;this.updateKey()}});pc.extend(d.prototype,{syncAabb:function(){},updateKey:function(){var a=this.material;this.key=(this.layer&
7)<<28|(a.blendType&3)<<26|0|(a.id&33554431)<<0}});return{Command:function(a,b,c){this.key=(a&7)<<28|(b&3)<<26|33554432;this.command=c},Mesh:function(){this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this.skin=null;this.aabb=new pc.shape.Aabb},MeshInstance:d}}());pc.extend(pc.scene,function(){var d=function(a){this.skin=a;this.bones=[];var c=a.inverseBindPose.length,a=a.device;a.supportsBoneTextures?(c=256<c?64:64<c?32:16<c?16:8,this.matrixPalette=new Float32Array(4*c*c),this.boneTexture=new pc.Texture(a,{width:c,height:c,format:pc.PIXELFORMAT_RGBA32F,autoMipmap:!1}),this.boneTexture.minFilter=pc.FILTER_NEAREST,this.boneTexture.magFilter=pc.FILTER_NEAREST,this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*c)},a=new pc.Mat4;
d.prototype={updateMatrixPalette:function(){for(var b=a.data,c=this.matrixPalette,e,d=this.bones.length-1;0<=d;d--)a.mul2(this.bones[d].worldTransform,this.skin.inverseBindPose[d]),e=16*d,c[e]=b[0],c[e+1]=b[1],c[e+2]=b[2],c[e+3]=b[3],c[e+4]=b[4],c[e+5]=b[5],c[e+6]=b[6],c[e+7]=b[7],c[e+8]=b[8],c[e+9]=b[9],c[e+10]=b[10],c[e+11]=b[11],c[e+12]=b[12],c[e+13]=b[13],c[e+14]=b[14],c[e+15]=b[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}};return{Skin:function(a,
c,e){this.device=a;this.inverseBindPose=c;this.boneNames=e},SkinInstance:d}}());pc.extend(pc.scene,function(){function d(){this.index=0;this.boneIndices=[0,0,0,0]}function a(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}a.prototype={addVertex:function(a,c,e){var d=-1;if(void 0!==this.indexMap[c])d=this.indexMap[c],this.indices.push(d);else{for(d=0;4>d;d++)0!==e.blendWeight.data[4*c+d]&&(a.boneIndices[d]=this.getBoneRemap(e.blendIndices.data[4*a.index+d]));d=this.vertices.length;
this.indices.push(d);this.vertices.push(a);this.indexMap[c]=d}},addPrimitive:function(a,c,e,d){var f,k,h=[],l=0,n=a.length;for(f=0;f<n;f++)for(var r=a[f].index,m=0;4>m;m++)if(0<e.blendWeight.data[4*r+m]){var w=e.blendIndices.data[4*r+m],u=!0;for(k=0;k<l;k++)if(h[k]==w){u=!1;break}u&&(h[l]=w,k=this.getBoneRemap(w),l+=-1===k?1:0)}if(this.boneIndices.length+l>d)return!1;for(f=0;f<l;f++)this.boneIndices.push(h[f]);for(f=0;f<n;f++)this.addVertex(a[f],c[f],e);return!0},getBoneRemap:function(a){for(var c=
0;c<this.boneIndices.length;c++)if(this.boneIndices[c]===a)return c;return-1}};return{partitionSkin:function(b,c,e){var g,f,k,h=b.vertices,l=b.skins,n=b.meshes,r=b.meshInstances;for(g=0;g<n.length;g++)n[g].vertices=h[n[g].vertices],void 0!==n[g].skin&&(n[g].skin=l[n[g].skin]);for(g=0;g<r.length;g++)r[g].mesh=n[r[g].mesh];h=b.vertices;l=b.skins;n=b.meshes;r=b.meshInstances;for(g=l.length-1;0<=g;g--)if(l[g].boneNames.length>e){var m=l.splice(g,1)[0],w=[];for(f=0;f<n.length;f++)n[f].skin===m&&w.push(n[f]);
for(f=0;f<w.length;f++){var u=n.indexOf(w[f]);-1!==u&&n.splice(u,1)}if(0===w.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var F=w[0].vertices;for(f=1;f<w.length;f++)if(w[f].vertices!==F)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var z=[],s=function(a){var b=new d;b.index=a;return b};k=[];var v=[],A=0;for(f=0;f<w.length;f++){for(var x=w[f],E=x.indices,D=x.base;D<x.base+x.count;){u=E[D++];k[0]=
s(u);v[0]=u;u=E[D++];k[1]=s(u);v[1]=u;u=E[D++];k[2]=s(u);v[2]=u;for(var I=!1,M=A;M<z.length;M++)if(u=z[M],u.addPrimitive(k,v,F,e)){I=!0;break}I||(u=new a,u.originalMesh=x,u.addPrimitive(k,v,F,e),z.push(u))}A=z.length}x=[];w=[];for(f=0;f<z.length;f++)if(u=z[f],u.vertices.length&&u.indices.length){s=x.length;k=u.vertices.length;v=w.length;A=u.indices.length;u.partition=f;u.vertexStart=s;u.vertexCount=k;u.indexStart=v;u.indexCount=A;E=0;for(D=s;E<k;)x[D++]=u.vertices[E++];E=0;for(D=v;E<A;)w[D++]=u.indices[E++]+
s}s=[];for(f=0;f<z.length;f++){u=z[f];v=[];A=[];for(k=0;k<u.boneIndices.length;k++)v.push(m.inverseBindMatrices[u.boneIndices[k]]),A.push(m.boneNames[u.boneIndices[k]]);u={inverseBindMatrices:v,boneNames:A};s.push(u);l.push(u)}var y,m={};for(y in F)m[y]={components:F[y].components,data:[],type:F[y].type};for(y in F)if("blendIndices"===y){u=m[y].data;for(f=0;f<x.length;f++)k=x[f].boneIndices,u.push(k[0],k[1],k[2],k[3])}else{f=F[y];data=f.data;components=f.components;for(f=0;f<x.length;f++){u=x[f].index;
for(k=0;k<components;k++)m[y].data.push(data[u*components+k])}}h[h.indexOf(F)]=m;for(f=0;f<z.length;f++){u=z[f];x={aabb:{min:[0,0,0],max:[0,0,0]},vertices:m,skin:s[f],indices:w.splice(0,u.indexCount),type:"triangles",base:0,count:u.indexCount};n.push(x);for(k=r.length-1;0<=k;k--)r[k].mesh===u.originalMesh&&(r.push({mesh:x,node:r[k].node}),c&&c.push({material:c[k].material,path:c[k].path}))}for(f=0;f<z.length;f++){u=z[f];for(k=r.length-1;0<=k;k--)r[k].mesh===u.originalMesh&&(r.splice(k,1),c&&c.splice(k,
1))}}c=b.vertices;e=b.skins;y=b.meshes;g=b.meshInstances;for(b=0;b<y.length;b++)y[b].vertices=c.indexOf(y[b].vertices),void 0!==y[b].skin&&(y[b].skin=e.indexOf(y[b].skin));for(b=0;b<g.length;b++)g[b].mesh=y.indexOf(g[b].mesh)}}}());pc.extend(pc.scene,function(){var d=function(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.cameras=[];this.lights=[]};d.prototype={getGraph:function(){return this.graph},setGraph:function(a){this.graph=a},getCameras:function(){return this.cameras},setCameras:function(a){this.cameras=a},getLights:function(){return this.lights},setLights:function(a){this.lights=a},getMaterials:function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var c=this.meshInstances[a];-1===b.indexOf(c.material)&&
b.push(c.material)}return b},clone:function(){var a,b=[],c=[],e=function(a){var d=a.clone();b.push(a);c.push(d);a instanceof pc.scene.CameraNode?m.cameras.push(d):a instanceof pc.scene.LightNode&&m.lights.push(d);for(var a=a.getChildren(),g=0;g<a.length;g++)d.addChild(e(a[g]));return d},d=e(this.graph),f=[],k=[];for(a=0;a<this.skinInstances.length;a++){var h=this.skinInstances[a].skin,l=new pc.scene.SkinInstance(h),n=[];for(j=0;j<h.boneNames.length;j++){var r=d.findByName(h.boneNames[j]);n.push(r)}l.bones=
n;k.push(l)}for(a=0;a<this.meshInstances.length;a++)h=this.meshInstances[a],l=b.indexOf(h.node),l=new pc.scene.MeshInstance(c[l],h.mesh,h.material),h.skinInstance&&(h=this.skinInstances.indexOf(h.skinInstance),l.skinInstance=k[h]),f.push(l);var m=new pc.scene.Model;m.graph=d;m.meshInstances=f;m.skinInstances=k;m.getGraph().syncHierarchy();return m},generateWireframe:function(){var a,b,c,e,d,f,k,h,l,n,r=[];for(a=0;a<this.meshInstances.length;a++)f=this.meshInstances[a].mesh,-1===r.indexOf(f)&&r.push(f);
var m=[[0,1],[1,2],[2,0]];for(a=0;a<r.length;a++){f=r[a];k=f.primitive[pc.scene.RENDERSTYLE_SOLID].base;h=f.primitive[pc.scene.RENDERSTYLE_SOLID].count;l=f.indexBuffer[pc.scene.RENDERSTYLE_SOLID];n=new Uint16Array(l.lock());var w={},u=[];for(b=k;b<k+h;b+=3)for(c=0;3>c;c++){e=n[b+m[c][0]];d=n[b+m[c][1]];var F=e>d?d<<16|e:e<<16|d;void 0===w[F]&&(w[F]=0,u.push(e,d))}l.unlock();b=new pc.IndexBuffer(l.device,pc.INDEXFORMAT_UINT16,u.length);c=new Uint16Array(b.lock());c.set(u);b.unlock();f.primitive[pc.scene.RENDERSTYLE_WIREFRAME]=
{type:pc.PRIMITIVE_LINES,base:0,count:u.length,indexed:!0};f.indexBuffer[pc.scene.RENDERSTYLE_WIREFRAME]=b}}};return{Model:d}}());pc.extend(pc.scene,function(){function d(a){return Math.max(Math.min(a,1),0)}function a(a,b,c,e){var d,g,f;if(void 0===c||2>c)return b*=a.length-1,d=a[Math.floor(b)],g=a[Math.ceil(b)],pc.math.lerp(d,g,b%1);b*=a.length/c-1;e||(e=[]);for(var h=0;h<c;h++)d=a[Math.floor(b)*c+h],g=a[Math.ceil(b)*c+h],f=b%1,e[h]=pc.math.lerp(d,g,f);return e}function b(a,b){Q[a]=void 0!==N[a]&&null!==N[a]?N[a]:b}function c(a,b){for(var c=a.length/3,e=Array(4*c),d=0;d<c;d++)e[4*d]=a[3*d],e[4*d+1]=a[3*d+1],e[4*d+2]=a[3*d+
2],e[4*d+3]=(255*b[3*d]<<16|255*b[3*d+1]<<8|255*b[3*d+2])/16777216;return e}function e(a,b,c){for(var e=new Float32Array(b.length),d=0;d<b.length;d++)e[d]=b[d]-a[d];for(var d=c.length,g=e.length/d,a=0;a<g;a++)for(b=0;b<d;b++){var f=Math.abs(e[a*d+b]);c[b]=Math.max(c[b],f)}a=c.length;g=e.length/a;for(b=0;b<g;b++)for(d=0;d<a;d++)e[b*a+d]/=c[d],e[b*a+d]*=0.5,e[b*a+d]+=0.5;return e}function g(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=
a.data[6];b.data[6]=a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}var f=[[-1,-1],[1,-1],[1,1],[-1,1]],k=function(a,b,c,e,d,g){d||(d=pc.PIXELFORMAT_RGBA32F);a=new pc.Texture(a,{width:b,height:c,format:d,cubemap:!1,autoMipmap:!1});a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;b=a.lock();if(d==pc.PIXELFORMAT_R8_G8_B8_A8){a.minFilter=pc.FILTER_LINEAR;a.magFilter=pc.FILTER_LINEAR;d=new Uint8Array(e.length);for(c=
0;c<e.length;c++)d[c]=255*e[c]*g;e=d}b.set(e);a.unlock();return a},h=new pc.Curve([0,0,1,0]),l=new pc.Curve([0,1,1,1]),n=new pc.CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),r=new pc.CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),m=null,w=new pc.Vec3,u=new pc.Vec3,F=new pc.Vec3,z=new pc.Vec3,s=new pc.Vec3,v=new pc.Vec3,A=new pc.Vec3,x=new pc.Vec3,E=new pc.Vec3,D=new pc.Mat4,I=new pc.Mat3,M=new pc.Mat3,y=new pc.Mat4,B=new pc.Mat4,H=1,C,J=new pc.Mat4,G=new pc.Vec3,K=new pc.Vec3,P=new pc.Vec3;new pc.Vec3;var Q,N,
L=function(a,c){this.graphicsDevice=a;this.precision=32;if(!m){var e=new Float32Array(1024),g,f,w,u;for(f=0;16>f;f++)for(g=0;16>g;g++)w=g+1-8.5,u=f+1-8.5,u=d(1-d(Math.sqrt(w*w+u*u)/16)-0.5),w=16*f+g,e[4*w]=1,e[4*w+1]=1,e[4*w+2]=1,e[4*w+3]=u;m=k(a,16,16,e,pc.PIXELFORMAT_R8_G8_B8_A8,1);m.minFilter=pc.FILTER_LINEAR;m.magFilter=pc.FILTER_LINEAR}Q=this;N=c;b("numParticles",1);b("rate",1);b("rate2",this.rate);b("lifetime",50);b("spawnBounds",new pc.Vec3(0,0,0));b("wrap",!1);b("wrapBounds",null);b("colorMap",
m);b("normalMap",null);b("loop",!0);b("preWarm",!1);b("sort",pc.scene.PARTICLESORT_NONE);b("mode",pc.scene.PARTICLEMODE_GPU);b("scene",null);b("lighting",!1);b("halfLambert",!1);b("intensity",1);b("stretch",0);b("alignToMotion",!1);b("depthSoftening",0);b("mesh",null);b("depthWrite",!1);b("blendType",pc.scene.BLEND_NORMAL);b("node",null);b("startAngle",0);b("startAngle2",this.startAngle);this.frameRandom=new pc.Vec3(0,0,0);b("colorGraph",r);b("colorGraph2",this.colorGraph);b("scaleGraph",l);b("scaleGraph2",
this.scaleGraph);b("alphaGraph",l);b("alphaGraph2",this.alphaGraph);b("localVelocityGraph",n);b("localVelocityGraph2",this.localVelocityGraph);b("velocityGraph",n);b("velocityGraph2",this.velocityGraph);b("rotationSpeedGraph",h);b("rotationSpeedGraph2",this.rotationSpeedGraph);this.constantParticleTexIN=a.scope.resolve("particleTexIN");this.constantParticleTexOUT=a.scope.resolve("particleTexOUT");this.constantEmitterPos=a.scope.resolve("emitterPos");this.constantEmitterScale=a.scope.resolve("emitterScale");
this.constantSpawnBounds=a.scope.resolve("spawnBounds");this.constantFrameRandom=a.scope.resolve("frameRandom");this.constantDelta=a.scope.resolve("delta");this.constantRate=a.scope.resolve("rate");this.constantRateDiv=a.scope.resolve("rateDiv");this.constantLifetime=a.scope.resolve("lifetime");this.constantLightCube=a.scope.resolve("lightCube[0]");this.constantGraphSampleSize=a.scope.resolve("graphSampleSize");this.constantGraphNumSamples=a.scope.resolve("graphNumSamples");this.constantInternalTex0=
a.scope.resolve("internalTex0");this.constantInternalTex1=a.scope.resolve("internalTex1");this.constantInternalTex2=a.scope.resolve("internalTex2");this.constantEmitterMatrix=a.scope.resolve("emitterMatrix");this.constantNumParticles=a.scope.resolve("numParticles");this.constantNumParticlesPot=a.scope.resolve("numParticlesPot");this.constantLocalVelocityDivMult=a.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=a.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=a.scope.resolve("rotSpeedDivMult");
this.constantSeed=a.scope.resolve("seed");this.constantStartAngle=a.scope.resolve("startAngle");this.constantStartAngle2=a.scope.resolve("startAngle2");this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);this.lightCubeDir[0]=new pc.Vec3(-1,0,0);this.lightCubeDir[1]=new pc.Vec3(1,0,0);this.lightCubeDir[2]=new pc.Vec3(0,-1,0);this.lightCubeDir[3]=new pc.Vec3(0,1,0);this.lightCubeDir[4]=new pc.Vec3(0,0,-1);this.lightCubeDir[5]=new pc.Vec3(0,0,1);this.camera=this.particleNoize=this.particleDistance=
this.vbOld=this.vbToSort=this.internalTex3=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=!1;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null;this.numParticleIndices=this.numParticleVerts=0;this.meshInstance=this.material=null;this.seed=0;this.rebuild()};L.prototype={onChangeCamera:function(){if(0<this.depthSoftening&&this.camera&&!this.camera._depthTarget){var a=this.camera,b;b=this.graphicsDevice;
var c=this.camera._rect,c=new pc.Texture(b,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:Math.floor(c.width*b.width),height:Math.floor(c.height*b.height)});c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;b=new pc.RenderTarget(b,c,{depth:!0});a._depthTarget=b;this._depthTarget=this.camera._depthTarget}this.regenShader();this.resetMaterial()},rebuild:function(){var a,b=this.graphicsDevice;this.useCpu=(this.useCpu=this.mode===
pc.scene.PARTICLEMODE_CPU)||this.sort>pc.scene.PARTICLESORT_NONE||!(b.extTextureFloat&&1<=b.maxVertexTextures&&b.extTextureFloatRenderable)||100>b.fragmentUniformsCount;this.vertexBuffer=void 0;this.useMesh=!1;this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0);this.numParticlesPot=pc.math.nextPowerOfTwo(this.numParticles);
this.rebuildGraphs();this.vbToSort=Array(this.numParticles);this.particleDistance=new Float32Array(this.numParticles);this.particleNoize=new Float32Array(this.numParticles);for(a=0;a<this.numParticles;a++)this.particleNoize[a]=Math.random();this.particleTex=new Float32Array(8*this.numParticlesPot);var c=null===this.node?pc.Vec3.ZERO:this.node.getPosition();null===this.node?J.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):J.setTRS(pc.Vec3.ZERO,this.node.getRotation(),P.copy(this.spawnBounds).mul(this.node.getLocalScale()));
for(a=0;a<this.numParticles;a++)this.calcSpawnPosition(c,a);this.particleTexStart=new Float32Array(8*this.numParticlesPot);for(a=0;a<this.particleTexStart.length;a++)this.particleTexStart[a]=this.particleTex[a];this.useCpu||(this.particleTexIN=k(b,this.numParticlesPot,2,this.particleTex),this.particleTexOUT=k(b,this.numParticlesPot,2,this.particleTex),this.particleTexStart=k(b,this.numParticlesPot,2,this.particleTexStart),this.rtParticleTexIN=new pc.RenderTarget(b,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=
new pc.RenderTarget(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=pc.shaderChunks;var c=a.particleUpdaterStartPS+a.particleUpdaterEndPS,e=a.particleUpdaterStartPS+a.particleUpdaterOnStopPS+a.particleUpdaterEndPS;this.shaderParticleUpdateRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,a.particleUpdaterStartPS+a.particleUpdaterRespawnPS+a.particleUpdaterEndPS,"fsQuad0");this.shaderParticleUpdateNoRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,c,"fsQuad1");this.shaderParticleUpdateOnStop=
a.createShaderFromCode(b,a.fullscreenQuadVS,e,"fsQuad2");this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);b=new pc.scene.Mesh;b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=this.indexBuffer;b.primitive[0].type=pc.PRIMITIVE_TRIANGLES;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new pc.scene.Material;
this.material.cullMode=pc.CULLFACE_NONE;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();this.meshInstance=new pc.scene.MeshInstance(this.node,b,this.material);this.meshInstance.updateKey();this.meshInstance.drawToDepth=!1;this._initializeTextures();this.addTime(0);this.preWarm&&this.prewarm(this.lifetime);this.resetTime()},calcSpawnPosition:function(a,b){G.data[0]=this.particleNoize[b]-
0.5;G.data[1]=10*this.particleNoize[b]%1-0.5;G.data[2]=100*this.particleNoize[b]%1-0.5;K.copy(a).add(J.transformPoint(G));this.particleTex[4*b]=K.data[0];this.particleTex[4*b+1]=K.data[1];this.particleTex[4*b+2]=K.data[2];this.particleTex[4*b+3]=pc.math.lerp(this.startAngle*pc.math.DEG_TO_RAD,this.startAngle2*pc.math.DEG_TO_RAD,this.particleNoize[b]);var c=-pc.math.lerp(this.rate,this.rate2,this.particleNoize[b])*b;this.particleTex[4*b+3+4*this.numParticlesPot]=c},rebuildGraphs:function(){var a=this.precision,
b=this.graphicsDevice,d;this.qLocalVelocity=this.localVelocityGraph.quantize(a);this.qVelocity=this.velocityGraph.quantize(a);this.qColor=this.colorGraph.quantize(a);this.qRotSpeed=this.rotationSpeedGraph.quantize(a);this.qScale=this.scaleGraph.quantize(a);this.qAlpha=this.alphaGraph.quantize(a);this.qLocalVelocity2=this.localVelocityGraph2.quantize(a);this.qVelocity2=this.velocityGraph2.quantize(a);this.qColor2=this.colorGraph2.quantize(a);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(a);this.qScale2=
this.scaleGraph2.quantize(a);this.qAlpha2=this.alphaGraph2.quantize(a);for(d=0;d<a;d++)this.qRotSpeed[d]*=pc.math.DEG_TO_RAD,this.qRotSpeed2[d]*=pc.math.DEG_TO_RAD;this.localVelocityUMax=new pc.Vec3(0,0,0);this.velocityUMax=new pc.Vec3(0,0,0);this.colorUMax=new pc.Vec3(0,0,0);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.qLocalVelocityDiv=e(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax.data);this.qVelocityDiv=e(this.qVelocity,this.qVelocity2,this.velocityUMax.data);
this.qColorDiv=e(this.qColor,this.qColor2,this.colorUMax.data);this.qRotSpeedDiv=e(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=e(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=e(this.qAlpha,this.qAlpha2,this.alphaUMax);if(!this.useCpu){this.internalTex0=k(b,a,1,c(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=k(b,a,1,c(this.qVelocity,this.qVelocityDiv));d=this.qRotSpeed;for(var g=this.qScale,f=this.qScaleDiv,h=this.qRotSpeedDiv,l=this.qAlphaDiv,n=Array(4*
d.length),m=0;m<d.length;m++)n[4*m]=d[m],n[4*m+1]=g[m],n[4*m+2]=0,n[4*m+3]=(255*f[m]<<16|255*h[m]<<8|255*l[m])/16777216;this.internalTex2=k(b,a,1,n)}d=this.qColor;g=this.qAlpha;f=Array(4*g.length);for(h=0;h<g.length;h++)f[4*h]=d[3*h],f[4*h+1]=d[3*h+1],f[4*h+2]=d[3*h+2],f[4*h+3]=g[h];this.internalTex3=k(b,a,1,f,pc.PIXELFORMAT_R8_G8_B8_A8,1)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",
this.normalMap))},_hasDepthTarget:function(){return this.camera?!!this.camera._depthTarget:!1},regenShader:function(){var a=this.graphicsDevice.getProgramLibrary(),b=null!=this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=b?2:1);this.material.updateShader=function(){var b=a.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening&&
this.emitter._hasDepthTarget(),mesh:this.emitter.useMesh,srgb:this.emitter.scene?this.emitter.scene.gammaCorrection:!1,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,blend:this.blendType});this.setShader(b)};this.material.updateShader()},resetMaterial:function(){var a=this.material,b=this.graphicsDevice;a.setParameter("stretch",this.stretch);a.setParameter("colorMult",this.intensity);
this.useCpu||(a.setParameter("internalTex0",this.internalTex0),a.setParameter("internalTex1",this.internalTex1),a.setParameter("internalTex2",this.internalTex2));a.setParameter("internalTex3",this.internalTex3);a.setParameter("numParticles",this.numParticles);a.setParameter("numParticlesPot",this.numParticlesPot);a.setParameter("lifetime",this.lifetime);a.setParameter("rate",this.rate);a.setParameter("rateDiv",this.rate2-this.rate);a.setParameter("seed",this.seed);a.setParameter("scaleDivMult",this.scaleUMax[0]);
a.setParameter("alphaDivMult",this.alphaUMax[0]);a.setParameter("graphNumSamples",this.precision);a.setParameter("graphSampleSize",1/this.precision);a.setParameter("emitterScale",pc.Vec3.ONE.data);this.wrap&&this.wrapBounds&&a.setParameter("wrapBounds",this.wrapBounds.data);this.colorMap&&a.setParameter("colorMap",this.colorMap);this.lighting&&this.normalMap&&a.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&this._hasDepthTarget()&&(a.setParameter("uDepthMap",this.camera._depthTarget.colorBuffer),
a.setParameter("screenSize",(new pc.Vec4(b.width,b.height,1/b.width,1/b.height)).data),a.setParameter("softening",1/(100*this.depthSoftening*this.depthSoftening)));0<this.stretch&&(a.cull=pc.CULLFACE_NONE)},_allocate:function(a){var b=a*this.numParticleVerts,c=a*this.numParticleIndices,e;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){e=this.useCpu?[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR1,components:4,type:pc.ELEMENTTYPE_FLOAT32},
{semantic:pc.SEMANTIC_ATTR2,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR3,components:2,type:pc.ELEMENTTYPE_FLOAT32}]:[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.ELEMENTTYPE_FLOAT32}];e=new pc.VertexFormat(this.graphicsDevice,e);this.vertexBuffer=new pc.VertexBuffer(this.graphicsDevice,e,b,pc.BUFFER_DYNAMIC);this.indexBuffer=new pc.IndexBuffer(this.graphicsDevice,pc.INDEXFORMAT_UINT16,c);e=new Float32Array(this.vertexBuffer.lock());var d,g;this.useMesh&&(d=new Float32Array(this.mesh.vertexBuffer.lock()),
g=d.length/this.mesh.vertexBuffer.numVertices);for(var h,c=0;c<b;c++){id=Math.floor(c/this.numParticleVerts);0===c%this.numParticleVerts&&(h=this.particleNoize[id]);if(this.useMesh){var k=c%this.numParticleVerts;e[4*c]=d[k*g];e[4*c+1]=d[k*g+1];e[4*c+2]=d[k*g+2]}else k=c%4,e[4*c]=f[k][0],e[4*c+1]=f[k][1],e[4*c+2]=0;e[4*c+3]=id+h}this.useCpu&&(this.vbCPU=new Float32Array(e),this.vbOld=new Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;indices=
new Uint16Array(this.indexBuffer.lock());this.useMesh&&(d=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(c=0;c<a;c++)if(this.useMesh)for(g=0;g<this.numParticleIndices;g++)indices[c*this.numParticleIndices+g]=d[g]+c*this.numParticleVerts;else g=4*c,indices[b++]=g,indices[b++]=g+1,indices[b++]=g+2,indices[b++]=g,indices[b++]=g+2,indices[b++]=g+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.seed=Math.random();this.material.setParameter("seed",
this.seed);if(this.useCpu)for(var a=0;a<this.particleTexStart.length;a++)this.particleTex[a]=this.particleTexStart[a];else this._initializeTextures();this.resetTime();a=this.loop;this.loop=!0;this.addTime(0);this.loop=a;this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(a){for(var b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision),a=a/b,c=0;c<b;c++)this.addTime(a)},resetTime:function(){var a=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+
1E3*a},addTime:function(b,c){var e,f,h=this.graphicsDevice;h.setBlending(!1);h.setColorWrite(!0,!0,!0,!0);h.setCullMode(pc.CULLFACE_NONE);h.setDepthTest(!1);h.setDepthWrite(!1);if(this.lighting){if(!this.scene){console.error("There is no scene defined for lighting particles");return}for(e=0;6>e;e++)this.lightCube[3*e]=this.scene.ambientLight.r,this.lightCube[3*e+1]=this.scene.ambientLight.g,this.lightCube[3*e+2]=this.scene.ambientLight.b;var k=this.scene._globalLights;for(e=0;e<k.length;e++)for(f=
0;6>f;f++){var l=Math.max(this.lightCubeDir[f].dot(k[e]._direction),0)*k[e]._intensity;this.lightCube[3*f]+=k[e]._color.r*l;this.lightCube[3*f+1]+=k[e]._color.g*l;this.lightCube[3*f+2]+=k[e]._color.b*l}this.constantLightCube.setValue(this.lightCube)}this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera());null===this.meshInstance.node?J.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):J.setTRS(pc.Vec3.ZERO,this.meshInstance.node.getRotation(),
P.copy(this.spawnBounds).mul(this.meshInstance.node.getLocalScale()));e=null===this.meshInstance.node?pc.Vec3.ONE.data:this.meshInstance.node.getLocalScale().data;this.material.setParameter("emitterScale",e);if(this.useCpu){k=new Float32Array(this.vertexBuffer.lock());if(this.meshInstance.node){e=this.meshInstance.node.worldTransform;for(f=0;12>f;f++)D.data[f]=e.data[f];C=this.meshInstance.node.getLocalScale();H=Math.max(Math.max(C.x,C.y),C.z)}f=null===this.meshInstance.node?pc.Vec3.ZERO:this.meshInstance.node.getPosition();
l=this.camera?this.camera.position:pc.Vec3.ZERO;if(this.camera){e=this.camera.getProjectionMatrix();var n=this.camera.getWorldTransform();y.copy(n);y.invert();B.mul2(e,y)}for(e=0;e<this.numParticles;e++){var n=Math.floor(this.vbCPU[4*e*this.numParticleVerts+3]),m=(this.particleNoize[n]+this.seed)%1;s.x=m;s.y=10*m%1;s.z=100*m%1;var r=pc.math.lerp(this.rate,this.rate2,m),G=this.lifetime,N=this.particleTex[4*n+3+4*this.numParticlesPot]+b,L=d(N/G),K=0,Q=0,T=0<N&&N<G;if(T){u.data=a(this.qLocalVelocity,
L,3,u.data);z.data=a(this.qLocalVelocity2,L,3,z.data);w.data=a(this.qVelocity,L,3,w.data);F.data=a(this.qVelocity2,L,3,F.data);var S=a(this.qRotSpeed,L),Q=a(this.qRotSpeed2,L),K=a(this.qScale,L),V=a(this.qScale2,L),W=a(this.qAlpha,L),X=a(this.qAlpha2,L);u.x=pc.math.lerp(u.x,z.x,s.x);u.y=pc.math.lerp(u.y,z.y,s.y);u.z=pc.math.lerp(u.z,z.z,s.z);w.x=pc.math.lerp(w.x,F.x,s.x);w.y=pc.math.lerp(w.y,F.y,s.y);w.z=pc.math.lerp(w.z,F.z,s.z);S=pc.math.lerp(S,Q,s.y);K=pc.math.lerp(K,V,1E4*m%1)*H;Q=(X-W)*(1E3*
m%1);this.meshInstance.node&&D.transformPoint(u,u);u.add(w.mul(C));E.copy(u);v.x=this.particleTex[4*n];v.y=this.particleTex[4*n+1];v.z=this.particleTex[4*n+2];A.copy(v).add(u.scale(b));x.copy(A);this.particleTex[4*n]=x.x;this.particleTex[4*n+1]=x.y;this.particleTex[4*n+2]=x.z;this.particleTex[4*n+3]+=S*b;this.wrap&&this.wrapBounds&&(x.sub(f),x.x=x.x-this.wrapBounds.x*Math.floor(x.x/this.wrapBounds.x)-0.5*this.wrapBounds.x,x.y=x.y-this.wrapBounds.y*Math.floor(x.y/this.wrapBounds.y)-0.5*this.wrapBounds.y,
x.z=x.z-this.wrapBounds.z*Math.floor(x.z/this.wrapBounds.z)-0.5*this.wrapBounds.z,x.add(f));0<this.sort&&(1===this.sort?(P.copy(x).sub(l),this.particleDistance[n]=-(P.x*P.x+P.y*P.y+P.z*P.z)):2===this.sort?this.particleDistance[n]=N:3===this.sort&&(this.particleDistance[n]=-N))}else this.calcSpawnPosition(f,n);N>G&&this.loop&&(N=-r*n);0>=N&&c&&(N=G+1);this.particleTex[4*n+3+4*this.numParticlesPot]=N;for(m=0;m<this.numParticleVerts;m++)r=this.vbCPU[4*e*this.numParticleVerts+4*m],G=this.vbCPU[4*e*this.numParticleVerts+
4*m+1],N=this.vbCPU[4*e*this.numParticleVerts+4*m+2],T||(r=G=N=0),S=14*e*this.numParticleVerts+14*m,k[S]=x.x,k[S+1]=x.y,k[S+2]=x.z,k[S+3]=L,k[S+4]=this.alignToMotion?0:this.particleTex[4*n+3],k[S+5]=K,k[S+6]=Q,k[S+7]=E.x,k[S+8]=r,k[S+9]=G,k[S+10]=N,k[S+11]=E.y,k[S+12]=E.z}if(this.sort>pc.scene.PARTICLESORT_NONE&&this.camera){for(e=0;e<this.numParticles;e++)this.vbToSort[e]=[e,Math.floor(this.vbCPU[4*e*this.numParticleVerts+3])];for(e=0;e<this.vbCPU.length;e++)this.vbOld[e]=this.vbCPU[e];var U=this.particleDistance;
this.vbToSort.sort(function(a,b){return U[a[1]]-U[b[1]]});for(e=0;e<this.numParticles;e++){k=this.vbToSort[e][0];for(l=0;l<this.numParticleVerts;l++)for(f=0;4>f;f++)this.vbCPU[4*e*this.numParticleVerts+4*l+f]=this.vbOld[4*k*this.numParticleVerts+4*l+f]}}this.vertexBuffer.unlock()}else this.frameRandom.x=Math.random(),this.frameRandom.y=Math.random(),this.frameRandom.z=Math.random(),this.constantGraphSampleSize.setValue(1/this.precision),this.constantGraphNumSamples.setValue(this.precision),this.constantNumParticles.setValue(this.numParticles),
this.constantNumParticlesPot.setValue(this.numParticlesPot),this.constantInternalTex0.setValue(this.internalTex0),this.constantInternalTex1.setValue(this.internalTex1),this.constantInternalTex2.setValue(this.internalTex2),f=null===this.meshInstance.node?pc.Vec3.ZERO.data:this.meshInstance.node.getPosition().data,k=null===this.meshInstance.node?pc.Mat4.IDENTITY:this.meshInstance.node.getWorldTransform(),g(J,I),g(k,M),this.constantEmitterPos.setValue(f),this.constantSpawnBounds.setValue(I.data),this.constantFrameRandom.setValue(this.frameRandom.data),
this.constantDelta.setValue(b),this.constantRate.setValue(this.rate),this.constantRateDiv.setValue(this.rate2-this.rate),this.constantStartAngle.setValue(this.startAngle*pc.math.DEG_TO_RAD),this.constantStartAngle2.setValue(this.startAngle2*pc.math.DEG_TO_RAD),this.constantSeed.setValue(this.seed),this.constantLifetime.setValue(this.lifetime),this.constantEmitterScale.setValue(e),this.constantEmitterMatrix.setValue(M.data),this.constantLocalVelocityDivMult.setValue(this.localVelocityUMax.data),this.constantVelocityDivMult.setValue(this.velocityUMax.data),
this.constantRotSpeedDivMult.setValue(this.rotSpeedUMax[0]),e=this.swapTex?this.particleTexOUT:this.particleTexIN,k=this.swapTex?this.particleTexIN:this.particleTexOUT,this.constantParticleTexIN.setValue(e),c?pc.drawQuadWithShader(h,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.shaderParticleUpdateOnStop):pc.drawQuadWithShader(h,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.loop?this.shaderParticleUpdateRespawn:this.shaderParticleUpdateNoRespawn),this.constantParticleTexOUT.setValue(k),
this.material.setParameter("particleTexOUT",k),this.material.setParameter("particleTexIN",e),this.swapTex=!this.swapTex;if(!this.loop&&this.onFinished&&Date.now()>this.endTime)this.onFinished();h.setDepthTest(!0);h.setDepthWrite(!0)}};return{ParticleEmitter:L,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1}}());pc.extend(pc.scene,function(){var d=function(a,b,c){this.device=a;a=a.getProgramLibrary();this.pickProgStatic=a.getProgram("pick",{skin:!1});this.pickProgSkin=a.getProgram("pick",{skin:!0});this.pickColor=new Float32Array(4);this.scene=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.resize(b,c)};d.prototype.getSelection=function(a){var b=this.device;a.width=a.width||1;a.height=a.height||1;var c=b.getRenderTarget();b.setRenderTarget(this._pickBufferTarget);
b.updateBegin();var e=new Uint8Array(4*a.width*a.height);b.readPixels(a.x,a.y,a.width,a.height,e);b.updateEnd();b.setRenderTarget(c);b=[];for(c=0;c<a.width*a.height;c++){var d=e[4*c+0]<<16|e[4*c+1]<<8|e[4*c+2];16777215!==d&&(d=this.scene.drawCalls[d],-1===b.indexOf(d)&&b.push(d))}return b};d.prototype.prepare=function(a,b){var c=this.device;this.scene=b;var e=c.getRenderTarget();c.setRenderTarget(this._pickBufferTarget);c.updateBegin();c.setViewport(0,0,this._pickBufferTarget.width,this._pickBufferTarget.height);
c.setScissor(0,0,this._pickBufferTarget.width,this._pickBufferTarget.height);c.clear(this.clearOptions);var d,f,k,h,l,n=b.drawCalls,r=n.length,c=this.device;f=c.scope;var m=f.resolve("matrix_model"),w=f.resolve("texture_poseMap"),u=f.resolve("texture_poseMapSize"),F=f.resolve("matrix_pose[0]"),z=f.resolve("uColor");d=f.resolve("matrix_projection");f=f.resolve("matrix_viewProjection");h=a.getWorldTransform();k=a.getProjectionMatrix();h=h.clone().invert();l=new pc.Mat4;l.mul2(k,h);d.setValue(k.data);
f.setValue(l.data);for(d=0;d<r;d++)if(!n[d].command){k=n[d];f=k.mesh;h=k.material;l=f.primitive[pc.scene.RENDERSTYLE_SOLID].type;var s=h instanceof pc.scene.PhongMaterial||h instanceof pc.scene.BasicMaterial;if((l===pc.PRIMITIVE_TRIANGLES||l===pc.PRIMITIVE_TRISTRIP||l===pc.PRIMITIVE_TRIFAN)&&s)c.setBlending(!1),c.setCullMode(h.cull),c.setDepthWrite(h.depthWrite),c.setDepthTest(h.depthTest),m.setValue(k.node.worldTransform.data),k.skinInstance&&(c.supportsBoneTextures?(w.setValue(k.skinInstance.boneTexture),
u.setValue([k.skinInstance.boneTexture.width,k.skinInstance.boneTexture.height])):F.setValue(k.skinInstance.matrixPalette)),this.pickColor[0]=(d>>16&255)/255,this.pickColor[1]=(d>>8&255)/255,this.pickColor[2]=(d&255)/255,this.pickColor[3]=1,z.setValue(this.pickColor),c.setShader(f.skin?this.pickProgSkin:this.pickProgStatic),c.setVertexBuffer(f.vertexBuffer,0),c.setIndexBuffer(f.indexBuffer[pc.scene.RENDERSTYLE_SOLID]),c.draw(f.primitive[pc.scene.RENDERSTYLE_SOLID])}c.setViewport(0,0,c.width,c.height);
c.setScissor(0,0,c.width,c.height);c.updateEnd();c.setRenderTarget(e)};d.prototype.resize=function(a,b){var c=new pc.Texture(this.device,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:a,height:b,autoMipmap:!1});c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this._pickBufferTarget=new pc.RenderTarget(this.device,c,{depth:!0})};Object.defineProperty(d.prototype,"renderTarget",{get:function(){return this._pickBufferTarget}});
Object.defineProperty(d.prototype,"width",{get:function(){return this._pickBufferTarget.width}});Object.defineProperty(d.prototype,"height",{get:function(){return this._pickBufferTarget.height}});return{Picker:d}}());pc.scene.procedural={};
pc.scene.procedural.calculateTangents=function(d,a,b,c){var e=c.length/3,g=d.length/3,f,k,h,l,n,r,m,w,u,F,z,s,v,A,x=new pc.Vec3,E=new pc.Vec3,D=new pc.Vec3,I=new pc.Vec3,M=new pc.Vec3,y=new pc.Vec2,B=new pc.Vec2,H=new pc.Vec2,C,J=new Float32Array(3*g),G=new Float32Array(3*g),K=[];for(C=0;C<e;C++)f=c[3*C],k=c[3*C+1],h=c[3*C+2],D.set(d[3*f],d[3*f+1],d[3*f+2]),I.set(d[3*k],d[3*k+1],d[3*k+2]),M.set(d[3*h],d[3*h+1],d[3*h+2]),y.set(b[2*f],b[2*f+1]),B.set(b[2*k],b[2*k+1]),H.set(b[2*h],b[2*h+1]),l=I.x-D.x,
n=M.x-D.x,r=I.y-D.y,m=M.y-D.y,w=I.z-D.z,u=M.z-D.z,F=B.x-y.x,z=H.x-y.x,s=B.y-y.y,v=H.y-y.y,A=1/(F*v-z*s),x.set((v*l-s*n)*A,(v*r-s*m)*A,(v*w-s*u)*A),E.set((F*n-z*l)*A,(F*m-z*r)*A,(F*u-z*w)*A),J[3*f+0]+=x.x,J[3*f+1]+=x.y,J[3*f+2]+=x.z,J[3*k+0]+=x.x,J[3*k+1]+=x.y,J[3*k+2]+=x.z,J[3*h+0]+=x.x,J[3*h+1]+=x.y,J[3*h+2]+=x.z,G[3*f+0]+=E.x,G[3*f+1]+=E.y,G[3*f+2]+=E.z,G[3*k+0]+=E.x,G[3*k+1]+=E.y,G[3*k+2]+=E.z,G[3*h+0]+=E.x,G[3*h+1]+=E.y,G[3*h+2]+=E.z;s=new pc.Vec3;v=new pc.Vec3;d=new pc.Vec3;b=new pc.Vec3;for(C=
0;C<g;C++)d.set(a[3*C],a[3*C+1],a[3*C+2]),s.set(J[3*C],J[3*C+1],J[3*C+2]),v.set(G[3*C],G[3*C+1],G[3*C+2]),c=d.dot(s),b.copy(d).scale(c),b.sub2(s,b).normalize(),K[4*C]=b.x,K[4*C+1]=b.y,K[4*C+2]=b.z,b.cross(d,s),K[4*C+3]=0>b.dot(v)?-1:1;return K};
pc.scene.procedural.createMesh=function(d,a,b){var c=b&&void 0!==b.normals?b.normals:null,e=b&&void 0!==b.tangents?b.tangents:null,g=b&&void 0!==b.uvs?b.uvs:null,b=b&&void 0!==b.indices?b.indices:null,f=[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}];null!==c&&f.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.ELEMENTTYPE_FLOAT32});null!==e&&f.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.ELEMENTTYPE_FLOAT32});null!==g&&f.push({semantic:pc.SEMANTIC_TEXCOORD0,
components:2,type:pc.ELEMENTTYPE_FLOAT32});for(var k=new pc.VertexFormat(d,f),f=a.length/3,k=new pc.VertexBuffer(d,k,f),h=new pc.VertexIterator(k),l=0;l<f;l++)h.element[pc.SEMANTIC_POSITION].set(a[3*l],a[3*l+1],a[3*l+2]),null!==c&&h.element[pc.SEMANTIC_NORMAL].set(c[3*l],c[3*l+1],c[3*l+2]),null!==e&&h.element[pc.SEMANTIC_TANGENT].set(e[4*l],e[4*l+1],e[4*l+2],e[4*l+3]),null!==g&&h.element[pc.SEMANTIC_TEXCOORD0].set(g[2*l],g[2*l+1]),h.next();h.end();c=null;if(e=null!==b)c=new pc.IndexBuffer(d,pc.INDEXFORMAT_UINT16,
b.length),(new Uint16Array(c.lock())).set(b),c.unlock();d=new pc.shape.Aabb;d.compute(a);a=new pc.scene.Mesh;a.vertexBuffer=k;a.indexBuffer[0]=c;a.primitive[0].type=pc.PRIMITIVE_TRIANGLES;a.primitive[0].base=0;a.primitive[0].count=e?b.length:f;a.primitive[0].indexed=e;a.aabb=d;return a};
pc.scene.procedural.createTorus=function(d,a){var b=a&&void 0!==a.tubeRadius?a.tubeRadius:0.2,c=a&&void 0!==a.ringRadius?a.ringRadius:0.3,e=a&&void 0!==a.segments?a.segments:30,g=a&&void 0!==a.sides?a.sides:20,f,k,h,l,n,r,m,w,u,F,z=[],s=[],v=[],A=[];for(f=0;f<=g;f++)for(k=0;k<=e;k++)h=Math.cos(2*Math.PI*k/e)*(c+b*Math.cos(2*Math.PI*f/g)),l=Math.sin(2*Math.PI*f/g)*b,n=Math.sin(2*Math.PI*k/e)*(c+b*Math.cos(2*Math.PI*f/g)),r=Math.cos(2*Math.PI*k/e)*Math.cos(2*Math.PI*f/g),m=Math.sin(2*Math.PI*f/g),w=
Math.sin(2*Math.PI*k/e)*Math.cos(2*Math.PI*f/g),u=f/g,F=1-k/e,z.push(h,l,n),s.push(r,m,w),v.push(u,F),f<g&&k<e&&(h=f*(e+1)+k,l=(f+1)*(e+1)+k,n=f*(e+1)+(k+1),r=(f+1)*(e+1)+(k+1),A.push(h,l,n),A.push(l,r,n));b={normals:s,uvs:v,indices:A};pc.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(z,s,v,A));return pc.scene.procedural.createMesh(d,z,b)};
pc.scene.procedural._createConeData=function(d,a,b,c,e,g){var f,k,h,l,n,r=new pc.Vec3;h=new pc.Vec3;l=new pc.Vec3;var m,w,u=[],F=[],z=[],s=[],v;if(0<b)for(f=0;f<=c;f++)for(k=0;k<=e;k++)theta=2*(k/e)*Math.PI-Math.PI,v=Math.sin(theta),w=Math.cos(theta),m=new pc.Vec3(v*d,-b/2,w*d),n=new pc.Vec3(v*a,b/2,w*a),r.lerp(m,n,f/c),h.sub2(n,m).normalize(),w=new pc.Vec3(w,0,-v),l.cross(w,h).normalize(),u.push(r.x,r.y,r.z),F.push(l.x,l.y,l.z),z.push(k/e,f/c),f<c&&k<e&&(w=f*(e+1)+k,v=f*(e+1)+(k+1),n=(f+1)*(e+1)+
k,m=(f+1)*(e+1)+(k+1),s.push(w,v,n),s.push(v,m,n));if(g){d=Math.floor(e/2);r=b/2;for(b=0;b<=d;b++){theta=0.5*b*Math.PI/d;v=Math.sin(theta);w=Math.cos(theta);for(f=0;f<=e;f++)phi=2*f*Math.PI/e-Math.PI/2,h=Math.sin(phi),g=Math.cos(phi),g*=v,k=w,h*=v,l=1-f/e,n=1-b/d,u.push(g*a,k*a+r,h*a),F.push(g,k,h),z.push(l,n)}m=(c+1)*(e+1);for(b=0;b<d;++b)for(f=0;f<e;++f)w=b*(e+1)+f,v=w+e+1,s.push(m+w+1,m+v,m+w),s.push(m+w+1,m+v+1,m+v);for(b=0;b<=d;b++){theta=0.5*Math.PI+0.5*b*Math.PI/d;v=Math.sin(theta);w=Math.cos(theta);
for(f=0;f<=e;f++)phi=2*f*Math.PI/e-Math.PI/2,h=Math.sin(phi),g=Math.cos(phi),g*=v,k=w,h*=v,l=1-f/e,n=1-b/d,u.push(g*a,k*a-r,h*a),F.push(g,k,h),z.push(l,n)}m=(c+1)*(e+1)+(e+1)*(d+1);for(b=0;b<d;++b)for(f=0;f<e;++f)w=b*(e+1)+f,v=w+e+1,s.push(m+w+1,m+v,m+w),s.push(m+w+1,m+v+1,m+v)}else{m=(c+1)*(e+1);if(0<d)for(f=0;f<e;f++)theta=2*(f/e)*Math.PI,g=Math.sin(theta),k=-b/2,h=Math.cos(theta),l=1-(g+1)/2,n=(h+1)/2,u.push(g*d,k,h*d),F.push(0,-1,0),z.push(l,n),1<f&&s.push(m,m+f,m+f-1);m+=e;if(0<a)for(f=0;f<e;f++)theta=
2*(f/e)*Math.PI,g=Math.sin(theta),k=b/2,h=Math.cos(theta),l=1-(g+1)/2,n=(h+1)/2,u.push(g*a,k,h*a),F.push(0,1,0),z.push(l,n),1<f&&s.push(m,m+f-1,m+f)}return{positions:u,normals:F,uvs:z,indices:s}};
pc.scene.procedural.createCylinder=function(d,a){var b=a&&void 0!==a.baseRadius?a.baseRadius:0.5,b=pc.scene.procedural._createConeData(b,b,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:20,!1);pc.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createCapsule=function(d,a){var b=a&&void 0!==a.radius?a.radius:0.3,b=pc.scene.procedural._createConeData(b,b,(a&&void 0!==a.height?a.height:1)-2*b,a&&void 0!==a.heightSegments?a.heightSegments:1,a&&void 0!==a.sides?a.sides:20,!0);pc.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createCone=function(d,a){var b=pc.scene.procedural._createConeData(a&&void 0!==a.baseRadius?a.baseRadius:0.5,a&&void 0!==a.peakRadius?a.peakRadius:0,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:18,!1);pc.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createSphere=function(d,a){var b=a&&void 0!==a.radius?a.radius:0.5,c=a&&void 0!==a.latitudeBands?a.latitudeBands:16,e=a&&void 0!==a.longitudeBands?a.longitudeBands:16,g,f,k,h,l,n,r,m,w,u=[],F=[],z=[],s=[];for(f=0;f<=c;f++){g=f*Math.PI/c;k=Math.sin(g);h=Math.cos(g);for(g=0;g<=e;g++)l=2*g*Math.PI/e-Math.PI/2,n=Math.sin(l),l=Math.cos(l),l*=k,r=h,n*=k,m=1-g/e,w=1-f/c,u.push(l*b,r*b,n*b),F.push(l,r,n),z.push(m,w)}for(f=0;f<c;++f)for(g=0;g<e;++g)b=f*(e+1)+g,k=b+e+1,s.push(b+1,k,b),s.push(b+
1,k+1,k);c={normals:F,uvs:z,indices:s};pc.precalculatedTangents&&(c.tangents=pc.scene.procedural.calculateTangents(u,F,z,s));return pc.scene.procedural.createMesh(d,u,c)};
pc.scene.procedural.createPlane=function(d,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec2(0.5,0.5),c=a&&void 0!==a.widthSegments?a.widthSegments:5,e=a&&void 0!==a.lengthSegments?a.lengthSegments:5,g,f,k,h,l,n,r=[],m=[],w=[],u=[];for(g=0;g<=c;g++)for(f=0;f<=e;f++)k=-b.x+2*b.x*g/c,h=-(-b.y+2*b.y*f/e),l=g/c,n=f/e,r.push(k,0,h),m.push(0,1,0),w.push(l,n),g<c&&f<e&&(u.push(f+g*(c+1),f+(g+1)*(c+1),f+g*(c+1)+1),u.push(f+(g+1)*(c+1),f+(g+1)*(c+1)+1,f+g*(c+1)+1));b={normals:m,uvs:w,indices:u};
pc.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(r,m,w,u));return pc.scene.procedural.createMesh(d,r,b)};
pc.scene.procedural.createBox=function(d,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec3(0.5,0.5,0.5),c=a&&void 0!==a.widthSegments?a.widthSegments:1,e=a&&void 0!==a.lengthSegments?a.lengthSegments:1,g=a&&void 0!==a.heightSegments?a.heightSegments:1,f=[new pc.Vec3(-b.x,-b.y,b.z),new pc.Vec3(b.x,-b.y,b.z),new pc.Vec3(b.x,b.y,b.z),new pc.Vec3(-b.x,b.y,b.z),new pc.Vec3(b.x,-b.y,-b.z),new pc.Vec3(-b.x,-b.y,-b.z),new pc.Vec3(-b.x,b.y,-b.z),new pc.Vec3(b.x,b.y,-b.z)],k=[[0,1,3],[4,5,7],[3,
2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],l=[],n=[],r=[],m=[],b=function(a,b,c){var e,d,g,A,x=l.length/3;for(g=0;g<=b;g++)for(A=0;A<=c;A++){e=new pc.Vec3;d=new pc.Vec3;var E=new pc.Vec3,D=new pc.Vec3;e.lerp(f[k[a][0]],f[k[a][1]],g/b);d.lerp(f[k[a][0]],f[k[a][2]],A/c);E.sub2(d,f[k[a][0]]);D.add2(e,E);e=g/b;d=A/c;l.push(D.x,D.y,D.z);n.push(h[a][0],h[a][1],h[a][2]);r.push(e,d);g<b&&A<c&&(m.push(x+A+g*(b+1),x+A+(g+1)*(b+1),x+A+g*(b+1)+1),m.push(x+A+(g+1)*(b+
1),x+A+(g+1)*(b+1)+1,x+A+g*(b+1)+1))}};b(0,c,g);b(1,c,g);b(2,c,e);b(3,c,e);b(4,e,g);b(5,e,g);c={normals:n,uvs:r,indices:m};pc.precalculatedTangents&&(c.tangents=pc.scene.procedural.calculateTangents(l,n,r,m));return pc.scene.procedural.createMesh(d,l,c)};pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a){return new pc.promise.Promise(function(c,e){pc.net.http.get(a.canonical,function(a){c(a)},{error:function(){e()}})})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="json";a.prototype.Type=Object;return{JsonResourceHandler:d,JsonRequest:a}}());pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a){return new RSVP.Promise(function(c,e){pc.net.http.get(a.canonical,function(a){c(a)},{error:function(){e()}})})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="text";a.prototype.Type=Object;return{TextResourceHandler:d,TextRequest:a}}());pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a){return new pc.promise.Promise(function(c,e){var d=new Image;d.onload=function(){c(d)};d.onerror=function(a){e(pc.string.format("Error loading Image from: '{0}'",a.srcElement.src))};d.src=a.canonical})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="image";a.prototype.Type=Image;return{ImageResourceHandler:d,
ImageRequest:a}}());pc.extend(pc.resources,function(){var d={repeat:pc.ADDRESS_REPEAT,clamp:pc.ADDRESS_CLAMP_TO_EDGE,mirror:pc.ADDRESS_MIRRORED_REPEAT},a={nearest:pc.FILTER_NEAREST,linear:pc.FILTER_LINEAR,nearest_mip_nearest:pc.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.FILTER_LINEAR_MIPMAP_LINEAR},b=function(a,b){this._device=a;this._assets=b;this.crossOrigin=void 0},b=pc.inherits(b,pc.resources.ResourceHandler);
b.prototype.load=function(a,b){var c=a.canonical,d=this;return new pc.promise.Promise(function(h,l){var n=pc.path.getExtension(c).toLowerCase();if(".dds"===n||".crn"===n)b=b||{},b.binary=!0,b.directory=pc.path.getDirectory(c),b.crn=".crn"===n,pc.net.http.get(c,function(a){h(a)},{cache:!1});else if(".jpg"===n||".jpeg"===n||".gif"===n||".png"===n){var r=new Image;void 0!==d.crossOrigin&&(r.crossOrigin=d.crossOrigin);r.onload=function(){h(r)};r.onerror=function(a){l(pc.string.format("Error loading Texture from: '{0}'",
a.srcElement.src))};(n=d._assets.getAssetByUrl(a.canonical))&&n.file&&(c+="?t="+n.file.hash);r.src=c}})};b.prototype.open=function(b,c,f){var k;if(b instanceof Image||b instanceof HTMLImageElement){if(c.result)k=c.result;else if(format=pc.string.endsWith(b.src.toLowerCase(),".jpg")?pc.PIXELFORMAT_R8_G8_B8:pc.PIXELFORMAT_R8_G8_B8_A8,k=new pc.Texture(this._device,{width:b.width,height:b.height,format:format}),(c=this._assets.getAssetByUrl(c.canonical))&&c.data)void 0!==c.data.name&&(k.name=c.data.name),
void 0!==c.data.addressu&&(k.addressU=d[c.data.addressu]),void 0!==c.data.addressV&&(k.addressV=d[c.data.addressV]),void 0!==c.data.magfilter&&(k.magFilter=a[c.data.magfilter]),void 0!==c.data.minfilter&&(k.minfilter=a[c.data.minfilter]);k.setSource(b)}else if(b instanceof ArrayBuffer){if(f.crn){k=b.byteLength;c=new Uint8Array(b);b=Module._malloc(k);f=Module.HEAPU8;dst32Offset=b/4;for(var h=k%4,l=new Uint32Array(c.buffer,0,(k-h)/4),n=new Uint32Array(f.buffer),r=0;r<l.length;r++)n[dst32Offset+r]=l[r];
for(r=k-h;r<k;r++)f[b+r]=c[r];c=Module._crn_decompress_get_data(b,k);k=Module._crn_decompress_get_size(b,k);b=Module.HEAPU8.buffer.slice(c,c+k)}k=loadDDS(b)}return k};var c;c=pc.inherits(function(){},pc.resources.ResourceRequest);c.prototype.type="texture";c.prototype.Type=pc.Texture;return{TextureResourceHandler:b,TextureRequest:c}}());pc.extend(pc.resources,function(){function d(a,b,g,f){if("resource"===b){var b=this.getSource(),k=!1;if(f)for(var f=f.getSource(),h=0;h<b.length;h++)b[h]===f&&(b[h]=g.getSource(),k=!0);k?this.setSource(b):a.off("change",d,this)}}var a=function(a,b){this._device=a;this._assets=b},a=pc.inherits(a,pc.resources.ResourceHandler);a.prototype.load=function(a){var b=null;return b=pc.string.startsWith(a.canonical,"asset://")?new pc.promise.Promise(function(b,e){var d=this._getAssetFromRequest(a);d||e(pc.string.format("Can't load cubemap, asset {0} not found",
a.canonical));this._loadCubemapImages(null,d.data).then(function(a){var c=pc.extend({},d.data);c.images=a;b(c)},function(a){e(a)})}.bind(this)):new pc.promise.Promise(function(b,e){pc.net.http.get(a.canonical,function(d){var h=pc.extend({},d),d=d.textures;if(d.length){var l=[];d.forEach(function(b){var e=pc.path.getBasename(b),b=pc.path.join(pc.path.split(a.canonical)[0],b);l.push(new pc.asset.Asset(e,"texture",{url:b}))});this._assets.load(l).then(function(a){h.images=a.map(function(a){return a.getSource()});
b(h)},function(a){e(a)})}else b(h)}.bind(this),{error:function(){e()}})}.bind(this))};a.prototype.open=function(a,b){var d=null,d=b.result?b.result:new pc.Texture(this._device,{format:pc.PIXELFORMAT_R8_G8_B8,cubemap:!0}),f=a.images;delete a.images;this._updateCubemapData(d,a,f);this._getAssetFromRequest(b).on("change",function(a,b,c){"data"===b&&this._loadCubemapImages(d,c).then(function(a){this._updateCubemapData(d,c,a)}.bind(this))},this);return d};a.prototype._areValidImages=function(a){var b=
a&&6===a.length,d;if(b)for(var f=a[0]?a[0].width:null,k=a[0]?a[0].height:null,h=0;6>h;h++){if(!a[h]){b=!1;break}if(!a[h]instanceof HTMLCanvasElement||!a[h]instanceof HTMLImageElement||!a[h]instanceof HTMLVideoElement){d="Cubemap source is not an instance of HTMLCanvasElement, HTMLImageElement or HTMLVideoElement.";b=!1;break}if(a[h].width!==f||a[h].height!==k){d="Cubemap sources do not all share the same dimensions.";b=!1;break}}d&&alert(d);return b};a.prototype._loadCubemapImages=function(a,b){var d=
this;return new pc.promise.Promise(function(a,c){if(b.textures){for(var h=[],l=0;6>l;l++)if(b.textures[l]){var n=d._assets.getAssetById(b.textures[l]);if(n)h.push(n);else{c(pc.string.format("Could not load cubemap - Texture {0} not found",b.textures[l]));return}}else{a(null);return}d._assets.load(h).then(function(b){a(b.map(function(a){return a.getSource()}))},function(a){c(a)})}else a(null)})};a.prototype._updateCubemapData=function(a,b,g){a.name!==b.name&&(a.name=b.name);a.minFilter!==b.minFilter&&
(a.minFilter=b.minFilter);a.magFilter!==b.magFilter&&(a.magFilter=b.magFilter);a.addressU!==pc.ADDRESS_CLAMP_TO_EDGE&&(a.addressU=pc.ADDRESS_CLAMP_TO_EDGE);a.addressV!==pc.ADDRESS_CLAMP_TO_EDGE&&(a.addressV=pc.ADDRESS_CLAMP_TO_EDGE);a.maxAnisotropy!==b.anisotropy&&(a.maxAnisotropy=b.anisotropy);this._areValidImages(g)&&a.setSource(g);g={};if(b.textures)for(var f=0;6>f;f++)if(b.textures[f]){var k=this._assets.getAssetById(b.textures[f]);k&&(g[k.id]=k)}for(var h in g)g[h].off("change",d,a),g[h].on("change",
d,a)};a.prototype._getAssetFromRequest=function(a){return pc.string.startsWith(a.canonical,"asset://")?this._assets.getAssetById(parseInt(a.canonical.slice(8))):this._assets.getAssetByUrl(a.canonical)};var b;b=pc.inherits(function(){},pc.resources.ResourceRequest);b.prototype.type="cubemap";b.prototype.Type=pc.Texture;return{CubemapResourceHandler:a,CubemapRequest:b}}());pc.extend(pc.resources,function(){var d={points:pc.PRIMITIVE_POINTS,lines:pc.PRIMITIVE_LINES,lineloop:pc.PRIMITIVE_LINELOOP,linestrip:pc.PRIMITIVE_LINESTRIP,triangles:pc.PRIMITIVE_TRIANGLES,trianglestrip:pc.PRIMITIVE_TRISTRIP,trianglefan:pc.PRIMITIVE_TRIFAN},a={int8:pc.ELEMENTTYPE_INT8,uint8:pc.ELEMENTTYPE_UINT8,int16:pc.ELEMENTTYPE_INT16,uint16:pc.ELEMENTTYPE_UINT16,int32:pc.ELEMENTTYPE_INT32,uint32:pc.ELEMENTTYPE_UINT32,float32:pc.ELEMENTTYPE_FLOAT32},b=function(a,b){this._device=a;this._assets=
b},b=pc.inherits(b,pc.resources.ResourceHandler);b.prototype.load=function(a,b){var c=this;if(a.data)for(var d,h=[],l=a.data,n=0;n<l.length;n++)l[n].material&&(d=this._assets.getAssetById(l[n].material))&&h.push(d);return new pc.promise.Promise(function(d,k){var l=a.canonical;b=b||{};b.directory=pc.path.getDirectory(l);pc.net.http.get(l,function(a){h.length?c._assets.load(h).then(function(){d(a)}):d(a)},{cache:b.cache,error:function(a){k(pc.string.format("Error loading model: {0} [{1}]",l,a))}})})};
b.prototype.open=function(a,b,c){c=c||{};c.directory=c.directory||"";c.parent=b;var d=null;1>=a.model.version?logERROR(pc.string.format("Asset: {0}, is an old model format. Upload source assets to re-import.",b.canonical)):2<=a.model.version&&(d=this._loadModelJson(a,b.data,c));return d};b.prototype.clone=function(a){return a.clone()};b.prototype._loadModelJson=function(b,c,f){var k=b.model,h,l,b=[];for(h=0;h<k.nodes.length;h++){var n=k.nodes[h],r=new pc.scene.GraphNode;r.setName(n.name);r.setLocalPosition(n.position[0],
n.position[1],n.position[2]);r.setLocalEulerAngles(n.rotation[0],n.rotation[1],n.rotation[2]);r.setLocalScale(n.scale[0],n.scale[1],n.scale[2]);b.push(r)}for(h=1;h<k.parents.length;h++)b[k.parents[h]].addChild(b[h]);!this._device.supportsBoneTextures&&0<k.skins.length&&(h=this._device.getBoneLimit(),pc.scene.partitionSkin(k,c,h));var m=[],n=[];for(h=0;h<k.skins.length;h++){var w=k.skins[h],r=[];for(l=0;l<w.inverseBindMatrices.length;l++){var u=w.inverseBindMatrices[l];r[l]=new pc.Mat4(u[0],u[1],u[2],
u[3],u[4],u[5],u[6],u[7],u[8],u[9],u[10],u[11],u[12],u[13],u[14],u[15])}w=new pc.scene.Skin(this._device,r,w.boneNames);m.push(w);r=new pc.scene.SkinInstance(w);u=[];for(l=0;l<w.boneNames.length;l++){var F=b[0].findByName(w.boneNames[l]);u.push(F)}r.bones=u;n.push(r)}var w=[],z,r={position:pc.SEMANTIC_POSITION,normal:pc.SEMANTIC_NORMAL,tangent:pc.SEMANTIC_TANGENT,blendWeight:pc.SEMANTIC_BLENDWEIGHT,blendIndices:pc.SEMANTIC_BLENDINDICES,color:pc.SEMANTIC_COLOR,texCoord0:pc.SEMANTIC_TEXCOORD0,texCoord1:pc.SEMANTIC_TEXCOORD1,
texCoord2:pc.SEMANTIC_TEXCOORD2,texCoord3:pc.SEMANTIC_TEXCOORD3,texCoord4:pc.SEMANTIC_TEXCOORD4,texCoord5:pc.SEMANTIC_TEXCOORD5,texCoord6:pc.SEMANTIC_TEXCOORD6,texCoord7:pc.SEMANTIC_TEXCOORD7};for(h=0;h<k.vertices.length;h++){u=k.vertices[h];if(u.position&&u.normal&&u.texCoord0){F=[];for(l=0;l<k.meshes.length;l++)k.meshes[l].vertices===h&&(F=F.concat(k.meshes[l].indices));tangents=pc.scene.procedural.calculateTangents(u.position.data,u.normal.data,u.texCoord0.data,F);u.tangent={type:"float32",components:4,
data:tangents}}l=[];for(z in u){var F=u[z],s=F.type;this._device.supportsUnsignedByte||("uint8"===s&&(s="float32"),"int8"===s&&(s="float32"));l.push({semantic:r[z],components:F.components,type:a[s],normalize:!1})}l=new pc.VertexFormat(this._device,l);var s=u.position.data.length/u.position.components,v=new pc.VertexBuffer(this._device,l,s),A=new pc.VertexIterator(v);for(l=0;l<s;l++){for(z in u)switch(F=u[z],F.components){case 1:A.element[r[z]].set(F.data[l]);break;case 2:A.element[r[z]].set(F.data[2*
l],F.data[2*l+1]);break;case 3:A.element[r[z]].set(F.data[3*l],F.data[3*l+1],F.data[3*l+2]);break;case 4:A.element[r[z]].set(F.data[4*l],F.data[4*l+1],F.data[4*l+2],F.data[4*l+3])}A.next()}A.end();w.push(v)}for(h=r=0;h<k.meshes.length;h++)u=k.meshes[h],void 0!==u.indices&&(r+=u.indices.length);s=F=null;v=0;0<r&&(F=new pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT16,r),s=new Uint16Array(F.lock()));z=[];for(h=0;h<k.meshes.length;h++){u=k.meshes[h];l=u.aabb.min;var A=u.aabb.max,A=new pc.shape.Aabb(new pc.Vec3(0.5*
(A[0]+l[0]),0.5*(A[1]+l[1]),0.5*(A[2]+l[2])),new pc.Vec3(0.5*(A[0]-l[0]),0.5*(A[1]-l[1]),0.5*(A[2]-l[2]))),x=void 0!==u.indices;l=new pc.scene.Mesh;l.vertexBuffer=w[u.vertices];l.indexBuffer[0]=x?F:null;l.primitive[0].type=d[u.type];l.primitive[0].base=x?u.base+v:u.base;l.primitive[0].count=u.count;l.primitive[0].indexed=x;l.skin=void 0!==u.skin?m[u.skin]:null;l.aabb=A;x&&(s.set(u.indices,v),v+=u.indices.length);z.push(l)}0<r&&F.unlock();w=[];u=new pc.scene.PhongMaterial;for(h=0;h<k.meshInstances.length;h++){l=
k.meshInstances[h];r=b[l.node];l=z[l.mesh];(F=this._getMaterial(h,c,f))||(F=u);r=new pc.scene.MeshInstance(r,l,F);if(l.skin){l=m.indexOf(l.skin);if(-1===l)throw Error("Mesh's skin does not appear in skin array.");r.skinInstance=n[l]}w.push(r)}c=new pc.scene.Model;c.graph=b[0];c.meshInstances=w;c.skinInstances=n;c.getGraph().syncHierarchy();return c};b.prototype._getMaterial=function(a,b,c){var d;if(b&&b.length>a)if(b[a].material){if(a=this._assets.getAssetById(b[a].material)){if(!a.resource)return console.error(pc.string.format("Material asset '{0}' is not loaded.",
a.name)),null}else return console.error("Reference to material not in asset list. Try reloading."),null;d=a.resource}else if(b[a].path&&(c=pc.path.split(c.parent.canonical)[0],c=pc.path.join(c,b[a].path),a=this._assets.getAssetByUrl(c)))d=a.resource;return d};var c;c=pc.inherits(function(){},pc.resources.ResourceRequest);c.prototype.type="model";c.prototype.Type=pc.scene.Model;return{ModelResourceHandler:b,ModelRequest:c}}());pc.extend(pc.resources,function(){function d(a,b,g,f){if("resource"===b){b=!1;if(f)for(var k in this)this.hasOwnProperty(k)&&this[k]===f&&(this[k]=g,b=!0);b?this.update():a.off("change",d,this)}}var a=function(a,b){this._assets=b;this._device=a},a=pc.inherits(a,pc.resources.ResourceHandler);a.prototype.load=function(a){var b=null;return b=pc.string.startsWith(a.canonical,"asset://")?new pc.promise.Promise(function(b,e){var d=this._getAssetFromRequest(a);d||e(pc.string("Can't load material, asset %s not found",
a.canonical));b(d.data)}.bind(this)):new pc.promise.Promise(function(b,e){pc.net.http.get(a.canonical,function(e){if("path"===e.mapping_format){var d=this._listReferencedAssets(e),f=[];d.length?(d.forEach(function(b){var e=b.data,d=pc.path.getBasename(e),e=pc.path.join(pc.path.split(a.canonical)[0],e);f.push(new pc.asset.Asset(d,b.type,{url:e}))}),this._assets.load(f).then(function(){b(e)})):b(e)}else b(e)}.bind(this),{error:function(){e()}})}.bind(this))};a.prototype.open=function(a,b){var d=new pc.scene.PhongMaterial;
this._updatePhongMaterial(d,a,b);this._getAssetFromRequest(b).on("change",function(a,c,h){"data"===c&&this._updatePhongMaterial(d,h,b)},this);return d};a.prototype._listReferencedAssets=function(a){return a.parameters.filter(function(a){return("texture"===a.type||"cubemap"===a.type)&&a.data})};a.prototype._updatePhongMaterial=function(a,b,g){var f=[];b.parameters.push({name:"shadingModel",type:"float",data:"blinn"===b.shader?pc.scene.SPECULAR_BLINN:pc.scene.SPECULAR_PHONG});for(var k={},h=0;h<b.parameters.length;h++){var l=
b.parameters[h];if("texture"===l.type&&l.data&&!(l.data instanceof pc.Texture)){var n=this._getTextureAssetFromRegistry(l.data,g);n&&(k[n.id]=n);this._loadTextureParamFromCache(l,n);!(l.data instanceof pc.Texture)&&n&&f.push(this._loadTextureParamPromise(l,n))}else"cubemap"===l.type&&(l.data&&!(l.data instanceof pc.Texture))&&(n=this._getTextureAssetFromRegistry(l.data,g),this._loadCubemapParamFromCache(l,n),!(l.data instanceof pc.Texture)&&n&&f.push(this._loadCubemapParamPromise(l,n)))}for(var r in k)k[r].off("change",
d,a),k[r].on("change",d,a);f.length?pc.promise.all(f).then(function(){a.init(b)},function(d){pc.log.error(d);a.init(b)}):a.init(b)};a.prototype._getTextureAssetFromRegistry=function(a,b){var d=this._assets.getAssetById(a);!d&&b&&(url=pc.path.join(pc.path.split(b.canonical)[0],a),d=this._assets.getAssetByUrl(url));return d};a.prototype._loadTextureParamFromCache=function(a,b){b?b.resource&&(a.data=b.resource):(pc.log.error(pc.string.format("Could not load texture. Asset {0} not found",a.data)),a.data=
null)};a.prototype._loadTextureParamPromise=function(a,b){return this._assets.load(b).then(function(b){a.data=b[0]},function(){a.data=null})};a.prototype._loadCubemapParamFromCache=function(a,b){b?b.resource&&(a.data=b.resource):(pc.log.error(pc.string.format("Could not load cubemap. Asset {0} not found",a.data)),a.data=null)};a.prototype._loadCubemapParamPromise=function(a,b){return this._assets.load(b).then(function(b){a.data=b[0]},function(){a.data=null})};a.prototype._getAssetFromRequest=function(a){return pc.string.startsWith(a.canonical,
"asset://")?this._assets.getAssetById(parseInt(a.canonical.slice(8))):this._assets.getAssetByUrl(a.canonical)};var b;b=pc.inherits(function(){},pc.resources.ResourceRequest);b.prototype.type="material";b.prototype.Type=pc.scene.Material;return{MaterialRequest:b,MaterialResourceHandler:a}}());pc.anim={};pc.anim.Key=function(d,a,b,c){this.time=d;this.position=a;this.rotation=b;this.scale=c};pc.anim.Node=function(){this._name="";this._keys=[]};
pc.extend(pc.anim,function(){var d=function(){this._name="";this._duration=0;this._nodes=[];this._nodeDict={}};d.prototype.getDuration=function(){return this._duration};d.prototype.getName=function(){return this._name};d.prototype.getNode=function(a){return this._nodeDict[a]};d.prototype.getNodes=function(){return this._nodes};d.prototype.setDuration=function(a){this._duration=a};d.prototype.setName=function(a){this._name=a};d.prototype.addNode=function(a){this._nodes.push(a);this._nodeDict[a._name]=
a};return{Animation:d}}());pc.extend(pc.anim,function(){function d(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new pc.Quat;this._pos=new pc.Vec3;this._scale=new pc.Vec3;this._targetNode=null}d.prototype={getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}};var a=function(a){function c(a){var b=a.getName(),k=new d;k._name=b;e._interpolatedKeys.push(k);e._interpolatedKeyDict[b]=k;e._currKeyIndices[b]=0;a=a.getChildren();for(b=0;b<a.length;b++)c(a[b])}this._animation=null;
this._time=0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var e=this;c(a)};a.prototype.addTime=function(a){if(null!==this._animation&&(this._time!==l||this.looping)){var c,e,d,f,k,h=this._animation.getNodes();this._time+=a;var l=this._animation.getDuration();if(this._time>l){this._time=this.looping?0:l;for(l=0;l<h.length;l++)c=h[l],e=c._name,this._currKeyIndices[e]=0}else if(0>this._time){this._time=this.looping?l:0;for(l=0;l<h.length;l++)c=
h[l],e=c._name,this._currKeyIndices[e]=c._keys.length-2}a=0<a?1:-1;for(l=0;l<h.length;l++)if(c=h[l],e=c._name,d=c._keys,c=this._interpolatedKeyDict[e],1===d.length)c._pos.copy(d[0].position),c._quat.copy(d[0].rotation),c._scale(d[0].scale);else for(var n=this._currKeyIndices[e];n<d.length-1&&0<=n;n+=a)if(f=d[n],k=d[n+1],f.time<=this._time&&k.time>=this._time){d=(this._time-f.time)/(k.time-f.time);c._pos.lerp(f.position,k.position,d);c._quat.slerp(f.rotation,k.rotation,d);c._scale.lerp(f.scale,k.scale,
d);c._written=!0;this._currKeyIndices[e]=n;break}}};a.prototype.blend=function(a,c,e){for(var d=this._interpolatedKeys.length,f=0;f<d;f++){var k=a._interpolatedKeys[f],h=c._interpolatedKeys[f],l=this._interpolatedKeys[f];k._written&&h._written?(l._quat.slerp(k._quat,c._interpolatedKeys[f]._quat,e),l._pos.lerp(k._pos,c._interpolatedKeys[f]._pos,e),l._scale.lerp(k._scale,h._scale,e),l._written=!0):k._written?(l._quat.copy(k._quat),l._pos.copy(k._pos),l._scale.copy(k._scale),l._written=!0):h._written&&
(l._quat.copy(h._quat),l._pos.copy(h._pos),l._scale.copy(h._scale),l._written=!0)}};a.prototype.getAnimation=function(){return this._animation};a.prototype.getCurrentTime=function(){return this._time};a.prototype.setCurrentTime=function(a){this._time=a;for(var a=this._interpolatedKeys.length,c=0;c<a;c++)this._currKeyIndices[this._interpolatedKeys[c]._name]=0;this.addTime(0);this.updateGraph()};a.prototype.getNumNodes=function(){return this._interpolatedKeys.length};a.prototype.setAnimation=function(a){this._animation=
a;this.setCurrentTime(0)};a.prototype.setGraph=function(a){var c;if(this.graph=a)for(c=0;c<this._interpolatedKeys.length;c++){var e=a.findByName(this._interpolatedKeys[c]._name);this._interpolatedKeys[c].setTarget(e)}else for(c=0;c<this._interpolatedKeys.length;c++)this._interpolatedKeys[c].setTarget(null)};a.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var c=this._interpolatedKeys[a];if(c._written){var e=c.getTarget();e.localPosition.copy(c._pos);
e.localRotation.copy(c._quat);e.localScale.copy(c._scale);e.dirtyLocal=!0;c._written=!1}}};a.prototype.setLooping=function(a){this.looping=a};a.prototype.getLooping=function(){return this.looping};return{Skeleton:a}}());pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a,c){return new pc.promise.Promise(function(e,d){var f=a.canonical;pc.path.getDirectory(f);pc.net.http.get(f,function(a){try{e(a)}catch(b){d(pc.string.format("An error occured while loading animation from: '{0}'",f))}}.bind(this),{cache:c.cache,error:function(a){d(a)}})})};d.prototype.open=function(a){return this["_loadAnimationV"+a.animation.version](a)};d.prototype._loadAnimationV3=
function(a){var a=a.animation,c=new pc.anim.Animation;c.setName(a.name);c.setDuration(a.duration);for(var e=0;e<a.nodes.length;e++){var d=new pc.anim.Node,f=a.nodes[e];d._name=f.name;for(var k=0;k<f.keys.length;k++){var h=f.keys[k],l=h.time,n=h.pos,r=h.rot,h=h.scale,n=new pc.Vec3(n[0],n[1],n[2]),r=(new pc.Quat).setFromEulerAngles(r[0],r[1],r[2]),h=new pc.Vec3(h[0],h[1],h[2]),l=new pc.anim.Key(l,n,r,h);d._keys.push(l)}c.addNode(d)}return c};d.prototype._loadAnimationV4=function(a){var a=a.animation,
c=new pc.anim.Animation;c.setName(a.name);c.setDuration(a.duration);for(var e=0;e<a.nodes.length;e++){var d=new pc.anim.Node,f=a.nodes[e];d._name=f.name;for(var k=f.defaults.p,h=f.defaults.r,l=f.defaults.s,n=0;n<f.keys.length;n++){var r=f.keys[n],m=r.t,w=k?k:r.p,u=h?h:r.r,r=l?l:r.s,w=new pc.Vec3(w[0],w[1],w[2]),u=(new pc.Quat).setFromEulerAngles(u[0],u[1],u[2]),r=new pc.Vec3(r[0],r[1],r[2]),m=new pc.anim.Key(m,w,u,r);d._keys.push(m)}c.addNode(d)}return c};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);
a.prototype.type="animation";a.prototype.Type=pc.anim.Animation;return{AnimationResourceHandler:d,AnimationRequest:a}}());pc.audio=function(){var d=function(){pc.audio.hasAudioContext()&&("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext));this.listener=new pc.audio.Listener(this);this.volume=1;this.suspended=!1;pc.events.attach(this)};d.prototype={createSound:function(a,b,c){var e=null;pc.audio.Sound?e=new pc.audio.Sound(this,a,b,c):c();return e},playSound:function(a,b){var b=b||{},c=null;pc.audio.Channel&&(c=new pc.audio.Channel(this,
a,b),c.play());return c},playSound3d:function(a,b,c){var c=c||{},e=null;pc.audio.Channel3d&&(e=new pc.audio.Channel3d(this,a,c),e.setPosition(b),c.volume&&e.setVolume(c.volume),c.loop&&e.setLoop(c.loop),c.maxDistance&&e.setMaxDistance(c.maxDistance),c.minDistance&&e.setMinDistance(c.minDistance),c.rollOffFactor&&e.setRollOffFactor(c.rollOffFactor),e.play());return e},getListener:function(){return this.listener},getVolume:function(){return this.volume},setVolume:function(a){this.volume=a;this.fire("volumechange",
a)},suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")}};return{AudioManager:d,hasAudio:function(){return"undefined"!==typeof Audio},hasAudioContext:function(){return!!("undefined"!==typeof AudioContext||"undefined"!==typeof webkitAudioContext)},isSupported:function(a,b){var c={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav"},e=pc.path.getExtension(a);return c[e]?(b||(b=new Audio),""!==b.canPlayType(c[e])):!1}}}();pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?d=function(a,b,c,e){this.buffer=null;this.isLoaded=!1;pc.audio.isSupported(b,this.audio)?a.context&&pc.net.http.get(b,function(b){a.context.decodeAudioData(b,function(a){this.buffer=a;this.isLoaded=!0;c(this)}.bind(this),e)}.bind(this),{error:e}):setTimeout(function(){e(pc.string.format("Audio format for {0} not supported",b))},0)}:pc.audio.hasAudio()&&(d=function(a,b,c){this.isLoaded=!1;this.audio=new Audio;this.audio.oncanplaythrough=
function(){this.isLoaded||(this.isLoaded=!0,c(this))}.bind(this);this.audio.src=b});return{Sound:d}}());pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?(d=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4;this.listener=a.context.listener},d.prototype.getPosition=function(){return this.position},d.prototype.setPosition=function(a){this.position.copy(a);this.listener.setPosition(a.x,a.y,a.z)},d.prototype.getVelocity=function(){return this.velocity},d.prototype.setVelocity=function(a){this.velocity.copy(a);this.listener.setPosition(a.x,a.y,a.z)},
d.prototype.setOrientation=function(a){this.orientation.copy(a);this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])}):(d=function(){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4},d.prototype.getPosition=function(){return this.position},d.prototype.setPosition=function(a){this.position.copy(a)},d.prototype.getVelocity=function(){return this.velocity},d.prototype.setVelocity=function(a){this.velocity.copy(a)},d.prototype.setOrientation=
function(a){this.orientation.copy(a)});d.prototype.getOrientation=function(){return this.orientation};return{Listener:d}}());pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?(d=function(a,b,c){c=c||{};this.volume=void 0===c.volume?1:c.volume;this.loop=void 0===c.loop?!1:c.loop;this.pitch=void 0===c.pitch?1:c.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()},d.prototype={play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();this.setVolume(this.volume);this.setLoop(this.loop);
this.setPitch(this.pitch);this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this)},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){if(this.source||!this.paused)throw Error("Call pause() before unpausing.");
this._createSource();this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch);this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.paused=!1},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setLoop:function(a){this.loop=
a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a;this.gain&&(this.gain.gain.value=a*this.manager.getVolume())},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;
this.source.connect(this.gain);this.gain.connect(a.destination)}}):pc.audio.hasAudio()?(d=function(a,b,c){this.volume=c.volume||1;this.loop=c.loop||!1;this.sound=b;this.pitch=void 0!==c.pitch?c.pitch:1;this.suspended=this.paused=!1;this.manager=a;this.source=b.audio.cloneNode(!1);this.source.pause()},d.prototype={play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,
this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this)},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(a){this.volume=
a;this.source&&(this.source.volume=a*this.manager.getVolume())},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=a)},getDuration:function(){if(this.source){var a=this.source.duration;if(a===a)return a}return 0},isPlaying:function(){return!this.source.paused}}):(console.warn("No support for 2D audio found"),d=function(){});pc.extend(d.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},
getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});return{Channel:d}}());pc.extend(pc.audio,function(){var d;if(pc.audio.hasAudioContext())d=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.panner=a.context.createPanner()},d=pc.inherits(d,pc.audio.Channel),d.prototype=pc.extend(d.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},
setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination)}});
else if(pc.audio.hasAudio()){var a=new pc.Vec3,b;d=pc.inherits(function(){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1},pc.audio.Channel);d.prototype=pc.extend(d.prototype,{getPosition:function(){return this.position},setPosition:function(c){this.position.copy(c);if(this.source){var e=this.manager.getListener().getPosition();var c=this.minDistance,d=this.maxDistance,f=this.rollOffFactor;a=a.sub2(e,this.position);b=a.length();b<c?c=
1:b>d?c=0:(e=c+f*(b-c),c=0!==e?c/e:1);e=this.getVolume();this.source.volume=e*c}},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rolloffFactor},setRollOffFactor:function(a){this.rolloffFactor=a}})}else console.warn("No support for 3D audio found"),
d=function(){};return{Channel3d:d}}());pc.extend(pc.resources,function(){var d=function(a){this.manager=a},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a){var c=this;return new pc.promise.Promise(function(e){var d=c.manager.createSound(a.canonical,function(a){e(a)},function(a){logERROR(a);e(d)})})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="audio";a.prototype.Type=pc.audio.Sound;return{AudioResourceHandler:d,AudioRequest:a}}());pc.input={};pc.extend(pc.input,function(){var d=function(a,b){var c={x:0,y:0};if(b){if(b instanceof d)throw Error("Expected MouseEvent");c=a._getTargetCoords(b)}else b={};if(c)this.x=c.x,this.y=c.y;else if(pc.input.Mouse.isPointerLocked())this.y=this.x=0;else return;this.wheel=b.detail?-1*b.detail:b.wheelDelta?b.wheelDelta/120:0;pc.input.Mouse.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=
this.y-a._lastY);this.button="mousedown"===b.type||"mouseup"===b.type?b.button:pc.input.MOUSEBUTTON_NONE;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b},a=function(a){this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);
this._wheelHandler=this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a);pc.events.attach(this)};a.isPointerLocked=function(){return!(!document.pointerLockElement&&!document.mozPointerLockElement&&!document.webkitPointerLockElement)};a.prototype={attach:function(a){this._target=a;this._attached||(this._attached=!0,window.addEventListener("mouseup",this._upHandler,!1),window.addEventListener("mousedown",this._downHandler,
!1),window.addEventListener("mousemove",this._moveHandler,!1),window.addEventListener("mousewheel",this._wheelHandler,!1),window.addEventListener("DOMMouseScroll",this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,window.removeEventListener("mouseup",this._upHandler),window.removeEventListener("mousedown",this._downHandler),window.removeEventListener("mousemove",this._moveHandler),window.removeEventListener("mousewheel",this._wheelHandler),window.removeEventListener("DOMMouseScroll",
this._wheelHandler))},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(a,b){var c=function(){a();document.removeEventListener("pointerlockchange",c)},d=function(){b();document.removeEventListener("pointerlockerror",d)};a&&document.addEventListener("pointerlockchange",c,!1);b&&document.addEventListener("pointerlockerror",
d,!1);document.body.requestPointerLock()},disablePointerLock:function(a){var b=function(){a();document.removeEventListener("pointerlockchange",b)};a&&document.addEventListener("pointerlockchange",b,!1);document.exitPointerLock()},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&!this._lastbuttons[a]},wasReleased:function(a){return!this._buttons[a]&&
this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;a=new d(this,a);a.event&&this.fire(pc.input.EVENT_MOUSEUP,a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new d(this,a);a.event&&this.fire(pc.input.EVENT_MOUSEDOWN,a)},_handleMove:function(a){a=new d(this,a);a.event&&(this.fire(pc.input.EVENT_MOUSEMOVE,a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new d(this,a);a.event&&this.fire(pc.input.EVENT_MOUSEWHEEL,a)},_getTargetCoords:function(a){var b=this._target.getBoundingClientRect(),
c=Math.floor(b.left),b=Math.floor(b.top);return a.clientX<c||a.clientX>=c+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?null:{x:a.clientX-c,y:a.clientY-b}}};if(!("undefined"===typeof navigator||"undefined"===typeof document)){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var b=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(a)},c=function(){var a=document.createEvent("CustomEvent");
a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",b,!1);document.addEventListener("webkitpointerlocklost",b,!1);document.addEventListener("mozpointerlockchange",b,!1);document.addEventListener("mozpointerlocklost",b,!1);document.addEventListener("webkitpointerlockerror",c,!1);document.addEventListener("mozpointerlockerror",c,!1);Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:
Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,b,c)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=
null,navigator.pointer.unlock())})}return{Mouse:a,MouseEvent:d,EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2}}());pc.extend(pc.input,function(){function d(a){return"string"==typeof a?a.toUpperCase().charCodeAt(0):a}var a=function(a,b){this.key=b.keyCode;this.element=b.target;this.event=b},b={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},c=function(a,b){b=b||{};this._element=null;this._keyDownHandler=this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);
pc.events.attach(this);this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1};c.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};c.prototype.detach=function(){this._element.removeEventListener("keydown",
this._keyDownHandler);this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};c.prototype.toKeyIdentifier=function(a){var a=d(a),c,f;if(c=b[a.toString()])return c;c=a.toString(16).toUpperCase();f=c.length;for(a=0;a<4-f;a++)c="0"+c;return"U+"+c};c.prototype._handleKeyDown=function(b){var c=b.keyCode||b.charCode,c=b.keyIdentifier||this.toKeyIdentifier(c);this._keymap[c]=!0;this.fire("keydown",new a(this,b));
this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};c.prototype._handleKeyUp=function(b){var c=b.keyCode||b.charCode,c=b.keyIdentifier||this.toKeyIdentifier(c);delete this._keymap[c];this.fire("keyup",new a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};c.prototype._handleKeyPress=function(b){var c=b.keyCode||b.charCode;b.keyIdentifier||this.toKeyIdentifier(c);this.fire("keypress",new a(this,b));this.preventDefault&&b.preventDefault();
this.stopPropagation&&b.stopPropagation()};c.prototype.update=function(){var a;this._lastmap={};for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};c.prototype.isPressed=function(a){a=d(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};c.prototype.wasPressed=function(a){a=d(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};c.prototype.wasReleased=function(a){a=d(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};
return{Keyboard:c,EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:14,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,
KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,
KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224}}());pc.extend(pc.input,function(){var d=function(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=0.25},a={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},b={"Product: 0268":"PS3"};d.prototype={update:function(){var a=this.poll(),b,d=a.length;for(b=0;b<d;b++)this.previous[b]=this.current[b],this.current[b]=a[b]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),d,f=b.length;for(d=0;d<f;d++)b[d]&&a.push({map:this.getMap(b[d]),pad:b[d]})}return a},getMap:function(c){for(var e in b)if(0<=c.id.indexOf(e))return a[b[e]];
return a.DEFAULT},isPressed:function(a,b){return!this.current[a]?!1:this.current[a].pad.buttons[pc.input[this.current[a].map.buttons[b]]].pressed},wasPressed:function(a,b){if(!this.current[a])return!1;var d=pc.input[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[d].pressed&&!this.previous[a].pad.buttons[d].pressed},getAxis:function(a,b){if(!this.current[a])return!1;var d=this.current[a].pad.axes[pc.input[this.current[a].map.axes[b]]];Math.abs(d)<this.deadZone&&(d=0);return d}};
return{PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,GamePads:d}}());pc.extend(pc.input,function(){var d=function(b,e){this.element=e.target;this.event=e;this.touches=[];this.changedTouches=[];if(e){var d,f=e.touches.length;for(d=0;d<f;d++)this.touches.push(new a(e.touches[d]));f=e.changedTouches.length;for(d=0;d<f;d++)this.changedTouches.push(new a(e.changedTouches[d]))}};d.prototype={getTouchById:function(a,b){var d,f=b.length;for(d=0;d<f;d++)if(b[d].id===a)return b[d];return null}};var a=function(a){var b=pc.input.getTouchTargetCoords(a);this.id=a.identifier;this.x=
b.x;this.y=b.y;this.target=a.target;this.touch=a},b=function(a){this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a);pc.events.attach(this)};b.prototype={attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,
!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire("touchstart",
new d(this,a))},_handleTouchEnd:function(a){this.fire("touchend",new d(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire("touchmove",new d(this,a))},_handleTouchCancel:function(a){this.fire("touchcancel",new d(this,a))}};return{EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",getTouchTargetCoords:function(a){for(var b=0,d=0,f=a.target;!(f instanceof HTMLElement);)f=f.parentNode;do b+=f.offsetLeft-f.scrollLeft,d+=
f.offsetTop-f.scrollTop,f=f.offsetParent;while(f);return{x:a.pageX-b,y:a.pageY-d}},TouchDevice:b}}());pc.extend(pc.input,function(){var d=function(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)};d.prototype.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};d.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};d.prototype.disableContextMenu=
function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};d.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};d.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var b in this._axes)this._axesValues[b]=[]};d.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error(pc.string.format("Action: {0} already registered",
a));if(void 0===b)throw Error("Invalid button");b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:pc.input.ACTION_KEYBOARD,keys:b}):this._actions[a]=[{type:pc.input.ACTION_KEYBOARD,keys:b}]};d.prototype.registerMouse=function(a,b){this._mouse||this._enableMouse();if(void 0===b)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.input.ACTION_MOUSE,button:b}):this._actions[a]=[{type:pc.input.ACTION_MOUSE,button:-b}]};d.prototype.registerPadButton=function(a,b,
c){if(void 0===c)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.input.ACTION_GAMEPAD,button:c,pad:b}):this._actions[a]=[{type:pc.input.ACTION_GAMEPAD,button:c,pad:b}]};d.prototype.registerAxis=function(a){var b=a.name;this._axes[b]||(this._axes[b]=[]);var c=this._axes[b].push(b),a=a||{};a.pad=a.pad||pc.input.PAD_1;var e=function(e,d,k,h){switch(d){case "mousex":e._mouse.on(pc.input.EVENT_MOUSEMOVE,function(a){e._axesValues[b][c]=a.dx/10});break;case "mousey":e._mouse.on(pc.input.EVENT_MOUSEMOVE,
function(a){e._axesValues[b][c]=a.dy/10});break;case "key":e._axes[b].push(function(){return e._keyboard.isPressed(h)?k:0});break;case "padrx":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_R_STICK_X)});break;case "padry":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_R_STICK_Y)});break;case "padlx":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_L_STICK_X)});break;case "padly":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,
pc.input.PAD_L_STICK_Y)});break;default:throw Error("Unknown axis");}};e(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&e(this,a.negative,-1,a.negativeKey)};d.prototype.isPressed=function(a){if(!this._actions[a])return!1;for(var b,c=0,e=this._actions[a].length,c=0;c<e;++c)switch(b=this._actions[a][c],b.type){case pc.input.ACTION_KEYBOARD:if(this._keyboard){var d,f=b.keys.length;for(d=0;d<f;d++)if(this._keyboard.isPressed(b.keys[d]))return!0}break;case pc.input.ACTION_MOUSE:if(this._mouse&&
this._mouse.isPressed(b.button))return!0;break;case pc.input.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.isPressed(b.pad,b.button))return!0}return!1};d.prototype.wasPressed=function(a){if(!this._actions[a])return!1;for(var b=0,c=this._actions[a].length,b=0;b<c;++b){var e=this._actions[a][b];switch(e.type){case pc.input.ACTION_KEYBOARD:if(this._keyboard){var d,f=e.keys.length;for(d=0;d<f;d++)if(this._keyboard.wasPressed(e.keys[d]))return!0}break;case pc.input.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(e.button))return!0;
break;case pc.input.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(e.pad,e.button))return!0}}return!1};d.prototype.getAxis=function(a){var b=0;if(this._axes[a]){var c,e=this._axes[a].length;for(c=0;c<e;c++)if("function"===pc.type(this._axes[a][c])){var d=this._axes[a][c]();Math.abs(d)>Math.abs(b)&&(b=d)}else this._axesValues[a]&&Math.abs(this._axesValues[a][c])>Math.abs(b)&&(b=this._axesValues[a][c])}return b};d.prototype._enableMouse=function(){this._mouse=new pc.input.Mouse;if(!this._element)throw Error("Controller must be attached to a DOMElement");
this._mouse.attach(this._element)};d.prototype._enableKeyboard=function(){this._keyboard=new pc.input.Keyboard;if(!this._element)throw Error("Controller must be attached to a DOMElement");this._keyboard.attach(this._element)};return{ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",Controller:d}}());pc.net=function(){return{}}();pc.extend(pc.net,function(){var d=function(){};d.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",BIN:"application/octet-stream"};d.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document"};d.binaryExtensions=[".model",".wav",".ogg",".mp3"];d.prototype={ContentType:d.ContentType,ResponseType:d.ResponseType,
binaryExtensions:d.binaryExtensions,get:function(a,b,c,e){c=c||{};c.success=b;return this.request("GET",a,c,e)},post:function(a,b,c,e,d){e=e||{};e.success=b;e.postdata=c;return this.request("POST",a,e,d)},put:function(a,b,c,e,d){e=e||{};e.success=b;e.postdata=c;return this.request("PUT",a,e,d)},del:function(a,b,c,e){c=c||{};c.success=b;return this.request("DELETE",a,c,e)},request:function(a,b,c,e){var g,f,k,h=!1,c=c||{};null==c.success&&(c.success=function(){});null==c.error&&(c.error=function(){});
null==c.async&&(c.async=!0);null==c.headers&&(c.headers={});if(null!=c.postdata)if(c.postdata instanceof Document)k=c.postdata;else if(c.postdata instanceof FormData)k=c.postdata;else if(c.postdata instanceof Object)switch(k=c.headers["Content-Type"],pc.isDefined(k)||(c.headers["Content-Type"]=d.ContentType.FORM_URLENCODED,k=c.headers["Content-Type"]),k){case d.ContentType.FORM_URLENCODED:k="";f=!0;for(g in c.postdata)c.postdata.hasOwnProperty(g)&&(f?f=!1:k+="&",k+=escape(g)+"="+escape(c.postdata[g]));
break;default:null==k&&(c.headers["Content-Type"]=d.ContentType.JSON),k=JSON.stringify(c.postdata)}else k=c.postdata;e||(e=new XMLHttpRequest);!1===c.cache&&(f=pc.time.now(),g=new pc.URI(b),g.query=g.query?g.query+"&ts="+f:"ts="+f,b=g.toString());c.query&&(g=new pc.URI(b),f=pc.extend(g.getQuery(),c.query),g.setQuery(f),b=g.toString());e.open(a,b,c.async);e.withCredentials=!0;e.responseType=c.responseType||this.guessResponseType(b);for(var l in c.headers)c.headers.hasOwnProperty(l)&&e.setRequestHeader(l,
c.headers[l]);e.onreadystatechange=function(){this.onReadyStateChange(a,b,c,e)}.bind(this);e.onerror=function(){this.onError(a,b,c,e);h=!0}.bind(this);try{e.send(k)}catch(n){h||c.error(e.status,e,n)}return e},guessResponseType:function(a){a=new pc.URI(a);a=pc.path.getExtension(a.path);return 0<=d.binaryExtensions.indexOf(a)?d.ResponseType.ARRAY_BUFFER:d.ResponseType.TEXT},isBinaryContentType:function(a){return 0<=[d.ContentType.WAV,d.ContentType.OGG,d.ContentType.MP3,d.ContentType.BIN].indexOf(a)?
!0:!1},onReadyStateChange:function(a,b,c,e){if(4===e.readyState)switch(e.status){case 0:if("/"!=b[0])this.onSuccess(a,b,c,e);break;case 200:case 201:case 206:case 304:this.onSuccess(a,b,c,e);break;default:this.onError(a,b,c,e)}},onSuccess:function(a,b,c,e){var g;if(a=e.getResponseHeader("Content-Type"))a=a.split(";"),g=a[0].trim(),a[1]&&a[1].trim();g===this.ContentType.JSON||pc.string.endsWith(b,".json")?b=JSON.parse(e.responseText):this.isBinaryContentType(g)?b=e.response:e.responseType===d.ResponseType.ARRAY_BUFFER?
(logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}",d.ResponseType.ARRAY_BUFFER,g)),b=e.response):b=e.responseType===d.ResponseType.DOCUMENT||g===this.ContentType.XML?e.responseXML:e.responseText;c.success(b,e.status,e)},onError:function(a,b,c,e){c.error(e.status,e,null)}};d.prototype.delete_=d.prototype.del;return{Http:d,http:new d}}());pc.extend(pc.net,function(){var d=0,a=function(a,c,e,d,f){this.clientId=d;this.endpoint=a;this.redirectUrl=c;this.origin=e;this.scope=f;this.responseType="token";this.accessToken=null;this.OAUTH_IFRAME_ID_BASE="pc-oauth-access-token-"},a=pc.inherits(a,pc.net.Http);a.prototype.refreshAccessToken=function(a){var c=this.OAUTH_IFRAME_ID_BASE+d++,e=function(d){if(d.origin===this.origin){if(d.data.access_token){var g=document.getElementById(c);g&&g.parentNode.removeChild(g);this.accessToken=d.data.access_token;
a(d.data.access_token)}else d.data.error?logERROR(d.data.error):logWARNING("Invalid message posted to Corazon API");window.removeEventListener("message",e)}}.bind(this);window.addEventListener("message",e,!1);var g={client_id:this.clientId,redirect_url:this.redirectUrl,scope:this.scope,response_type:this.responseType},f=new pc.URI(this.endpoint);f.setQuery(g);if(g=document.getElementById(c))throw Error("accessToken request already in progress");g=document.createElement("iframe");g.src=f.toString();
g.id=c;g.style.display="none";document.body.appendChild(g)};a.prototype.request=function(a,c,e,d){e.query=e.query||{};e.query=pc.extend(e.query,{access_token:this.accessToken});return pc.net.OAuth._super.request.call(this,a,c,e,d)};a.prototype.onError=function(a,c,e,d){401==d.status?this.refreshAccessToken(function(f){e.query.access_token=f;this.request(a,c,e,d)}.bind(this)):e.error(d.status,d,null)};return{OAuth:a,oauth:new a}}());pc.extend(pc.net,function(){var d=function(a){this._ws=new WebSocket(a);this._ws.onopen=this._handleOpen.bind(this);this._ws.onerror=this._handleError.bind(this);this._ws.onmessage=this._handleMessage.bind(this);this._ws.onclose=this._handleClose.bind(this)};d.prototype={onopen:null,onerror:null,onmessage:null,get binaryType(){return this._ws.binaryType},set binaryType(a){this._ws.binaryType=a},get readyState(){return this._ws.readyState},get bufferedAmount(){return this._ws.bufferedAmount},get extensions(){return this._ws.extensions},
get protocol(){return this._ws.protocol},_handleOpen:function(){if(this.onopen)this.onopen()},_handleError:function(a){if(this.onerror)this.onerror(a)},_handleMessage:function(a){if(this.onmessage)this.onmessage(a)},_handleClose:function(){if(this.onclose)this.onclose()},send:function(a){this._ws.send(a)}};return{Socket:d}}());pc.script=function(){var d=null,a=null,b={main:function(a){if(d)throw Error("'main' Object already registered");d=a},setLoader:function(b){if(b&&a)throw Error("pc.script already has loader object.");a=b},create:function(a,b){void 0===b&&(b=attributes);this.fire("created",a,b)},attribute:function(){},start:function(){d()}};pc.events.attach(b);return b}();pc.extend(pc.resources,function(){var d=function(a,c){this._context=a;this._prefix=c||"";this._queue=[];this._pending=[];this._loaded={};this._loading=null;pc.script.on("created",this._onScriptCreated,this)},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a,c){c=c||{};c.timeout=c.timeout||6E4;c.cache=!0;return new pc.promise.Promise(function(e,d){var f=a.canonical,k=f;c.cache||(k=this._appendTimestampToUrl(k));k=new pc.URI(k);k.path=pc.path.join(this._prefix,k.path);k=k.toString();
this._loaded[f]?!0!==this._loaded[f]?e(this._loaded[f]):e(null):this._loading?this._queue.push({url:k,canonicalUrl:f,success:e,error:d}):this._addScriptTag(k,f,e,d);c.timeout&&setTimeout(function(){this._loaded[f]||d(pc.string.format("Loading script {0} timed out after {1}s",f,c.timeout/1E3))}.bind(this),c.timeout)}.bind(this))};d.prototype.open=function(a){return a};d.prototype._appendTimestampToUrl=function(a){timestamp=Date.now();uri=new pc.URI(a);uri.query=uri.query?uri.query+"&ts="+timestamp:
"ts="+timestamp;return a=uri.toString()};d.prototype._onScriptCreated=function(a,c){this._pending.push({name:a,callback:c})};d.prototype._addScriptTag=function(a,c,e,d){var f=this,k=document.getElementsByTagName("head")[0],h=document.createElement("script");this._loading=h;h.addEventListener("error",function(a){d(pc.string.format("Error loading script from '{0}'",a.target.src))});var l=!1;h.onload=h.onreadystatechange=function(){if(!l&&(!this.readyState||"loaded"==this.readyState||"complete"==this.readyState)){l=
!0;var a=f._pending.shift();if(a){var b=a.callback(f._context);if(b._pcScriptName)throw Error("Attribute _pcScriptName is reserved on ScriptTypes for ResourceLoader use");b._pcScriptName=a.name;f._loaded[c]=b;f._loader.registerHash(c,c);f._loader.addToCache(c,b);e(b)}else f._loaded[c]=!0,f._loader.registerHash(c,c),f._loader.addToCache(c,!0),e(null);f._loading=null;f._queue.length&&(a=f._queue.shift(),f._addScriptTag(a.url,a.canonicalUrl,a.success,a.error))}};h.src=a;k.appendChild(h)};var a;a=pc.inherits(function(){},
pc.resources.ResourceRequest);a.prototype.type="script";return{ScriptResourceHandler:d,ScriptRequest:a}}());pc.fw={};var editor=editor||{};pc.extend(editor,function(){var d=function(){this.exposed={};this.added={};this.scripts={};this.systems=[]};d.prototype={addComponentType:function(){},expose:function(){},add:function(){},scriptexpose:function(){}};return{LinkInterface:d,link:new d}}());pc.extend(editor,function(){var d=function(){this.exposed={};this.added={};this.scripts={};this.systems=[]};d.prototype.addComponentType=function(a){var b=a.id,c,e=this.systems,d=e.length,f=!1;for(c=0;c<d;c++)if(e[c].name===b){f=!0;break}f||this.systems.push({name:b,description:a.description});this.exposed[b]||(this.exposed[b]={})};d.prototype.expose=function(a,b){if(!b.name)throw Error("Missing option 'name'");b.options=b.options||{};if("vector"===b.type)if(b.array=!0,b.defaultValue)switch(b.defaultValue.length){case 2:b.RuntimeType=
pc.Vec2;break;case 3:b.RuntimeType=pc.Vec3;break;case 4:b.RuntimeType=pc.Vec4}else b.RuntimeType=pc.Vec3;else"rgb"===b.type||"rgba"===b.type?(b.array=!0,b.RuntimeType=pc.Color):"curve"===b.type?(b.object=!0,b.RuntimeType=pc.Curve):"curveset"===b.type&&(b.object=!0,b.RuntimeType=pc.CurveSet);this.exposed[a][b.name]||(this.exposed[a][b.name]={});this.exposed[a][b.name]=b};d.prototype.add=function(a){logASSERT(a.system,"Missing option: 'system'");logASSERT(a.variable,"Missing option: 'variable'");this.added[a.system]||
(this.added[a.system]={});this.added[a.system][a.variable]||(this.added[a.system][a.variable]={});this.added[a.system][a.variable]=a};d.prototype.scriptexpose=function(a){this.scripts[a.script]=a};return{LinkInterface:d,link:new d}}());pc.extend(pc.fw,function(){return{ContentFile:function(d){this.packs=d.packs||{};this.appProperties=d.application_properties||{};this.toc=d.toc||{}}}}());pc.extend(pc.fw,function(){var d=function(a){this.hierarchy=a.hierarchy;this.settings=a.settings};d.prototype={};return{Pack:d}}());pc.extend(pc.fw,function(){return{ApplicationContext:function(d,a,b,c,e){this.loader=d;this.scene=a;this.graphicsDevice=b;this.root=new pc.fw.Entity;d=e.depot?e.depot.assets.getServer().getBaseUrl():null;this.assets=new pc.asset.AssetRegistry(this.loader,d);this.systems=c;e=e||{};this.controller=e.controller;this.keyboard=e.keyboard;this.mouse=e.mouse;this.touch=e.touch;this.gamepads=e.gamepads}}}());pc.extend(pc.fw,function(){var d,a=function(b,c){c=c||{};this._inTools=!1;pc.events.attach(this);this.canvas=b;this.fillMode=pc.fw.FillMode.KEEP_ASPECT;this.resolutionMode=pc.fw.ResolutionMode.FIXED;this.librariesLoaded=!1;this._link=new pc.fw.LiveLink("application");this._link.addDestinationWindow(window);this._link.listen(this._handleMessage.bind(this));pc.log.open();this.graphicsDevice=new pc.GraphicsDevice(b);var e=new pc.fw.ComponentSystemRegistry;this.audioManager=new pc.audio.AudioManager;
var d=new pc.resources.ResourceLoader;!1===c.cache&&(d.cache=!1);c.displayLoader&&new pc.resources.ResourceLoaderDisplay(document.body,d);this.context=new pc.fw.ApplicationContext(d,new pc.scene.Scene,this.graphicsDevice,e,c);c.content&&(this.content=c.content,Object.keys(this.content.toc).forEach(function(a){this.context.assets.addGroup(a,this.content.toc[a])}.bind(this)));new pc.resources.TextureCache(d);d.registerHandler(pc.resources.JsonRequest,new pc.resources.JsonResourceHandler);d.registerHandler(pc.resources.TextRequest,
new pc.resources.TextResourceHandler);d.registerHandler(pc.resources.ImageRequest,new pc.resources.ImageResourceHandler);d.registerHandler(pc.resources.MaterialRequest,new pc.resources.MaterialResourceHandler(this.graphicsDevice,this.context.assets));d.registerHandler(pc.resources.TextureRequest,new pc.resources.TextureResourceHandler(this.graphicsDevice,this.context.assets));d.registerHandler(pc.resources.CubemapRequest,new pc.resources.CubemapResourceHandler(this.graphicsDevice,this.context.assets));
d.registerHandler(pc.resources.ModelRequest,new pc.resources.ModelResourceHandler(this.graphicsDevice,this.context.assets));d.registerHandler(pc.resources.AnimationRequest,new pc.resources.AnimationResourceHandler);d.registerHandler(pc.resources.PackRequest,new pc.resources.PackResourceHandler(e,c.depot));d.registerHandler(pc.resources.AudioRequest,new pc.resources.AudioResourceHandler(this.audioManager));this.renderer=new pc.scene.ForwardRenderer(this.graphicsDevice);d.registerHandler(pc.resources.ScriptRequest,
new pc.resources.ScriptResourceHandler(this.context,c.scriptPrefix));new pc.fw.RigidBodyComponentSystem(this.context);new pc.fw.CollisionComponentSystem(this.context);new pc.fw.BallSocketJointComponentSystem(this.context);new pc.fw.AnimationComponentSystem(this.context);new pc.fw.ModelComponentSystem(this.context);new pc.fw.CameraComponentSystem(this.context);new pc.fw.CubeMapComponentSystem(this.context);new pc.fw.StaticCubeMapComponentSystem(this.context);new pc.fw.LightComponentSystem(this.context);
new pc.fw.PackComponentSystem(this.context);new pc.fw.SkyboxComponentSystem(this.context);new pc.fw.ScriptComponentSystem(this.context);new pc.fw.PickComponentSystem(this.context);new pc.fw.AudioSourceComponentSystem(this.context,this.audioManager);new pc.fw.AudioListenerComponentSystem(this.context,this.audioManager);new pc.fw.ParticleSystemComponentSystem(this.context);new pc.fw.DesignerComponentSystem(this.context);this.on("librariesloaded",this.onLibrariesLoaded,this);c.libraries&&c.libraries.length?
(e=c.libraries.map(function(a){return new pc.resources.ScriptRequest(a)}),d.request(e).then(function(){this.fire("librariesloaded",this);this.librariesLoaded=!0}.bind(this))):(this.fire("librariesloaded",this),this.librariesLoaded=!0);void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this.onVisibilityChange.bind(this),!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this.onVisibilityChange.bind(this),
!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this.onVisibilityChange.bind(this),!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this.onVisibilityChange.bind(this),!1));a._applications[this.canvas.id]=this};a._applications={};a.getApplication=function(b){return a._applications[b]};a.prototype={loadFromToc:function(a,c,e,d){this.content||e("No content");var a=this.content.toc[a],
c=c||function(){},e=e||function(){},d=d||function(){},f=a.packs[0],k=function(){this.context.loader.request(new pc.resources.PackRequest(f)).then(function(a){a=a[0];this.context.root.addChild(a.hierarchy);pc.fw.ComponentSystem.initialize(a.hierarchy);pc.fw.ComponentSystem.postInitialize(a.hierarchy);if(this.context.systems.rigidbody&&"undefined"!==typeof Ammo){var b=a.settings.physics.gravity;this.context.systems.rigidbody.setGravity(b[0],b[1],b[2])}b=a.settings.render.global_ambient;this.context.scene.ambientLight=
new pc.Color(b[0],b[1],b[2]);this.context.scene.fog=a.settings.render.fog;b=a.settings.render.fog_color;this.context.scene.fogColor=new pc.Color(b[0],b[1],b[2]);this.context.scene.fogStart=a.settings.render.fog_start;this.context.scene.fogEnd=a.settings.render.fog_end;this.context.scene.fogDensity=a.settings.render.fog_density;this.context.scene.gammaCorrection=a.settings.render.gamma_correction;this.context.scene.toneMapping=a.settings.render.tonemapping;this.context.scene.exposure=a.settings.render.exposure;
a.settings.render.skybox&&(b=this.context.assets.getAssetById(a.settings.render.skybox),this.context.scene.skybox=b?b.resource:null);c(a);this.context.loader.off("progress",d)}.bind(this),function(a){e(a)}).then(null,function(a){setTimeout(function(){throw a;},0)})}.bind(this),h=function(){var a=this.context.assets.list(f);this.context.loader.on("progress",d);a.length?this.context.assets.load(a).then(function(a){k(a)}):setTimeout(function(){k([])},0)}.bind(this);if(this.librariesLoaded)h();else this.on("librariesloaded",
function(){h()})},start:function(){if(this.librariesLoaded)this.tick();else this.on("librariesloaded",function(){this.tick()},this)},update:function(a){var c=this.context;pc.fw.ComponentSystem.fixedUpdate(1/60,c,this._inTools);pc.fw.ComponentSystem.update(a,c,this._inTools);pc.fw.ComponentSystem.postUpdate(a,c,this._inTools);this.fire("update",a);c.controller&&c.controller.update(a);c.mouse&&c.mouse.update(a);c.keyboard&&c.keyboard.update(a);c.gamepads&&c.gamepads.update(a)},render:function(){var a=
this.context,c=a.systems.camera.cameras,e=null,d=this.renderer;a.root.syncHierarchy();for(var f=0,k=c.length;f<k;f++)e=c[f],e.frameBegin(),d.render(a.scene,e.camera),e.frameEnd()},tick:function(){window.requestAnimationFrame(this.tick.bind(this));var a=window.performance&&window.performance.now?performance.now():Date.now(),c=(a-(d||a))/1E3;d=a;c=pc.math.clamp(c,0,0.1);this.update(c);this.render()},setCanvasFillMode:function(a,c,e){this.fillMode=a;this.resizeCanvas(c,e)},setCanvasResolution:function(a,
c,e){this.resolutionMode=a;a===pc.fw.ResolutionMode.AUTO&&void 0===c&&(c=this.canvas.clientWidth,e=this.canvas.clientHeight);this.graphicsDevice.resizeCanvas(c,e)},isFullscreen:function(){return!!document.fullscreenElement},enableFullscreen:function(a,c,e){var a=a||this.canvas,d=function(){c();document.removeEventListener("fullscreenchange",d)},f=function(){e();document.removeEventListener("fullscreenerror",f)};c&&document.addEventListener("fullscreenchange",d,!1);e&&document.addEventListener("fullscreenerror",
f,!1);a.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT)},disableFullscreen:function(a){var c=function(){a();document.removeEventListener("fullscreenchange",c)};a&&document.addEventListener("fullscreenchange",c,!1);document.exitFullscreen()},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this.audioManager.suspend():this.audioManager.resume()},resizeCanvas:function(a,c){var e=window.innerWidth,d=window.innerHeight;if(navigator.isCocoonJS)a=e,c=d,
e=window.devicePixelRatio,this.graphicsDevice.resizeCanvas(a*e,c*e);else{if(this.fillMode===pc.fw.FillMode.KEEP_ASPECT){var f=this.canvas.width/this.canvas.height;f>e/d?(a=e,c=a/f):(c=d,a=c*f)}else this.fillMode===pc.fw.FillMode.FILL_WINDOW&&(a=e,c=d);this.canvas.style.width=a+"px";this.canvas.style.height=c+"px";this.resolutionMode===pc.fw.ResolutionMode.AUTO&&this.setCanvasResolution(pc.fw.ResolutionMode.AUTO)}return{width:a,height:c}},onLibrariesLoaded:function(){this.context.systems.rigidbody.onLibraryLoaded();
this.context.systems.collision.onLibraryLoaded()},_handleMessage:function(a){var c;switch(a.type){case pc.fw.LiveLinkMessageType.UPDATE_COMPONENT:this._linkUpdateComponent(a.content.id,a.content.component,a.content.attribute,a.content.value);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY:this._linkUpdateEntity(a.content.id,a.content.components);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_TRANSFORM:this._linkUpdateEntityTransform(a.content.id,a.content.position,a.content.rotation,a.content.scale);
break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_NAME:c=this.context.root.findOne("getGuid",a.content.id);c.setName(a.content.name);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_ENABLED:c=this.context.root.findOne("getGuid",a.content.id);c.enabled=a.content.enabled;break;case pc.fw.LiveLinkMessageType.REPARENT_ENTITY:this._linkReparentEntity(a.content.id,a.content.newParentId,a.content.index);break;case pc.fw.LiveLinkMessageType.CLOSE_ENTITY:if(c=this.context.root.findOne("getGuid",a.content.id))logDEBUG(pc.string.format("RT: Removed '{0}' from parent {1}",
a.content.id,c.getParent().getGuid())),c.destroy();break;case pc.fw.LiveLinkMessageType.OPEN_PACK:a=this.context.loader.open(pc.resources.PackRequest,a.content.pack);c=a.hierarchy;c.__parent?(a=this.context.root.findByGuid(c.__parent),a.addChild(c)):this.context.root.addChild(c);break;case pc.fw.LiveLinkMessageType.OPEN_ENTITY:a.content.entity&&(a={application_data:{},hierarchy:a.content.entity},a=this.context.loader.open(pc.resources.PackRequest,a),c=a.hierarchy,c.__parent?(a=this.context.root.findByGuid(c.__parent),
a.addChild(c)):this.context.root.addChild(c));break;case pc.fw.LiveLinkMessageType.UPDATE_ASSET:this._linkUpdateAsset(a.content.id,a.content.attribute,a.content.value);break;case pc.fw.LiveLinkMessageType.UPDATE_ASSETCACHE:var e;for(c in a.content.assets)if(e=this.context.assets.getAssetById(c)){var d=a.content.assets[c],f;for(f in d)d.hasOwnProperty(f)&&(e[f]=d[f])}else this.context.assets.createAndAddAsset(c,a.content.assets[c]);for(c in a.content.deleted)(e=this.context.assets.getAssetById(c))&&
this.context.assets.removeAsset(e);break;case pc.fw.LiveLinkMessageType.UPDATE_PACK_SETTINGS:this._linkUpdatePackSettings(a.content.settings)}},_linkUpdateComponent:function(a,c,e,d){var a=this.context.root.findOne("getGuid",a),f;a&&(c?a[c]?(f=editor.link.exposed[c][e],editor&&f?f.RuntimeType?f.RuntimeType===pc.Vec3?a[c][e]=new f.RuntimeType(d[0],d[1],d[2]):f.RuntimeType===pc.Vec4?a[c][e]=new f.RuntimeType(d[0],d[1],d[2],d[3]):f.RuntimeType===pc.Vec2?a[c][e]=new f.RuntimeType(d[0],d[1]):f.RuntimeType===
pc.Color?a[c][e]=3===d.length?new f.RuntimeType(d[0],d[1],d[2]):new f.RuntimeType(d[0],d[1],d[2],d[3]):f.RuntimeType===pc.Curve||f.RuntimeType===pc.CurveSet?(a[c][e]=new f.RuntimeType(d.keys),a[c][e].type=d.type):a[c][e]=new f.RuntimeType(d):a[c][e]=d:a[c][e]=d):logWARNING(pc.string.format("No component system called '{0}' exists",c)):a[e]=d)},_linkUpdateEntityTransform:function(a,c,e,d){if(a=this.context.root.findByGuid(a))a.setLocalPosition(c[0],c[1],c[2]),a.setLocalEulerAngles(e[0],e[1],e[2]),
a.setLocalScale(d[0],d[1],d[2]),a.fire("livelink:updatetransform",c,e,d)},_linkReparentEntity:function(a,c,e){a=this.context.root.findByGuid(a);c=this.context.root.findByGuid(c);a.reparent(c,e)},_linkUpdateEntity:function(a,c){var e,d=this.context.root.findOne("getGuid",a);if(d){var f=this.context.systems.getComponentSystemOrder(),k,h=f.length;for(k=0;k<h;k++)e=f[k],c.hasOwnProperty(e)&&this.context.systems.hasOwnProperty(e)&&(d[e]||this.context.systems[e].addComponent(d,{}));for(e in this.context.systems)"gizmo"===
e||"pick"===e||this.context.systems.hasOwnProperty(e)&&!c.hasOwnProperty(e)&&d[e]&&this.context.systems[e].removeComponent(d)}},_linkUpdateAsset:function(a,c,e){(a=this.context.assets.getAssetById(a))&&(a[c]=e)},_linkUpdatePackSettings:function(a){var c=a.render.global_ambient;this.context.scene.ambientLight.set(c[0],c[1],c[2]);this.context.systems.rigidbody&&"undefined"!==typeof Ammo&&(c=a.physics.gravity,this.context.systems.rigidbody.setGravity(c[0],c[1],c[2]));this.context.scene.fog=a.render.fog;
this.context.scene.fogStart=a.render.fog_start;this.context.scene.fogEnd=a.render.fog_end;c=a.render.fog_color;this.context.scene.fogColor=new pc.Color(c[0],c[1],c[2]);this.context.scene.fogDensity=a.render.fog_density;this.context.scene.gammaCorrection=a.render.gamma_correction;this.context.scene.toneMapping=a.render.tonemapping;this.context.scene.exposure=a.render.exposure;a.render.skybox?(c=this.context.assets.getAssetById(a.render.skybox))?c.resource?this.context.scene.skybox=c.resource:this.context.assets.load([c]).then(function(a){this.context.scene.skybox=
a[0]}.bind(this),function(){pc.log.error("Could not initialize scene skybox. Missing cubemap asset "+a.render.skybox)}):pc.log.error("Could not initialize scene skybox. Missing cubemap asset "+a.render.skybox):this.context.scene.skybox=null}};return{FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:"KEEP_ASPECT"},ResolutionMode:{AUTO:"AUTO",FIXED:"FIXED"},Application:a}}());pc.extend(pc.resources,function(){var d=function(a,c){this._registry=a;this._depot=c},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a){return new pc.promise.Promise(function(c,e){var d=a.canonical;d in pc.content.packs?setTimeout(function(){c(pc.content.packs[d])},0):this._depot.packs.getOne(d,function(a){c(a)}.bind(this),function(a){e(a)})}.bind(this))};d.prototype.open=function(a,c){return this.openPack(a,c)};d.prototype.openPack=function(a,c){var e=pc.extend({},a);e.hierarchy=
this.openEntity(e.hierarchy,c);return new pc.fw.Pack(e)};d.prototype.openEntity=function(a,c){var e;e=this.openEntityHierarchy(a,c);e.syncHierarchy();return e=this.openComponentData(e,a,c)};d.prototype.openEntityHierarchy=function(a,c){var e=new pc.fw.Entity,d=a.position,f=a.rotation,k=a.scale;e.setName(a.name);e.setGuid(a.resource_id);e.setLocalPosition(d[0],d[1],d[2]);e.setLocalEulerAngles(f[0],f[1],f[2]);e.setLocalScale(k[0],k[1],k[2]);e._enabled=void 0!==a.enabled?a.enabled:!0;e._enabledInHierarchy=
e._enabled;a.labels&&a.labels.forEach(function(a){e.addLabel(a)});e.__parent=a.parent;e.__children=a.children;e.name=a.name;e.template=a.template;k=a.children.length;for(d=0;d<k;d++)f=this.openEntityHierarchy(a.children[d],c),e.addChild(f);return e};d.prototype.openComponentData=function(a,c,e){a.setRequest(e);var d=this._registry.list(),f,k=d.length;for(f=0;f<k;f++){var h=c.components[d[f].id];h&&this._registry[d[f].id].addComponent(a,h)}a.setRequest(null);d=c.children.length;k=a.getChildren();for(f=
0;f<d;f++)k[f]=this.openComponentData(k[f],c.children[f],e);return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="pack";a.prototype.Type=pc.fw.Pack;return{PackResourceHandler:d,PackRequest:a}}());pc.extend(pc.fw,function(){var d=function(){};d.prototype={add:function(a,b){if(this[a])throw Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",a));this[a]=b;b.name=a},remove:function(a){if(!this[a])throw Error(pc.string.format("No ComponentSystem named '{0}' registered",a));delete this[a]},list:function(){var a=Object.keys(this),b={collisionrect:0.5,collisioncircle:0.5};a.sort(function(a,e){var d=b[a]||1,f=b[e]||1;return d<f?-1:d>f?1:0});return a.map(function(a){return this[a]},
this)},getComponentSystemOrder:function(){var a,b=Object.keys(this);a=b.indexOf("collisionrect");b.splice(a,1);b.unshift("collisionrect");a=b.indexOf("collisioncircle");b.splice(a,1);b.unshift("collisioncircle");return b}};return{ComponentSystemRegistry:d}}());pc.extend(pc.fw,function(){var d=function(a){this.context=a;this.dataStore={};this.schema=[];pc.events.attach(this)};pc.extend(d,{initialize:function(a){d.fire("initialize",a)},postInitialize:function(a){d.fire("postInitialize",a)},update:function(a,b,c){c?d.fire("toolsUpdate",a):d.fire("update",a)},fixedUpdate:function(a){d.fire("fixedUpdate",a)},postUpdate:function(a){d.fire("postUpdate",a)}});d.prototype={get store(){return this.dataStore},addComponent:function(a,b){var c=new this.ComponentType(this,
a),e=new this.DataType,b=b||{};this.dataStore[a.getGuid()]={entity:a,data:e};a[this.id]=c;a.c[this.id]=c;this.initializeComponentData(c,b,[]);this.fire("add",a,c);return c},removeComponent:function(a){var b=this.dataStore[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.dataStore[a.getGuid()];delete a[this.id];delete a.c[this.id];this.fire("remove",a,b.data)},cloneComponent:function(a,b){var c=this.dataStore[a.getGuid()];return this.addComponent(b,c.data)},initializeComponentData:function(a,
b,c){b=b||{};c.forEach(function(c){a[c]=void 0!==b[c]?b[c]:a.data[c]},this);if(a.enabled&&a.entity.enabled)a.onEnable()},exposeProperties:function(){editor.link.addComponentType(this);this.schema.forEach(function(a){!1!==a.exposed&&editor.link.expose(this.id,a)}.bind(this))}};pc.events.attach(d);return{ComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.system=a;this.entity=b;pc.events.attach(this);this.buildAccessors(this.system.schema);this.on("set",function(a,b,d){this.fire("set_"+a,a,b,d)});this.on("set_enabled",this.onSetEnabled,this)};d.prototype={get data(){var a=this.system.store[this.entity.getGuid()];return a?a.data:null},buildAccessors:function(a){a.forEach(function(a){a.readOnly?Object.defineProperty(this,a.name,{get:function(){return this.data[a.name]},configurable:!0}):Object.defineProperty(this,
a.name,{get:function(){return this.data[a.name]},set:function(c){var e=this.data,d=e[a.name];e[a.name]=c;this.fire("set",a.name,d,c)},configurable:!0})}.bind(this))},onSetEnabled:function(a,b,c){if(b!==c&&this.entity.enabled)if(c)this.onEnable();else this.onDisable()},onEnable:function(){},onDisable:function(){}};return{Component:d}}());pc.extend(pc.fw,function(){return{ComponentData:function(){}}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{play:function(a,b){if(this.data.animations[a]){if(this.enabled&&this.entity.enabled){var b=b||0,c=this.data;c.prevAnim=c.currAnim;c.currAnim=a;c.model&&(c.blending=0<b,c.blending?(c.blendTime=b,c.blendTimeRemaining=b,c.fromSkel.setAnimation(c.animations[c.prevAnim]),
c.fromSkel.addTime(c.skeleton.getCurrentTime()),c.toSkel.setAnimation(c.animations[c.currAnim])):c.skeleton.setAnimation(c.animations[c.currAnim]));c.playing=!0}}else console.error(pc.string.format("Trying to play animation '{0}' which doesn't exist",a))},getAnimation:function(a){return this.data.animations[a]},setModel:function(a){var b=this.data;if(a){var c=a.getGraph();b.fromSkel=new pc.anim.Skeleton(c);b.toSkel=new pc.anim.Skeleton(c);b.skeleton=new pc.anim.Skeleton(c);b.skeleton.setLooping(b.loop);
b.skeleton.setGraph(c)}b.model=a;b.animations&&(b.currAnim&&b.animations[b.currAnim])&&this.play(b.currAnim)},loadAnimationAssets:function(a){if(a&&a.length){for(var b={parent:this.entity.getRequest()},c=a.map(function(a){return this.system.context.assets.getAssetById(a)},this),e={},d=[],f=[],k=0,h=c.length;k<h;k++){var l=c[k];l?(l.off("change",this.onAssetChanged,this),l.on("change",this.onAssetChanged,this),l.resource?e[l.name]=l.resource:(d.push(l.name),f.push(new pc.resources.AnimationRequest(l.getFileUrl())))):
logERROR(pc.string.format("Trying to load animation component before assets {0} are loaded",a))}f.length?this.system.context.loader.request(f,b).then(function(a){for(var b=0;b<f.length;b++)e[d[b]]=a[b];this.animations=e}.bind(this)):this.animations=e}},onAssetChanged:function(a,b,c){"resource"===b&&(c?(this.animations[a.name]=c,this.data.currAnim===a.name&&this.data.playing&&(this.data.enabled&&this.entity.enabled)&&this.play(a.name,0)):delete this.animations[a.name])},onSetAnimations:function(){var a=
this.data,b=this.entity.model;b&&(b=b.model)&&this.entity.animation.setModel(b);for(var c in a.animations){a.activate&&(a.enabled&&this.entity.enabled)&&this.play(c,0);break}},onSetAssets:function(a,b,c){if(b&&b.length)for(a=0;a<b.length;a++)if(b[a]){var e=this.system.context.assets.getAssetById(b[a]);e&&e.off("change",this.onAssetChanged,this)}this.loadAnimationAssets(c)},onSetLoop:function(){this.data.skeleton&&this.data.skeleton.setLooping(this.data.loop)},onSetCurrentTime:function(a,b,c){this.data.skeleton.setCurrentTime(c);
this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()},onEnable:function(){d._super.onEnable.call(this);if(this.data.activate&&!this.data.currAnim)for(var a in this.data.animations){this.play(a,0);break}}});Object.defineProperties(d.prototype,{currentTime:{get:function(){return this.data.skeleton.getCurrentTime()},set:function(a){this.data.skeleton.setCurrentTime(a);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()}},duration:{get:function(){return this.data.animations[this.data.currAnim].getDuration()}}});
return{AnimationComponent:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="animation";this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AnimationComponent;this.DataType=pc.fw.AnimationComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"assets",displayName:"Asset",description:"Animation Asset",type:"asset",
options:{max:100,type:"animation"},defaultValue:[]},{name:"speed",displayName:"Speed Factor",description:"Scale the animation playback speed",type:"number",options:{step:0.1},defaultValue:1},{name:"loop",displayName:"Loop",description:"Loop the animation back to the start on completion",type:"boolean",defaultValue:!0},{name:"activate",displayName:"Activate",description:"Play the configured animation on load",type:"boolean",defaultValue:!0},{name:"animations",exposed:!1},{name:"skeleton",exposed:!1,
readOnly:!0},{name:"model",exposed:!1,readOnly:!0},{name:"prevAnim",exposed:!1,readOnly:!0},{name:"currAnim",exposed:!1,readOnly:!0},{name:"fromSkel",exposed:!1,readOnly:!0},{name:"toSkel",exposed:!1,readOnly:!0},{name:"blending",exposed:!1,readOnly:!0},{name:"blendTime",exposed:!1,readOnly:!0},{name:"blendTimeRemaining",exposed:!1,readOnly:!0},{name:"playing",exposed:!1,readOnly:!0}];this.exposeProperties();this.on("remove",this.onRemove,this);this.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["activate","loop","speed","assets","enabled"];d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){this.addComponent(b,{});b.animation.data.assets=pc.extend([],a.animation.assets);b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=a.animation.enabled;
b.animation.animations=pc.extend({},a.animation.animations)},onRemove:function(a,b){delete b.animation;delete b.skeleton;delete b.fromSkel;delete b.toSkel},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var e=b[c],d=e.data;d.enabled&&(d.playing&&e.entity.enabled)&&(e=d.skeleton,null!==e&&null!==d.model&&(d.blending?(d.blendTimeRemaining-=a,0>d.blendTimeRemaining&&(d.blendTimeRemaining=0),e.blend(d.fromSkel,d.toSkel,1-d.blendTimeRemaining/d.blendTime)):(e.addTime(a*d.speed),
e.getCurrentTime()===e.getAnimation().getDuration()&&!d.loop&&(d.playing=!1)),d.blending&&0===d.blendTimeRemaining&&(d.blending=!1,e.setAnimation(d.toSkel.getAnimation())),e.updateGraph()))}}});return{AnimationComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.toSkel=this.fromSkel=this.currAnim=this.prevAnim=this.model=this.skeleton=this.animations=null;this.blending=!1;this.blendTimeRemaining=this.blendTime=0;this.playing=!1},pc.fw.ComponentData);return{AnimationComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="model";this.description="Renders a 3D model at the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.ModelComponent;this.DataType=pc.fw.ModelComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable rendering of the Model",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"Type of model",type:"enumeration",options:{enumerations:[{name:"Asset",value:"asset"},
{name:"Box",value:"box"},{name:"Capsule",value:"capsule"},{name:"Sphere",value:"sphere"},{name:"Cylinder",value:"cylinder"},{name:"Cone",value:"cone"},{name:"Plane",value:"plane"}]},defaultValue:"asset"},{name:"asset",displayName:"Asset",description:"Model Asset to render",type:"asset",options:{max:1,type:"model"},defaultValue:null,filter:{type:"asset"}},{name:"materialAsset",displayName:"Material",description:"The material of the model",type:"asset",options:{max:1,type:"material"},defaultValue:null,
filter:{type:function(){return!1}}},{name:"castShadows",displayName:"Cast shadows",description:"Occlude light",type:"boolean",defaultValue:!1},{name:"receiveShadows",displayName:"Receive shadows",description:"Receive shadows cast from occluders",type:"boolean",defaultValue:!0},{name:"material",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();a=a.graphicsDevice;this.box=pc.scene.procedural.createBox(a,{halfExtents:new pc.Vec3(0.5,0.5,0.5)});this.capsule=pc.scene.procedural.createCapsule(a,
{radius:0.5,height:2});this.sphere=pc.scene.procedural.createSphere(a,{radius:0.5});this.cone=pc.scene.procedural.createCone(a,{baseRadius:0.5,peakRadius:0,height:1});this.cylinder=pc.scene.procedural.createCylinder(a,{radius:0.5,height:1});this.plane=pc.scene.procedural.createPlane(a,{halfExtents:new pc.Vec2(0.5,0.5),widthSegments:1,lengthSegments:1});this.defaultMaterial=new pc.scene.PhongMaterial},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,
b,c){b.material=this.defaultMaterial;c="material materialAsset asset castShadows receiveShadows type enabled".split(" ");d._super.initializeComponentData.call(this,a,b,c)},removeComponent:function(a){var b=a.model.data;a.model.asset=null;"asset"!==b.type&&b.model&&(this.context.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null);d._super.removeComponent.call(this,a)},cloneComponent:function(a,b){this.addComponent(b,{});b.model.data.type=a.model.type;b.model.data.materialAsset=
a.model.materialAsset;b.model.data.asset=a.model.asset;b.model.data.castShadows=a.model.castShadows;b.model.data.receiveShadows=a.model.receiveShadows;b.model.data.material=a.model.material;b.model.data.enabled=a.model.enabled;a.model.model&&(b.model.model=a.model.model.clone())}});return{ModelComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_type",this.onSetType,this);this.on("set_asset",this.onSetAsset,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_model",this.onSetModel,this);this.on("set_receiveShadows",this.onSetReceiveShadows,this);this.on("set_material",this.onSetMaterial,this);Object.defineProperty(this,"materialAsset",{set:this.setMaterialAsset.bind(this),get:this.getMaterialAsset.bind(this)})},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,
{setVisible:function(a){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");this.enabled=a},loadModelAsset:function(a){var b={parent:this.entity.getRequest()},c=this.system.context.assets.getAssetById(a);c?(c.off("change",this.onAssetChange,this),c.on("change",this.onAssetChange,this),c.resource?(a=c.resource.clone(),this._onModelLoaded(a)):this.system.context.assets.load(c,[],b).then(function(a){this._onModelLoaded(a[0])}.bind(this))):logERROR(pc.string.format("Trying to load model before asset {0} is loaded.",
a))},_onModelLoaded:function(a){this.system.context.designer&&a.generateWireframe();"asset"===this.data.type&&(this.model=a)},onSetType:function(a,b,c){a=this.data;if(c)if(b=null,"asset"===c)null!==this.data.asset?this.loadModelAsset(this.data.asset):this.model=null;else{switch(c){case "box":b=this.system.box;break;case "capsule":b=this.system.capsule;break;case "sphere":b=this.system.sphere;break;case "cone":b=this.system.cone;break;case "cylinder":b=this.system.cylinder;break;case "plane":b=this.system.plane;
break;default:throw Error("Invalid model type: "+c);}var c=new pc.scene.GraphNode,e=new pc.scene.Model;e.graph=c;e.meshInstances=[new pc.scene.MeshInstance(c,b,a.material)];this.system.context.designer&&e.generateWireframe();this.model=e;this.asset=null}},onSetAsset:function(a,b,c){b&&(a=this.system.context.assets.getAssetById(b))&&a.off("change",this.onAssetChange,this);"asset"===this.data.type&&(c?c instanceof pc.asset.Asset?(this.data.asset=c.id,this.loadModelAsset(c.id)):this.loadModelAsset(c):
this.model=null)},onSetCastShadows:function(a,b,c){if(a=this.data.model){var b=this.system.context.scene,e=b.containsModel(a);e&&b.removeModel(a);for(var d=a.meshInstances,f=0;f<d.length;f++)d[f].castShadow=c;e&&b.addModel(a)}},onSetModel:function(a,b,c){b&&(this.system.context.scene.removeModel(b),this.entity.removeChild(b.getGraph()),delete b._entity);if(c){for(var a=this.data,b=c.meshInstances,e=0;e<b.length;e++)b[e].castShadow=a.castShadows,b[e].receiveShadow=a.receiveShadows;this.entity.addChild(c.graph);
this.enabled&&this.entity.enabled&&this.system.context.scene.addModel(c);c._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(c)}},setMaterialAsset:function(a){var a="number"===typeof a||!a?a:a.id,b;if(void 0!==a&&null!==a){var c=this.system.context.assets.getAssetById(a);c?c.resource?this.material=b=c.resource:this.system.context.assets.load(c).then(function(a){this.material=a[0]}.bind(this)):console.error(pc.string.format("Entity '{0}' is trying to load Material Asset {1} which no longer exists. Maybe this model was once a primitive shape?",
this.entity.getPath(),a))}b||(b=this.system.defaultMaterial);this.material=b;b=this.data.materialAsset;this.data.materialAsset=a;this.fire("set","materialAsset",b,a)},getMaterialAsset:function(){return this.system.context.assets.getAssetById(this.data.materialAsset)},onSetMaterial:function(a,b,c){if(c!==b&&(this.data.material=c,this.data.model&&"asset"!==this.data.type)){a=this.data.model.meshInstances;for(b=0;b<a.length;b++)a[b].material=c}},onSetReceiveShadows:function(a,b,c){if(void 0!==c&&(a=
this.data,a.model)){a=a.model.meshInstances;for(b=0;b<a.length;b++)a[b].receiveShadow=c}},onEnable:function(){d._super.onEnable.call(this);var a=this.data.model;a&&(this.system.context.scene.containsModel(a)||this.system.context.scene.addModel(a))},onDisable:function(){d._super.onDisable.call(this);var a=this.data.model;a&&this.system.context.scene.containsModel(a)&&this.system.context.scene.removeModel(a)},onAssetChange:function(a,b,c,e){if("resource"===b)c&&this._onModelLoaded(c);else if("data"===
b){b=!1;c=c.mapping;e=e.mapping;if(c&&!e||e&&!c)b=!0;else if(c)if(c&&c.length!==e.length)b=!0;else for(var d=0;d<c.length;d++)if(c[d].material!==e[d].material){b=!0;break}b&&(a.resource=null,this.system.context.loader.removeFromCache(a.getFileUrl()),this.loadModelAsset(a.id))}}});return{ModelComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.type="asset";this.asset=null;this.castShadows=!1;this.receiveShadows=!0;this.model=this.material=this.materialAsset=null},pc.fw.ComponentData);return{ModelComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="skybox";this.description="Renders a skybox in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.fw.SkyboxComponent;this.DataType=pc.fw.SkyboxComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the component",type:"boolean",defaultValue:!0},{name:"posx",displayName:"POSX",description:"URL of the positive X face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},
{name:"negx",displayName:"NEGX",description:"URL of the negative X face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posy",displayName:"POSY",description:"URL of the positive Y face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negy",displayName:"NEGY",description:"URL of the negative Y face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posz",displayName:"POSZ",description:"URL of the positive Z face of skybox cubemap",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negz",displayName:"NEGZ",description:"URL of the negative Z face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"model",exposed:!1,readOnly:!0},{name:"assets",exposed:!1,readOnly:!0},{name:"cubemap",exposed:!1}];this.exposeProperties();this.on("remove",this.onRemove,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="enabled posx negx posy negy posz negz cubemap".split(" ");
d._super.initializeComponentData.call(this,a,b,c)},onRemove:function(a,b){b.model&&(this.context.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null)}});return{SkyboxComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set",this.onSet,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{onSet:function(b,c,e){function d(b,c){if(!(void 0===c||null===c)){var e=a.indexOf(b),f=this.entity.skybox.assets;this.data.model=null;f[e]=this.system.context.assets.getAssetById(c);if(f[e]){if(this.data.assets=f,f[0]&&f[1]&&f[2]&&f[3]&&f[4]&&f[5]){e=this.data;a:{for(var g=this.entity,h=this.system.context,k=h.graphicsDevice,l=[],v=[],A=[],x,E=0;E<f.length;E++)if(x=f[E])if(x.resource){x=
x.resource.getSource();if(!x){logERROR(pc.string.format("Trying to load skybox component with invalid texture types"));f=void 0;break a}l.push(x)}else A.push(E),v.push(new pc.resources.TextureRequest(x.getFileUrl()));else{logERROR(pc.string.format("Trying to load skybox component before assets are loaded"));f=void 0;break a}var D=new pc.Texture(k,{format:pc.PIXELFORMAT_R8_G8_B8,cubemap:!0});D.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;D.magFilter=pc.FILTER_LINEAR;D.addressU=pc.ADDRESS_CLAMP_TO_EDGE;
D.addressV=pc.ADDRESS_CLAMP_TO_EDGE;v.length?(f={parent:g.getRequest()},h.loader.request(v,f).then(function(a){for(var b=0;b<a.length;b++)l[A[b]]=a[b].getSource();D.setSource(l)})):D.setSource(l);v=new pc.scene.Material;v.updateShader=function(){var a=k.getProgramLibrary().getProgram("skybox",{hdr:!1,gamma:h.scene.gammaCorrection,toneMapping:h.scene.toneMapping});this.setShader(a)};v.updateShader();v.setParameter("texture_cubeMap",D);v.cull=pc.CULLFACE_NONE;f=new pc.scene.GraphNode;g=pc.scene.procedural.createBox(k);
v=new pc.scene.MeshInstance(f,g,v);g=new pc.scene.Model;g.graph=f;g.meshInstances=[v];f=g}e.model=f;this.enabled&&this.entity.enabled&&(this.system.context.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))}}else logERROR(pc.string.format("Trying to load skybox component before asset {0} has loaded",c))}}if("cubemap"==b&&e){var b=this.data,f=this.system.context,k=f.graphicsDevice,h=new pc.scene.Material;h.updateShader=function(){var a=k.getProgramLibrary().getProgram("skybox",
{hdr:e.hdr,prefiltered:!0,gamma:f.scene.gammaCorrection,toneMapping:f.scene.toneMapping});this.setShader(a)};h.updateShader();h.setParameter("texture_cubeMap",e);h.cull=pc.CULLFACE_NONE;var c=new pc.scene.GraphNode,l=pc.scene.procedural.createBox(k),h=new pc.scene.MeshInstance(c,l,h),l=new pc.scene.Model;l.graph=c;l.meshInstances=[h];b.model=l;this.enabled&&this.entity.enabled&&(this.system.context.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))}else h={posx:function(a,
b,c,e){d.call(this,b,e)},negx:function(a,b,c,e){d.call(this,b,e)},posy:function(a,b,c,e){d.call(this,b,e)},negy:function(a,b,c,e){d.call(this,b,e)},posz:function(a,b,c,e){d.call(this,b,e)},negz:function(a,b,c,e){d.call(this,b,e)}},h[b]&&h[b].call(this,this.entity,b,c,e)},onEnable:function(){d._super.onEnable.call(this);this.data.model&&!this.system.context.scene.containsModel(this.data.model)&&(this.system.context.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))},onDisable:function(){d._super.onDisable.call(this);
this.data.model&&this.system.context.scene.containsModel(this.data.model)&&(this.entity.removeChild(this.data.model.graph),this.system.context.scene.removeModel(this.data.model))}});var a="posx negx posy negy posz negz".split(" ");return{SkyboxComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.negz=this.posz=this.negy=this.posy=this.negx=this.posx=null;this.assets=[];this.model=null},pc.fw.ComponentData);return{SkyboxComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="camera";this.description="Renders the scene from the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.CameraComponent;this.DataType=pc.fw.CameraComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"clearColorBuffer",displayName:"Clear Color Buffer",description:"Clear color buffer",type:"boolean",defaultValue:!0},{name:"clearColor",
displayName:"Clear Color",description:"Clear Color",type:"rgba",defaultValue:[0.7294117647058823,0.7294117647058823,0.6941176470588235,1],filter:{clearColorBuffer:!0}},{name:"clearDepthBuffer",displayName:"Clear Depth Buffer",description:"Clear depth buffer",type:"boolean",defaultValue:!0},{name:"projection",displayName:"Projection",description:"Projection type of camera",type:"enumeration",options:{enumerations:[{name:"Perspective",value:0},{name:"Orthographic",value:1}]},defaultValue:0},{name:"fov",
displayName:"Field of View",description:"Field of view in Y axis",type:"number",defaultValue:45,options:{min:0,max:90},filter:{projection:0}},{name:"orthoHeight",displayName:"Ortho Height",description:"View window half extent of camera in Y axis",type:"number",defaultValue:100,filter:{projection:1}},{name:"nearClip",displayName:"Near Clip",description:"Near clipping distance",type:"number",defaultValue:0.3,options:{min:1E-4,decimalPrecision:5}},{name:"farClip",displayName:"Far Clip",description:"Far clipping distance",
type:"number",defaultValue:1E3,options:{min:1E-4,decimalPrecision:5}},{name:"priority",displayName:"Priority",description:"Controls which camera will be rendered first. Smaller numbers are rendered first.",type:"number",defaultValue:0},{name:"rect",displayName:"Viewport",description:"Controls where on the screen the camera will be rendered in normalized coordinates.",type:"vector",defaultValue:[0,0,1,1]},{name:"camera",exposed:!1},{name:"aspectRatio",exposed:!1},{name:"model",exposed:!1},{name:"renderTarget",
exposed:!1}];this.exposeProperties();this.cameras=[];this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("toolsUpdate",this.toolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b=b||{};b.clearColor&&"array"===pc.type(b.clearColor)&&(c=b.clearColor,b.clearColor=new pc.Color(c[0],c[1],c[2],c[3]));b.rect&&"array"===pc.type(b.rect)&&(c=b.rect,b.rect=new pc.Vec4(c[0],c[1],c[2],c[3]));b.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),
b.enabled=b.activate);b.camera=new pc.scene.CameraNode;b.postEffects=new pc.posteffect.PostEffectQueue(this.context,a);if(this.context.designer&&this.displayInTools(a.entity)){c=new pc.scene.BasicMaterial;c.color=new pc.Color(1,1,0,1);c.update();var e=new pc.IndexBuffer(this.context.graphicsDevice,pc.INDEXFORMAT_UINT8,24);(new Uint8Array(e.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);e.unlock();var g=new pc.VertexFormat(this.context.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,
components:3,type:pc.ELEMENTTYPE_FLOAT32}]),f=new pc.VertexBuffer(this.context.graphicsDevice,g,8,pc.BUFFER_DYNAMIC),g=new pc.scene.Mesh;g.vertexBuffer=f;g.indexBuffer[0]=e;g.primitive[0].type=pc.PRIMITIVE_LINES;g.primitive[0].base=0;g.primitive[0].count=e.getNumIndices();g.primitive[0].indexed=!0;e=new pc.scene.Model;e.graph=b.camera;e.meshInstances=[new pc.scene.MeshInstance(e.graph,g,c)];this.context.scene.addModel(e);b.model=e}c="postEffects enabled model camera aspectRatio renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer rect".split(" ");
d._super.initializeComponentData.call(this,a,b,c)},onRemove:function(a,b){this.context.designer&&this.displayInTools(a)&&this.context.scene.containsModel(b.model)&&this.context.scene.removeModel(b.model);a.removeChild(b.camera);b.camera=null},toolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].entity;this.displayInTools(c)&&this._updateGfx(c.camera)}},_updateGfx:function(a){if(a.model&&a.model.meshInstances.length){var b=a.model.meshInstances[0].mesh.vertexBuffer,
c=a.camera.getAspectRatio(),e=this.isToolsCamera(a.entity)?0.5:a.nearClip,d=this.isToolsCamera(a.entity)?2:a.farClip,f=a.fov*Math.PI/180,k=a.projection,h;h=k===pc.scene.Projection.PERSPECTIVE?Math.tan(f/2)*e:a.camera.getOrthoHeight();var a=h*c,l=new Float32Array(b.lock());l[0]=a;l[1]=-h;l[2]=-e;l[3]=a;l[4]=h;l[5]=-e;l[6]=-a;l[7]=h;l[8]=-e;l[9]=-a;l[10]=-h;l[11]=-e;k===pc.scene.Projection.PERSPECTIVE&&(h=Math.tan(f/2)*d,a=h*c);l[12]=a;l[13]=-h;l[14]=-d;l[15]=a;l[16]=h;l[17]=-d;l[18]=-a;l[19]=h;l[20]=
-d;l[21]=-a;l[22]=-h;l[23]=-d;b.unlock()}},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority();if(this.context.designer&&(a=a.data.model)){var b=this.context.scene;b.containsModel(a)||b.addModel(a)}},removeCamera:function(a){var b=this.cameras.indexOf(a);0<=b&&(this.cameras.splice(b,1),this.sortCamerasByPriority(),this.context.designer&&(a=a.data.model)&&this.context.scene.removeModel(a))},sortCamerasByPriority:function(){this.cameras.sort(function(a,b){return a.priority-b.priority})},
isToolsCamera:function(a){return a.hasLabel("pc:designer")},displayInTools:function(a){return!this.isToolsCamera(a)||"Perspective"===a.getName()}});return{CameraComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,this);this.on("set_priority",this.onSetPriority,this);this.on("set_clearColorBuffer",
this.updateClearFlags,this);this.on("set_clearDepthBuffer",this.updateClearFlags,this);this.on("set_renderTarget",this.onSetRenderTarget,this);this.on("set_rect",this.onSetRect,this)},d=pc.inherits(d,pc.fw.Component);Object.defineProperty(d.prototype,"activate",{get:function(){console.warn("WARNING: activate: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: activate: Property is deprecated. Set enabled property instead.");this.enabled=
a}});pc.extend(d.prototype,{screenToWorld:function(a,b,c,e){var d=this.system.context.graphicsDevice,f=parseInt(d.canvas.clientWidth),d=parseInt(d.canvas.clientHeight);return this.data.camera.screenToWorld(a,b,c,f,d,e)},onSetAspectRatio:function(a,b,c){this.data.camera.setAspectRatio(c)},onSetCamera:function(a,b,c){b&&this.entity.removeChild(b);this.entity.addChild(c)},onSetClearColor:function(a,b,c){a=this.data.camera.getClearOptions();a.color[0]=c.r;a.color[1]=c.g;a.color[2]=c.b;a.color[3]=c.a},
onSetFov:function(a,b,c){this.data.camera.setFov(c)},onSetOrthoHeight:function(a,b,c){this.data.camera.setOrthoHeight(c)},onSetNearClip:function(a,b,c){this.data.camera.setNearClip(c)},onSetFarClip:function(a,b,c){this.data.camera.setFarClip(c)},onSetProjection:function(a,b,c){this.data.camera.setProjection(c)},onSetPriority:function(){this.system.sortCamerasByPriority()},updateClearFlags:function(){var a=this.data.camera.getClearOptions(),b=0;this.clearColorBuffer&&(b|=pc.CLEARFLAG_COLOR);this.clearDepthBuffer&&
(b|=pc.CLEARFLAG_DEPTH);a.flags=b},onSetRenderTarget:function(a,b,c){this.data.camera.setRenderTarget(c)},onSetRect:function(a,b,c){this.data.camera.setRect(c.data[0],c.data[1],c.data[2],c.data[3]);this._resetAspectRatio()},onEnable:function(){d._super.onEnable.call(this);this.system.addCamera(this);this.postEffects.enable()},onDisable:function(){d._super.onDisable.call(this);this.postEffects.disable();this.system.removeCamera(this)},_resetAspectRatio:function(){var a=this.camera;if(a){var b=this.system.context.graphicsDevice,
c=this.rect,b=b.width*c.z/(b.height*c.w);b!==a.getAspectRatio()&&a.setAspectRatio(b)}},frameBegin:function(){this._resetAspectRatio();this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1}});return{CameraComponent:d}}());pc.extend(pc.fw,function(){CameraComponentData=function(){this.clearColor=new pc.Color(0.729411780834198,0.729411780834198,0.6941176652908325,1);this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=0.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.projection=pc.scene.Projection.PERSPECTIVE;this.priority=0;this.rect=new pc.Vec4(0,0,1,1);this.enabled=!0;this.camera=null;this.aspectRatio=16/9;this.postEffects=this.renderTarget=null;this.isRendering=!1};CameraComponentData=pc.inherits(CameraComponentData,
pc.fw.ComponentData);return{CameraComponentData:CameraComponentData}}());pc.extend(pc.fw,function(){var d=function(a){this.id="cubemap";a.systems.add(this.id,this);this.ComponentType=pc.fw.CubeMapComponent;this.DataType=pc.fw.CubeMapComponentData;this.schema=[{name:"enabled",type:"boolean",defaultValue:!0},{name:"cubemap",exposed:!1},{name:"camera",exposed:!1},{name:"targets",exposed:!1}];this.exposeProperties();pc.fw.ComponentSystem.on("update",this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b){var c=
new pc.Texture(this.context.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8,width:256,height:256,cubemap:!0});c.minFilter=pc.FILTER_LINEAR;c.magFilter=pc.FILTER_LINEAR;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(var e=[],g=0;6>g;g++){var f=new pc.RenderTarget(this.context.graphicsDevice,c,{face:g,depth:!0});e.push(f)}g=new pc.scene.CameraNode;g.setNearClip(0.01);g.setFarClip(1E4);g.setAspectRatio(1);b.cubemap=c;b.targets=e;b.camera=g;d._super.initializeComponentData.call(this,
a,b,["enabled","targets","cubemap","camera"])},onUpdate:function(){var a,b,c,e=this.store;for(a in e)if(e.hasOwnProperty(a)){b=e[a].entity;c=e[a].data;var d;b.model&&(d=b.model.model);if(d){var f=this.context.scene;f.removeModel(d);var k=[{target:[1,0,0],up:[0,-1,0]},{target:[-1,0,0],up:[0,-1,0]},{target:[0,1,0],up:[0,0,1]},{target:[0,-1,0],up:[0,0,-1]},{target:[0,0,1],up:[0,-1,0]},{target:[0,0,-1],up:[0,-1,0]}];b=b.getPosition();for(var h=c.camera,l=0;6>l;l++)h.setRenderTarget(c.targets[l]),h.setPosition(b),
h.lookAt(k[l].target,k[l].up),h.syncHierarchy(),f.render(h,this.context.graphicsDevice);f.addModel(d)}}}});return{CubeMapComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);return{CubeMapComponent:d}}());pc.extend(pc.fw,function(){CubeMapComponentData=function(){this.camera=null;this.nearClip=1;this.farClip=1E5;this.height=this.width=256;this.enabled=!0};CubeMapComponentData=pc.inherits(CubeMapComponentData,pc.fw.ComponentData);return{CubeMapComponentData:CubeMapComponentData}}());pc.extend(pc.fw,function(){var d=function(a){this.id="staticcubemap";a.systems.add(this.id,this);this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the component",type:"boolean",defaultValue:!0},{name:"posx",displayName:"POSX",description:"URL of the positive X face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negx",displayName:"NEGX",description:"URL of the negative X face of cubemap",type:"asset",options:{max:1,type:"texture"},
defaultValue:null},{name:"posy",displayName:"POSY",description:"URL of the positive Y face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negy",displayName:"NEGY",description:"URL of the negative Y face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posz",displayName:"POSZ",description:"URL of the positive Z face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negz",displayName:"NEGZ",description:"URL of the negative Z face of cubemap",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"assets",exposed:!1},{name:"cubemap",exposed:!1}];this.exposeProperties();this.ComponentType=pc.fw.StaticCubeMapComponent;this.DataType=pc.fw.StaticCubeMapComponentData},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="enabled posx negx posy negy posz negz".split(" ");d._super.initializeComponentData.call(this,a,b,c)}});return{StaticCubeMapComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set",this.onSet,this)},pc.fw.Component);pc.extend(d.prototype,{onSet:function(b,c,e){function d(b,c){if(!(void 0===c||null===c)){var e=a.indexOf(b),f=this.assets;this.cubemap=null;if(c&&(f[e]=this.system.context.assets.getAssetById(c),this.assets=f,f[0]&&f[1]&&f[2]&&f[3]&&f[4]&&f[5])){var g=f.map(function(a){return a.getFileUrl()}),f=this.entity,e=this.system.context,m=new pc.Texture(e.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8,
cubemap:!0});m.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;m.magFilter=pc.FILTER_LINEAR;m.addressU=pc.ADDRESS_CLAMP_TO_EDGE;m.addressV=pc.ADDRESS_CLAMP_TO_EDGE;g=g.map(function(a){return new pc.resources.ImageRequest(a)});f={parent:f.getRequest()};e.loader.request(g,f).then(function(a){m.setSource(a)});this.cubemap=m}}}var f={posx:function(a,b,c){d.call(this,a,c)},negx:function(a,b,c){d.call(this,a,c)},posy:function(a,b,c){d.call(this,a,c)},negy:function(a,b,c){d.call(this,a,c)},posz:function(a,b,c){d.call(this,
a,c)},negz:function(a,b,c){d.call(this,a,c)}};f[b]&&f[b].call(this,b,c,e)}});var a="posx negx posy negy posz negz".split(" ");return{StaticCubeMapComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.negz=this.posz=this.negy=this.posy=this.negx=this.posx=null;this.assets=[];this.cubemap=null},pc.fw.ComponentData);return{StaticCubeMapComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="light";this.description="Enables the Entity to emit light.";a.systems.add(this.id,this);this.ComponentType=pc.fw.LightComponent;this.DataType=pc.fw.LightComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the light",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of the light",type:"enumeration",options:{enumerations:[{name:"Directional",value:"directional"},{name:"Point",
value:"point"},{name:"Spot",value:"spot"}]},defaultValue:"directional"},{name:"color",displayName:"Color",description:"Light Color",type:"rgb",defaultValue:[1,1,1]},{name:"intensity",displayName:"Intensity",description:"The intensity of the light",type:"number",defaultValue:1,options:{min:0,max:10,step:0.05}},{name:"castShadows",displayName:"Cast Shadows",description:"Cast shadows from this light",type:"boolean",defaultValue:!1},{name:"shadowDistance",displayName:"Shadow Distance",description:"Camera distance at which shadows are no longer rendered",
type:"number",options:{min:0,decimalPrecision:5},defaultValue:40,filter:{castShadows:!0,type:"directional"}},{name:"shadowResolution",displayName:"Shadow Resolution",description:"Resolution of shadowmap generated by this light",type:"enumeration",options:{enumerations:[{name:"128",value:128},{name:"256",value:256},{name:"512",value:512},{name:"1024",value:1024},{name:"2048",value:2048}]},defaultValue:1024,filter:{castShadows:!0}},{name:"shadowBias",displayName:"Shadow Bias",description:"Tunes the shadows to reduce rendering artifacts",
type:"number",options:{min:0,max:1,decimalPrecision:5,step:0.01},defaultValue:0.05,filter:{castShadows:!0}},{name:"normalOffsetBias",displayName:"Normal Offset Shadow Bias",description:"Tunes the shadows to reduce rendering artifacts",type:"number",options:{min:0,max:1,decimalPrecision:5,step:0.01},defaultValue:0,filter:{castShadows:!0}},{name:"range",displayName:"Range",description:"The distance from the light where its contribution falls to zero",type:"number",defaultValue:10,options:{min:0},filter:{type:["point",
"spot"]}},{name:"falloffMode",displayName:"Falloff mode",description:"Controls the rate at which a light attentuates from its position",type:"enumeration",options:{enumerations:[{name:"Linear",value:pc.scene.LIGHTFALLOFF_LINEAR},{name:"Inverse squared",value:pc.scene.LIGHTFALLOFF_INVERSESQUARED}]},defaultValue:0,filter:{type:["point","spot"]}},{name:"innerConeAngle",displayName:"Inner Cone Angle",description:"Spotlight inner cone angle",type:"number",defaultValue:40,options:{min:0,max:90},filter:{type:"spot"}},
{name:"outerConeAngle",displayName:"Outer Cone Angle",description:"Spotlight outer cone angle",type:"number",defaultValue:45,options:{min:0,max:90},filter:{type:"spot"}},{name:"model",exposed:!1}];this.exposeProperties();this.implementations={};this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("toolsUpdate",this.toolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b.type||(b.type=a.data.type);a.data.type=b.type;b.color&&
"array"===pc.type(b.color)&&(b.color=new pc.Color(b.color[0],b.color[1],b.color[2]));b.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),b.enabled=b.enable);this._createImplementation(b.type).initialize(a,b);c="type model enabled color intensity range falloffMode innerConeAngle outerConeAngle castShadows shadowDistance shadowResolution shadowBias normalOffsetBias".split(" ");d._super.initializeComponentData.call(this,a,b,c)},_createImplementation:function(a){var b=
this.implementations[a];if(!b){switch(a){case "directional":b=new DirectionalLightImplementation(this);break;case "point":b=new PointLightImplementation(this);break;case "spot":b=new SpotLightImplementation(this);break;default:throw Error("Invalid light type: "+a);}this.implementations[a]=b}return b},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},cloneComponent:function(a,b){var c=a.light;this.addComponent(b,{type:c.type,enabled:c.enabled,color:[c.color.r,c.color.g,c.color.b],intensity:c.intensity,
range:c.range,innerConeAngle:c.innerConeAngle,outerConeAngle:c.outerConeAngle,castShadows:c.castShadows,shadowDistance:c.shadowDistance,shadowResolution:c.shadowResolution,falloffMode:c.falloffMode,shadowBias:c.shadowBias,normalOffsetBias:c.normalOffsetBias})},toolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].data,e=this.implementations[c.type];e&&e.toolsUpdate(c)}},changeType:function(a,b,c){this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).initialize(a,
a.data)}});LightComponentImplementation=function(a){this.system=a};LightComponentImplementation.prototype={initialize:function(a,b){var c=this._createLightNode(a,b);this._createDebugShape(a,b,c)},_createLightNode:function(a,b){var c=new pc.scene.LightNode;c.setName(b.type+"light");c.setType(this._getLightType());return c},_getLightType:function(){},_createDebugShape:function(a,b,c){var e=this.system.context,d=new pc.scene.Model;d.graph=c;d.lights=[c];e.designer&&(this.mesh=this._createDebugMesh(),
this.material||(this.material=this._createDebugMaterial()),d.meshInstances=[new pc.scene.MeshInstance(c,this.mesh,this.material)]);e.scene.addModel(d);a.entity.addChild(c);b=b||{};b.model=d},_createDebugMesh:function(){},_createDebugMaterial:function(){},remove:function(a,b){var c=this.system.context;a.removeChild(b.model.graph);c.scene.removeModel(b.model);delete b.model},toolsUpdate:function(){}};DirectionalLightImplementation=function(){};DirectionalLightImplementation=pc.inherits(DirectionalLightImplementation,
LightComponentImplementation);DirectionalLightImplementation.prototype=pc.extend(DirectionalLightImplementation.prototype,{_getLightType:function(){return pc.scene.LIGHTTYPE_DIRECTIONAL},_createDebugMesh:function(){if(this.mesh)return this.mesh;var a=this.system.context,b=new pc.VertexFormat(a.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]);vertexData=[0,0,0,0,-8,0,-0.5,-8,0,0.5,-8,0,0.5,-8,0,0,-10,0,0,-10,0,-0.5,-8,0,0,0,-2,0,-8,-2,-0.25,-8,-2,0.25,-8,-2,
0.25,-8,-2,0,-10,-2,0,-10,-2,-0.25,-8,-2,0,0,2,0,-8,2,-0.25,-8,2,0.25,-8,2,0.25,-8,2,0,-10,2,0,-10,2,-0.25,-8,2];var c=(new pc.Mat4).setFromAxisAngle(pc.Vec3.UP,120),e;for(e=0;24>e;e++){var d=new pc.Vec3(vertexData[3*(e+8)],vertexData[3*(e+8)+1],vertexData[3*(e+8)+2]),d=c.transformPoint(d,d);vertexData[3*(e+24)]=d[0];vertexData[3*(e+24)+1]=d[1];vertexData[3*(e+24)+2]=d[2]}a=new pc.VertexBuffer(a.graphicsDevice,b,32);b=new Float32Array(a.lock());for(e=0;e<vertexData.length;e++)b[e]=vertexData[e];a.unlock();
e=new pc.scene.Mesh;e.vertexBuffer=a;e.indexBuffer[0]=null;e.primitive[0].type=pc.PRIMITIVE_LINES;e.primitive[0].base=0;e.primitive[0].count=a.getNumVertices();e.primitive[0].indexed=!1;return e},_createDebugMaterial:function(){var a=new pc.scene.BasicMaterial;a.color=new pc.Color(1,1,0,1);a.update();return a}});PointLightImplementation=function(){};PointLightImplementation=pc.inherits(PointLightImplementation,LightComponentImplementation);PointLightImplementation.prototype=pc.extend(PointLightImplementation.prototype,
{_getLightType:function(){return pc.scene.LIGHTTYPE_POINT},_createDebugMesh:function(){return this.mesh?this.mesh:pc.scene.procedural.createSphere(this.system.context.graphicsDevice,{radius:0.1})},_createDebugMaterial:function(){var a=new pc.scene.BasicMaterial;a.color=new pc.Color(1,1,0,1);a.update();return a}});SpotLightImplementation=function(){};SpotLightImplementation=pc.inherits(SpotLightImplementation,LightComponentImplementation);SpotLightImplementation.prototype=pc.extend(SpotLightImplementation.prototype,
{_getLightType:function(){return pc.scene.LIGHTTYPE_SPOT},_createDebugMesh:function(){var a=this.system.context,b=this.indexBuffer;if(!b){var b=new pc.IndexBuffer(a.graphicsDevice,pc.INDEXFORMAT_UINT8,88),c=new Uint8Array(b.lock());c[0]=0;c[1]=1;c[2]=0;c[3]=11;c[4]=0;c[5]=21;c[6]=0;c[7]=31;for(var e=0;40>e;e++)c[2*e+8]=e+1,c[2*e+9]=e+2;b.unlock();this.indexBuffer=b}c=new pc.VertexFormat(a.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]);a=new pc.VertexBuffer(a.graphicsDevice,
c,42,pc.BUFFER_DYNAMIC);c=new pc.scene.Mesh;c.vertexBuffer=a;c.indexBuffer[0]=b;c.primitive[0].type=pc.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=b.getNumIndices();c.primitive[0].indexed=!0;return c},_createDebugMaterial:function(){return new pc.scene.BasicMaterial},toolsUpdate:function(a){var b=a.model.meshInstances[0].mesh.vertexBuffer,c=Math.PI*a.outerConeAngle/180,e=a.range,a=-e*Math.cos(c),c=e*Math.sin(c),e=new Float32Array(b.lock());e[0]=0;e[1]=0;e[2]=0;for(var d=b.getNumVertices(),
f=0;f<d-1;f++){var k=2*Math.PI*(f/(d-2)),h=c*Math.cos(k),k=c*Math.sin(k);e[3*(f+1)+0]=h;e[3*(f+1)+1]=a;e[3*(f+1)+2]=k}b.unlock()}});return{LightComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_type",this.onSetType,this);this.on("set_color",this.onSetColor,this);this.on("set_intensity",this.onSetIntensity,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_shadowDistance",this.onSetShadowDistance,this);this.on("set_shadowResolution",this.onSetShadowResolution,this);this.on("set_shadowBias",this.onSetShadowBias,this);this.on("set_normalOffsetBias",this.onSetNormalOffsetBias,this);this.on("set_range",this.onSetRange,
this);this.on("set_innerConeAngle",this.onSetInnerConeAngle,this);this.on("set_outerConeAngle",this.onSetOuterConeAngle,this);this.on("set_falloffMode",this.onSetFalloffMode,this)},d=pc.inherits(d,pc.fw.Component);Object.defineProperty(d.prototype,"enable",{get:function(){console.warn("WARNING: enable: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");this.enabled=a}});
pc.extend(d.prototype,{onSetType:function(a,b,c){b!==c&&(this.system.changeType(this,b,c),this.refreshProperties())},refreshProperties:function(){this.onSetCastShadows("castShadows",this.castShadows,this.castShadows);this.onSetColor("color",this.color,this.color);this.onSetIntensity("intensity",this.intensity,this.intensity);this.onSetShadowDistance("shadowDistance",this.shadowDistance,this.shadowDistance);this.onSetShadowResolution("shadowResolution",this.shadowResolution,this.shadowResolution);
this.onSetShadowBias("shadowBias",this.shadowBias,this.shadowBias);this.onSetNormalOffsetBias("normalOffsetBias",this.normalOffsetBias,this.normalOffsetBias);this.onSetRange("range",this.range,this.range);this.onSetInnerConeAngle("innerConeAngle",this.innerConeAngle,this.innerConeAngle);this.onSetOuterConeAngle("outerConeAngle",this.outerConeAngle,this.outerConeAngle);this.onSetFalloffMode("falloffMode",this.falloffMode,this.falloffMode);if(this.enabled&&this.entity.enabled)this.onEnable()},onSetCastShadows:function(a,
b,c){this.data.model.lights[0].setCastShadows(c)},onSetColor:function(a,b,c){this.data.model.lights[0].setColor(c)},onSetIntensity:function(a,b,c){this.data.model.lights[0].setIntensity(c)},onSetShadowDistance:function(a,b,c){"directional"===this.data.type&&this.data.model.lights[0].setShadowDistance(c)},onSetShadowResolution:function(a,b,c){this.data.model.lights[0].setShadowResolution(c)},onSetShadowBias:function(a,b,c){this.data.model.lights[0].setShadowBias(-0.01*c)},onSetNormalOffsetBias:function(a,
b,c){this.data.model.lights[0].setNormalOffsetBias(c)},onSetRange:function(a,b,c){("point"===this.data.type||"spot"===this.data.type)&&this.data.model.lights[0].setAttenuationEnd(c)},onSetInnerConeAngle:function(a,b,c){"spot"===this.data.type&&this.data.model.lights[0].setInnerConeAngle(c)},onSetOuterConeAngle:function(a,b,c){"spot"===this.data.type&&this.data.model.lights[0].setOuterConeAngle(c)},onSetFalloffMode:function(a,b,c){("point"===this.data.type||"spot"===this.data.type)&&this.data.model.lights[0].setFalloffMode(c)},
onEnable:function(){d._super.onEnable.call(this);var a=this.data.model;a.lights[0].setEnabled(!0);var b=this.system.context.scene;b.containsModel(a)||b.addModel(a)},onDisable:function(){d._super.onDisable.call(this);var a=this.data.model;a.lights[0].setEnabled(!1);this.system.context.scene.removeModel(a)}});return{LightComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.type="directional";this.enabled=!0;this.color=new pc.Color(1,1,1);this.intensity=1;this.castShadows=!1;this.shadowDistance=40;this.shadowResolution=1024;this.shadowBias=0.05;this.normalOffsetBias=0;this.range=10;this.innerConeAngle=40;this.outerConeAngle=45;this.falloffMode=pc.scene.LIGHTFALLOFF_LINEAR;this.model=null},pc.fw.ComponentData);return{LightComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="script";this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.";a.systems.add(this.id,this);this.ComponentType=pc.fw.ScriptComponent;this.DataType=pc.fw.ScriptComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled components are not updated",type:"boolean",defaultValue:!0},{name:"scripts",displayName:"URLs",description:"Attach scripts to this Entity",type:"script",defaultValue:[]},
{name:"instances",exposed:!1},{name:"runInTools",description:"Allows scripts to be loaded and executed while in the tools",defaultValue:!1,exposed:!1}];this.exposeProperties();this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("beforeremove",this.onBeforeRemove,this);pc.fw.ComponentSystem.on("initialize",this.onInitialize,this);pc.fw.ComponentSystem.on("postInitialize",this.onPostInitialize,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this);pc.fw.ComponentSystem.on("fixedUpdate",this.onFixedUpdate,this);pc.fw.ComponentSystem.on("postUpdate",this.onPostUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["runInTools","enabled","scripts"];d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){var c=this.dataStore[a.getGuid()],c={runInTools:c.data.runInTools,scripts:pc.extend([],
c.data.scripts),enabled:c.data.enabled};return this.addComponent(b,c)},onBeforeRemove:function(a,b){b.enabled&&this._disableScriptComponent(b);this._destroyScriptComponent(b)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&a.script.enabled&&this._postInitializeScriptComponent(a.script);
var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onPostInitialize(a[b])}},_callInstancesMethod:function(a,b){var c=a.data.instances,e;for(e in c)if(c.hasOwnProperty(e)){var d=c[e].instance;d[b]&&d[b].call(d)}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,"onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,
"onDisable")},_destroyScriptComponent:function(a){var b,c=a.data.instances,e;for(e in c)if(c.hasOwnProperty(e)){var d=c[e].instance;d.destroy&&d.destroy();d.update&&(b=this.instancesWithUpdate.indexOf(d),0<=b&&this.instancesWithUpdate.splice(b,1));d.fixedUpdate&&(b=this.instancesWithFixedUpdate.indexOf(d),0<=b&&this.instancesWithFixedUpdate.splice(b,1));d.postUpdate&&(b=this.instancesWithPostUpdate.indexOf(d),0<=b&&this.instancesWithPostUpdate.splice(b,1));d.toolsUpdate&&(b=this.instancesWithToolsUpdate.indexOf(d),
0<=b&&this.instancesWithToolsUpdate.splice(b,1));a.instances[e].instance===a[e]&&delete a[e];delete a.instances[e]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,b,c){for(var e,d=0,f=b.length;d<f;d++)(e=b[d])&&(e.entity.script.enabled&&e.entity.enabled)&&e[a].call(e,c)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",
this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,b){console.warn("DEPRECATED: ScriptComponentSystem.broadcast() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var c=pc.makeArray(arguments).slice(2),e,d,f,k=this.store;for(e in k)k.hasOwnProperty(e)&&
(d=k[e].data,d.instances[a]&&(f=d.instances[a].instance[b])&&f.apply(d.instances[a].instance,c))},_preRegisterInstance:function(a,b,c,e){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[c])throw Error(pc.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}",c,b,a.script.data._instances[c].url,a.getGuid()));a.script.data._instances[c]={url:b,name:c,instance:e}}},_registerInstances:function(a){var b,c,e;if(a.script&&a.script.data._instances){a.script.instances=
a.script.data._instances;for(e in a.script.instances){b=a.script.instances[e];c=b.instance;pc.events.attach(c);c.update&&this.instancesWithUpdate.push(c);c.fixedUpdate&&this.instancesWithFixedUpdate.push(c);c.postUpdate&&this.instancesWithPostUpdate.push(c);c.toolsUpdate&&this.instancesWithToolsUpdate.push(c);a.script.scripts&&this._createAccessors(a,b);if(a.script[e])throw Error(pc.string.format("Script with name '{0}' is already attached to Script Component",e));a.script[e]=c}delete a.script.data._instances}a=
a.getChildren();c=a.length;for(b=0;b<c;b++)a[b]instanceof pc.fw.Entity&&this._registerInstances(a[b])},_createAccessors:function(a,b){var c=this,e,d=a.script.scripts.length,f=b.url;for(e=0;e<d;e++){var k=a.script.scripts[e];if(k.url===f){e=k.attributes;k.name&&e&&(e.forEach(function(a){c._createAccessor(a,b)}),a.script.data.attributes[k.name]=pc.extend([],e));break}}},_createAccessor:function(a,b){var c=this;c._convertAttributeValue(a);Object.defineProperty(b.instance,a.name,{get:function(){return a.value},
set:function(e){var d=a.value;a.value=e;c._convertAttributeValue(a);b.instance.fire("set",a.name,d,a.value)},configurable:!0})},_updateAccessors:function(a,b){var c=this,e,d,f;f=a.script.scripts.length;var k=b.url,h,l,n,r;for(e=0;e<f;e++)if(h=a.script,d=h.scripts[e],d.url===k){e=d.name;k=d.attributes;if(e){k&&k.forEach(function(a){c._createAccessor(a,b)});if(l=h.data.attributes[e])for(d=l.length;d--;){n=l[d];r=null;for(f=k.length;f--;)if(n.name===k[f].name){r=k[f];break}if(r){if(n.value!==r.value&&
b.instance.onAttributeChanged)b.instance.onAttributeChanged(n.name,n.value,r.value)}else delete b.instance[n.name]}k?h.data.attributes[e]=pc.extend([],k):delete h.data.attributes[e]}break}},_convertAttributeValue:function(a){"rgb"===a.type||"rgba"===a.type?"array"===pc.type(a.value)&&(a.value=3===a.value.length?new pc.Color(a.value[0],a.value[1],a.value[2]):new pc.Color(a.value[0],a.value[1],a.value[2],a.value[3])):"vector"===a.type&&"array"===pc.type(a.value)&&(a.value=new pc.Vec3(a.value[0],a.value[1],
a.value[2]))}});return{ScriptComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_scripts",this.onSetScripts,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{send:function(a,b){console.warn("DEPRECATED: ScriptComponent.send() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var c=pc.makeArray(arguments).slice(2),e=this.entity.script.instances,d;if(e&&e[a]&&(d=e[a].instance[b]))return d.apply(e[a].instance,c)},onEnable:function(){d._super.onEnable.call(this);
this.data.areScriptsLoaded&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){d._super.onDisable.call(this);this.system._disableScriptComponent(this)},onSetScripts:function(a,b,c){if((!this.system._inTools||this.runInTools)&&!this._updateScriptAttributes(b,c))this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),
this.data.areScriptsLoaded=!1,a=c.map(function(a){return a.url}),this._loadFromCache(a)||this._loadScripts(a)},_updateScriptAttributes:function(a,b){var c=!0;if(a.length!==b.length)c=!1;else{var e;len=b.length;for(e=0;e<len;e++)if(a[e].url!==b[e].url){c=!1;break}}if(c)for(var d in this.instances)this.instances.hasOwnProperty(d)&&this.system._updateAccessors(this.entity,this.instances[d]);return c},_loadFromCache:function(a){for(var b=[],c=0,e=a.length;c<e;c++){var d=this.system.context.loader.getFromCache(a[c]);
if(d)b.push(d);else return!1}c=0;for(e=b.length;c<e;c++)if(d=b[c],!0!=d&&d&&this.entity.script&&!this.entity.script.instances[d._pcScriptName]){var f=new d(this.entity);this.system._preRegisterInstance(this.entity,a[c],d._pcScriptName,f)}this.data&&(this.data.areScriptsLoaded=!0);this.system.onInitialize(this.entity);this.system.onPostInitialize(this.entity);return!0},_loadScripts:function(a){var b=a.map(function(a){return new pc.resources.ScriptRequest(a)}),c={parent:this.entity.getRequest()};this.system.context.loader.request(b,
c).then(function(b){b.forEach(function(b,c){if(b&&this.entity.script&&!this.entity.script.instances[b._pcScriptName]){var e=new b(this.entity);this.system._preRegisterInstance(this.entity,a[c],b._pcScriptName,e)}},this);this.data&&(this.data.areScriptsLoaded=!0);c.parent||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity))}.bind(this)).then(null,function(a){setTimeout(function(){throw a;})})}});return{ScriptComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1},pc.fw.ComponentData);return{ScriptComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="pack";a.systems.add(this.id,this);this.ComponentType=pc.fw.PackComponent;this.DataType=pc.fw.PackComponentData;this.schema=[]},d=pc.inherits(d,pc.fw.ComponentSystem);return{PackComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);return{PackComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.ComponentData);return{PackComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="pick";a.systems.add(this.id,this);this.ComponentType=pc.fw.PickComponent;this.DataType=pc.fw.PickComponentData;this.schema=[{name:"layer",exposed:!1},{name:"shapes",exposed:!1},{name:"material",exposed:!1}];this.layers={"default":[]};this.display=!1;this.on("remove",this.onRemove,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b.material=new pc.scene.PhongMaterial;c=["material"];d._super.initializeComponentData.call(this,
a,b,c)},onRemove:function(a,b){this.deleteShapes(b.layer,b.shapes)},addShape:function(a,b){void 0===this.layers[a]&&(this.layers[a]=[]);this.layers[a].push(b.model);this.display&&this.context.scene.addModel(b.model)},deleteShapes:function(a,b){for(var c=this.layers[a],e=0;e<b.length;e++){var d=b[e].model,f=c.indexOf(d);-1!==f&&c.splice(f,1);this.display&&this.context.scene.removeModel(d)}},getLayerModels:function(a){return this.layers[a]}});return{PickComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);pc.extend(d.prototype,{addShape:function(a,b){var c=this.data.material,e=null;switch(a.type){case pc.shape.Type.BOX:e=pc.scene.procedural.createBox(this.system.context.graphicsDevice,{halfExtents:a.halfExtents});break;case pc.shape.Type.SPHERE:e=pc.scene.procedural.createSphere(this.system.context.graphicsDevice,{radius:a.radius});break;case pc.shape.Type.TORUS:e=pc.scene.procedural.createTorus(this.system.context.graphicsDevice,
{tubeRadius:a.iradius,ringRadius:a.oradius})}var d=new pc.scene.GraphNode,c=new pc.scene.MeshInstance(d,e,c);c._entity=this.entity;e=new pc.scene.Model;e.graph=d;e.meshInstances=[c];a={shape:a,shapeName:b,model:e};this.data.shapes.push(a);this.system.addShape(this.data.layer,a)},deleteShapes:function(){this.system.deleteShapes(this.data.layer,this.data.shapes);this.data.shapes=[]}});return{PickComponent:d}}());pc.extend(pc.fw,function(){function d(){this.layer="default";this.shapes=[];this.material=null}d=pc.inherits(d,pc.fw.ComponentData);return{PickComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.id="audiosource";this.description="Specifies audio assets that can be played at the position of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AudioSourceComponent;this.DataType=pc.fw.AudioSourceComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled audiosource components do not play any sounds",type:"boolean",defaultValue:!0},{name:"assets",displayName:"Assets",description:"Audio assets",type:"asset",
options:{max:100,type:"audio"},defaultValue:[]},{name:"volume",displayName:"Volume",description:"The sound volume",type:"number",options:{max:1,min:0,step:0.1},defaultValue:1},{name:"pitch",displayName:"Pitch",description:"The sound pitch",type:"number",defaultValue:1,options:{min:0.01,step:0.01}},{name:"loop",displayName:"Loop",description:"Set whether sound loops or not",type:"boolean",defaultValue:!1},{name:"activate",displayName:"Activate",description:"Play first audio sample when scene loads",
type:"boolean",defaultValue:!0},{name:"3d",displayName:"3d",description:"3d sounds are positioned in space, and their sound is dependent on listener position/orientation. Non-3d sounds are uniform across space",type:"boolean",defaultValue:!0},{name:"minDistance",displayName:"Min Distance",description:"Distance from listener under which the sound is at full volume",type:"number",defaultValue:1,options:{min:0}},{name:"maxDistance",displayName:"Max Distance",description:"Distance from listener over which the sound cannot be heard",
type:"number",defaultValue:1E4,options:{min:0}},{name:"rollOffFactor",displayName:"Roll-off factor",description:"Strength of the roll off",type:"number",defaultValue:1,options:{min:0}},{name:"sources",exposed:!1,readOnly:!0},{name:"currentSource",exposed:!1,readOnly:!0},{name:"channel",exposed:!1,readOnly:!0}];this.exposeProperties();this.manager=b;this.initialized=!1;pc.fw.ComponentSystem.on("initialize",this.onInitialize,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this)},d=pc.inherits(d,
pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="activate volume pitch loop 3d minDistance maxDistance rollOffFactor enabled assets".split(" ");d._super.initializeComponentData.call(this,a,b,c);a.paused=!(a.enabled&&a.activate)},onInitialize:function(a){a.audiosource&&(a.enabled&&a.audiosource.enabled&&a.audiosource.activate)&&a.audiosource.play(a.audiosource.currentSource);var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onInitialize(a[b]);
this.initialized=!0},onUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b],e=c.entity,c=c.data;c.enabled&&(e.enabled&&c.channel instanceof pc.audio.Channel3d)&&(e=e.getPosition(),c.channel.setPosition(e))}},setVolume:function(a){this.manager.setVolume(a)}});return{AudioSourceComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&
this.stop();var b,c=this.data;c.sources[a]&&(c.sources[a].isLoaded?(c["3d"]?(b=this.entity.getPosition(),b=this.system.manager.playSound3d(c.sources[a],b,c)):b=this.system.manager.playSound(c.sources[a],c),c.currentSource=a,c.channel=b):logWARNING(pc.string.format("Audio asset '{0}' is not loaded (probably an unsupported format) and will not be played",a)))}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&
(this.channel.stop(),this.channel=null)},onSetAssets:function(a,b,c){var a=[],e,d=c.length;if(b&&b.length)for(e=0;e<b.length;e++)if(b[e]){var f=this.system.context.assets.getAssetById(b[e]);f&&f.off("change",this.onAssetChanged,this)}if(d)for(e=0;e<d;e++)0>b.indexOf(c[e])&&a.push(c[e]);!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},onAssetChanged:function(a,b,c){"resource"===b&&this.data.sources&&(this.data.sources[a.name]=c,this.data.currentSource===a.name&&this.channel&&(this.channel.paused?
(this.play(a.name),this.pause()):this.play(a.name)))},onSetLoop:function(a,b,c){b!=c&&this.channel&&this.channel.setLoop(c)},onSetVolume:function(a,b,c){b!=c&&this.channel&&this.channel.setVolume(c)},onSetPitch:function(a,b,c){b!=c&&this.channel&&this.channel.setPitch(c)},onSetMaxDistance:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&this.channel.setMaxDistance(c)},onSetMinDistance:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&this.channel.setMinDistance(c)},
onSetRollOffFactor:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&this.channel.setRollOffFactor(c)},onEnable:function(){d._super.onEnable.call(this);this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){d._super.onDisable.call(this);this.pause()},loadAudioSourceAssets:function(a){var b={parent:this.entity.getRequest()},c=[],e=[],d={},f=null;a.map(function(a){return this.system.context.assets.getAssetById(a)},
this).forEach(function(b){b?(f=f||b.name,b.off("change",this.onAssetChanged,this),b.on("change",this.onAssetChanged,this),b.resource?d[b.name]=b.resource:(c.push(new pc.resources.AudioRequest(b.getFileUrl())),e.push(b.name))):logERROR(pc.string.format("Trying to load audiosource component before assets {0} are loaded",a))}.bind(this));if(c.length)this.system.context.loader.request(c,b).then(function(a){for(var h=0;h<c.length;h++)d[e[h]]=a[h];this.data.sources=d;this.data.currentSource=f;if(!b.parent&&
this.enabled&&this.activate&&f)this.onEnable()}.bind(this));else if(this.data.sources=d,this.data.currentSource=f,this.enabled&&this.activate&&f)this.onEnable()}});return{AudioSourceComponent:d}}());pc.fw.AudioSourceComponentData=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.paused=!0;this.sources={};this.channel=this.currentSource=null};pc.extend(pc.fw,function(){var d=function(a,b){this.id="audiolistener";this.description="Specifies the location of the listener for 3D audio playback.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AudioListenerComponent;this.DataType=pc.fw.AudioListenerComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled audio listener components do not affect audiosources",type:"boolean",defaultValue:!0}];this.exposeProperties();this.manager=b;this.current=null;pc.fw.ComponentSystem.on("update",
this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["enabled"];d._super.initializeComponentData.call(this,a,b,c)},onUpdate:function(){if(this.current){var a=this.current.getPosition();this.manager.listener.setPosition(a);a=this.current.getWorldTransform();this.manager.listener.setOrientation(a)}}});return{AudioListenerComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},onEnable:function(){d._super.onEnable.call(this);this.setCurrentListener()},onDisable:function(){d._super.onDisable.call(this);this.system.current===this.entity&&(this.system.current=null)}});
return{AudioListenerComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0},pc.fw.ComponentData);return{AudioListenerComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){a.systems.add("designer",this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype.createComponent=function(a,b){var c=new pc.fw.DesignerComponentData;this.initializeComponent(a,c,b,["fillWindow","width","height"]);return c};return{DesignerComponentSystem:d}}());pc.extend(pc.fw,function(){DesignerComponentData=function(){this.fillWindow=!0;this.width=800;this.height=450};DesignerComponentData=pc.inherits(DesignerComponentData,pc.fw.ComponentData);return{DesignerComponentData:DesignerComponentData}}());pc.extend(pc.fw,function(){var d=new pc.Vec3,a=new pc.Vec3,b,c,e,g,f,k=function(a){void 0!==Box2D&&!c&&(c=Box2D.Dynamics.b2World,e=Box2D.Common.Math.b2Vec2,g=Box2D.Dynamics.b2Body,f=Box2D.Dynamics.b2BodyDef,b=new e);this.id="body2d";a.systems.add(this.id,this);this.ComponentType=pc.fw.Body2dComponent;this.DataType=pc.fw.Body2dComponentData;this.schema=[{name:"static",displayName:"Static",description:"Static bodies are immovable and do not collide with other static bodies.",type:"boolean",defaultValue:!0},
{name:"body",exposed:!1,readOnly:!0},{name:"bodyDef",exposed:!1,readOnly:!0}];this.exposeProperties();this._rayStart=new pc.Vec3;this._rayEnd=new pc.Vec3;this.time=0;this.step=1/60;this.xi=0;this.yi=2;this.ri=1;c&&(this.b2World=new c(new e(0,0),!0),pc.fw.ComponentSystem.on("update",this.onUpdate,this));this.on("remove",this.onRemove,this)},k=pc.inherits(k,pc.fw.ComponentSystem);pc.extend(k.prototype,{initializeComponentData:function(a,b,c){c=["static"];k._super.initializeComponentData.call(this,a,
b,c);void 0!==Box2D&&this.createBody(a)},createBody:function(b){if(b.entity.collisionrect||b.entity.collisioncircle){var c=new f;d.copy(b.entity.getPosition());a.copy(b.entity.getEulerAngles());c.type=b.static?g.b2_staticBody:g.b2_dynamicBody;c.position.Set(d.data[this.xi],d.data[this.yi]);var e=b._eulersToAngle(a);c.angle=-e*pc.math.DEG_TO_RAD;c.userData=b.entity;b.data.bodyDef=c}b.data.body&&this.removeBody(b.entity,b.data.body);b.data.body=b.entity.collisionrect?this.addBody(b.bodyDef,b.entity.collisionrect.fixtureDef):
b.entity.collisioncircle?this.addBody(b.bodyDef,b.entity.collisioncircle.fixtureDef):null},onRemove:function(a,b){b.body&&this.removeBody(a,b.body);b.body=null},to2d:function(a,b){b=b||new e;return b.Set(a[this.xi],a[this.yi])},addBody:function(a,b){var c=this.b2World.CreateBody(a);c.CreateFixture(b);return c},removeBody:function(a,b){this.b2World.DestroyBody(b);a.body2d.body&&(a.body2d.data.body=null)},setGravity:function(a,c){b.Set(a,c);this.b2World.SetGravity(b)},raycast:function(a,b,c){var d=
new e,f=new e;this.to2d(b,d);this.to2d(c,f);this._rayStart.vec3.copy(b);this._rayEnd.vec3.copy(c);this.b2World.RayCast(a,d,f)},raycastFirst:function(a,b,c){var e,d=1;this.raycast(function(a,b,f,g){a=a.GetUserData();a!==c&&g<d&&(e=a,d=g);return 1},a,b);return e},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var e=b[c].entity,d=b[c].data;d.body&&!d.static&&e.body2d.updateTransform(d.body)}for(this.time+=a;this.time>this.step;)this.b2World.Step(this.step,6,2),this.time-=
this.step}});return{Body2dComponentSystem:k}}());pc.extend(pc.fw,function(){new pc.Mat4;var d=new pc.Vec3,a=new pc.Vec3,b=function(a,b){this.on("set_static",this.onSetStatic,this);b.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this)},b=pc.inherits(b,pc.fw.Component);pc.extend(b.prototype,{applyForce:function(a,b){var g=this.entity.body2d.body;g&&(b||(b=d,b[this.system.xi]=g.GetPosition().x,b[this.system.yi]=g.GetPosition().y),g.ApplyForce({x:a[this.system.xi],y:a[this.system.yi]},{x:b[this.system.xi],y:b[this.system.yi]}))},applyImpulse:function(a,
b){var g=this.entity.body2d.body;g&&(b||(b=d,b[this.system.xi]=g.GetPosition().x,b[this.system.yi]=g.GetPosition().y),g.ApplyImpulse({x:a[this.system.xi],y:a[this.system.yi]},{x:b[this.system.xi],y:b[this.system.yi]}))},setLinearVelocity:function(a,b){var d=this.entity.body2d.body;if(d){var f=d.GetLinearVelocity();f.x=a;f.y=b;d.SetLinearVelocity(f)}},setAngularVelocity:function(a){var b=this.entity.body2d.body;b&&b.SetAngularVelocity(a)},setTransform:function(b){b.getTranslation(d);b.getEulerAngles(a);
b=this._eulersToAngle(a);this.setPositionAndAngle(d.data[this.system.xi],d.data[this.system.yi],-b)},setPosition:function(a,b){var d=this.entity.body2d.body;if(d){d.SetAwake(!0);var f=d.GetPosition();f.x=a;f.y=b;d.SetPosition(f);this.updateTransform(d)}},setAngle:function(a){var b=this.entity.body2d.body;b&&(b.SetAwake(!0),b.SetAngle(a*pc.math.DEG_TO_RAD),this.updateTransform(b))},setPositionAndAngle:function(a,b,d){var f=this.entity.body2d.body;if(f){f.SetAwake(!0);var k=f.GetPosition();k.x=a;k.y=
b;f.SetPositionAndAngle(k,d*pc.math.DEG_TO_RAD);this.updateTransform(f)}},getAngle:function(){return this.entity.body2d.body.GetAngle()*pc.math.RAD_TO_DEG},setLinearDamping:function(a,b){var d=this.entity.body2d.body;d&&d.SetLinearDamping(b)},updateTransform:function(b){var e=this.entity.getPosition();this.entity.getLocalEulerAngles();var g=b.GetPosition();d.data[this.system.xi]=g.x;d.data[this.system.ri]=e.y;d.data[this.system.yi]=g.y;a.data[this.system.xi]=0;a.data[this.system.ri]=-b.GetAngle()*
pc.math.RAD_TO_DEG;a.data[this.system.yi]=0;this.entity.setPosition(d);this.entity.setEulerAngles(a)},onSetStatic:function(a,b,d){(a=this.entity.body2d.body)&&(d?a.SetType((void 0).b2_staticBody):a.SetType((void 0).b2_dynamicBody))},onLiveLinkUpdateTransform:function(){this.setTransform(this.entity.getWorldTransform());this.setLinearVelocity(0,0);this.setAngularVelocity(0)},_eulersToAngle:function(a){var b=a[this.system.ri];179.9<a[this.system.xi]&&179.9<a[this.system.yi]&&(b=180-a[this.system.ri]);
return b}});return{Body2dComponent:b}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.static=!0;this.shape=pc.shape.Type.RECT;this.body=this.bodyDef=null},pc.fw.ComponentData);return{Body2dComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b,c=function(c){void 0!==Box2D&&!d&&(d=Box2D.Dynamics.b2World,a=Box2D.Dynamics.b2FixtureDef,b=Box2D.Collision.Shapes.b2PolygonShape);this.id="collisionrect";c.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionRectComponent;this.DataType=pc.fw.CollisionRectComponentData;this.schema=[{name:"density",displayName:"Density",description:"The density of the body, this determine the mass",type:"number",options:{min:0,step:0.01},defaultValue:1},{name:"friction",
displayName:"Friction",description:"The friction when the body slides along another body",type:"number",options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object doesn't bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"x",displayName:"Size: X",description:"The size of the Rect in the x-axis",type:"number",options:{min:0,
step:0.1},defaultValue:0.5},{name:"y",displayName:"Size: Y",description:"The size of the Rect in the y-axis",type:"number",options:{min:0,step:0.1},defaultValue:0.5},{name:"model",expose:!1}];this.exposeProperties();var c=c.graphicsDevice,g=new pc.VertexFormat(c,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),g=new pc.VertexBuffer(c,g,4);(new Float32Array(g.lock())).set([-0.5,0,-0.5,-0.5,0,0.5,0.5,0,0.5,0.5,0,-0.5]);g.unlock();c=new pc.IndexBuffer(c,pc.INDEXFORMAT_UINT8,
8);(new Uint8Array(c.lock())).set([0,1,1,2,2,3,3,0]);c.unlock();this.mesh=new pc.scene.Mesh;this.mesh.vertexBuffer=g;this.mesh.indexBuffer[0]=c;this.mesh.primitive[0].type=pc.PRIMITIVE_LINES;this.mesh.primitive[0].base=0;this.mesh.primitive[0].count=c.getNumIndices();this.mesh.primitive[0].indexed=!0;this.material=new pc.scene.BasicMaterial;this.material.color=new pc.Color(0,0,1,1);this.material.update();this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,
this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},c=pc.inherits(c,pc.fw.ComponentSystem);c.prototype=pc.extend(c.prototype,{initializeComponentData:function(a,b,d){b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[new pc.scene.MeshInstance(b.model.graph,this.mesh,this.material)];d="density friction restitution x y model".split(" ");c._super.initializeComponentData.call(this,a,b,d);void 0!==Box2D&&(a.fixtureDef=this.createFixtureDef(a.entity,
a),a.entity.body2d&&this.context.systems.body2d.createBody(a.entity.body2d))},createFixtureDef:function(c,d){var f=new a;f.density=d.density;f.friction=d.friction;f.restitution=d.restitution;f.shape=new b;f.shape.SetAsBox(d.x,d.y);f.userData=c;return f},onRemove:function(a,b){a.body2d&&a.body2d.body&&this.context.systems.body2d.removeBody(a,a.body2d.body);this.context.scene.containsModel(b.model)&&(this.context.scene.removeModel(b.model),this.context.root.removeChild(b.model.graph))},setDebugRender:function(a){this.debugRender=
a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b=this.context.systems.body2d.xi,c=this.context.systems.body2d.yi,d=this.context.systems.body2d.ri,h;for(h in a){var l=a[h].entity,n=a[h].data;this.context.scene.containsModel(n.model)||(this.context.scene.addModel(n.model),this.context.root.addChild(n.model.graph));var r=[];r[b]=2*n.x;r[c]=2*n.y;r[d]=1;n=n.model.graph;n.setPosition(l.getPosition());
n.setRotation(l.getRotation());n.setLocalScale(r[0],r[1],r[2])}}});return{CollisionRectComponentSystem:c}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_density",this.onSetDensity,this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_x",this.onSetX,this);this.on("set_y",this.onSetY,this)},pc.fw.Component);pc.extend(d.prototype,{onSetDensity:function(a,b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetDensity(c),this.entity.body2d.body.ResetMassData())},onSetFriction:function(a,
b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetFriction(c),this.entity.body2d.body.ResetMassData())},onSetRestitution:function(a,b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetRestitution(c),this.entity.body2d.body.ResetMassData())},onSetX:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().GetShape().SetAsBox(c,this.y),a.SetAwake(!0)},onSetY:function(a,b,c){if(this.entity.body2d&&
(a=this.entity.body2d.body))a.GetFixtureList().GetShape().SetAsBox(this.x,c),a.SetAwake(!0)}});return{CollisionRectComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.y=this.x=0.5},pc.fw.ComponentData);return{CollisionRectComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b,c=function(c){void 0!==Box2D&&!d&&(d=Box2D.Dynamics.b2World,a=Box2D.Dynamics.b2FixtureDef,b=Box2D.Collision.Shapes.b2CircleShape);this.id="collisioncircle";c.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionCircleComponent;this.DataType=pc.fw.CollisionCircleComponentData;this.schema=[{name:"density",displayName:"Density",description:"The density of the body, this determine the mass",type:"number",options:{min:0,step:0.01},defaultValue:1},{name:"friction",
displayName:"Friction",description:"The friction when the body slides along another body",type:"number",options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object doesn't bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"radius",displayName:"Radius",description:"The size of the Rect in the x-axis",type:"number",
options:{min:0,step:0.1},defaultValue:1},{name:"model",exposed:!1}];this.exposeProperties();var g=c.graphicsDevice,c=new pc.VertexFormat(g,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),c=new pc.VertexBuffer(g,c,41),f=new Float32Array(c.lock()),k,h=c.getNumVertices();for(k=0;k<h-1;k++){var l=2*Math.PI*(k/(h-2)),n=0.5*Math.cos(l),l=0.5*Math.sin(l);f[3*k+0]=n;f[3*k+1]=0;f[3*k+2]=l}c.unlock();g=new pc.IndexBuffer(g,pc.INDEXFORMAT_UINT8,80);f=new Uint8Array(g.lock());for(k=
0;40>k;k++)f[2*k+0]=k,f[2*k+1]=k+1;g.unlock();this.mesh=new pc.scene.Mesh;this.mesh.vertexBuffer=c;this.mesh.indexBuffer[0]=g;this.mesh.primitive[0].type=pc.PRIMITIVE_LINES;this.mesh.primitive[0].base=0;this.mesh.primitive[0].count=g.getNumIndices();this.mesh.primitive[0].indexed=!0;this.material=new pc.scene.BasicMaterial;this.material.color=pc.Color(0,0,1,1);this.material.update();this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",
this.onToolsUpdate,this)},c=pc.inherits(c,pc.fw.ComponentSystem);pc.extend(c.prototype,{initializeComponentData:function(a,b,d){b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[new pc.scene.MeshInstance(b.model.graph,this.mesh,this.material)];d=["density","friction","restitution","radius","model"];c._super.initializeComponentData.call(this,a,b,d);void 0!==Box2D&&(a.fixtureDef=this.createFixtureDef(a.entity,a),a.entity.body2d&&this.context.systems.body2d.createBody(a.entity.body2d))},
createFixtureDef:function(c,d){var f=new a;f.density=d.density;f.friction=d.friction;f.restitution=d.restitution;f.shape=new b;f.shape.SetRadius(d.radius);f.userData=c;return f},onRemove:function(a,b){a.body2d&&a.body2d.body&&this.context.systems.body2d.removeBody(a,a.body2d.body);this.context.scene.containsModel(b.model)&&(this.context.scene.removeModel(b.model),this.context.root.removeChild(b.model.graph))},setDebugRender:function(a){this.debugRender=a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},
onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b;for(b in a){var c=a[b].entity,d=a[b].data;this.context.scene.containsModel(d.model)||(this.context.scene.addModel(d.model),this.context.root.addChild(d.model.graph));var h=d.radius,d=d.model.graph;d.setPosition(c.getPosition());d.setRotation(c.getRotation());d.setLocalScale(h/0.5,h/0.5,h/0.5)}}});return{CollisionCircleComponentSystem:c}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_density",this.onSetDensity,this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_radius",this.onSetRadius,this)},pc.fw.Component);pc.extend(d.prototype,{onSetDensity:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetDensity(c),a.ResetMassData()},onSetFriction:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetFriction(c),
a.ResetMassData()},onSetRestitution:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetRestitution(c),a.ResetMassData()},onSetRadius:function(){if(this.entity.body2d){var a=this.entity.body2d.body;a&&(a.GetFixtureList().GetShape().SetRadius(this.radius),a.SetAwake(!0))}}});return{CollisionCircleComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.radius=1},pc.fw.ComponentData);return{CollisionCircleComponentData:d}}());pc.extend(pc,{BODYTYPE_STATIC:"static",BODYTYPE_DYNAMIC:"dynamic",BODYTYPE_KINEMATIC:"kinematic",BODYFLAG_STATIC_OBJECT:1,BODYFLAG_KINEMATIC_OBJECT:2,BODYFLAG_NORESPONSE_OBJECT:4,BODYSTATE_ACTIVE_TAG:1,BODYSTATE_ISLAND_SLEEPING:2,BODYSTATE_WANTS_DEACTIVATION:3,BODYSTATE_DISABLE_DEACTIVATION:4,BODYSTATE_DISABLE_SIMULATION:5,BODYGROUP_NONE:0,BODYGROUP_DEFAULT:1,BODYGROUP_STATIC:2,BODYGROUP_KINEMATIC:4,BODYGROUP_ENGINE_1:8,BODYGROUP_TRIGGER:16,BODYGROUP_ENGINE_2:32,BODYGROUP_ENGINE_3:64,BODYGROUP_USER_1:128,
BODYGROUP_USER_2:256,BODYGROUP_USER_3:512,BODYGROUP_USER_4:1024,BODYGROUP_USER_5:2048,BODYGROUP_USER_6:4096,BODYGROUP_USER_7:8192,BODYGROUP_USER_8:16384,BODYMASK_NONE:0,BODYMASK_ALL:65535,BODYMASK_STATIC:2,BODYMASK_NOT_STATIC:65533,BODYMASK_NOT_STATIC_KINEMATIC:65529});pc.extend(pc.fw,function(){new pc.Mat4;new pc.Mat4;new pc.Vec3;new pc.Vec3;new pc.Vec3;var d,a,b={},c={},e=function(a,b,c){this.entity=a;this.point=b;this.normal=c},g=function(a,b,c){0===arguments.length?(this.b=this.a=null,this.localPointA=new pc.Vec3,this.localPointB=new pc.Vec3,this.pointA=new pc.Vec3,this.pointB=new pc.Vec3,this.normal=new pc.Vec3):(this.a=a,this.b=b,this.localPointA=c.localPoint,this.localPointB=c.localPointOther,this.pointA=c.point,this.pointB=c.pointOther,this.normal=c.normal)},
f=function(a,b,c,d,e){0===arguments.length?(this.localPoint=new pc.Vec3,this.localPointOther=new pc.Vec3,this.point=new pc.Vec3,this.pointOther=new pc.Vec3,this.normal=new pc.Vec3):(this.localPoint=a,this.localPointOther=b,this.point=c,this.pointOther=d,this.normal=e)},k=function(a,b){this.other=a;this.contacts=b},h=function(a){this.id="rigidbody";this.description="Adds the entity to the scene's physical simulation.";a.systems.add(this.id,this);this.ComponentType=pc.fw.RigidBodyComponent;this.DataType=
pc.fw.RigidBodyComponentData;this.contactPointPool=new pc.AllocatePool(f,1);this.contactResultPool=new pc.AllocatePool(k,1);this.singleContactResultPool=new pc.AllocatePool(g,1);this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the rigid body",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of body determines how it moves and collides with other bodies. Dynamic is a normal body. Static will never move. Kinematic can be moved in code, but will not respond to collisions.",
type:"enumeration",options:{enumerations:[{name:"Static",value:pc.BODYTYPE_STATIC},{name:"Dynamic",value:pc.BODYTYPE_DYNAMIC},{name:"Kinematic",value:pc.BODYTYPE_KINEMATIC}]},defaultValue:pc.BODYTYPE_STATIC},{name:"mass",displayName:"Mass",description:"The mass of the body",type:"number",options:{min:0,step:1},defaultValue:1,filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"linearDamping",displayName:"Linear Damping",description:"The linear damping applied to the body",type:"number",
options:{min:0,step:1},defaultValue:0,filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"angularDamping",displayName:"Angular Damping",description:"The angular damping applied to the body",type:"number",options:{min:0,step:1},defaultValue:0,filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"linearFactor",displayName:"Linear Factor",description:"The linear factor applied to the linear motion of the body, used to contrain linear movement in each axis",type:"vector",options:{min:0,
step:0.1},defaultValue:[1,1,1],filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"angularFactor",displayName:"Angular Factor",description:"The angular factor applied to the angular motion of the body, used to contrain angular movement in each axis",type:"vector",options:{min:0,step:0.1},defaultValue:[1,1,1],filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"friction",displayName:"Friction",description:"The friction when the body slides along another body",type:"number",
options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object does not bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"group",displayName:"Group",description:"The collision group this rigidbody belongs to",type:"number",defaultValue:pc.BODYGROUP_STATIC,exposed:!1},{name:"mask",displayName:"Mask",description:"The collision mask this rigidbody uses to collide",
type:"number",defaultValue:pc.BODYMASK_NOT_STATIC,exposed:!1},{name:"body",exposed:!1}];this.exposeProperties();this.maxSubSteps=10;this.fixedTimeStep=1/60;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this)},h=pc.inherits(h,pc.fw.ComponentSystem);pc.extend(h.prototype,{onLibraryLoaded:function(){if("undefined"!==typeof Ammo){var b=new Ammo.btDefaultCollisionConfiguration,c=new Ammo.btCollisionDispatcher(b),e=new Ammo.btDbvtBroadphase,f=new Ammo.btSequentialImpulseConstraintSolver;
this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(c,e,f,b);this._ammoGravity=new Ammo.btVector3(0,-9.82,0);this.dynamicsWorld.setGravity(this._ammoGravity);d=new Ammo.btVector3;a=new Ammo.btVector3}else pc.fw.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){b.bodyType&&(b.type=b.bodyType,console.warn("WARNING: rigidbody.bodyType: Property is deprecated. Use type instead."));b.linearFactor&&"array"===pc.type(b.linearFactor)&&(b.linearFactor=new pc.Vec3(b.linearFactor[0],
b.linearFactor[1],b.linearFactor[2]));b.angularFactor&&"array"===pc.type(b.angularFactor)&&(b.angularFactor=new pc.Vec3(b.angularFactor[0],b.angularFactor[1],b.angularFactor[2]));c="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ");h._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,
linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,type:a.rigidbody.type,group:a.rigidbody.group,mask:a.rigidbody.mask})},onRemove:function(a,b){b.body&&(this.removeBody(b.body),Ammo.destroy(b.body));b.body=null},addBody:function(a,b,c){void 0!==b&&void 0!==c?this.dynamicsWorld.addRigidBody(a,
b,c):this.dynamicsWorld.addRigidBody(a);return a},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},addConstraint:function(a){this.dynamicsWorld.addConstraint(a);return a},removeConstraint:function(a){this.dynamicsWorld.removeConstraint(a)},setGravity:function(){var a,b,c;1===arguments.length?(a=arguments[0].x,b=arguments[0].y,c=arguments[0].z):(a=arguments[0],b=arguments[1],c=arguments[2]);this._ammoGravity.setValue(a,b,c);this.dynamicsWorld.setGravity(this._ammoGravity)},raycastFirst:function(b,
c,f){d.setValue(b.x,b.y,b.z);a.setValue(c.x,c.y,c.z);b=new Ammo.ClosestRayResultCallback(d,a);this.dynamicsWorld.rayTest(d,a,b);if(b.hasHit()){var c=b.get_m_collisionObject(),c=Ammo.castObject(c,Ammo.btRigidBody),g=b.get_m_hitPointWorld(),h=b.get_m_hitNormalWorld();c&&f(new e(c.entity,new pc.Vec3(g.x(),g.y(),g.z()),new pc.Vec3(h.x(),h.y(),h.z())))}Ammo.destroy(b)},_storeCollision:function(a,d){var e=!1,f=a.getGuid();b[f]=b[f]||{others:[],entity:a};0>b[f].others.indexOf(d)&&(b[f].others.push(d),e=
!0);c[f]=c[f]||{others:[],entity:a};c[f].others.push(d);return e},_createContactPointFromAmmo:function(a){var b=this.contactPointPool.allocate();b.localPoint.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z());b.localPointOther.set(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z());b.point.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());b.pointOther.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),
a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return b},_createReverseContactPointFromAmmo:function(a){var b=this.contactPointPool.allocate();b.localPointOther.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z());b.localPoint.set(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z());b.pointOther.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());
b.point.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return b},_createSingleContactResult:function(a,b,c){var d=this.singleContactResultPool.allocate();d.a=a;d.b=b;d.localPointA=c.localPoint;d.localPointB=c.localPointOther;d.pointA=c.point;d.pointB=c.pointOther;d.normal=c.normal;return d},_createContactResult:function(a,b){var c=this.contactResultPool.allocate();
c.other=a;c.contacts=b;return c},_cleanOldCollisions:function(){for(var a in b)if(b.hasOwnProperty(a)){for(var d=b[a].entity,e=d.collision,f=b[a].others,g=f.length;g--;){var h=f[g];if(!c[a]||0>c[a].others.indexOf(h))f.splice(g,1),e&&h.collision&&(d.rigidbody&&h.rigidbody?e.fire("collisionend",h):d.trigger&&e.fire("triggerleave",h))}0===f.length&&delete b[a]}},onUpdate:function(a){frameContacts=0;this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);var b=this.store,d;for(d in b)if(b.hasOwnProperty(d)){var e=
b[d].entity,f=b[d].data;f.body&&(f.body.isActive()&&f.enabled&&e.enabled)&&(f.type===pc.BODYTYPE_DYNAMIC?e.rigidbody.syncBodyToEntity():f.type===pc.BODYTYPE_KINEMATIC&&e.rigidbody._updateKinematic(a))}var a=this.dynamicsWorld.getDispatcher(),b=a.getNumManifolds(),g;c={};for(d=0;d<b;d++){var h=a.getManifoldByIndexInternal(d),k=h.getBody0(),s=h.getBody1(),e=Ammo.castObject(k,Ammo.btRigidBody),f=Ammo.castObject(s,Ammo.btRigidBody),e=e.entity,f=f.entity;if(e&&f){g=k.getCollisionFlags();var v=s.getCollisionFlags(),
A=h.getNumContacts(),x=[],s=[];if(0<A)if(g&pc.BODYFLAG_NORESPONSE_OBJECT||v&pc.BODYFLAG_NORESPONSE_OBJECT){var E=e.collision.hasEvent("triggerenter")||e.collision.hasEvent("triggerleave"),k=f.collision.hasEvent("triggerenter")||f.collision.hasEvent("triggerleave");E&&(h=this._storeCollision(e,f))&&e.collision&&!(v&pc.BODYFLAG_NORESPONSE_OBJECT)&&e.collision.fire("triggerenter",f);k&&(h=this._storeCollision(f,e))&&f.collision&&!(g&pc.BODYFLAG_NORESPONSE_OBJECT)&&f.collision.fire("triggerenter",e)}else if(E=
e.collision.hasEvent("collisionstart")||e.collision.hasEvent("collisionend")||e.collision.hasEvent("contact"),k=f.collision.hasEvent("collisionstart")||f.collision.hasEvent("collisionend")||f.collision.hasEvent("contact"),(v=this.hasEvent("contact"))||E||k){for(g=0;g<A;g++){var D=h.getContactPoint(g),I=this._createContactPointFromAmmo(D),M=null;if(E||k)M=this._createReverseContactPointFromAmmo(D),x.push(I),s.push(M);v&&(D=this._createSingleContactResult(e,f,I),this.fire("contact",D))}E&&(A=this._createContactResult(f,
x),e.collision&&e.collision.fire("contact",A),(h=this._storeCollision(e,f))&&e.collision&&e.collision.fire("collisionstart",A));k&&(s=this._createContactResult(e,s),f.collision&&f.collision.fire("contact",s),(h=this._storeCollision(f,e))&&f.collision&&f.collision.fire("collisionstart",s))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll()}});return{RIGIDBODY_TYPE_STATIC:"static",RIGIDBODY_TYPE_DYNAMIC:"dynamic",RIGIDBODY_TYPE_KINEMATIC:"kinematic",
RIGIDBODY_CF_STATIC_OBJECT:1,RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:h}}());pc.extend(pc.fw,function(){var d,a,b,c,e,g=function(f,g){"undefined"!==typeof Ammo&&!d&&(d=new Ammo.btTransform,a=new Ammo.btVector3,b=new Ammo.btVector3,c=new Ammo.btQuaternion,e=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,this);this.on("set_friction",
this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_group",this.onSetGroupOrMask,this);this.on("set_mask",this.onSetGroupOrMask,this);this.on("set_body",this.onSetBody,this);g.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this);this.system.on("beforeremove",this.onBeforeRemove,this);this._displacement=new pc.Vec3(0,0,0);this._linearVelocity=new pc.Vec3(0,0,0);this._angularVelocity=new pc.Vec3(0,0,0)},g=
pc.inherits(g,pc.fw.Component);Object.defineProperty(g.prototype,"bodyType",{get:function(){console.warn("WARNING: bodyType: Function is deprecated. Query type property instead.");return this.type},set:function(a){console.warn("WARNING: bodyType: Function is deprecated. Set type property instead.");this.type=a}});Object.defineProperty(g.prototype,"linearVelocity",{get:function(){if(this.isKinematic())return this._linearVelocity;if(this.body){var a=this.body.getLinearVelocity();this._linearVelocity.set(a.x(),
a.y(),a.z());return this._linearVelocity}},set:function(b){this.activate();if(this.isKinematic())this._linearVelocity.copy(b);else{var c=this.body;c&&(a.setValue(b.x,b.y,b.z),c.setLinearVelocity(a))}}});Object.defineProperty(g.prototype,"angularVelocity",{get:function(){if(this.isKinematic())return this._angularVelocity;if(this.body){var a=this.body.getAngularVelocity();this._angularVelocity.set(a.x(),a.y(),a.z());return this._angularVelocity}},set:function(b){this.activate();if(this.isKinematic())this._angularVelocity.copy(b);
else{var c=this.body;c&&(a.setValue(b.x,b.y,b.z),c.setAngularVelocity(a))}}});pc.extend(g.prototype,{createBody:function(){var b=this.entity,d;b.collision&&(d=b.collision.shape,b.trigger&&(b.trigger.destroy(),delete b.trigger));if(d){this.body&&(this.system.removeBody(this.body),Ammo.destroy(this.body));var e=this.isStaticOrKinematic(),g=e?0:this.mass,n=new Ammo.btVector3(0,0,0);e||d.calculateLocalInertia(g,n);var e=b.getPosition(),r=b.getRotation();c.setValue(r.x,r.y,r.z,r.w);r=new Ammo.btTransform;
r.setIdentity();r.getOrigin().setValue(e.x,e.y,e.z);r.setRotation(c);e=new Ammo.btDefaultMotionState(r);d=new Ammo.btRigidBodyConstructionInfo(g,e,d,n);d=new Ammo.btRigidBody(d);d.setRestitution(this.restitution);d.setFriction(this.friction);d.setDamping(this.linearDamping,this.angularDamping);g=this.linearFactor;a.setValue(g.x,g.y,g.z);d.setLinearFactor(a);g=this.angularFactor;a.setValue(g.x,g.y,g.z);d.setAngularFactor(a);d.entity=b;this.isKinematic()&&(d.setCollisionFlags(d.getCollisionFlags()|
pc.BODYFLAG_KINEMATIC_OBJECT),d.setActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION));b.rigidbody.body=d;this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){return this.body?this.body.isActive():!1},activate:function(){this.body&&this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;a&&(this.system.addBody(a,this.group,this.mask),this.isKinematic()?(a.forceActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION),
a.activate()):(a.forceActivationState(pc.BODYFLAG_ACTIVE_TAG),this.syncEntityToBody()),this.data.simulationEnabled=!0)}},disableSimulation:function(){var a=this.body;a&&this.data.simulationEnabled&&(this.system.removeBody(a),a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION),this.data.simulationEnabled=!1)},applyForce:function(){var c,d,g,l,n,r;switch(arguments.length){case 1:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;break;case 2:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;l=
arguments[1].x;n=arguments[1].y;r=arguments[1].z;break;case 3:c=arguments[0];d=arguments[1];g=arguments[2];break;case 6:c=arguments[0],d=arguments[1],g=arguments[2],l=arguments[3],n=arguments[4],r=arguments[5]}var m=this.body;m&&(m.activate(),a.setValue(c,d,g),void 0!==l?(b.setValue(l,n,r),m.applyForce(a,b)):m.applyForce(a,e))},applyTorque:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];
break;default:console.error("ERROR: applyTorque: function takes 1 or 3 arguments");return}var e=this.body;e&&(e.activate(),a.setValue(b,c,d),e.applyTorque(a))},applyImpulse:function(){var c,d,g,l,n,r;switch(arguments.length){case 1:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;break;case 2:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;l=arguments[1].x;n=arguments[1].y;r=arguments[1].z;break;case 3:c=arguments[0];d=arguments[1];g=arguments[2];break;case 6:c=arguments[0],d=arguments[1],g=
arguments[2],l=arguments[0],n=arguments[1],r=arguments[2]}var m=this.body;m&&(m.activate(),a.setValue(c,d,g),void 0!==l?(b.setValue(l,n,r),m.applyImpulse(a,b)):m.applyImpulse(a,e))},applyTorqueImpulse:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];break;default:console.error("ERROR: applyTorqueImpulse: function takes 1 or 3 arguments");return}var e=this.body;e&&(e.activate(),a.setValue(b,
c,d),e.applyTorqueImpulse(a))},isStatic:function(){return this.type===pc.BODYTYPE_STATIC},isStaticOrKinematic:function(){return this.type===pc.BODYTYPE_STATIC||this.type===pc.BODYTYPE_KINEMATIC},isKinematic:function(){return this.type===pc.BODYTYPE_KINEMATIC},syncEntityToBody:function(){var a=this.body;if(a){var b=this.entity.getPosition(),d=this.entity.getRotation(),e=a.getWorldTransform();e.getOrigin().setValue(b.x,b.y,b.z);c.setValue(d.x,d.y,d.z,d.w);e.setRotation(c);a.activate()}},syncBodyToEntity:function(){var a=
this.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(d);var a=d.getOrigin(),b=d.getRotation();this.entity.setPosition(a.x(),a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof pc.Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],
arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2]));this.syncEntityToBody()},_updateKinematic:function(a){this._displacement.copy(this._linearVelocity).scale(a);this.entity.translate(this._displacement);this._displacement.copy(this._angularVelocity).scale(a);this.entity.rotate(this._displacement.x,this._displacement.y,this._displacement.z);if(this.body.getMotionState()){var a=this.entity.getPosition(),b=this.entity.getRotation();d.getOrigin().setValue(a.x,a.y,a.z);c.setValue(b.x,
b.y,b.z,b.w);d.setRotation(c);this.body.getMotionState().setWorldTransform(d)}},onEnable:function(){g._super.onEnable.call(this);this.body||this.createBody();this.enableSimulation()},onDisable:function(){g._super.onDisable.call(this);this.disableSimulation()},onSetMass:function(a,b,c){if(a=this.data.body){(b=this.enabled&&this.entity.enabled)&&this.disableSimulation();var d=new Ammo.btVector3(0,0,0);a.getCollisionShape().calculateLocalInertia(c,d);a.setMassProps(c,d);a.updateInertiaTensor();b&&this.enableSimulation()}},
onSetLinearDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(c,this.data.angularDamping)},onSetAngularDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(this.data.linearDamping,c)},onSetLinearFactor:function(b,c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setLinearFactor(a)},onSetAngularFactor:function(b,c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setAngularFactor(a)},onSetFriction:function(a,b,c){(a=this.data.body)&&a.setFriction(c)},onSetRestitution:function(a,b,c){(a=this.data.body)&&
a.setRestitution(c)},onSetType:function(a,b,c){c!==b&&(this.disableSimulation(),c===pc.BODYTYPE_DYNAMIC?(this.data.group=pc.BODYGROUP_DEFAULT,this.data.mask=pc.BODYMASK_ALL):c===pc.BODYTYPE_KINEMATIC?(this.data.group=pc.BODYGROUP_KINEMATIC,this.data.mask=pc.BODYMASK_ALL):(this.data.group=pc.BODYGROUP_STATIC,this.data.mask=pc.BODYMASK_NOT_STATIC),this.createBody())},onSetGroupOrMask:function(a,b,c){c!==b&&(this.enabled&&this.entity.enabled)&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(){this.body&&
this.data.simulationEnabled&&this.body.activate()},onLiveLinkUpdateTransform:function(){this.syncEntityToBody();this.angularVelocity=this.linearVelocity=pc.Vec3.ZERO},onBeforeRemove:function(a,b){this===b&&(a.off("livelink:updatetransform",this.onLiveLinkUpdateTransform,this),this.system.off("beforeremove",this.onBeforeRemove,this))}});return{RigidBodyComponent:g}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new pc.Vec3(1,1,1);this.angularFactor=new pc.Vec3(1,1,1);this.friction=0.5;this.restitution=0;this.type=pc.BODYTYPE_STATIC;this.group=pc.BODYGROUP_STATIC;this.mask=pc.BODYMASK_NOT_STATIC;this.body=null;this.simulationEnabled=!1},pc.fw.ComponentData);return{RigidBodyComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b=function(b,e,g){this.entity=e.entity;this.component=e;this.context=b;"undefined"!==typeof Ammo&&(d=new Ammo.btVector3,a=new Ammo.btQuaternion);this.initialize(g)};b.prototype={initialize:function(b){var e=this.entity;if((b=b.shape)&&"undefined"!==typeof Ammo){e.trigger&&e.trigger.destroy();var g=new Ammo.btVector3(0,0,0);b.calculateLocalInertia(1,g);var f=e.getPosition(),k=e.getRotation();a.setValue(k.x,k.y,k.z,k.w);k=new Ammo.btTransform;k.setIdentity();k.getOrigin().setValue(f.x,
f.y,f.z);k.setRotation(a);f=new Ammo.btDefaultMotionState(k);b=new Ammo.btRigidBodyConstructionInfo(1,f,b,g);this.body=b=new Ammo.btRigidBody(b);b.setRestitution(0);b.setFriction(0);b.setDamping(0,0);d.setValue(0,0,0);b.setLinearFactor(d);b.setAngularFactor(d);b.setCollisionFlags(b.getCollisionFlags()|pc.BODYFLAG_NORESPONSE_OBJECT);b.entity=e;this.component.enabled&&e.enabled&&this.enable()}},destroy:function(){this.body&&this.context.systems.rigidbody.removeBody(this.body)},syncEntityToBody:function(){var b=
this.body;if(b){var d=this.entity.getPosition(),g=this.entity.getRotation(),f=b.getWorldTransform();f.getOrigin().setValue(d.x,d.y,d.z);a.setValue(g.x,g.y,g.z,g.w);f.setRotation(a);b.activate()}},enable:function(){var a=this.body;this.context.systems.rigidbody.addBody(a,pc.BODYGROUP_TRIGGER,pc.BODYMASK_NOT_STATIC^pc.BODYGROUP_TRIGGER);a.forceActivationState(pc.BODYSTATE_ACTIVE_TAG);a.activate()},disable:function(){var a=this.body;this.context.systems.rigidbody.removeBody(a);a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION)}};
return{Trigger:b}}());pc.extend(pc.fw,function(){var d=function(a){this.id="collision";this.description="Specifies a collision volume.";a.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionComponent;this.DataType=pc.fw.CollisionComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the collision",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of the collision volume",type:"enumeration",options:{enumerations:[{name:"Box",value:"box"},
{name:"Sphere",value:"sphere"},{name:"Capsule",value:"capsule"},{name:"Cylinder",value:"cylinder"},{name:"Mesh",value:"mesh"}]},defaultValue:"box"},{name:"halfExtents",displayName:"Half Extents",description:"The half-extents of the box",type:"vector",options:{min:0,step:0.1},defaultValue:[0.5,0.5,0.5],filter:{type:"box"}},{name:"radius",displayName:"Radius",description:"The radius of the collision volume",type:"number",options:{min:0,step:0.1},defaultValue:0.5,filter:{type:["sphere","capsule","cylinder"]}},
{name:"axis",displayName:"Axis",description:"Major axis of the volume",type:"enumeration",options:{enumerations:[{name:"X",value:0},{name:"Y",value:1},{name:"Z",value:2}]},defaultValue:1,filter:{type:["capsule","cylinder"]}},{name:"height",displayName:"Height",description:"Height of the volume",type:"number",options:{min:0,step:0.1},defaultValue:2,filter:{type:["capsule","cylinder"]}},{name:"asset",displayName:"Asset",description:"Collision mesh asset",type:"asset",options:{max:1,type:"model"},defaultValue:null,
filter:{type:"mesh"}},{name:"shape",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();this.implementations={};this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype=pc.extend(d.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.fw.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,
b,c){b.type||(b.type=a.data.type);a.data.type=b.type;b.halfExtents&&"array"===pc.type(b.halfExtents)&&(b.halfExtents=new pc.Vec3(b.halfExtents[0],b.halfExtents[1],b.halfExtents[2]));var e=this._createImplementation(b.type);e.beforeInitialize(a,b);c="type halfExtents radius axis height shape model asset enabled".split(" ");d._super.initializeComponentData.call(this.system,a,b,c);e.afterInitialize(a,b)},_createImplementation:function(a){if(void 0===this.implementations[a]){var b;switch(a){case "box":b=
new CollisionBoxSystemImpl(this);break;case "sphere":b=new CollisionSphereSystemImpl(this);break;case "capsule":b=new CollisionCapsuleSystemImpl(this);break;case "cylinder":b=new CollisionCylinderSystemImpl(this);break;case "mesh":b=new CollisionMeshSystemImpl(this);break;default:throw"Invalid collision system type: "+a;}this.implementations[a]=b}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,
b)},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},onUpdate:function(){var a,b,c,d=this.store;for(a in d)b=d[a].entity,c=d[a].data,c.enabled&&b.enabled&&(b.rigidbody||b.trigger.syncEntityToBody()),this.debugRender&&this.updateDebugShape(b,c,this._getImplementation(b))},updateDebugShape:function(a,b,c){var d=this.context;if(void 0!==c&&c.hasDebugShape){if(b.model)if(d.scene.containsModel(b.model)){if(!b.enabled||!a.enabled)d.root.removeChild(b.model.graph),d.scene.removeModel(b.model)}else a.enabled&&
b.enabled&&(d.scene.addModel(b.model),d.root.addChild(b.model.graph));b.enabled&&a.enabled&&c.updateDebugShape(a,b)}},onTransformChanged:function(a,b,c,d){this.implementations[a.data.type].updateTransform(a,b,c,d)},onToolsUpdate:function(){var a,b,c=this.store;for(a in c)b=c[a].entity,this.updateDebugShape(b,c[a].data,this._getImplementation(b))},setDebugRender:function(a){this.debugRender=a},changeType:function(a,b,c){this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).reset(a,
a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)}});CollisionSystemImpl=function(a){this.system=a;this.hasDebugShape=!0};CollisionSystemImpl.prototype={beforeInitialize:function(a,b){b.shape=this.createPhysicalShape(a.entity,b);b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[this.createDebugMesh(b)]},afterInitialize:function(a){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,
b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=a.entity,c=a.data;"undefined"!==typeof Ammo&&(c.shape=this.createPhysicalShape(a.entity,c),b.rigidbody?b.rigidbody.createBody():b.trigger?b.trigger.initialize(c):b.trigger=new pc.fw.Trigger(this.system.context,a,c))},createDebugMesh:function(){},createPhysicalShape:function(){},updateDebugShape:function(){},updateTransform:function(a){a.entity.trigger&&a.entity.trigger.syncEntityToBody()},remove:function(a,b){var c=this.system.context;
a.rigidbody&&a.rigidbody.body&&c.systems.rigidbody.removeBody(a.rigidbody.body);a.trigger&&(a.trigger.destroy(),delete a.trigger);c.scene.containsModel(b.model)&&(c.root.removeChild(b.model.graph),c.scene.removeModel(b.model))},clone:function(a,b){var c=this.system.dataStore[a.getGuid()];return this.system.addComponent(b,{enabled:c.data.enabled,type:c.data.type,halfExtents:[c.data.halfExtents.x,c.data.halfExtents.y,c.data.halfExtents.z],radius:c.data.radius,axis:c.data.axis,height:c.data.height,asset:c.data.asset,
model:c.data.model})}};CollisionBoxSystemImpl=function(){};CollisionBoxSystemImpl=pc.inherits(CollisionBoxSystemImpl,CollisionSystemImpl);CollisionBoxSystemImpl.prototype=pc.extend(CollisionBoxSystemImpl.prototype,{createDebugMesh:function(a){if(!this.mesh){var b=this.system.context.graphicsDevice,c=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),c=new pc.VertexBuffer(b,c,8);(new Float32Array(c.lock())).set([-0.5,-0.5,-0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,
0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,-0.5]);c.unlock();b=new pc.IndexBuffer(b,pc.INDEXFORMAT_UINT8,24);(new Uint8Array(b.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);b.unlock();var d=new pc.scene.Mesh;d.vertexBuffer=c;d.indexBuffer[0]=b;d.primitive[0].type=pc.PRIMITIVE_LINES;d.primitive[0].base=0;d.primitive[0].count=b.getNumIndices();d.primitive[0].indexed=!0;this.mesh=d}this.material||(c=new pc.scene.BasicMaterial,c.color=new pc.Color(0,0,1,1),c.update(),
this.material=c);return new pc.scene.MeshInstance(a.model.graph,this.mesh,this.material)},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo){var c=b.halfExtents,c=new Ammo.btVector3(c.x,c.y,c.z);return new Ammo.btBoxShape(c)}},updateDebugShape:function(a,b){var c=b.halfExtents,d=c.x,g=c.y,c=c.z,f=b.model.graph;f.setPosition(a.getPosition());f.setRotation(a.getRotation());f.setLocalScale(2*d,2*g,2*c)}});CollisionSphereSystemImpl=function(){};CollisionSphereSystemImpl=pc.inherits(CollisionSphereSystemImpl,
CollisionSystemImpl);CollisionSphereSystemImpl.prototype=pc.extend(CollisionSphereSystemImpl.prototype,{createDebugMesh:function(a){if(!this.mesh){for(var b=this.system.context.graphicsDevice,c=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),b=new pc.VertexBuffer(b,c,240),c=new Float32Array(b.lock()),d,g=0,f,k=0;3>k;k++){var h=0,l=1,n=2;1===k?(h=1,l=0,n=2):2===k&&(h=0,l=2,n=1);for(d=0;40>d;d++)f=2*Math.PI*(d/40),c[g+h]=0.5*Math.cos(f),c[g+l]=0,c[g+
n]=0.5*Math.sin(f),g+=3,f=2*Math.PI*((d+1)/40),c[g+h]=0.5*Math.cos(f),c[g+l]=0,c[g+n]=0.5*Math.sin(f),g+=3}b.unlock();c=new pc.scene.Mesh;c.vertexBuffer=b;c.primitive[0].type=pc.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=b.getNumVertices();c.primitive[0].indexed=!1;this.mesh=c}this.material||(b=new pc.scene.BasicMaterial,b.color=new pc.Color(0,0,1,1),b.update(),this.material=b);return new pc.scene.MeshInstance(a.model.graph,this.mesh,this.material)},createPhysicalShape:function(a,
b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());var d=2*b.radius;c.setLocalScale(d,d,d)}});CollisionCapsuleSystemImpl=function(){};CollisionCapsuleSystemImpl=pc.inherits(CollisionCapsuleSystemImpl,CollisionSystemImpl);CollisionCapsuleSystemImpl.prototype=pc.extend(CollisionCapsuleSystemImpl.prototype,{createDebugMesh:function(a){if(a.model&&a.model.meshInstances&&
a.model.meshInstances.length)return a.model.meshInstances[0];var b=this.system.context.graphicsDevice,c=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),c=new pc.VertexBuffer(b,c,328,pc.BUFFER_DYNAMIC);this.updateCapsuleShape(a,c);b=new pc.scene.Mesh;b.vertexBuffer=c;b.primitive[0].type=pc.PRIMITIVE_LINES;b.primitive[0].base=0;b.primitive[0].count=c.getNumVertices();b.primitive[0].indexed=!1;this.mesh=b;this.material||(c=new pc.scene.BasicMaterial,
c.color=new pc.Color(0,0,1,1),c.update(),this.material=c);return new pc.scene.MeshInstance(a.model.graph,b,this.material)},updateCapsuleShape:function(a,b){var c=void 0!==a.axis?a.axis:1,d=a.radius||0.5,g=Math.max((a.height||2)-2*d,0),f=new Float32Array(b.lock()),k=0,h=1,l=2;0===c?(k=1,h=0,l=2):2===c&&(k=0,h=2,l=1);var n=0,r;for(cap=-1;2>cap;cap+=2){for(c=0;40>c;c++)r=2*Math.PI*(c/40),f[n+k]=d*Math.cos(r),f[n+h]=0.5*cap*g,f[n+l]=d*Math.sin(r),n+=3,r=2*Math.PI*((c+1)/40),f[n+k]=d*Math.cos(r),f[n+h]=
0.5*cap*g,f[n+l]=d*Math.sin(r),n+=3;for(c=0;20>c;c++)r=Math.PI*(c/20)+1.5*Math.PI,f[n+k]=0,f[n+h]=cap*(0.5*g+d*Math.cos(r)),f[n+l]=cap*d*Math.sin(r),n+=3,r=Math.PI*((c+1)/20)+1.5*Math.PI,f[n+k]=0,f[n+h]=cap*(0.5*g+d*Math.cos(r)),f[n+l]=cap*d*Math.sin(r),n+=3;for(c=0;20>c;c++)r=Math.PI*(c/20)+1.5*Math.PI,f[n+k]=cap*d*Math.sin(r),f[n+h]=cap*(0.5*g+d*Math.cos(r)),f[n+l]=0,n+=3,r=Math.PI*((c+1)/20)+1.5*Math.PI,f[n+k]=cap*d*Math.sin(r),f[n+h]=cap*(0.5*g+d*Math.cos(r)),f[n+l]=0,n+=3}for(c=0;4>c;c++)r=2*
Math.PI*(c/4),f[n+k]=d*Math.cos(r),f[n+h]=0.5*g,f[n+l]=d*Math.sin(r),n+=3,r=2*Math.PI*(c/4),f[n+k]=d*Math.cos(r),f[n+h]=0.5*-g,f[n+l]=d*Math.sin(r),n+=3;b.unlock()},createPhysicalShape:function(a,b){var c=null,d=void 0!==b.axis?b.axis:1,g=b.radius||0.5,f=Math.max((b.height||2)-2*g,0);if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btCapsuleShapeX(g,f);break;case 1:c=new Ammo.btCapsuleShape(g,f);break;case 2:c=new Ammo.btCapsuleShapeZ(g,f)}return c},updateDebugShape:function(a,b){var c=b.model.graph;
c.setPosition(a.getPosition());c.setRotation(a.getRotation());c.setLocalScale(1,1,1)},recreatePhysicalShapes:function(a){if(a.data.model){var b=this.createDebugMesh(a.data).mesh.vertexBuffer;this.updateCapsuleShape(a.data,b);CollisionCapsuleSystemImpl._super.recreatePhysicalShapes.call(this,a)}}});CollisionCylinderSystemImpl=function(){};CollisionCylinderSystemImpl=pc.inherits(CollisionCylinderSystemImpl,CollisionSystemImpl);CollisionCylinderSystemImpl.prototype=pc.extend(CollisionCylinderSystemImpl.prototype,
{createDebugMesh:function(a){if(a.model&&a.model.meshInstances&&a.model.meshInstances.length)return a.model.meshInstances[0];var b=this.system.context.graphicsDevice,c=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),c=new pc.VertexBuffer(b,c,168,pc.BUFFER_DYNAMIC);this.updateCylinderShape(a,c);b=new pc.scene.Mesh;b.vertexBuffer=c;b.primitive[0].type=pc.PRIMITIVE_LINES;b.primitive[0].base=0;b.primitive[0].count=c.getNumVertices();b.primitive[0].indexed=
!1;this.material||(c=new pc.scene.BasicMaterial,c.color=new pc.Color(0,0,1,1),c.update(),this.material=c);return new pc.scene.MeshInstance(a.model.graph,b,this.material)},updateCylinderShape:function(a,b){var c=void 0!==a.axis?a.axis:1,d=void 0!==a.radius?a.radius:0.5,g=void 0!==a.height?a.height:1,f=new Float32Array(b.lock()),k=0,h=1,l=2;0===c?(k=1,h=0,l=2):2===c&&(k=0,h=2,l=1);var n=0,r;for(cap=-1;2>cap;cap+=2)for(c=0;40>c;c++)r=2*Math.PI*(c/40),f[n+k]=d*Math.cos(r),f[n+h]=0.5*cap*g,f[n+l]=d*Math.sin(r),
n+=3,r=2*Math.PI*((c+1)/40),f[n+k]=d*Math.cos(r),f[n+h]=0.5*cap*g,f[n+l]=d*Math.sin(r),n+=3;for(c=0;4>c;c++)r=2*Math.PI*(c/4),f[n+k]=d*Math.cos(r),f[n+h]=0.5*g,f[n+l]=d*Math.sin(r),n+=3,r=2*Math.PI*(c/4),f[n+k]=d*Math.cos(r),f[n+h]=0.5*-g,f[n+l]=d*Math.sin(r),n+=3;b.unlock()},createPhysicalShape:function(a,b){var c=null,c=null,d=void 0!==b.axis?b.axis:1,g=void 0!==b.radius?b.radius:0.5,f=void 0!==b.height?b.height:1;if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btVector3(0.5*f,g,g);c=new Ammo.btCylinderShapeX(c);
break;case 1:c=new Ammo.btVector3(g,0.5*f,g);c=new Ammo.btCylinderShape(c);break;case 2:c=new Ammo.btVector3(g,g,0.5*f),c=new Ammo.btCylinderShapeZ(c)}return c},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());c.setLocalScale(1,1,1)},recreatePhysicalShapes:function(a){if(a.data.model){var b=this.createDebugMesh(a.data).mesh.vertexBuffer;this.updateCylinderShape(a.data,b);CollisionCylinderSystemImpl._super.recreatePhysicalShapes.call(this,
a)}}});CollisionMeshSystemImpl=function(){this.hasDebugShape=!1};CollisionMeshSystemImpl=pc.inherits(CollisionMeshSystemImpl,CollisionSystemImpl);CollisionMeshSystemImpl.prototype=pc.extend(CollisionMeshSystemImpl.prototype,{beforeInitialize:function(){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var c=b.model,d=new Ammo.btCompoundShape,g,f;for(g=0;g<c.meshInstances.length;g++){var k=c.meshInstances[g],h=k.mesh,l=h.indexBuffer[pc.scene.RENDERSTYLE_SOLID],n=h.vertexBuffer,
r=n.getFormat(),m=r.size/4,w;for(f=0;f<r.elements.length;f++){var u=r.elements[f];u.name===pc.SEMANTIC_POSITION&&(w=new Float32Array(n.lock(),u.offset))}var l=new Uint16Array(l.lock()),n=h.primitive[0].count/3,r=new Ammo.btVector3,u=new Ammo.btVector3,F=new Ammo.btVector3,z,s,v=h.primitive[0].base,A=new Ammo.btTriangleMesh;for(f=0;f<n;f++)h=l[v+3*f]*m,z=l[v+3*f+1]*m,s=l[v+3*f+2]*m,r.setValue(w[h],w[h+1],w[h+2]),u.setValue(w[z],w[z+1],w[z+2]),F.setValue(w[s],w[s+1],w[s+2]),A.addTriangle(r,u,F,!0);
f=new Ammo.btBvhTriangleMeshShape(A,!0);m=k.node.getWorldTransform().getScale();f.setLocalScaling(new Ammo.btVector3(m.x,m.y,m.z));m=k.node.getPosition();k=k.node.getRotation();l=new Ammo.btTransform;l.setIdentity();l.getOrigin().setValue(m.x,m.y,m.z);m=new Ammo.btQuaternion;m.setValue(k.x,k.y,k.z,k.w);l.setRotation(m);d.addChildShape(l,f)}c=a.getWorldTransform().getScale();g=new Ammo.btVector3;g.setValue(c.x,c.y,c.z);d.setLocalScaling(g);return d}},recreatePhysicalShapes:function(a){var b=a.data;
null!==b.asset?this.loadModelAsset(a):(b.model=null,this.doRecreatePhysicalShape(a))},loadModelAsset:function(a){var b=a.data.asset,c=a.data,d={parent:a.entity.getRequest()},g=this.system.context.assets.getAssetById(b);g?g.resource?(c.model=g.resource,this.doRecreatePhysicalShape(a)):this.system.context.assets.load(g,[],d).then(function(b){c.model=b[0];this.doRecreatePhysicalShape(a)}.bind(this)):logERROR(pc.string.format("Trying to load model before asset {0} is loaded.",b))},doRecreatePhysicalShape:function(a){var b=
a.entity,c=a.data;c.model?(c.shape&&Ammo.destroy(c.shape),c.shape=this.createPhysicalShape(b,c),b.rigidbody?b.rigidbody.createBody():b.trigger?b.trigger.initialize(c):b.trigger=new pc.fw.Trigger(this.system.context,a,c)):this.remove(b,c)},updateTransform:function(a,b,c,d){if(a.shape){var g=a.entity.getWorldTransform().getScale(),f=a.shape.getLocalScaling();(g.x!==f.x()||g.y!==f.y()||g.z!==f.z())&&this.doRecreatePhysicalShape(a)}CollisionMeshSystemImpl._super.updateTransform.call(this,a,b,c,d)}});
return{CollisionComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);b.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this);a.on("beforeremove",this.onBeforeRemove,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{onSetType:function(a,
b,c){b!==c&&this.system.changeType(this,b,c)},onSetHalfExtents:function(){this.data.initialized&&"box"===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(){this.data.initialized&&("sphere"===this.data.type||"capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetHeight:function(){this.data.initialized&&("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAxis:function(){this.data.initialized&&
("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAsset:function(){this.data.initialized&&"mesh"===this.data.type&&this.system.recreatePhysicalShapes(this)},onEnable:function(){d._super.onEnable.call(this);this.entity.trigger?this.entity.trigger.enable():this.entity.rigidbody&&this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation()},onDisable:function(){d._super.onDisable.call(this);this.entity.trigger?this.entity.trigger.disable():
this.entity.rigidbody&&this.entity.rigidbody.disableSimulation()},onLiveLinkUpdateTransform:function(a,b,c){if(this.enabled&&this.entity.enabled)this.system.onTransformChanged(this,a,b,c)},onBeforeRemove:function(a,b){this===b&&(a.off("livelink:updatetransform",this.onLiveLinkUpdateTransform,this),this.system.off("beforeremove",this.onBeforeRemove,this))}});return{CollisionComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.type="box";this.halfExtents=new pc.Vec3(0.5,0.5,0.5);this.radius=0.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1},pc.fw.ComponentData);return{CollisionComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="ballsocketjoint";a.systems.add(this.id,this);this.ComponentType=pc.fw.BallSocketJointComponent;this.DataType=pc.fw.BallSocketJointComponentData;this.schema=[{name:"pivot",displayName:"Pivot",description:"Local space pivot",type:"vector",options:{min:0,step:0.1},defaultValue:[0,0,0]},{name:"position",displayName:"Position",description:"World space joint position",type:"vector",options:{min:0,step:0.1},defaultValue:[0,0,0]},{name:"tau",displayName:"Tau",
description:"TBD",type:"number",defaultValue:0.001,options:{min:0,max:1}},{name:"damping",displayName:"Damping",description:"Damping",type:"number",defaultValue:1,options:{min:0,max:1}},{name:"impulseClamp",displayName:"Impulse Clamp",description:"Impulse Clamp",type:"number",defaultValue:0,options:{min:0,max:100}},{name:"constraint",exposed:!1}];this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,
this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype=pc.extend(d.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.fw.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){"undefined"!==typeof Ammo&&a.entity.rigidbody&&(b.pivot&&"array"===pc.type(b.pivot)&&(b.pivot=new pc.Vec3(b.pivot[0],b.pivot[1],b.pivot[2])),b.position&&"array"===pc.type(b.position)&&(b.position=new pc.Vec3(b.position[0],b.position[1],b.position[2])),c=new Ammo.btVector3(b.pivot.x,
b.pivot.y,b.pivot.z),b.constraint=new Ammo.btPoint2PointConstraint(a.entity.rigidbody.body,c),c=b.constraint.getPivotInB(),b.position=[c.x(),c.y(),c.z()],this.context.systems.rigidbody.addConstraint(b.constraint));c="constraint pivot position tau damping impulseClamp".split(" ");d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){return this.addComponent(b,{pivot:[a.ballsocketjoint.pivot.x,a.ballsocketjoint.pivot.y,a.ballsocketjoint.pivot.z],position:[a.ballsocketjoint.position.x,
a.ballsocketjoint.position.y,a.ballsocketjoint.position.z],tau:a.ballsocketjoint.tau,damping:a.ballsocketjoint.damping,impulseClamp:a.ballsocketjoint.impulseClamp})},onRemove:function(a,b){b.constraint&&this.context.systems.rigidbody.removeConstraint(b.constraint)},setDebugRender:function(a){this.debugRender=a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b;for(b in a);}});return{BallSocketJointComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_pivot",this.onSetPivot,this);this.on("set_position",this.onSetPosition,this);this.on("set_tau",this.onSetTau,this);this.on("set_damping",this.onSetDamping,this);this.on("set_impulseClamp",this.onSetImpulseClamp,this)},pc.fw.Component);pc.extend(d.prototype,{onSetPivot:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&(a=new Ammo.btVector3(c.x,c.y,c.z),this.data.constraint.setPivotA(a))},onSetPosition:function(a,
b,c){"undefined"!==typeof Ammo&&this.data.constraint&&(a=new Ammo.btVector3(c.x,c.y,c.z),this.data.constraint.setPivotB(a))},onSetTau:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_tau(c)},onSetDamping:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_damping(c)},onSetImpulseClamp:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_impulseClamp(c)}});
return{BallSocketJointComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.pivot=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.tau=0.3;this.damping=1;this.impulseClamp=0;this.constraint=null},pc.fw.ComponentData);return{BallSocketJointComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="particlesystem";this.description="Updates and renders particle system in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.fw.ParticleSystemComponent;this.DataType=pc.fw.ParticleSystemComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"autoPlay",displayName:"Auto Play",description:"Play automatically on start",type:"boolean",defaultValue:!0},
{name:"numParticles",displayName:"Particle Count",description:"Total number of particles allocated",type:"number",defaultValue:30,options:{min:1,max:4096,step:1}},{name:"lifetime",displayName:"Lifetime",description:"The lifetime of each particle in seconds",type:"number",defaultValue:5,options:{min:0,step:0.01}},{name:"rate",displayName:"Emission Rate",description:"Delay between emission of each particle in seconds",type:"number",defaultValue:0.1,options:{min:0,step:0.01}},{name:"rate2",displayName:"Emission Rate 2",
description:"Defines the random range of Emission Rate",type:"number",defaultValue:0.1,options:{min:0,step:0.01}},{name:"startAngle",displayName:"Start Angle",description:"The starting angle of each particle in degrees",type:"number",defaultValue:0,options:{min:0,step:0.01}},{name:"startAngle2",displayName:"Start Angle 2",description:"Defines the random range of Start Angle",type:"number",defaultValue:0,options:{min:0,step:0.01}},{name:"loop",displayName:"Loop",description:"Enables looping",type:"boolean",
defaultValue:!0},{name:"preWarm",displayName:"Pre Warm",description:"Starts particles in the middle of simulation",type:"boolean",defaultValue:!1,filter:{loop:!0}},{name:"lighting",displayName:"Lighting",description:"Enables particle lighting; Only ambient and directional lights are used",type:"boolean",defaultValue:!1},{name:"halfLambert",displayName:"Half-Lambert",description:"Uses Half-Lambert shading instead of Lambert, for softer lighting.",type:"boolean",defaultValue:!1,filter:{lighting:!0}},
{name:"intensity",displayName:"Color Intensity",description:"Controls the intensity of the colors for each particle",type:"number",defaultValue:1,options:{min:0,max:10,step:0.1}},{name:"depthWrite",displayName:"Depth Write",description:"Enables writing to depth buffer, therefore giving accurate occlusion between particles. Do not use it for semi-transparent particles",type:"boolean",defaultValue:!1},{name:"depthSoftening",displayName:"Depth Softening",description:"Softens particle intersections with scene geometry",
type:"number",defaultValue:0,options:{min:0,max:1,step:0.01}},{name:"sort",displayName:"Sorting Mode",description:"How to sort particles; Any value other than None will force CPU mode",type:"enumeration",options:{enumerations:[{name:"None",value:pc.scene.PARTICLESORT_NONE},{name:"Camera Distance",value:pc.scene.PARTICLESORT_DISTANCE},{name:"Newer First",value:pc.scene.PARTICLESORT_NEWER_FIRST},{name:"Older First",value:pc.scene.PARTICLESORT_OLDER_FIRST}]},defaultValue:0},{name:"blendType",displayName:"Blending Mode",
description:"How to blend particles",type:"enumeration",options:{enumerations:[{name:"Alpha",value:pc.scene.BLEND_NORMAL},{name:"Add",value:pc.scene.BLEND_ADDITIVE},{name:"Multiply",value:pc.scene.BLEND_MULTIPLICATIVE}]},defaultValue:pc.scene.BLEND_NORMAL},{name:"stretch",displayName:"Stretch",description:"Stretch particles in the direction of motion",type:"number",defaultValue:0,options:{min:0,step:0.01}},{name:"alignToMotion",displayName:"Align To Motion",description:"Rotates particles along the direction of motion",
type:"boolean",defaultValue:!1},{name:"spawnBounds",displayName:"Spawn Bounds",description:"Defines an AABB in which particles are allowed to spawn",type:"vector",defaultValue:[0,0,0]},{name:"wrap",displayName:"Wrap",description:"Set to true to wrap particles around the camera. Used for infinite atmospheric effect like rain or mist.",type:"boolean",defaultValue:!1},{name:"wrapBounds",displayName:"Wrap Bounds",description:"AABB around to camera to wrap particles. Used for infinite atmospheric effect like rain or mist.",
type:"vector",filter:{wrap:!0},defaultValue:[0,0,0]},{name:"colorMapAsset",displayName:"Color Map",description:"Color map used for each particle, with alpha channel",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"normalMapAsset",displayName:"Normal Map",description:"Normal map used for each particle",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"mesh",displayName:"Particle Mesh",description:"Mesh to use as particle; Will be quad, if not set",type:"asset",
options:{max:1,type:"model"},defaultValue:null},{name:"localVelocityGraph",displayName:"Local Velocity",description:"Curves that define the local velocity of particles over time.",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,0],[0,0],[0,0]],betweenCurves:!1},options:{curveNames:["X","Y","Z"],secondCurve:"localVelocityGraph2"}},{name:"localVelocityGraph2",displayName:"Local Velocity 2",description:"Curves that define the range of the Local Velocity",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,
keys:[[0,0],[0,0],[0,0]]},filter:{always:!1}},{name:"velocityGraph",displayName:"Velocity",description:"Curves that define the world velocity of particles over time.",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,-1],[0,-1],[0,-1]],betweenCurves:!0},options:{curveNames:["X","Y","Z"],secondCurve:"velocityGraph2"}},{name:"velocityGraph2",displayName:"Velocity 2",description:"Curves that define the range of the Velocity",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,
1],[0,1],[0,1]]},options:{curveNames:["X","Y","Z"]},filter:{always:!1}},{name:"rotationSpeedGraph",displayName:"Rotation Speed",description:"Curve that defines how fast particles rotate over time.",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0],betweenCurves:!1},options:{curveNames:["Angle"],secondCurve:"rotationSpeedGraph2",verticalAxisValue:360},filter:{alignToMotion:!1}},{name:"rotationSpeedGraph2",displayName:"Rotation Speed 2",description:"Curve that defines the range of Rotation Speed",
type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0]},options:{curveNames:["Angle"],verticalAxisValue:360},filter:{always:!1}},{name:"scaleGraph",displayName:"Scale",description:"Curve that defines the scale of particles over time",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0.1],betweenCurves:!1},options:{curveNames:["Scale"],verticalAxisValue:1,secondCurve:"scaleGraph2",min:0}},{name:"scaleGraph2",displayName:"Scale 2",description:"Curve that defines the range of Scale",
type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0.1]},options:{curveNames:["Scale"],verticalAxisValue:1,min:0},filter:{always:!1}},{name:"colorGraph",displayName:"Color",description:"Curves that define the color of particles over time",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,1],[0,1],[0,1]],betweenCurves:!1},options:{curveNames:["R","G","B"],max:1,min:0}},{name:"colorGraph2",displayName:"Color 2",description:"Curves that define the range of Color",exposed:!1,type:"curveset",
defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,1,1,1],[0,1,1,1],[0,1,1,1]]},options:{curveNames:["R","G","B"],max:1,min:0}},{name:"alphaGraph",displayName:"Opacity",description:"Curve that defines the opacity of particles over time",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,1],betweenCurves:!1},options:{curveNames:["Opacity"],max:1,min:0,secondCurve:"alphaGraph2"}},{name:"alphaGraph2",displayName:"Opacity 2",description:"Curve that defines the range of Opacity",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,
keys:[0,1]},options:{curveNames:["Opacity"],max:1,min:0},filter:{always:!1}},{name:"colorMap",exposed:!1},{name:"normalMap",exposed:!1}];this.exposeProperties();this.propertyTypes={};for(a=0;a<this.schema.length;a++){var b=this.schema[a];this.propertyTypes[b.name]=b.type}this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this);this.debugMesh=this._createDebugMesh();this.debugMaterial=new pc.scene.BasicMaterial;
this.debugMaterial.color=new pc.Color(1,0.5,0,1);this.debugMaterial.update()},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){var c=[],e=this.propertyTypes,g,f;for(f in b)b.hasOwnProperty(f)&&c.push(f),"vector"===e[f]?"array"===pc.type(b[f])&&(b[f]=new pc.Vec3(b[f][0],b[f][1],b[f][2])):"curve"===e[f]?b[f]instanceof pc.Curve||(g=b[f].type,b[f]=new pc.Curve(b[f].keys),b[f].type=g):"curveset"===e[f]&&!(b[f]instanceof pc.CurveSet)&&(g=b[f].type,b[f]=
new pc.CurveSet(b[f].keys),b[f].type=g);d._super.initializeComponentData.call(this,a,b,c);this._inTools&&this._createDebugShape(a)},cloneComponent:function(a,b){for(var c=a.particlesystem.data,d=this.schema,g={},f=0,k=d.length;f<k;f++){var h=d[f],l=c[h.name];l instanceof pc.Vec3||l instanceof pc.Curve||l instanceof pc.CurveSet?(l=l.clone(),g[h.name]=l):null!==l&&void 0!==l&&(g[h.name]=l)}return this.addComponent(b,g)},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=
b[c],g=d.entity,d=d.data;d.enabled&&g.enabled&&(g=d.model.emitter,d.paused||g.addTime(a))}},onToolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b];c.data.enabled&&c.entity.enabled&&this._updateDebugShape(c)}},onRemove:function(a,b){b.model&&(this.context.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null)},_createDebugMesh:function(){var a=this.context.graphicsDevice,b=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),
b=new pc.VertexBuffer(a,b,8);(new Float32Array(b.lock())).set([-0.5,-0.5,-0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,-0.5]);b.unlock();a=new pc.IndexBuffer(a,pc.INDEXFORMAT_UINT8,24);(new Uint8Array(a.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);a.unlock();var c=new pc.scene.Mesh;c.vertexBuffer=b;c.indexBuffer[0]=a;c.primitive[0].type=pc.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=a.getNumIndices();c.primitive[0].indexed=
!0;return c},_createDebugShape:function(a){var b=new pc.scene.GraphNode,c=new pc.scene.Model;c.graph=b;c.meshInstances=[new pc.scene.MeshInstance(b,this.debugMesh,this.debugMaterial)];a.data.debugShape=c;a.data.enabled&&a.entity.enabled&&(this.context.root.addChild(b),this.context.scene.addModel(c));return c},_updateDebugShape:function(a){var b=a.data.spawnBounds,c=b.x,d=b.y,b=b.z,g=a.entity,a=a.data.debugShape.graph;a.setPosition(g.getPosition());a.setRotation(g.getRotation());a.setLocalScale(2*
(c||5E-4),2*(d||5E-4),2*(b||5E-4))}});return{ParticleSystemComponentSystem:d}}());pc.extend(pc.fw,function(){var d=["spawnBounds","colorMap","normalMap","loop"],a="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite depthSoftening sort stretch alignToMotion preWarm".split(" "),b="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2".split(" "),c=function(){this.on("set_colorMapAsset",this.onSetColorMapAsset,
this);this.on("set_normalMapAsset",this.onSetNormalMapAsset,this);this.on("set_mesh",this.onSetMesh,this);this.on("set_loop",this.onSetLoop,this);this.on("set_blendType",this.onSetBlendType,this);d.forEach(function(a){this.on("set_"+a,this.onSetSimpleProperty,this)}.bind(this));a.forEach(function(a){this.on("set_"+a,this.onSetComplexProperty,this)}.bind(this));b.forEach(function(a){this.on("set_"+a,this.onSetGraphProperty,this)}.bind(this))},c=pc.inherits(c,pc.fw.Component);pc.extend(c.prototype,
{onSetColorMapAsset:function(a,b,c){c?this._loadAsset(c,function(a){this.colorMap=a}.bind(this)):this.colorMap=null},onSetNormalMapAsset:function(a,b,c){c?this._loadAsset(c,function(a){this.normalMap=a}.bind(this)):this.normalMap=null},_loadAsset:function(a,b){var c=a instanceof pc.asset.Asset?a:this.system.context.assets.getAssetById(a);if(c)if(c.resource)b(c.resource);else{var d={parent:this.entity.getRequest()};this.system.context.assets.load(c,[],d).then(function(a){b(a[0])})}else logERROR(pc.string.format("Trying to load particle system before asset {0} is loaded.",
a))},onSetMesh:function(a,b,c){c?c instanceof pc.asset.Asset||"number"===pc.type(c)?this._loadAsset(c,function(a){this._onMeshChanged(a)}.bind(this)):this._onMeshChanged(c):this._onMeshChanged(null)},_onMeshChanged:function(a){a&&(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onSetLoop:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetTime())},onSetBlendType:function(a,b,c){this.emitter&&
(this.emitter[a]=c,this.emitter.material.blendType=c,this.emitter.resetMaterial(),this.rebuild())},onSetSimpleProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial())},onSetComplexProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.reset(),this.emitter.resetMaterial(),this.rebuild())},onSetGraphProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){!this.emitter&&!this.system._inTools&&
(this.emitter=new pc.scene.ParticleEmitter(this.system.context.graphicsDevice,{numParticles:this.data.numParticles,spawnBounds:this.data.spawnBounds,wrap:this.data.wrap,wrapBounds:this.data.wrapBounds,lifetime:this.data.lifetime,rate:this.data.rate,rate2:this.data.rate2,startAngle:this.data.startAngle,startAngle2:this.data.startAngle2,scaleGraph:this.data.scaleGraph,scaleGraph2:this.data.scaleGraph2,colorGraph:this.data.colorGraph,colorGraph2:this.data.colorGraph2,alphaGraph:this.data.alphaGraph,
alphaGraph2:this.data.alphaGraph2,localVelocityGraph:this.data.localVelocityGraph,localVelocityGraph2:this.data.localVelocityGraph2,velocityGraph:this.data.velocityGraph,velocityGraph2:this.data.velocityGraph2,rotationSpeedGraph:this.data.rotationSpeedGraph,rotationSpeedGraph2:this.data.rotationSpeedGraph2,colorMap:this.data.colorMap,normalMap:this.data.normalMap,loop:this.data.loop,preWarm:this.data.preWarm,sort:this.data.sort,stretch:this.data.stretch,alignToMotion:this.data.alignToMotion,lighting:this.data.lighting,
halfLambert:this.data.halfLambert,intensity:this.data.intensity,depthSoftening:this.data.depthSoftening,scene:this.system.context.scene,mesh:this.data.mesh,depthWrite:this.data.depthWrite,node:this.entity,blendType:this.data.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new pc.scene.Model,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],this.data.model=this.psys,this.emitter.psys=this.psys,!this.data.loop&&!this.data.autoPlay&&
this.pause());this.data.model&&(this.system.context.scene.containsModel(this.data.model)||this.emitter.colorMap&&this.system.context.scene.addModel(this.data.model));this.data.debugShape&&!this.system.context.scene.containsModel(this.data.debugShape)&&(this.system.context.scene.addModel(this.data.debugShape),this.system.context.root.addChild(this.data.debugShape.graph));c._super.onEnable.call(this)},onDisable:function(){c._super.onDisable.call(this);this.data.model&&this.system.context.scene.containsModel(this.data.model)&&
this.system.context.scene.removeModel(this.data.model);this.data.debugShape&&(this.system.context.root.removeChild(this.data.debugShape.graph),this.system.context.scene.removeModel(this.data.debugShape))},reset:function(){this.stop();this.emitter.addTime(1E3);this.emitter.loop=this.data.loop;this.emitter.reset()},stop:function(){this.emitter.loop=!1;this.emitter.resetTime();this.emitter.addTime(0,!0)},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=
!1;this.emitter.loop=this.data.loop;this.emitter.resetTime()},isPlaying:function(){return this.data.paused?!1:this.emitter.loop?!0:Date.now()<=this.emitter.endTime},rebuild:function(){var a=this.enabled;this.enabled=!1;this.emitter.rebuild();this.emitter.meshInstance.node=this.entity;this.data.model.meshInstances=[this.emitter.meshInstance];this.enabled=a}});return{ParticleSystemComponent:c}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.rate=this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.spawnBounds=new pc.Vec3;this.wrapBounds=new pc.Vec3;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;this.sort=0;this.mode=pc.scene.PARTICLEMODE_GPU;this.scene=null;this.halfLambert=this.lighting=!1;this.intensity=1;this.stretch=0;this.alignToMotion=!1;this.depthSoftening=0;this.mesh=
null;this.depthWrite=!1;this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=pc.scene.BLEND_NORMAL;this.model=null;this.enabled=!0;this.paused=!1;this.debugShape=null},pc.fw.ComponentData);return{ParticleSystemComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this._destinations=[];this._callbacks={};this._linkid=(a||"")+"-"+pc.guid.create();this._listener=null;this._handler=this._handleMessage.bind(this);window.addEventListener("message",this._handler,!1);pc.livelinks||(pc.livelinks=[]);pc.livelinks.push(this)};d.prototype.detach=function(){this._listener=null;window.removeEventListener("message",this._handler,!1)};d.prototype.addDestinationWindow=function(a){this._destinations.push(a)};d.prototype.removeDestinationWindow=
function(a){var b;for(b=0;b<this._destinations.length;++b)if(this._destinations[b]==a){this._destinations.splice(b,1);break}};d.prototype.send=function(a,b,c){var b=b||function(){},c=c||this._destinations,d,g=c.length,f=[];for(d=0;d<g;d++){var k=c[d];k.closed?f.push(k):this._send(a,b,k,k.location.protocol+"//"+k.location.host)}g=f.length;for(d=0;d<g;d++)this.removeDestinationWindow(f[d])};d.prototype._send=function(a,b,c,d){a.senderid=this._linkid;this._callbacks[a.id]?this._callbacks[a.id].count++:
this._callbacks[a.id]={count:1,callback:b?b.bind(this):function(){}};var g=pc.fw.LiveLinkMessage.serialize(a);c===window?pc.livelinks.forEach(function(a){a._handleMessage({source:window,data:g})}):c.postMessage(g,d)};d.prototype.listen=function(a){if(this._listener)throw Error("LiveLink already listening");this._listener=a};d.prototype._handleMessage=function(a){var b,c;if(b=pc.fw.LiveLinkMessage.deserialize(a.data))b=new pc.fw.LiveLinkMessage(b,a.source),this._linkid!==b.senderid&&(b.type==pc.fw.LiveLinkMessageType.RECEIVED?
b.content.received_from==this._linkid&&(this._callbacks[b.content.id].count--,0===this._callbacks[b.content.id].count&&(this._callbacks[b.content.id].callback(),delete this._callbacks[b.content.id])):this._listener&&(this._listener(b),c=new pc.fw.LiveLinkMessage,c.type=pc.fw.LiveLinkMessageType.RECEIVED,c.content={id:b.id,received_from:b.senderid},this._send(c,null,a.source,a.origin)))};return{LiveLink:d}}());pc.extend(pc.fw,function(){var d=function(a,b){a=a||{};this.type=a.type||pc.fw.LiveLinkMessageType.NO_TYPE;this.content=a.content||{};this.id=a.id||pc.guid.create();this.senderid=a.senderid||null;this.source=b||null};d.register=function(a){pc.fw.LiveLinkMessageType[a]=a};d.serialize=function(a){return JSON.stringify({type:a.type,content:a.content,id:a.id,senderid:a.senderid},function(a){return this[a]instanceof Float32Array?pc.makeArray(this[a]):this[a]})};d.deserialize=function(a){try{return JSON.parse(a)}catch(b){return null}};
return{LiveLinkMessage:d,LiveLinkMessageRegister:{},LiveLinkMessageType:{NO_TYPE:"NO_TYPE",RECEIVED:"RECEIVED"}}}());pc.extend(pc.fw,function(){var d=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.UPDATE_COMPONENT;this.content={id:a,component:b,attribute:c,value:d}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_COMPONENT");return{LiveLinkUpdateComponentMessage:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY;this.content={id:a,components:b}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY");var a=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_TRANSFORM;this.content={id:a,position:b,rotation:c,scale:d}},a=pc.inherits(a,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_TRANSFORM");var b=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_NAME;
this.content={id:a,name:b}},b=pc.inherits(b,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_NAME");var c=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_ENABLED;this.content={id:a,enabled:b}},c=pc.inherits(c,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_ENABLED");var e=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.REPARENT_ENTITY;this.content={id:a,oldParentId:b,newParentId:c,index:d}},e=pc.inherits(e,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("REPARENT_ENTITY");
return{LiveLinkUpdateEntityMessage:d,LiveLinkUpdateEntityNameMessage:b,LiveLinkUpdateEntityEnabledMessage:c,LiveLinkUpdateEntityTransformMessage:a,LiveLinkReparentEntityMessage:e}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.CLOSE_ENTITY;this.content={id:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("CLOSE_ENTITY");return{LiveLinkCloseEntityMessage:d}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.OPEN_ENTITY;this.content={entity:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("OPEN_ENTITY");var a=function(a,c){this.type=pc.fw.LiveLinkMessageType.OPEN_PACK;this.content={pack:pc.extend({},c.getData())};this.content.pack.hierarchy=PCD.model.Entity.toData(a)},a=pc.inherits(a,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("OPEN_PACK");return{LiveLinkOpenEntityMessage:d,LiveLinkOpenPackMessage:a}}());pc.extend(pc.fw,function(){var d=function(a,b,c){this.type=pc.fw.LiveLinkMessageType.UPDATE_ASSET;this.content={id:a,attribute:b,value:c}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ASSET");return{LiveLinkUpdateAssetMessage:d}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.UPDATE_PACK_SETTINGS;this.content={settings:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_PACK_SETTINGS");return{LiveLinkUpdatePackSettings:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ASSETCACHE;this.content={assets:a,deleted:b}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ASSETCACHE");return{LiveLinkUpdateAssetCacheMessage:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this._guid=pc.guid.create();this._batchHandle=null;this.c={};pc.events.attach(this)},pc.scene.GraphNode);d.prototype.getGuid=function(){return this._guid};d.prototype.setGuid=function(a){this._guid=a};d.prototype._onHierarchyStateChanged=function(a){pc.fw.Entity._super._onHierarchyStateChanged.call(this,a);var b,c=this.c;for(type in c)if(c.hasOwnProperty(type)&&(b=c[type],b.enabled))if(a)b.onEnable();else b.onDisable()};d.prototype.setRequest=
function(a){this._request=a};d.prototype.getRequest=function(){return this._request};d.prototype.addChild=function(a){if(a instanceof pc.fw.Entity&&this.getRoot().findOne("getGuid",a.getGuid()))throw Error("GUID already exists in graph");pc.scene.GraphNode.prototype.addChild.call(this,a)};d.prototype.findByGuid=function(a){if(this._guid===a)return this;for(var b=0;b<this._children.length;b++)if(this._children[b].findByGuid){var c=this._children[b].findByGuid(a);if(null!==c)return c}return null};d.prototype.destroy=
function(){var a=this.getParent(),b;for(b in this.c)this.c[b].enabled=!1;for(b in this.c)this.c[b].system.removeComponent(this);a&&a.removeChild(this);a=this.getChildren();for(b=a.shift();b;)b instanceof pc.fw.Entity&&b.destroy(),b=a.shift()};d.prototype.clone=function(){var a,b=new pc.fw.Entity;pc.fw.Entity._super._cloneInternal.call(this,b);for(a in this.c)this.c[a].system.cloneComponent(this,b);for(a=0;a<this.getChildren().length;a++){var c=this.getChildren()[a];c instanceof pc.fw.Entity&&b.addChild(c.clone())}return b};
d.deserialize=function(a){var b=pc.json.parse(a.template),c=pc.json.parse(a.parent),d=pc.json.parse(a.children),g=pc.json.parse(a.transform),f=pc.json.parse(a.components),k=pc.json.parse(a.labels);return{_id:a._id,resource_id:a.resource_id,_rev:a._rev,name:a.name,enabled:a.enabled,labels:k,template:b,parent:c,children:d,transform:g,components:f}};d.serialize=function(a){var b={_id:a._id,resource_id:a.resource_id,name:a.name,enabled:a.enabled,labels:pc.json.stringify(a.labels),template:pc.json.stringify(a.template),
parent:pc.json.stringify(a.parent),children:pc.json.stringify(a.children),transform:pc.json.stringify(a.transform),components:pc.json.stringify(a.components)};a._rev&&(b._rev=a._rev);return b};return{Entity:d}}());pc.asset={};
pc.extend(pc.asset,function(){var d=-1,a=function(a,c,e,g,f){this._id=++d;this.name=a;this.type=c;this._file=e?{filename:e.filename,size:e.size,hash:e.hash,url:e.url}:null;this._data=g||{};this.prefix=f||"";this.resource=null;pc.events.attach(this)};a.prototype={getFileUrl:function(){if(!this.file)return null;var a=this.file.url,c="";this.prefix&&(c=this.prefix);return pc.path.join(c,a)}};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},set:function(a){this._id=a;a>d&&(d=a)}});
Object.defineProperty(a.prototype,"file",{get:function(){return this._file},set:function(a){var c=this._file;((this._file=a)&&!c||!a&&c||a&&c&&a.hash!==c.hash)&&this.fire("change",this,"file",a,c)}});Object.defineProperty(a.prototype,"data",{get:function(){return this._data},set:function(a){var c=this._data;this._data=a;a!==c&&this.fire("change",this,"data",a,c)}});return{Asset:a,ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",
ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap"}}());pc.extend(pc.asset,function(){var d=function(a,b){if(!a)throw Error("Must provide a ResourceLoader instance for AssetRegistry");this.loader=a;this._prefix=b||"";this._cache={};this._names={};this._urls={};this._groups={}};d.prototype={addGroup:function(a,b){this._groups[a]||(this._groups[a]=[]);for(var c in b.assets){var d=this.getAssetById(c);d?pc.extend(d,b.assets[c]):d=this.createAndAddAsset(c,b.assets[c]);this._groups[a].push(d.id)}},createAndAddAsset:function(a,b){var c=new pc.asset.Asset(b.name,
b.type,b.file,b.data,this._prefix);c.id=a;this.addAsset(c);c.file&&this.loader.registerHash(c.file.hash,c.getFileUrl());return c},all:function(){return Object.keys(this._cache).map(function(a){return this.getAssetById(a)},this)},list:function(a){if(a){if(this._groups[a])return this._groups[a].map(function(a){return this.getAssetById(a)},this)}else return Object.keys(this._cache).map(function(a){return this.getAssetById(a)},this)},addAsset:function(a){this._cache[a.id]=a;this._names[a.name]||(this._names[a.name]=
[]);this._names[a.name].push(a.id);a.file&&(this._urls[a.getFileUrl()]=a.id,a.on("change",this._onAssetChanged,this))},removeAsset:function(a){delete this._cache[a.id];delete this._names[a.name];a.file&&(a.off("change",this._onAssetChanged,this),delete this._urls[a.file.url])},_onAssetChanged:function(a,b,c,d){if("file"===b&&(d&&(b=a.prefix?pc.path.join(a.prefix,d.url):d.url,delete this._urls[b],this.loader.removeFromCache(b),this.loader.unregisterHash(b)),c)){b=a.getFileUrl();this._urls[b]=a.id;
this.loader.registerHash(c.hash,b);var g=a.resource;this.load([a]).then(function(b){a.fire("change",a,"resource",b[0],g)})}},findAll:function(a,b){var c=this,d=this._names[a];return d?(d=d.map(function(a){return c._cache[a]}),b?d.filter(function(a){return a.type===b}):d):[]},find:function(a,b){var c=this.findAll(a,b);return c?c[0]:null},getAssetByResourceId:function(a){console.warn("WARNING: getAssetByResourceId: Function is deprecated. Use getAssetById() instead.");return this._cache[a]},getAssetById:function(a){return this._cache[a]},
getAssetByUrl:function(a){return this._cache[this._urls[a]]},getAssetByName:function(a){console.warn("WARNING: getAssetByName: Function is deprecated. Use find() or findAll() instead.");return this.find(a)},load:function(a,b,c){a&&"array"!==pc.type(a)&&(a=[a]);void 0===c&&(c=b,b=[]);var d=[];a.forEach(function(a,c){this.getAssetById(a.id)||this.addAsset(a);switch(a.type){case pc.asset.ASSET_MODEL:d.push(this._createModelRequest(a));break;case pc.asset.ASSET_TEXTURE:d.push(this._createTextureRequest(a,
b[c]));break;case pc.asset.ASSET_CUBEMAP:d.push(this._createCubemapRequest(a,b[c]));break;case pc.asset.ASSET_MATERIAL:d.push(this._createMaterialRequest(a));break;default:d.push(this._createAssetRequest(a))}},this);return this.loader.request(d.filter(function(a){return null!==a}),c).then(function(b){return new pc.promise.Promise(function(c){var k=0;d.forEach(function(c,d){c&&(a[d].resource=b[k++])});c(b)})},function(a){setTimeout(function(){throw a;},0)})},loadFromUrl:function(a,b){if(!b)throw Error("type required");
if("model"===b)return this._loadModel(a);pc.path.getDirectory(a);var c=pc.path.getBasename(a).replace(".json",""),d=new pc.asset.Asset(c,b,{url:a});return new pc.promise.Promise(function(a){this.load(d).then(function(b){a({resource:b,asset:d})})}.bind(this))},_loadModel:function(a){var b=this,c=pc.path.getDirectory(a),d=pc.path.getBasename(a),g=d.replace(".json",""),d=pc.path.join(c,d.replace(".json",".mapping.json")),f=new pc.asset.Asset(g,"model",{url:a}),k=new pc.asset.Asset(g+".mapping","json",
{url:d});return new pc.promise.Promise(function(a){b.load([f,k]).then(function(d){var e=d[0],d=d[1];f.data=d;var g=[];d.mapping.forEach(function(a){g.push(new pc.asset.Asset(pc.path.getBasename(a.path),"material",{url:pc.path.join(c,a.path)}))});if(g.length)return d=b.load(g),d.then(function(b){for(var c=0,d=e.meshInstances.length;c<d;c++)e.meshInstances[c].material=b[c];a({resource:e,asset:f})}),d;a({resource:e,asset:f})})})},_createAssetRequest:function(a){var b=a.getFileUrl();return b?this.loader.createFileRequest(b,
a.type):null},_createModelRequest:function(a){var b=a.getFileUrl();return new pc.resources.ModelRequest(b,a.data&&a.data.mapping?a.data.mapping:[])},_createTextureRequest:function(a,b){return new pc.resources.TextureRequest(a.getFileUrl(),null,b)},_createCubemapRequest:function(a,b){var c=a.getFileUrl();return c?new pc.resources.CubemapRequest(c,null,b):new pc.resources.CubemapRequest("asset://"+a.id,null,b)},_createMaterialRequest:function(a){var b=a.getFileUrl();return b?new pc.resources.MaterialRequest(b):
new pc.resources.MaterialRequest("asset://"+a.id)}};return{AssetRegistry:d}}());!function(d){var a,b,c={},e={};a=function(a,b,d){c[a]={deps:b,callback:d}};b=function(a){function d(b){if("."!==b.charAt(0))return b;for(var b=b.split("/"),c=a.split("/").slice(0,-1),e=0,f=b.length;f>e;e++){var h=b[e];".."===h?c.pop():"."!==h&&c.push(h)}return c.join("/")}if(e[a])return e[a];if(e[a]={},!c[a])throw Error("Could not find module "+a);for(var k,h=c[a],l=h.deps,h=h.callback,n=[],r=0,m=l.length;m>r;r++)n.push("exports"===l[r]?k={}:b(d(l[r])));l=h.apply(this,n);return e[a]=k||l};b.entries=
c;!0;a("rsvp/all-settled",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isArray,n=b.isNonThenable;c["default"]=function(a,b){return new d(function(b){function c(a){return function(b){g(a,{state:"fulfilled",value:b})}}function f(a){return function(b){g(a,{state:"rejected",reason:b})}}function g(a,c){A[a]=c;0===--m&&b(A)}if(!e(a))throw new TypeError("You must pass an array to allSettled.");var k,m=a.length;if(0===m)return void b([]);for(var A=Array(m),x=0;x<a.length;x++)k=
a[x],n(k)?g(x,{state:"fulfilled",value:k}):d.resolve(k).then(c(x),f(x))},b)}});a("rsvp/all",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.all(a,b)}});a("rsvp/asap",["exports"],function(a){function b(){for(var a=0;a<d.length;a++){var c=d[a];(0,c[0])(c[1])}d.length=0}a["default"]=function(a,b){1===d.push([a,b])&&c()};var c,a="undefined"!=typeof window?window:{},a=a.MutationObserver||a.WebKitMutationObserver,d=[];if("undefined"!=typeof process&&"[object process]"===
{}.toString.call(process))a=function(){process.nextTick(b)};else if(a)var e=0,a=new a(b),n=document.createTextNode(""),a=(a.observe(n,{characterData:!0}),function(){n.data=e=++e%2});else a=function(){setTimeout(b,1)};c=a});a("rsvp/config",["./events","exports"],function(a,b){var c={instrument:!1};a["default"].mixin(c);b.config=c;b.configure=function(a,b){return"onerror"===a?void c.on("error",b):2!==arguments.length?c[a]:void(c[a]=b)}});a("rsvp/defer",["./promise","exports"],function(a,b){var c=a["default"];
b["default"]=function(a){var b={};return b.promise=new c(function(a,c){b.resolve=a;b.reject=c},a),b}});a("rsvp/events",["exports"],function(a){function b(a,c){for(var d=0,e=a.length;e>d;d++)if(a[d]===c)return d;return-1}function c(a){var b=a._promiseCallbacks;return b||(b=a._promiseCallbacks={}),b}a["default"]={mixin:function(a){return a.on=this.on,a.off=this.off,a.trigger=this.trigger,a._promiseCallbacks=void 0,a},on:function(a,d){var e,g=c(this);(e=g[a])||(e=g[a]=[]);-1===b(e,d)&&e.push(d)},off:function(a,
d){var e,g,m=c(this);return d?(e=m[a],g=b(e,d),void(-1!==g&&e.splice(g,1))):void(m[a]=[])},trigger:function(a,b){var d;if(d=c(this)[a])for(var e=0;e<d.length;e++)(0,d[e])(b)}}});a("rsvp/filter",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isFunction;c["default"]=function(a,b,c){return d.all(a,c).then(function(a){if(!e(b))throw new TypeError("You must pass a function as filter's second argument.");for(var f=a.length,g=Array(f),k=0;f>k;k++)g[k]=b(a[k]);return d.all(g,c).then(function(b){for(var c=
Array(f),d=0,e=0;f>e;e++)!0===b[e]&&(c[d]=a[e],d++);return c.length=d,c})})}});a("rsvp/hash-settled",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isNonThenable,n=b.keysOf;c["default"]=function(a){return new d(function(b){function c(a){return function(b){g(a,{state:"fulfilled",value:b})}}function f(a){return function(b){g(a,{state:"rejected",reason:b})}}function g(a,c){v[a]=c;0===--x&&b(v)}var k,s,v={},A=n(a),x=A.length;if(0===x)return void b(v);for(var E=0;E<A.length;E++)s=
A[E],k=a[s],e(k)?g(s,{state:"fulfilled",value:k}):d.resolve(k).then(c(s),f(s))})}});a("rsvp/hash",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isNonThenable,n=b.keysOf;c["default"]=function(a){return new d(function(b,c){function f(a){return function(c){v[a]=c;0===--x&&b(v)}}function g(a){x=0;c(a)}var k,s,v={},A=n(a),x=A.length;if(0===x)return void b(v);for(var E=0;E<A.length;E++)s=A[E],k=a[s],e(k)?(v[s]=k,0===--x&&b(v)):d.resolve(k).then(f(s),g)})}});a("rsvp/instrument",
["./config","./utils","exports"],function(a,b,c){var d=a.config,e=b.now;c["default"]=function(a,b,c){try{d.trigger(a,{guid:b._guidKey+b._id,eventName:a,detail:b._detail,childGuid:c&&b._guidKey+c._id,label:b._label,timeStamp:e(),stack:Error(b._label).stack})}catch(f){setTimeout(function(){throw f;},0)}}});a("rsvp/map",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=(b.isArray,b.isFunction);c["default"]=function(a,b,c){return d.all(a,c).then(function(a){if(!e(b))throw new TypeError("You must pass a function as map's second argument.");
for(var f=a.length,g=Array(f),k=0;f>k;k++)g[k]=b(a[k]);return d.all(g,c)})}});a("rsvp/node",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isArray;c["default"]=function(a,b){function c(){for(var e=arguments.length,k=Array(e),l=0;e>l;l++)k[l]=arguments[l];var m;return f||g||!b?m=this:(console.warn('Deprecation: RSVP.denodeify() doesn\'t allow setting the "this" binding anymore. Use yourFunction.bind(yourThis) instead.'),m=b),d.all(k).then(function(c){return new d(function(d,
e){c.push(function(){for(var a=arguments.length,c=Array(a),h=0;a>h;h++)c[h]=arguments[h];a=c[0];h=c[1];if(a)e(a);else if(f)d(c.slice(1));else if(g){for(var a={},k=c.slice(1),h=0;h<b.length;h++)c=b[h],a[c]=k[h];d(a)}else d(h)});a.apply(m,c)})})}var f=!0===b,g=e(b);return c.__proto__=a,c}});a("rsvp/promise","./config ./events ./instrument ./utils ./promise/cast ./promise/all ./promise/race ./promise/resolve ./promise/reject exports".split(" "),function(a,b,c,d,e,n,r,m,w,u){function F(){}function z(a,
b){if(!C(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof z))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._id=J++;this._label=b;this._subscribers=[];y.instrument&&B("created",this);if(F!==a){var c=this,d=function(a){x(c,a)},e=function(a){D(c,a)};try{a(d,e)}catch(f){e(f)}}}function s(a,b){var c,d,e=a._subscribers,f=a._detail;
y.instrument&&B(b===P?"fulfilled":"rejected",a);for(var g=0;g<e.length;g+=3)c=e[g],d=e[g+b],v(b,c,d,f);a._subscribers=null}function v(a,b,c,d){var e,f,g,h,k=C(c);if(k)try{e=c(d),g=!0}catch(l){h=!0,f=l}else e=d,g=!0;A(b,e)||(k&&g?x(b,e):h?D(b,f):a===P?x(b,e):a===Q&&D(b,e))}function A(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(H(b)&&(d=b.then,C(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?x(a,d):E(a,d)))},function(b){return c?
!0:(c=!0,void D(a,b))},"Settle: "+(a._label||" unknown promise")),!0}catch(e){return c?!0:(D(a,e),!0)}return!1}function x(a,b){a===b?E(a,b):A(a,b)||E(a,b)}function E(a,b){a._state===G&&(a._state=K,a._detail=b,y.async(I,a))}function D(a,b){a._state===G&&(a._state=K,a._detail=b,y.async(M,a))}function I(a){s(a,a._state=P)}function M(a){a._onerror&&a._onerror(a._detail);s(a,a._state=Q)}var y=a.config,B=(b["default"],c["default"]),H=d.objectOrFunction,C=d.isFunction,a=d.now,e=e["default"],n=n["default"],
r=r["default"],m=m["default"],w=w["default"],a="rsvp_"+a()+"-",J=0;u["default"]=z;z.cast=e;z.all=n;z.race=r;z.resolve=m;z.reject=w;var G=void 0,K=0,P=1,Q=2;z.prototype={constructor:z,_id:void 0,_guidKey:a,_label:void 0,_state:void 0,_detail:void 0,_subscribers:void 0,_onerror:function(a){y.trigger("error",a)},then:function(a,b,c){var d=this;this._onerror=null;var e=new this.constructor(F,c);if(this._state){var f=arguments;y.async(function(){v(d._state,e,f[d._state-1],d._detail)})}else{var g=this._subscribers,
h=g.length;g[h]=e;g[h+P]=a;g[h+Q]=b}return y.instrument&&B("chained",d,e),e},"catch":function(a,b){return this.then(null,a,b)},"finally":function(a,b){var c=this.constructor;return this.then(function(b){return c.resolve(a()).then(function(){return b})},function(b){return c.resolve(a()).then(function(){throw b;})},b)}}});a("rsvp/promise/all",["../utils","exports"],function(a,b){var c=a.isArray,d=a.isNonThenable;b["default"]=function(a,b){var e=this;return new e(function(b,f){function g(a){return function(c){v[a]=
c;0===--s&&b(v)}}function n(a){s=0;f(a)}if(!c(a))throw new TypeError("You must pass an array to all.");var z,s=a.length,v=Array(s);if(0===s)return void b(v);for(var A=0;A<a.length;A++)z=a[A],d(z)?(v[A]=z,0===--s&&b(v)):e.resolve(z).then(g(A),n)},b)}});a("rsvp/promise/cast",["exports"],function(a){a["default"]=function(a,b){return a&&"object"==typeof a&&a.constructor===this?a:new this(function(b){b(a)},b)}});a("rsvp/promise/race",["../utils","exports"],function(a,b){var c=a.isArray,d=(a.isFunction,
a.isNonThenable);b["default"]=function(a,b){var e,f=this;return new f(function(b,g){function n(a){s&&(s=!1,b(a))}function z(a){s&&(s=!1,g(a))}if(!c(a))throw new TypeError("You must pass an array to race.");for(var s=!0,v=0;v<a.length;v++){if(e=a[v],d(e))return s=!1,void b(e);f.resolve(e).then(n,z)}},b)}});a("rsvp/promise/reject",["exports"],function(a){a["default"]=function(a,b){return new this(function(b,c){c(a)},b)}});a("rsvp/promise/resolve",["exports"],function(a){a["default"]=function(a,b){return a&&
"object"==typeof a&&a.constructor===this?a:new this(function(b){b(a)},b)}});a("rsvp/race",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.race(a,b)}});a("rsvp/reject",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.reject(a,b)}});a("rsvp/resolve",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.resolve(a,b)}});a("rsvp/rethrow",["exports"],function(a){a["default"]=function(a){throw setTimeout(function(){throw a;
}),a;}});a("rsvp/utils",["exports"],function(a){function b(a){return"function"==typeof a||"object"==typeof a&&null!==a}a.objectOrFunction=b;a.isFunction=function(a){return"function"==typeof a};a.isNonThenable=function(a){return!b(a)};a.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};a.now=Date.now||function(){return(new Date).getTime()};a.keysOf=Object.keys||function(a){var b=[],c;for(c in a)b.push(c);return b}});a("rsvp","./rsvp/promise ./rsvp/events ./rsvp/node ./rsvp/all ./rsvp/all-settled ./rsvp/race ./rsvp/hash ./rsvp/hash-settled ./rsvp/rethrow ./rsvp/defer ./rsvp/config ./rsvp/map ./rsvp/resolve ./rsvp/reject ./rsvp/filter ./rsvp/asap exports".split(" "),
function(a,b,c,d,e,n,r,m,w,u,F,z,s,v,A,x,E){function D(){I.on.apply(I,arguments)}var a=a["default"],b=b["default"],c=c["default"],d=d["default"],e=e["default"],n=n["default"],r=r["default"],m=m["default"],w=w["default"],u=u["default"],I=F.config,F=F.configure,z=z["default"],s=s["default"],v=v["default"],A=A["default"];if(I.async=x["default"],"undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){x=window.__PROMISE_INSTRUMENTATION__;F("instrument",!0);for(var M in x)x.hasOwnProperty(M)&&
D(M,x[M])}E.Promise=a;E.EventTarget=b;E.all=d;E.allSettled=e;E.race=n;E.hash=r;E.hashSettled=m;E.rethrow=w;E.defer=u;E.denodeify=c;E.configure=F;E.on=D;E.off=function(){I.off.apply(I,arguments)};E.resolve=s;E.reject=v;E.async=function(a,b){I.async(a,b)};E.map=z;E.filter=A});d.RSVP=b("rsvp")}(window);pc.promise={Promise:window.RSVP.Promise,all:window.RSVP.all};
