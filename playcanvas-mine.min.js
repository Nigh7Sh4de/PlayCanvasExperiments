/*
 PlayCanvas Engine v0.160.0-dev
 revision 2018aae

 http://playcanvas.com
 Copyright 2011-2014 PlayCanvas Ltd. All rights reserved.
 Do not distribute.
 Contains: https://github.com/tildeio/rsvp.js - see page for license information
*/
var pc={config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(d){var a,b=[],c=d.length;for(a=0;a<c;++a)b.push(d[a]);return b},type:function(d){if(null===d)return"null";var a=typeof d;return"undefined"==a||"number"==a||"string"==a||"boolean"==a?a:_typeLookup[Object.prototype.toString.call(d)]},extend:function(d,a){var b,c;for(b in a)c=a[b],d[b]="object"==pc.type(c)?pc.extend({},c):
"array"==pc.type(c)?pc.extend([],c):c;return d},isDefined:function(d){return void 0!==d}},_typeLookup=function(){var d={},a,b="Array Object Function Date RegExp Float32Array".split(" ");for(a=0;a<b.length;++a)d["[object "+b[a]+"]"]=b[a].toLowerCase();return d}();"undefined"!==typeof exports&&(exports.pc=pc);(function(){if("undefined"!==typeof document){var d=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenchange",!0,!1,null);document.dispatchEvent(a)},a=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitfullscreenchange",d,!1);document.addEventListener("mozfullscreenchange",d,!1);document.addEventListener("MSFullscreenChange",d,!1);document.addEventListener("webkitfullscreenerror",
a,!1);document.addEventListener("mozfullscreenerror",a,!1);document.addEventListener("MSFullscreenError",a,!1);Element.prototype.requestFullscreen=Element.prototype.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen||function(){};document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;document.fullscreenElement||
Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}});document.fullscreenEnabled||Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,get:function(){return document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}})();(function(d){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!d.requestAnimationFrame;++c)d.requestAnimationFrame=d[b[c]+"RequestAnimationFrame"],d.cancelAnimationFrame=d[b[c]+"CancelAnimationFrame"]||d[b[c]+"CancelRequestAnimationFrame"];d.requestAnimationFrame||(d.requestAnimationFrame=function(b){var c=(new Date).getTime(),f=Math.max(0,16-(c-a)),h=d.setTimeout(function(){b(c+f)},f);a=c+f;return h});d.cancelAnimationFrame||(d.cancelAnimationFrame=function(a){clearTimeout(a)});d.requestAnimFrame=
d.requestAnimationFrame})("undefined"===typeof exports?this:exports);pc.extend(pc,function(){var d=function(){this.data=new Float32Array(4);3<=arguments.length?(this.data[0]=arguments[0],this.data[1]=arguments[1],this.data[2]=arguments[2],this.data[3]=4<=arguments.length?arguments[3]:1):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=1)};d.prototype={clone:function(){return new pc.Color(this.r,this.g,this.b,this.a)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},set:function(a,b,c,e){var g=this.data;g[0]=a;
g[1]=b;g[2]=c;g[3]="undefined"===typeof e?1:e;return this},fromString:function(a){var b=parseInt(a.replace("#","0x"));7<a.length?a=pc.math.intToBytes32(b):(a=pc.math.intToBytes24(b),a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return this},toString:function(a){var b="#"+(16777216+(parseInt(255*this.r)<<16)+(parseInt(255*this.g)<<8)+parseInt(255*this.b)).toString(16).slice(1);!0===a&&(a=parseInt(255*this.a).toString(16),b=this.a<16/255?b+("0"+a):b+a);return b}};Object.defineProperty(d.prototype,
"r",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"g",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(d.prototype,"b",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d.prototype,"a",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});return{Color:d}}());pc.guid=function(){return{create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var a=16*Math.random()|0;return("x"==d?a:a&3|8).toString(16)})}}}();pc.time=function(){var d=function(){this._isRunning=!1;this._b=this._a=0};d.prototype.start=function(){this._isRunning=!0;this._a=(new Date).getTime()};d.prototype.stop=function(){this._isRunning=!1;this._b=(new Date).getTime()};d.prototype.getMilliseconds=function(){return this._b-this._a};return{Timer:d,now:function(){return(new Date).getTime()}}}();pc.extend(pc,function(){return{createURI:function(d){var a="";if((d.authority||d.scheme)&&(d.host||d.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(d.host&&d.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(d.path&&d.hostpath)throw Error("Can't have 'path' and 'hostpath' option");d.scheme&&(a+=d.scheme+":");d.authority&&(a+="//"+d.authority);d.host&&(a+=d.host);d.path&&(a+=d.path);d.hostpath&&(a+=d.hostpath);d.query&&(a+="?"+d.query);
d.fragment&&(a+="#"+d.fragment);return a},URI:function(d){d=d.match(/^(([^:\/?\#]+):)?(\/\/([^\/?\#]*))?([^?\#]*)(\?([^\#]*))?(\#(.*))?/);this.scheme=d[2];this.authority=d[4];this.path=d[5];this.query=d[7];this.fragment=d[9];this.toString=function(){var a="";this.scheme&&(a+=this.scheme+":");this.authority&&(a+="//"+this.authority);a+=this.path;this.query&&(a+="?"+this.query);this.fragment&&(a+="#"+this.fragment);return a};this.getQuery=function(){var a,b,c={};this.query&&(a=decodeURIComponent(this.query).split("&"),
a.forEach(function(a){b=a.split("=");c[b[0]]=b[1]},this));return c};this.setQuery=function(a){q="";for(var b in a)a.hasOwnProperty(b)&&(""!==q&&(q+="&"),q+=encodeURIComponent(b)+"="+encodeURIComponent(a[b]));this.query=q}}}}());pc.extend(pc,function(){return{log:{write:function(d){console.log(d)},open:function(){pc.log.write(Date());pc.log.info("Log opened")},info:function(d){console.info("INFO:    "+d)},debug:function(d){console.debug("DEBUG:   "+d)},error:function(d){console.error("ERROR:   "+d)},warning:function(d){console.warn("WARNING: "+d)},alert:function(d){pc.log.write("ALERT:   "+d);alert(d)},assert:function(d,a){!1===d&&(pc.log.write("ASSERT:  "+a),alert("ASSERT failed: "+a))}}}}());
var logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;Function.prototype.extendsFrom=function(d){var a,b,c=function(){};a=this;b=function(){d.apply(this,arguments);a.apply(this,arguments);this.constructor=a};b._super=d.prototype;c.prototype=d.prototype;b.prototype=new c;return b};pc.extend(pc,function(){return{inherits:function(d,a){var b=function(){},c=function(){a.apply(this,arguments);d.apply(this,arguments)};c._super=a.prototype;b.prototype=a.prototype;c.prototype=new b;return c}}}());Function.prototype.bind||(Function.prototype.bind=function(d){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be fBound is not callable");var a=Array.prototype.slice.call(arguments,1),b=this,c=function(){},e=function(){return b.apply(this instanceof c?this:d||window,a.concat(Array.prototype.slice.call(arguments)))};c.prototype=this.prototype;e.prototype=new c;return e});pc.path=function(){return{delimiter:"/",join:function(){var d,a=arguments.length,b=arguments[0];for(d=0;d<a-1;++d){var c=arguments[d],e=arguments[d+1];if(!pc.isDefined(c)||!pc.isDefined(e))throw Error("undefined argument to pc.path.join");b=e[0]===pc.path.delimiter?e:c&&e&&c[c.length-1]!==pc.path.delimiter&&e[0]!==pc.path.delimiter?b+(pc.path.delimiter+e):b+e}return b},split:function(d){var d=d.split(pc.path.delimiter),a=d.slice(d.length-1)[0];return[d.slice(0,d.length-1).join(pc.path.delimiter),
a]},getBasename:function(d){return pc.path.split(d)[1]},getDirectory:function(d){d=d.split(pc.path.delimiter);return d.slice(0,d.length-1).join(pc.path.delimiter)},getExtension:function(d){var a=d.split(".").pop();return a!==d?"."+a:""},isRelativePath:function(d){return"/"!==d.charAt(0)&&null===d.match(/:\/\//)},extractPath:function(d){var a=".",b=d.split("/"),c=0;if(1<b.length){!1===pc.path.isRelativePath(d)&&(a="");for(c=0;c<b.length-1;++c)a+="/"+b[c]}return a}}}();pc.string=function(){return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:this.ASCII_LOWERCASE+this.ASCII_UPPERCASE,format:function(d){var a=0,b,c=pc.makeArray(arguments);c.shift();for(a=0;a<c.length;a++)b=RegExp("\\{"+a+"\\}","gi"),d=d.replace(b,c[a]);return d},startsWith:function(d,a){return 0===d.indexOf(a)},endsWith:function(d,a){return-1!==d.lastIndexOf(a,d.length-a.length)},toBool:function(d,a){if("true"===d)return!0;if(a){if("false"===
d)return!1;throw Error("Not a boolean string");}return!1}}}();pc.extend(pc,function(){return{json:{parse:function(d,a){return JSON.parse(d,a)},stringify:function(d,a,b){return JSON.stringify(d,function(b,e){this[b]instanceof Float32Array&&(e=pc.makeArray(this[b]));return a?a(b,e):e},b)}}}}());pc.cookie=function(){return{set:function(d,a,b){b=b||{};d=d+"="+a;b.path&&(d+=";path="+b.path);b.domain&&(d+=";domain="+b.domain);b.path&&(d+=";path="+b.path);b.secure&&(d+=";secure");d=b.lifetime?d+(";max-age="+86400*b.lifetime):d+";max-age=86400";document.cookie=d},get:function(d){var a,b=document.cookie.split(";"),c,e=b.length;for(c=0;c<e;c++)if(a=b[c].trim(),pc.string.startsWith(a,d))return a.split("=")[1]},remove:function(d,a){a.lifetime=0;pc.cookie.set(d,"",a)}}}();pc.debug=function(){var d=null,a=null,b=null,c=null;return{display:function(e){d||(d=document.createElement("table"),a=document.createElement("tr"),b=document.createElement("td"),c=document.createElement("td"),d.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",d.style.top="0px",d.style.left="0px",d.style.border="thin solid #cccccc",document.body.appendChild(d));d.innerHTML="";for(var g in e){var f=a.cloneNode(),h=b.cloneNode(),l=c.cloneNode();h.textContent=g;l.textContent=
e[g];f.appendChild(h);f.appendChild(l);d.appendChild(f)}}}}();pc.extend(pc,function(){var d=function(a,b){this.objects=[];this.ctor=a;this.name=b.name;this.useNew="undefined"===typeof b.useNew||b.useNew;if(this.metrics=b.metrics)this.used=this.total=0};d.prototype={_construct:function(a,b){function c(){return a.apply(this,b)}c.prototype=a.prototype;return new c},allocate:function(){var a;this.objects.length?(a=this.objects.pop(),this.ctor.apply(a,arguments),this.metrics&&this.used++):(a=this.useNew?this._construct(this.ctor,arguments):this.ctor.apply(this,arguments),
this.metrics&&(this.total++,this.used++));return a},free:function(a){this.objects.push(a);this.metrics&&this.used--;if(a.onFree)a.onFree()},usage:function(){return pc.string.format("{0} - total: {1}, used: {2}",this.name,this.total,this.used)}};return{ObjectPool:d}}());pc.events=function(){var d={attach:function(a){var b=pc.events;a.on=b.on;a.off=b.off;a.fire=b.fire;a.hasEvent=b.hasEvent;a.bind=b.on;a.unbind=b.off;return a},on:function(a,b,c){if("string"!=pc.type(a))throw new TypeError("Event name must be a string");var e=this._callbacks||(this._callbacks={});(e[a]||(e[a]=[])).push({callback:b,scope:c||this});return this},off:function(a,b,c){var e=this._callbacks;if(e){if(b){a=e[a];if(!a)return this;for(e=0;e<a.length;e++)if(a[e].callback===b&&(!c||c===a[e].scope))a.splice(e,
1),e--}else e[a]=[];return this}},fire:function(a){var b,c,e,g;if(this._callbacks&&this._callbacks[a]){e=pc.makeArray(arguments);e.shift();g=this._callbacks[a].slice();c=g.length;for(b=0;b<c;++b)g[b].callback.apply(g[b].scope,e)}return this},hasEvent:function(a){return"undefined"!==typeof this._callbacks&&"undefined"!==typeof this._callbacks[a]&&0<this._callbacks[a].length}};d.bind=d.on;d.unbind=d.off;return d}();pc.dom=function(){return{getWidth:function(d){return d.offsetWidth},getHeight:function(d){return d.offsetHeight},setText:function(d,a){d.textContent?d.textContent=a:d.innerText&&(d.innerText=a)},getText:function(d){return d.textContent||d.innerText}}}();pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(d,a,b){return d>=b?b:d<=a?a:d},intToBytes24:function(d){return[d>>16&255,d>>8&255,d&255]},intToBytes32:function(d){return[d>>24&255,d>>16&255,d>>8&255,d&255]},bytesToInt24:function(d,a,b){d.length&&(b=d[2],a=d[1],d=d[0]);return d<<16|a<<8|b},bytesToInt32:function(d,a,b,c){d.length&&(c=d[3],b=d[2],a=d[1],d=d[0]);return(d<<24|a<<16|b<<8|c)>>>32},lerp:function(d,a,b){return d+(a-d)*pc.math.clamp(b,0,1)},lerpAngle:function(d,a,b){180<
a-d&&(a-=360);-180>a-d&&(a+=360);return pc.math.lerp(d,a,pc.math.clamp(b,0,1))},powerOfTwo:function(d){return 0!==d&&!(d&d-1)},nextPowerOfTwo:function(d){d--;d|=d>>1;d|=d>>2;d|=d>>4;d|=d>>8;d|=d>>16;d++;return d},random:function(d,a){return Math.random()*(a-d)+d},smoothstep:function(d,a,b){if(b<=d)return 0;if(b>=a)return 1;b=(b-d)/(a-d);return b*b*(3-2*b)},smootherstep:function(d,a,b){if(b<=d)return 0;if(b>=a)return 1;b=(b-d)/(a-d);return b*b*b*(b*(6*b-15)+10)}};pc.math.intToBytes=pc.math.intToBytes32;
pc.math.bytesToInt=pc.math.bytesToInt32;pc.extend(pc,function(){var d=function(){this.data=new Float32Array(2);2===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*
a[0]+b[1]*a[1]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]},lerp:function(a,b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);e[1]=a[1]+c*(b[1]-a[1]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];
return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;return this},set:function(a,b){var c=this.data;c[0]=a;c[1]=b;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1);return function(){return a}}()});Object.defineProperty(d,"RIGHT",{get:function(){var a=new d(1,0);return function(){return a}}()});Object.defineProperty(d,"UP",{get:function(){var a=new d(0,1);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0);return function(){return a}}()});
return{Vec2:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(3);3===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];g[2]=c[2]+e[2];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];return this},
cross:function(a,b){var c,e,g,f,d,l,k;c=a.data;e=b.data;g=this.data;f=c[0];d=c[1];c=c[2];l=e[0];k=e[1];e=e[2];g[0]=d*e-k*c;g[1]=c*l-e*f;g[2]=f*k-l*d;return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},lerp:function(a,
b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);e[1]=a[1]+c*(b[1]-a[1]);e[2]=a[2]+c*(b[2]-a[2]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];g[2]=c[2]*e[2];return this},normalize:function(){return this.scale(1/this.length())},project:function(a){var b=this.data,a=a.data,c=(b[0]*a[0]+b[1]*a[1]+b[2]*a[2])/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);b[0]=a[0]*c;
b[1]=a[1]*c;b[2]=a[2]*c;return this},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;return this},set:function(a,b,c){var e=this.data;e[0]=a;e[1]=b;e[2]=c;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];g[2]=c[2]-e[2];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(d.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d,"BACK",{get:function(){var a=new d(0,0,1);return function(){return a}}()});Object.defineProperty(d,"DOWN",{get:function(){var a=new d(0,-1,0);return function(){return a}}()});Object.defineProperty(d,"FORWARD",{get:function(){var a=
new d(0,0,-1);return function(){return a}}()});Object.defineProperty(d,"LEFT",{get:function(){var a=new d(-1,0,0);return function(){return a}}()});Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1,1);return function(){return a}}()});Object.defineProperty(d,"RIGHT",{get:function(){var a=new d(1,0,0);return function(){return a}}()});Object.defineProperty(d,"UP",{get:function(){var a=new d(0,1,0);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,
0,0);return function(){return a}}()});return{Vec3:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(4);4===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];b[3]+=a[3];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];g[2]=c[2]+e[2];g[3]=c[3]+e[3];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;
b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},lerp:function(a,b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);
e[1]=a[1]+c*(b[1]-a[1]);e[2]=a[2]+c*(b[2]-a[2]);e[3]=a[3]+c*(b[3]-a[3]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];b[3]*=a[3];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];g[2]=c[2]*e[2];g[3]=c[3]*e[3];return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return this},set:function(a,b,c,e){var g=this.data;g[0]=a;g[1]=b;g[2]=
c;g[3]=e;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];b[3]-=a[3];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];g[2]=c[2]-e[2];g[3]=c[3]-e[3];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+", "+this.data[3]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},
set:function(a){this.data[1]=a}});Object.defineProperty(d.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d.prototype,"w",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1,1,1);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0);return function(){return a}}()});return{Vec4:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(9);9===arguments.length?this.data.set(arguments):this.setIdentity()};d.prototype={clone:function(){return(new pc.Mat3).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},equals:function(){},isIdentity:function(){},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=
1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},toString:function(){for(var a="[",b=0;9>b;b++)a+=this.data[b],a+=9!==b?", ":"";return a+"]"},transpose:function(){var a=this.data,b;b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat3:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(16);16===arguments.length?this.data.set(arguments):this.setIdentity()},a,b,c;a=new pc.Vec3;b=new pc.Vec3;c=new pc.Vec3;var e,g,f;e=new pc.Vec3;g=new pc.Vec3;f=new pc.Vec3;var h=new pc.Vec3;d.prototype={add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];g[2]=c[2]+e[2];g[3]=c[3]+e[3];g[4]=c[4]+e[4];g[5]=c[5]+e[5];g[6]=c[6]+e[6];g[7]=c[7]+e[7];g[8]=c[8]+e[8];g[9]=c[9]+e[9];g[10]=c[10]+e[10];g[11]=c[11]+
e[11];g[12]=c[12]+e[12];g[13]=c[13]+e[13];g[14]=c[14]+e[14];g[15]=c[15]+e[15];return this},add:function(a){return this.add2(this,a)},clone:function(){return(new pc.Mat4).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===
a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var c,e,g,f,d,h,x,u,v,z,A,C,H,E,I,y,B,K,D,J;y=a.data;var F=b.data,L=this.data;c=y[0];e=y[1];g=y[2];
f=y[3];d=y[4];h=y[5];x=y[6];u=y[7];v=y[8];z=y[9];A=y[10];C=y[11];H=y[12];E=y[13];I=y[14];y=y[15];B=F[0];K=F[1];D=F[2];J=F[3];L[0]=c*B+d*K+v*D+H*J;L[1]=e*B+h*K+z*D+E*J;L[2]=g*B+x*K+A*D+I*J;L[3]=f*B+u*K+C*D+y*J;B=F[4];K=F[5];D=F[6];J=F[7];L[4]=c*B+d*K+v*D+H*J;L[5]=e*B+h*K+z*D+E*J;L[6]=g*B+x*K+A*D+I*J;L[7]=f*B+u*K+C*D+y*J;B=F[8];K=F[9];D=F[10];J=F[11];L[8]=c*B+d*K+v*D+H*J;L[9]=e*B+h*K+z*D+E*J;L[10]=g*B+x*K+A*D+I*J;L[11]=f*B+u*K+C*D+y*J;B=F[12];K=F[13];D=F[14];J=F[15];L[12]=c*B+d*K+v*D+H*J;L[13]=e*B+
h*K+z*D+E*J;L[14]=g*B+x*K+A*D+I*J;L[15]=f*B+u*K+C*D+y*J;return this},mul:function(a){return this.mul2(this,a)},transformPoint:function(a,b){var c=this.data,e=a.data,b=void 0===b?new pc.Vec3:b;return b.set(e[0]*c[0]+e[1]*c[4]+e[2]*c[8]+c[12],e[0]*c[1]+e[1]*c[5]+e[2]*c[9]+c[13],e[0]*c[2]+e[1]*c[6]+e[2]*c[10]+c[14])},transformVector:function(a,b){var c=this.data,e=a.data,b=void 0===b?new pc.Vec3:b;return b.set(e[0]*c[0]+e[1]*c[4]+e[2]*c[8],e[0]*c[1]+e[1]*c[5]+e[2]*c[9],e[0]*c[2]+e[1]*c[6]+e[2]*c[10])},
setLookAt:function(e,g,f){c.sub2(e,g).normalize();b.copy(f).normalize();a.cross(b,c).normalize();b.cross(c,a);g=this.data;g[0]=a.x;g[1]=a.y;g[2]=a.z;g[3]=0;g[4]=b.x;g[5]=b.y;g[6]=b.z;g[7]=0;g[8]=c.x;g[9]=c.y;g[10]=c.z;g[11]=0;g[12]=e.x;g[13]=e.y;g[14]=e.z;g[15]=1;return this},setFrustum:function(a,b,c,e,g,f){var d,h,x,u,v;d=2*g;h=b-a;x=e-c;u=f-g;v=this.data;v[0]=d/h;v[1]=0;v[2]=0;v[3]=0;v[4]=0;v[5]=d/x;v[6]=0;v[7]=0;v[8]=(b+a)/h;v[9]=(e+c)/x;v[10]=(-f-g)/u;v[11]=-1;v[12]=0;v[13]=0;v[14]=-d*f/u;v[15]=
0;return this},setPerspective:function(a,b,c,e){a=c*Math.tan(a*Math.PI/360);b*=a;return this.setFrustum(-b,b,-a,a,c,e)},setOrtho:function(a,b,c,e,g,f){var d=this.data;d[0]=2/(b-a);d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=2/(e-c);d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=-2/(f-g);d[11]=0;d[12]=-(b+a)/(b-a);d[13]=-(e+c)/(e-c);d[14]=-(f+g)/(f-g);d[15]=1;return this},setFromAxisAngle:function(a,b){var c,e,g,f,d,h,x,u,v,b=b*pc.math.DEG_TO_RAD;c=a.x;e=a.y;g=a.z;f=Math.cos(b);d=Math.sin(b);h=1-f;x=h*c;u=h*e;v=this.data;
v[0]=x*c+f;v[1]=x*e+d*g;v[2]=x*g-d*e;v[3]=0;v[4]=x*e-d*g;v[5]=u*e+f;v[6]=u*g+d*c;v[7]=0;v[8]=x*g+d*e;v[9]=u*g-c*d;v[10]=h*g*g+f;v[11]=0;v[12]=0;v[13]=0;v[14]=0;v[15]=1;return this},setTranslate:function(a,b,c){var e=this.data;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=a;e[13]=b;e[14]=c;e[15]=1;return this},setScale:function(a,b,c){var e=this.data;e[0]=a;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=b;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=c;e[11]=0;e[12]=0;e[13]=0;e[14]=
0;e[15]=1;return this},invert:function(){var a,b,c,e,g,f,d,h,x,u,v,z,A,C,H,E,I,y,B,K,D,J,F,L,P,M,Q,N,R,O;O=this.data;a=O[0];b=O[1];c=O[2];e=O[3];g=O[4];f=O[5];d=O[6];h=O[7];x=O[8];u=O[9];v=O[10];z=O[11];A=O[12];C=O[13];H=O[14];E=O[15];I=a*f-b*g;y=a*d-c*g;B=a*h-e*g;K=b*d-c*f;D=b*h-e*f;J=c*h-e*d;F=x*C-u*A;L=x*H-v*A;P=x*E-z*A;M=u*H-v*C;Q=u*E-z*C;N=v*E-z*H;R=1/(I*N-y*Q+B*M+K*P-D*L+J*F);O[0]=(f*N-d*Q+h*M)*R;O[1]=(-b*N+c*Q-e*M)*R;O[2]=(C*J-H*D+E*K)*R;O[3]=(-u*J+v*D-z*K)*R;O[4]=(-g*N+d*P-h*L)*R;O[5]=(a*
N-c*P+e*L)*R;O[6]=(-A*J+H*B-E*y)*R;O[7]=(x*J-v*B+z*y)*R;O[8]=(g*Q-f*P+h*F)*R;O[9]=(-a*Q+b*P-e*F)*R;O[10]=(A*D-C*B+E*I)*R;O[11]=(-x*D+u*B-z*I)*R;O[12]=(-g*M+f*L-d*F)*R;O[13]=(a*M-b*L+c*F)*R;O[14]=(-A*K+C*y-H*I)*R;O[15]=(x*K-u*y+v*I)*R;return this},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},setTRS:function(a,b,c){var e,g,f,d,h,x,u,v,z,A,C,H,E;e=a.x;g=a.y;a=a.z;f=b.x;d=b.y;h=
b.z;x=b.w;b=c.x;u=c.y;c=c.z;v=f+f;z=d+d;A=h+h;C=f*v;H=f*z;f*=A;E=d*z;d*=A;h*=A;v*=x;z*=x;x*=A;A=this.data;A[0]=(1-(E+h))*b;A[1]=(H+x)*b;A[2]=(f-z)*b;A[3]=0;A[4]=(H-x)*u;A[5]=(1-(C+h))*u;A[6]=(d+v)*u;A[7]=0;A[8]=(f+z)*c;A[9]=(d-v)*c;A[10]=(1-(C+E))*c;A[11]=0;A[12]=e;A[13]=g;A[14]=a;A[15]=1;return this},transpose:function(){var a,b=this.data;a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return this},
invertTo3x3:function(a){var b,c,e,g,f,d,h,x,u,v;u=this.data;v=a.data;a=u[10]*u[5]-u[6]*u[9];b=-u[10]*u[1]+u[2]*u[9];c=u[6]*u[1]-u[2]*u[5];e=-u[10]*u[4]+u[6]*u[8];g=u[10]*u[0]-u[2]*u[8];f=-u[6]*u[0]+u[2]*u[4];d=u[9]*u[4]-u[5]*u[8];h=-u[9]*u[0]+u[1]*u[8];x=u[5]*u[0]-u[1]*u[4];u=u[0]*a+u[1]*e+u[2]*d;if(0===u)return console.warn("pc.Mat4#invertTo3x3: Matrix not invertible"),this;u=1/u;v[0]=u*a;v[1]=u*b;v[2]=u*c;v[3]=u*e;v[4]=u*g;v[5]=u*f;v[6]=u*d;v[7]=u*h;v[8]=u*x;return this},getTranslation:function(a){a=
void 0===a?new pc.Vec3:a;return a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[8],this.data[9],this.data[10])},getScale:function(a){a=void 0===a?new pc.Vec3:a;this.getX(e);this.getY(g);this.getZ(f);a.set(e.length(),g.length(),f.length());
return a},setFromEulerAngles:function(a,b,c){var e,g,f,d,a=a*pc.math.DEG_TO_RAD,b=b*pc.math.DEG_TO_RAD,c=c*pc.math.DEG_TO_RAD;e=Math.sin(-a);a=Math.cos(-a);g=Math.sin(-b);b=Math.cos(-b);f=Math.sin(-c);c=Math.cos(-c);d=this.data;d[0]=b*c;d[1]=-b*f;d[2]=g;d[3]=0;d[4]=a*f+c*e*g;d[5]=a*c-e*g*f;d[6]=-b*e;d[7]=0;d[8]=e*f-a*c*g;d[9]=c*e+a*g*f;d[10]=a*b;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return this},getEulerAngles:function(a){var b,c,e,g,f,d,a=void 0===a?new pc.Vec3:a;this.getScale(h);e=h.x;b=h.y;g=
h.z;f=this.data;c=Math.asin(-f[2]/e);d=0.5*Math.PI;c<d?c>-d?(b=Math.atan2(f[6]/b,f[10]/g),e=Math.atan2(f[1]/e,f[0]/e)):(e=0,b=-Math.atan2(f[4]/b,f[5]/b)):(e=0,b=Math.atan2(f[4]/b,f[5]/b));return a.set(b,c,e).scale(pc.math.RAD_TO_DEG)},toString:function(){var a,b;b="[";for(a=0;16>a;a+=1)b+=this.data[a],b+=15!==a?", ":"";return b+"]"}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat4:d}}());pc.extend(pc,function(){var d=function(a,b,c,e){this.x=void 0===a?0:a;this.y=void 0===b?0:b;this.z=void 0===c?0:c;this.w=void 0===e?1:e};d.prototype={clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},getEulerAngles:function(a){var b,c,e,g,f,d,a=void 0===a?new pc.Vec3:
a;e=this.x;g=this.y;f=this.z;d=this.w;c=2*(d*g-e*f);-0.99999>=c?(b=2*Math.atan2(e,d),c=-Math.PI/2,e=0):0.99999<=c?(b=2*Math.atan2(e,d),c=Math.PI/2,e=0):(b=Math.atan2(2*(d*e+g*f),1-2*(e*e+g*g)),c=Math.asin(c),e=Math.atan2(2*(d*f+e*g),1-2*(g*g+f*f)));return a.set(b,c,e).scale(pc.math.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){var a,b,c,e;a=this.x;b=this.y;c=this.z;e=this.w;return Math.sqrt(a*a+b*b+c*c+e*e)},lengthSq:function(){var a=this.data;return a[0]*a[0]+
a[1]*a[1]+a[2]*a[2]},mul:function(a){var b,c,e,g,f,d,l;b=this.x;c=this.y;e=this.z;g=this.w;f=a.x;d=a.y;l=a.z;a=a.w;this.x=g*f+b*a+c*l-e*d;this.y=g*d+c*a+e*f-b*l;this.z=g*l+e*a+b*d-c*f;this.w=g*a-b*f-c*d-e*l;return this},mul2:function(a,b){var c,e,g,f,d,l,k,n;c=a.x;e=a.y;g=a.z;f=a.w;d=b.x;l=b.y;k=b.z;n=b.w;this.x=f*d+c*n+e*k-g*l;this.y=f*l+e*n+g*d-c*k;this.z=f*k+g*n+c*l-e*d;this.w=f*n-c*d-e*l-g*k;return this},normalize:function(){var a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=
a,this.y*=a,this.z*=a,this.w*=a);return this},set:function(a,b,c,e){this.x=a;this.y=b;this.z=c;this.w=e;return this},setFromAxisAngle:function(a,b){var c,e,b=b*0.5*pc.math.DEG_TO_RAD;c=Math.sin(b);e=Math.cos(b);this.x=c*a.x;this.y=c*a.y;this.z=c*a.z;this.w=e;return this},setFromEulerAngles:function(a,b,c){var e,g,f;e=0.5*pc.math.DEG_TO_RAD;a*=e;b*=e;c*=e;e=Math.sin(a);a=Math.cos(a);g=Math.sin(b);b=Math.cos(b);f=Math.sin(c);c=Math.cos(c);this.x=e*b*c-a*g*f;this.y=a*g*c+e*b*f;this.z=a*b*f-e*g*c;this.w=
a*b*c+e*g*f;return this},setFromMat4:function(a){var b,c,e,g,f,d,l,k,n,m,r,a=a.data;b=a[0];c=a[1];e=a[2];g=a[4];f=a[5];d=a[6];l=a[8];k=a[9];a=a[10];n=1/Math.sqrt(b*b+c*c+e*e);m=1/Math.sqrt(g*g+f*f+d*d);r=1/Math.sqrt(l*l+k*k+a*a);b*=n;c*=n;e*=n;g*=m;f*=m;d*=m;l*=r;k*=r;a*=r;n=b+f+a;0<=n?(b=Math.sqrt(n+1),this.w=0.5*b,b=0.5/b,this.x=(d-k)*b,this.y=(l-e)*b,this.z=(c-g)*b):b>f?b>a?(b=Math.sqrt(b-(f+a)+1),this.x=0.5*b,b=0.5/b,this.w=(d-k)*b,this.y=(c+g)*b,this.z=(e+l)*b):(b=Math.sqrt(a-(b+f)+1),this.z=
0.5*b,b=0.5/b,this.w=(c-g)*b,this.x=(l+e)*b,this.y=(k+d)*b):f>a?(b=Math.sqrt(f-(a+b)+1),this.y=0.5*b,b=0.5/b,this.w=(l-e)*b,this.z=(d+k)*b,this.x=(g+c)*b):(b=Math.sqrt(a-(b+f)+1),this.z=0.5*b,b=0.5/b,this.w=(c-g)*b,this.x=(l+e)*b,this.y=(k+d)*b);return this},slerp:function(a,b,c){var e,g,f,d,l,k;e=a.x;g=a.y;f=a.z;a=a.w;d=b.x;l=b.y;k=b.z;var b=b.w,n=a*b+e*d+g*l+f*k;0>n&&(b=-b,d=-d,l=-l,k=-k,n=-n);if(1<=Math.abs(n))return this.w=a,this.x=e,this.y=g,this.z=f,this;var m=Math.acos(n),r=Math.sqrt(1-n*n);
if(0.001>Math.abs(r))return this.w=0.5*a+0.5*b,this.x=0.5*e+0.5*d,this.y=0.5*g+0.5*l,this.z=0.5*f+0.5*k,this;n=Math.sin((1-c)*m)/r;c=Math.sin(c*m)/r;this.w=a*n+b*c;this.x=e*n+d*c;this.y=g*n+l*c;this.z=f*n+k*c;return this},transformVector:function(a,b){"undefined"===typeof b&&(b=new pc.Vec3);var c=a.x,e=a.y,g=a.z,f=this.x,d=this.y,l=this.z,k=this.w,n=k*c+d*g-l*e,m=k*e+l*c-f*g,r=k*g+f*e-d*c,c=-f*c-d*e-l*g;b.x=n*k+c*-f+m*-l-r*-d;b.y=m*k+c*-d+r*-f-n*-l;b.z=r*k+c*-l+n*-d-m*-f;return b},toString:function(){return"["+
this.x+", "+this.y+", "+this.z+", "+this.w+"]"}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0);return function(){return a}}()});return{Quat:d}}());pc.extend(pc,function(){var d=function(a){this.keys=[];this.type=1;this.tension=0.5;if(a)for(var b=0;b<a.length-1;b+=2)this.keys.push([a[b],a[b+1]]);this.sort()};d.prototype={add:function(a,b){for(var c=this.keys,e=c.length,g=0;g<e&&!(c[g][0]>a);g++);c=[a,b];this.keys.splice(g,0,c);return c},get:function(a){return this.keys[a]},sort:function(){this.keys.sort(function(a,b){return a[0]-b[0]})},value:function(a){var b=this.keys;if(!b.length)return 0;if(a<b[0][0])return b[0][1];if(a>b[b.length-1][0])return b[b.length-
1][1];for(var c=0,e=b.length?b[0][1]:0,g=1,f=0,d=0,l=b.length;d<l;d++){if(b[d][0]===a)return b[d][1];f=b[d][1];if(a<b[d][0]){g=b[d][0];break}c=b[d][0];e=b[d][1]}l=g-c;a=0===l?0:(a-c)/l;if(1===this.type)a*=a*(3-2*a);else if(2===this.type||3===this.type){var l=e+(e-f),k=f+(f-e),n=g=c=g-c;0<d&&(d-=1);0<d&&(l=b[d-1][1],g=b[d][0]-b[d-1][0]);b.length>d+1&&(c=b[d+1][0]-b[d][0]);b.length>d+2&&(n=b[d+2][0]-b[d+1][0],k=b[d+2][1]);l=e+(l-e)*c/g;k=f+(k-f)*c/n;return 2===this.type?this._interpolateCatmullRom(l,
e,f,k,a):this._interpolateCardinal(l,e,f,k,a,this.tension)}return pc.math.lerp(e,f,a)},_interpolateHermite:function(a,b,c,e,g){var f=g*g,d=g*g*g;return a*(2*d-3*f+1)+b*(-2*d+3*f)+c*(d-2*f+g)+e*(d-f)},_interpolateCardinal:function(a,b,c,e,g,f){return this._interpolateHermite(b,c,f*(c-a),f*(e-b),g)},_interpolateCatmullRom:function(a,b,c,e,g){return this._interpolateCardinal(a,b,c,e,g,0.5)},closest:function(a){for(var b=this.keys,c=b.length,e=2,g=null,f=0;f<c;f++){var d=Math.abs(a-b[f][0]);if(e>=d)e=
d,g=b[f];else break}return g},clone:function(){var a=new pc.Curve;a.keys=pc.extend(a.keys,this.keys);a.type=this.type;return a},quantize:function(a){for(var a=Math.max(a,2),b=new Float32Array(a),c=1/(a-1),e=0;e<a;e++){var g=this.value(c*e);b[e]=g}return b}};Object.defineProperty(d.prototype,"length",{get:function(){return this.keys.length}});return{Curve:d,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3}}());pc.extend(pc,function(){var d=function(){var a;this.curves=[];this._type=pc.CURVE_SMOOTHSTEP;if(1<arguments.length)for(a=0;a<arguments.length;a++)this.curves.push(new pc.Curve(arguments[a]));else if(0===arguments.length)this.curves.push(new pc.Curve);else{var b=arguments[0];if("number"===pc.type(b))for(a=0;a<b;a++)this.curves.push(new pc.Curve);else for(a=0;a<b.length;a++)this.curves.push(new pc.Curve(b[a]))}};d.prototype={get:function(a){return this.curves[a]},value:function(a,b){var c=this.curves.length,
b=b||[];b.length=c;for(var e=0;e<c;e++)b[e]=this.curves[e].value(a);return b},clone:function(){var a=new pc.CurveSet;a.curves=[];for(var b=0;b<this.curves.length;b++)a.curves.push(this.curves[b].clone());a._type=this._type;return a},quantize:function(a){for(var a=Math.max(a,2),b=this.curves.length,c=new Float32Array(a*b),e=1/(a-1),g=[],f=0;f<a;f++){var d=this.value(e*f,g);if(1==b)c[f]=d[0];else for(var l=0;l<b;l++)c[f*b+l]=d[l]}return c}};Object.defineProperty(d.prototype,"length",{get:function(){return this.curves.length}});
Object.defineProperty(d.prototype,"type",{get:function(){return this._type},set:function(a){this._type=a;for(var b=0;b<this.curves.length;b++)this.curves[b].type=a}});return{CurveSet:d}}());pc.shape=function(){var d=function(){};d.prototype={containsPoint:function(){throw Error("Shape hasn't implemented containsPoint");}};return{Shape:d,Type:{CAPSULE:"Capsule",CONE:"Cone",CYLINDER:"Cylinder",CIRCLE:"Circle",RECT:"Rect"}}}();pc.shape.intersection=function(){return{aabbAabb:function(d,a){var b=d.getMax(),c=d.getMin(),e=a.getMax(),g=a.getMin();return c[0]<=e[0]&&b[0]>=g[0]&&c[1]<=e[1]&&b[1]>=g[1]&&c[2]<=e[2]&&b[2]>=g[2]},rayAabb:function(d,a,b){var c=new pc.Vec3,e,g=new pc.Vec3;e=new pc.Vec3;c.sub2(d,b.center);d=new pc.Vec3(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z));e.mul2(c,a);if(d.x>b.halfExtents.x&&0<=e.x||d.y>b.halfExtents.y&&0<=e.y||d.z>b.halfExtents.z&&0<=e.z)return!1;e=new pc.Vec3(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z));
g.cross(a,c);g.set(Math.abs(g.x),Math.abs(g.y),Math.abs(g.z));return g.x>b.halfExtents.y*e.z+b.halfExtents.z*e.y||g.y>b.halfExtents.x*e.z+b.halfExtents.z*e.x||g.z>b.halfExtents.x*e.y+b.halfExtents.y*e.x?!1:!0},raySphere:function(d,a,b,c){var e=new pc.Vec3,g=0,f=0,h=0,h=0,c=c||{};e.sub2(d,b.center);if(e.dot(e)<b.radius*b.radius)return c.success=!0,c.t=0,!0;g=a.dot(a);f=2*a.dot(e);h=b.center.dot(b.center);h+=d.dot(d);h-=2*b.center.dot(d);h-=b.radius*b.radius;h=f*f-4*g*h;if(0>h)return c.success=!1,c.t=
0,!1;c.success=!0;c.t=(-f-Math.sqrt(h))/(2*g);return!0},rayTriangle:function(d,a,b,c){var e=d.clone().sub(b.v0),e=-b.n.dot(e),g=b.n.dot(a);if(1E-8>Math.fabs(g))return 0===e?2:0;e/=g;if(0>e)return 0;a=a.clone().scale(e);c.add2(d,a);c=(new pc.Vec3).sub2(c,b.v0);d=c.dot(b.u);c=c.dot(b.v);a=(b.uv*c-b.vv*d)/b.d;if(0>a||1<a)return 0;b=(b.uv*d-b.uu*c)/b.d;return 0>b||1<a+b?0:1}}}();pc.extend(pc.shape,function(){pc.shape.Type.AABB="Aabb";var d=function(a,b){this.center=a||new pc.Vec3(0,0,0);this.halfExtents=b||new pc.Vec3(0.5,0.5,0.5);this.type=pc.shape.Type.AABB},d=pc.inherits(d,pc.shape.Shape);d.prototype.add=function(a){var b=this.center,c=this.halfExtents,e=b.x-c.x,g=b.x+c.x,f=b.y-c.y,d=b.y+c.y,l=b.z-c.z,k=b.z+c.z,n=a.center,m=a.halfExtents,a=n.x-m.x,r=n.x+m.x,w=n.y-m.y,s=n.y+m.y,G=n.z-m.z,n=n.z+m.z;a<e&&(e=a);r>g&&(g=r);w<f&&(f=w);s>d&&(d=s);G<l&&(l=G);n>k&&(k=n);b.set(e+
g,f+d,l+k).scale(0.5);c.set(g-e,d-f,k-l).scale(0.5)};d.prototype.copy=function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type};d.prototype.setMinMax=function(a,b){this.center.add2(b,a).scale(0.5);this.halfExtents.sub2(b,a).scale(0.5)};d.prototype.getMin=function(){return this.center.clone().sub(this.halfExtents)};d.prototype.getMax=function(){return this.center.clone().add(this.halfExtents)};d.prototype.containsPoint=function(a){var b=this.getMin(),c=this.getMax(),
e;for(e=0;3>e;++e)if(a.data[e]<b.data[e]||a.data[e]>c.data[e])return!1;return!0};d.prototype.setFromTransformedAabb=function(a,b){var c=this.center,e=this.halfExtents,g=a.center.data,f=a.halfExtents.data,b=b.data,d=b[0],l=b[4],k=b[8],n=b[1],m=b[5],r=b[9],w=b[2],s=b[6],G=b[10],x=Math.abs(d),u=Math.abs(l),v=Math.abs(k),z=Math.abs(n),A=Math.abs(m),C=Math.abs(r),H=Math.abs(w),E=Math.abs(s),I=Math.abs(G);c.set(b[12]+d*g[0]+l*g[1]+k*g[2],b[13]+n*g[0]+m*g[1]+r*g[2],b[14]+w*g[0]+s*g[1]+G*g[2]);e.set(x*f[0]+
u*f[1]+v*f[2],z*f[0]+A*f[1]+C*f[2],H*f[0]+E*f[1]+I*f[2])};d.prototype.compute=function(a){for(var b=new pc.Vec3(a[0],a[1],a[2]),c=new pc.Vec3(a[0],a[1],a[2]),e=a.length/3,g=1;g<e;g++){var f=a[3*g+0],d=a[3*g+1],l=a[3*g+2];f<b.x&&(b.x=f);d<b.y&&(b.y=d);l<b.z&&(b.z=l);f>c.x&&(c.x=f);d>c.y&&(c.y=d);l>c.z&&(c.z=l)}this.setMinMax(b,c)};return{Aabb:d}}());pc.extend(pc.shape,function(){function d(a,b){this.transform="undefined"===typeof a?new pc.Mat4:a;this.halfExtents="undefined"===typeof b?new pc.Vec3(0.5,0.5,0.5):b;this.type=pc.shape.Type.BOX}pc.shape.Type.BOX="Box";var a=new pc.Vec3,b=new pc.Vec3,c=new pc.Mat4,e=new pc.Mat4,d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(g){this.transform.getTranslation(a);var f=this.getHalfExtents();c.copy(this.transform);b.copy(f).scale(2);e.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,b);c.mul(e).invert();
c.transformPoint(g,b);return-0.5>b.x||0.5<b.x||-0.5>b.y||0.5<b.y||-0.5>b.z||0.5<b.z?!1:!0};d.prototype.getHalfExtents=function(){return this.halfExtents};return{Box:d}}());pc.extend(pc.shape,function(){pc.shape.Type.FRUSTUM="Frustum";var d=new pc.Mat4,a=function(a,c){a=a||(new pc.Mat4).setPerspective(90,16/9,0.1,1E3);c=c||new pc.Mat4;this.planes=[];for(var e=0;6>e;e++)this.planes[e]=[];this.update(a,c);this.type=pc.shape.Type.FRUSTUM},a=pc.inherits(a,pc.shape.Shape);a.prototype.update=function(a,c){d.mul2(a,c);var e=d.data;this.planes[0][0]=e[3]-e[0];this.planes[0][1]=e[7]-e[4];this.planes[0][2]=e[11]-e[8];this.planes[0][3]=e[15]-e[12];t=Math.sqrt(this.planes[0][0]*
this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=t;this.planes[0][1]/=t;this.planes[0][2]/=t;this.planes[0][3]/=t;this.planes[1][0]=e[3]+e[0];this.planes[1][1]=e[7]+e[4];this.planes[1][2]=e[11]+e[8];this.planes[1][3]=e[15]+e[12];t=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=t;this.planes[1][1]/=t;this.planes[1][2]/=t;this.planes[1][3]/=t;this.planes[2][0]=
e[3]+e[1];this.planes[2][1]=e[7]+e[5];this.planes[2][2]=e[11]+e[9];this.planes[2][3]=e[15]+e[13];t=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=t;this.planes[2][1]/=t;this.planes[2][2]/=t;this.planes[2][3]/=t;this.planes[3][0]=e[3]-e[1];this.planes[3][1]=e[7]-e[5];this.planes[3][2]=e[11]-e[9];this.planes[3][3]=e[15]-e[13];t=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+
this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=t;this.planes[3][1]/=t;this.planes[3][2]/=t;this.planes[3][3]/=t;this.planes[4][0]=e[3]-e[2];this.planes[4][1]=e[7]-e[6];this.planes[4][2]=e[11]-e[10];this.planes[4][3]=e[15]-e[14];t=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=t;this.planes[4][1]/=t;this.planes[4][2]/=t;this.planes[4][3]/=t;this.planes[5][0]=e[3]+e[2];this.planes[5][1]=e[7]+e[6];this.planes[5][2]=
e[11]+e[10];this.planes[5][3]=e[15]+e[14];t=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=t;this.planes[5][1]/=t;this.planes[5][2]/=t;this.planes[5][3]/=t};a.prototype.containsPoint=function(a){for(var c=0;6>c;c++)if(0>=this.planes[c][0]*a.x+this.planes[c][1]*a.y+this.planes[c][2]*a.z+this.planes[c][3])return!1;return!0};a.prototype.containsSphere=function(a){var c=0,e;for(p=0;6>p;p++){e=this.planes[p][0]*
a.center.x+this.planes[p][1]*a.center.y+this.planes[p][2]*a.center.z+this.planes[p][3];if(e<=-a.radius)return 0;e>a.radius&&c++}return 6===c?2:1};return{Frustum:a}}());pc.extend(pc.shape,function(){pc.shape.Type.PLANE="Plane";var d=function(a,b){this.normal=b||new pc.Vec3(0,0,1);this.point=a||new pc.Vec3(0,0,0);this.d=-this.normal.dot(this.point);this.type=pc.shape.Type.PLANE},d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(){return!1};d.prototype.distance=function(a){return this.normal.dot(a)+this.d};d.prototype.intersect=function(a,b){var c=this.distance(a),e=this.distance(b);return c/(c-e)};d.prototype.intersectPosition=function(a,b){var c=
this.intersect(a,b),e=new pc.Vec3;e.lerp(a,b,c);return e};return{Plane:d}}());pc.extend(pc.shape,function(){function d(a,b){this.center=void 0===a?new pc.Vec3(0,0,0):a;this.radius=void 0===b?1:b;this.type=pc.shape.Type.SPHERE}pc.shape.Type.SPHERE="Sphere";var d=pc.inherits(d,pc.shape.Shape),a=d.prototype,b=new pc.Vec3;a.containsPoint=function(a){var a=b.sub2(a,this.center).lengthSq(),e=this.radius;return a<e*e};d.prototype.compute=function(a){var b,g=a.length/3,f=new pc.Vec3(0,0,0),d=new pc.Vec3(0,0,0),l=new pc.Vec3(0,0,0);for(b=0;b<g;b++)f.set(a[3*b],a[3*b+1],a[3*b+2]),l.addSelf(f),
0===b%100&&(l.scale(1/g),d.add(l),l.set(0,0,0));l.scale(1/g);d.add(l);this.center.copy(d);d=0;l=new pc.Vec3(0,0,0);for(b=0;b<g;b++)f.set(a[3*b],a[3*b+1],a[3*b+2]),l.sub2(f,this.center),d=Math.max(l.lengthSq(),d);this.radius=Math.sqrt(d)};d.prototype.intersectRay=function(a,b){var g=a.clone().sub(this.center),f=g.dot(b),g=g.dot(g)-this.radius*this.radius;if(0<g&&0<f)return null;g=f*f-g;if(0>g)return null;t=Math.abs(-f-Math.sqrt(g));return b.clone().scale(t).add(a)};return{Sphere:d}}());pc.extend(pc.shape,function(){pc.shape.Type.TORUS="Torus";var d=function(a,b,c){this.transform=a;this.iradius=b;this.oradius=c;this.type=pc.shape.Type.TORUS},d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(){throw Error("Not implemented yet");};return{Torus:d}}());pc.resources={};pc.extend(pc.resources,function(){var d=function(){"undefined"===typeof window.RSVP&&logERROR("Missing RSVP library");this._types={};this._handlers={};this._requests={};this._cache={};this._hashes={};this._canonicals={};this._sequence=this._loaded=this._requested=0;this.cache=!0;pc.events.attach(this)};d.prototype={createFileRequest:function(a,c){return new this._types[c](a)},registerHandler:function(a,c){var e=new a;if(""===e.type)throw Error("ResourceRequests must have a type");this._types[e.type]=
a;this._handlers[e.type]=c;c.setLoader(this)},request:function(a,c){var c=c||{},e=this,g=c.parent;c.cache=e.cache;return new pc.promise.Promise(function(f,d){var l,k;void 0===a.length&&(a=[a]);var n=[],m=[];l=0;for(k=a.length;l<k;l++){var r=e._findExistingRequest(a[l]);r!==a[l]&&(r.data=a[l].data);e._makeCanonical(r);m.push(e._request(r,c));n.push(r);g&&g.children.push(r)}var w=function(a,b){var c=[],g=[];b.forEach(function(a){a.children.forEach(function(a){g.push(a);c.push.apply(c,a.promises)})});
c.length?pc.promise.all(c).then(function(){w(a,g,c)},function(a){d(a)}):(e.fire("complete",a),f(a))};pc.promise.all(m).then(function(a){w(a,n,m)},function(a){d(a)})})},open:function(a,c,e){a=new a;return this._handlers[a.type].open(c,a,e)},registerHash:function(a,c){this._hashes[c]||(this._hashes[c]=a);this._canonicals[a]||(this._canonicals[a]=c)},getHash:function(a){return this._hashes[a]},addToCache:function(a,c){var e=this.getHash(a);e&&(this._cache[e]=c)},getFromCache:function(a){return(a=this.getHash(a))?
this._cache[a]:null},removeFromCache:function(a){if(a=this.getHash(a))delete this._cache[a];else return null},resetProgress:function(){this._loaded=this._requested=0},_request:function(a,c){var e=this,g={};for(key in c)g[key]=c[key];null===a.id&&(a.id=this._sequence++);this.fire("request",a);a.promises.length?a.promises.push(new pc.promise.Promise(function(c){a.promises[0].then(function(g){g=e._postOpen(g,a);c(g)})})):a.promises[0]=new pc.promise.Promise(function(c,d){var l=e._handlers[a.type];if(l){var k=
e.getFromCache(a.canonical);k&&(void 0===a.Type||k instanceof a.Type)?(k=e._postOpen(k,a),c(k)):l.load(a,g).then(function(l){try{var k=e._open(l,a,g);k&&(k=e._postOpen(k,a));c(k)}catch(r){d(r)}},function(c){e.fire("error",a,c);d(c)})}else l="Missing handler for type: "+a.type,e.fire("error",a,l),d(l)});e._requests[a.canonical]=a;this._requested++;return a.promises[a.promises.length-1]},_open:function(a,c,e){return this._handlers[c.type].open(a,c,e)},_postOpen:function(a,c){this.addToCache(c.canonical,
a);a=this._handlers[c.type].clone(a,c);delete this._requests[c.canonical];this._loaded++;this.fire("progress",this._loaded/this._requested);this.fire("load",c,a);return a},_makeCanonical:function(a){var c=this.getHash(a.identifier);a.canonical=c&&this._canonicals[c]?this._canonicals[c]:a.identifier},_findExistingRequest:function(a){var c=this._requests[a.canonical];return c?c.type!==a.type||c.result||a.result?a:c:a}};var a=function(){};a.prototype={setLoader:function(a){this._loader=a},load:function(){throw Error("Not implemented");
},open:function(){throw Error("Not implemented");},clone:function(a){return a}};return{ResourceLoader:d,ResourceHandler:a,ResourceRequest:function(a,c,e){this.id=null;this.canonical=a;this.alternatives=[];this.promises=[];this.children=[];this.data=c;this.result=e;this.identifier=a}}}());pc.extend(pc.resources,function(){var d=function(a,b){b.on("request",this.handleRequest,this);b.on("load",this.handleLoad,this);b.on("error",this.handleError,this);b.on("progress",this.handleProgress,this);this.addCss();this._element=a;this._domCreate()};d.prototype={addCss:function(){var a=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=".pc-resourceloaderdisplay-root {\n   font-family: sans-serif;\n   font-size: 0.7em;\n   color: #aaa;\n   border-collapse: collapse;\n   position: absolute;\n   top: 10px;\n   left: 10px;\n   background-color: black;\n   opacity: 0.6;\n}\n.pc-resourceloaderdisplay-root td {\n   border: 1px solid #aaa;\n}\n.pc-resourceloaderdisplay-subtable {\n   border-collapse: collapse;\n}";
else{var b=document.createTextNode(".pc-resourceloaderdisplay-root {\n   font-family: sans-serif;\n   font-size: 0.7em;\n   color: #aaa;\n   border-collapse: collapse;\n   position: absolute;\n   top: 10px;\n   left: 10px;\n   background-color: black;\n   opacity: 0.6;\n}\n.pc-resourceloaderdisplay-root td {\n   border: 1px solid #aaa;\n}\n.pc-resourceloaderdisplay-subtable {\n   border-collapse: collapse;\n}");a.appendChild(b)}},handleRequest:function(a){console.warn("request: "+a.id);this._domAddRequest(a)},
handleLoad:function(a){console.warn("load: "+a.id);if(a=document.getElementsByClassName("pc-resourcesloaderdisplay-progress-"+a.id))for(var b=0;b<a.length;b++)a[b].textContent="100%"},handleError:function(a,b){var c=document.getElementsByClassName("pc-resourcesloaderdisplay-progress-"+a.id);if(c)for(var e=0;e<c.length;e++)c[e].textContent=b},handleProgress:function(){},_domCreate:function(){this._rootTable=document.createElement("table");this._rootTable.setAttribute("class","pc-resourceloaderdisplay-root");
this._element.appendChild(this._rootTable)},_domAddRequest:function(a){var b="pc-resourcesloaderdisplay-progress-"+a.id,c=document.createElement("tr"),e=document.createElement("td");e.textContent=a.identifier;a=document.createElement("td");a.className=b;a.textContent="0%";c.appendChild(e);c.appendChild(a);this._rootTable.appendChild(c)},_sanitizeId:function(a){return a.replace(/\//,"").replace(/\./,"")}};return{ResourceLoaderDisplay:d}}());pc.extend(pc.resources,function(){var d=function(a){this.cache={};this.loader=a};d.prototype={getTexture:function(a){return(a=this.loader.getHash(a))&&this.cache[a]?this.cache[a]:null},addTexture:function(a,b){var c=this.loader.getHash(a);c&&(this.cache[c]=b)}};return{TextureCache:d}}());pc.gfx={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CLEARFLAG_COLOR:1,
CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,
PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",
SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",
SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2};pc.extend(pc.gfx,function(){var d=function(a){this.name=a;this.value=null;this.versionObject=new pc.gfx.VersionedObject};d.prototype={setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(){return this.value}};return{ScopeId:d}}());pc.extend(pc.gfx,function(){var d=function(a){this.name=a;this.variables={};this.namespaces={}};d.prototype={resolve:function(a){!1===this.variables.hasOwnProperty(a)&&(this.variables[a]=new pc.gfx.ScopeId(a));return this.variables[a]},getSubSpace:function(a){!1===this.namespaces.hasOwnProperty(a)&&(this.namespaces[a]=new pc.gfx.ScopeSpace(a),logDEBUG("Added ScopeSpace: "+a));return this.namespaces[a]}};return{ScopeSpace:d}}());pc.extend(pc.gfx,function(){var d=function(){this.revision=this.globalId=0};d.prototype={equals:function(a){return this.globalId===a.globalId&&this.revision===a.revision},notequals:function(a){return this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}};return{Version:d}}());pc.extend(pc.gfx,function(){var d=0,a=function(){d++;this.version=new pc.gfx.Version;this.version.globalId=d};a.prototype={increment:function(){this.version.revision++}};return{VersionedObject:a}}());function WebGLValidator(d){function a(a){return function(){var c=b.gl[a].apply(b.gl,arguments);b.validate(a);return c}}this.gl=d;var b=this,c;for(c in d)this[c]="function"===typeof d[c]?a(c):d[c];this.errorString={};this.errorString[d.NO_ERROR]="NO_ERROR";this.errorString[d.INVALID_ENUM]="INVALID_ENUM";this.errorString[d.INVALID_VALUE]="INVALID_VALUE";this.errorString[d.INVALID_OPERATION]="INVALID_OPERATION";this.errorString[d.OUT_OF_MEMORY]="OUT_OF_MEMORY";this.errorString[d.INVALID_FRAMEBUFFER_OPERATION]=
"INVALID_FRAMEBUFFER_OPERATION"}WebGLValidator.prototype.validate=function(d){var a=this.gl,b=a.getError();return b!==a.NO_ERROR?(pc.log.error("WebGL error from "+d+": "+this.errorString[b]),!1):!0};pc.extend(pc.gfx,function(){function d(g,d){this.index=0;switch(d.dataType){case pc.gfx.ELEMENTTYPE_INT8:this.array=new Int8Array(g,d.offset);break;case pc.gfx.ELEMENTTYPE_UINT8:this.array=new Uint8Array(g,d.offset);break;case pc.gfx.ELEMENTTYPE_INT16:this.array=new Int16Array(g,d.offset);break;case pc.gfx.ELEMENTTYPE_UINT16:this.array=new Uint16Array(g,d.offset);break;case pc.gfx.ELEMENTTYPE_INT32:this.array=new Int32Array(g,d.offset);break;case pc.gfx.ELEMENTTYPE_UINT32:this.array=new Uint32Array(g,
d.offset);break;case pc.gfx.ELEMENTTYPE_FLOAT32:this.array=new Float32Array(g,d.offset)}switch(d.numComponents){case 1:this.set=a;break;case 2:this.set=b;break;case 3:this.set=c;break;case 4:this.set=e}}function a(a){this.array[this.index]=a}function b(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function c(a,b,c){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c}function e(a,b,c,e){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+
2]=c;this.array[this.index+3]=e}function g(a){this.vertexBuffer=a;this.buffer=this.vertexBuffer.lock();this.setters=[];this.element={};for(var a=this.vertexBuffer.getFormat(),b=0;b<a.elements.length;b++){var c=a.elements[b];this.setters[b]=new d(this.buffer,c);this.element[c.name]=this.setters[b]}}g.prototype={next:function(){for(var a=0,b=this.setters,c=this.setters.length,e=this.vertexBuffer.getFormat();a<c;){var g=b[a++];g.index+=e.size/g.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}};
return{VertexIterator:g}}());pc.extend(pc.gfx,function(){var d=[];d[pc.gfx.ELEMENTTYPE_INT8]=1;d[pc.gfx.ELEMENTTYPE_UINT8]=1;d[pc.gfx.ELEMENTTYPE_INT16]=2;d[pc.gfx.ELEMENTTYPE_UINT16]=2;d[pc.gfx.ELEMENTTYPE_INT32]=4;d[pc.gfx.ELEMENTTYPE_UINT32]=4;d[pc.gfx.ELEMENTTYPE_FLOAT32]=4;return{VertexFormat:function(a,b){var c;this.elements=[];c=this.size=0;for(var e=b.length;c<e;c++){var g=b[c],g={name:g.semantic,offset:0,stride:0,stream:-1,scopeId:a.scope.resolve(g.semantic),dataType:g.type,numComponents:g.components,normalize:"undefined"===
typeof g.normalize?!1:g.normalize,size:g.components*d[g.type]};this.elements.push(g);this.size+=g.size}var f=0;c=0;for(e=this.elements.length;c<e;c++)g=this.elements[c],g.offset=f,g.stride=this.size,f+=g.size}}}());pc.extend(pc.gfx,function(){var d=function(a,b,c,e){this.usage=e||pc.gfx.BUFFER_STATIC;this.format=b;this.numVertices=c;this.numBytes=b.size*c;this.device=a;this.bufferId=this.device.gl.createBuffer();this.storage=new ArrayBuffer(this.numBytes)};d.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId)},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var a=
this.device.gl,b;switch(this.usage){case pc.gfx.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.gfx.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.gfx.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)}};return{VertexBuffer:d}}());pc.extend(pc.gfx,function(){var d=function(a,b,c,e){this.usage=e||pc.gfx.BUFFER_STATIC;this.format=b;this.numIndices=c;this.device=a;a=this.device.gl;this.bufferId=a.createBuffer();var g;b===pc.gfx.INDEXFORMAT_UINT8?(g=1,this.glFormat=a.UNSIGNED_BYTE):b===pc.gfx.INDEXFORMAT_UINT16?(g=2,this.glFormat=a.UNSIGNED_SHORT):b===pc.gfx.INDEXFORMAT_UINT32&&(g=4,this.glFormat=a.UNSIGNED_INT);this.storage=new ArrayBuffer(this.numIndices*g)};d.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId)},
getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl,b;switch(this.usage){case pc.gfx.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.gfx.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.gfx.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)}};return{IndexBuffer:d}}());pc.extend(pc.gfx,function(){var d=function(a,b){this.device=a;var c=4,e=4,g=pc.gfx.PIXELFORMAT_R8_G8_B8_A8,f=!1,d=!0;"undefined"!==typeof b&&(c="undefined"!==typeof b.width?b.width:c,e="undefined"!==typeof b.height?b.height:e,g="undefined"!==typeof b.format?b.format:g,f="undefined"!==typeof b.cubemap?b.cubemap:f,d="undefined"!==typeof b.autoMipmap?b.autoMipmap:d);this.name=null;this.autoMipmap=d;var d=this.device.gl,l;this._glTextureId=d.createTexture();this._glTarget=f?d.TEXTURE_CUBE_MAP:d.TEXTURE_2D;
this._cubemap=f;this._format=g;switch(g){case pc.gfx.PIXELFORMAT_A8:this._glInternalFormat=this._glFormat=d.ALPHA;this._glPixelType=d.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_L8:this._glInternalFormat=this._glFormat=d.LUMINANCE;this._glPixelType=d.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_L8_A8:this._glInternalFormat=this._glFormat=d.LUMINANCE_ALPHA;this._glPixelType=d.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_R5_G6_B5:this._glInternalFormat=this._glFormat=d.RGB;this._glPixelType=d.UNSIGNED_SHORT_5_6_5;
break;case pc.gfx.PIXELFORMAT_R5_G5_B5_A1:this._glInternalFormat=this._glFormat=d.RGBA;this._glPixelType=d.UNSIGNED_SHORT_5_5_5_1;break;case pc.gfx.PIXELFORMAT_R4_G4_B4_A4:this._glInternalFormat=this._glFormat=d.RGBA;this._glPixelType=d.UNSIGNED_SHORT_4_4_4_4;break;case pc.gfx.PIXELFORMAT_R8_G8_B8:this._glInternalFormat=this._glFormat=d.RGB;this._glPixelType=d.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_R8_G8_B8_A8:this._glInternalFormat=this._glFormat=d.RGBA;this._glPixelType=d.UNSIGNED_BYTE;break;
case pc.gfx.PIXELFORMAT_DXT1:l=this.device.extCompressedTextureS3TC;this._glFormat=d.RGB;this._glInternalFormat=l.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.gfx.PIXELFORMAT_DXT3:l=this.device.extCompressedTextureS3TC;this._glFormat=d.RGBA;this._glInternalFormat=l.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case pc.gfx.PIXELFORMAT_DXT5:l=this.device.extCompressedTextureS3TC;this._glFormat=d.RGBA;this._glInternalFormat=l.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case pc.gfx.PIXELFORMAT_RGB16F:l=this.device.extTextureHalfFloat;
this._glInternalFormat=this._glFormat=d.RGB;this._glPixelType=l.HALF_FLOAT_OES;break;case pc.gfx.PIXELFORMAT_RGBA16F:l=this.device.extTextureHalfFloat;this._glInternalFormat=this._glFormat=d.RGBA;this._glPixelType=l.HALF_FLOAT_OES;break;case pc.gfx.PIXELFORMAT_RGB32F:this._glInternalFormat=this._glFormat=d.RGB;this._glPixelType=d.FLOAT;break;case pc.gfx.PIXELFORMAT_RGBA32F:this._glInternalFormat=this._glFormat=d.RGBA,this._glPixelType=d.FLOAT}this._compressed=g===pc.gfx.PIXELFORMAT_DXT1||g===pc.gfx.PIXELFORMAT_DXT3||
g===pc.gfx.PIXELFORMAT_DXT5;this._width=c||4;this._height=e||4;this._addressv=this._addressu=pc.gfx.ADDRESS_REPEAT;this.bind();pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)?(d.texParameteri(this._glTarget,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_LINEAR),this._minFilter=pc.gfx.FILTER_LINEAR_MIPMAP_LINEAR):(d.texParameteri(this._glTarget,d.TEXTURE_MIN_FILTER,d.LINEAR),this._minFilter=pc.gfx.FILTER_LINEAR);this._magFilter=pc.gfx.FILTER_LINEAR;this._maxAnisotropy=1;this._levels=f?[[null,
null,null,null,null,null]]:[null];this._lockedLevel=-1;this.upload()};Object.defineProperty(d.prototype,"minFilter",{get:function(){return this._minFilter},set:function(a){if(!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))a===pc.gfx.FILTER_NEAREST||a===pc.gfx.FILTER_LINEAR||(logWARNING("Invalid filter mode set on non power of two texture. Forcing linear addressing."),a=pc.gfx.FILTER_LINEAR);this.bind();var b=this.device.gl;b.texParameteri(this._glTarget,b.TEXTURE_MIN_FILTER,[b.NEAREST,
b.LINEAR,b.NEAREST_MIPMAP_NEAREST,b.NEAREST_MIPMAP_LINEAR,b.LINEAR_MIPMAP_NEAREST,b.LINEAR_MIPMAP_LINEAR][a]);this._minFilter=a}});Object.defineProperty(d.prototype,"magFilter",{get:function(){return this._magFilter},set:function(a){a===pc.gfx.FILTER_NEAREST||a===pc.gfx.FILTER_LINEAR||logWARNING("Invalid maginication filter mode. Must be set to FILTER_NEAREST or FILTER_LINEAR.");this.bind();var b=this.device.gl;b.texParameteri(this._glTarget,b.TEXTURE_MAG_FILTER,[b.NEAREST,b.LINEAR,b.NEAREST_MIPMAP_NEAREST,
b.NEAREST_MIPMAP_LINEAR,b.LINEAR_MIPMAP_NEAREST,b.LINEAR_MIPMAP_LINEAR][a]);this._magFilter=a}});Object.defineProperty(d.prototype,"addressU",{get:function(){return this._addressu},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.gfx.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in U set on non power of two texture. Forcing clamp to edge addressing."),a=pc.gfx.ADDRESS_CLAMP_TO_EDGE;this.bind();var b=this.device.gl;b.texParameteri(this._glTarget,
b.TEXTURE_WRAP_S,[b.REPEAT,b.CLAMP_TO_EDGE,b.MIRRORED_REPEAT][a]);this._addressu=a}});Object.defineProperty(d.prototype,"addressV",{get:function(){return this._addressv},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.gfx.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in V set on non power of two texture. Forcing clamp to edge addressing."),a=pc.gfx.ADDRESS_CLAMP_TO_EDGE;this.bind();var b=this.device.gl;b.texParameteri(this._glTarget,b.TEXTURE_WRAP_T,
[b.REPEAT,b.CLAMP_TO_EDGE,b.MIRRORED_REPEAT][a]);this._addressv=a}});Object.defineProperty(d.prototype,"maxAnisotropy",{get:function(){return this._maxAnisotropy},set:function(a){this._maxAnisotropy=a;var b=this.device,c=b.extTextureFilterAnisotropic;if(c){this.bind();var e=b.gl,a=Math.min(a,b.maxSupportedMaxAnisotropy);e.texParameterf(this._glTarget,c.TEXTURE_MAX_ANISOTROPY_EXT,a)}}});Object.defineProperty(d.prototype,"width",{get:function(){return this._width}});Object.defineProperty(d.prototype,
"height",{get:function(){return this._height}});Object.defineProperty(d.prototype,"format",{get:function(){return this._format}});pc.extend(d.prototype,{bind:function(){this.device.gl.bindTexture(this._glTarget,this._glTextureId)},destroy:function(){this.device.gl.deleteTexture(this._glTextureId)},lock:function(a){a=a||{level:0,face:0,mode:pc.gfx.TEXTURELOCK_WRITE};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=0);void 0===a.mode&&(a.mode=pc.gfx.TEXTURELOCK_WRITE);this._lockedLevel=a.level;
if(null===this._levels[a.level])switch(this._format){case pc.gfx.PIXELFORMAT_A8:case pc.gfx.PIXELFORMAT_L8:this._levels[a.level]=new Uint8Array(this._width*this._height);break;case pc.gfx.PIXELFORMAT_L8_A8:this._levels[a.level]=new Uint8Array(2*this._width*this._height);break;case pc.gfx.PIXELFORMAT_R5_G6_B5:case pc.gfx.PIXELFORMAT_R5_G5_B5_A1:case pc.gfx.PIXELFORMAT_R4_G4_B4_A4:this._levels[a.level]=new Uint16Array(this._width*this._height);break;case pc.gfx.PIXELFORMAT_R8_G8_B8:this._levels[a.level]=
new Uint8Array(3*this._width*this._height);break;case pc.gfx.PIXELFORMAT_R8_G8_B8_A8:this._levels[a.level]=new Uint8Array(4*this._width*this._height);break;case pc.gfx.PIXELFORMAT_DXT1:this._levels[a.level]=new Uint8Array(8*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case pc.gfx.PIXELFORMAT_DXT3:case pc.gfx.PIXELFORMAT_DXT5:this._levels[a.level]=new Uint8Array(16*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case pc.gfx.PIXELFORMAT_RGB16F:case pc.gfx.PIXELFORMAT_RGB32F:this._levels[a.level]=
new Float32Array(3*this._width*this._height);break;case pc.gfx.PIXELFORMAT_RGBA16F:case pc.gfx.PIXELFORMAT_RGBA32F:this._levels[a.level]=new Float32Array(4*this._width*this._height)}return this._levels[a.level]},recover:function(){this._glTextureId=this.device.gl.createTexture();this.addressU=this._addressu;this.addressV=this._addressv;this.minFilter=this._minFilter;this.magFilter=this._magFilter;this.maxAnisotropy=this._maxAnisotropy;this.upload()},load:function(a,b){if(this._cubemap){var c=a.map(function(a){return new pc.resources.ImageRequest(a)});
b.request(c).then(function(a){this.setSource(a)}.bind(this))}else c=new pc.resources.ImageRequest(a),b.request(c).then(function(a){this.setSource(a[0])}.bind(this))},setSource:function(a){if(this._cubemap){logASSERT("[object Array]"===Object.prototype.toString.apply(a),"pc.gfx.Texture: setSource: supplied source is not an array");logASSERT(6===a.length,"pc.gfx.Texture: setSource: supplied source does not have 6 entries.");for(var b=0,c=!0,e=a[0].width,g=a[0].height,d=0;6>d;d++)(a[d]instanceof HTMLCanvasElement||
a[d]instanceof HTMLImageElement||a[d]instanceof HTMLVideoElement)&&b++,a[d].width!==e&&(c=!1),a[d].height!==g&&(c=!1);logASSERT(6===b,"pc.gfx.Texture: setSource: Not all supplied source elements are of required type (canvas, image or video).");logASSERT(c,"pc.gfx.Texture: setSource: Not all supplied source elements share the same dimensions.");this._width=a[0].width;this._height=a[0].height}else logASSERT(a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement,
"pc.gfx.Texture: setSource: supplied source is not an instance of HTMLCanvasElement, HTMLImageElement or HTMLVideoElement."),this._width=a.width,this._height=a.height;this._levels[0]=a;this.upload();this.minFilter=this._minFilter;this.magFilter=this._magFilter;this.addressu=this._addressu;this.addressv=this._addressv},getSource:function(){return this._levels[0]},unlock:function(){logASSERT(-1!==this._lockedLevel,"Attempting to unlock a texture that is not locked");this.upload();this._lockedLevel=
-1},upload:function(){this.bind();var a=this.device.gl,b=this._levels[0];if(this._cubemap){var c;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);if(b[0]instanceof HTMLCanvasElement||b[0]instanceof HTMLImageElement||b[0]instanceof HTMLVideoElement)for(c=0;6>c;c++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,this._glInternalFormat,this._glFormat,this._glPixelType,b[c]);else for(c=0;6>c;c++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,this._glInternalFormat,
this._width,this._height,0,this._glFormat,this._glPixelType,b[c])}else b instanceof HTMLCanvasElement||b instanceof HTMLImageElement||b instanceof HTMLVideoElement?(a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.texImage2D(a.TEXTURE_2D,0,this._glInternalFormat,this._glFormat,this._glPixelType,b)):(a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),this._compressed?a.compressedTexImage2D(a.TEXTURE_2D,0,this._glInternalFormat,this._width,this._height,0,b):a.texImage2D(a.TEXTURE_2D,
0,this._glInternalFormat,this._width,this._height,0,this._glFormat,this._glPixelType,b));this.autoMipmap&&(pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)&&1===this._levels.length)&&a.generateMipmap(this._glTarget)}});return{Texture:d}}());pc.extend(pc.gfx,function(){var d={depth:!0,face:0},a=function(a,c,e){this._device=a;this._colorBuffer=c;e="undefined"!==typeof e?e:d;this._face="undefined"!==typeof e.face?e.face:0;this._depth="undefined"!==typeof e.depth?e.depth:!0;a=this._device.gl;this._frameBuffer=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,this._frameBuffer);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,this._colorBuffer._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+this._face:a.TEXTURE_2D,this._colorBuffer._glTextureId,
0);this._depth&&(this._depthBuffer=a.createRenderbuffer(),a.bindRenderbuffer(a.RENDERBUFFER,this._depthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height),a.bindRenderbuffer(a.RENDERBUFFER,null),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this._depthBuffer));switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:logERROR("RenderTarget error: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:logERROR("RenderTarget error: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:logERROR("RenderTarget error: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:logERROR("RenderTarget error: FRAMEBUFFER_UNSUPPORTED")}a.bindFramebuffer(a.FRAMEBUFFER,null)};a.prototype={bind:function(){var a=this._device.gl;a.bindFramebuffer(a.FRAMEBUFFER,this._frameBuffer)},destroy:function(){var a=this._device.gl;a.deleteFramebuffer(this._frameBuffer);this._depthBuffer&&a.deleteRenderbuffer(this._depthBuffer)},unbind:function(){var a=
this._device.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)}};Object.defineProperty(a.prototype,"colorBuffer",{get:function(){return this._colorBuffer}});Object.defineProperty(a.prototype,"face",{get:function(){return this._face}});Object.defineProperty(a.prototype,"width",{get:function(){return this._colorBuffer.width}});Object.defineProperty(a.prototype,"height",{get:function(){return this._colorBuffer.height}});return{RenderTarget:a}}());pc.gfx.ShaderInputType={BOOL:0,INT:1,FLOAT:2,VEC2:3,VEC3:4,VEC4:5,IVEC2:6,IVEC3:7,IVEC4:8,BVEC2:9,BVEC3:10,BVEC4:11,MAT2:12,MAT3:13,MAT4:14,TEXTURE2D:15,TEXTURECUBE:16};pc.gfx.ShaderInput=function(d,a,b,c){this.locationId=c;this.scopeId=d.scope.resolve(a);this.version=new pc.gfx.Version;this.dataType=b;this.array=[]};pc.extend(pc.gfx,function(){function d(a,c,e){var g=a.createShader(c);a.shaderSource(g,e);a.compileShader(g);if(!a.getShaderParameter(g,a.COMPILE_STATUS)){for(var d=a.getShaderInfoLog(g),h=logERROR,a="Failed to compile "+(c===a.VERTEX_SHADER?"vertex":"fragment")+" shader:\n\n",e=e.split("\n"),c=0,l=e.length;c<l;c++)e[c]=c+1+":\t"+e[c];e=e.join("\n");h(a+e+"\n\n"+d)}return g}var a=function(a,c){this.device=a;this.definition=c;var e=this.device.gl,g=d(e,e.VERTEX_SHADER,c.vshader),f=d(e,e.FRAGMENT_SHADER,
c.fshader),h=e.createProgram();e.attachShader(h,g);e.attachShader(h,f);e.linkProgram(h);if(!e.getProgramParameter(h,e.LINK_STATUS)){var l=e.getProgramInfoLog(h);logERROR("Failed to link shader program. Error: "+l)}this.program=h;e.deleteShader(g);e.deleteShader(f);this.attributes=[];this.uniforms=[];this.samplers=[];g=0;f={};f[e.BOOL]=pc.gfx.ShaderInputType.BOOL;f[e.INT]=pc.gfx.ShaderInputType.INT;f[e.FLOAT]=pc.gfx.ShaderInputType.FLOAT;f[e.FLOAT_VEC2]=pc.gfx.ShaderInputType.VEC2;f[e.FLOAT_VEC3]=
pc.gfx.ShaderInputType.VEC3;f[e.FLOAT_VEC4]=pc.gfx.ShaderInputType.VEC4;f[e.INT_VEC2]=pc.gfx.ShaderInputType.IVEC2;f[e.INT_VEC3]=pc.gfx.ShaderInputType.IVEC3;f[e.INT_VEC4]=pc.gfx.ShaderInputType.IVEC4;f[e.BOOL_VEC2]=pc.gfx.ShaderInputType.BVEC2;f[e.BOOL_VEC3]=pc.gfx.ShaderInputType.BVEC3;f[e.BOOL_VEC4]=pc.gfx.ShaderInputType.BVEC4;f[e.FLOAT_MAT2]=pc.gfx.ShaderInputType.MAT2;f[e.FLOAT_MAT3]=pc.gfx.ShaderInputType.MAT3;f[e.FLOAT_MAT4]=pc.gfx.ShaderInputType.MAT4;f[e.SAMPLER_2D]=pc.gfx.ShaderInputType.TEXTURE2D;
f[e.SAMPLER_CUBE]=pc.gfx.ShaderInputType.TEXTURECUBE;for(var k=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES);g<k;)h=e.getActiveAttrib(this.program,g++),l=e.getAttribLocation(this.program,h.name),"undefined"===typeof c.attributes[h.name]&&console.error('Vertex shader attribute "'+h.name+'" is not mapped to a semantic in shader definition.'),h=new pc.gfx.ShaderInput(a,c.attributes[h.name],f[h.type],l),this.attributes.push(h);g=0;for(k=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS);g<
k;)h=e.getActiveUniform(this.program,g++),l=e.getUniformLocation(this.program,h.name),h.type===e.SAMPLER_2D||h.type===e.SAMPLER_CUBE?this.samplers.push(new pc.gfx.ShaderInput(a,h.name,f[h.type],l)):this.uniforms.push(new pc.gfx.ShaderInput(a,h.name,f[h.type],l))};a.prototype={destroy:function(){this.device.gl.deleteProgram(this.program)}};return{Shader:a}}());pc.extend(pc.gfx,function(){var d=function(a){this._device=a;this._cache={};this._generators={}};d.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=b)};d.prototype.unregister=function(a){this.isRegistered(a)&&delete this._generators[a]};d.prototype.isRegistered=function(a){return void 0!==this._generators[a]};d.prototype.getProgram=function(a,b){var c=this._generators[a];if(void 0===c)return logERROR("No program library functions registered for: "+a),null;var e=c.generateKey(g,
b),g=this._cache[e];if(!g)var g=this._device,c=c.createShaderDefinition(g,b),g=this._cache[e]=new pc.gfx.Shader(g,c);return g};return{ProgramLibrary:d}}());pc.gfx.precalculatedTangents=!0;
pc.extend(pc.gfx,function(){function d(a){this.name="UnsupportedBrowserError";this.message=a||""}function a(a){this.name="ContextCreationError";this.message=a||""}d.prototype=Error.prototype;a.prototype=Error.prototype;var b=function(){logWARNING("Context lost.")},c=function(){logINFO("Context restored.")},e=function(a){this.gl=void 0;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision="highp";this.attributesInvalidated=!0;this.boundBuffer=null;this.enabledAttributes=
{};this.textureUnits=[];this.commitFunction={};if(!window.WebGLRenderingContext)throw new pc.gfx.UnsupportedBrowserError;for(var e={alpha:!1},d=["webgl","experimental-webgl","webkit-3d","moz-webgl"],l=null,k=0;k<d.length;k++){try{l=a.getContext(d[k],e)}catch(n){}if(l)break}this.gl=l;if(!this.gl)throw new pc.gfx.ContextCreationError;a.addEventListener("webglcontextlost",b,!1);a.addEventListener("webglcontextrestored",c,!1);this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision=
"highp";var m=this.gl;logINFO("Device started");logINFO("WebGL version:                "+m.getParameter(m.VERSION));logINFO("WebGL shader version:         "+m.getParameter(m.SHADING_LANGUAGE_VERSION));logINFO("WebGL vendor:                 "+m.getParameter(m.VENDOR));logINFO("WebGL renderer:               "+m.getParameter(m.RENDERER));logINFO("WebGL extensions:             "+m.getSupportedExtensions());logINFO("WebGL max vertex attribs:     "+m.getParameter(m.MAX_VERTEX_ATTRIBS));logINFO("WebGL max vshader vectors:    "+
m.getParameter(m.MAX_VERTEX_UNIFORM_VECTORS));logINFO("WebGL max varying vectors:    "+m.getParameter(m.MAX_VARYING_VECTORS));logINFO("WebGL max fshader vectors:    "+m.getParameter(m.MAX_FRAGMENT_UNIFORM_VECTORS));logINFO("WebGL max combined tex units: "+m.getParameter(m.MAX_COMBINED_TEXTURE_IMAGE_UNITS));logINFO("WebGL max vertex tex units:   "+m.getParameter(m.MAX_VERTEX_TEXTURE_IMAGE_UNITS));logINFO("WebGL max tex units:          "+m.getParameter(m.MAX_TEXTURE_IMAGE_UNITS));logINFO("WebGL max texture size:       "+
m.getParameter(m.MAX_TEXTURE_SIZE));logINFO("WebGL max cubemap size:       "+m.getParameter(m.MAX_CUBE_MAP_TEXTURE_SIZE));a=m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.HIGH_FLOAT);d=m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.MEDIUM_FLOAT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.LOW_FLOAT);e=m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.HIGH_FLOAT);l=m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.MEDIUM_FLOAT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.LOW_FLOAT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,
m.HIGH_INT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.MEDIUM_INT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.LOW_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.HIGH_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.MEDIUM_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.LOW_INT);d=0<d.precision&&0<l.precision;0<a.precision&&0<e.precision||(d?(this.precision="mediump",console.warn("WARNING: highp not supported, using mediump")):(this.precision="lowp",console.warn("WARNING: highp and mediump not supported, using lowp")));
this.defaultClearOptions={color:[0,0,0,1],depth:1,flags:pc.gfx.CLEARFLAG_COLOR|pc.gfx.CLEARFLAG_DEPTH};this.glPrimitive=[m.POINTS,m.LINES,m.LINE_LOOP,m.LINE_STRIP,m.TRIANGLES,m.TRIANGLE_STRIP,m.TRIANGLE_FAN];this.glBlendEquation=[m.FUNC_ADD,m.FUNC_SUBTRACT,m.FUNC_REVERSE_SUBTRACT];this.glBlendFunction=[m.ZERO,m.ONE,m.SRC_COLOR,m.ONE_MINUS_SRC_COLOR,m.DST_COLOR,m.ONE_MINUS_DST_COLOR,m.SRC_ALPHA,m.SRC_ALPHA_SATURATE,m.ONE_MINUS_SRC_ALPHA,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA];this.glClearFlag=[0,m.COLOR_BUFFER_BIT,
m.DEPTH_BUFFER_BIT,m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT];this.glType=[m.BYTE,m.UNSIGNED_BYTE,m.SHORT,m.UNSIGNED_SHORT,m.INT,m.UNSIGNED_INT,m.FLOAT];this.extTextureFloat=m.getExtension("OES_texture_float");this.extTextureHalfFloat=m.getExtension("OES_texture_half_float");this.maxVertexTextures=m.getParameter(m.MAX_VERTEX_TEXTURE_IMAGE_UNITS);
this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures;this.fragmentUniformsCount=m.getParameter(m.MAX_FRAGMENT_UNIFORM_VECTORS);this.extDepthTexture=null;(this.extStandardDerivatives=m.getExtension("OES_standard_derivatives"))&&m.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,m.NICEST);this.maxTextureMaxAnisotropy=1;this.extTextureFilterAnisotropic=m.getExtension("EXT_texture_filter_anisotropic");this.extTextureFilterAnisotropic||(this.extTextureFilterAnisotropic=
m.getExtension("WEBKIT_EXT_texture_filter_anisotropic"));this.extTextureFilterAnisotropic&&(this.maxTextureMaxAnisotropy=m.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT));if(this.extCompressedTextureS3TC=m.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")){a=m.getParameter(m.COMPRESSED_TEXTURE_FORMATS);e="WebGL compressed texture formats:";for(d=0;d<a.length;d++)switch(a[d]){case this.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT:e+=" COMPRESSED_RGB_S3TC_DXT1_EXT";
break;case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT1_EXT:e+=" COMPRESSED_RGBA_S3TC_DXT1_EXT";break;case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT:e+=" COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT:e+=" COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:e+=" UNKOWN("+a[d]+")"}logINFO(e)}(this.extDrawBuffers=m.getExtension("EXT_draw_buffers"))?(logINFO("WebGL max draw buffers:       "+m.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_EXT)),
logINFO("WebGL max color attachments:  "+m.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_EXT))):(logINFO("WebGL max draw buffers:       1"),logINFO("WebGL max color attachments:  1"));this.renderTarget=null;this.scope=new pc.gfx.ScopeSpace("Device");this.commitFunction={};this.commitFunction[pc.gfx.ShaderInputType.BOOL]=function(a,b){m.uniform1i(a,b)};this.commitFunction[pc.gfx.ShaderInputType.INT]=function(a,b){m.uniform1i(a,b)};this.commitFunction[pc.gfx.ShaderInputType.FLOAT]=function(a,
b){"number"==typeof b?m.uniform1f(a,b):m.uniform1fv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.VEC2]=function(a,b){m.uniform2fv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.VEC3]=function(a,b){m.uniform3fv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.VEC4]=function(a,b){m.uniform4fv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.IVEC2]=function(a,b){m.uniform2iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.BVEC2]=function(a,b){m.uniform2iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.IVEC3]=
function(a,b){m.uniform3iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.BVEC3]=function(a,b){m.uniform3iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.IVEC4]=function(a,b){m.uniform4iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.BVEC4]=function(a,b){m.uniform4iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.MAT2]=function(a,b){m.uniformMatrix2fv(a,!1,b)};this.commitFunction[pc.gfx.ShaderInputType.MAT3]=function(a,b){m.uniformMatrix3fv(a,!1,b)};this.commitFunction[pc.gfx.ShaderInputType.MAT4]=
function(a,b){m.uniformMatrix4fv(a,!1,b)};this.setBlending(!1);this.setBlendFunction(pc.gfx.BLENDMODE_ONE,pc.gfx.BLENDMODE_ZERO);this.setBlendEquation(pc.gfx.BLENDEQUATION_ADD);this.setColorWrite(!0,!0,!0,!0);this.setCullMode(pc.gfx.CULLFACE_BACK);this.setDepthTest(!0);this.setDepthWrite(!0);this.setClearDepth(1);this.setClearColor(0,0,0,0);m.enable(m.SCISSOR_TEST);this.programLib=new pc.gfx.ProgramLibrary(this);for(var r in pc.gfx.programlib)this.programLib.register(r,pc.gfx.programlib[r]);r=m.getParameter(m.MAX_VERTEX_UNIFORM_VECTORS);
r=r-16-8;r-=1;r-=16;this.boneLimit=Math.floor(r/4);110<this.boneLimit&&(this.boneLimit=110);pc.events.attach(this);this.boundBuffer=null;this.textureUnits=[];this.attributesInvalidated=!0;this.enabledAttributes={};r=m.createBuffer();a=new ArrayBuffer(16);m.bindBuffer(m.ARRAY_BUFFER,r);m.bufferData(m.ARRAY_BUFFER,a,m.STATIC_DRAW);m.getError();m.vertexAttribPointer(0,4,m.UNSIGNED_BYTE,!1,4,0);this.supportsUnsignedByte=0===m.getError();m.deleteBuffer(r)};e.prototype={setViewport:function(a,b,c,e){this.gl.viewport(a,
b,c,e)},setScissor:function(a,b,c,e){this.gl.scissor(a,b,c,e)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(a){this.programLib=a},updateBegin:function(){logASSERT(null!==this.canvas,"Device has not been started");this.indexBuffer=this.boundBuffer=null;if(this.renderTarget)this.renderTarget.bind();else{var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)}for(a=0;16>a;a++)this.textureUnits[a]=null},updateEnd:function(){},draw:function(a){var b=this.gl,c,e,d,n,m,r,w;
c=this.shader;w=c.samplers;var s=c.uniforms;if(this.attributesInvalidated){r=c.attributes;c=0;for(d=r.length;c<d;c++)e=r[c],n=e.scopeId.value,null!==n&&(m=this.vertexBuffers[n.stream],this.boundBuffer!==m.bufferId&&(b.bindBuffer(b.ARRAY_BUFFER,m.bufferId),this.boundBuffer=m.bufferId),this.enabledAttributes[e.locationId]||(b.enableVertexAttribArray(e.locationId),this.enabledAttributes[e.locationId]=!0),b.vertexAttribPointer(e.locationId,n.numComponents,this.glType[n.dataType],n.normalize,n.stride,
n.offset));this.attributesInvalidated=!1}c=textureUnit=0;for(d=w.length;c<d;c++)if(n=w[c],m=n.scopeId.value,m instanceof pc.gfx.Texture)r=m,this.textureUnits[textureUnit]!==r&&(b.activeTexture(b.TEXTURE0+textureUnit),r.bind(),this.textureUnits[textureUnit]=r),n.slot!==textureUnit&&(b.uniform1i(n.locationId,textureUnit),n.slot=textureUnit),textureUnit++;else{n.array.length=0;numTexures=m.length;for(e=0;e<numTexures;e++)r=m[e],this.textureUnits[textureUnit]!==r&&(b.activeTexture(b.TEXTURE0+textureUnit),
r.bind(),this.textureUnits[textureUnit]=r),n.array[e]=textureUnit,textureUnit++;b.uniform1iv(n.locationId,n.array)}c=0;for(d=s.length;c<d;c++)if(w=s[c],e=w.scopeId,n=w.version,m=e.versionObject.version,n.globalId!==m.globalId||n.revision!==m.revision)n.globalId=m.globalId,n.revision=m.revision,null==e.value&&console.log(e.name+" is null"),this.commitFunction[w.dataType](w.locationId,e.value);a.indexed?b.drawElements(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,2*a.base):b.drawArrays(this.glPrimitive[a.type],
a.base,a.count)},clear:function(a){var b=this.defaultClearOptions,a=a||b,c=void 0===a.flags?b.flags:a.flags;if(0!==c){if(c&pc.gfx.CLEARFLAG_COLOR){var e=void 0===a.color?b.color:a.color;this.setClearColor(e[0],e[1],e[2],e[3])}c&pc.gfx.CLEARFLAG_DEPTH&&this.setClearDepth(void 0===a.depth?b.depth:a.depth);this.gl.clear(this.glClearFlag[c])}},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)},setClearColor:function(a,b,c,e){if(a!==this.clearRed||b!==this.clearGreen||
c!==this.clearBlue||e!==this.clearAlpha)this.gl.clearColor(a,b,c,e),this.clearRed=a,this.clearGreen=b,this.clearBlue=c,this.clearAlpha=e},setRenderTarget:function(a){this.renderTarget=a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==
a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,c,e){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==c||this.writeAlpha!==e)this.gl.colorMask(a,b,c,e),this.writeRed=a,this.writeGreen=b,this.writeBlue=c,this.writeAlpha=e},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b)this.gl.blendFunc(this.glBlendFunction[a],
this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b},setBlendEquation:function(a){this.blendEquation!==a&&(this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a)},setCullMode:function(a){if(this.cullMode!==a){var b=this.gl;switch(a){case pc.gfx.CULLFACE_NONE:b.disable(b.CULL_FACE);break;case pc.gfx.CULLFACE_FRONT:b.enable(b.CULL_FACE);b.cullFace(b.FRONT);break;case pc.gfx.CULLFACE_BACK:b.enable(b.CULL_FACE);b.cullFace(b.BACK);break;case pc.gfx.CULLFACE_FRONTANDBACK:b.enable(b.CULL_FACE),
b.cullFace(b.FRONT_AND_BACK)}this.cullMode=a}},setIndexBuffer:function(a){if(this.indexBuffer!==a){this.indexBuffer=a;var b=this.gl;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a?a.bufferId:null)}},setVertexBuffer:function(a,b){if(this.vertexBuffers[b]!==a){this.vertexBuffers[b]=a;for(var c=0,e=a.getFormat().elements,d=e.length;c<d;){var n=e[c++];n.stream=b;n.scopeId.setValue(n)}this.attributesInvalidated=!0}},setShader:function(a){a!==this.shader&&(this.shader=a,this.gl.useProgram(a.program),this.attributesInvalidated=
!0)},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(a){this.boneLimit=a},enableValidation:function(a){!0===a?this.gl instanceof WebGLRenderingContext&&(this.gl=new WebGLValidator(this.gl)):this.gl instanceof WebGLValidator&&(this.gl=Context.gl)},validate:function(){var a=this.gl,b=a.getError();return b!==a.NO_ERROR?(Log.error("WebGL error: "+WebGLValidator.ErrorString[b]),!1):!0},resizeCanvas:function(a,b){this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)}};
Object.defineProperty(e.prototype,"maxSupportedMaxAnisotropy",{get:function(){return this.maxTextureMaxAnisotropy}});Object.defineProperty(e.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}});Object.defineProperty(e.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(e.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});
return{UnsupportedBrowserError:d,ContextCreationError:a,Device:e}}());pc.extend(pc.gfx,function(){var d={},a={};d.collectAttribs=function(a){for(var c={},e=0,d=a.indexOf("attribute");0<=d;){var f=a.indexOf(";",d),h=a.lastIndexOf(" ",f),f=a.substr(h+1,f-(h+1));"aPosition"==f?c.aPosition=pc.gfx.SEMANTIC_POSITION:(c[f]="ATTR"+e,e++);d=a.indexOf("attribute",d+1)}return c};d.createShader=function(a,c,e){c=d[c];e=pc.gfx.programlib.getSnippet(a,"fs_precision")+"\n"+d[e];attribs=this.collectAttribs(c);return new pc.gfx.Shader(a,{attributes:attribs,vshader:c,fshader:e})};d.createShaderFromCode=
function(b,c,e,d){var f=a[d];if(void 0!=f)return f;e=pc.gfx.programlib.getSnippet(b,"fs_precision")+"\n"+e;attribs=this.collectAttribs(c);a[d]=new pc.gfx.Shader(b,{attributes:attribs,vshader:c,fshader:e});return a[d]};return{shaderChunks:d}}());pc.extend(pc.gfx,function(){var d=null;return{drawQuadWithShader:function(a,b,c){if(null==d){var e=new pc.gfx.VertexFormat(a,[{semantic:pc.gfx.SEMANTIC_POSITION,components:2,type:pc.gfx.ELEMENTTYPE_FLOAT32}]);d=new pc.gfx.VertexBuffer(a,e,4);e=new pc.gfx.VertexIterator(d);e.element[pc.gfx.SEMANTIC_POSITION].set(-1,-1);e.next();e.element[pc.gfx.SEMANTIC_POSITION].set(1,-1);e.next();e.element[pc.gfx.SEMANTIC_POSITION].set(-1,1);e.next();e.element[pc.gfx.SEMANTIC_POSITION].set(1,1);e.end()}a.setRenderTarget(b);
a.updateBegin();e=null!==b?b.width:a.width;b=null!==b?b.height:a.height;a.setViewport(0,0,e,b);a.setScissor(0,0,e,b);b=a.getDepthTest();e=a.getDepthWrite();a.setDepthTest(!1);a.setDepthWrite(!1);a.setVertexBuffer(d,0);a.setShader(c);a.draw({type:pc.gfx.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});a.setDepthTest(b);a.setDepthWrite(e);a.updateEnd()}}}());pc.gfx.shaderChunks.normalVS="vec3 getNormal(inout vsInternalData data) {\n    data.normalMatrix = matrix_normal;\n    return normalize(data.normalMatrix * vertex_normal);\n}\n\n";pc.gfx.shaderChunks.normalMapPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpMapFactor;\nvoid getNormal(inout psInternalData data) {\n    vec3 normalMap = texture2D(texture_normalMap, $UV).xyz * 2.0 - 1.0;\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpMapFactor));\n\n    data.normalW = data.TBN * normalMap;\n}\n\n";
pc.gfx.shaderChunks.particle2PS="varying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap, normalMap, uDepthMap;\nuniform sampler2D internalTex3;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform vec4 screenSize;\nuniform float camera_far;\nuniform float softening;\nuniform float colorMult;\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n\nvoid main(void) {\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = tex1Dlod_lerp(internalTex3, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n\n    ramp.a += texCoordsAlphaLife.z;\n\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n\n";
pc.gfx.shaderChunks.combineDiffuseSpecularNoReflPS="vec3 combineColor(inout psInternalData data) {\n    return data.albedo * data.diffuseLight + data.specularLight * data.specularity;\n}\n\n";pc.gfx.shaderChunks.gamma1_0PS="vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\n\nfloat gammaCorrectInput(float color) {\n    return color;\n}\n\n";
pc.gfx.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS="uniform vec3 material_ambient;\nvec3 combineColor(inout psInternalData data) {\n    return (data.diffuseLight - light_globalAmbient) * data.albedo + data.specularLight * data.specularity + material_ambient * light_globalAmbient;\n}\n\n";pc.gfx.shaderChunks.reflectionSpherePS="uniform mat4 matrix_view;\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectionFactor;\nvoid addSpheremapReflection(inout psInternalData data) {\n\n    vec3 reflDirV = (mat3(matrix_view) * data.reflDirW).xyz;\n\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n    data.reflection += vec4(texture2DSRGB(texture_sphereMap, sphereMapUv).rgb, material_reflectionFactor);\n}\n\n\n";
pc.gfx.shaderChunks.fresnelComplexPS="// More physically-based Fresnel\nuniform float material_fresnelFactor; // should be IOR\nvoid getFresnel(inout psInternalData data) {\n    float cosThetaI = max(dot(data.normalW, data.viewDirW), 0.0);\n    float n = material_fresnelFactor;\n\n    float cosThetaT = sqrt(max(0.0, 1.0 - (1.0 - cosThetaI * cosThetaI) / (n * n)));\n    float nCosThetaT = n * cosThetaT;\n    float nCosThetaI = n * cosThetaI;\n\n    float rS = abs((cosThetaI - nCosThetaT) / (cosThetaI + nCosThetaT));\n    float rP = abs((cosThetaT - nCosThetaI) / (cosThetaT + nCosThetaI));\n    rS *= rS;\n    rP *= rP;\n\n    data.specularity *= (rS + rP) / 2.0;\n}\n\n";
pc.gfx.shaderChunks.particleVS="\n// VERTEX SHADER BODY\nvoid main(void)\n{\n    vec2 uv = particle_uvLifeTimeFrameStart.xy;\n    float lifeTime = particle_uvLifeTimeFrameStart.z;\n    float frameStart = particle_uvLifeTimeFrameStart.w;\n    vec3 position = particle_positionStartTime.xyz;\n    float startTime = particle_positionStartTime.w;\n\n    vec3 velocity = (matrix_model * vec4(particle_velocityStartSize.xyz, 0.0)).xyz + particle_worldVelocity;\n    float startSize = particle_velocityStartSize.w;\n\n    vec3 acceleration = (matrix_model * vec4(particle_accelerationEndSize.xyz, 0.0)).xyz + particle_worldAcceleration;\n    float endSize = particle_accelerationEndSize.w;\n\n    float spinStart = particle_spinStartSpinSpeed.x;\n    float spinSpeed = particle_spinStartSpinSpeed.y;\n\n    float localTime = mod((particle_time - particle_timeOffset - startTime), particle_timeRange);\n    float percentLife = localTime / lifeTime;\n\n    float frame = mod(floor(localTime / particle_frameDuration + frameStart), particle_numFrames);\n    float uOffset = frame / particle_numFrames;\n    float u = uOffset + (uv.x + 0.5) * (1.0 / particle_numFrames);\n\n    vUv0 = vec2(u, uv.y + 0.5);\n    vColor = particle_colorMult;\n\n\n";
pc.gfx.shaderChunks.lightSpecularPhongPS="float getLightSpecular(inout psInternalData data) {\n    return pow(max(dot(data.reflDirW, -data.lightDirNormW), 0.0), data.glossiness);\n}\n\n";pc.gfx.shaderChunks.albedoColorPS="uniform vec3 material_diffuse;\nvoid getAlbedo(inout psInternalData data) {\n    data.albedo = material_diffuse.rgb;\n}\n\n";pc.gfx.shaderChunks.opacityTexPS="uniform sampler2D texture_opacityMap;\nvoid getOpacity(inout psInternalData data) {\n    vec4 tex = texture2D(texture_opacityMap, $UV);\n    data.alpha = tex.r;\n}\n\n";
pc.gfx.shaderChunks.normalVertexPS="void getNormal(inout psInternalData data) {\n    data.normalW = normalize(vNormalW);\n}\n\n";pc.gfx.shaderChunks.shadowPS="float unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\nvoid getShadowCoord(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    vec4 projPos = shadowMatrix * vec4(vPositionW, 1.0);\n    projPos.xyz /= projPos.w;\n    projPos.z += shadowParams.z;\n    data.shadowCoord = projPos.xyz;\n}\n\nbool shadowContained(psInternalData data) {\n    bvec4 containedVec = bvec4(data.shadowCoord.x >= 0.0, data.shadowCoord.x <= 1.0, data.shadowCoord.y >= 0.0, data.shadowCoord.y <= 1.0);\n    return all(bvec2(all(containedVec), data.shadowCoord.z <= 1.0));\n}\n\nfloat getShadow(inout psInternalData data, sampler2D shadowMap, vec3 shadowParams) {\n    if (shadowContained(data)) {\n        float depth = unpackFloat(texture2D(shadowMap, data.shadowCoord.xy));\n        return (depth < data.shadowCoord.z) ? 0.0 : 1.0;\n    }\n    return 1.0;\n}\n\nfloat getShadowPCF3x3(inout psInternalData data, sampler2D shadowMap, vec3 shadowParams) {\n    if (shadowContained(data)) {\n        float shadowAccum = 0.0;\n        vec3 shadowCoord = data.shadowCoord;\n\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float yoffset = 1.0 / shadowParams.y; // 1/shadow map height\n        float dx0 = -xoffset;\n        float dy0 = -yoffset;\n        float dx1 = xoffset;\n        float dy1 = yoffset;\n\n        mat3 shadowKernel;\n        mat3 depthKernel;\n\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dy0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dy1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dy0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dy1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dy0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dy1)));\n\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(lessThan(depthKernel[0], shadowZ));\n        shadowKernel[0] *= vec3(0.25);\n        shadowKernel[1] = vec3(lessThan(depthKernel[1], shadowZ));\n        shadowKernel[1] *= vec3(0.25);\n        shadowKernel[2] = vec3(lessThan(depthKernel[2], shadowZ));\n        shadowKernel[2] *= vec3(0.25);\n\n        vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowParams.xy );\n\n        shadowKernel[0] = mix(shadowKernel[1], shadowKernel[0], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[2], shadowKernel[1], fractionalCoord.x);\n\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y);\n\n        shadowAccum = 1.0 - dot( shadowValues, vec4( 1.0 ) );\n\n        return shadowAccum;\n    }\n    return 1.0;\n}\n\n\n/*float getShadowPoint(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams) {\n    return float(unpackFloat(textureCube(shadowMap, data.lightDirNormW)) > (length(data.lightDirW)/shadowParams.w + shadowParams.z));\n}*/\n\nvec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\nfloat getShadowPoint(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams) {\n\n    vec3 tc = data.lightDirNormW;\n    vec3 tcAbs = abs(tc);\n\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n\n    vec2 shadowParamsInFaceSpace = (((1.0/shadowParams.xy) * 2.0) * abs(majorAxisLength));\n\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace.x);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace.y);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n\n    mat3 shadowKernel;\n    mat3 depthKernel;\n\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n    vec3 shadowZ = vec3(length(data.lightDirW) / shadowParams.w + shadowParams.z);\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[0] *= vec3(0.25);\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[1] *= vec3(0.25);\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n    shadowKernel[2] *= vec3(0.25);\n\n    //vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength) + 1.0) * 0.5;\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n    vec2 fractionalCoord = 1.0 - fract( uv * shadowParams.xy );\n\n    shadowKernel[0] = mix(shadowKernel[1], shadowKernel[0], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[2], shadowKernel[1], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y);\n\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) );\n}\n\n";
pc.gfx.shaderChunks.particleStartVS="// VERTEX SHADER INPUTS: ATTRIBUTES\nattribute vec4 particle_uvLifeTimeFrameStart; // uv, lifeTime, frameStart\nattribute vec4 particle_positionStartTime;    // position.xyz, startTime\nattribute vec4 particle_velocityStartSize;    // velocity.xyz, startSize\nattribute vec4 particle_accelerationEndSize;  // acceleration.xyz, endSize\nattribute vec4 particle_spinStartSpinSpeed;   // spinStart.x, spinSpeed.y\nattribute vec4 particle_colorMult;            // multiplies color and ramp textures\n\n// VERTEX SHADER INPUTS: UNIFORMS\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewInverse;\nuniform vec3 particle_worldVelocity;\nuniform vec3 particle_worldAcceleration;\nuniform float particle_timeRange;\nuniform float particle_time;\nuniform float particle_timeOffset;\nuniform float particle_frameDuration;\nuniform float particle_numFrames;\n\n// VERTEX SHADER OUTPUTS\nvarying vec2 vUv0;\nvarying float vAge;\nvarying vec4 vColor;\n\n";
pc.gfx.shaderChunks.reflectionSphereLowPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectionFactor;\nvoid addSpheremapReflection(inout psInternalData data) {\n\n    vec3 reflDirV = vNormalV;\n\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    data.reflection += vec4(texture2DSRGB(texture_sphereMap, sphereMapUv).rgb, material_reflectionFactor);\n}\n\n";pc.gfx.shaderChunks.particle2_halflambertPS="\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n\n\n";
pc.gfx.shaderChunks.endPS="   gl_FragColor.rgb = combineColor(data);\n   gl_FragColor.rgb += getEmission(data);\n   gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   gl_FragColor.a = data.alpha;\n";pc.gfx.shaderChunks.emissionColorPS="uniform vec3 material_emissive;\nvec3 getEmission(inout psInternalData data) {\n    return material_emissive;\n}\n\n";pc.gfx.shaderChunks.particleEndBBRDVS="\n    vec3 basisX = matrix_viewInverse[0].xyz;\n    vec3 basisZ = matrix_viewInverse[1].xyz;\n    float size = mix(startSize, endSize, percentLife);\n    size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n    float s = sin(spinStart + spinSpeed * localTime);\n    float c = cos(spinStart + spinSpeed * localTime);\n    vec2 rotatedPoint = vec2(uv.x * c + uv.y * s,\n                             -uv.x * s + uv.y * c);\n    vec3 localPosition = vec3(basisX * rotatedPoint.x +\n                              basisZ * rotatedPoint.y) * size +\n                              velocity * localTime +\n                              acceleration * localTime * localTime +\n                              position;\n    vAge = percentLife;\n    gl_Position = matrix_viewProjection * vec4(localPosition + matrix_model[3].xyz, 1.0);\n}\n";
pc.gfx.shaderChunks.startPS="\nvoid main(void) {\n    psInternalData data;\n\tdata.diffuseLight = vec3(0);\n\tdata.specularLight = vec3(0);\n    data.reflection = vec4(0);\n\n\n";pc.gfx.shaderChunks.particle2_TBNVS="\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    localMat[2] *= -1.0;\n    ParticleMat = localMat * rot3;\n\n\n\n\n";pc.gfx.shaderChunks.particleUpdaterRespawnPS="    float accumLifePrev = max(totalTimePrev + startSpawnTime + particleRate, 0.0);\n    bool respawn = floor(accumLife / (particleLifetime + particleRate)) != floor(accumLifePrev / (particleLifetime + particleRate));\n\n    float accumLifeOneShotStart = max(oneShotStartTime + startSpawnTime + particleRate, 0.0);\n    bool endOfSim = floor(accumLife / (particleLifetime + particleRate)) != floor(accumLifeOneShotStart / (particleLifetime + particleRate));\n\n    if (respawn || endOfSim || life <= 0.0) {\n        vec3 inBounds = fract( vec3(rndFactor, rndFactor*10.0, rndFactor*100.0) + frameRandom );\n        tex.xyz = emitterPos + spawnBounds * (inBounds - vec3(0.5));\n        tex.w = mix(startAngle, startAngle2, rndFactor);\n    }\n\n";
pc.gfx.shaderChunks.particle2_meshVS="\n    vec3 localPos = particle_vertexData.xyz;\n    localPos.xy = rotate(localPos.xy, angle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, angle, rotMatrix);\n\n    billboard(particlePos, quadXY, localMat);\n\n\n";pc.gfx.shaderChunks.uv1VS="\nvec2 getUv1(inout vsInternalData data) {\n    return vertex_texCoord1;\n}\n";pc.gfx.shaderChunks.fresnelSimplePS="// Easily tweakable but not very correct Fresnel\nuniform float material_fresnelFactor;\nvoid getFresnel(inout psInternalData data) {\n    float fresnel = 1.0 - max(dot(data.normalW, data.viewDirW), 0.0);\n    data.specularity *= pow(fresnel, material_fresnelFactor);\n}\n\n";
pc.gfx.shaderChunks.glossinessFloatPS="uniform float material_shininess;\nvoid getGlossiness(inout psInternalData data) {\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    data.glossiness = material_shininess + 0.0001;\n}\n\n";pc.gfx.shaderChunks.particle2VS="attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform mat4 matrix_view;\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, totalTime, totalTimePrev, scaleDivMult, alphaDivMult, oneShotStartTime, seed;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY, out mat3 localMat) {\n    vec3 viewUp = matrix_viewInverse[1].xyz;\n    vec3 posCam = matrix_viewInverse[3].xyz;\n\n    mat3 billMat;\n    billMat[2] = normalize(InstanceCoords - posCam);\n    billMat[0] = normalize(cross(viewUp, billMat[2]));\n    billMat[1] = -viewUp;\n    vec3 pos = billMat * vec3(quadXY, 0);\n\n    localMat = billMat;\n\n    return pos;\n}\n\nvoid main(void) {\n    vec2 quadXY = particle_vertexData.xy;\n    float id = floor(particle_vertexData.w);\n\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    vec4 particleTex = texture2D(particleTexOUT, vec2(id / numParticlesPot, 0.0));\n    vec3 pos = particleTex.xyz;\n    float angle = particleTex.w;\n\n    float particleRate = rate + rateDiv * rndFactor;\n    float particleLifetime = lifetime;\n    float startSpawnTime = -particleRate * id;\n    float accumLife = max(totalTime + startSpawnTime + particleRate, 0.0);\n    float life = mod(accumLife, particleLifetime + particleRate) - particleRate;\n    if (life <= 0.0) quadXY = vec2(0,0);\n    float nlife = clamp(life / particleLifetime, 0.0, 1.0);\n\n    float accumLifeOneShotStart = max(oneShotStartTime + startSpawnTime + particleRate, 0.0);\n    bool endOfSim = floor(accumLife / (particleLifetime + particleRate)) != floor(accumLifeOneShotStart / (particleLifetime + particleRate));\n    if (endOfSim) quadXY = vec2(0,0);\n\n    vec3 paramDiv;\n    vec4 params =                 tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5,    (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0),    nlife);\n\n    vec3 particlePos = pos;\n    vec3 particlePosMoved = vec3(0.0);\n\n    mat2 rotMatrix;\n    mat3 localMat;\n\n\n";
pc.gfx.shaderChunks.tangentBinormalVS="\nvec3 getTangent(inout vsInternalData data) {\n    return normalize(data.normalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal(inout vsInternalData data) {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n\n";pc.gfx.shaderChunks.albedoTexPS="uniform sampler2D texture_diffuseMap;\nvoid getAlbedo(inout psInternalData data) {\n    vec4 tex = texture2DSRGB(texture_diffuseMap, $UV);\n    data.albedo = tex.rgb;\n}\n\n";
pc.gfx.shaderChunks.normalSkinnedVS="vec3 getNormal(inout vsInternalData data) {\n    data.normalMatrix = mat3(data.modelMatrix[0].xyz, data.modelMatrix[1].xyz, data.modelMatrix[2].xyz);\n    return normalize(data.normalMatrix * vertex_normal);\n}\n\n";pc.gfx.shaderChunks.lightDiffuseLambertPS="float getLightDiffuse(inout psInternalData data) {\n    return max(dot(data.normalW, -data.lightDirNormW), 0.0);\n}\n\n";pc.gfx.shaderChunks.particle2_stretchVS="    float accumLifePrev = max(totalTimePrev + startSpawnTime + particleRate, 0.0);\n    bool respawn = floor(accumLife / (particleLifetime + particleRate)) != floor(accumLifePrev / (particleLifetime + particleRate));\n\n    if (!respawn) {\n        particleTex = texture2D(particleTexIN, vec2(id / numParticlesPot, 0.0));\n        vec3 posPrev = particleTex.xyz;\n        vec3 moveDir = (pos - posPrev) * stretch;\n        posPrev = pos - moveDir;\n        posPrev += particlePosMoved;\n\n        float interpolation =  quadXY.y * 0.5 + 0.5;\n        particlePos = mix(particlePos, posPrev, interpolation);\n    }\n\n";
pc.gfx.shaderChunks.opacityFloatPS="uniform float material_opacity;\nvoid getOpacity(inout psInternalData data) {\n    data.alpha = material_opacity;\n}\n\n";pc.gfx.shaderChunks.ambientPS="\nvoid getAmbientConstant(inout psInternalData data) {\n    data.diffuseLight = light_globalAmbient;\n}\n";pc.gfx.shaderChunks.particleUpdaterStartPS="varying vec2 vUv0;\n\nuniform sampler2D particleTexIN;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform mat3 spawnBounds;\nuniform mat3 emitterMatrix;\nuniform float delta, rate, rateDiv, lifetime, numParticles, totalTime, totalTimePrev, rotSpeedDivMult, oneShotStartTime, oneShotEndTime, seed;\nuniform float startAngle, startAngle2;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform vec3 emitterScale;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n\n    vec4 tex = texture2D(particleTexIN, vec2(vUv0.x, 0));\n\n    float rndFactor = fract(sin(gl_FragCoord.x + 0.5 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    float particleRate = rate + rateDiv * rndFactor;\n    float particleLifetime = lifetime;\n    float startSpawnTime = -particleRate * (gl_FragCoord.x - 0.5);\n    float accumLife = max(totalTime + startSpawnTime + particleRate, 0.0);\n    float life = mod(accumLife, particleLifetime + particleRate) - particleRate;\n\n    if (life > 0.0) {\n        life = clamp(life / particleLifetime, 0.0, 1.0);\n        vec3 localVelocityDiv;\n        vec3 velocityDiv;\n        vec3 paramDiv;\n        vec3 localVelocity =    tex1Dlod_lerp(internalTex0, vec2(life, 0), localVelocityDiv).xyz;\n        vec3 velocity =         tex1Dlod_lerp(internalTex1, vec2(life, 0), velocityDiv).xyz;\n        vec4 params =           tex1Dlod_lerp(internalTex2, vec2(life, 0), paramDiv);\n\n        float rotSpeed = params.x;\n        float rotSpeedDiv = paramDiv.y;\n\n        localVelocity +=        (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor3;\n        velocity +=             (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor3.zxy;\n        rotSpeed +=             (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor3.y;\n\n        tex.xyz += (emitterMatrix * localVelocity.xyz + velocity.xyz * emitterScale) * delta;\n        tex.w += rotSpeed * delta;\n    }\n\n";
pc.gfx.shaderChunks.viewNormalVS="\nuniform mat4 matrix_view;\nvec3 getViewNormal(inout vsInternalData data) {\n    return mat3(matrix_view) * vNormalW;\n}\n";pc.gfx.shaderChunks.transformVS="mat4 getModelMatrix(inout vsInternalData data) {\n    return matrix_model;\n}\n\nvec4 getPosition(inout vsInternalData data) {\n    data.modelMatrix = getModelMatrix(data);\n    vec4 posW = data.modelMatrix * vec4(vertex_position, 1.0);\n    data.positionW = posW.xyz;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition(inout vsInternalData data) {\n    return data.positionW;\n}\n\n";
pc.gfx.shaderChunks.uv0VS="\nvec2 getUv0(inout vsInternalData data) {\n    return vertex_texCoord0;\n}\n";pc.gfx.shaderChunks.particle2_lightingPS="\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n\n    rgb *= light;\n\n\n";pc.gfx.shaderChunks.opacityTexFloatPS="uniform sampler2D texture_opacityMap;\nuniform float material_opacity;\nvoid getOpacity(inout psInternalData data) {\n    vec4 tex = texture2D(texture_opacityMap, $UV);\n    data.alpha = tex.r * material_opacity;\n}\n\n";
pc.gfx.shaderChunks.baseVS="\n// Compiler should remove unneeded stuff\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform vec3 view_position;\n\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\nvarying vec3 vTangentW;\nvarying vec3 vBinormalW;\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec4 vVertexColor;\nvarying vec3 vNormalV;\n\nstruct vsInternalData {\n    vec3 positionW;\n    mat4 modelMatrix;\n    mat3 normalMatrix;\n};\n\n";
pc.gfx.shaderChunks.particleUpdaterEndPS="\n    gl_FragColor = tex;\n}\n";pc.gfx.shaderChunks.particle2_endPS="    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n";pc.gfx.shaderChunks.basePS="\n// Compiler should remove unneeded stuff\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\nvarying vec3 vTangentW;\nvarying vec3 vBinormalW;\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec4 vVertexColor;\nvarying vec3 vNormalV;\n\nstruct psInternalData {\n    vec3 albedo;\n    vec3 specularity;\n    float glossiness;\n    vec3 emission;\n    vec3 normalW;\n    mat3 TBN;\n    vec3 viewDirW;\n    vec3 reflDirW;\n    vec3 diffuseLight;\n    vec3 specularLight;\n    vec4 reflection;\n    float alpha;\n    vec3 lightDirNormW;\n    vec3 lightDirW;\n    float atten;\n    vec3 shadowCoord;\n    vec2 uvOffset;\n};\n\nvoid getViewDir(inout psInternalData data) {\n    data.viewDirW = normalize(view_position - vPositionW);\n}\n\nvoid getReflDir(inout psInternalData data) {\n    data.reflDirW = normalize(-reflect(data.viewDirW, data.normalW));\n}\n\nvoid addAmbientConstant(inout psInternalData data) {\n    data.diffuseLight += light_globalAmbient;\n}\n\nvoid getLightDirPoint(inout psInternalData data, vec3 lightPosW) {\n    data.lightDirW = vPositionW - lightPosW;\n    data.lightDirNormW = normalize(data.lightDirW);\n}\n\nfloat getFalloffLinear(inout psInternalData data, float lightRadius) {\n    float d = length(data.lightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n\nfloat square(float x) {\n    return x*x;\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat getFalloffInvSquared(inout psInternalData data, float lightRadius) {\n    float sqrDist = dot(data.lightDirW, data.lightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n    return falloff;\n}\n\nfloat getSpotEffect(inout psInternalData data, vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(data.lightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n\n";
pc.gfx.shaderChunks.particle2_normalMapPS="\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n\n\n\n\n";pc.gfx.shaderChunks.specularityColorPS="uniform vec3 material_specular;\nvoid getSpecularity(inout psInternalData data) {\n    data.specularity = material_specular;\n}\n\n";pc.gfx.shaderChunks.combineDiffuseSpecularPS="vec3 combineColor(inout psInternalData data) {\n    return mix(data.albedo * data.diffuseLight, data.specularLight + data.reflection.rgb * data.reflection.a, data.specularity);\n}\n\n";
pc.gfx.shaderChunks.particlePS="// FRAGMENT SHADER INPUTS: VARYINGS\nvarying vec2 vUv0;\nvarying float vAge;\nvarying vec4 vColor;\n\n// FRAGMENT SHADER INPUTS: UNIFORMS\nuniform sampler2D texture_colorMap;\nuniform sampler2D texture_opacityMap;\nuniform sampler2D texture_rampMap;\n\nvoid main(void)\n{\n    vec4 colorMult = texture2D(texture_rampMap, vec2(vAge, 0.5)) * vColor;\n    vec3 rgb = texture2D(texture_colorMap, vUv0).rgb;\n    float a = texture2D(texture_opacityMap, vUv0).r;\n    gl_FragColor = vec4(rgb, a) * colorMult;\n}\n\n";
pc.gfx.shaderChunks.combineDiffusePS="vec3 combineColor(inout psInternalData data) {\n    return data.albedo * data.diffuseLight;\n}\n\n";pc.gfx.shaderChunks.specularityTexPS="uniform sampler2D texture_specularMap;\nvoid getSpecularity(inout psInternalData data) {\n    vec4 tex = texture2D(texture_specularMap, $UV);\n    data.specularity = tex.rgb;\n}\n\n";pc.gfx.shaderChunks.lightSpecularBlinnPS="// Energy-conserving (hopefully) Blinn-Phong\nfloat getLightSpecular(inout psInternalData data) {\n    vec3 h = normalize( -data.lightDirNormW - -data.viewDirW );\n    float nh = max( dot( h, data.normalW ), 0.0 );\n    return pow( nh, data.glossiness ) * (data.glossiness + 2.0)/8.0;\n}\n\n";
pc.gfx.shaderChunks.TBNPS="void getTBN(inout psInternalData data) {\n    data.TBN = mat3(normalize(vTangentW), normalize(vBinormalW), normalize(vNormalW));\n}\n\n";pc.gfx.shaderChunks.particle2_blendAddPS="\n    rgb *= gammaCorrectInput(a);\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n\n";pc.gfx.shaderChunks.gamma2_2PS="vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\n\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return pow(color, vec3(0.45));\n}\n\n";
pc.gfx.shaderChunks.particle2_wrapVS="\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_viewInverse[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_viewInverse[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n\n\n";pc.gfx.shaderChunks.transformSkinnedVS="mat4 getModelMatrix(inout vsInternalData data) {\n    return             vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n}\n\nvec4 getPosition(inout vsInternalData data) {\n    data.modelMatrix = getModelMatrix(data);\n    vec4 posW = data.modelMatrix * vec4(vertex_position, 1.0);\n    data.positionW = posW.xyz / posW.w;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition(inout vsInternalData data) {\n    return data.positionW;\n}\n\n";
pc.gfx.shaderChunks.albedoTexColorPS="uniform sampler2D texture_diffuseMap;\nuniform vec3 material_diffuse;\nvoid getAlbedo(inout psInternalData data) {\n    vec4 tex = texture2DSRGB(texture_diffuseMap, $UV);\n    data.albedo = tex.rgb * material_diffuse;\n}\n\n";pc.gfx.shaderChunks.particle2_normalVS="\n    Normal = normalize(localPos - localMat[2]);\n\n\n";pc.gfx.shaderChunks.particle2_blendMultiplyPS="\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n\n";
pc.gfx.shaderChunks.particle2_softPS="\n    vec2 screenTC = gl_FragCoord.xy / screenSize.xy;\n    float depth = unpackFloat( texture2D(uDepthMap, screenTC) ) * camera_far;\n    float particleDepth = gl_FragCoord.z / gl_FragCoord.w;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n\n";pc.gfx.shaderChunks.particle2_blendNormalPS="\n    if (a < 0.01) discard;\n";pc.gfx.shaderChunks.particle2_cpu_meshVS="\n    worldPos -= localPos;\n    localPos = particle_vertexData3.xyz;\n    localPos.xy = rotate(localPos.xy, particle_vertexData2.x, rotMatrix);\n    localPos.yz = rotate(localPos.yz, particle_vertexData2.x, rotMatrix);\n    worldPos += localPos;\n\n";
pc.gfx.shaderChunks.specularityTexColorPS="uniform sampler2D texture_specularMap;\nuniform vec3 material_specular;\nvoid getSpecularity(inout psInternalData data) {\n    vec4 tex = texture2D(texture_specularMap, $UV);\n    data.specularity = tex.rgb * material_specular;\n}\n\n";pc.gfx.shaderChunks.startVS="\nvoid main(void) {\n    vsInternalData data;\n\n    gl_Position = getPosition(data);\n";pc.gfx.shaderChunks.particle2_billboardVS="\n    quadXY = rotate(quadXY, angle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY, localMat);\n\n";
pc.gfx.shaderChunks.combineDiffuseSpecularOldPS="vec3 combineColor(inout psInternalData data) {\n    return mix(data.albedo * data.diffuseLight + data.specularLight * data.specularity, data.reflection.rgb, data.reflection.a);\n}\n\n";pc.gfx.shaderChunks.lightmapSinglePS="uniform sampler2D texture_lightMap;\nvoid addLightmap(inout psInternalData data) {\n    data.diffuseLight += texture2D(texture_lightMap, vUv1).rgb;\n}\n\n";pc.gfx.shaderChunks.emissionTexPS="uniform sampler2D texture_emissiveMap;\nvec3 getEmission(inout psInternalData data) {\n    vec4 tex = texture2D(texture_emissiveMap, $UV);\n    return tex.rgb;\n}\n\n";
pc.gfx.shaderChunks.reflectionCubePS="uniform samplerCube texture_cubeMap;\nuniform float material_reflectionFactor;\nvoid addCubemapReflection(inout psInternalData data) {\n    data.reflection += vec4(textureCubeSRGB(texture_cubeMap, data.reflDirW).rgb, material_reflectionFactor);\n}\n\n";pc.gfx.shaderChunks.particle2_lambertPS="\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n\n\n";pc.gfx.shaderChunks.particleStartRotationVS="\n// VERTEX SHADER INPUTS: ROTATION ATTRIBUTE (not used on billboards)\nattribute vec4 particle_orientation;\n\n";
pc.gfx.shaderChunks.fullscreenQuadVS="attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.5, 1.0);\n    vUv0 = aPosition.xy*0.5+0.5;\n}\n\n";pc.gfx.shaderChunks.particle2_cpu_endVS="\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n}\n\n";pc.gfx.shaderChunks.particle2_cpuVS="attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = unused\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nvarying vec4 texCoordsAlphaLife;\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY, out mat3 localMat)\n{\n    vec3 viewUp = matrix_viewInverse[1].xyz;\n    vec3 posCam = matrix_viewInverse[3].xyz;\n\n    mat3 billMat;\n    billMat[2] = normalize(InstanceCoords - posCam);\n    billMat[0] = normalize(cross(viewUp, billMat[2]));\n    billMat[1] = -viewUp;\n    vec3 pos = billMat * vec3(quadXY, 0);\n\n    localMat = billMat;\n\n    return pos;\n}\n\n\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 vertPos = particle_vertexData3.xyz;\n\n    vec2 quadXY = vertPos.xy;\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n\n    mat2 rotMatrix;\n    mat3 localMat;\n\n    quadXY = rotate(quadXY, particle_vertexData2.x, rotMatrix);\n\n    vec3 localPos = billboard(particlePos, quadXY, localMat);\n    vec3 particlePosMoved = vec3(0.0);\n\n\n\n";
pc.gfx.shaderChunks.particle2_endVS="\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n}\n";pc.gfx.shaderChunks.particleEndVS="\n    float size = mix(startSize, endSize, percentLife);\n    size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n    float s = sin(spinStart + spinSpeed * localTime);\n    float c = cos(spinStart + spinSpeed * localTime);\n\n    vec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0.0, (uv.x * s - uv.y * c) * size, 1.0);\n    vec3 center = velocity * localTime + acceleration * localTime * localTime + position;\n\n    vec4 q2 = particle_orientation + particle_orientation;\n    vec4 qx = particle_orientation.xxxw * q2.xyzx;\n    vec4 qy = particle_orientation.xyyw * q2.xyzy;\n    vec4 qz = particle_orientation.xxzw * q2.xxzz;\n\n    mat4 localMatrix =\n         mat4((1.0 - qy.y) - qz.z, qx.y + qz.w, qx.z - qy.w, 0,\n              qx.y - qz.w, (1.0 - qx.x) - qz.z, qy.z + qx.w, 0,\n              qx.z + qy.w, qy.z - qx.w, (1.0 - qx.x) - qy.y, 0,\n              center.x, center.y, center.z, 1);\n    rotatedPoint = localMatrix * rotatedPoint;\n    vAge = percentLife;\n    gl_Position = matrix_viewProjection * vec4(rotatedPoint.xyz + matrix_model[3].xyz, 1.0);\n}\n";
pc.gfx.shaderChunks.parallaxPS="uniform sampler2D texture_heightMap;\nvoid getParallax(inout psInternalData data) {\n    const float parallaxScale = 0.025;\n    const float parallaxBias = 0.01;\n\n    float height = texture2D(texture_heightMap, $UV).r * parallaxScale - parallaxBias;\n    vec3 viewDirT = data.viewDirW * data.TBN;\n\n    data.uvOffset = min(height * viewDirT.xy, vec2(parallaxBias));\n}\n\n";pc.gfx.shaderChunks.fresnelSchlickPS="// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel(inout psInternalData data) {\n    float fresnel = 1.0 - max(dot(data.normalW, data.viewDirW), 0.0);\n    data.specularity = data.specularity + (1.0 - data.specularity) * fresnel * fresnel * fresnel * fresnel * fresnel;\n}\n\n";
pc.gfx.shaderChunks.emissionTexColorPS="uniform sampler2D texture_emissiveMap;\nuniform vec3 material_emissive;\nvec3 getEmission(inout psInternalData data) {\n    vec4 tex = texture2D(texture_emissiveMap, $UV);\n    return tex.rgb * material_emissive;\n}\n\n";pc.gfx.shaderChunks.glossinessTexPS="uniform sampler2D texture_glossMap;\nvoid getGlossiness(inout psInternalData data) {\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    vec4 tex = texture2D(texture_glossMap, $UV);\n    data.glossiness = tex.r * 100.0 + 0.0001;\n}\n\n";pc.extend(pc.gfx.shaderChunks,function(){return{defaultGamma:pc.gfx.shaderChunks.gamma1_0PS,defaultSpecular:pc.gfx.shaderChunks.lightSpecularPhongPS,defaultFresnel:pc.gfx.shaderChunks.fresnelSimplePS}}());pc.gfx.programlib={getSnippet:function(d,a){var b="";switch(a){case "common_main_begin":b+="void main(void)\n{\n";break;case "common_main_end":b+="}\n";break;case "fs_alpha_test_decl":b+="uniform float alpha_ref;\n";break;case "fs_alpha_test":b+="    if (gl_FragColor.a < alpha_ref) discard;\n\n";break;case "fs_clamp":b+="    gl_FragColor = clamp(gl_FragColor, 0.0, 1.0);\n";break;case "fs_flat_color_decl":b+="uniform vec4 uColor;\n";break;case "fs_flat_color":b+="    gl_FragColor = uColor;\n";break;
case "fs_fog_linear_decl":case "fs_fog_exp_decl":case "fs_fog_exp2_decl":b+="uniform vec3 fog_color;\n";b="fs_fog_linear_decl"===a?b+"uniform float fog_start;\nuniform float fog_end;\n\n":b+"uniform float fog_density;\n\n";break;case "fs_fog_linear":case "fs_fog_exp":case "fs_fog_exp2":b+="    float depth = gl_FragCoord.z / gl_FragCoord.w;\n";b="fs_fog_linear"===a?b+"    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n":"fs_fog_exp"===a?b+"    float fogFactor = exp(-depth * fog_density);\n":
b+"    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n";b+="    fogFactor = clamp(fogFactor, 0.0, 1.0);\n";b+="    gl_FragColor.rgb = mix(fog_color, gl_FragColor.rgb, fogFactor);\n";break;case "fs_precision":b+="precision "+d.precision+" float;\n\n";break;case "fs_height_map_funcs":b+="vec3 perturb_normal( vec3 N, vec3 p, vec2 uv )\n";b+="{\n";b+="    vec3 dp1 = dFdx( p );\n";b+="    vec3 dp2 = dFdy( p );\n";b+="    vec2 duv1 = dFdx( uv );\n";b+="    vec2 duv2 = dFdy( uv );\n\n";
b+="    vec3 dp2perp = cross( dp2, N );\n";b+="    vec3 dp1perp = cross( N, dp1 );\n\n";b+="    const float bumpScale = 0.125;\n";b+="    float Hll = bumpScale * texture2D( texture_heightMap, uv ).x;\n";b+="    float dBx = bumpScale * texture2D( texture_heightMap, uv + duv1 ).x - Hll;\n";b+="    float dBy = bumpScale * texture2D( texture_heightMap, uv + duv2 ).x - Hll;\n\n";b+="    float fDet = dot( dp1, dp2perp );\n";b+="    vec3 vGrad = sign( fDet ) * ( dBx * dp2perp + dBy * dp1perp );\n";b+="    return normalize( abs( fDet ) * N - vGrad );\n";
b+="}\n\n";break;case "fs_normal_map_funcs":pc.gfx.precalculatedTangents||(b+="mat3 cotangent_frame( vec3 N, vec3 p, vec2 uv )\n",b+="{\n",b+="    vec3 dp1 = dFdx( p );\n",b+="    vec3 dp2 = dFdy( p );\n",b+="    vec2 duv1 = dFdx( uv );\n",b+="    vec2 duv2 = dFdy( uv );\n\n",b+="    vec3 dp2perp = cross( dp2, N );\n",b+="    vec3 dp1perp = cross( N, dp1 );\n",b+="    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n",b+="    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n",b+="    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n",
b+="    return mat3( T * invmax, B * invmax, N );\n",b+="}\n\n",b+="vec3 perturb_normal( vec3 N, vec3 V, vec2 uv )\n",b+="{\n",b+="    vec3 map = texture2D( texture_normalMap, uv ).xyz;\n",b+="    map = map * 255./127. - 128./127.;\n",b+="    map.xy = map.xy * material_bumpMapFactor;\n",b+="    mat3 TBN = cotangent_frame( N, -V, uv );\n",b+="    return normalize( TBN * map );\n",b+="}\n\n");break;case "vs_skin_decl":b=d.supportsBoneTextures?b+"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\n\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n\n    y = dy * (y + 0.5);\n\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n\n    mat4 bone = mat4(v1, v2, v3, v4);\n\n    return bone;\n}":
b+["attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n","uniform mat4 matrix_pose["+d.getBoneLimit()+"];","\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n\n    return bone;\n}"].join("\n");b+="\n\n";break;case "vs_transform_decl":b+="attribute vec3 vertex_position;\n",b+="uniform mat4 matrix_model;\n",b+="uniform mat4 matrix_viewProjection;\n\n"}return b}};pc.gfx.programlib.basic={generateKey:function(d,a){var b="basic";a.fog&&(b+="_fog");a.alphaTest&&(b+="_atst");a.vertexColors&&(b+="_vcol");a.diffuseMap&&(b+="_diff");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.gfx.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);a.vertexColors&&(b.vertex_color=pc.gfx.SEMANTIC_COLOR);a.diffuseMap&&(b.vertex_texCoord0=pc.gfx.SEMANTIC_TEXCOORD0);var c=pc.gfx.programlib.getSnippet,
e;e=""+c(d,"vs_transform_decl");a.skin&&(e+=c(d,"vs_skin_decl"));a.vertexColors&&(e+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");a.diffuseMap&&(e+="attribute vec2 vertex_texCoord0;\n",e+="varying vec2 vUv0;\n");e+=c(d,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",
e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):e+="    mat4 modelMatrix = matrix_model;\n";e+="\n";e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.vertexColors&&(e+="    vColor = vertex_color;\n");a.diffuseMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=c(d,"common_main_end");e=c(d,"fs_precision");e=a.vertexColors?e+"varying vec4 vColor;\n":e+"uniform vec4 uColor;\n";
a.diffuseMap&&(e+="varying vec2 vUv0;\n",e+="uniform sampler2D texture_diffuseMap;\n");a.fog&&(e+=c(d,"fs_fog_decl"));a.alphatest&&(e+=c(d,"fs_alpha_test_decl"));e+=c(d,"common_main_begin");e=a.vertexColors?e+"    gl_FragColor = vColor;\n":e+"    gl_FragColor = uColor;\n";a.diffuseMap&&(e+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");a.alphatest&&(e+=c(d,"fs_alpha_test"));e+=c(d,"fs_clamp");a.fog&&(e+=c(d,"fs_fog"));e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.depth={generateKey:function(d,a){var b="depth";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.gfx.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.gfx.SEMANTIC_TEXCOORD0);var c=pc.gfx.programlib.getSnippet,e;e=""+c(d,"vs_transform_decl");a.skin&&(e+=c(d,"vs_skin_decl"));a.opacityMap&&(e+="attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");
e+=c(d,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):e+="    mat4 modelMatrix = matrix_model;\n";e+="\n";e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";
e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.opacityMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=c(d,"common_main_end");e=c(d,"fs_precision");e+="uniform float camera_near;\n";e+="uniform float camera_far;\n";e+="vec4 packFloat(float depth)\n";e+="{\n";e+="    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n";e+="    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n";e+="    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n";
e+="    res -= res.xxyz * bit_mask;\n";e+="    return res;\n";e+="}\n\n";e+=c(d,"common_main_begin");e+="float depth = gl_FragCoord.z / gl_FragCoord.w;\n";e+="gl_FragColor = packFloat(depth / camera_far);\n";e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.depthrgba={generateKey:function(d,a){var b="depthrgba";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");a.point&&(b+="_pnt");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.gfx.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.gfx.SEMANTIC_TEXCOORD0);var c=pc.gfx.programlib.getSnippet,e;e=""+c(d,"vs_transform_decl");a.skin&&(e+=c(d,"vs_skin_decl"));
a.opacityMap&&(e+="attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");a.point&&(e+="uniform vec3 view_position;\n\n",e+="uniform float light_radius;\n\n",e+="varying float vDistance;\n\n");e+=c(d,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",
e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):e+="    mat4 modelMatrix = matrix_model;\n";e+="\n";e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.opacityMap&&(e+="    vUv0 = vertex_texCoord0;\n");a.point&&(e+="    vDistance = distance(view_position, positionW.xyz) / light_radius;\n");var g=e+=c(d,"common_main_end");e=c(d,"fs_precision");a.opacityMap&&(e+="varying vec2 vUv0;\n\n",
e+="uniform sampler2D texture_opacityMap;\n\n");a.point&&(e+="varying float vDistance;\n\n");e+="vec4 packFloat(float depth)\n";e+="{\n";e+="    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n";e+="    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n";e+="    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n";e+="    res -= res.xxyz * bit_mask;\n";e+="    return res;\n";e+="}\n\n";e+=c(d,"common_main_begin");a.opacityMap&&
(e+="    if (texture2D(texture_opacityMap, vUv0).r < 0.25) discard;\n\n");e=a.point?e+"   gl_FragData[0] = packFloat(vDistance);\n":e+"    gl_FragData[0] = packFloat(gl_FragCoord.z);\n";e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.particle={generateKey:function(d,a){var b="particle";a.billboard&&(b+="_bbrd");return b},createShaderDefinition:function(d,a){var b={particle_uvLifeTimeFrameStart:pc.gfx.SEMANTIC_ATTR0,particle_positionStartTime:pc.gfx.SEMANTIC_ATTR1,particle_velocityStartSize:pc.gfx.SEMANTIC_ATTR2,particle_accelerationEndSize:pc.gfx.SEMANTIC_ATTR3,particle_spinStartSpinSpeed:pc.gfx.SEMANTIC_ATTR4,particle_colorMult:pc.gfx.SEMANTIC_ATTR5};a.billboard||(b.particle_orientation=pc.gfx.SEMANTIC_ATTR6);
var c=pc.gfx.programlib.getSnippet,e,g=pc.gfx.shaderChunks;e=""+g.particleStartVS;a.billboard||(e+=g.particleStartRotationVS);e+=g.particleVS;var f=e+=a.billboard?g.particleEndBBRDVS:g.particleEndVS;e=c(d,"fs_precision");e+=g.particlePS;return{attributes:b,vshader:f,fshader:e}}};pc.gfx.programlib.particle2={generateKey:function(d,a){return"particle2"+a.mode+a.normal+a.halflambert+a.stretch+a.soft+a.mesh+a.srgb+a.wrap+a.blend},createShaderDefinition:function(d,a){var b=pc.gfx.programlib.getSnippet,c=pc.gfx.shaderChunks,e="",b=b(d,"fs_precision")+"\n";0==a.mode?(1==a.normal&&(e+="\nvarying vec3 Normal;\n"),2==a.normal&&(e+="\nvarying mat3 ParticleMat;\n"),e+=c.particle2VS,a.wrap&&(e+=c.particle2_wrapVS),e+=a.mesh?c.particle2_meshVS:c.particle2_billboardVS,1==a.normal&&(e+=
c.particle2_normalVS),2==a.normal&&(e+=c.particle2_TBNVS),0<a.stretch&&(e+=c.particle2_stretchVS),e+=c.particle2_endVS):(1==a.normal&&(e+="\nvarying vec3 Normal;\n"),2==a.normal&&(e+="\nvarying mat3 ParticleMat;\n"),e+=c.particle2_cpuVS,a.mesh&&(e+=c.particle2_cpu_meshVS),1==a.normal&&(e+=c.particle2_normalVS),2==a.normal&&(e+=c.particle2_TBNVS),e+=c.particle2_cpu_endVS);0<a.normal&&(1==a.normal?b+="\nvarying vec3 Normal;\n":2==a.normal&&(b+="\nvarying mat3 ParticleMat;\n"),b+="\nuniform vec3 lightCube[6];\n");
0==a.normal&&(a.srgb=!1);b+=a.srgb?c.gamma2_2PS:c.gamma1_0PS;b+=c.particle2PS;0<a.soft&&(b+=c.particle2_softPS);1==a.normal&&(b+="\nvec3 normal = Normal;\n");2==a.normal&&(b+=c.particle2_normalMapPS);0<a.normal&&(b+=a.halflambert?c.particle2_halflambertPS:c.particle2_lambertPS);0<a.normal&&(b+=c.particle2_lightingPS);a.blend==pc.scene.BLEND_NORMAL?b+=c.particle2_blendNormalPS:a.blend==pc.scene.BLEND_ADDITIVE?b+=c.particle2_blendAddPS:a.blend==pc.scene.BLEND_MULTIPLICATIVE&&(b+=c.particle2_blendMultiplyPS);
b+=c.particle2_endPS;return{attributes:pc.gfx.shaderChunks.collectAttribs(e),vshader:e,fshader:b}}};pc.gfx.programlib.phong={generateKey:function(d,a){var b=[],c="phong";for(prop in a)if("lights"===prop)for(var e=0;e<a.lights.length;e++)b.push(a.lights[e].getType()+"_"+(a.lights[e].getCastShadows()?1:0)+"_"+a.lights[e].getFalloffMode());else a[prop]&&b.push(prop);b.sort();for(prop in b)c+="_"+b[prop];return c},_setMapTransform:function(d,a,b){d[0]+="uniform vec4 texture_"+a+"MapTransform;\n";d[3][b]||(d[1]+="varying vec2 vUv0_"+b+";\n",d[2]+="   vUv0_"+b+"   = uv0 * texture_"+a+"MapTransform.xy + texture_"+
a+"MapTransform.zw;\n",d[3][b]=!0);return d},_uvSource:function(d){return 0==d?"vUv0":"vUv0_"+d},createShaderDefinition:function(d,a){var b,c=0<a.lights.length,e=pc.gfx.precalculatedTangents;this.options=a;var g=pc.gfx.programlib.getSnippet,f,h,l="",k=pc.gfx.shaderChunks;f=""+k.baseVS;var n={vertex_position:pc.gfx.SEMANTIC_POSITION};h="   vPositionW    = getWorldPosition(data);\n";c&&(n.vertex_normal=pc.gfx.SEMANTIC_NORMAL,h+="   vNormalW    = getNormal(data);\n",a.sphereMap&&16>=d.fragmentUniformsCount&&
(f+=k.viewNormalVS,h+="   vNormalV    = getViewNormal(data);\n"),a.normalMap&&e&&(n.vertex_tangent=pc.gfx.SEMANTIC_TANGENT,f+=k.tangentBinormalVS,h+="   vTangentW   = getTangent(data);\n   vBinormalW  = getBinormal(data);\n"));if(a.diffuseMap||a.specularMap||a.glossMap||a.emissiveMap||a.normalMap||a.heightMap||a.opacityMap)if(n.vertex_texCoord0=pc.gfx.SEMANTIC_TEXCOORD0,f+=k.uv0VS,h+="   vec2 uv0        = getUv0(data);\n",h=[f,l,h,[]],a.diffuseMapTransform&&this._setMapTransform(h,"diffuse",a.diffuseMapTransform),
a.normalMapTransform&&this._setMapTransform(h,"normal",a.normalMapTransform),a.heightMapTransform&&this._setMapTransform(h,"height",a.heightMapTransform),a.opacityMapTransform&&this._setMapTransform(h,"opacity",a.opacityMapTransform),a.useSpecular&&(a.specularMapTransform&&this._setMapTransform(h,"specular",a.specularMapTransform),a.glossMapTransform&&this._setMapTransform(h,"gloss",a.glossMapTransform)),a.emissiveMapTransform&&this._setMapTransform(h,"emissive",a.emissiveMapTransform),f=h[0]+h[1],
l=h[1],h=h[2],a.diffuseMap&&!a.diffuseMapTransform||a.emissiveMap&&!a.emissiveMapTransform||a.normalMap&&!a.normalMapTransform||a.heightMap&&!a.heightMapTransform||a.opacityMap&&!a.opacityMapTransform||a.specularMap&&!a.specularMapTransform||a.glossMap&&!a.glossMapTransform)h+="   vUv0        = uv0;\n";a.lightMap&&(n.vertex_texCoord1=pc.gfx.SEMANTIC_TEXCOORD1,f+=k.uv1VS,h+="   vUv1        = getUv1(data);\n");a.vertexColors&&(n.vertex_color=pc.gfx.SEMANTIC_COLOR);a.skin?(n.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,
n.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES,f+=g(d,"vs_skin_decl"),f+=k.transformSkinnedVS,c&&(f+=k.normalSkinnedVS)):(f+=k.transformVS,c&&(f+=k.normalVS));f=f+"\n"+k.startVS;f+=h;h=f+="}";f=g(d,"fs_precision");f+=k.basePS;f+=l;for(b=l=0;b<a.lights.length;b++){var m=a.lights[b].getType();f+="uniform vec3 light"+b+"_color;\n";m==pc.scene.LIGHTTYPE_DIRECTIONAL?f+="uniform vec3 light"+b+"_direction;\n":(f+="uniform vec3 light"+b+"_position;\n",f+="uniform float light"+b+"_radius;\n",m==pc.scene.LIGHTTYPE_SPOT&&
(f+="uniform vec3 light"+b+"_spotDirection;\n",f+="uniform float light"+b+"_innerConeAngle;\n",f+="uniform float light"+b+"_outerConeAngle;\n"));a.lights[b].getCastShadows()&&(f+="uniform mat4 light"+b+"_shadowMatrix;\n",f=m==pc.scene.LIGHTTYPE_POINT?f+("uniform vec4 light"+b+"_shadowParams;\n"):f+("uniform vec3 light"+b+"_shadowParams;\n"),f=m==pc.scene.LIGHTTYPE_POINT?f+("uniform samplerCube light"+b+"_shadowMap;\n"):f+("uniform sampler2D light"+b+"_shadowMap;\n"),l++)}switch(a.fog){case "linear":f+=
g(d,"fs_fog_linear_decl");break;case "exp":f+=g(d,"fs_fog_exp_decl");break;case "exp2":f+=g(d,"fs_fog_exp2_decl")}a.alphaTest&&(f+=g(d,"fs_alpha_test_decl"));f+="\n";b=a.heightMap?" + data.uvOffset":"";a.normalMap&&e?(f+=k.normalMapPS.replace(/\$UV/g,this._uvSource(a.normalMapTransform)+b),f+=k.TBNPS):f+=k.normalVertexPS;f+=k.defaultGamma;f=a.diffuseMap?f+k.albedoTexPS.replace(/\$UV/g,this._uvSource(a.diffuseMapTransform)+b):f+k.albedoColorPS;a.useSpecular&&(f=a.specularMap?f+k.specularityTexPS.replace(/\$UV/g,
this._uvSource(a.specularMapTransform)+b):f+k.specularityColorPS,a.useFresnel&&(f+=k.defaultFresnel));f=a.glossMap?f+k.glossinessTexPS.replace(/\$UV/g,this._uvSource(a.glossMapTransform)+b):f+k.glossinessFloatPS;f=a.opacityMap?f+k.opacityTexPS.replace(/\$UV/g,this._uvSource(a.opacityMapTransform)+b):f+k.opacityFloatPS;f=a.emissiveMap?f+k.emissionTexPS.replace(/\$UV/g,this._uvSource(a.emissiveMapTransform)+b):f+k.emissionColorPS;a.heightMap&&(a.normalMap||(f+=k.TBNPS),f+=k.parallaxPS.replace(/\$UV/g,
this._uvSource(a.heightMapTransform)));a.cubeMap&&(f+=k.reflectionCubePS);a.sphereMap&&(f+=16<d.fragmentUniformsCount?k.reflectionSpherePS:k.reflectionSphereLowPS);a.lightMap&&(f+=k.lightmapSinglePS);0<l&&(f+=k.shadowPS);f+=k.lightDiffuseLambertPS;a.useSpecular?(f+=k.defaultSpecular,f=a.sphereMap||a.cubeMap||a.useFresnel?a.useFresnel?f+k.combineDiffuseSpecularPS:f+k.combineDiffuseSpecularOldPS:a.diffuseMap?f+k.combineDiffuseSpecularNoReflPS:f+k.combineDiffuseSpecularNoReflSeparateAmbientPS):f+=k.combineDiffusePS;
f+=k.startPS;if(c){f+="   getViewDir(data);\n";if(a.heightMap||a.normalMap)f+="   getTBN(data);\n";a.heightMap&&(f+="   getParallax(data);\n");f+="   getNormal(data);\n";a.useSpecular&&(f+="   getReflDir(data);\n")}f+="   getAlbedo(data);\n";c&&a.useSpecular&&(f+="   getSpecularity(data);\n",a.useFresnel&&(f+="   getFresnel(data);\n"),f+="   getGlossiness(data);\n");f+="   getOpacity(data);\n";a.alphaTest&&(f+="   if (data.alpha < alpha_ref) discard;");a.lightMap&&(f+="    addLightmap(data);\n");
f+="   addAmbientConstant(data);\n";if(c){a.cubeMap?f+="   addCubemapReflection(data);\n":a.sphereMap&&(f+="   addSpheremapReflection(data);\n");for(b=0;b<a.lights.length;b++)m=a.lights[b].getType(),m==pc.scene.LIGHTTYPE_DIRECTIONAL?(f+="   data.lightDirNormW = light"+b+"_direction;\n",f+="   data.atten = 1.0;\n"):(f+="   getLightDirPoint(data, light"+b+"_position);\n",f=a.lights[b].getFalloffMode()==pc.scene.LIGHTFALLOFF_LINEAR?f+("   data.atten = getFalloffLinear(data, light"+b+"_radius);\n"):f+
("   data.atten = getFalloffInvSquared(data, light"+b+"_radius);\n"),m==pc.scene.LIGHTTYPE_SPOT&&(f+="   data.atten *= getSpotEffect(data, light"+b+"_spotDirection, light"+b+"_innerConeAngle, light"+b+"_outerConeAngle);\n")),f+="   data.atten *= getLightDiffuse(data);\n",a.lights[b].getCastShadows()&&(m==pc.scene.LIGHTTYPE_POINT?f+="   data.atten *= getShadowPoint(data, light"+b+"_shadowMap, light"+b+"_shadowParams);\n":(f+="   getShadowCoord(data, light"+b+"_shadowMatrix, light"+b+"_shadowParams);\n",
f+="   data.atten *= getShadowPCF3x3(data, light"+b+"_shadowMap, light"+b+"_shadowParams);\n")),f+="   data.diffuseLight += data.atten * light"+b+"_color;\n",a.useSpecular&&(f+="   data.atten *= getLightSpecular(data);\n",f+="   data.specularLight += data.atten * light"+b+"_color;\n"),f+="\n"}f+="\n";f+=k.endPS;switch(a.fog){case "linear":f+=g(d,"fs_fog_linear");break;case "exp":f+=g(d,"fs_fog_exp");break;case "exp2":f+=g(d,"fs_fog_exp2")}f+=g(d,"fs_clamp");f+=g(d,"common_main_end");return{attributes:n,
vshader:h,fshader:f}}};pc.gfx.programlib.pick={generateKey:function(d,a){var b="pick";a.skin&&(b+="_skin");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.gfx.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);var c=pc.gfx.programlib.getSnippet,e;e=""+c(d,"vs_transform_decl");a.skin&&(e+=c(d,"vs_skin_decl"));e+=c(d,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",
e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):e+="    mat4 modelMatrix = matrix_model;\n";e+="\n";e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";var g=e+=c(d,"common_main_end");e=c(d,"fs_precision");e+=c(d,"fs_flat_color_decl");e+=c(d,"common_main_begin");e+=c(d,"fs_flat_color");
e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.skybox={generateKey:function(){return"skybox"},createShaderDefinition:function(d){var a=pc.gfx.programlib.getSnippet;return{attributes:{aPosition:pc.gfx.SEMANTIC_POSITION},vshader:"attribute vec3 aPosition;\n\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\n\nvarying vec3 vViewDir;\n\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projection * view * vec4(aPosition, 1.0);\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n}",
fshader:a(d,"fs_precision")+"varying vec3 vViewDir;\n\nuniform samplerCube texture_cubeMap;\n\nvoid main(void)\n{\n    gl_FragColor = textureCube(texture_cubeMap, vec3(-vViewDir.x, vViewDir.yz));\n}"}}};pc.posteffect={};
pc.extend(pc.posteffect,function(){var d=function(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=pc.posteffect.createFullscreenQuad(a);this.needsDepthBuffer=!1};d.prototype={render:function(){}};return{PostEffect:d,createFullscreenQuad:function(a){var b=new pc.gfx.VertexFormat(a,[{semantic:pc.gfx.SEMANTIC_POSITION,components:2,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),a=new pc.gfx.VertexBuffer(a,b,4),b=new pc.gfx.VertexIterator(a);b.element[pc.gfx.SEMANTIC_POSITION].set(-1,-1);b.next();
b.element[pc.gfx.SEMANTIC_POSITION].set(1,-1);b.next();b.element[pc.gfx.SEMANTIC_POSITION].set(-1,1);b.next();b.element[pc.gfx.SEMANTIC_POSITION].set(1,1);b.end();return a},drawFullscreenQuad:function(a,b,c,e,d){a.setRenderTarget(b);a.updateBegin();var f=null!==b?b.width:a.width,b=null!==b?b.height:a.height,h=0,l=0;d&&(h=d.x*f,l=d.y*b,f*=d.z,b*=d.w);a.setViewport(h,l,f,b);a.setScissor(h,l,f,b);d=a.getBlending();f=a.getDepthTest();b=a.getDepthWrite();a.setBlending(!1);a.setDepthTest(!1);a.setDepthWrite(!1);
a.setVertexBuffer(c,0);a.setShader(e);a.draw({type:pc.gfx.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});a.setBlending(d);a.setDepthTest(f);a.setDepthWrite(b);a.updateEnd()}}}());pc.extend(pc.posteffect,function(){function d(a,b){this.context=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;b.on("set_rect",this.onCameraRectChanged,this);this.previous}d.prototype={_createOffscreenTarget:function(a){var b=this.camera.rect,b=new pc.gfx.Texture(this.context.graphicsDevice,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,width:Math.floor(b.z*this.context.graphicsDevice.width*this.renderTargetScale),height:Math.floor(b.w*
this.context.graphicsDevice.height*this.renderTargetScale)});b.minFilter=pc.gfx.FILTER_NEAREST;b.magFilter=pc.gfx.FILTER_NEAREST;b.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;b.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;return new pc.gfx.RenderTarget(this.context.graphicsDevice,b,{depth:a})},_setDepthTarget:function(a){this.depthTarget!==a&&(this.depthTarget&&this.depthTarget.destroy(),this.depthTarget=a);this.camera.camera._depthTarget=a},setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},
addEffect:function(a){var b=0===this.effects.length,c=this.effects,e={effect:a,inputTarget:this._createOffscreenTarget(b),outputTarget:null};a.needsDepthBuffer&&(this.depthTarget||this._setDepthTarget(this._createOffscreenTarget(!0)),a.depthMap=this.depthTarget.colorBuffer);b&&(this.camera.renderTarget=e.inputTarget);c.push(e);a=c.length;1<a&&(c[a-2].outputTarget=e.inputTarget);this.enable()},removeEffect:function(a){for(var b=-1,c=0,e=this.effects.length;c<e;c++)if(this.effects[c].effect===a){b=
c;break}0<=b&&(0<b?this.effects[b-1].outputTarget=b+1<this.effects.length?this.effects[b+1].inputTarget:null:1<this.effects.length&&(this.effects[1].inputTarget._depth||(this.effects[1].inputTarget.destroy(),this.effects[1].inputTarget=this._createOffscreenTarget(!0)),this.camera.renderTarget=this.effects[1].inputTarget),this.effects[b].inputTarget.destroy(),this.effects.splice(b,1));if(this.depthTarget){a=!1;c=0;for(e=this.effects.length;c<e;c++)if(this.effects[c].effect.needsDepthBuffer){a=!0;break}a||
this._setDepthTarget(null)}0===this.effects.length&&this.disable()},destroy:function(){this.depthTarget&&(this.depthTarget.destroy(),this.depthTarget=null);for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].inputTarget.destroy();this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var a=this.effects,b=this.camera;this.context.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);b.camera.setRect(0,0,1,1);this.command=new pc.scene.Command(pc.scene.LAYER_FX,
pc.scene.BLEND_NONE,function(){if(this.enabled&&b.data.isRendering){var c=null,e=a.length;if(e){b.renderTarget=a[0].inputTarget;this._setDepthTarget(this.depthTarget);for(var d=0;d<e;d++){var f=a[d];d===e-1&&(c=b.rect);f.effect.render(f.inputTarget,f.outputTarget,c)}}}}.bind(this));this.context.scene.drawCalls.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1;this.context.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this.camera.renderTarget=null;this.camera.camera._depthTarget=
null;var a=this.camera.rect;this.camera.camera.setRect(a.x,a.y,a.z,a.w);a=this.context.scene.drawCalls.indexOf(this.command);0<=a&&this.context.scene.drawCalls.splice(a,1)}},_onCanvasResized:function(){this.resizeTimeout&&clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(this.resizeRenderTargets.bind(this),500)},resizeRenderTargets:function(){var a=this.camera.rect,b=Math.floor(a.z*this.context.graphicsDevice.width*this.renderTargetScale),a=Math.floor(a.w*this.context.graphicsDevice.height*
this.renderTargetScale),c=this.effects;this.depthTarget&&(this.depthTarget.width!==b&&this.depthTarget.height!==a)&&this._setDepthTarget(this._createOffscreenTarget(!0));for(var e=0,d=c.length;e<d;e++){var f=c[e];if(f.inputTarget.width!==b||f.inputTarget.height!==a)f.inputTarget.destroy(),f.inputTarget=this._createOffscreenTarget(f.effect.needsDepthBuffer||0===e),f.effect.needsDepthBuffer&&(f.depthMap=this.depthTarget),0<e?c[e-1].outputTarget=f.inputTarget:this.camera.renderTarget=f.inputTarget}},
onCameraRectChanged:function(){this.enabled&&(this.camera.camera.setRect(0,0,1,1),this.resizeRenderTargets())}};return{PostEffectQueue:d}}());pc.scene={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:3,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2"};
pc.extend(pc.scene,function(){var d=function(){this.drawCalls=[];this.shadowCasters=[];this.fog=pc.scene.FOG_NONE;this.fogColor=new pc.Color(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new pc.Color(0,0,0);this.shadowDistance=40;this._gammaCorrection=!1;this._models=[];this._lights=[];this._globalLights=[];this._localLights=[[],[]];this.updateShaders=!0};Object.defineProperty(d.prototype,"fog",{get:function(){return this._fog},set:function(a){a!==this._fog&&(this._fog=
a,this.updateShaders=!0)}});Object.defineProperty(d.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(a){a!==this._gammaCorrection&&(this._gammaCorrection=a,pc.gfx.shaderChunks.defaultGamma=a?pc.gfx.shaderChunks.gamma2_2PS:pc.gfx.shaderChunks.gamma1_0PS,this.updateShaders=!0)}});d.prototype._updateShaders=function(a){var b,c=[],e=this.drawCalls;for(b=0;b<e.length;b++){var d=e[b];void 0!==d.material&&-1===c.indexOf(d.material)&&c.push(d.material)}for(b=0;b<c.length;b++)c[b].updateShader(a,
this)};d.prototype.getModels=function(){return this._models};d.prototype.addModel=function(a){var b;if(-1===this._models.indexOf(a)){this._models.push(a);var c=a.getMaterials();for(b=0;b<c.length;b++)c[b].scene=this;var e=a.meshInstances.length;for(b=0;b<e;b++)c=a.meshInstances[b],-1===this.drawCalls.indexOf(c)&&this.drawCalls.push(c),c.castShadow&&-1===this.shadowCasters.indexOf(c)&&this.shadowCasters.push(c);a=a.getLights();b=0;for(len=a.length;b<len;b++)this.addLight(a[b])}};d.prototype.removeModel=
function(a){var b,c=this._models.indexOf(a);if(-1!==c){this._models.splice(c,1);c=a.getMaterials();for(b=0;b<c.length;b++)c[b].scene=null;var e,d=a.meshInstances.length;for(b=0;b<d;b++)e=a.meshInstances[b],c=this.drawCalls.indexOf(e),-1!==c&&this.drawCalls.splice(c,1),e.castShadow&&(c=this.shadowCasters.indexOf(e),-1!==c&&this.shadowCasters.splice(c,1));a=a.getLights();b=0;for(len=a.length;b<len;b++)this.removeLight(a[b])}};d.prototype.containsModel=function(a){return 0<=this._models.indexOf(a)};
d.prototype.addLight=function(a){-1!==this._lights.indexOf(a)?console.warn("pc.scene.Scene#addLight: light is already in the scene"):(this._lights.push(a),a._scene=this,this.updateShaders=!0)};d.prototype.removeLight=function(a){var b=this._lights.indexOf(a);-1===b?console.warn("pc.scene.Scene#removeLight: light is not in the scene"):(this._lights.splice(b,1),a._scene=null,this.updateShaders=!0)};d.prototype.update=function(){for(var a=0,b=this._models.length;a<b;a++)this._models[a].getGraph().syncHierarchy()};
return{Scene:d}}());pc.extend(pc.scene,function(){function d(a,b){return a.distSqr&&b.distSqr?b.distSqr-a.distSqr:b.key-a.key}function a(a,b){var c;if(b.getType()===pc.scene.LIGHTTYPE_POINT){c=b._shadowResolution;c=new pc.gfx.Texture(a,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,width:c,height:c,cubemap:!0,autoMipmap:!1});c.minFilter=pc.gfx.FILTER_NEAREST;c.magFilter=pc.gfx.FILTER_NEAREST;c.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;for(var e=[],d=0;6>d;d++){var g=new pc.gfx.RenderTarget(a,
c,{face:d,depth:!0});e.push(g)}c=e;b._shadowCamera.setRenderTarget(c[0]);b._shadowCubeMap=c}else c=new pc.gfx.Texture(a,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,width:b._shadowResolution,height:b._shadowResolution,autoMipmap:!1}),c.minFilter=pc.gfx.FILTER_NEAREST,c.magFilter=pc.gfx.FILTER_NEAREST,c.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE,c.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE,c=new pc.gfx.RenderTarget(a,c,!0),b._shadowCamera.setRenderTarget(c)}function b(a){this.device=a;a=this.device.getProgramLibrary();
this._depthProgStatic=a.getProgram("depthrgba",{skin:!1,opacityMap:!1});this._depthProgSkin=a.getProgram("depthrgba",{skin:!0,opacityMap:!1});this._depthProgStaticOp=a.getProgram("depthrgba",{skin:!1,opacityMap:!0});this._depthProgSkinOp=a.getProgram("depthrgba",{skin:!0,opacityMap:!0});this._depthShaderStatic=a.getProgram("depth",{skin:!1});this._depthShaderSkin=a.getProgram("depth",{skin:!0});this._depthProgStaticPoint=a.getProgram("depthrgba",{skin:!1,opacityMap:!1,point:!0});this._depthProgSkinPoint=
a.getProgram("depthrgba",{skin:!0,opacityMap:!1,point:!0});this._depthProgStaticOpPoint=a.getProgram("depthrgba",{skin:!1,opacityMap:!0,point:!0});this._depthProgSkinOpPoint=a.getProgram("depthrgba",{skin:!0,opacityMap:!0,point:!0});a=this.device.scope;this.projId=a.resolve("matrix_projection");this.viewId=a.resolve("matrix_view");this.viewId3=a.resolve("matrix_view3");this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=a.resolve("matrix_viewProjection");this.viewPosId=a.resolve("view_position");
this.nearClipId=a.resolve("camera_near");this.farClipId=a.resolve("camera_far");this.lightRadiusId=a.resolve("light_radius");this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");this.modelMatrixId=a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");this.boneTextureId=a.resolve("texture_poseMap");this.boneTextureSizeId=a.resolve("texture_poseMapSize");
this.alphaTestId=a.resolve("alpha_ref");this.shadowEnableId=a.resolve("shadow_enable");this._shadowAabb=new pc.shape.Aabb;this._sceneAabb=new pc.shape.Aabb;this._shadowState={blend:!1};this.centroid=new pc.Vec3;this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3)}var c=(new pc.Mat4).setScale(0.5,0.5,0.5),e=(new pc.Mat4).setTranslate(0.5,0.5,0.5),g=(new pc.Mat4).mul2(e,c),f=(new pc.Mat4).setFromAxisAngle(pc.Vec3.RIGHT,-90),h=new pc.Mat4,l=new pc.Mat4,k=new pc.Mat4,n=new pc.Mat4,
m=new pc.Mat3,r=new pc.Mat4,w=new pc.Mat4,s=[];for(i=0;8>i;i++)s.push(new pc.Vec3);pc.extend(b.prototype,{setCamera:function(a){var b=a.getProjectionMatrix();this.projId.setValue(b.data);var c=a.getWorldTransform();this.viewInvId.setValue(c.data);n.copy(c).invert();this.viewId.setValue(n.data);m.data[0]=n.data[0];m.data[1]=n.data[1];m.data[2]=n.data[2];m.data[3]=n.data[4];m.data[4]=n.data[5];m.data[5]=n.data[6];m.data[6]=n.data[8];m.data[7]=n.data[9];m.data[8]=n.data[10];this.viewId3.setValue(m.data);
r.mul2(b,n);this.viewProjId.setValue(r.data);this.viewPosId.setValue(a.getPosition().data);this.nearClipId.setValue(a.getNearClip());this.farClipId.setValue(a.getFarClip());a._frustum.update(b,n);var b=this.device,e=a.getRenderTarget();b.setRenderTarget(e);b.updateBegin();var c=a.getRect(),d=e?e.width:b.width,g=e?e.height:b.height,e=Math.floor(c.x*d),f=Math.floor(c.y*g),d=Math.floor(c.width*d),c=Math.floor(c.height*g);b.setViewport(e,f,d,c);b.setScissor(e,f,d,c);b.clear(a.getClearOptions())},dispatchGlobalLights:function(a){var b=
a._globalLights,c=b.length,e=this.device.scope;this.ambientColor[0]=a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;e.resolve("light_globalAmbient").setValue(this.ambientColor);for(a=0;a<c;a++){var d=b[a],g=d.getWorldTransform(),f="light"+a;e.resolve(f+"_color").setValue(d._finalColor.data);g.getY(d._direction).scale(-1);e.resolve(f+"_direction").setValue(d._direction.normalize().data);d.getCastShadows()&&(g=this.device.extDepthTexture?d._shadowCamera._renderTarget._depthTexture:
d._shadowCamera._renderTarget.colorBuffer,e.resolve(f+"_shadowMap").setValue(g),e.resolve(f+"_shadowMatrix").setValue(d._shadowMatrix.data),e.resolve(f+"_shadowParams").setValue([d._shadowResolution,d._shadowResolution,d._shadowBias]))}},dispatchLocalLights:function(a){var b,c,e,d,g=a._localLights;e=g[pc.scene.LIGHTTYPE_POINT-1];for(var g=g[pc.scene.LIGHTTYPE_SPOT-1],f=a._globalLights.length,h=e.length,l=g.length,k=this.device.scope,a=0;a<h;a++)c=e[a],b=c.getWorldTransform(),d="light"+(f+a),k.resolve(d+
"_radius").setValue(c._attenuationEnd),k.resolve(d+"_color").setValue(c._finalColor.data),b.getTranslation(c._position),k.resolve(d+"_position").setValue(c._position.data),c.getCastShadows()&&(b=this.device.extDepthTexture?c._shadowCamera._renderTarget._depthTexture:c._shadowCamera._renderTarget.colorBuffer,k.resolve(d+"_shadowMap").setValue(b),k.resolve(d+"_shadowMatrix").setValue(c._shadowMatrix.data),k.resolve(d+"_shadowParams").setValue([c._shadowResolution,c._shadowResolution,c._shadowBias,c.getAttenuationEnd()]));
for(a=0;a<l;a++)e=g[a],b=e.getWorldTransform(),d="light"+(f+h+a),k.resolve(d+"_innerConeAngle").setValue(e._innerConeAngleCos),k.resolve(d+"_outerConeAngle").setValue(e._outerConeAngleCos),k.resolve(d+"_radius").setValue(e._attenuationEnd),k.resolve(d+"_color").setValue(e._finalColor.data),b.getTranslation(e._position),k.resolve(d+"_position").setValue(e._position.data),b.getY(e._direction).scale(-1),k.resolve(d+"_spotDirection").setValue(e._direction.data),e.getCastShadows()&&(b=this.device.extDepthTexture?
e._shadowCamera._renderTarget._depthTexture:e._shadowCamera._renderTarget.colorBuffer,k.resolve(d+"_shadowMap").setValue(b),k.resolve(d+"_shadowMatrix").setValue(e._shadowMatrix.data),k.resolve(d+"_shadowParams").setValue([e._shadowResolution,e._shadowResolution,e._shadowBias]))},render:function(b,c){var e=this.device,m=e.scope;b.updateShaders&&(b._updateShaders(e),b.updateShaders=!1);var n=b._lights,r=b.drawCalls,C=b.shadowCasters,H,E,I,y,B,K,D,J=null;H=0;for(numDrawCalls=b.drawCalls.length;H<numDrawCalls;H++)y=
b.drawCalls[H],y.skinInstance&&y.skinInstance.updateMatrixPalette();b._globalLights.length=0;b._localLights[0].length=0;for(H=b._localLights[1].length=0;H<n.length;H++){var F=n[H];F.getEnabled()&&(F.getType()===pc.scene.LIGHTTYPE_DIRECTIONAL?b._globalLights.push(F):b._localLights[F.getType()===pc.scene.LIGHTTYPE_POINT?0:1].push(F))}F=c.getPosition();H=0;for(numDrawCalls=r.length;H<numDrawCalls;H++)if(y=r[H],!y.command)if(B=y,B.material.blendType===pc.scene.BLEND_NORMAL||B.material.blendType===pc.scene.BLEND_PREMULTIPLIED){B.syncAabb();
var L=B.aabb.center,P=L.x-F.x;y=L.y-F.y;L=L.z-F.z;B.distSqr=P*P+y*y+L*L}else void 0!==B.distSqr&&delete B.distSqr;r.sort(d);if(c._depthTarget){F=c.getRenderTarget();c.setRenderTarget(c._depthTarget);this.setCamera(c);P=e.getBlending();e.setBlending(!1);H=0;for(numDrawCalls=r.length;H<numDrawCalls;H++){y=r[H];if(!y.command&&(B=y,B.layer!==pc.scene.LAYER_SKYBOX)){K=B.mesh;this.modelMatrixId.setValue(B.node.worldTransform.data);if(B.skinInstance){if(e.supportsBoneTextures){this.boneTextureId.setValue(B.skinInstance.boneTexture);
var M=B.skinInstance.boneTexture.width,Q=B.skinInstance.boneTexture.height;this.boneTextureSizeId.setValue([M,Q])}else this.poseMatrixId.setValue(B.skinInstance.matrixPalette);e.setShader(this._depthShaderSkin)}else e.setShader(this._depthShaderStatic);B=B.renderStyle;e.setVertexBuffer(K.vertexBuffer,0);e.setIndexBuffer(K.indexBuffer[B]);e.draw(K.primitive[B])}c.setRenderTarget(F)}e.setBlending(P)}for(H=0;H<n.length;H++)if(F=n[H],P=F.getType(),F.getCastShadows()&&F.getEnabled()){y=e;L=F;B=L._shadowCamera;
E=void 0;null===B?(B=L,E=pc.gfx.CLEARFLAG_DEPTH,y.extDepthTexture||(E|=pc.gfx.CLEARFLAG_COLOR),K=new pc.scene.CameraNode,K.setClearOptions({color:[1,1,1,1],depth:1,flags:E}),B=B._shadowCamera=K,a(y,L)):(E=B.getRenderTarget(),(E.width!==L._shadowResolution||E.height!==L._shadowResolution)&&a(y,L));y=B;var L=1,N;if(P===pc.scene.LIGHTTYPE_DIRECTIONAL){B=c;E=this.centroid;E.set(0,0,0.5*-(b.shadowDistance+B._nearClip));B.getWorldTransform().transformPoint(E,E);y.setPosition(this.centroid);y.setRotation(F.getRotation());
y.rotateLocal(-90,0,0);D=b;B=c;E=s;I=B;K=I.getNearClip();D=D.shadowDistance;M=I.getFov()*Math.PI/180;Q=I.getAspectRatio();I=I.getProjection();var R=N=void 0,R=I===pc.scene.Projection.PERSPECTIVE?Math.tan(M/2)*K:B._orthoHeight;N=R*Q;E[0].x=N;E[0].y=-R;E[0].z=-K;E[1].x=N;E[1].y=R;E[1].z=-K;E[2].x=-N;E[2].y=R;E[2].z=-K;E[3].x=-N;E[3].y=-R;E[3].z=-K;I===pc.scene.Projection.PERSPECTIVE&&(R=Math.tan(M/2)*D,N=R*Q);E[4].x=N;E[4].y=-R;E[4].z=-D;E[5].x=N;E[5].y=R;E[5].z=-D;E[6].x=-N;E[6].y=R;E[6].z=-D;E[7].x=
-N;E[7].y=-R;E[7].z=-D;h.copy(y.getWorldTransform());B=h.invert();w.mul2(B,c.worldTransform);for(E=0;8>E;E++)w.transformPoint(s[E],s[E]);B=K=D=1E6;M=Q=I=-1E6;for(E=0;8>E;E++)N=s[E],N.x<B&&(B=N.x),N.x>M&&(M=N.x),N.y<K&&(K=N.y),N.y>Q&&(Q=N.y),N.z<D&&(D=N.z),N.z>I&&(I=N.z);y.translateLocal(0.5*-(M+B),0.5*(Q+K),I+0.25*(I-D));h.copy(y.getWorldTransform());y.setProjection(pc.scene.Projection.ORTHOGRAPHIC);y.setNearClip(0);y.setFarClip(1.5*(I-D));y.setAspectRatio((M-B)/(Q-K));y.setOrthoHeight(0.5*(Q-K))}else P===
pc.scene.LIGHTTYPE_SPOT?(y.setProjection(pc.scene.Projection.PERSPECTIVE),y.setNearClip(F.getAttenuationEnd()/1E3),y.setFarClip(F.getAttenuationEnd()),y.setAspectRatio(1),y.setFov(2*F.getOuterConeAngle()),h.mul2(F.worldTransform,f)):P===pc.scene.LIGHTTYPE_POINT&&(y.setProjection(pc.scene.Projection.PERSPECTIVE),y.setNearClip(F.getAttenuationEnd()/1E3),y.setFarClip(F.getAttenuationEnd()),y.setAspectRatio(1),y.setFov(90),L=6,this.viewPosId.setValue(y.getPosition().data),this.lightRadiusId.setValue(F.getAttenuationEnd()));
P!=pc.scene.LIGHTTYPE_POINT&&(l.copy(h).invert(),k.mul2(y.getProjectionMatrix(),l),F._shadowMatrix.mul2(g,k),y.worldTransform.copy(h));for(N=0;N<L;N++){P===pc.scene.LIGHTTYPE_POINT&&(0===N?y.setEulerAngles(0,90,180):1===N?y.setEulerAngles(0,-90,180):2===N?y.setEulerAngles(90,0,0):3===N?y.setEulerAngles(-90,0,0):4===N?y.setEulerAngles(0,180,180):5===N&&y.setEulerAngles(0,0,180),y.setPosition(F.getPosition()),y.setRenderTarget(F._shadowCubeMap[N]));e.setBlending(!1);e.setColorWrite(!0,!0,!0,!0);e.setCullMode(pc.gfx.CULLFACE_BACK);
e.setDepthWrite(!0);e.setDepthTest(!0);e.extDepthTexture&&e.setColorWrite(!1,!1,!1,!1);this.setCamera(y);E=0;for(I=C.length;E<I;E++)B=C[E],K=B.mesh,D=B.material,this.modelMatrixId.setValue(B.node.worldTransform.data),D.opacityMap&&m.resolve("texture_opacityMap").setValue(D.opacityMap),B.skinInstance?(e.supportsBoneTextures?(this.boneTextureId.setValue(B.skinInstance.boneTexture),M=B.skinInstance.boneTexture.width,Q=B.skinInstance.boneTexture.height,this.boneTextureSizeId.setValue([M,Q])):this.poseMatrixId.setValue(B.skinInstance.matrixPalette),
P===pc.scene.LIGHTTYPE_POINT?e.setShader(D.opacityMap?this._depthProgSkinOpPoint:this._depthProgSkinPoint):e.setShader(D.opacityMap?this._depthProgSkinOp:this._depthProgSkin)):P===pc.scene.LIGHTTYPE_POINT?e.setShader(D.opacityMap?this._depthProgStaticOpPoint:this._depthProgStaticPoint):e.setShader(D.opacityMap?this._depthProgStaticOp:this._depthProgStatic),B=B.renderStyle,e.setVertexBuffer(K.vertexBuffer,0),e.setIndexBuffer(K.indexBuffer[B]),e.draw(K.primitive[B])}}this.setCamera(c);this.dispatchGlobalLights(b);
this.dispatchLocalLights(b);b.fog!==pc.scene.FOG_NONE&&(this.fogColor[0]=b.fogColor.r,this.fogColor[1]=b.fogColor.g,this.fogColor[2]=b.fogColor.b,this.fogColorId.setValue(this.fogColor),b.fog===pc.scene.FOG_LINEAR?(this.fogStartId.setValue(b.fogStart),this.fogEndId.setValue(b.fogEnd)):this.fogDensityId.setValue(b.fogDensity));H=0;for(numDrawCalls=r.length;H<numDrawCalls;H++)if(y=r[H],y.command)y.command();else{B=y;K=B.mesh;D=B.material;m=B.node.worldTransform;n=B.normalMatrix;m.invertTo3x3(n);n.transpose();
this.modelMatrixId.setValue(m.data);this.normalMatrixId.setValue(n.data);B.skinInstance&&(e.supportsBoneTextures?(this.boneTextureId.setValue(B.skinInstance.boneTexture),M=B.skinInstance.boneTexture.width,Q=B.skinInstance.boneTexture.height,this.boneTextureSizeId.setValue([M,Q])):this.poseMatrixId.setValue(B.skinInstance.matrixPalette));this.shadowEnableId.setValue(B.receiveShadow);if(D!==J){D.shader||D.updateShader(e,b);e.setShader(D.shader);var J=D.parameters,O;for(O in J)m=J[O],m.scopeId||(m.scopeId=
e.scope.resolve(O)),m.scopeId.setValue(m.data);this.alphaTestId.setValue(D.alphaTest);e.setBlending(D.blend);e.setBlendFunction(D.blendSrc,D.blendDst);e.setBlendEquation(D.blendEquation);e.setColorWrite(D.redWrite,D.greenWrite,D.blueWrite,D.alphaWrite);e.setCullMode(D.cull);e.setDepthWrite(D.depthWrite);e.setDepthTest(D.depthTest)}e.setVertexBuffer(K.vertexBuffer,0);B=B.renderStyle;e.setIndexBuffer(K.indexBuffer[B]);e.draw(K.primitive[B]);J=D}}});return{ForwardRenderer:b}}());pc.extend(pc.scene,function(){var d=function(a){this.name=a||"Untitled";this._labels={};this.localPosition=new pc.Vec3(0,0,0);this.localRotation=new pc.Quat(0,0,0,1);this.localScale=new pc.Vec3(1,1,1);this.localEulerAngles=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.rotation=new pc.Quat(0,0,0,1);this.eulerAngles=new pc.Vec3(0,0,0);this.localTransform=new pc.Mat4;this.dirtyLocal=!1;this.worldTransform=new pc.Mat4;this.dirtyWorld=!1;this._right=new pc.Vec3;this._up=new pc.Vec3;this._forward=
new pc.Vec3;this._parent=null;this._children=[];this._enabledInHierarchy=this._enabled=!0};Object.defineProperty(d.prototype,"right",{get:function(){return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(d.prototype,"up",{get:function(){return this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(d.prototype,"forward",{get:function(){return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(d.prototype,
"forwards",{get:function(){console.log("pc.GraphNode#forwards is DEPRECATED. Use pc.GraphNode#forward instead.");return this.forward}});Object.defineProperty(d.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,(!this._parent||this._parent.enabled)&&this._notifyHierarchyStateChanged(this,a))}});pc.extend(d.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);for(var c=a._children,e=
0,d=c.length;e<d;e++)c[e]._enabled&&this._notifyHierarchyStateChanged(c[e],b)},_onHierarchyStateChanged:function(a){this._enabledInHierarchy=a},_cloneInternal:function(a){a.name=this.name;a._labels=pc.extend(this._labels,{});a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);
a.dirtyLocal=this.dirtyLocal;a.worldTransform.copy(this.worldTransform);a.dirtyWorld=this.dirtyWorld;a._enabled=this._enabled;a._enabledInHierarchy=this._enabledInHierarchy},clone:function(){var a=new pc.scene.GraphNode;this._cloneInternal(a);return a},find:function(a,b){var c,e=this.getChildren(),d=e.length,f=[];this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b&&f.push(this));for(c=0;c<d;++c)f=f.concat(e[c].find(a,b));return f},findOne:function(a,b){var c,e=this.getChildren(),d=e.length,
f=null;if(this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b))return this;for(c=0;c<d;++c)if(f=e[c].findOne(a,b),null!==f)return f;return null},findByName:function(a){if(this.name===a)return this;for(var b=0;b<this._children.length;b++){var c=this._children[b].findByName(a);if(null!==c)return c}return null},findByPath:function(a){for(var a=a.split("/"),b=this,c=null,e=0,d=a.length;e<d&&b;e++){for(var f=a[e],c=null,b=b._children,h=0,l=b.length;h<l;h++)if(b[h].name==f){c=b[h];break}b=c}return c},
getPath:function(){var a=this._parent;if(a){for(var b=this.name;a&&a._parent;)b=pc.string.format("{0}/{1}",a.name,b),a=a._parent;return b}return""},getRoot:function(){var a=this.getParent();if(!a)return this;for(;a.getParent();)a=a.getParent();return a},getParent:function(){return this._parent},getChildren:function(){return this._children},getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);
return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);return this.localTransform},getName:function(){return this.name},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},
getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation},getWorldTransform:function(){var a=[];return function(){var b=this;for(a.length=0;null!==b;)a.push(b),b=b._parent;for(b=a.length-1;0<=b;b--)a[b].sync();return this.worldTransform}}(),reparent:function(a,b){var c=this.getParent();c&&c.removeChild(this);a&&(0<=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(){var a,b,c;switch(arguments.length){case 1:a=arguments[0].x;b=arguments[0].y;
c=arguments[0].z;break;case 3:a=arguments[0],b=arguments[1],c=arguments[2]}this.localRotation.setFromEulerAngles(a,b,c);this.dirtyLocal=!0},setLocalPosition:function(){1===arguments.length?this.localPosition.copy(arguments[0]):this.localPosition.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setLocalRotation:function(a){1===arguments.length?this.localRotation.copy(arguments[0]):this.localRotation.set(arguments[0],arguments[1],arguments[2],arguments[3]);this.dirtyLocal=!0},setLocalScale:function(){1===
arguments.length?this.localScale.copy(arguments[0]):this.localScale.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setName:function(a){this.name=a},setPosition:function(){var a=new pc.Vec3,b=new pc.Mat4;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2]);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this.dirtyLocal=!0}}(),setRotation:function(){var a=
new pc.Quat,b=new pc.Quat;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2],arguments[3]);if(null===this._parent)this.localRotation.copy(a);else{var c=this._parent.getRotation();b.copy(c).invert();this.localRotation.copy(b).mul(a)}this.dirtyLocal=!0}}(),setEulerAngles:function(){var a=new pc.Quat;return function(){var b,c,e;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0],c=arguments[1],
e=arguments[2]}this.localRotation.setFromEulerAngles(b,c,e);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,this.localRotation));this.dirtyLocal=!0}}(),addChild:function(a){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.push(a);this._onInsertChild(a)},addChildAndSaveTransform:function(a){var b=a.getPosition(),c=a.getRotation(),e=a.getParent();e&&e.removeChild(a);void 0==this.tmpMat4&&(this.tmpMat4=new pc.Mat4,this.tmpQuat=
new pc.Quat);a.setPosition(this.tmpMat4.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(this.tmpQuat.copy(this.getRotation()).invert().mul(c));this._children.push(a);this._onInsertChild(a)},insertChild:function(a,b){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=this;var b=a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,
b));a.dirtyWorld=!0},removeChild:function(a){var b,c=this._children.length;a._parent=null;for(b=0;b<c;++b)if(this._children[b]===a){this._children.splice(b,1);break}},addLabel:function(a){this._labels[a]=!0},getLabels:function(){return Object.keys(this._labels)},hasLabel:function(a){return!!this._labels[a]},removeLabel:function(a){delete this._labels[a]},findByLabel:function(a,b){var c,e=this._children.length,b=b||[];this.hasLabel(a)&&b.push(this);for(c=0;c<e;++c)b=this._children[c].findByLabel(a,
b);return b},sync:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);if(this.dirtyWorld){null===this._parent?this.worldTransform.copy(this.localTransform):this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this.dirtyWorld=!1;for(var a=0,b=this._children.length;a<b;a++)this._children[a].dirtyWorld=!0}},syncHierarchy:function(){var a=function(){if(this._enabled){this.sync();for(var b=
this._children,c=0,e=b.length;c<e;c++)a.call(b[c])}};return a}(),lookAt:function(){var a=new pc.Mat4,b=new pc.Vec3,c=new pc.Vec3,e=new pc.Quat;return function(){switch(arguments.length){case 1:b.copy(arguments[0]);c.copy(pc.Vec3.UP);break;case 2:b.copy(arguments[0]);c.copy(arguments[1]);break;case 3:b.set(arguments[0],arguments[1],arguments[2]);c.copy(pc.Vec3.UP);break;case 6:b.set(arguments[0],arguments[1],arguments[2]),c.set(arguments[3],arguments[4],arguments[5])}a.setLookAt(this.getPosition(),
b,c);e.setFromMat4(a);this.setRotation(e)}}(),translate:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}a.add(this.getPosition());this.setPosition(a)}}(),translateLocal:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}this.localRotation.transformVector(a,a);this.localPosition.add(a);
this.dirtyLocal=!0}}(),rotate:function(){var a=new pc.Quat,b=new pc.Quat;return function(){var c,e,d;switch(arguments.length){case 1:c=arguments[0].x;e=arguments[0].y;d=arguments[0].z;break;case 3:c=arguments[0],e=arguments[1],d=arguments[2]}a.setFromEulerAngles(c,e,d);null===this._parent?this.localRotation.mul2(a,this.localRotation):(c=this.getRotation(),e=this._parent.getRotation(),b.copy(e).invert(),a.mul2(b,a),this.localRotation.mul2(a,c));this.dirtyLocal=!0}}(),rotateLocal:function(){var a=new pc.Quat;
return function(){var b,c,e;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0],c=arguments[1],e=arguments[2]}a.setFromEulerAngles(b,c,e);this.localRotation.mul(a);this.dirtyLocal=!0}}()});return{GraphNode:d}}());pc.scene.Projection={PERSPECTIVE:0,ORTHOGRAPHIC:1};
pc.extend(pc.scene,function(){var d=function(){this._projection=pc.scene.Projection.PERSPECTIVE;this._nearClip=0.1;this._farClip=1E4;this._fov=45;this._orthoHeight=10;this._aspect=16/9;this._projMatDirty=!0;this._projMat=new pc.Mat4;this._viewMat=new pc.Mat4;this._viewProjMat=new pc.Mat4;this._rect={x:0,y:0,width:1,height:1};this._frustum=new pc.shape.Frustum(this._projMat,this._viewMat);this._renderTarget=null;this._clearOptions={color:[186/255,186/255,177/255,1],depth:1,flags:pc.gfx.CLEARFLAG_COLOR|
pc.gfx.CLEARFLAG_DEPTH}},d=pc.inherits(d,pc.scene.GraphNode);pc.extend(d.prototype,{_cloneInternal:function(a){d._super._cloneInternal.call(this,a);a.setProjection(this.getProjection());a.setNearClip(this.getNearClip());a.setFarClip(this.getFarClip());a.setFov(this.getFov());a.setAspectRatio(this.getAspectRatio());a.setRenderTarget(this.getRenderTarget());a.setClearOptions(this.getClearOptions())},clone:function(){var a=new pc.scene.CameraNode;this._cloneInternal(a);return a},worldToScreen:function(a){var b,
c=this.getWorldTransform().clone().invert();pvm=new pc.Mat4;width=this._renderTarget.getWidth();height=this._renderTarget.getHeight();point2d=new pc.Vec3;b=(new pc.Mat4).setPerspective(this._fov,width/height,this._nearClip,this._farClip);pvm.mul2(b,c);pvm.transformPoint(a,point2d);point2d.x=width/2+width/2*point2d.x;point2d.y=height-(height/2+height/2*point2d.y);point2d.z=point2d.z;return point2d},screenToWorld:function(a,b,c,e,d,f){"undefined"===typeof f&&(f=new pc.Vec3);var h=this.getProjectionMatrix(),
l=this.getWorldTransform();this._viewMat.copy(l);this._viewMat.invert();this._viewProjMat.mul2(h,this._viewMat);h=this._viewProjMat.clone().invert();this._projection===pc.scene.Projection.PERSPECTIVE?(b=new pc.Vec3(2*(a/e)-1,2*((d-b)/d)-1,1),a=h.transformPoint(b),a.scale(1/(b.x*h.data[3]+b.y*h.data[7]+b.z*h.data[11]+h.data[15])),c/=this._farClip,f.lerp(this.getPosition(),a,c)):(c=new pc.Vec3(2*(a/e)-1,2*((d-b)/d)-1,2*((this._farClip-c)/(this._farClip-this._nearClip))-1),h.transformPoint(c,f));return f},
getAspectRatio:function(){return this._aspect},getClearOptions:function(){return this._clearOptions},getFarClip:function(){return this._farClip},getFov:function(){return this._fov},getFrustum:function(){return this._frustum},getNearClip:function(){return this._nearClip},getOrthoHeight:function(){return this._orthoHeight},getProjection:function(){return this._projection},getProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===pc.scene.Projection.PERSPECTIVE)this._projMat.setPerspective(this._fov,
this._aspect,this._nearClip,this._farClip);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,b,-a,a,this._nearClip,this._farClip)}this._projMatDirty=!1}return this._projMat},getRect:function(){return this._rect},getRenderTarget:function(){return this._renderTarget},setAspectRatio:function(a){this._aspect=a;this._projMatDirty=!0},setClearOptions:function(a){this._clearOptions=a},setFarClip:function(a){this._farClip=a;this._projMatDirty=!0},setFov:function(a){this._fov=a;this._projMatDirty=
!0},setNearClip:function(a){this._nearClip=a;this._projMatDirty=!0},setOrthoHeight:function(a){this._orthoHeight=a;this._projMatDirty=!0},setProjection:function(a){this._projection=a;this._projMatDirty=!0},setRect:function(a,b,c,e){this._rect.x=a;this._rect.y=b;this._rect.width=c;this._rect.height=e},setRenderTarget:function(a){this._renderTarget=a}});return{CameraNode:d}}());pc.extend(pc.scene,function(){var d=function(){this._type=pc.scene.LIGHTTYPE_DIRECTIONAL;this._color=new pc.Color(0.8,0.8,0.8);this._intensity=1;this._enabled=this._castShadows=!1;this._attenuationEnd=this._attenuationStart=10;this._falloffMode=0;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new pc.Vec3(0.8,0.8,0.8);this._position=new pc.Vec3(0,0,0);this._direction=new pc.Vec3(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*
Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new pc.Mat4;this._shadowResolution=1024;this._shadowBias=-5E-4;this._scene=null},d=pc.inherits(d,pc.scene.GraphNode);pc.extend(d.prototype,{_cloneInternal:function(a){d._super._cloneInternal.call(this,a);a.setType(this.getType());a.setColor(this.getColor());a.setIntensity(this.getIntensity());a.setCastShadows(this.getCastShadows());a.setEnabled(this.getEnabled());a.setAttenuationStart(this.getAttenuationStart());a.setAttenuationEnd(this.getAttenuationEnd());
a.setFalloffMode(this.getFalloffMode());a.setInnerConeAngle(this.getInnerConeAngle());a.setOuterConeAngle(this.getOuterConeAngle());a.setShadowBias(this.getShadowBias());a.setShadowResolution(this.getShadowResolution())},clone:function(){var a=new pc.scene.LightNode;this._cloneInternal(a);return a},getAttenuationEnd:function(){return this._attenuationEnd},getAttenuationStart:function(){return this._attenuationStart},getFalloffMode:function(){return this._falloffMode},getCastShadows:function(){return this._castShadows},
getColor:function(){return this._color},getEnabled:function(){return this._enabled},getInnerConeAngle:function(){return this._innerConeAngle},getIntensity:function(){return this._intensity},getOuterConeAngle:function(){return this._outerConeAngle},getShadowBias:function(){return this._shadowBias},getShadowResolution:function(){return this._shadowResolution},getType:function(){return this._type},setAttenuationEnd:function(a){this._attenuationEnd=a},setAttenuationStart:function(a){this._attenuationStart=
a},setFalloffMode:function(a){this._falloffMode=a;null!==this._scene&&(this._scene.updateShaders=!0)},setCastShadows:function(a){this._castShadows=a;null!==this._scene&&(this._scene.updateShaders=!0)},setColor:function(){var a,b,c;1===arguments.length?(a=arguments[0].r,b=arguments[0].g,c=arguments[0].b):3===arguments.length&&(a=arguments[0],b=arguments[1],c=arguments[2]);this._color.set(a,b,c);var e=this._intensity;this._finalColor.set(a*e,b*e,c*e)},setEnabled:function(a){this._enabled!==a&&(this._enabled=
a,null!==this._scene&&(this._scene.updateShaders=!0))},setInnerConeAngle:function(a){this._innerConeAngle=a;this._innerConeAngleCos=Math.cos(a*Math.PI/180)},setIntensity:function(a){this._intensity=a;var a=this._color,b=this._intensity;this._finalColor.set(a.r*b,a.g*b,a.b*b)},setOuterConeAngle:function(a){this._outerConeAngle=a;this._outerConeAngleCos=Math.cos(a*Math.PI/180)},setShadowBias:function(a){this._shadowBias=a},setShadowResolution:function(a){this._shadowResolution=a},setType:function(a){this._type=
a}});return{LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,LightNode:d}}());pc.extend(pc.scene,function(){var d=0,a=function(){this.name="Untitled";this.id=d++;this.shader=null;this.parameters={};this.alphaTest=0;this.blend=!1;this.blendSrc=pc.gfx.BLENDMODE_ONE;this.blendDst=pc.gfx.BLENDMODE_ZERO;this.blendEquation=pc.gfx.BLENDEQUATION_ADD;this.cull=pc.gfx.CULLFACE_BACK;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=this.depthWrite=this.depthTest=!0;this.meshInstances=[]};Object.defineProperty(a.prototype,"blendType",{get:function(){return!this.blend&&this.blendSrc===
pc.gfx.BLENDMODE_ONE&&this.blendDst===pc.gfx.BLENDMODE_ZERO&&this.blendEquation===pc.gfx.BLENDEQUATION_ADD?pc.scene.BLEND_NONE:this.blend&&this.blendSrc===pc.gfx.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.gfx.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.gfx.BLENDEQUATION_ADD?pc.scene.BLEND_NORMAL:this.blend&&this.blendSrc===pc.gfx.BLENDMODE_ONE&&this.blendDst===pc.gfx.BLENDMODE_ONE&&this.blendEquation===pc.gfx.BLENDEQUATION_ADD?pc.scene.BLEND_ADDITIVE:this.blend&&this.blendSrc===pc.gfx.BLENDMODE_DST_COLOR&&
this.blendDst===pc.gfx.BLENDMODE_ZERO&&this.blendEquation===pc.gfx.BLENDEQUATION_ADD?pc.scene.BLEND_MULTIPLICATIVE:this.blend&&this.blendSrc===pc.gfx.BLENDMODE_ONE&&this.blendDst===pc.gfx.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.gfx.BLENDEQUATION_ADD?pc.scene.BLEND_PREMULTIPLIED:pc.scene.BLEND_NORMAL},set:function(a){switch(a){case pc.scene.BLEND_NONE:this.blend=!1;this.blendSrc=pc.gfx.BLENDMODE_ONE;this.blendDst=pc.gfx.BLENDMODE_ZERO;this.blendEquation=pc.gfx.BLENDEQUATION_ADD;break;
case pc.scene.BLEND_NORMAL:this.blend=!0;this.blendSrc=pc.gfx.BLENDMODE_SRC_ALPHA;this.blendDst=pc.gfx.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.gfx.BLENDEQUATION_ADD;break;case pc.scene.BLEND_PREMULTIPLIED:this.blend=!0;this.blendSrc=pc.gfx.BLENDMODE_ONE;this.blendDst=pc.gfx.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.gfx.BLENDEQUATION_ADD;break;case pc.scene.BLEND_ADDITIVE:this.blend=!0;this.blendDst=this.blendSrc=pc.gfx.BLENDMODE_ONE;this.blendEquation=pc.gfx.BLENDEQUATION_ADD;
break;case pc.scene.BLEND_MULTIPLICATIVE:this.blend=!0,this.blendSrc=pc.gfx.BLENDMODE_DST_COLOR,this.blendDst=pc.gfx.BLENDMODE_ZERO,this.blendEquation=pc.gfx.BLENDEQUATION_ADD}this._updateMeshInstanceKeys()}});a.prototype._cloneInternal=function(a){a.name=this.name;a.id=d++;a.shader=null;a.parameters={};a.alphaTest=this.alphaTest;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;
a.redWrite=this.redWrite;a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite;a.meshInstances=[]};a.prototype.clone=function(){var a=new pc.scene.Material;this._cloneInternal(a);return a};a.prototype._updateMeshInstanceKeys=function(){var a,c=this.meshInstances;for(a=0;a<c.length;a++)c[a].updateKey()};a.prototype.updateShader=function(){};a.prototype.getName=function(){return this.name};a.prototype.setName=function(a){this.name=a};a.prototype.clearParameters=function(){this.parameters=
{}};a.prototype.getParameters=function(){return this.parameters};a.prototype.getParameter=function(a){return this.parameters[a]};a.prototype.setParameter=function(a,c){var e=this.parameters[a];e?e.data=c:this.parameters[a]={scopeId:null,data:c}};a.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};a.prototype.setParameters=function(){for(var a in this.parameters){var c=this.parameters[a];c.scopeId||(c.scopeId=device.scope.resolve(a));c.scopeId.setValue(c.data)}};
a.prototype.getShader=function(){return this.shader};a.prototype.setShader=function(a){this.shader=a};a.prototype.update=function(){throw Error("Not Implemented in base class");};a.prototype.init=function(){throw Error("Not Implemented in base class");};return{Material:a}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.update()},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.BasicMaterial;Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data);this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(a){var b=
{skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("basic",b)}});return{BasicMaterial:d}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.DepthMaterial;Material.prototype._cloneInternal.call(this,a);a.update();return a},update:function(){},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("depth",b)}});return{DepthMaterial:d}}());pc.extend(pc.scene,function(){new pc.Vec3;new pc.Quat;new pc.Vec3;var d,a=function(a){if(a.data){if(a.data instanceof pc.gfx.Texture)return a.data;throw Error("PhongMaterial.init() expects textures to already be created");}return null},b=function(a){return new pc.Vec2(a.data[0],a.data[1])},c=function(a){return new pc.Vec3(a.data[0],a.data[1],a.data[2])},e=function(a){return new pc.Color(a.data[0],a.data[1],a.data[2])};d=pc.inherits(function(){this.ambient=new pc.Color(0.7,0.7,0.7);this.diffuse=new pc.Color(0.7,
0.7,0.7);this.diffuseMap=null;this.diffuseMapTiling=new pc.Vec2(1,1);this.diffuseMapOffset=new pc.Vec2(0,0);this.diffuseMapRotation=new pc.Vec3(0,0,0);this.diffuseMapTransform=null;this.specular=new pc.Color(0,0,0);this.specularMap=null;this.specularMapTiling=new pc.Vec2(1,1);this.specularMapOffset=new pc.Vec2(0,0);this.specularMapRotation=new pc.Vec3(0,0,0);this.specularMapTransform=null;this.shininess=25;this.glossMap=null;this.glossMapTiling=new pc.Vec2(1,1);this.glossMapOffset=new pc.Vec2(0,0);
this.glossMapRotation=new pc.Vec3(0,0,0);this.glossMapTransform=null;this.emissive=new pc.Color(0,0,0);this.emissiveMap=null;this.emissiveMapTiling=new pc.Vec2(1,1);this.emissiveMapOffset=new pc.Vec2(0,0);this.emissiveMapRotation=new pc.Vec3(0,0,0);this.emissiveMapTransform=null;this.opacity=1;this.opacityMap=null;this.opacityMapTiling=new pc.Vec2(1,1);this.opacityMapOffset=new pc.Vec2(0,0);this.opacityMapRotation=new pc.Vec3(0,0,0);this.opacityMapTransform=null;this.blendType=pc.scene.BLEND_NONE;
this.normalMapTransform=this.normalMap=null;this.normalMapTiling=new pc.Vec2(1,1);this.normalMapOffset=new pc.Vec2(0,0);this.normalMapRotation=new pc.Vec3(0,0,0);this.heightMap=null;this.heightMapTiling=new pc.Vec2(1,1);this.heightMapOffset=new pc.Vec2(0,0);this.heightMapRotation=new pc.Vec3(0,0,0);this.heightMapTransform=null;this.bumpiness=1;this.sphereMap=this.cubeMap=null;this.reflectivity=1;this.lightMap=null;this.fresnelFactor=0;this.ambientUniform=new Float32Array(3);this.diffuseUniform=new Float32Array(3);
this.specularUniform=new Float32Array(3);this.emissiveUniform=new Float32Array(3);this.update()},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.PhongMaterial;pc.scene.Material.prototype._cloneInternal.call(this,a);a.ambient.copy(this.ambient);a.diffuse.copy(this.diffuse);a.diffuseMap=this.diffuseMap;a.diffuseMapTiling=this.diffuseMapTiling?this.diffuseMapTiling.clone():new pc.Vec2(1,1);a.diffuseMapOffset=this.diffuseMapOffset?this.diffuseMapOffset.clone():new pc.Vec2(0,
0);a.diffuseMapRotation=this.diffuseMapRotation?this.diffuseMapRotation.clone():new pc.Vec3;a.diffuseMapTransform=this.diffuseMapTransform?this.diffuseMapTransform.clone():null;a.specular.copy(this.specular);a.specularMap=this.specularMap;a.specularMapTiling=this.specularMapTiling?this.specularMapTiling.clone():new pc.Vec2(1,1);a.specularMapOffset=this.specularMapOffset?this.specularMapOffset.clone():new pc.Vec2(0,0);a.specularMapRotation=this.specularMapRotation?this.specularMapRotation.clone():
new pc.Vec3;a.specularMapTransform=this.specularMapTransform?this.specularMapTransform.clone():null;a.shininess=this.shininess;a.glossMap=this.glossMap;a.glossMapTiling=this.glossMapTiling?this.glossMapTiling.clone():new pc.Vec2(1,1);a.glossMapOffset=this.glossMapOffset?this.glossMapOffset.clone():new pc.Vec2(0,0);a.glossMapRotation=this.glossMapRotation?this.glossMapRotation.clone():new pc.Vec3;a.glossMapTransform=this.glossMapTransform?this.glossMapTransform.clone():null;a.emissive.copy(this.emissive);
a.emissiveMap=this.emissiveMap;a.emissiveMapTiling=this.emissiveMapTiling?this.emissiveMapTiling.clone():new pc.Vec2(1,1);a.emissiveMapOffset=this.emissiveMapOffset?this.emissiveMapOffset.clone():new pc.Vec2(0,0);a.emissiveMapRotation=this.emissiveMapRotation?this.emissiveMapRotation.clone():new pc.Vec3;a.emissiveMapTransform=this.emissiveMapTransform?this.emissiveMapTransform.clone():null;a.opacity=this.opacity;a.opacityMap=this.opacityMap;a.opacityMapTiling=this.opacityMapTiling?this.opacityMapTiling.clone():
new pc.Vec2(1,1);a.opacityMapOffset=this.opacityMapOffset?this.opacityMapOffset.clone():new pc.Vec2(0,0);a.opacityMapRotation=this.opacityMapRotation?this.opacityMapRotation.clone():new pc.Vec3;a.opacityMapTransform=this.opacityMapTransform?this.opacityMapTransform.clone():null;a.blendType=this.blendType;a.normalMap=this.normalMap;a.normalMapTransform=this.normalMapTransform?this.normalMapTransform.clone():null;a.normalMapTiling=this.normalMapTiling?this.normalMapTiling.clone():new pc.Vec2(1,1);a.normalMapOffset=
this.normalMapOffset?this.normalMapOffset.clone():new pc.Vec2(0,0);a.normalMapRotation=this.normalMapRotation?this.normalMapRotation.clone():new pc.Vec3;a.heightMap=this.heightMap;a.heightMapTransform=this.heightMapTransform?this.heightMapTransform.clone():null;a.heightMapTiling=this.heightMapTiling?this.heightMapTiling.clone():new pc.Vec2(1,1);a.heightMapOffset=this.heightMapOffset?this.heightMapOffset.clone():new pc.Vec2(0,0);a.heightMapRotation=this.heightMapRotation?this.heightMapRotation.clone():
new pc.Vec3;a.bumpiness=this.bumpiness;a.cubeMap=this.cubeMap;a.sphereMap=this.sphereMap;a.reflectivity=this.reflectivity;a.lightMap=this.lightMap;a.fresnelFactor=this.fresnelFactor;a.update();return a},init:function(d){this.name=d.name;for(var f=0;f<d.parameters.length;f++){var h=d.parameters[f];switch(h.name){case "ambient":this.ambient=e(h);break;case "diffuse":this.diffuse=e(h);break;case "diffuseMap":this.diffuseMap=a(h);break;case "diffuseMapTiling":this.diffuseMapTiling=b(h);break;case "diffuseMapOffset":this.diffuseMapOffset=
b(h);break;case "diffuseMapRotation":this.diffuseMapRotation=c(h);break;case "specular":this.specular=e(h);break;case "specularMap":this.specularMap=a(h);break;case "specularMapTiling":this.specularMapTiling=b(h);break;case "specularMapOffset":this.specularMapOffset=b(h);break;case "specularMapRotation":this.specularMapRotation=c(h);break;case "shininess":this.shininess=h.data;break;case "glossMap":this.glossMap=a(h);break;case "glossMapTiling":this.glossMapTiling=b(h);break;case "glossMapOffset":this.glossMapOffset=
b(h);break;case "glossMapRotation":this.glossMapRotation=c(h);break;case "emissive":this.emissive=e(h);break;case "emissiveMap":this.emissiveMap=a(h);break;case "emissiveMapTiling":this.emissiveMapTiling=b(h);break;case "emissiveMapOffset":this.emissiveMapOffset=b(h);break;case "emissiveMapRotation":this.emissiveMapRotation=c(h);break;case "opacity":this.opacity=h.data;break;case "opacityMap":this.opacityMap=a(h);break;case "opacityMapTiling":this.opacityMapTiling=b(h);break;case "opacityMapOffset":this.opacityMapOffset=
b(h);break;case "opacityMapRotation":this.opacityMapRotation=c(h);break;case "normalMap":this.normalMap=a(h);break;case "normalMapTiling":this.normalMapTiling=b(h);break;case "normalMapOffset":this.normalMapOffset=b(h);break;case "normalMapRotation":this.normalMapRotation=c(h);break;case "heightMap":this.heightMap=a(h);break;case "heightMapTiling":this.heightMapTiling=b(h);break;case "heightMapOffset":this.heightMapOffset=b(h);break;case "heightMapRotation":this.heightMapRotation=c(h);break;case "bumpMapFactor":this.bumpiness=
h.data;break;case "cubeMap":this.cubeMap=a(h);break;case "sphereMap":this.sphereMap=a(h);break;case "reflectivity":this.reflectivity=h.data;break;case "lightMap":this.lightMap=a(h);break;case "depthTest":this.depthTest=h.data;break;case "depthWrite":this.depthWrite=h.data;break;case "cull":this.cull=h.data;break;case "blendType":this.blendType=h.data;break;case "fresnelFactor":this.fresnelFactor=h.data}}this.update()},_updateMapTransform:function(a,b,c){a=a||new pc.Vec4;a.set(b.x,b.y,c.x,c.y);return 1==
a.x&&1==a.y&&0==a.z&&0==a.w?null:a},_collectLights:function(a,b,c){for(var e=0;e<b.length;e++)b[e].getEnabled()&&b[e].getType()==a&&c.push(b[e])},update:function(){this.clearParameters();this.ambientUniform[0]=this.ambient.r;this.ambientUniform[1]=this.ambient.g;this.ambientUniform[2]=this.ambient.b;this.setParameter("material_ambient",this.ambientUniform);this.diffuseMap?(this.setParameter("texture_diffuseMap",this.diffuseMap),(this.diffuseMapTransform=this._updateMapTransform(this.diffuseMapTransform,
this.diffuseMapTiling,this.diffuseMapOffset,this.diffuseMapRotation))&&this.setParameter("texture_diffuseMapTransform",this.diffuseMapTransform.data)):(this.diffuseMapTransform=null,this.diffuseUniform[0]=this.diffuse.r,this.diffuseUniform[1]=this.diffuse.g,this.diffuseUniform[2]=this.diffuse.b,this.setParameter("material_diffuse",this.diffuseUniform));this.specularMap?(this.setParameter("texture_specularMap",this.specularMap),(this.specularMapTransform=this._updateMapTransform(this.specularMapTransform,
this.specularMapTiling,this.specularMapOffset,this.specularMapRotation))&&this.setParameter("texture_specularMapTransform",this.specularMapTransform.data)):(this.specularMapTransform=null,this.specularUniform[0]=this.specular.r,this.specularUniform[1]=this.specular.g,this.specularUniform[2]=this.specular.b,this.setParameter("material_specular",this.specularUniform));this.glossMap?(this.setParameter("texture_glossMap",this.glossMap),(this.glossMapTransform=this._updateMapTransform(this.glossMapTransform,
this.glossMapTiling,this.glossMapOffset,this.glossMapRotation))&&this.setParameter("texture_glossMapTransform",this.glossMapTransform.data)):(this.glossMapTransform=null,this.setParameter("material_shininess",this.shininess));this.emissiveMap?(this.setParameter("texture_emissiveMap",this.emissiveMap),(this.emissiveMapTransform=this._updateMapTransform(this.emissiveMapTransform,this.emissiveMapTiling,this.emissiveMapOffset,this.emissiveMapRotation))&&this.setParameter("texture_emissiveMapTransform",
this.emissiveMapTransform.data)):(this.emissiveMapTransform=null,this.emissiveUniform[0]=this.emissive.r,this.emissiveUniform[1]=this.emissive.g,this.emissiveUniform[2]=this.emissive.b,this.setParameter("material_emissive",this.emissiveUniform));this.opacityMap?(this.setParameter("texture_opacityMap",this.opacityMap),(this.opacityMapTransform=this._updateMapTransform(this.opacityMapTransform,this.opacityMapTiling,this.opacityMapOffset,this.opacityMapRotation))&&this.setParameter("texture_opacityMapTransform",
this.opacityMapTransform.data)):(this.opacityMapTransform=null,this.setParameter("material_opacity",this.opacity));this.normalMap?(this.setParameter("texture_normalMap",this.normalMap),(this.normalMapTransform=this._updateMapTransform(this.normalMapTransform,this.normalMapTiling,this.normalMapOffset,this.normalMapRotation))&&this.setParameter("texture_normalMapTransform",this.normalMapTransform.data)):this.normalMapTransform=null;this.heightMap?(this.setParameter("texture_heightMap",this.heightMap),
(this.heightMapTransform=this._updateMapTransform(this.heightMapTransform,this.heightMapTiling,this.heightMapOffset,this.heightMapRotation))&&this.setParameter("texture_heightMapTransform",this.heightMapTransform.data)):this.heightMapTransform=null;(this.normalMap||this.heightMap)&&this.setParameter("material_bumpMapFactor",this.bumpiness);this.cubeMap&&this.setParameter("texture_cubeMap",this.cubeMap);this.sphereMap&&this.setParameter("texture_sphereMap",this.sphereMap);(this.sphereMap||this.cubeMap)&&
this.setParameter("material_reflectionFactor",this.reflectivity);0<this.fresnelFactor&&this.setParameter("material_fresnelFactor",this.fresnelFactor);this.lightMap&&this.setParameter("texture_lightMap",this.lightMap);this.shader=null},_getMapTransformID:function(a){if(!a)return 0;var b,c,e;for(b=0;b<this._mapXForms.length;b++){e=!0;for(c=0;c<a.data.length;c++)if(this._mapXForms[b][c]!=a.data[c]){e=!1;break}if(e)return b+1}b=this._mapXForms.length;this._mapXForms[b]=[];for(c=0;c<a.data.length;c++)this._mapXForms[b][c]=
a.data[c];return b+1},updateShader:function(a,b){var c=b._lights;this._mapXForms=[];var e={fog:b.fog,gamma:b.gammaCorrection,skin:!!this.meshInstances[0].skinInstance,diffuseMap:!!this.diffuseMap,diffuseMapTransform:this._getMapTransformID(this.diffuseMapTransform),specularMap:!!this.specularMap,specularMapTransform:this._getMapTransformID(this.specularMapTransform),glossMap:!!this.glossMap,glossMapTransform:this._getMapTransformID(this.glossMapTransform),emissiveMap:!!this.emissiveMap,emissiveMapTransform:this._getMapTransformID(this.emissiveMapTransform),
opacityMap:!!this.opacityMap,opacityMapTransform:this._getMapTransformID(this.opacityMapTransform),normalMap:!!this.normalMap,normalMapTransform:this._getMapTransformID(this.normalMapTransform),heightMap:!!this.heightMap,heightMapTransform:this._getMapTransformID(this.heightMapTransform),sphereMap:!!this.sphereMap,cubeMap:!!this.cubeMap,lightMap:!!this.lightMap,useSpecular:!!this.specularMap||!(0===this.specular.r&&0===this.specular.g&&0===this.specular.b)||!!this.sphereMap||!!this.cubeMap,useFresnel:0<
this.fresnelFactor};this._mapXForms=null;var d=[];this._collectLights(pc.scene.LIGHTTYPE_DIRECTIONAL,c,d);this._collectLights(pc.scene.LIGHTTYPE_POINT,c,d);this._collectLights(pc.scene.LIGHTTYPE_SPOT,c,d);e.lights=d;this.shader=a.getProgramLibrary().getProgram("phong",e)}});return{PhongMaterial:d}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.update()},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.PickMaterial;Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data)},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("pick",
b)}});return{PickMaterial:d}}());pc.extend(pc.scene,function(){var d=function(a,b,c){this.node=a;this.mesh=b;this.material=c;this.layer=pc.scene.LAYER_WORLD;this.renderStyle=pc.scene.RENDERSTYLE_SOLID;this.castShadow=!1;this.receiveShadow=!0;this.key=0;this.updateKey();this.skinInstance=null;this.aabb=new pc.shape.Aabb;this.normalMatrix=new pc.Mat3};Object.defineProperty(d.prototype,"aabb",{get:function(){this._aabb.setFromTransformedAabb(this.mesh.aabb,this.node.worldTransform);return this._aabb},set:function(a){this._aabb=a}});
Object.defineProperty(d.prototype,"material",{get:function(){return this._material},set:function(a){if(this._material){var b=this._material.meshInstances,c=b.indexOf(this);-1!==c&&b.splice(c,1)}this._material=a;this._material.meshInstances.push(this);this.updateKey()}});Object.defineProperty(d.prototype,"layer",{get:function(){return this._layer},set:function(a){this._layer=a;this.updateKey()}});pc.extend(d.prototype,{syncAabb:function(){},updateKey:function(){var a=this.material;this.key=(this.layer&
7)<<28|(a.blendType&3)<<26|0|(a.id&33554431)<<0}});return{Command:function(a,b,c){this.key=(a&7)<<28|(b&3)<<26|33554432;this.command=c},Mesh:function(){this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this.skin=null;this.aabb=new pc.shape.Aabb},MeshInstance:d}}());pc.extend(pc.scene,function(){var d=function(a){this.skin=a;this.bones=[];var c=a.inverseBindPose.length,a=a.device;a.supportsBoneTextures?(c=256<c?64:64<c?32:16<c?16:8,this.matrixPalette=new Float32Array(4*c*c),this.boneTexture=new pc.gfx.Texture(a,{width:c,height:c,format:pc.gfx.PIXELFORMAT_RGBA32F,autoMipmap:!1}),this.boneTexture.minFilter=pc.gfx.FILTER_NEAREST,this.boneTexture.magFilter=pc.gfx.FILTER_NEAREST,this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*c)},
a=new pc.Mat4;d.prototype={updateMatrixPalette:function(){for(var b=a.data,c=this.matrixPalette,e,d=this.bones.length-1;0<=d;d--)a.mul2(this.bones[d].worldTransform,this.skin.inverseBindPose[d]),e=16*d,c[e]=b[0],c[e+1]=b[1],c[e+2]=b[2],c[e+3]=b[3],c[e+4]=b[4],c[e+5]=b[5],c[e+6]=b[6],c[e+7]=b[7],c[e+8]=b[8],c[e+9]=b[9],c[e+10]=b[10],c[e+11]=b[11],c[e+12]=b[12],c[e+13]=b[13],c[e+14]=b[14],c[e+15]=b[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}};return{Skin:function(a,
c,e){this.device=a;this.inverseBindPose=c;this.boneNames=e},SkinInstance:d}}());pc.extend(pc.scene,function(){function d(){this.index=0;this.boneIndices=[0,0,0,0]}function a(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}a.prototype={addVertex:function(a,c,e){var d=-1;if(void 0!==this.indexMap[c])d=this.indexMap[c],this.indices.push(d);else{for(d=0;4>d;d++)0!==e.blendWeight.data[4*c+d]&&(a.boneIndices[d]=this.getBoneRemap(e.blendIndices.data[4*a.index+d]));d=this.vertices.length;
this.indices.push(d);this.vertices.push(a);this.indexMap[c]=d}},addPrimitive:function(a,c,e,d){var f,h,l=[],k=0,n=a.length;for(f=0;f<n;f++)for(var m=a[f].index,r=0;4>r;r++)if(0<e.blendWeight.data[4*m+r]){var w=e.blendIndices.data[4*m+r],s=!0;for(h=0;h<k;h++)if(l[h]==w){s=!1;break}s&&(l[k]=w,h=this.getBoneRemap(w),k+=-1===h?1:0)}if(this.boneIndices.length+k>d)return!1;for(f=0;f<k;f++)this.boneIndices.push(l[f]);for(f=0;f<n;f++)this.addVertex(a[f],c[f],e);return!0},getBoneRemap:function(a){for(var c=
0;c<this.boneIndices.length;c++)if(this.boneIndices[c]===a)return c;return-1}};return{partitionSkin:function(b,c,e){var g,f,h,l=b.vertices,k=b.skins,n=b.meshes,m=b.meshInstances;for(g=0;g<n.length;g++)n[g].vertices=l[n[g].vertices],"undefined"!==typeof n[g].skin&&(n[g].skin=k[n[g].skin]);for(g=0;g<m.length;g++)m[g].mesh=n[m[g].mesh];l=b.vertices;k=b.skins;n=b.meshes;m=b.meshInstances;for(g=k.length-1;0<=g;g--)if(k[g].boneNames.length>e){var r=k.splice(g,1)[0],w=[];for(f=0;f<n.length;f++)n[f].skin===
r&&w.push(n[f]);for(f=0;f<w.length;f++){var s=n.indexOf(w[f]);-1!==s&&n.splice(s,1)}if(0===w.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var G=w[0].vertices;for(f=1;f<w.length;f++)if(w[f].vertices!==G)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var x=[],u=function(a){var b=new d;b.index=a;return b};h=[];var v=[],z=0;for(f=0;f<w.length;f++){for(var A=w[f],C=A.indices,H=A.base;H<A.base+A.count;){s=
C[H++];h[0]=u(s);v[0]=s;s=C[H++];h[1]=u(s);v[1]=s;s=C[H++];h[2]=u(s);v[2]=s;for(var E=!1,I=z;I<x.length;I++)if(s=x[I],s.addPrimitive(h,v,G,e)){E=!0;break}E||(s=new a,s.originalMesh=A,s.addPrimitive(h,v,G,e),x.push(s))}z=x.length}A=[];w=[];for(f=0;f<x.length;f++)if(s=x[f],s.vertices.length&&s.indices.length){u=A.length;h=s.vertices.length;v=w.length;z=s.indices.length;s.partition=f;s.vertexStart=u;s.vertexCount=h;s.indexStart=v;s.indexCount=z;C=0;for(H=u;C<h;)A[H++]=s.vertices[C++];C=0;for(H=v;C<z;)w[H++]=
s.indices[C++]+u}u=[];for(f=0;f<x.length;f++){s=x[f];v=[];z=[];for(h=0;h<s.boneIndices.length;h++)v.push(r.inverseBindMatrices[s.boneIndices[h]]),z.push(r.boneNames[s.boneIndices[h]]);s={inverseBindMatrices:v,boneNames:z};u.push(s);k.push(s)}var y,r={};for(y in G)r[y]={components:G[y].components,data:[],type:G[y].type};for(y in G)if("blendIndices"===y){s=r[y].data;for(f=0;f<A.length;f++)h=A[f].boneIndices,s.push(h[0],h[1],h[2],h[3])}else{f=G[y];data=f.data;components=f.components;for(f=0;f<A.length;f++){s=
A[f].index;for(h=0;h<components;h++)r[y].data.push(data[s*components+h])}}l[l.indexOf(G)]=r;for(f=0;f<x.length;f++){s=x[f];A={aabb:{min:[0,0,0],max:[0,0,0]},vertices:r,skin:u[f],indices:w.splice(0,s.indexCount),type:"triangles",base:0,count:s.indexCount};n.push(A);for(h=m.length-1;0<=h;h--)m[h].mesh===s.originalMesh&&(m.push({mesh:A,node:m[h].node}),c&&c.push({material:c[h].material,path:c[h].path}))}for(f=0;f<x.length;f++){s=x[f];for(h=m.length-1;0<=h;h--)m[h].mesh===s.originalMesh&&(m.splice(h,
1),c&&c.splice(h,1))}}c=b.vertices;e=b.skins;y=b.meshes;g=b.meshInstances;for(b=0;b<y.length;b++)y[b].vertices=c.indexOf(y[b].vertices),"undefined"!==typeof y[b].skin&&(y[b].skin=e.indexOf(y[b].skin));for(b=0;b<g.length;b++)g[b].mesh=y.indexOf(g[b].mesh)}}}());pc.extend(pc.scene,function(){var d=function(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.cameras=[];this.lights=[]};d.prototype={getGraph:function(){return this.graph},setGraph:function(a){this.graph=a},getCameras:function(){return this.cameras},setCameras:function(a){this.cameras=a},getLights:function(){return this.lights},setLights:function(a){this.lights=a},getMaterials:function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var c=this.meshInstances[a];-1===b.indexOf(c.material)&&
b.push(c.material)}return b},clone:function(){var a,b=[],c=[],e=function(a){var d=a.clone();b.push(a);c.push(d);a instanceof pc.scene.CameraNode?r.cameras.push(d):a instanceof pc.scene.LightNode&&r.lights.push(d);for(var a=a.getChildren(),f=0;f<a.length;f++)d.addChild(e(a[f]));return d},d=e(this.graph),f=[],h=[];for(a=0;a<this.skinInstances.length;a++){var l=this.skinInstances[a].skin,k=new pc.scene.SkinInstance(l),n=[];for(j=0;j<l.boneNames.length;j++){var m=d.findByName(l.boneNames[j]);n.push(m)}k.bones=
n;h.push(k)}for(a=0;a<this.meshInstances.length;a++)l=this.meshInstances[a],k=b.indexOf(l.node),k=new pc.scene.MeshInstance(c[k],l.mesh,l.material),l.skinInstance&&(l=this.skinInstances.indexOf(l.skinInstance),k.skinInstance=h[l]),f.push(k);var r=new pc.scene.Model;r.graph=d;r.meshInstances=f;r.skinInstances=h;r.getGraph().syncHierarchy();return r},generateWireframe:function(){var a,b,c,e,d,f,h,l,k,n,m=[];for(a=0;a<this.meshInstances.length;a++)f=this.meshInstances[a].mesh,-1===m.indexOf(f)&&m.push(f);
var r=[[0,1],[1,2],[2,0]];for(a=0;a<m.length;a++){f=m[a];h=f.primitive[pc.scene.RENDERSTYLE_SOLID].base;l=f.primitive[pc.scene.RENDERSTYLE_SOLID].count;k=f.indexBuffer[pc.scene.RENDERSTYLE_SOLID];n=new Uint16Array(k.lock());var w={},s=[];for(b=h;b<h+l;b+=3)for(c=0;3>c;c++){e=n[b+r[c][0]];d=n[b+r[c][1]];var G=e>d?d<<16|e:e<<16|d;void 0===w[G]&&(w[G]=0,s.push(e,d))}k.unlock();b=new pc.gfx.IndexBuffer(k.device,pc.gfx.INDEXFORMAT_UINT16,s.length);c=new Uint16Array(b.lock());c.set(s);b.unlock();f.primitive[pc.scene.RENDERSTYLE_WIREFRAME]=
{type:pc.gfx.PRIMITIVE_LINES,base:0,count:s.length,indexed:!0};f.indexBuffer[pc.scene.RENDERSTYLE_WIREFRAME]=b}}};return{Model:d}}());pc.extend(pc.scene,function(){var d=new pc.Vec3,a=new pc.Vec3,b=new pc.Vec3,c=new pc.Vec4,e=[[-0.5,-0.5],[0.5,-0.5],[0.5,0.5],[-0.5,0.5]],g=function(a){return 2*(Math.random()-0.5)*a},f=function(a){var b=new pc.Vec3;b.set(g(a.x),g(a.y),g(a.z));return b},h=function(a){var b=new pc.Vec4;b.set(g(a.x),g(a.y),g(a.z),g(a.w));return b},l=function(a,b,c,e){a=new pc.gfx.Texture(a,{width:b,height:c,format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,cubemap:!1,autoMipmap:!0});a.lock().set(e);a.unlock();a.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;
a.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;a.minFilter=pc.gfx.FILTER_LINEAR;a.magFilter=pc.gfx.FILTER_LINEAR;return a},k=function(a,b){this.graphicsDevice=a;this.numParticles="undefined"!==typeof b.numParticles?b.numParticles:1;this.numFrames="undefined"!==typeof b.numFrames?b.numFrames:1;this.frameDuration="undefined"!==typeof b.frameDuration?b.frameDuration:1;this.frameStart="undefined"!==typeof b.frameStart?b.frameStart:0;this.frameStartRange="undefined"!==typeof b.frameStartRange?b.frameStartRange:
0;this.timeRange="undefined"!==typeof b.timeRange?b.timeRange:99999999;this.startTime="undefined"!==typeof b.startTime?b.startTime:null;this.lifeTime="undefined"!==typeof b.lifeTime?b.lifeTime:1;this.lifeTimeRange="undefined"!==typeof b.lifeTimeRange?b.lifeTimeRange:0;this.startSize="undefined"!==typeof b.startSize?b.startSize:1;this.startSizeRange="undefined"!==typeof b.startSizeRange?b.startSizeRange:0;this.endSize="undefined"!==typeof b.endSize?b.endSize:1;this.endSizeRange="undefined"!==typeof b.endSizeRange?
b.endSizeRange:0;this.position="undefined"!==typeof b.position?b.position:new pc.Vec3(0,0,0);this.positionRange="undefined"!==typeof b.positionRange?b.positionRange:new pc.Vec3(0,0,0);this.velocity="undefined"!==typeof b.velocity?b.velocity:new pc.Vec3(0,0,0);this.velocityRange="undefined"!==typeof b.velocityRange?b.velocityRange:new pc.Vec3(0,0,0);this.acceleration="undefined"!==typeof b.acceleration?b.acceleration:new pc.Vec3(0,0,0);this.accelerationRange="undefined"!==typeof b.accelerationRange?
b.accelerationRange:new pc.Vec3(0,0,0);this.spinStart="undefined"!==typeof b.spinStart?b.spinStart:0;this.spinStartRange="undefined"!==typeof b.spinStartRange?b.spinStartRange:0;this.spinSpeed="undefined"!==typeof b.spinSpeed?b.spinSpeed:0;this.spinSpeedRange="undefined"!==typeof b.spinSpeedRange?b.spinSpeedRange:0;this.colorMult="undefined"!==typeof b.colorMult?b.colorMult:new pc.Vec4(1,1,1,1);this.colorMultRange="undefined"!==typeof b.colorMultRange?b.colorMultRange:new pc.Vec4(0,0,0,0);this.worldVelocity=
"undefined"!==typeof b.worldVelocity?b.worldVelocity:new pc.Vec3(0,0,0);this.worldAcceleration="undefined"!==typeof b.worldAcceleration?b.worldAcceleration:new pc.Vec3(0,0,0);this.billboard="undefined"!==typeof b.billboard?b.billboard:!0;this.orientation="undefined"!==typeof b.orientation?b.orientation:new pc.Vec4(0,0,0,1);this.dynamic="undefined"!==typeof b.dynamic?b.dynamic:!1;this.birthIndex=0;this.maxParticles=1E3;for(var c=[],e=[0,0.2,0.7,1,1,0.7,0.2,0],d=0;8>d;d++)for(var f=0;8>f;f++){var g=
255*e[f]*e[d];c.push(g,g,g,g)}this.colorMap=l(a,8,8,c);this.opacityMap=l(a,1,1,[255,255,255,255]);this.rampMap=l(a,2,1,[255,255,255,255,255,255,255,0]);this.allocate(this.numParticles);this.generate(0,this.numParticles);c=new pc.scene.Mesh;c.vertexBuffer=this.vertexBuffer;c.indexBuffer[0]=this.indexBuffer;c.primitive[0].type=pc.gfx.PRIMITIVE_TRIANGLES;c.primitive[0].base=0;c.primitive[0].count=this.indexBuffer.getNumIndices();c.primitive[0].indexed=!0;e=new pc.scene.Material;d=this.graphicsDevice.getProgramLibrary().getProgram("particle",
{billboard:this.billboard});e.setShader(d);e.setParameter("particle_worldVelocity",this.worldVelocity.data);e.setParameter("particle_worldAcceleration",this.worldAcceleration.data);e.setParameter("particle_numFrames",this.numFrames);e.setParameter("particle_frameDuration",this.frameDuration);e.setParameter("particle_timeRange",this.timeRange);e.setParameter("particle_timeOffset",0);e.setParameter("particle_time",0);e.setParameter("texture_colorMap",this.colorMap);e.setParameter("texture_opacityMap",
this.opacityMap);e.setParameter("texture_rampMap",this.rampMap);e.cullMode=pc.gfx.CULLFACE_NONE;e.blend=!0;e.blendSrc=pc.gfx.BLENDMODE_SRC_ALPHA;e.blendDst=pc.gfx.BLENDMODE_ONE;e.depthWrite=!1;this.meshInstance=new pc.scene.MeshInstance(null,c,e);this.meshInstance.layer=pc.scene.LAYER_FX;this.meshInstance.updateKey();this.time=0};k.prototype={allocate:function(a){if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==4*a){var b=[{semantic:pc.gfx.SEMANTIC_ATTR0,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},
{semantic:pc.gfx.SEMANTIC_ATTR1,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR2,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR3,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR4,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR5,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32}];this.billboard||b.push({semantic:pc.gfx.SEMANTIC_ATTR6,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32});b=new pc.gfx.VertexFormat(this.graphicsDevice,
b);this.vertexBuffer=new pc.gfx.VertexBuffer(this.graphicsDevice,b,4*a,pc.gfx.BUFFER_DYNAMIC);this.indexBuffer=new pc.gfx.IndexBuffer(this.graphicsDevice,pc.gfx.INDEXFORMAT_UINT16,6*a);for(var b=0,c=new Uint16Array(this.indexBuffer.lock()),e=0;e<a;e++){var d=4*e;c[b++]=d;c[b++]=d+1;c[b++]=d+2;c[b++]=d;c[b++]=d+2;c[b++]=d+3}this.indexBuffer.unlock()}},generate:function(l,k){for(var r=new Float32Array(this.vertexBuffer.lock()),w=this.billboard?24:28,s=l;s<k;s++){var G=this.lifeTime,x=s*G/k,u=this.frameStart+
g(this.frameStartRange);d.add2(this.position,f(this.positionRange));a.add2(this.velocity,f(this.velocityRange));b.add2(this.acceleration,f(this.accelerationRange));c.add2(this.colorMult,h(this.colorMultRange));for(var v=this.spinStart+g(this.spinStartRange),z=this.spinSpeed+g(this.spinSpeedRange),A=this.startSize+g(this.startSizeRange),C=this.endSize+g(this.endSizeRange),H=this.orientation,E=0;4>E;E++){var I=(4*s+E)*w;r[I+0]=e[E][0];r[I+1]=e[E][1];r[I+2]=G;r[I+3]=u;r[I+4]=d.x;r[I+5]=d.y;r[I+6]=d.z;
r[I+7]=x;r[I+8]=a.x;r[I+9]=a.y;r[I+10]=a.z;r[I+11]=A;r[I+12]=b.x;r[I+13]=b.y;r[I+14]=b.z;r[I+15]=C;r[I+16]=v;r[I+17]=z;r[I+18]=0;r[I+19]=0;r[I+20]=c.x;r[I+21]=c.y;r[I+22]=c.z;r[I+23]=c.w;this.billboard||(r[I+24]=H.x,r[I+25]=H.y,r[I+26]=H.z,r[I+27]=H.w)}}this.vertexBuffer.unlock()},addTime:function(a){this.time+=a;this.meshInstance.material.setParameter("particle_time",this.time);this.dynamic&&(this.generate(this.birthIndex+this.numParticles,this.numParticles),this.birthIndex+=this.numParticles)},
setColorRamp:function(a){for(var b=0;b<a.length;b++)a[b]=Math.floor(255*a[b]);this.rampMap=l(this.graphicsDevice,a.length/4,1,a);this.meshInstance.material.setParameter("texture_rampMap",this.rampMap)},setColorMap:function(a){this.colorMap=a;this.meshInstance.material.setParameter("texture_colorMap",this.colorMap)},setOpacityMap:function(a){this.opacityMap=a;this.meshInstance.material.setParameter("texture_opacityMap",this.opacityMap)}};return{ParticleEmitter:k}}());pc.extend(pc.scene,function(){function d(a){return Math.max(Math.min(a,1),0)}function a(a,b,c,e){var d,f,g;if(void 0===c||2>c)return b*=a.length-1,d=a[Math.floor(b)],f=a[Math.ceil(b)],pc.math.lerp(d,f,b%1);b*=a.length/c-1;e||(e=[]);for(var h=0;h<c;h++)d=a[Math.floor(b)*c+h],f=a[Math.ceil(b)*c+h],g=b%1,e[h]=pc.math.lerp(d,f,g);return e}function b(a,b){P[a]=void 0!==M[a]&&null!==M[a]?M[a]:b}function c(a,b){for(var c=a.length/3,e=Array(4*c),d=0;d<c;d++)e[4*d]=a[3*d],e[4*d+1]=a[3*d+1],e[4*d+2]=a[3*d+
2],e[4*d+3]=(255*b[3*d]<<16|255*b[3*d+1]<<8|255*b[3*d+2])/16777216;return e}function e(a,b,c){for(var e=new Float32Array(b.length),d=0;d<b.length;d++)e[d]=b[d]-a[d];for(var d=c.length,f=e.length/d,a=0;a<f;a++)for(b=0;b<d;b++){var g=Math.abs(e[a*d+b]);c[b]=Math.max(c[b],g)}a=c.length;f=e.length/a;for(b=0;b<f;b++)for(d=0;d<a;d++)e[b*a+d]/=c[d],e[b*a+d]*=0.5,e[b*a+d]+=0.5;return e}function g(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=
a.data[6];b.data[6]=a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}var f=[[-1,-1],[1,-1],[1,1],[-1,1]],h=function(a,b,c,e,d,f){d||(d=pc.gfx.PIXELFORMAT_RGBA32F);a=new pc.gfx.Texture(a,{width:b,height:c,format:d,cubemap:!1,autoMipmap:!1});a.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;a.minFilter=pc.gfx.FILTER_NEAREST;a.magFilter=pc.gfx.FILTER_NEAREST;b=a.lock();if(d==pc.gfx.PIXELFORMAT_R8_G8_B8_A8){d=new Uint8Array(e.length);for(c=0;c<e.length;c++)d[c]=255*e[c]*
f;e=d}b.set(e);a.unlock();return a},l=new pc.Curve([0,0,1,0]),k=new pc.Curve([0,1,1,1]),n=new pc.CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),m=new pc.CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),r=null,w=new pc.Vec3,s=new pc.Vec3,G=new pc.Vec3,x=new pc.Vec3,u=new pc.Vec3,v=new pc.Vec3,z=new pc.Vec3,A=new pc.Vec3,C=new pc.Vec3,H=new pc.Vec3,E=new pc.Mat4,I=new pc.Mat3,y=new pc.Mat3,B=1,K,D=new pc.Mat4,J=new pc.Vec3,F=new pc.Vec3,L=new pc.Vec3,P,M,Q=function(a,c){this.graphicsDevice=a;this.precision=32;if(!r){var e=
new Float32Array(1024),f,g,s,w;for(g=0;16>g;g++)for(f=0;16>f;f++)s=f+1-8.5,w=g+1-8.5,w=d(1-d(Math.sqrt(s*s+w*w)/16)-0.5),s=16*g+f,e[4*s]=1,e[4*s+1]=1,e[4*s+2]=1,e[4*s+3]=w;r=h(a,16,16,e,pc.gfx.PIXELFORMAT_R8_G8_B8_A8,1);r.minFilter=pc.gfx.FILTER_LINEAR;r.magFilter=pc.gfx.FILTER_LINEAR}P=this;M=c;b("numParticles",1);b("rate",1);b("rate2",this.rate);b("lifetime",50);b("spawnBounds",new pc.Vec3(0,0,0));b("wrap",!1);b("wrapBounds",null);b("colorMap",r);b("normalMap",null);b("oneShot",!1);b("preWarm",
!1);b("sort",pc.scene.PARTICLES_SORT_NONE);b("mode",this.sort>pc.scene.PARTICLES_SORT_NONE?"CPU":"GPU");b("camera",null);b("scene",null);b("lighting",!1);b("halfLambert",!1);b("intensity",1);b("stretch",0);b("depthSoftening",0);b("mesh",null);b("depthTest",!1);b("blendType",pc.scene.BLEND_NORMAL);b("node",null);b("startAngle",0);b("startAngle2",this.startAngle);this.mode="CPU"===this.mode?pc.scene.PARTICLES_MODE_CPU:pc.scene.PARTICLES_MODE_GPU;a.extTextureFloat&&1<=a.maxVertexTextures||(this.mode=
pc.scene.PARTICLES_MODE_CPU);100>a.fragmentUniformsCount&&(this.mode=pc.scene.PARTICLES_MODE_CPU);this.frameRandom=new pc.Vec3(0,0,0);b("colorGraph",m);b("colorGraph2",this.colorGraph);b("scaleGraph",k);b("scaleGraph2",this.scaleGraph);b("alphaGraph",k);b("alphaGraph2",this.alphaGraph);b("localVelocityGraph",n);b("localVelocityGraph2",this.localVelocityGraph);b("velocityGraph",n);b("velocityGraph2",this.velocityGraph);b("rotationSpeedGraph",l);b("rotationSpeedGraph2",this.rotationSpeedGraph);this.constantParticleTexIN=
a.scope.resolve("particleTexIN");this.constantParticleTexOUT=a.scope.resolve("particleTexOUT");this.constantEmitterPos=a.scope.resolve("emitterPos");this.constantEmitterScale=a.scope.resolve("emitterScale");this.constantSpawnBounds=a.scope.resolve("spawnBounds");this.constantFrameRandom=a.scope.resolve("frameRandom");this.constantDelta=a.scope.resolve("delta");this.constantRate=a.scope.resolve("rate");this.constantRateDiv=a.scope.resolve("rateDiv");this.constantLifetime=a.scope.resolve("lifetime");
this.constantLightCube=a.scope.resolve("lightCube[0]");this.constantGraphSampleSize=a.scope.resolve("graphSampleSize");this.constantGraphNumSamples=a.scope.resolve("graphNumSamples");this.constantInternalTex0=a.scope.resolve("internalTex0");this.constantInternalTex1=a.scope.resolve("internalTex1");this.constantInternalTex2=a.scope.resolve("internalTex2");this.constantEmitterMatrix=a.scope.resolve("emitterMatrix");this.constantNumParticles=a.scope.resolve("numParticles");this.constantNumParticlesPot=
a.scope.resolve("numParticlesPot");this.constantTotalTime=a.scope.resolve("totalTime");this.constantTotalTimePrev=a.scope.resolve("totalTimePrev");this.constantLocalVelocityDivMult=a.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=a.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=a.scope.resolve("rotSpeedDivMult");this.constantOneShotStartTime=a.scope.resolve("oneShotStartTime");this.constantOneShotEndTime=a.scope.resolve("oneShotEndTime");this.constantSeed=a.scope.resolve("seed");
this.constantStartAngle=a.scope.resolve("startAngle");this.constantStartAngle2=a.scope.resolve("startAngle2");this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);this.lightCubeDir[0]=new pc.Vec3(-1,0,0);this.lightCubeDir[1]=new pc.Vec3(1,0,0);this.lightCubeDir[2]=new pc.Vec3(0,-1,0);this.lightCubeDir[3]=new pc.Vec3(0,1,0);this.lightCubeDir[4]=new pc.Vec3(0,0,-1);this.lightCubeDir[5]=new pc.Vec3(0,0,1);this.particleNoize=this.particleDistance=this.vbOld=this.vbToSort=this.internalTex3=this.internalTex2=
this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null;this.numParticleIndices=this.numParticleVerts=0;this.meshInstance=this.material=null;this.seed=this.oneShotEndTime=this.oneShotStartTime=this.totalTimePrev=this.totalTime=0;this.rebuild()};Q.prototype={rebuild:function(){var a;this.numParticlesPot=pc.math.nextPowerOfTwo(this.numParticles);var b=this.graphicsDevice;if(0<this.depthSoftening&&this.camera&&!this.camera.camera.camera._depthTarget){a=
this.camera.camera.camera;var c;c=this.graphicsDevice;var e=this.camera.camera.rect,e=new pc.gfx.Texture(c,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,width:Math.floor(e.z*c.width),height:Math.floor(e.w*c.height)});e.minFilter=pc.gfx.FILTER_NEAREST;e.magFilter=pc.gfx.FILTER_NEAREST;e.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;e.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;c=new pc.gfx.RenderTarget(c,e,{depth:!0});a._depthTarget=c;this.camera.camera._depthTarget=this.camera.camera.camera._depthTarget;this.camera._depthTarget=
this.camera.camera.camera._depthTarget}this.rebuildGraphs();this.vbToSort=Array(this.numParticles);this.vbOld=new Float32Array(16*this.numParticles);this.particleDistance=new Float32Array(this.numParticles);this.particleNoize=new Float32Array(this.numParticles);for(a=0;a<this.numParticles;a++)this.particleNoize[a]=Math.random();this.particleTex=new Float32Array(4*this.numParticles);c=null===this.node?pc.Vec3.ZERO:this.node.getPosition();null===this.node?D.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):
D.setTRS(pc.Vec3.ZERO,this.node.getRotation(),L.copy(this.spawnBounds).mul(this.node.getLocalScale()));for(a=0;a<this.numParticles;a++)this.calcSpawnPosition(c,a);this.particleTexStart=new Float32Array(4*this.numParticles);for(a=0;a<this.particleTexStart.length;a++)this.particleTexStart[a]=this.particleTex[a];this.mode===pc.scene.PARTICLES_MODE_GPU&&(this.particleTexIN=h(b,this.numParticlesPot,1,this.particleTex),this.particleTexOUT=h(b,this.numParticlesPot,1,this.particleTex),this.particleTexStart=
h(b,this.numParticlesPot,1,this.particleTexStart),this.rtParticleTexIN=new pc.gfx.RenderTarget(b,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new pc.gfx.RenderTarget(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=pc.gfx.shaderChunks;c=a.particleUpdaterStartPS;c+=a.particleUpdaterRespawnPS;c+=a.particleUpdaterEndPS;e=a.particleUpdaterStartPS;e+=a.particleUpdaterRespawnPS;e+=a.particleUpdaterEndPS;this.shaderParticleUpdateRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,c,"fsQuadfalse");
this.shaderParticleUpdateNoRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,e,"fsQuadtrue");this.numParticleVerts=null===this.mesh?4:this.mesh.vertexBuffer.numVertices;this.numParticleIndices=null===this.mesh?6:this.mesh.indexBuffer[0].numIndices;this._allocate(this.numParticles);b=new pc.scene.Mesh;b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=this.indexBuffer;b.primitive[0].type=pc.gfx.PRIMITIVE_TRIANGLES;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*this.numParticleIndices;
b.primitive[0].indexed=!0;a=null!=this.normalMap;var d=this.graphicsDevice.getProgramLibrary();this.normalOption=0;this.lighting&&(this.normalOption=a?2:1);this.isMesh=null!=this.mesh;this.material=new pc.scene.Material;this.material.cullMode=pc.gfx.CULLFACE_NONE;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthTest;this.material.emitter=this;this.material.updateShader=function(){var a=d.getProgram("particle2",{mode:this.emitter.mode,normal:this.emitter.normalOption,
halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,soft:this.emitter.depthSoftening&&this.emitter._hasDepthTarget(),mesh:this.emitter.isMesh,srgb:this.emitter.scene?this.emitter.scene.gammaCorrection:!1,wrap:this.emitter.wrap&&this.emitter.wrapBounds,blend:this.blendType});this.setShader(a)};this.material.updateShader();this.resetMaterial();this.meshInstance=new pc.scene.MeshInstance(this.node,b,this.material);this.meshInstance.updateKey();this._initializeTextures();this.addTime(0);
this.preWarm&&this.prewarm(this.lifetime);this.resetTime()},calcSpawnPosition:function(a,b){J.data[0]=this.particleNoize[b]-0.5;J.data[1]=10*this.particleNoize[b]%1-0.5;J.data[2]=100*this.particleNoize[b]%1-0.5;F.copy(a).add(D.transformPoint(J));this.particleTex[4*b]=F.data[0];this.particleTex[4*b+1]=F.data[1];this.particleTex[4*b+2]=F.data[2];this.particleTex[4*b+3]=pc.math.lerp(this.startAngle*pc.math.DEG_TO_RAD,this.startAngle2*pc.math.DEG_TO_RAD,this.particleNoize[b])},rebuildGraphs:function(){var a=
this.precision,b=this.graphicsDevice,d;this.qLocalVelocity=this.localVelocityGraph.quantize(a);this.qVelocity=this.velocityGraph.quantize(a);this.qColor=this.colorGraph.quantize(a);this.qRotSpeed=this.rotationSpeedGraph.quantize(a);this.qScale=this.scaleGraph.quantize(a);this.qAlpha=this.alphaGraph.quantize(a);this.qLocalVelocity2=this.localVelocityGraph2.quantize(a);this.qVelocity2=this.velocityGraph2.quantize(a);this.qColor2=this.colorGraph2.quantize(a);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(a);
this.qScale2=this.scaleGraph2.quantize(a);this.qAlpha2=this.alphaGraph2.quantize(a);for(d=0;d<a;d++)this.qRotSpeed[d]*=pc.math.DEG_TO_RAD,this.qRotSpeed2[d]*=pc.math.DEG_TO_RAD;this.localVelocityUMax=new pc.Vec3(0,0,0);this.velocityUMax=new pc.Vec3(0,0,0);this.colorUMax=new pc.Vec3(0,0,0);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.qLocalVelocityDiv=e(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax.data);this.qVelocityDiv=e(this.qVelocity,this.qVelocity2,this.velocityUMax.data);
this.qColorDiv=e(this.qColor,this.qColor2,this.colorUMax.data);this.qRotSpeedDiv=e(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=e(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=e(this.qAlpha,this.qAlpha2,this.alphaUMax);if(this.mode===pc.scene.PARTICLES_MODE_GPU){this.internalTex0=h(b,a,1,c(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=h(b,a,1,c(this.qVelocity,this.qVelocityDiv));d=this.qRotSpeed;for(var f=this.qScale,g=this.qScaleDiv,l=this.qRotSpeedDiv,
k=this.qAlphaDiv,m=Array(4*d.length),n=0;n<d.length;n++)m[4*n]=d[n],m[4*n+1]=f[n],m[4*n+2]=0,m[4*n+3]=(255*g[n]<<16|255*l[n]<<8|255*k[n])/16777216;this.internalTex2=h(b,a,1,m)}d=this.qColor;f=this.qAlpha;g=Array(4*f.length);for(l=0;l<f.length;l++)g[4*l]=d[3*l],g[4*l+1]=d[3*l+1],g[4*l+2]=d[3*l+2],g[4*l+3]=f[l];this.internalTex3=h(b,a,1,g,pc.gfx.PIXELFORMAT_R8_G8_B8_A8,1)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&
this.material.setParameter("normalMap",this.normalMap))},_hasDepthTarget:function(){return this.camera?!!this.camera.camera._depthTarget:!1},resetMaterial:function(){var a=this.material,b=this.graphicsDevice;a.setParameter("stretch",this.stretch);a.setParameter("colorMult",this.intensity);this.mode===pc.scene.PARTICLES_MODE_GPU&&(a.setParameter("internalTex0",this.internalTex0),a.setParameter("internalTex1",this.internalTex1),a.setParameter("internalTex2",this.internalTex2));a.setParameter("internalTex3",
this.internalTex3);a.setParameter("numParticles",this.numParticles);a.setParameter("numParticlesPot",this.numParticlesPot);a.setParameter("lifetime",this.lifetime);a.setParameter("rate",this.rate);a.setParameter("rateDiv",this.rate2-this.rate);a.setParameter("seed",this.seed);a.setParameter("scaleDivMult",this.scaleUMax[0]);a.setParameter("alphaDivMult",this.alphaUMax[0]);a.setParameter("oneShotStartTime",this.oneShotStartTime);a.setParameter("oneShotEndTime",this.oneShotEndTime);a.setParameter("graphNumSamples",
this.precision);a.setParameter("graphSampleSize",1/this.precision);a.setParameter("emitterScale",pc.Vec3.ONE.data);this.wrap&&this.wrapBounds&&a.setParameter("wrapBounds",this.wrapBounds.data);this.colorMap&&a.setParameter("colorMap",this.colorMap);this.lighting&&this.normalMap&&a.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&this._hasDepthTarget()&&(a.setParameter("uDepthMap",this.camera.camera._depthTarget.colorBuffer),a.setParameter("screenSize",(new pc.Vec4(b.width,b.height,
1/b.width,1/b.height)).data),a.setParameter("softening",this.depthSoftening));0<this.stretch&&(a.cull=pc.gfx.CULLFACE_NONE)},_allocate:function(a){var b=a*this.numParticleVerts,c=a*this.numParticleIndices,e;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){e=this.mode===pc.scene.PARTICLES_MODE_GPU?[{semantic:pc.gfx.SEMANTIC_ATTR0,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32}]:[{semantic:pc.gfx.SEMANTIC_ATTR0,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR1,
components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR2,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32}];e=new pc.gfx.VertexFormat(this.graphicsDevice,e);this.vertexBuffer=new pc.gfx.VertexBuffer(this.graphicsDevice,e,b,pc.gfx.BUFFER_DYNAMIC);this.indexBuffer=new pc.gfx.IndexBuffer(this.graphicsDevice,pc.gfx.INDEXFORMAT_UINT16,c);e=new Float32Array(this.vertexBuffer.lock());var d,g;this.mesh&&(d=new Float32Array(this.mesh.vertexBuffer.lock()),g=d.length/this.mesh.vertexBuffer.numVertices);
for(var h,c=0;c<b;c++){id=Math.floor(c/this.numParticleVerts);0===c%this.numParticleVerts&&(h=this.particleNoize[id]);if(this.mesh){var l=c%this.numParticleVerts;e[4*c]=d[l*g];e[4*c+1]=d[l*g+1];e[4*c+2]=d[l*g+2]}else l=c%4,e[4*c]=f[l][0],e[4*c+1]=f[l][1],e[4*c+2]=0;e[4*c+3]=id+h}this.mode===pc.scene.PARTICLES_MODE_CPU&&(this.vbCPU=new Float32Array(e));this.vertexBuffer.unlock();this.mesh&&this.mesh.vertexBuffer.unlock();b=0;indices=new Uint16Array(this.indexBuffer.lock());this.mesh&&(d=new Uint16Array(this.mesh.indexBuffer[0].lock()));
for(c=0;c<a;c++)if(this.mesh)for(g=0;g<this.numParticleIndices;g++)indices[c*this.numParticleIndices+g]=d[g]+c*this.numParticleVerts;else g=4*c,indices[b++]=g,indices[b++]=g+1,indices[b++]=g+2,indices[b++]=g,indices[b++]=g+2,indices[b++]=g+3;this.indexBuffer.unlock();this.mesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.mode===pc.scene.PARTICLES_MODE_CPU)for(var a=0;a<this.particleTexStart.length;a++)this.particleTex[a]=
this.particleTexStart[a];else this._initializeTextures(),this.swapTex=!1,a=this.particleTexIN,this.particleTexIN=this.particleTexStart,this.particleTexIN=a;this.totalTime=this.totalTimePrev=this.oneShotStartTime=this.oneShotEndTime=0;this.resetTime();this.addTime(0);this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(a){for(var b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision),a=a/b,c=0;c<b;c++)this.addTime(a)},resetTime:function(){var a=Math.max(this.rate,this.rate2)*
this.numParticles+this.lifetime;this.endTime=Date.now()+1E3*a},addTime:function(b){var c,e,f=this.graphicsDevice;this.totalTimePrev=this.totalTime;this.totalTime+=b;this.oneShot||(this.oneShotStartTime=this.totalTime);f.setBlending(!1);f.setColorWrite(!0,!0,!0,!0);f.setCullMode(pc.gfx.CULLFACE_NONE);f.setDepthTest(!1);f.setDepthWrite(!1);if(this.lighting){if(!this.scene){console.error("There is no scene defined for lighting particles");return}for(c=0;6>c;c++)this.lightCube[3*c]=this.scene.ambientLight.r,
this.lightCube[3*c+1]=this.scene.ambientLight.g,this.lightCube[3*c+2]=this.scene.ambientLight.b;e=this.scene._globalLights;for(c=0;c<e.length;c++)for(var h=0;6>h;h++){var l=Math.max(this.lightCubeDir[h].dot(e[c]._direction),0)*e[c]._intensity;this.lightCube[3*h]+=e[c]._color.r*l;this.lightCube[3*h+1]+=e[c]._color.g*l;this.lightCube[3*h+2]+=e[c]._color.b*l}this.constantLightCube.setValue(this.lightCube)}null===this.meshInstance.node?D.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):D.setTRS(pc.Vec3.ZERO,
this.meshInstance.node.getRotation(),L.copy(this.spawnBounds).mul(this.meshInstance.node.getLocalScale()));c=null===this.meshInstance.node?pc.Vec3.ONE.data:this.meshInstance.node.getLocalScale().data;this.material.setParameter("emitterScale",c);if(this.mode===pc.scene.PARTICLES_MODE_GPU)this.frameRandom.x=Math.random(),this.frameRandom.y=Math.random(),this.frameRandom.z=Math.random(),this.constantGraphSampleSize.setValue(1/this.precision),this.constantGraphNumSamples.setValue(this.precision),this.constantNumParticles.setValue(this.numParticles),
this.constantNumParticlesPot.setValue(this.numParticlesPot),this.constantInternalTex0.setValue(this.internalTex0),this.constantInternalTex1.setValue(this.internalTex1),this.constantInternalTex2.setValue(this.internalTex2),e=null===this.meshInstance.node?pc.Vec3.ZERO.data:this.meshInstance.node.getPosition().data,h=null===this.meshInstance.node?pc.Mat4.IDENTITY:this.meshInstance.node.getWorldTransform(),g(D,I),g(h,y),this.constantEmitterPos.setValue(e),this.constantSpawnBounds.setValue(I.data),this.constantFrameRandom.setValue(this.frameRandom.data),
this.constantDelta.setValue(b),this.constantTotalTime.setValue(this.totalTime),this.constantTotalTimePrev.setValue(this.totalTimePrev),this.constantOneShotStartTime.setValue(this.oneShotStartTime),this.constantOneShotEndTime.setValue(this.oneShotEndTime),this.constantRate.setValue(this.rate),this.constantRateDiv.setValue(this.rate2-this.rate),this.constantStartAngle.setValue(this.startAngle*pc.math.DEG_TO_RAD),this.constantStartAngle2.setValue(this.startAngle2*pc.math.DEG_TO_RAD),this.constantSeed.setValue(this.seed),
this.constantLifetime.setValue(this.lifetime),this.constantEmitterScale.setValue(c),this.constantEmitterMatrix.setValue(y.data),this.constantLocalVelocityDivMult.setValue(this.localVelocityUMax.data),this.constantVelocityDivMult.setValue(this.velocityUMax.data),this.constantRotSpeedDivMult.setValue(this.rotSpeedUMax[0]),b=this.swapTex?this.particleTexOUT:this.particleTexIN,c=this.swapTex?this.particleTexIN:this.particleTexOUT,this.constantParticleTexIN.setValue(b),pc.gfx.drawQuadWithShader(f,this.swapTex?
this.rtParticleTexIN:this.rtParticleTexOUT,this.oneShot?this.shaderParticleUpdateNoRespawn:this.shaderParticleUpdateRespawn),this.constantParticleTexOUT.setValue(c),this.material.setParameter("totalTime",this.totalTime),this.material.setParameter("totalTimePrev",this.totalTimePrev),this.material.setParameter("oneShotStartTime",this.oneShotStartTime),this.material.setParameter("oneShotEndTime",this.oneShotEndTime),this.material.setParameter("particleTexOUT",c),this.material.setParameter("particleTexIN",
b),this.swapTex=!this.swapTex;else{h=new Float32Array(this.vertexBuffer.lock());if(this.meshInstance.node){c=this.meshInstance.node.worldTransform;for(e=0;12>e;e++)E.data[e]=c.data[e];K=this.meshInstance.node.getLocalScale();B=Math.max(Math.max(K.x,K.y),K.z)}e=null===this.meshInstance.node?pc.Vec3.ZERO:this.meshInstance.node.getPosition();l=this.camera?this.camera.position:pc.Vec3.ZERO;for(c=0;c<this.numParticles;c++){var k=Math.floor(this.vbCPU[4*c*this.numParticleVerts+3]),m=(this.particleNoize[k]+
this.seed)%1;u.x=m;u.y=10*m%1;u.z=100*m%1;var n=pc.math.lerp(this.rate,this.rate2,m),r=this.lifetime,F=-n*k,Q=Math.max(this.totalTime+F+n,0),J=Q%(r+n)-n,M=d(J/r),P=Math.max(this.totalTimePrev+F+n,0),P=Math.floor(Q/(r+n))!=Math.floor(P/(r+n)),S=0,T=0;if(0<J){s.data=a(this.qLocalVelocity,M,3,s.data);x.data=a(this.qLocalVelocity2,M,3,x.data);w.data=a(this.qVelocity,M,3,w.data);G.data=a(this.qVelocity2,M,3,G.data);var U=a(this.qRotSpeed,M),T=a(this.qRotSpeed2,M),S=a(this.qScale,M),W=a(this.qScale2,M),
X=a(this.qAlpha,M),Y=a(this.qAlpha2,M);s.x=pc.math.lerp(s.x,x.x,u.x);s.y=pc.math.lerp(s.y,x.y,u.y);s.z=pc.math.lerp(s.z,x.z,u.z);w.x=pc.math.lerp(w.x,G.x,u.x);w.y=pc.math.lerp(w.y,G.y,u.y);w.z=pc.math.lerp(w.z,G.z,u.z);U=pc.math.lerp(U,T,u.y);S=pc.math.lerp(S,W,1E4*m%1)*B;T=(Y-X)*(1E3*m%1);this.meshInstance.node&&E.transformPoint(s,s);s.add(w.mul(K));v.x=this.particleTex[4*k];v.y=this.particleTex[4*k+1];v.z=this.particleTex[4*k+2];z.copy(v).add(s.scale(b));C.copy(z);A.x=A.y=A.z=0;this.wrap&&this.wrapBounds&&
(C.sub(l),C.x=C.x-this.wrapBounds.x*Math.floor(C.x/this.wrapBounds.x)-0.5*this.wrapBounds.x,C.y=C.y-this.wrapBounds.y*Math.floor(C.y/this.wrapBounds.y)-0.5*this.wrapBounds.y,C.z=C.z-this.wrapBounds.z*Math.floor(C.z/this.wrapBounds.z)-0.5*this.wrapBounds.z,C.add(l),A.copy(C).sub(z));0<this.stretch&&!P&&(H.copy(z).sub(v).scale(this.stretch),v.sub(H).add(A));this.particleTex[4*k]=C.x;this.particleTex[4*k+1]=C.y;this.particleTex[4*k+2]=C.z;this.particleTex[4*k+3]+=U*b;0<this.sort&&(1===this.sort?(L.copy(C).sub(l),
this.particleDistance[k]=-(L.x*L.x+L.y*L.y+L.z*L.z)):2===this.sort?this.particleDistance[k]=J:3===this.sort&&(this.particleDistance[k]=-J))}m=Math.max(this.oneShotStartTime+F+n,0);n=Math.floor(Q/(r+n))!=Math.floor(m/(r+n));(J=!(P||n||0>=J))||this.calcSpawnPosition(e,k);for(n=0;n<this.numParticleVerts;n++)r=this.vbCPU[4*c*this.numParticleVerts+4*n],Q=this.vbCPU[4*c*this.numParticleVerts+4*n+1],m=this.vbCPU[4*c*this.numParticleVerts+4*n+2],J?0<this.stretch&&!P&&C.lerp(C,v,0.5*Q+0.5):r=Q=m=0,F=12*c*
this.numParticleVerts+12*n,h[F]=C.x,h[F+1]=C.y,h[F+2]=C.z,h[F+3]=M,h[F+4]=this.particleTex[4*k+3],h[F+5]=S,h[F+6]=T,h[F+8]=r,h[F+9]=Q,h[F+10]=m}if(this.sort>pc.scene.PARTICLES_SORT_NONE&&this.camera){for(c=0;c<this.numParticles;c++)this.vbToSort[c]=[c,Math.floor(this.vbCPU[4*c*this.numParticleVerts+3])];for(c=0;c<4*this.numParticles*this.numParticleVerts;c++)this.vbOld[c]=this.vbCPU[c];var V=this.particleDistance;this.vbToSort.sort(function(a,b){return V[a[1]]-V[b[1]]});for(c=0;c<this.numParticles;c++){b=
this.vbToSort[c][0];for(h=0;h<this.numParticleVerts;h++)for(e=0;4>e;e++)this.vbCPU[4*c*this.numParticleVerts+4*h+e]=this.vbOld[4*b*this.numParticleVerts+4*h+e]}}this.vertexBuffer.unlock()}if(this.oneShot&&this.onFinished&&Date.now()>this.endTime)this.onFinished();f.setDepthTest(!0);f.setDepthWrite(!0)}};return{ParticleEmitter2:Q,PARTICLES_SORT_NONE:0,PARTICLES_SORT_DISTANCE:1,PARTICLES_SORT_NEWER_FIRST:2,PARTICLES_SORT_OLDER_FIRST:3,PARTICLES_MODE_GPU:0,PARTICLES_MODE_CPU:1}}());pc.extend(pc.scene,function(){var d=function(a,b,c){this.device=a;a=a.getProgramLibrary();this.pickProgStatic=a.getProgram("pick",{skin:!1});this.pickProgSkin=a.getProgram("pick",{skin:!0});this.pickColor=new Float32Array(4);this.scene=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:pc.gfx.CLEARFLAG_COLOR|pc.gfx.CLEARFLAG_DEPTH};this.resize(b,c)};d.prototype.getSelection=function(a){a.width=a.width||1;a.height=a.height||1;this._pickBufferTarget.bind();var b=new ArrayBuffer(4*a.width*a.height),
c=new Uint8Array(b),e=this.device.gl;e.readPixels(a.x,a.y,a.width,a.height,e.RGBA,e.UNSIGNED_BYTE,c);c=[];for(e=0;e<a.width*a.height;e++){var d=new Uint8Array(b,4*e,4),d=d[0]<<16|d[1]<<8|d[2];16777215!==d&&(d=this.scene.drawCalls[d],-1===c.indexOf(d)&&c.push(d))}return c};d.prototype.prepare=function(a,b){this.scene=b;var c=this.device,e=c.getRenderTarget();c.setRenderTarget(this._pickBufferTarget);c.updateBegin();c.setViewport(0,0,this._pickBufferTarget.width,this._pickBufferTarget.height);c.setScissor(0,
0,this._pickBufferTarget.width,this._pickBufferTarget.height);c.clear(this.clearOptions);var d,f,h,l,k=b.drawCalls,n=k.length,c=this.device;f=c.scope;var m=f.resolve("matrix_model"),r=f.resolve("texture_poseMap"),w=f.resolve("texture_poseMapSize"),s=f.resolve("matrix_pose[0]"),G=f.resolve("uColor");d=f.resolve("matrix_projection");f=f.resolve("matrix_viewProjection");l=a.getWorldTransform();h=a.getProjectionMatrix();l=l.clone().invert();var x=new pc.Mat4;x.mul2(h,l);d.setValue(h.data);f.setValue(x.data);
for(d=0;d<n;d++)if(!k[d].command&&(h=k[d],f=h.mesh,l=f.primitive[pc.scene.RENDERSTYLE_SOLID].type,l===pc.gfx.PRIMITIVE_TRIANGLES||l===pc.gfx.PRIMITIVE_TRISTRIP||l===pc.gfx.PRIMITIVE_TRIFAN))m.setValue(h.node.worldTransform.data),h.skinInstance&&(c.supportsBoneTextures?(r.setValue(h.skinInstance.boneTexture),w.setValue([h.skinInstance.boneTexture.width,h.skinInstance.boneTexture.height])):s.setValue(h.skinInstance.matrixPalette)),this.pickColor[0]=(d>>16&255)/255,this.pickColor[1]=(d>>8&255)/255,this.pickColor[2]=
(d&255)/255,this.pickColor[3]=1,G.setValue(this.pickColor),c.setShader(f.skin?this.pickProgSkin:this.pickProgStatic),c.setVertexBuffer(f.vertexBuffer,0),c.setIndexBuffer(f.indexBuffer[pc.scene.RENDERSTYLE_SOLID]),c.draw(f.primitive[pc.scene.RENDERSTYLE_SOLID]);c.setViewport(0,0,c.width,c.height);c.setScissor(0,0,c.width,c.height);c.updateEnd();c.setRenderTarget(e)};d.prototype.resize=function(a,b){var c=new pc.gfx.Texture(this.device,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,width:a,height:b,autoMipmap:!1});
c.minFilter=pc.gfx.FILTER_NEAREST;c.magFilter=pc.gfx.FILTER_NEAREST;c.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;this._pickBufferTarget=new pc.gfx.RenderTarget(this.device,c,{depth:!0})};Object.defineProperty(d.prototype,"renderTarget",{get:function(){return this._pickBufferTarget}});Object.defineProperty(d.prototype,"width",{get:function(){return this._pickBufferTarget.width}});Object.defineProperty(d.prototype,"height",{get:function(){return this._pickBufferTarget.height}});
return{Picker:d}}());pc.scene.procedural={};
pc.scene.procedural.calculateTangents=function(d,a,b,c){var e=c.length/3,g=d.length/3,f,h,l,k,n,m,r,w,s,G,x,u,v,z,A=new pc.Vec3,C=new pc.Vec3,H=new pc.Vec3,E=new pc.Vec3,I=new pc.Vec3,y=new pc.Vec2,B=new pc.Vec2,K=new pc.Vec2,D,J=new Float32Array(3*g),F=new Float32Array(3*g),L=[];for(D=0;D<e;D++)f=c[3*D],h=c[3*D+1],l=c[3*D+2],H.set(d[3*f],d[3*f+1],d[3*f+2]),E.set(d[3*h],d[3*h+1],d[3*h+2]),I.set(d[3*l],d[3*l+1],d[3*l+2]),y.set(b[2*f],b[2*f+1]),B.set(b[2*h],b[2*h+1]),K.set(b[2*l],b[2*l+1]),k=E.x-H.x,
n=I.x-H.x,m=E.y-H.y,r=I.y-H.y,w=E.z-H.z,s=I.z-H.z,G=B.x-y.x,x=K.x-y.x,u=B.y-y.y,v=K.y-y.y,z=1/(G*v-x*u),A.set((v*k-u*n)*z,(v*m-u*r)*z,(v*w-u*s)*z),C.set((G*n-x*k)*z,(G*r-x*m)*z,(G*s-x*w)*z),J[3*f+0]+=A.x,J[3*f+1]+=A.y,J[3*f+2]+=A.z,J[3*h+0]+=A.x,J[3*h+1]+=A.y,J[3*h+2]+=A.z,J[3*l+0]+=A.x,J[3*l+1]+=A.y,J[3*l+2]+=A.z,F[3*f+0]+=C.x,F[3*f+1]+=C.y,F[3*f+2]+=C.z,F[3*h+0]+=C.x,F[3*h+1]+=C.y,F[3*h+2]+=C.z,F[3*l+0]+=C.x,F[3*l+1]+=C.y,F[3*l+2]+=C.z;u=new pc.Vec3;v=new pc.Vec3;d=new pc.Vec3;b=new pc.Vec3;for(D=
0;D<g;D++)d.set(a[3*D],a[3*D+1],a[3*D+2]),u.set(J[3*D],J[3*D+1],J[3*D+2]),v.set(F[3*D],F[3*D+1],F[3*D+2]),c=d.dot(u),b.copy(d).scale(c),b.sub2(u,b).normalize(),L[4*D]=b.x,L[4*D+1]=b.y,L[4*D+2]=b.z,b.cross(d,u),L[4*D+3]=0>b.dot(v)?-1:1;return L};
pc.scene.procedural.createMesh=function(d,a,b){var c=b&&void 0!==b.normals?b.normals:null,e=b&&void 0!==b.tangents?b.tangents:null,g=b&&void 0!==b.uvs?b.uvs:null,b=b&&void 0!==b.indices?b.indices:null,f=[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}];null!==c&&f.push({semantic:pc.gfx.SEMANTIC_NORMAL,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32});null!==e&&f.push({semantic:pc.gfx.SEMANTIC_TANGENT,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32});null!==g&&f.push({semantic:pc.gfx.SEMANTIC_TEXCOORD0,
components:2,type:pc.gfx.ELEMENTTYPE_FLOAT32});for(var h=new pc.gfx.VertexFormat(d,f),f=a.length/3,h=new pc.gfx.VertexBuffer(d,h,f),l=new pc.gfx.VertexIterator(h),k=0;k<f;k++)l.element[pc.gfx.SEMANTIC_POSITION].set(a[3*k],a[3*k+1],a[3*k+2]),null!==c&&l.element[pc.gfx.SEMANTIC_NORMAL].set(c[3*k],c[3*k+1],c[3*k+2]),null!==e&&l.element[pc.gfx.SEMANTIC_TANGENT].set(e[4*k],e[4*k+1],e[4*k+2],e[4*k+3]),null!==g&&l.element[pc.gfx.SEMANTIC_TEXCOORD0].set(g[2*k],g[2*k+1]),l.next();l.end();c=null;if(e=null!==
b)c=new pc.gfx.IndexBuffer(d,pc.gfx.INDEXFORMAT_UINT16,b.length),(new Uint16Array(c.lock())).set(b),c.unlock();d=new pc.shape.Aabb;d.compute(a);a=new pc.scene.Mesh;a.vertexBuffer=h;a.indexBuffer[0]=c;a.primitive[0].type=pc.gfx.PRIMITIVE_TRIANGLES;a.primitive[0].base=0;a.primitive[0].count=e?b.length:f;a.primitive[0].indexed=e;a.aabb=d;return a};
pc.scene.procedural.createTorus=function(d,a){var b=a&&void 0!==a.tubeRadius?a.tubeRadius:0.2,c=a&&void 0!==a.ringRadius?a.ringRadius:0.3,e=a&&void 0!==a.segments?a.segments:30,g=a&&void 0!==a.sides?a.sides:20,f,h,l,k,n,m,r,w,s,G,x=[],u=[],v=[],z=[];for(f=0;f<=g;f++)for(h=0;h<=e;h++)l=Math.cos(2*Math.PI*h/e)*(c+b*Math.cos(2*Math.PI*f/g)),k=Math.sin(2*Math.PI*f/g)*b,n=Math.sin(2*Math.PI*h/e)*(c+b*Math.cos(2*Math.PI*f/g)),m=Math.cos(2*Math.PI*h/e)*Math.cos(2*Math.PI*f/g),r=Math.sin(2*Math.PI*f/g),w=
Math.sin(2*Math.PI*h/e)*Math.cos(2*Math.PI*f/g),s=f/g,G=1-h/e,x.push(l,k,n),u.push(m,r,w),v.push(s,G),f<g&&h<e&&(l=f*(e+1)+h,k=(f+1)*(e+1)+h,n=f*(e+1)+(h+1),m=(f+1)*(e+1)+(h+1),z.push(l,k,n),z.push(k,m,n));b={normals:u,uvs:v,indices:z};pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(x,u,v,z));return pc.scene.procedural.createMesh(d,x,b)};
pc.scene.procedural._createConeData=function(d,a,b,c,e,g){var f,h,l,k,n,m=new pc.Vec3;l=new pc.Vec3;k=new pc.Vec3;var r,w,s=[],G=[],x=[],u=[],v;if(0<b)for(f=0;f<=c;f++)for(h=0;h<=e;h++)theta=2*(h/e)*Math.PI-Math.PI,v=Math.sin(theta),w=Math.cos(theta),r=new pc.Vec3(v*d,-b/2,w*d),n=new pc.Vec3(v*a,b/2,w*a),m.lerp(r,n,f/c),l.sub2(n,r).normalize(),w=new pc.Vec3(w,0,-v),k.cross(w,l).normalize(),s.push(m.x,m.y,m.z),G.push(k.x,k.y,k.z),x.push(h/e,f/c),f<c&&h<e&&(w=f*(e+1)+h,v=f*(e+1)+(h+1),n=(f+1)*(e+1)+
h,r=(f+1)*(e+1)+(h+1),u.push(w,v,n),u.push(v,r,n));if(g){d=Math.floor(e/2);m=b/2;for(b=0;b<=d;b++){theta=0.5*b*Math.PI/d;v=Math.sin(theta);w=Math.cos(theta);for(f=0;f<=e;f++)phi=2*f*Math.PI/e-Math.PI/2,l=Math.sin(phi),g=Math.cos(phi),g*=v,h=w,l*=v,k=1-f/e,n=1-b/d,s.push(g*a,h*a+m,l*a),G.push(g,h,l),x.push(k,n)}r=(c+1)*(e+1);for(b=0;b<d;++b)for(f=0;f<e;++f)w=b*(e+1)+f,v=w+e+1,u.push(r+w+1,r+v,r+w),u.push(r+w+1,r+v+1,r+v);for(b=0;b<=d;b++){theta=0.5*Math.PI+0.5*b*Math.PI/d;v=Math.sin(theta);w=Math.cos(theta);
for(f=0;f<=e;f++)phi=2*f*Math.PI/e-Math.PI/2,l=Math.sin(phi),g=Math.cos(phi),g*=v,h=w,l*=v,k=1-f/e,n=1-b/d,s.push(g*a,h*a-m,l*a),G.push(g,h,l),x.push(k,n)}r=(c+1)*(e+1)+(e+1)*(d+1);for(b=0;b<d;++b)for(f=0;f<e;++f)w=b*(e+1)+f,v=w+e+1,u.push(r+w+1,r+v,r+w),u.push(r+w+1,r+v+1,r+v)}else{r=(c+1)*(e+1);if(0<d)for(f=0;f<e;f++)theta=2*(f/e)*Math.PI,g=Math.sin(theta),h=-b/2,l=Math.cos(theta),k=1-(g+1)/2,n=(l+1)/2,s.push(g*d,h,l*d),G.push(0,-1,0),x.push(k,n),1<f&&u.push(r,r+f,r+f-1);r+=e;if(0<a)for(f=0;f<e;f++)theta=
2*(f/e)*Math.PI,g=Math.sin(theta),h=b/2,l=Math.cos(theta),k=1-(g+1)/2,n=(l+1)/2,s.push(g*a,h,l*a),G.push(0,1,0),x.push(k,n),1<f&&u.push(r,r+f-1,r+f)}return{positions:s,normals:G,uvs:x,indices:u}};
pc.scene.procedural.createCylinder=function(d,a){var b=a&&void 0!==a.baseRadius?a.baseRadius:0.5,b=pc.scene.procedural._createConeData(b,b,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:20,!1);pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createCapsule=function(d,a){var b=a&&void 0!==a.radius?a.radius:0.3,b=pc.scene.procedural._createConeData(b,b,(a&&void 0!==a.height?a.height:1)-2*b,a&&void 0!==a.heightSegments?a.heightSegments:1,a&&void 0!==a.sides?a.sides:20,!0);pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createCone=function(d,a){var b=pc.scene.procedural._createConeData(a&&void 0!==a.baseRadius?a.baseRadius:0.5,a&&void 0!==a.peakRadius?a.peakRadius:0,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:18,!1);pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createSphere=function(d,a){var b=a&&void 0!==a.radius?a.radius:0.5,c=a&&void 0!==a.latitudeBands?a.latitudeBands:16,e=a&&void 0!==a.longitudeBands?a.longitudeBands:16,g,f,h,l,k,n,m,r,w,s=[],G=[],x=[],u=[];for(f=0;f<=c;f++){g=f*Math.PI/c;h=Math.sin(g);l=Math.cos(g);for(g=0;g<=e;g++)k=2*g*Math.PI/e-Math.PI/2,n=Math.sin(k),k=Math.cos(k),k*=h,m=l,n*=h,r=1-g/e,w=1-f/c,s.push(k*b,m*b,n*b),G.push(k,m,n),x.push(r,w)}for(f=0;f<c;++f)for(g=0;g<e;++g)b=f*(e+1)+g,h=b+e+1,u.push(b+1,h,b),u.push(b+
1,h+1,h);c={normals:G,uvs:x,indices:u};pc.gfx.precalculatedTangents&&(c.tangents=pc.scene.procedural.calculateTangents(s,G,x,u));return pc.scene.procedural.createMesh(d,s,c)};
pc.scene.procedural.createPlane=function(d,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec2(0.5,0.5),c=a&&void 0!==a.widthSegments?a.widthSegments:5,e=a&&void 0!==a.lengthSegments?a.lengthSegments:5,g,f,h,l,k,n,m=[],r=[],w=[],s=[];for(g=0;g<=c;g++)for(f=0;f<=e;f++)h=-b.x+2*b.x*g/c,l=-(-b.y+2*b.y*f/e),k=g/c,n=f/e,m.push(h,0,l),r.push(0,1,0),w.push(k,n),g<c&&f<e&&(s.push(f+g*(c+1),f+(g+1)*(c+1),f+g*(c+1)+1),s.push(f+(g+1)*(c+1),f+(g+1)*(c+1)+1,f+g*(c+1)+1));b={normals:r,uvs:w,indices:s};
pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(m,r,w,s));return pc.scene.procedural.createMesh(d,m,b)};
pc.scene.procedural.createBox=function(d,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec3(0.5,0.5,0.5),c=a&&void 0!==a.widthSegments?a.widthSegments:1,e=a&&void 0!==a.lengthSegments?a.lengthSegments:1,g=a&&void 0!==a.heightSegments?a.heightSegments:1,f=[new pc.Vec3(-b.x,-b.y,b.z),new pc.Vec3(b.x,-b.y,b.z),new pc.Vec3(b.x,b.y,b.z),new pc.Vec3(-b.x,b.y,b.z),new pc.Vec3(b.x,-b.y,-b.z),new pc.Vec3(-b.x,-b.y,-b.z),new pc.Vec3(-b.x,b.y,-b.z),new pc.Vec3(b.x,b.y,-b.z)],h=[[0,1,3],[4,5,7],[3,
2,6],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],k=[],n=[],m=[],r=[],b=function(a,b,c){var e,d,g,z,A=k.length/3;for(g=0;g<=b;g++)for(z=0;z<=c;z++){e=new pc.Vec3;d=new pc.Vec3;var C=new pc.Vec3,H=new pc.Vec3;e.lerp(f[h[a][0]],f[h[a][1]],g/b);d.lerp(f[h[a][0]],f[h[a][2]],z/c);C.sub2(d,f[h[a][0]]);H.add2(e,C);e=g/b;d=z/c;k.push(H.x,H.y,H.z);n.push(l[a][0],l[a][1],l[a][2]);m.push(e,d);g<b&&z<c&&(r.push(A+z+g*(b+1),A+z+(g+1)*(b+1),A+z+g*(b+1)+1),r.push(A+z+(g+1)*(b+
1),A+z+(g+1)*(b+1)+1,A+z+g*(b+1)+1))}};b(0,c,g);b(1,c,g);b(2,c,e);b(3,c,e);b(4,e,g);b(5,e,g);c={normals:n,uvs:m,indices:r};pc.gfx.precalculatedTangents&&(c.tangents=pc.scene.procedural.calculateTangents(k,n,m,r));return pc.scene.procedural.createMesh(d,k,c)};pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a){return new pc.promise.Promise(function(c,e){pc.net.http.get(a.canonical,function(a){c(a)},{error:function(){e()}})})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="json";a.prototype.Type=Object;return{JsonResourceHandler:d,JsonRequest:a}}());pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a){return new RSVP.Promise(function(c,e){pc.net.http.get(a.canonical,function(a){c(a)},{error:function(){e()}})})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="text";a.prototype.Type=Object;return{TextResourceHandler:d,TextRequest:a}}());pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a){return new pc.promise.Promise(function(c,e){var d=new Image;d.onload=function(){c(d)};d.onerror=function(a){e(pc.string.format("Error loading Image from: '{0}'",a.srcElement.src))};d.src=a.canonical})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="image";a.prototype.Type=Image;return{ImageResourceHandler:d,
ImageRequest:a}}());pc.extend(pc.resources,function(){var d=function(a){this._device=a;this.crossOrigin=void 0},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a,c){var e=a.canonical,d=this;return new pc.promise.Promise(function(a,b){var l=pc.path.getExtension(e).toLowerCase();if(".dds"===l||".crn"===l)c=c||{},c.binary=!0,c.directory=pc.path.getDirectory(e),c.crn=".crn"===l,pc.net.http.get(e,function(b){a(b)},{cache:!1});else if(".jpg"===l||".jpeg"===l||".gif"===l||".png"===l){var k=new Image;
void 0!==d.crossOrigin&&(k.crossOrigin=d.crossOrigin);k.onload=function(){a(k)};k.onerror=function(a){b(pc.string.format("Error loading Texture from: '{0}'",a.srcElement.src))};k.src=e}})};d.prototype.open=function(a,c,e){var d;if(a instanceof Image||a instanceof HTMLImageElement)d=c.result?c.result:new pc.gfx.Texture(this._device,{width:a.width,height:a.height,format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8}),d.setSource(a);else if(a instanceof ArrayBuffer){if(e.crn){c=a.byteLength;d=new Uint8Array(a);a=Module._malloc(c);
e=Module.HEAPU8;dst32Offset=a/4;for(var f=c%4,h=new Uint32Array(d.buffer,0,(c-f)/4),l=new Uint32Array(e.buffer),k=0;k<h.length;k++)l[dst32Offset+k]=h[k];for(k=c-f;k<c;k++)e[a+k]=d[k];d=Module._crn_decompress_get_data(a,c);c=Module._crn_decompress_get_size(a,c);a=Module.HEAPU8.buffer.slice(d,d+c)}d=loadDDS(a)}return d};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="texture";a.prototype.Type=pc.gfx.Texture;return{TextureResourceHandler:d,TextureRequest:a}}());pc.extend(pc.resources,function(){var d={points:pc.gfx.PRIMITIVE_POINTS,lines:pc.gfx.PRIMITIVE_LINES,lineloop:pc.gfx.PRIMITIVE_LINELOOP,linestrip:pc.gfx.PRIMITIVE_LINESTRIP,triangles:pc.gfx.PRIMITIVE_TRIANGLES,trianglestrip:pc.gfx.PRIMITIVE_TRISTRIP,trianglefan:pc.gfx.PRIMITIVE_TRIFAN},a={int8:pc.gfx.ELEMENTTYPE_INT8,uint8:pc.gfx.ELEMENTTYPE_UINT8,int16:pc.gfx.ELEMENTTYPE_INT16,uint16:pc.gfx.ELEMENTTYPE_UINT16,int32:pc.gfx.ELEMENTTYPE_INT32,uint32:pc.gfx.ELEMENTTYPE_UINT32,float32:pc.gfx.ELEMENTTYPE_FLOAT32},
b=function(a,b){this._device=a;this._assets=b},b=pc.inherits(b,pc.resources.ResourceHandler);b.prototype.load=function(a,b){var c=this;if(a.data)for(var d,l=[],k=a.data,n=0;n<k.length;n++)k[n].material&&(d=this._assets.getAssetById(k[n].material))&&l.push(d);return new pc.promise.Promise(function(d,h){var k=a.canonical;b=b||{};b.directory=pc.path.getDirectory(k);pc.net.http.get(k,function(a){l.length?c._assets.load(l).then(function(){d(a)}):d(a)},{cache:b.cache,error:function(a){h(pc.string.format("Error loading model: {0} [{1}]",
k,a))}})})};b.prototype.open=function(a,b,c){c=c||{};c.directory=c.directory||"";c.parent=b;var d=null;1>=a.model.version?logERROR(pc.string.format("Asset: {0}, is an old model format. Upload source assets to re-import.",b.canonical)):2<=a.model.version&&(d=this._loadModelJson(a,b.data,c));return d};b.prototype.clone=function(a){return a.clone()};b.prototype._loadModelJson=function(b,c,f){var h=b.model,l,k,b=[];for(l=0;l<h.nodes.length;l++){var n=h.nodes[l],m=new pc.scene.GraphNode;m.setName(n.name);
m.setLocalPosition(n.position[0],n.position[1],n.position[2]);m.setLocalEulerAngles(n.rotation[0],n.rotation[1],n.rotation[2]);m.setLocalScale(n.scale[0],n.scale[1],n.scale[2]);b.push(m)}for(l=1;l<h.parents.length;l++)b[h.parents[l]].addChild(b[l]);!this._device.supportsBoneTextures&&0<h.skins.length&&(l=this._device.getBoneLimit(),pc.scene.partitionSkin(h,c,l));var r=[],n=[];for(l=0;l<h.skins.length;l++){var w=h.skins[l],m=[];for(k=0;k<w.inverseBindMatrices.length;k++){var s=w.inverseBindMatrices[k];
m[k]=new pc.Mat4(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9],s[10],s[11],s[12],s[13],s[14],s[15])}w=new pc.scene.Skin(this._device,m,w.boneNames);r.push(w);m=new pc.scene.SkinInstance(w);s=[];for(k=0;k<w.boneNames.length;k++){var G=b[0].findByName(w.boneNames[k]);s.push(G)}m.bones=s;n.push(m)}var w=[],x,m={position:pc.gfx.SEMANTIC_POSITION,normal:pc.gfx.SEMANTIC_NORMAL,tangent:pc.gfx.SEMANTIC_TANGENT,blendWeight:pc.gfx.SEMANTIC_BLENDWEIGHT,blendIndices:pc.gfx.SEMANTIC_BLENDINDICES,color:pc.gfx.SEMANTIC_COLOR,
texCoord0:pc.gfx.SEMANTIC_TEXCOORD0,texCoord1:pc.gfx.SEMANTIC_TEXCOORD1,texCoord2:pc.gfx.SEMANTIC_TEXCOORD2,texCoord3:pc.gfx.SEMANTIC_TEXCOORD3,texCoord4:pc.gfx.SEMANTIC_TEXCOORD4,texCoord5:pc.gfx.SEMANTIC_TEXCOORD5,texCoord6:pc.gfx.SEMANTIC_TEXCOORD6,texCoord7:pc.gfx.SEMANTIC_TEXCOORD7};for(l=0;l<h.vertices.length;l++){s=h.vertices[l];if(s.position&&s.normal&&s.texCoord0){G=[];for(k=0;k<h.meshes.length;k++)h.meshes[k].vertices===l&&(G=G.concat(h.meshes[k].indices));tangents=pc.scene.procedural.calculateTangents(s.position.data,
s.normal.data,s.texCoord0.data,G);s.tangent={type:"float32",components:4,data:tangents}}k=[];for(x in s){var G=s[x],u=G.type;this._device.supportsUnsignedByte||("uint8"===u&&(u="float32"),"int8"===u&&(u="float32"));k.push({semantic:m[x],components:G.components,type:a[u],normalize:!1})}k=new pc.gfx.VertexFormat(this._device,k);var u=s.position.data.length/s.position.components,v=new pc.gfx.VertexBuffer(this._device,k,u),z=new pc.gfx.VertexIterator(v);for(k=0;k<u;k++){for(x in s)switch(G=s[x],G.components){case 1:z.element[m[x]].set(G.data[k]);
break;case 2:z.element[m[x]].set(G.data[2*k],G.data[2*k+1]);break;case 3:z.element[m[x]].set(G.data[3*k],G.data[3*k+1],G.data[3*k+2]);break;case 4:z.element[m[x]].set(G.data[4*k],G.data[4*k+1],G.data[4*k+2],G.data[4*k+3])}z.next()}z.end();w.push(v)}for(l=m=0;l<h.meshes.length;l++)s=h.meshes[l],"undefined"!==typeof s.indices&&(m+=s.indices.length);u=G=null;v=0;0<m&&(G=new pc.gfx.IndexBuffer(this._device,pc.gfx.INDEXFORMAT_UINT16,m),u=new Uint16Array(G.lock()));x=[];for(l=0;l<h.meshes.length;l++){s=
h.meshes[l];k=s.aabb.min;var z=s.aabb.max,z=new pc.shape.Aabb(new pc.Vec3(0.5*(z[0]+k[0]),0.5*(z[1]+k[1]),0.5*(z[2]+k[2])),new pc.Vec3(0.5*(z[0]-k[0]),0.5*(z[1]-k[1]),0.5*(z[2]-k[2]))),A="undefined"!==typeof s.indices;k=new pc.scene.Mesh;k.vertexBuffer=w[s.vertices];k.indexBuffer[0]=A?G:null;k.primitive[0].type=d[s.type];k.primitive[0].base=A?s.base+v:s.base;k.primitive[0].count=s.count;k.primitive[0].indexed=A;k.skin="undefined"!==typeof s.skin?r[s.skin]:null;k.aabb=z;A&&(u.set(s.indices,v),v+=s.indices.length);
x.push(k)}0<m&&G.unlock();w=[];s=new pc.scene.PhongMaterial;for(l=0;l<h.meshInstances.length;l++){k=h.meshInstances[l];m=b[k.node];k=x[k.mesh];(G=this._getMaterial(l,c,f))||(G=s);m=new pc.scene.MeshInstance(m,k,G);if(k.skin){k=r.indexOf(k.skin);if(-1===k)throw Error("Mesh's skin does not appear in skin array.");m.skinInstance=n[k]}w.push(m)}c=new pc.scene.Model;c.graph=b[0];c.meshInstances=w;c.skinInstances=n;c.getGraph().syncHierarchy();return c};b.prototype._getMaterial=function(a,b,c){var d;if(b&&
b.length>a)if(b[a].material){if(a=this._assets.getAssetById(b[a].material)){if(!a.resource)return console.error(pc.string.format("Material asset '{0}' is not loaded.",a.name)),null}else return console.error("Reference to material not in asset list. Try reloading."),null;d=a.resource}else if(b[a].path&&(c=pc.path.split(c.parent.canonical)[0],c=pc.path.join(c,b[a].path),a=this._assets.getAssetByUrl(c)))d=a.resource;return d};var c;c=pc.inherits(function(){},pc.resources.ResourceRequest);c.prototype.type=
"model";c.prototype.Type=pc.scene.Model;return{ModelResourceHandler:b,ModelRequest:c}}());pc.extend(pc.resources,function(){var d={repeat:pc.gfx.ADDRESS_REPEAT,clamp:pc.gfx.ADDRESS_CLAMP_TO_EDGE,mirror:pc.gfx.ADDRESS_MIRRORED_REPEAT},a={nearest:pc.gfx.FILTER_NEAREST,linear:pc.gfx.FILTER_LINEAR,nearest_mip_nearest:pc.gfx.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.gfx.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.gfx.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.gfx.FILTER_LINEAR_MIPMAP_LINEAR},b=function(a,b){this._assets=b;this._device=a},b=pc.inherits(b,pc.resources.ResourceHandler);
b.prototype.load=function(a){var b=null;return b=pc.string.startsWith(a.canonical,"asset://")?new pc.promise.Promise(function(b,c){var d=this._getAssetFromRequest(a);d||c(pc.string("Can't load material, asset %s not found",a.canonical));b(d.data)}.bind(this)):new pc.promise.Promise(function(b,c){pc.net.http.get(a.canonical,function(c){if("path"===c.mapping_format){var d=this._listTextures(c),g=[];d.length?(d.forEach(function(b){var c=pc.path.getBasename(b),b=pc.path.join(pc.path.split(a.canonical)[0],
b);g.push(new pc.asset.Asset(c,"texture",{url:b}))}),this._assets.load(g).then(function(){b(c)})):b(c)}else b(c)}.bind(this),{error:function(){c()}})}.bind(this))};b.prototype.open=function(a,b){var c=new pc.scene.PhongMaterial;this._updatePhongMaterial(c,a,b);this._getAssetFromRequest(b).on("change",function(a,b,e){"data"===b&&this._updatePhongMaterial(c,e)},this);return c};b.prototype._listTextures=function(a){var b,c=a.parameters.length,d,l=[];for(b=0;b<c;b++)d=a.parameters[b],"texture"===d.type&&
d.data&&l.push(d.data);return l};b.prototype._updatePhongMaterial=function(a,b,c){for(var d=0;d<b.parameters.length;d++){var l=b.parameters[d];"texture"===l.type&&(l.data&&!(l.data instanceof pc.gfx.Texture))&&(l.data=this._loadTexture(l.data,c))}a.init(b)};b.prototype._loadTexture=function(b,c){var f=this._assets.getAssetById(b);if(!f)var h=pc.path.join(pc.path.split(c.canonical)[0],b),f=this._assets.getAssetByUrl(h);if(!f)return null;if(f.resource)return f.resource;h=f.getFileUrl();if(!h)return null;
var l=f.data,h=this._assets.loader.getFromCache(h);h||(h=new pc.gfx.Texture(this._device,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8}),h.name=l.name,h.addressU=d[l.addressu],h.addressV=d[l.addressv],h.magFilter=a[l.magfilter],h.minFilter=a[l.minfilter]);this._assets.load([f],[h],{});return h};b.prototype._getAssetFromRequest=function(a){return pc.string.startsWith(a.canonical,"asset://")?this._assets.getAssetById(parseInt(a.canonical.slice(8))):this._assets.getAssetByUrl(a.canonical)};var c;c=pc.inherits(function(){},
pc.resources.ResourceRequest);c.prototype.type="material";c.prototype.Type=pc.scene.Material;return{MaterialRequest:c,MaterialResourceHandler:b}}());pc.anim={};pc.anim.Key=function(d,a,b,c){this.time=d;this.position=a;this.rotation=b;this.scale=c};pc.anim.Node=function(){this._name="";this._keys=[]};
pc.extend(pc.anim,function(){var d=function(){this._name="";this._duration=0;this._nodes=[];this._nodeDict={}};d.prototype.getDuration=function(){return this._duration};d.prototype.getName=function(){return this._name};d.prototype.getNode=function(a){return this._nodeDict[a]};d.prototype.getNodes=function(){return this._nodes};d.prototype.setDuration=function(a){this._duration=a};d.prototype.setName=function(a){this._name=a};d.prototype.addNode=function(a){this._nodes.push(a);this._nodeDict[a._name]=
a};return{Animation:d}}());pc.extend(pc.anim,function(){function d(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new pc.Quat;this._pos=new pc.Vec3;this._scale=new pc.Vec3;this._targetNode=null}d.prototype={getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}};var a=function(a){function c(a){var b=a.getName(),h=new d;h._name=b;e._interpolatedKeys.push(h);e._interpolatedKeyDict[b]=h;e._currKeyIndices[b]=0;a=a.getChildren();for(b=0;b<a.length;b++)c(a[b])}this._animation=null;
this._time=0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var e=this;c(a)};a.prototype.addTime=function(a){if(null!==this._animation&&(this._time!==k||this.looping)){var c,e,d,f,h,l=this._animation.getNodes();this._time+=a;var k=this._animation.getDuration();if(this._time>k){this._time=this.looping?0:k;for(k=0;k<l.length;k++)c=l[k],e=c._name,this._currKeyIndices[e]=0}else if(0>this._time){this._time=this.looping?k:0;for(k=0;k<l.length;k++)c=
l[k],e=c._name,this._currKeyIndices[e]=c._keys.length-2}a=0<a?1:-1;for(k=0;k<l.length;k++)if(c=l[k],e=c._name,d=c._keys,c=this._interpolatedKeyDict[e],1===d.length)c._pos.copy(d[0].position),c._quat.copy(d[0].rotation),c._scale(d[0].scale);else for(var n=this._currKeyIndices[e];n<d.length-1&&0<=n;n+=a)if(f=d[n],h=d[n+1],f.time<=this._time&&h.time>=this._time){d=(this._time-f.time)/(h.time-f.time);c._pos.lerp(f.position,h.position,d);c._quat.slerp(f.rotation,h.rotation,d);c._scale.lerp(f.scale,h.scale,
d);c._written=!0;this._currKeyIndices[e]=n;break}}};a.prototype.blend=function(a,c,e){for(var d=this._interpolatedKeys.length,f=0;f<d;f++){var h=a._interpolatedKeys[f],l=c._interpolatedKeys[f],k=this._interpolatedKeys[f];h._written&&l._written?(k._quat.slerp(h._quat,c._interpolatedKeys[f]._quat,e),k._pos.lerp(h._pos,c._interpolatedKeys[f]._pos,e),k._scale.lerp(h._scale,l._scale,e),k._written=!0):h._written?(k._quat.copy(h._quat),k._pos.copy(h._pos),k._scale.copy(h._scale),k._written=!0):l._written&&
(k._quat.copy(l._quat),k._pos.copy(l._pos),k._scale.copy(l._scale),k._written=!0)}};a.prototype.getAnimation=function(){return this._animation};a.prototype.getCurrentTime=function(){return this._time};a.prototype.setCurrentTime=function(a){this._time=a;for(var a=this._interpolatedKeys.length,c=0;c<a;c++)this._currKeyIndices[this._interpolatedKeys[c]._name]=0;this.addTime(0);this.updateGraph()};a.prototype.getNumNodes=function(){return this._interpolatedKeys.length};a.prototype.setAnimation=function(a){this._animation=
a;this.setCurrentTime(0)};a.prototype.setGraph=function(a){var c;if(this.graph=a)for(c=0;c<this._interpolatedKeys.length;c++){var e=a.findByName(this._interpolatedKeys[c]._name);this._interpolatedKeys[c].setTarget(e)}else for(c=0;c<this._interpolatedKeys.length;c++)this._interpolatedKeys[c].setTarget(null)};a.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var c=this._interpolatedKeys[a];if(c._written){var e=c.getTarget();e.localPosition.copy(c._pos);
e.localRotation.copy(c._quat);e.localScale.copy(c._scale);e.dirtyLocal=!0;c._written=!1}}};a.prototype.setLooping=function(a){this.looping=a};a.prototype.getLooping=function(){return this.looping};return{Skeleton:a}}());pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a,c){return new pc.promise.Promise(function(e,d){var f=a.canonical;pc.path.getDirectory(f);pc.net.http.get(f,function(a){try{e(a)}catch(b){d(pc.string.format("An error occured while loading animation from: '{0}'",f))}}.bind(this),{cache:c.cache,error:function(a){d(a)}})})};d.prototype.open=function(a){return this["_loadAnimationV"+a.animation.version](a)};d.prototype._loadAnimationV3=
function(a){var a=a.animation,c=new pc.anim.Animation;c.setName(a.name);c.setDuration(a.duration);for(var e=0;e<a.nodes.length;e++){var d=new pc.anim.Node,f=a.nodes[e];d._name=f.name;for(var h=0;h<f.keys.length;h++){var l=f.keys[h],k=l.time,n=l.pos,m=l.rot,l=l.scale,n=new pc.Vec3(n[0],n[1],n[2]),m=(new pc.Quat).setFromEulerAngles(m[0],m[1],m[2]),l=new pc.Vec3(l[0],l[1],l[2]),k=new pc.anim.Key(k,n,m,l);d._keys.push(k)}c.addNode(d)}return c};d.prototype._loadAnimationV4=function(a){var a=a.animation,
c=new pc.anim.Animation;c.setName(a.name);c.setDuration(a.duration);for(var e=0;e<a.nodes.length;e++){var d=new pc.anim.Node,f=a.nodes[e];d._name=f.name;for(var h=f.defaults.p,l=f.defaults.r,k=f.defaults.s,n=0;n<f.keys.length;n++){var m=f.keys[n],r=m.t,w=h?h:m.p,s=l?l:m.r,m=k?k:m.s,w=new pc.Vec3(w[0],w[1],w[2]),s=(new pc.Quat).setFromEulerAngles(s[0],s[1],s[2]),m=new pc.Vec3(m[0],m[1],m[2]),r=new pc.anim.Key(r,w,s,m);d._keys.push(r)}c.addNode(d)}return c};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);
a.prototype.type="animation";a.prototype.Type=pc.anim.Animation;return{AnimationResourceHandler:d,AnimationRequest:a}}());pc.audio=function(){var d=function(){pc.audio.hasAudioContext()&&("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext));this.listener=new pc.audio.Listener(this);this.volume=1;this.suspended=!1;pc.events.attach(this)};d.prototype={createSound:function(a,b,c){var e=null;pc.audio.Sound?e=new pc.audio.Sound(this,a,b,c):c();return e},playSound:function(a,b){var b=b||{},c=null;pc.audio.Channel&&(c=new pc.audio.Channel(this,
a,b),c.play());return c},playSound3d:function(a,b,c){var c=c||{},e=null;pc.audio.Channel3d&&(e=new pc.audio.Channel3d(this,a,c),e.setPosition(b),c.volume&&e.setVolume(c.volume),c.loop&&e.setLoop(c.loop),c.maxDistance&&e.setMaxDistance(c.maxDistance),c.minDistance&&e.setMinDistance(c.minDistance),c.rollOffFactor&&e.setRollOffFactor(c.rollOffFactor),e.play());return e},getListener:function(){return this.listener},getVolume:function(){return this.volume},setVolume:function(a){this.volume=a;this.fire("volumechange",
a)},suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")}};return{AudioManager:d,hasAudio:function(){return"undefined"!==typeof Audio},hasAudioContext:function(){return!!("undefined"!==typeof AudioContext||"undefined"!==typeof webkitAudioContext)},isSupported:function(a,b){var c={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav"},e=pc.path.getExtension(a);return c[e]?(b||(b=new Audio),""!==b.canPlayType(c[e])):!1}}}();pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?d=function(a,b,c,e){this.buffer=null;this.isLoaded=!1;pc.audio.isSupported(b,this.audio)?a.context&&pc.net.http.get(b,function(b){a.context.decodeAudioData(b,function(a){this.buffer=a;this.isLoaded=!0;c(this)}.bind(this),e)}.bind(this),{error:e}):setTimeout(function(){e(pc.string.format("Audio format for {0} not supported",b))},0)}:pc.audio.hasAudio()&&(d=function(a,b,c,e){this.isLoaded=!1;this.audio=new Audio;pc.audio.isSupported(b,this.audio)?
(this.audio.addEventListener("stalled",function(){logDEBUG("stalled: "+this.audio.src)}.bind(this),!1),this.audio.addEventListener("suspend",function(){logDEBUG("suspend: "+this.audio.src)}.bind(this),!1),this.audio.addEventListener("abort",function(){logDEBUG("abort: "+this.audio.src)}.bind(this),!1),this.audio.addEventListener("pause",function(){logDEBUG("pause: "+this.audio.src)}.bind(this),!1),this.audio.addEventListener("canplay",function(){logDEBUG("canplay: "+this.audio.src)}.bind(this),!1),
this.audio.addEventListener("progress",function(){logDEBUG("progress "+b)}.bind(this)),this.audio.addEventListener("loadstart",function(){logDEBUG("loadstart: "+this.audio.src);this.isLoaded||(this.isLoaded=!0,c(this))}.bind(this),!1),this.audio.addEventListener("canplaythrough",function(){logDEBUG("canplaythrough: "+this.audio.src);this.isLoaded||(this.isLoaded=!0,c(this))}.bind(this),!1),this.audio.addEventListener("loadeddata",function(){logDEBUG("loadeddata: "+b);this.isLoaded||(this.isLoaded=
!0,c(this))}.bind(this),!1),this.audio.addEventListener("error",function(){logERROR("error loading: "+b);e(pc.string.format("Error loading Sound from: '{0}'",b))}.bind(this),!1),this.audio.src=b,logDEBUG("loading: "+b)):(setTimeout(function(){e(pc.string.format("Audio format for {0} not supported",b))},0),this.audio=null)});return{Sound:d}}());pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?(d=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4;this.listener=a.context.listener},d.prototype.getPosition=function(){return this.position},d.prototype.setPosition=function(a){this.position.copy(a);this.listener.setPosition(a.x,a.y,a.z)},d.prototype.getVelocity=function(){return this.velocity},d.prototype.setVelocity=function(a){this.velocity.copy(a);this.listener.setPosition(a.x,a.y,a.z)},
d.prototype.setOrientation=function(a){this.orientation.copy(a);this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])}):(d=function(){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4},d.prototype.getPosition=function(){return this.position},d.prototype.setPosition=function(a){this.position.copy(a)},d.prototype.getVelocity=function(){return this.velocity},d.prototype.setVelocity=function(a){this.velocity.copy(a)},d.prototype.setOrientation=
function(a){this.orientation.copy(a)});d.prototype.getOrientation=function(){return this.orientation};return{Listener:d}}());pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?(d=function(a,b,c){c=c||{};this.volume="undefined"===typeof c.volume?1:c.volume;this.loop="undefined"===typeof c.loop?!1:c.loop;this.pitch="undefined"===typeof c.pitch?1:c.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()},d.prototype={play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();this.setVolume(this.volume);
this.setLoop(this.loop);this.setPitch(this.pitch);this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this)},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){if(this.source||
!this.paused)throw Error("Call pause() before unpausing.");this._createSource();this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch);this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.paused=!1},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",
this.onManagerResume,this)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a;this.gain&&(this.gain.gain.value=a*this.manager.getVolume())},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var a=this.manager.context;this.source=
a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.gain);this.gain.connect(a.destination)}}):pc.audio.hasAudio()?(d=function(a,b,c){this.volume=c.volume||1;this.loop=c.loop||!1;this.sound=b;this.pitch="undefined"!==typeof c.pitch?c.pitch:1;this.suspended=this.paused=!1;this.manager=a;this.source=b.audio.cloneNode(!1);this.source.pause()},d.prototype={play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),
this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this)},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&(this.source.pause(),this.source.currentTime=0);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,
this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(a){this.volume=a;this.source&&(this.source.volume=a*this.manager.getVolume())},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=a)},getDuration:function(){if(this.source){var a=this.source.duration;if(a===a)return a}return 0},isPlaying:function(){return!this.source.paused}}):(console.warn("No support for 2D audio found"),d=function(){});
pc.extend(d.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});return{Channel:d}}());pc.extend(pc.audio,function(){var d;if(pc.audio.hasAudioContext())d=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.panner=a.context.createPanner()},d=pc.inherits(d,pc.audio.Channel),d.prototype=pc.extend(d.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},
setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination)}});
else if(pc.audio.hasAudio()){var a=new pc.Vec3,b;d=pc.inherits(function(){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1},pc.audio.Channel);d.prototype=pc.extend(d.prototype,{getPosition:function(){return this.position},setPosition:function(c){this.position.copy(c);if(this.source){var e=this.manager.getListener().getPosition();var c=this.minDistance,d=this.maxDistance,f=this.rollOffFactor;a=a.sub2(e,this.position);b=a.length();b<c?c=
1:b>d?c=0:(e=c+f*(b-c),c=0!==e?c/e:1);e=this.getVolume();this.source.volume=e*c}},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rolloffFactor},setRollOffFactor:function(a){this.rolloffFactor=a}})}else console.warn("No support for 3D audio found"),
d=function(){};return{Channel3d:d}}());pc.extend(pc.resources,function(){var d=function(a){this.manager=a},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a){var c=this;return new pc.promise.Promise(function(e){var d=c.manager.createSound(a.canonical,function(a){e(a)},function(a){logERROR(a);e(d)})})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="audio";a.prototype.Type=pc.audio.Sound;return{AudioResourceHandler:d,AudioRequest:a}}());pc.input={};pc.extend(pc.input,function(){var d=function(a,b){var c={x:0,y:0};if(b){if(b instanceof d)throw Error("Expected MouseEvent");c=a._getTargetCoords(b)}else b={};if(c)this.x=c.x,this.y=c.y;else if(pc.input.Mouse.isPointerLocked())this.y=this.x=0;else return;this.wheel=b.detail?-1*b.detail:b.wheelDelta?b.wheelDelta/120:0;pc.input.Mouse.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=
this.y-a._lastY);this.button="mousedown"===b.type||"mouseup"===b.type?b.button:pc.input.MOUSEBUTTON_NONE;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b},a=function(a){this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);
this._wheelHandler=this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a);pc.events.attach(this)};a.isPointerLocked=function(){return!(!document.pointerLockElement&&!document.mozPointerLockElement&&!document.webkitPointerLockElement)};a.prototype={attach:function(a){this._target=a;this._attached||(this._attached=!0,window.addEventListener("mouseup",this._upHandler,!1),window.addEventListener("mousedown",this._downHandler,
!1),window.addEventListener("mousemove",this._moveHandler,!1),window.addEventListener("mousewheel",this._wheelHandler,!1),window.addEventListener("DOMMouseScroll",this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,window.removeEventListener("mouseup",this._upHandler),window.removeEventListener("mousedown",this._downHandler),window.removeEventListener("mousemove",this._moveHandler),window.removeEventListener("mousewheel",this._wheelHandler),window.removeEventListener("DOMMouseScroll",
this._wheelHandler))},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(a,b){var c=function(){a();document.removeEventListener("pointerlockchange",c)},d=function(){b();document.removeEventListener("pointerlockerror",d)};a&&document.addEventListener("pointerlockchange",c,!1);b&&document.addEventListener("pointerlockerror",
d,!1);document.body.requestPointerLock()},disablePointerLock:function(a){var b=function(){a();document.removeEventListener("pointerlockchange",b)};a&&document.addEventListener("pointerlockchange",b,!1);document.exitPointerLock()},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&!this._lastbuttons[a]},wasReleased:function(a){return!this._buttons[a]&&
this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;a=new d(this,a);a.event&&this.fire(pc.input.EVENT_MOUSEUP,a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new d(this,a);a.event&&this.fire(pc.input.EVENT_MOUSEDOWN,a)},_handleMove:function(a){a=new d(this,a);a.event&&(this.fire(pc.input.EVENT_MOUSEMOVE,a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new d(this,a);a.event&&this.fire(pc.input.EVENT_MOUSEWHEEL,a)},_getTargetCoords:function(a){var b=this._target.getBoundingClientRect(),
c=Math.floor(b.left),b=Math.floor(b.top);return a.clientX<c||a.clientX>=c+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?null:{x:a.clientX-c,y:a.clientY-b}}};if(!("undefined"===typeof navigator||"undefined"===typeof document)){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var b=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(a)},c=function(){var a=document.createEvent("CustomEvent");
a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",b,!1);document.addEventListener("webkitpointerlocklost",b,!1);document.addEventListener("mozpointerlockchange",b,!1);document.addEventListener("mozpointerlocklost",b,!1);document.addEventListener("webkitpointerlockerror",c,!1);document.addEventListener("mozpointerlockerror",c,!1);Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:
Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,b,c)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=
null,navigator.pointer.unlock())})}return{Mouse:a,MouseEvent:d,EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2}}());pc.extend(pc.input,function(){function d(a){return"string"==typeof a?a.toUpperCase().charCodeAt(0):a}var a=function(a,b){this.key=b.keyCode;this.element=b.target;this.event=b},b={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},c=function(a,b){b=b||{};this._element=null;this._keyDownHandler=this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);
pc.events.attach(this);this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1};c.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};c.prototype.detach=function(){this._element.removeEventListener("keydown",
this._keyDownHandler);this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};c.prototype.toKeyIdentifier=function(a){var a=d(a),c,f;if(c=b[a.toString()])return c;c=a.toString(16).toUpperCase();f=c.length;for(a=0;a<4-f;a++)c="0"+c;return"U+"+c};c.prototype._handleKeyDown=function(b){var c=b.keyCode||b.charCode,c=b.keyIdentifier||this.toKeyIdentifier(c);this._keymap[c]=!0;this.fire("keydown",new a(this,b));
this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};c.prototype._handleKeyUp=function(b){var c=b.keyCode||b.charCode,c=b.keyIdentifier||this.toKeyIdentifier(c);delete this._keymap[c];this.fire("keyup",new a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};c.prototype._handleKeyPress=function(b){var c=b.keyCode||b.charCode;b.keyIdentifier||this.toKeyIdentifier(c);this.fire("keypress",new a(this,b));this.preventDefault&&b.preventDefault();
this.stopPropagation&&b.stopPropagation()};c.prototype.update=function(){var a;this._lastmap={};for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};c.prototype.isPressed=function(a){a=d(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};c.prototype.wasPressed=function(a){a=d(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};c.prototype.wasReleased=function(a){a=d(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};
return{Keyboard:c,EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:14,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,
KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,
KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224}}());pc.extend(pc.input,function(){var d=function(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=0.25},a={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},b={"Product: 0268":"PS3"};d.prototype={update:function(){var a=this.poll(),b,d=a.length;for(b=0;b<d;b++)this.previous[b]=this.current[b],this.current[b]=a[b]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),d,f=b.length;for(d=0;d<f;d++)b[d]&&a.push({map:this.getMap(b[d]),pad:b[d]})}return a},getMap:function(c){for(var e in b)if(0<=c.id.indexOf(e))return a[b[e]];
return a.DEFAULT},isPressed:function(a,b){return!this.current[a]?!1:this.current[a].pad.buttons[pc.input[this.current[a].map.buttons[b]]].pressed},wasPressed:function(a,b){if(!this.current[a])return!1;var d=pc.input[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[d].pressed&&!this.previous[a].pad.buttons[d].pressed},getAxis:function(a,b){if(!this.current[a])return!1;var d=this.current[a].pad.axes[pc.input[this.current[a].map.axes[b]]];Math.abs(d)<this.deadZone&&(d=0);return d}};
return{PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,GamePads:d}}());pc.extend(pc.input,function(){var d=function(b,e){this.element=e.target;this.event=e;this.touches=[];this.changedTouches=[];if(e){var d,f=e.touches.length;for(d=0;d<f;d++)this.touches.push(new a(e.touches[d]));f=e.changedTouches.length;for(d=0;d<f;d++)this.changedTouches.push(new a(e.changedTouches[d]))}};d.prototype={getTouchById:function(a,b){var d,f=b.length;for(d=0;d<f;d++)if(b[d].id===a)return b[d];return null}};var a=function(a){var b=pc.input.getTouchTargetCoords(a);this.id=a.identifier;this.x=
b.x;this.y=b.y;this.target=a.target;this.touch=a},b=function(a){this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a);pc.events.attach(this)};b.prototype={attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,
!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire("touchstart",
new d(this,a))},_handleTouchEnd:function(a){this.fire("touchend",new d(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire("touchmove",new d(this,a))},_handleTouchCancel:function(a){this.fire("touchcancel",new d(this,a))}};return{EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",getTouchTargetCoords:function(a){for(var b=0,d=0,f=a.target;!(f instanceof HTMLElement);)f=f.parentNode;do b+=f.offsetLeft-f.scrollLeft,d+=
f.offsetTop-f.scrollTop,f=f.offsetParent;while(f);return{x:a.pageX-b,y:a.pageY-d}},TouchDevice:b}}());pc.extend(pc.input,function(){var d=function(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)};d.prototype.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};d.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};d.prototype.disableContextMenu=
function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};d.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};d.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var b in this._axes)this._axesValues[b]=[]};d.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error(pc.string.format("Action: {0} already registered",
a));if("undefined"===typeof b)throw Error("Invalid button");b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:pc.input.ACTION_KEYBOARD,keys:b}):this._actions[a]=[{type:pc.input.ACTION_KEYBOARD,keys:b}]};d.prototype.registerMouse=function(a,b){this._mouse||this._enableMouse();if("undefined"===typeof b)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.input.ACTION_MOUSE,button:b}):this._actions[a]=[{type:pc.input.ACTION_MOUSE,button:-b}]};d.prototype.registerPadButton=
function(a,b,c){if("undefined"===typeof c)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.input.ACTION_GAMEPAD,button:c,pad:b}):this._actions[a]=[{type:pc.input.ACTION_GAMEPAD,button:c,pad:b}]};d.prototype.registerAxis=function(a){var b=a.name;this._axes[b]||(this._axes[b]=[]);var c=this._axes[b].push(b),a=a||{};a.pad=a.pad||pc.input.PAD_1;var e=function(e,d,h,l){switch(d){case "mousex":e._mouse.on(pc.input.EVENT_MOUSEMOVE,function(a){e._axesValues[b][c]=a.dx/10});break;
case "mousey":e._mouse.on(pc.input.EVENT_MOUSEMOVE,function(a){e._axesValues[b][c]=a.dy/10});break;case "key":e._axes[b].push(function(){return e._keyboard.isPressed(l)?h:0});break;case "padrx":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_R_STICK_X)});break;case "padry":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_R_STICK_Y)});break;case "padlx":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_L_STICK_X)});break;case "padly":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,
pc.input.PAD_L_STICK_Y)});break;default:throw Error("Unknown axis");}};e(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&e(this,a.negative,-1,a.negativeKey)};d.prototype.isPressed=function(a){if(!this._actions[a])return!1;for(var b,c=0,e=this._actions[a].length,c=0;c<e;++c)switch(b=this._actions[a][c],b.type){case pc.input.ACTION_KEYBOARD:if(this._keyboard){var d,f=b.keys.length;for(d=0;d<f;d++)if(this._keyboard.isPressed(b.keys[d]))return!0}break;case pc.input.ACTION_MOUSE:if(this._mouse&&
this._mouse.isPressed(b.button))return!0;break;case pc.input.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.isPressed(b.pad,b.button))return!0}return!1};d.prototype.wasPressed=function(a){if(!this._actions[a])return!1;for(var b=0,c=this._actions[a].length,b=0;b<c;++b){var e=this._actions[a][b];switch(e.type){case pc.input.ACTION_KEYBOARD:if(this._keyboard){var d,f=e.keys.length;for(d=0;d<f;d++)if(this._keyboard.wasPressed(e.keys[d]))return!0}break;case pc.input.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(e.button))return!0;
break;case pc.input.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(e.pad,e.button))return!0}}return!1};d.prototype.getAxis=function(a){var b=0;if(this._axes[a]){var c,e=this._axes[a].length;for(c=0;c<e;c++)if("function"===pc.type(this._axes[a][c])){var d=this._axes[a][c]();Math.abs(d)>Math.abs(b)&&(b=d)}else this._axesValues[a]&&Math.abs(this._axesValues[a][c])>Math.abs(b)&&(b=this._axesValues[a][c])}return b};d.prototype._enableMouse=function(){this._mouse=new pc.input.Mouse;if(!this._element)throw Error("Controller must be attached to a DOMElement");
this._mouse.attach(this._element)};d.prototype._enableKeyboard=function(){this._keyboard=new pc.input.Keyboard;if(!this._element)throw Error("Controller must be attached to a DOMElement");this._keyboard.attach(this._element)};return{ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",Controller:d}}());pc.net=function(){return{}}();pc.extend(pc.net,function(){var d=function(){};d.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",BIN:"application/octet-stream"};d.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document"};d.binaryExtensions=[".model",".wav",".ogg",".mp3"];d.prototype={ContentType:d.ContentType,ResponseType:d.ResponseType,
binaryExtensions:d.binaryExtensions,get:function(a,b,c,e){c=c||{};c.success=b;return this.request("GET",a,c,e)},post:function(a,b,c,e,d){e=e||{};e.success=b;e.postdata=c;return this.request("POST",a,e,d)},put:function(a,b,c,e,d){e=e||{};e.success=b;e.postdata=c;return this.request("PUT",a,e,d)},del:function(a,b,c,e){c=c||{};c.success=b;return this.request("DELETE",a,c,e)},request:function(a,b,c,e){var g,f,h,l=!1,c=c||{};null==c.success&&(c.success=function(){});null==c.error&&(c.error=function(){});
null==c.async&&(c.async=!0);null==c.headers&&(c.headers={});if(null!=c.postdata)if(c.postdata instanceof Document)h=c.postdata;else if(c.postdata instanceof FormData)h=c.postdata;else if(c.postdata instanceof Object)switch(h=c.headers["Content-Type"],pc.isDefined(h)||(c.headers["Content-Type"]=d.ContentType.FORM_URLENCODED,h=c.headers["Content-Type"]),h){case d.ContentType.FORM_URLENCODED:h="";f=!0;for(g in c.postdata)c.postdata.hasOwnProperty(g)&&(f?f=!1:h+="&",h+=escape(g)+"="+escape(c.postdata[g]));
break;default:null==h&&(c.headers["Content-Type"]=d.ContentType.JSON),h=JSON.stringify(c.postdata)}else h=c.postdata;e||(e=new XMLHttpRequest);!1===c.cache&&(f=pc.time.now(),g=new pc.URI(b),g.query=g.query?g.query+"&ts="+f:"ts="+f,b=g.toString());c.query&&(g=new pc.URI(b),f=pc.extend(g.getQuery(),c.query),g.setQuery(f),b=g.toString());e.open(a,b,c.async);e.withCredentials=0;e.responseType=c.responseType||this.guessResponseType(b);for(var k in c.headers)c.headers.hasOwnProperty(k)&&e.setRequestHeader(k,
c.headers[k]);e.onreadystatechange=function(){this.onReadyStateChange(a,b,c,e)}.bind(this);e.onerror=function(){this.onError(a,b,c,e);l=!0}.bind(this);try{e.send(h)}catch(n){l||c.error(e.status,e,n)}return e},guessResponseType:function(a){a=new pc.URI(a);a=pc.path.getExtension(a.path);return 0<=d.binaryExtensions.indexOf(a)?d.ResponseType.ARRAY_BUFFER:d.ResponseType.TEXT},isBinaryContentType:function(a){return 0<=[d.ContentType.WAV,d.ContentType.OGG,d.ContentType.MP3,d.ContentType.BIN].indexOf(a)?
!0:!1},onReadyStateChange:function(a,b,c,e){if(4===e.readyState)switch(e.status){case 0:if("/"!=b[0])this.onSuccess(a,b,c,e);break;case 200:case 201:case 206:case 304:this.onSuccess(a,b,c,e);break;default:this.onError(a,b,c,e)}},onSuccess:function(a,b,c,e){var g;if(a=e.getResponseHeader("Content-Type"))a=a.split(";"),g=a[0].trim(),a[1]&&a[1].trim();g===this.ContentType.JSON||pc.string.endsWith(b,".json")?b=JSON.parse(e.responseText):this.isBinaryContentType(g)?b=e.response:e.responseType===d.ResponseType.ARRAY_BUFFER?
(logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}",d.ResponseType.ARRAY_BUFFER,g)),b=e.response):b=e.responseType===d.ResponseType.DOCUMENT||g===this.ContentType.XML?e.responseXML:e.responseText;c.success(b,e.status,e)},onError:function(a,b,c,e){c.error(e.status,e,null)}};d.prototype.delete_=d.prototype.del;return{Http:d,http:new d}}());pc.extend(pc.net,function(){var d=0,a=function(a,c,e,d,f){this.clientId=d;this.endpoint=a;this.redirectUrl=c;this.origin=e;this.scope=f;this.responseType="token";this.accessToken=null;this.OAUTH_IFRAME_ID_BASE="pc-oauth-access-token-"},a=pc.inherits(a,pc.net.Http);a.prototype.refreshAccessToken=function(a){var c=this.OAUTH_IFRAME_ID_BASE+d++,e=function(d){if(d.origin===this.origin){if(d.data.access_token){var f=document.getElementById(c);f&&f.parentNode.removeChild(f);this.accessToken=d.data.access_token;
a(d.data.access_token)}else d.data.error?logERROR(d.data.error):logWARNING("Invalid message posted to Corazon API");window.removeEventListener("message",e)}}.bind(this);window.addEventListener("message",e,!1);var g={client_id:this.clientId,redirect_url:this.redirectUrl,scope:this.scope,response_type:this.responseType},f=new pc.URI(this.endpoint);f.setQuery(g);if(g=document.getElementById(c))throw Error("accessToken request already in progress");g=document.createElement("iframe");g.src=f.toString();
g.id=c;g.style.display="none";document.body.appendChild(g)};a.prototype.request=function(a,c,e,d){e.query=e.query||{};e.query=pc.extend(e.query,{access_token:this.accessToken});return pc.net.OAuth._super.request.call(this,a,c,e,d)};a.prototype.onError=function(a,c,e,d){401==d.status?this.refreshAccessToken(function(f){e.query.access_token=f;this.request(a,c,e,d)}.bind(this)):e.error(d.status,d,null)};return{OAuth:a,oauth:new a}}());pc.extend(pc.net,function(){var d=function(a){this._ws=new WebSocket(a);this._ws.onopen=this._handleOpen.bind(this);this._ws.onerror=this._handleError.bind(this);this._ws.onmessage=this._handleMessage.bind(this);this._ws.onclose=this._handleClose.bind(this)};d.prototype={onopen:null,onerror:null,onmessage:null,get binaryType(){return this._ws.binaryType},set binaryType(a){this._ws.binaryType=a},get readyState(){return this._ws.readyState},get bufferedAmount(){return this._ws.bufferedAmount},get extensions(){return this._ws.extensions},
get protocol(){return this._ws.protocol},_handleOpen:function(){if(this.onopen)this.onopen()},_handleError:function(a){if(this.onerror)this.onerror(a)},_handleMessage:function(a){if(this.onmessage)this.onmessage(a)},_handleClose:function(){if(this.onclose)this.onclose()},send:function(a){this._ws.send(a)}};return{Socket:d}}());pc.script=function(){var d=null,a=null,b={main:function(a){if(d)throw Error("'main' Object already registered");d=a},setLoader:function(b){if(b&&a)throw Error("pc.script already has loader object.");a=b},create:function(a,b){"undefined"===typeof b&&(b=attributes);this.fire("created",a,b)},attribute:function(){},start:function(){d()}};pc.events.attach(b);return b}();pc.extend(pc.resources,function(){var d=function(a,c){this._context=a;this._prefix=c||"";this._queue=[];this._pending=[];this._loaded={};this._loading=null;pc.script.on("created",this._onScriptCreated,this)},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a,c){c=c||{};c.timeout=c.timeout||6E4;c.cache=!0;return new pc.promise.Promise(function(e,d){var f=a.canonical,h=f;c.cache||(h=this._appendTimestampToUrl(h));h=new pc.URI(h);h.path=pc.path.join(this._prefix,h.path);h=h.toString();
this._loaded[f]?!0!==this._loaded[f]?e(this._loaded[f]):e(null):this._loading?this._queue.push({url:h,canonicalUrl:f,success:e,error:d}):this._addScriptTag(h,f,e,d);c.timeout&&setTimeout(function(){this._loaded[f]||d(pc.string.format("Loading script {0} timed out after {1}s",f,c.timeout/1E3))}.bind(this),c.timeout)}.bind(this))};d.prototype.open=function(a){return a};d.prototype._appendTimestampToUrl=function(a){timestamp=Date.now();uri=new pc.URI(a);uri.query=uri.query?uri.query+"&ts="+timestamp:
"ts="+timestamp;return a=uri.toString()};d.prototype._onScriptCreated=function(a,c){this._pending.push({name:a,callback:c})};d.prototype._addScriptTag=function(a,c,e,d){var f=this,h=document.getElementsByTagName("head")[0],l=document.createElement("script");this._loading=l;l.addEventListener("error",function(a){d(pc.string.format("Error loading script from '{0}'",a.target.src))});var k=!1;l.onload=l.onreadystatechange=function(){if(!k&&(!this.readyState||"loaded"==this.readyState||"complete"==this.readyState)){k=
!0;var a=f._pending.shift();if(a){var b=a.callback(f._context);if(b._pcScriptName)throw Error("Attribute _pcScriptName is reserved on ScriptTypes for ResourceLoader use");b._pcScriptName=a.name;f._loaded[c]=b;f._loader.registerHash(c,c);f._loader.addToCache(c,b);e(b)}else f._loaded[c]=!0,f._loader.registerHash(c,c),f._loader.addToCache(c,!0),e(null);f._loading=null;f._queue.length&&(a=f._queue.shift(),f._addScriptTag(a.url,a.canonicalUrl,a.success,a.error))}};l.src=a;h.appendChild(l)};var a;a=pc.inherits(function(){},
pc.resources.ResourceRequest);a.prototype.type="script";return{ScriptResourceHandler:d,ScriptRequest:a}}());pc.fw={};var editor=editor||{};pc.extend(editor,function(){var d=function(){this.exposed={};this.added={};this.scripts={};this.systems=[]};d.prototype={addComponentType:function(){},expose:function(){},add:function(){},scriptexpose:function(){}};return{LinkInterface:d,link:new d}}());pc.extend(editor,function(){var d=function(){this.exposed={};this.added={};this.scripts={};this.systems=[]};d.prototype.addComponentType=function(a){var b=a.id,c,e=this.systems,d=e.length,f=!1;for(c=0;c<d;c++)if(e[c].name===b){f=!0;break}f||this.systems.push({name:b,description:a.description});this.exposed[b]||(this.exposed[b]={})};d.prototype.expose=function(a,b){if(!b.name)throw Error("Missing option 'name'");b.options=b.options||{};if("vector"===b.type)if(b.array=!0,b.defaultValue)switch(b.defaultValue.length){case 2:b.RuntimeType=
pc.Vec2;break;case 3:b.RuntimeType=pc.Vec3;break;case 4:b.RuntimeType=pc.Vec4}else b.RuntimeType=pc.Vec3;else"rgb"===b.type||"rgba"===b.type?(b.array=!0,b.RuntimeType=pc.Color):"curve"===b.type?(b.object=!0,b.RuntimeType=pc.Curve):"curveset"===b.type&&(b.object=!0,b.RuntimeType=pc.CurveSet);this.exposed[a][b.name]||(this.exposed[a][b.name]={});this.exposed[a][b.name]=b};d.prototype.add=function(a){logASSERT(a.system,"Missing option: 'system'");logASSERT(a.variable,"Missing option: 'variable'");this.added[a.system]||
(this.added[a.system]={});this.added[a.system][a.variable]||(this.added[a.system][a.variable]={});this.added[a.system][a.variable]=a};d.prototype.scriptexpose=function(a){this.scripts[a.script]=a};return{LinkInterface:d,link:new d}}());pc.extend(pc.fw,function(){return{ContentFile:function(d){this.packs=d.packs||{};this.appProperties=d.application_properties||{};this.toc=d.toc||{}}}}());pc.extend(pc.fw,function(){var d=function(a){this.hierarchy=a.hierarchy;this.settings=a.settings};d.prototype={};return{Pack:d}}());pc.extend(pc.fw,function(){return{ApplicationContext:function(d,a,b,c,e){this.loader=d;this.scene=a;this.graphicsDevice=b;this.root=new pc.fw.Entity;d=e.depot?e.depot.assets.getServer().getBaseUrl():null;this.assets=new pc.asset.AssetRegistry(this.loader,d);this.systems=c;e=e||{};this.controller=e.controller;this.keyboard=e.keyboard;this.mouse=e.mouse;this.touch=e.touch;this.gamepads=e.gamepads}}}());pc.extend(pc.fw,function(){var d,a=function(b,c){c=c||{};this._inTools=!1;pc.events.attach(this);this.canvas=b;this.fillMode=pc.fw.FillMode.KEEP_ASPECT;this.resolutionMode=pc.fw.ResolutionMode.FIXED;this.librariesLoaded=!1;this._link=new pc.fw.LiveLink("application");this._link.addDestinationWindow(window);this._link.listen(this._handleMessage.bind(this));pc.log.open();this.graphicsDevice=new pc.gfx.Device(b);this.graphicsDevice.enableValidation(!1);var e=new pc.fw.ComponentSystemRegistry;this.audioManager=
new pc.audio.AudioManager;var d=new pc.resources.ResourceLoader;!1===c.cache&&(d.cache=!1);c.displayLoader&&new pc.resources.ResourceLoaderDisplay(document.body,d);this.context=new pc.fw.ApplicationContext(d,new pc.scene.Scene,this.graphicsDevice,e,c);c.content&&(this.content=c.content,Object.keys(this.content.toc).forEach(function(a){this.context.assets.addGroup(a,this.content.toc[a])}.bind(this)));new pc.resources.TextureCache(d);d.registerHandler(pc.resources.JsonRequest,new pc.resources.JsonResourceHandler);
d.registerHandler(pc.resources.TextRequest,new pc.resources.TextResourceHandler);d.registerHandler(pc.resources.ImageRequest,new pc.resources.ImageResourceHandler);d.registerHandler(pc.resources.MaterialRequest,new pc.resources.MaterialResourceHandler(this.graphicsDevice,this.context.assets));d.registerHandler(pc.resources.TextureRequest,new pc.resources.TextureResourceHandler(this.graphicsDevice));d.registerHandler(pc.resources.ModelRequest,new pc.resources.ModelResourceHandler(this.graphicsDevice,
this.context.assets));d.registerHandler(pc.resources.AnimationRequest,new pc.resources.AnimationResourceHandler);d.registerHandler(pc.resources.PackRequest,new pc.resources.PackResourceHandler(e,c.depot));d.registerHandler(pc.resources.AudioRequest,new pc.resources.AudioResourceHandler(this.audioManager));this.renderer=new pc.scene.ForwardRenderer(this.graphicsDevice);d.registerHandler(pc.resources.ScriptRequest,new pc.resources.ScriptResourceHandler(this.context,c.scriptPrefix));new pc.fw.RigidBodyComponentSystem(this.context);
new pc.fw.CollisionComponentSystem(this.context);new pc.fw.BallSocketJointComponentSystem(this.context);new pc.fw.AnimationComponentSystem(this.context);new pc.fw.ModelComponentSystem(this.context);new pc.fw.CameraComponentSystem(this.context);new pc.fw.CubeMapComponentSystem(this.context);new pc.fw.StaticCubeMapComponentSystem(this.context);new pc.fw.LightComponentSystem(this.context);new pc.fw.PackComponentSystem(this.context);new pc.fw.SkyboxComponentSystem(this.context);new pc.fw.ScriptComponentSystem(this.context);
new pc.fw.PickComponentSystem(this.context);new pc.fw.AudioSourceComponentSystem(this.context,this.audioManager);new pc.fw.AudioListenerComponentSystem(this.context,this.audioManager);new pc.fw.ParticleSystemComponentSystem(this.context);new pc.fw.DesignerComponentSystem(this.context);this.on("librariesloaded",this.onLibrariesLoaded,this);c.libraries&&c.libraries.length?(e=c.libraries.map(function(a){return new pc.resources.ScriptRequest(a)}),d.request(e).then(function(){this.fire("librariesloaded",
this);this.librariesLoaded=!0}.bind(this))):(this.fire("librariesloaded",this),this.librariesLoaded=!0);"undefined"!==typeof document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this.onVisibilityChange.bind(this),!1)):"undefined"!==typeof document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this.onVisibilityChange.bind(this),!1)):"undefined"!==typeof document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",
this.onVisibilityChange.bind(this),!1)):"undefined"!==typeof document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this.onVisibilityChange.bind(this),!1));a._applications[this.canvas.id]=this};a._applications={};a.getApplication=function(b){return a._applications[b]};a.prototype={loadFromToc:function(a,c,e,d){this.content||e("No content");var a=this.content.toc[a],c=c||function(){},e=e||function(){},d=d||function(){},f=a.packs[0],h=function(){this.context.loader.request(new pc.resources.PackRequest(f)).then(function(a){a=
a[0];this.context.root.addChild(a.hierarchy);pc.fw.ComponentSystem.initialize(a.hierarchy);pc.fw.ComponentSystem.postInitialize(a.hierarchy);if(this.context.systems.rigidbody&&"undefined"!==typeof Ammo){var b=a.settings.physics.gravity;this.context.systems.rigidbody.setGravity(b[0],b[1],b[2])}b=a.settings.render.global_ambient;this.context.scene.ambientLight=new pc.Color(b[0],b[1],b[2]);this.context.scene.fog=a.settings.render.fog;b=a.settings.render.fog_color;this.context.scene.fogColor=new pc.Color(b[0],
b[1],b[2]);this.context.scene.fogStart=a.settings.render.fog_start;this.context.scene.fogEnd=a.settings.render.fog_end;this.context.scene.fogDensity=a.settings.render.fog_density;this.context.scene.shadowDistance=a.settings.render.shadow_distance;this.context.scene.gammaCorrection=a.settings.render.gamma_correction;c(a);this.context.loader.off("progress",d)}.bind(this),function(a){e(a)}).then(null,function(a){setTimeout(function(){throw a;},0)})}.bind(this),l=function(){var a=this.context.assets.list(f);
this.context.loader.on("progress",d);a.length?this.context.assets.load(a).then(function(a){h(a)}):setTimeout(function(){h([])},0)}.bind(this);if(this.librariesLoaded)l();else this.on("librariesloaded",function(){l()})},start:function(){if(this.librariesLoaded)this.tick();else this.on("librariesloaded",function(){this.tick()},this)},update:function(a){var c=this.context;pc.fw.ComponentSystem.fixedUpdate(1/60,c,this._inTools);pc.fw.ComponentSystem.update(a,c,this._inTools);pc.fw.ComponentSystem.postUpdate(a,
c,this._inTools);this.fire("update",a);c.controller&&c.controller.update(a);c.mouse&&c.mouse.update(a);c.keyboard&&c.keyboard.update(a);c.gamepads&&c.gamepads.update(a)},render:function(){var a=this.context,c=a.systems.camera.cameras,e=null,d=this.renderer;a.root.syncHierarchy();for(var f=0,h=c.length;f<h;f++)e=c[f],e.frameBegin(),d.render(a.scene,e.camera),e.frameEnd()},tick:function(){requestAnimationFrame(this.tick.bind(this),this.canvas);var a=window.performance&&window.performance.now?performance.now():
Date.now(),c=(a-(d||a))/1E3;d=a;c=pc.math.clamp(c,0,0.1);this.update(c);this.render()},setCanvasFillMode:function(a,c,e){this.fillMode=a;this.resizeCanvas(c,e)},setCanvasResolution:function(a,c,e){this.resolutionMode=a;a===pc.fw.ResolutionMode.AUTO&&void 0===c&&(c=this.canvas.clientWidth,e=this.canvas.clientHeight);this.graphicsDevice.resizeCanvas(c,e)},isFullscreen:function(){return!!document.fullscreenElement},enableFullscreen:function(a,c,e){var a=a||this.canvas,d=function(){c();document.removeEventListener("fullscreenchange",
d)},f=function(){e();document.removeEventListener("fullscreenerror",f)};c&&document.addEventListener("fullscreenchange",d,!1);e&&document.addEventListener("fullscreenerror",f,!1);a.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT)},disableFullscreen:function(a){var c=function(){a();document.removeEventListener("fullscreenchange",c)};a&&document.addEventListener("fullscreenchange",c,!1);document.exitFullscreen()},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?
this.audioManager.suspend():this.audioManager.resume()},resizeCanvas:function(a,c){var e=window.innerWidth,d=window.innerHeight;if(navigator.isCocoonJS)a=e,c=d,e=window.devicePixelRatio,this.graphicsDevice.resizeCanvas(a*e,c*e);else{if(this.fillMode===pc.fw.FillMode.KEEP_ASPECT){var f=this.canvas.width/this.canvas.height;f>e/d?(a=e,c=a/f):(c=d,a=c*f)}else this.fillMode===pc.fw.FillMode.FILL_WINDOW&&(a=e,c=d);this.canvas.style.width=a+"px";this.canvas.style.height=c+"px";this.resolutionMode===pc.fw.ResolutionMode.AUTO&&
this.setCanvasResolution(pc.fw.ResolutionMode.AUTO)}return{width:a,height:c}},onLibrariesLoaded:function(){this.context.systems.rigidbody.onLibraryLoaded();this.context.systems.collision.onLibraryLoaded()},_handleMessage:function(a){var c;switch(a.type){case pc.fw.LiveLinkMessageType.UPDATE_COMPONENT:this._linkUpdateComponent(a.content.id,a.content.component,a.content.attribute,a.content.value);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY:this._linkUpdateEntity(a.content.id,a.content.components);
break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_TRANSFORM:this._linkUpdateEntityTransform(a.content.id,a.content.position,a.content.rotation,a.content.scale);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_NAME:c=this.context.root.findOne("getGuid",a.content.id);c.setName(a.content.name);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_ENABLED:c=this.context.root.findOne("getGuid",a.content.id);c.enabled=a.content.enabled;break;case pc.fw.LiveLinkMessageType.REPARENT_ENTITY:this._linkReparentEntity(a.content.id,
a.content.newParentId,a.content.index);break;case pc.fw.LiveLinkMessageType.CLOSE_ENTITY:if(c=this.context.root.findOne("getGuid",a.content.id))logDEBUG(pc.string.format("RT: Removed '{0}' from parent {1}",a.content.id,c.getParent().getGuid())),c.destroy();break;case pc.fw.LiveLinkMessageType.OPEN_PACK:a=this.context.loader.open(pc.resources.PackRequest,a.content.pack);c=a.hierarchy;c.__parent?(a=this.context.root.findByGuid(c.__parent),a.addChild(c)):this.context.root.addChild(c);break;case pc.fw.LiveLinkMessageType.OPEN_ENTITY:a.content.entity&&
(a={application_data:{},hierarchy:a.content.entity},a=this.context.loader.open(pc.resources.PackRequest,a),c=a.hierarchy,c.__parent?(a=this.context.root.findByGuid(c.__parent),a.addChild(c)):this.context.root.addChild(c));break;case pc.fw.LiveLinkMessageType.UPDATE_ASSET:this._linkUpdateAsset(a.content.id,a.content.attribute,a.content.value);break;case pc.fw.LiveLinkMessageType.UPDATE_ASSETCACHE:for(c in a.content.assets){var e=this.context.assets.getAssetById(c);e?pc.extend(e,a.content.assets[c]):
this.context.assets.createAndAddAsset(c,a.content.assets[c])}for(c in a.content.deleted)(e=this.context.assets.getAssetById(c))&&this.context.assets.removeAsset(e);break;case pc.fw.LiveLinkMessageType.UPDATE_PACK_SETTINGS:this._linkUpdatePackSettings(a.content.settings)}},_linkUpdateComponent:function(a,c,e,d){var a=this.context.root.findOne("getGuid",a),f;a&&(c?a[c]?(f=editor.link.exposed[c][e],editor&&f?f.RuntimeType?f.RuntimeType===pc.Vec3?a[c][e]=new f.RuntimeType(d[0],d[1],d[2]):f.RuntimeType===
pc.Vec4?a[c][e]=new f.RuntimeType(d[0],d[1],d[2],d[3]):f.RuntimeType===pc.Vec2?a[c][e]=new f.RuntimeType(d[0],d[1]):f.RuntimeType===pc.Color?a[c][e]=3===d.length?new f.RuntimeType(d[0],d[1],d[2]):new f.RuntimeType(d[0],d[1],d[2],d[3]):f.RuntimeType===pc.Curve||f.RuntimeType===pc.CurveSet?(a[c][e]=new f.RuntimeType(d.keys),a[c][e].type=d.type):a[c][e]=new f.RuntimeType(d):a[c][e]=d:a[c][e]=d):logWARNING(pc.string.format("No component system called '{0}' exists",c)):a[e]=d)},_linkUpdateEntityTransform:function(a,
c,e,d){if(a=this.context.root.findByGuid(a))a.setLocalPosition(c[0],c[1],c[2]),a.setLocalEulerAngles(e[0],e[1],e[2]),a.setLocalScale(d[0],d[1],d[2]),a.fire("livelink:updatetransform",c,e,d)},_linkReparentEntity:function(a,c,e){a=this.context.root.findByGuid(a);c=this.context.root.findByGuid(c);a.reparent(c,e)},_linkUpdateEntity:function(a,c){var e,d=this.context.root.findOne("getGuid",a);if(d){var f=this.context.systems.getComponentSystemOrder(),h,l=f.length;for(h=0;h<l;h++)e=f[h],c.hasOwnProperty(e)&&
this.context.systems.hasOwnProperty(e)&&(d[e]||this.context.systems[e].addComponent(d,{}));for(e in this.context.systems)"gizmo"===e||"pick"===e||this.context.systems.hasOwnProperty(e)&&!c.hasOwnProperty(e)&&d[e]&&this.context.systems[e].removeComponent(d)}},_linkUpdateAsset:function(a,c,e){if(a=this.context.assets.getAssetById(a))a[c]=e,a.fire("change",a,c,e)},_linkUpdatePackSettings:function(a){var c=a.render.global_ambient;this.context.scene.ambientLight.set(c[0],c[1],c[2]);this.context.systems.rigidbody&&
"undefined"!==typeof Ammo&&(c=a.physics.gravity,this.context.systems.rigidbody.setGravity(c[0],c[1],c[2]));this.context.scene.fog=a.render.fog;this.context.scene.fogStart=a.render.fog_start;this.context.scene.fogEnd=a.render.fog_end;c=a.render.fog_color;this.context.scene.fogColor=new pc.Color(c[0],c[1],c[2]);this.context.scene.fogDensity=a.render.fog_density;this.context.scene.shadowDistance=a.render.shadow_distance;this.context.scene.gammaCorrection=a.render.gamma_correction}};return{FillMode:{NONE:"NONE",
FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:"KEEP_ASPECT"},ResolutionMode:{AUTO:"AUTO",FIXED:"FIXED"},Application:a}}());pc.extend(pc.resources,function(){var d=function(a,c){this._registry=a;this._depot=c},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a){return new pc.promise.Promise(function(c,e){var d=a.canonical;d in pc.content.packs?setTimeout(function(){c(pc.content.packs[d])},0):this._depot.packs.getOne(d,function(a){c(a)}.bind(this),function(a){e(a)})}.bind(this))};d.prototype.open=function(a,c){return this.openPack(a,c)};d.prototype.openPack=function(a,c){var e=pc.extend({},a);e.hierarchy=
this.openEntity(e.hierarchy,c);return new pc.fw.Pack(e)};d.prototype.openEntity=function(a,c){var e;e=this.openEntityHierarchy(a,c);e.syncHierarchy();return e=this.openComponentData(e,a,c)};d.prototype.openEntityHierarchy=function(a,c){var e=new pc.fw.Entity,d=a.position,f=a.rotation,h=a.scale;e.setName(a.name);e.setGuid(a.resource_id);e.setLocalPosition(d[0],d[1],d[2]);e.setLocalEulerAngles(f[0],f[1],f[2]);e.setLocalScale(h[0],h[1],h[2]);e._enabled=void 0!==a.enabled?a.enabled:!0;e._enabledInHierarchy=
e._enabled;a.labels&&a.labels.forEach(function(a){e.addLabel(a)});e.__parent=a.parent;e.__children=a.children;e.name=a.name;e.template=a.template;h=a.children.length;for(d=0;d<h;d++)f=this.openEntityHierarchy(a.children[d],c),e.addChild(f);return e};d.prototype.openComponentData=function(a,c,e){a.setRequest(e);var d=this._registry.list(),f,h=d.length;for(f=0;f<h;f++){var l=c.components[d[f].id];l&&this._registry[d[f].id].addComponent(a,l)}a.setRequest(null);d=c.children.length;h=a.getChildren();for(f=
0;f<d;f++)h[f]=this.openComponentData(h[f],c.children[f],e);return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="pack";a.prototype.Type=pc.fw.Pack;return{PackResourceHandler:d,PackRequest:a}}());pc.extend(pc.fw,function(){var d=function(){};d.prototype={add:function(a,b){if(this[a])throw Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",a));this[a]=b;b.name=a},remove:function(a){if(!this[a])throw Error(pc.string.format("No ComponentSystem named '{0}' registered",a));delete this[a]},list:function(){var a=Object.keys(this),b={collisionrect:0.5,collisioncircle:0.5};a.sort(function(a,e){var d=b[a]||1,f=b[e]||1;return d<f?-1:d>f?1:0});return a.map(function(a){return this[a]},
this)},getComponentSystemOrder:function(){var a,b=Object.keys(this);a=b.indexOf("collisionrect");b.splice(a,1);b.unshift("collisionrect");a=b.indexOf("collisioncircle");b.splice(a,1);b.unshift("collisioncircle");return b}};return{ComponentSystemRegistry:d}}());pc.extend(pc.fw,function(){var d=function(a){this.context=a;this.dataStore={};this.schema=[];pc.events.attach(this)};pc.extend(d,{initialize:function(a){d.fire("initialize",a)},postInitialize:function(a){d.fire("postInitialize",a)},update:function(a,b,c){c?d.fire("toolsUpdate",a):d.fire("update",a)},fixedUpdate:function(a){d.fire("fixedUpdate",a)},postUpdate:function(a){d.fire("postUpdate",a)}});d.prototype={get store(){return this.dataStore},addComponent:function(a,b){var c=new this.ComponentType(this,
a),e=new this.DataType,b=b||{};this.dataStore[a.getGuid()]={entity:a,data:e};a[this.id]=c;a.c[this.id]=c;this.initializeComponentData(c,b,[]);this.fire("add",a,c);return c},removeComponent:function(a){var b=this.dataStore[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.dataStore[a.getGuid()];delete a[this.id];delete a.c[this.id];this.fire("remove",a,b.data)},cloneComponent:function(a,b){var c=this.dataStore[a.getGuid()];return this.addComponent(b,c.data)},initializeComponentData:function(a,
b,c){b=b||{};c.forEach(function(c){a[c]="undefined"!==typeof b[c]?b[c]:a.data[c]},this);if(a.enabled&&a.entity.enabled)a.onEnable()},exposeProperties:function(){editor.link.addComponentType(this);this.schema.forEach(function(a){!1!==a.exposed&&editor.link.expose(this.id,a)}.bind(this))}};pc.events.attach(d);return{ComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.system=a;this.entity=b;pc.events.attach(this);this.buildAccessors(this.system.schema);this.on("set",function(a,b,d){this.fire("set_"+a,a,b,d)});this.on("set_enabled",this.onSetEnabled,this)};d.prototype={get data(){var a=this.system.store[this.entity.getGuid()];return a?a.data:null},buildAccessors:function(a){a.forEach(function(a){a.readOnly?Object.defineProperty(this,a.name,{get:function(){return this.data[a.name]},configurable:!0}):Object.defineProperty(this,
a.name,{get:function(){return this.data[a.name]},set:function(c){var e=this.data,d=e[a.name];e[a.name]=c;this.fire("set",a.name,d,c)},configurable:!0})}.bind(this))},onSetEnabled:function(a,b,c){if(b!==c&&this.entity.enabled)if(c)this.onEnable();else this.onDisable()},onEnable:function(){},onDisable:function(){}};return{Component:d}}());pc.extend(pc.fw,function(){return{ComponentData:function(){}}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{play:function(a,b){if(this.data.animations[a]){if(this.enabled&&this.entity.enabled){var b=b||0,c=this.data;c.prevAnim=c.currAnim;c.currAnim=a;c.model&&(c.blending=0<b,c.blending?(c.blendTime=b,c.blendTimeRemaining=b,c.fromSkel.setAnimation(c.animations[c.prevAnim]),
c.fromSkel.addTime(c.skeleton.getCurrentTime()),c.toSkel.setAnimation(c.animations[c.currAnim])):c.skeleton.setAnimation(c.animations[c.currAnim]));c.playing=!0}}else console.error(pc.string.format("Trying to play animation '{0}' which doesn't exist",a))},getAnimation:function(a){return this.data.animations[a]},setModel:function(a){var b=this.data;if(a){var c=a.getGraph();b.fromSkel=new pc.anim.Skeleton(c);b.toSkel=new pc.anim.Skeleton(c);b.skeleton=new pc.anim.Skeleton(c);b.skeleton.setLooping(b.loop);
b.skeleton.setGraph(c)}b.model=a;b.animations&&(b.currAnim&&b.animations[b.currAnim])&&this.play(b.currAnim)},loadAnimationAssets:function(a){if(a&&a.length){for(var b={parent:this.entity.getRequest()},c=a.map(function(a){return this.system.context.assets.getAssetById(a)},this),e={},d=[],f=[],h=0,l=c.length;h<l;h++){var k=c[h];k?k.resource?e[k.name]=k.resource:(d.push(k.name),f.push(new pc.resources.AnimationRequest(k.getFileUrl()))):logERROR(pc.string.format("Trying to load animation component before assets {0} are loaded",
a))}f.length?this.system.context.loader.request(f,b).then(function(a){for(var b=0;b<f.length;b++)e[d[b]]=a[b];this.animations=e}.bind(this)):this.animations=e}},onSetAnimations:function(){var a=this.data,b=this.entity.model;b&&(b=b.model)&&this.entity.animation.setModel(b);for(var c in a.animations){a.activate&&(a.enabled&&this.entity.enabled)&&this.play(c,0);break}},onSetAssets:function(a,b,c){this.loadAnimationAssets(c)},onSetLoop:function(){this.data.skeleton&&this.data.skeleton.setLooping(this.data.loop)},
onSetCurrentTime:function(a,b,c){this.data.skeleton.setCurrentTime(c);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()},onEnable:function(){d._super.onEnable.call(this);if(this.data.activate&&!this.data.currAnim)for(var a in this.data.animations){this.play(a,0);break}}});Object.defineProperties(d.prototype,{currentTime:{get:function(){return this.data.skeleton.getCurrentTime()},set:function(a){this.data.skeleton.setCurrentTime(a);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()}},
duration:{get:function(){return this.data.animations[this.data.currAnim].getDuration()}}});return{AnimationComponent:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="animation";this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AnimationComponent;this.DataType=pc.fw.AnimationComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"assets",displayName:"Asset",description:"Animation Asset",type:"asset",
options:{max:100,type:"animation"},defaultValue:[]},{name:"speed",displayName:"Speed Factor",description:"Scale the animation playback speed",type:"number",options:{step:0.1},defaultValue:1},{name:"loop",displayName:"Loop",description:"Loop the animation back to the start on completion",type:"boolean",defaultValue:!0},{name:"activate",displayName:"Activate",description:"Play the configured animation on load",type:"boolean",defaultValue:!0},{name:"animations",exposed:!1},{name:"skeleton",exposed:!1,
readOnly:!0},{name:"model",exposed:!1,readOnly:!0},{name:"prevAnim",exposed:!1,readOnly:!0},{name:"currAnim",exposed:!1,readOnly:!0},{name:"fromSkel",exposed:!1,readOnly:!0},{name:"toSkel",exposed:!1,readOnly:!0},{name:"blending",exposed:!1,readOnly:!0},{name:"blendTime",exposed:!1,readOnly:!0},{name:"blendTimeRemaining",exposed:!1,readOnly:!0},{name:"playing",exposed:!1,readOnly:!0}];this.exposeProperties();this.on("remove",this.onRemove,this);this.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["activate","loop","speed","assets","enabled"];d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){this.addComponent(b,{});b.animation.data.assets=pc.extend([],a.animation.assets);b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=a.animation.enabled;
b.animation.animations=pc.extend({},a.animation.animations)},onRemove:function(a,b){delete b.animation;delete b.skeleton;delete b.fromSkel;delete b.toSkel},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var e=b[c],d=e.data;d.enabled&&(d.playing&&e.entity.enabled)&&(e=d.skeleton,null!==e&&null!==d.model&&(d.blending?(d.blendTimeRemaining-=a,0>d.blendTimeRemaining&&(d.blendTimeRemaining=0),e.blend(d.fromSkel,d.toSkel,1-d.blendTimeRemaining/d.blendTime)):(e.addTime(a*d.speed),
e.getCurrentTime()===e.getAnimation().getDuration()&&!d.loop&&(d.playing=!1)),d.blending&&0===d.blendTimeRemaining&&(d.blending=!1,e.setAnimation(d.toSkel.getAnimation())),e.updateGraph()))}}});return{AnimationComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.toSkel=this.fromSkel=this.currAnim=this.prevAnim=this.model=this.skeleton=this.animations=null;this.blending=!1;this.blendTimeRemaining=this.blendTime=0;this.playing=!1},pc.fw.ComponentData);return{AnimationComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="model";this.description="Renders a 3D model at the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.ModelComponent;this.DataType=pc.fw.ModelComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable rendering of the Model",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"Type of model",type:"enumeration",options:{enumerations:[{name:"Asset",value:"asset"},
{name:"Box",value:"box"},{name:"Capsule",value:"capsule"},{name:"Sphere",value:"sphere"},{name:"Cylinder",value:"cylinder"},{name:"Cone",value:"cone"},{name:"Plane",value:"plane"}]},defaultValue:"asset"},{name:"asset",displayName:"Asset",description:"Model Asset to render",type:"asset",options:{max:1,type:"model"},defaultValue:null,filter:{type:"asset"}},{name:"materialAsset",displayName:"Material",description:"The material of the model",type:"asset",options:{max:1,type:"material"},defaultValue:null,
filter:{type:function(){return!1}}},{name:"castShadows",displayName:"Cast shadows",description:"Occlude light",type:"boolean",defaultValue:!1},{name:"receiveShadows",displayName:"Receive shadows",description:"Receive shadows cast from occluders",type:"boolean",defaultValue:!0},{name:"material",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();a=a.graphicsDevice;this.box=pc.scene.procedural.createBox(a,{halfExtents:new pc.Vec3(0.5,0.5,0.5)});this.capsule=pc.scene.procedural.createCapsule(a,
{radius:0.5,height:2});this.sphere=pc.scene.procedural.createSphere(a,{radius:0.5});this.cone=pc.scene.procedural.createCone(a,{baseRadius:0.5,peakRadius:0,height:1});this.cylinder=pc.scene.procedural.createCylinder(a,{radius:0.5,height:1});this.plane=pc.scene.procedural.createPlane(a,{halfExtents:new pc.Vec2(0.5,0.5),widthSegments:1,lengthSegments:1});this.defaultMaterial=new pc.scene.PhongMaterial},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,
b,c){b.material=this.defaultMaterial;c="material materialAsset asset castShadows receiveShadows type enabled".split(" ");d._super.initializeComponentData.call(this,a,b,c)},removeComponent:function(a){var b=a.model.data;a.model.asset=null;"asset"!==b.type&&b.model&&(this.context.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null);d._super.removeComponent.call(this,a)},cloneComponent:function(a,b){this.addComponent(b,{});b.model.data.type=a.model.type;b.model.data.materialAsset=
a.model.materialAsset;b.model.data.asset=a.model.asset;b.model.data.castShadows=a.model.castShadows;b.model.data.receiveShadows=a.model.receiveShadows;b.model.data.material=a.model.material;b.model.data.enabled=a.model.enabled;a.model.model&&(b.model.model=a.model.model.clone())}});return{ModelComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_type",this.onSetType,this);this.on("set_asset",this.onSetAsset,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_model",this.onSetModel,this);this.on("set_receiveShadows",this.onSetReceiveShadows,this);this.on("set_material",this.onSetMaterial,this);Object.defineProperty(this,"materialAsset",{set:this.setMaterialAsset.bind(this),get:this.getMaterialAsset.bind(this)})},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,
{setVisible:function(a){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");this.enabled=a},loadModelAsset:function(a){function b(a){a=a[0];this.system.context.designer&&a.generateWireframe();e.on("change",this.onAssetChange,this);"asset"===this.data.type&&(this.model=a)}var c={parent:this.entity.getRequest()},e=this.system.context.assets.getAssetById(a);e?e.resource?(a=e.resource.clone(),b.call(this,[a])):this.system.context.assets.load(e,[],c).then(b.bind(this)):
logERROR(pc.string.format("Trying to load model before asset {0} is loaded.",a))},onSetType:function(a,b,c){a=this.data;if(c)if(b=null,"asset"===c)null!==this.data.asset?this.loadModelAsset(this.data.asset):this.model=null;else{switch(c){case "box":b=this.system.box;break;case "capsule":b=this.system.capsule;break;case "sphere":b=this.system.sphere;break;case "cone":b=this.system.cone;break;case "cylinder":b=this.system.cylinder;break;case "plane":b=this.system.plane;break;default:throw Error("Invalid model type: "+
c);}var c=new pc.scene.GraphNode,e=new pc.scene.Model;e.graph=c;e.meshInstances=[new pc.scene.MeshInstance(c,b,a.material)];this.system.context.designer&&e.generateWireframe();this.model=e;this.asset=null}},onSetAsset:function(a,b,c){b&&(a=this.system.context.assets.getAssetById(b))&&a.off("change",this.onAssetChange,this);"asset"===this.data.type&&(c?c instanceof pc.asset.Asset?(this.data.asset=c.id,this.loadModelAsset(c.id)):this.loadModelAsset(c):this.model=null)},onSetCastShadows:function(a,b,
c){if(a=this.data.model){var b=this.system.context.scene,e=b.containsModel(a);e&&b.removeModel(a);for(var d=a.meshInstances,f=0;f<d.length;f++)d[f].castShadow=c;e&&b.addModel(a)}},onSetModel:function(a,b,c){b&&(this.system.context.scene.removeModel(b),this.entity.removeChild(b.getGraph()),delete b._entity);if(c){for(var a=this.data,b=c.meshInstances,e=0;e<b.length;e++)b[e].castShadow=a.castShadows,b[e].receiveShadow=a.receiveShadows;this.entity.addChild(c.graph);this.enabled&&this.entity.enabled&&
this.system.context.scene.addModel(c);c._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(c)}},setMaterialAsset:function(a){var a="number"===typeof a||!a?a:a.id,b;if(void 0!==a&&null!==a){var c=this.system.context.assets.getAssetById(a);c?c.resource?this.material=b=c.resource:this.system.context.assets.load(c).then(function(a){this.material=a[0]}.bind(this)):console.error(pc.string.format("Entity '{0}' is trying to load Material Asset {1} which no longer exists. Maybe this model was once a primitive shape?",
this.entity.getName(),a))}b||(b=this.system.defaultMaterial);this.material=b;b=this.data.materialAsset;this.data.materialAsset=a;this.fire("set","materialAsset",b,a)},getMaterialAsset:function(){return this.system.context.assets.getAssetById(this.data.materialAsset)},onSetMaterial:function(a,b,c){if(c!==b&&(this.data.material=c,this.data.model&&"asset"!==this.data.type)){a=this.data.model.meshInstances;for(b=0;b<a.length;b++)a[b].material=c}},onSetReceiveShadows:function(a,b,c){if(void 0!==c&&(a=
this.data,a.model)){a=a.model.meshInstances;for(b=0;b<a.length;b++)a[b].receiveShadow=c}},onEnable:function(){d._super.onEnable.call(this);var a=this.data.model;a&&(this.system.context.scene.containsModel(a)||this.system.context.scene.addModel(a))},onDisable:function(){d._super.onDisable.call(this);var a=this.data.model;a&&this.system.context.scene.containsModel(a)&&this.system.context.scene.removeModel(a)},onAssetChange:function(a){a.resource=null;this.system.context.loader.removeFromCache(a.getFileUrl());
this.asset=null;this.asset=a.id}});return{ModelComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.type="asset";this.asset=null;this.castShadows=!1;this.receiveShadows=!0;this.model=this.material=this.materialAsset=null},pc.fw.ComponentData);return{ModelComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="skybox";this.description="Renders a skybox in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.fw.SkyboxComponent;this.DataType=pc.fw.SkyboxComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the component",type:"boolean",defaultValue:!0},{name:"posx",displayName:"POSX",description:"URL of the positive X face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},
{name:"negx",displayName:"NEGX",description:"URL of the negative X face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posy",displayName:"POSY",description:"URL of the positive Y face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negy",displayName:"NEGY",description:"URL of the negative Y face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posz",displayName:"POSZ",description:"URL of the positive Z face of skybox cubemap",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negz",displayName:"NEGZ",description:"URL of the negative Z face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"model",exposed:!1,readOnly:!0},{name:"assets",exposed:!1,readOnly:!0}];this.exposeProperties();this.on("remove",this.onRemove,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="enabled posx negx posy negy posz negz".split(" ");
d._super.initializeComponentData.call(this,a,b,c)},onRemove:function(a,b){b.model&&(this.context.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null)}});return{SkyboxComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set",this.onSet,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{onSet:function(b,c,e){function d(b,c){if(!(void 0===c||null===c)){var e=a.indexOf(b),f=this.entity.skybox.assets;this.data.model=null;f[e]=this.system.context.assets.getAssetById(c);if(f[e]){if(this.data.assets=f,f[0]&&f[1]&&f[2]&&f[3]&&f[4]&&f[5]){var e=this.data,g;a:{var r=this.entity,w=this.system.context;g=w.graphicsDevice;for(var s=[],G=[],x=[],u,v=0;v<f.length;v++)if(u=
f[v])if(u.resource){u=u.resource.getSource();if(!u){logERROR(pc.string.format("Trying to load skybox component with invalid texture types"));g=void 0;break a}s.push(u)}else x.push(v),G.push(new pc.resources.TextureRequest(u.getFileUrl()));else{logERROR(pc.string.format("Trying to load skybox component before assets are loaded"));g=void 0;break a}var z=new pc.gfx.Texture(g,{format:pc.gfx.PIXELFORMAT_R8_G8_B8,cubemap:!0});z.minFilter=pc.gfx.FILTER_LINEAR_MIPMAP_LINEAR;z.magFilter=pc.gfx.FILTER_LINEAR;
z.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;z.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;G.length?(f={parent:r.getRequest()},w.loader.request(G,f).then(function(a){for(var b=0;b<a.length;b++)s[x[b]]=a[b].getSource();z.setSource(s)})):z.setSource(s);f=g.getProgramLibrary().getProgram("skybox");w=new pc.scene.Material;w.setShader(f);w.setParameter("texture_cubeMap",z);w.cull=pc.gfx.CULLFACE_NONE;f=new pc.scene.GraphNode;g=pc.scene.procedural.createBox(g);g=new pc.scene.MeshInstance(f,g,w);w=new pc.scene.Model;
w.graph=f;w.meshInstances=[g];g=w}e.model=g;this.enabled&&this.entity.enabled&&(this.system.context.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))}}else logERROR(pc.string.format("Trying to load skybox component before asset {0} has loaded",c))}}var f={posx:function(a,b,c,e){d.call(this,b,e)},negx:function(a,b,c,e){d.call(this,b,e)},posy:function(a,b,c,e){d.call(this,b,e)},negy:function(a,b,c,e){d.call(this,b,e)},posz:function(a,b,c,e){d.call(this,b,e)},negz:function(a,
b,c,e){d.call(this,b,e)}};f[b]&&f[b].call(this,this.entity,b,c,e)},onEnable:function(){d._super.onEnable.call(this);this.data.model&&!this.system.context.scene.containsModel(this.data.model)&&(this.system.context.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))},onDisable:function(){d._super.onDisable.call(this);this.data.model&&this.system.context.scene.containsModel(this.data.model)&&(this.entity.removeChild(this.data.model.graph),this.system.context.scene.removeModel(this.data.model))}});
var a="posx negx posy negy posz negz".split(" ");return{SkyboxComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.negz=this.posz=this.negy=this.posy=this.negx=this.posx=null;this.assets=[];this.model=null},pc.fw.ComponentData);return{SkyboxComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="camera";this.description="Renders the scene from the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.CameraComponent;this.DataType=pc.fw.CameraComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"clearColorBuffer",displayName:"Clear Color Buffer",description:"Clear color buffer",type:"boolean",defaultValue:!0},{name:"clearColor",
displayName:"Clear Color",description:"Clear Color",type:"rgba",defaultValue:[0.7294117647058823,0.7294117647058823,0.6941176470588235,1],filter:{clearColorBuffer:!0}},{name:"clearDepthBuffer",displayName:"Clear Depth Buffer",description:"Clear depth buffer",type:"boolean",defaultValue:!0},{name:"projection",displayName:"Projection",description:"Projection type of camera",type:"enumeration",options:{enumerations:[{name:"Perspective",value:0},{name:"Orthographic",value:1}]},defaultValue:0},{name:"fov",
displayName:"Field of View",description:"Field of view in Y axis",type:"number",defaultValue:45,options:{min:0,max:90},filter:{projection:0}},{name:"orthoHeight",displayName:"Ortho Height",description:"View window half extent of camera in Y axis",type:"number",defaultValue:100,filter:{projection:1}},{name:"nearClip",displayName:"Near Clip",description:"Near clipping distance",type:"number",defaultValue:0.3,options:{min:1E-4,decimalPrecision:5}},{name:"farClip",displayName:"Far Clip",description:"Far clipping distance",
type:"number",defaultValue:1E3,options:{min:1E-4,decimalPrecision:5}},{name:"priority",displayName:"Priority",description:"Controls which camera will be rendered first. Smaller numbers are rendered first.",type:"number",defaultValue:0},{name:"rect",displayName:"Viewport",description:"Controls where on the screen the camera will be rendered in normalized coordinates.",type:"vector",defaultValue:[0,0,1,1]},{name:"camera",exposed:!1},{name:"aspectRatio",exposed:!1},{name:"model",exposed:!1},{name:"renderTarget",
exposed:!1}];this.exposeProperties();this.cameras=[];this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("toolsUpdate",this.toolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b=b||{};b.clearColor&&"array"===pc.type(b.clearColor)&&(c=b.clearColor,b.clearColor=new pc.Color(c[0],c[1],c[2],c[3]));b.rect&&"array"===pc.type(b.rect)&&(c=b.rect,b.rect=new pc.Vec4(c[0],c[1],c[2],c[3]));b.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),
b.enabled=b.activate);b.camera=new pc.scene.CameraNode;b.postEffects=new pc.posteffect.PostEffectQueue(this.context,a);if(this.context.designer&&this.displayInTools(a.entity)){c=new pc.scene.BasicMaterial;c.color=new pc.Color(1,1,0,1);c.update();var e=new pc.gfx.IndexBuffer(this.context.graphicsDevice,pc.gfx.INDEXFORMAT_UINT8,24);(new Uint8Array(e.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);e.unlock();var g=new pc.gfx.VertexFormat(this.context.graphicsDevice,[{semantic:pc.gfx.SEMANTIC_POSITION,
components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),f=new pc.gfx.VertexBuffer(this.context.graphicsDevice,g,8,pc.gfx.BUFFER_DYNAMIC),g=new pc.scene.Mesh;g.vertexBuffer=f;g.indexBuffer[0]=e;g.primitive[0].type=pc.gfx.PRIMITIVE_LINES;g.primitive[0].base=0;g.primitive[0].count=e.getNumIndices();g.primitive[0].indexed=!0;e=new pc.scene.Model;e.graph=b.camera;e.meshInstances=[new pc.scene.MeshInstance(e.graph,g,c)];this.context.scene.addModel(e);b.model=e}c="postEffects enabled model camera aspectRatio renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer rect".split(" ");
d._super.initializeComponentData.call(this,a,b,c)},onRemove:function(a,b){this.context.designer&&this.displayInTools(a)&&this.context.scene.containsModel(b.model)&&this.context.scene.removeModel(b.model);a.removeChild(b.camera);b.camera=null},toolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].entity;this.displayInTools(c)&&this._updateGfx(c.camera)}},_updateGfx:function(a){if(a.model&&a.model.meshInstances.length){var b=a.model.meshInstances[0].mesh.vertexBuffer,
c=a.camera.getAspectRatio(),e=this.isToolsCamera(a.entity)?0.5:a.nearClip,d=this.isToolsCamera(a.entity)?2:a.farClip,f=a.fov*Math.PI/180,h=a.projection,l;l=h===pc.scene.Projection.PERSPECTIVE?Math.tan(f/2)*e:a.camera.getOrthoHeight();var a=l*c,k=new Float32Array(b.lock());k[0]=a;k[1]=-l;k[2]=-e;k[3]=a;k[4]=l;k[5]=-e;k[6]=-a;k[7]=l;k[8]=-e;k[9]=-a;k[10]=-l;k[11]=-e;h===pc.scene.Projection.PERSPECTIVE&&(l=Math.tan(f/2)*d,a=l*c);k[12]=a;k[13]=-l;k[14]=-d;k[15]=a;k[16]=l;k[17]=-d;k[18]=-a;k[19]=l;k[20]=
-d;k[21]=-a;k[22]=-l;k[23]=-d;b.unlock()}},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority();if(this.context.designer&&(a=a.data.model)){var b=this.context.scene;b.containsModel(a)||b.addModel(a)}},removeCamera:function(a){var b=this.cameras.indexOf(a);0<=b&&(this.cameras.splice(b,1),this.sortCamerasByPriority(),this.context.designer&&(a=a.data.model)&&this.context.scene.removeModel(a))},sortCamerasByPriority:function(){this.cameras.sort(function(a,b){return a.priority-b.priority})},
isToolsCamera:function(a){return a.hasLabel("pc:designer")},displayInTools:function(a){return!this.isToolsCamera(a)||"Perspective"===a.getName()}});return{CameraComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,this);this.on("set_priority",this.onSetPriority,this);this.on("set_clearColorBuffer",
this.updateClearFlags,this);this.on("set_clearDepthBuffer",this.updateClearFlags,this);this.on("set_renderTarget",this.onSetRenderTarget,this);this.on("set_rect",this.onSetRect,this)},d=pc.inherits(d,pc.fw.Component);Object.defineProperty(d.prototype,"activate",{get:function(){console.warn("WARNING: activate: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: activate: Property is deprecated. Set enabled property instead.");this.enabled=
a}});pc.extend(d.prototype,{screenToWorld:function(a,b,c,e){var d=this.system.context.graphicsDevice,f=parseInt(d.canvas.clientWidth),d=parseInt(d.canvas.clientHeight);return this.data.camera.screenToWorld(a,b,c,f,d,e)},onSetAspectRatio:function(a,b,c){this.data.camera.setAspectRatio(c)},onSetCamera:function(a,b,c){b&&this.entity.removeChild(b);this.entity.addChild(c)},onSetClearColor:function(a,b,c){a=this.data.camera.getClearOptions();a.color[0]=c.r;a.color[1]=c.g;a.color[2]=c.b},onSetFov:function(a,
b,c){this.data.camera.setFov(c)},onSetOrthoHeight:function(a,b,c){this.data.camera.setOrthoHeight(c)},onSetNearClip:function(a,b,c){this.data.camera.setNearClip(c)},onSetFarClip:function(a,b,c){this.data.camera.setFarClip(c)},onSetProjection:function(a,b,c){this.data.camera.setProjection(c)},onSetPriority:function(){this.system.sortCamerasByPriority()},updateClearFlags:function(){var a=this.data.camera.getClearOptions(),b=0;this.clearColorBuffer&&(b|=pc.gfx.CLEARFLAG_COLOR);this.clearDepthBuffer&&
(b|=pc.gfx.CLEARFLAG_DEPTH);a.flags=b},onSetRenderTarget:function(a,b,c){this.data.camera.setRenderTarget(c)},onSetRect:function(a,b,c){this.data.camera.setRect(c.data[0],c.data[1],c.data[2],c.data[3]);this._resetAspectRatio()},onEnable:function(){d._super.onEnable.call(this);this.system.addCamera(this);this.postEffects.enable()},onDisable:function(){d._super.onDisable.call(this);this.postEffects.disable();this.system.removeCamera(this)},_resetAspectRatio:function(){var a=this.camera;if(a){var b=
this.system.context.graphicsDevice,c=this.rect,b=b.width*c.z/(b.height*c.w);b!==a.getAspectRatio()&&a.setAspectRatio(b)}},frameBegin:function(){this._resetAspectRatio();this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1}});return{CameraComponent:d}}());pc.extend(pc.fw,function(){CameraComponentData=function(){this.clearColor=new pc.Color(0.729411780834198,0.729411780834198,0.6941176652908325,1);this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=0.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.projection=pc.scene.Projection.PERSPECTIVE;this.priority=0;this.rect=new pc.Vec4(0,0,1,1);this.enabled=!0;this.camera=null;this.aspectRatio=16/9;this.postEffects=this.renderTarget=null;this.isRendering=!1};CameraComponentData=pc.inherits(CameraComponentData,
pc.fw.ComponentData);return{CameraComponentData:CameraComponentData}}());pc.extend(pc.fw,function(){var d=function(a){this.id="cubemap";a.systems.add(this.id,this);this.ComponentType=pc.fw.CubeMapComponent;this.DataType=pc.fw.CubeMapComponentData;this.schema=[{name:"enabled",type:"boolean",defaultValue:!0},{name:"cubemap",exposed:!1},{name:"camera",exposed:!1},{name:"targets",exposed:!1}];this.exposeProperties();pc.fw.ComponentSystem.on("update",this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b){var c=
new pc.gfx.Texture(this.context.graphicsDevice,{format:pc.gfx.PIXELFORMAT_R8_G8_B8,width:256,height:256,cubemap:!0});c.minFilter=pc.gfx.FILTER_LINEAR;c.magFilter=pc.gfx.FILTER_LINEAR;c.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;for(var e=[],g=0;6>g;g++){var f=new pc.gfx.RenderTarget(this.context.graphicsDevice,c,{face:g,depth:!0});e.push(f)}g=new pc.scene.CameraNode;g.setNearClip(0.01);g.setFarClip(1E4);g.setAspectRatio(1);b.cubemap=c;b.targets=e;b.camera=g;d._super.initializeComponentData.call(this,
a,b,["enabled","targets","cubemap","camera"])},onUpdate:function(){var a,b,c,e=this.store;for(a in e)if(e.hasOwnProperty(a)){b=e[a].entity;c=e[a].data;var d;b.model&&(d=b.model.model);if(d){var f=this.context.scene;f.removeModel(d);var h=[{target:[1,0,0],up:[0,-1,0]},{target:[-1,0,0],up:[0,-1,0]},{target:[0,1,0],up:[0,0,1]},{target:[0,-1,0],up:[0,0,-1]},{target:[0,0,1],up:[0,-1,0]},{target:[0,0,-1],up:[0,-1,0]}];b=b.getPosition();for(var l=c.camera,k=0;6>k;k++)l.setRenderTarget(c.targets[k]),l.setPosition(b),
l.lookAt(h[k].target,h[k].up),l.syncHierarchy(),f.render(l,this.context.graphicsDevice);f.addModel(d)}}}});return{CubeMapComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);return{CubeMapComponent:d}}());pc.extend(pc.fw,function(){CubeMapComponentData=function(){this.camera=null;this.nearClip=1;this.farClip=1E5;this.height=this.width=256;this.enabled=!0};CubeMapComponentData=pc.inherits(CubeMapComponentData,pc.fw.ComponentData);return{CubeMapComponentData:CubeMapComponentData}}());pc.extend(pc.fw,function(){var d=function(a){this.id="staticcubemap";a.systems.add(this.id,this);this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the component",type:"boolean",defaultValue:!0},{name:"posx",displayName:"POSX",description:"URL of the positive X face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negx",displayName:"NEGX",description:"URL of the negative X face of cubemap",type:"asset",options:{max:1,type:"texture"},
defaultValue:null},{name:"posy",displayName:"POSY",description:"URL of the positive Y face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negy",displayName:"NEGY",description:"URL of the negative Y face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posz",displayName:"POSZ",description:"URL of the positive Z face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negz",displayName:"NEGZ",description:"URL of the negative Z face of cubemap",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"assets",exposed:!1},{name:"cubemap",exposed:!1}];this.exposeProperties();this.ComponentType=pc.fw.StaticCubeMapComponent;this.DataType=pc.fw.StaticCubeMapComponentData},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="enabled posx negx posy negy posz negz".split(" ");d._super.initializeComponentData.call(this,a,b,c)}});return{StaticCubeMapComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set",this.onSet,this)},pc.fw.Component);pc.extend(d.prototype,{onSet:function(b,c,e){function d(b,c){if(!(void 0===c||null===c)){var e=a.indexOf(b),f=this.assets;this.cubemap=null;if(c&&(f[e]=this.system.context.assets.getAssetById(c),this.assets=f,f[0]&&f[1]&&f[2]&&f[3]&&f[4]&&f[5])){var g=f.map(function(a){return a.getFileUrl()}),f=this.entity,e=this.system.context,r=new pc.gfx.Texture(e.graphicsDevice,{format:pc.gfx.PIXELFORMAT_R8_G8_B8,
cubemap:!0});r.minFilter=pc.gfx.FILTER_LINEAR_MIPMAP_LINEAR;r.magFilter=pc.gfx.FILTER_LINEAR;r.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;r.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;g=g.map(function(a){return new pc.resources.ImageRequest(a)});f={parent:f.getRequest()};e.loader.request(g,f).then(function(a){r.setSource(a)});this.cubemap=r}}}var f={posx:function(a,b,c){d.call(this,a,c)},negx:function(a,b,c){d.call(this,a,c)},posy:function(a,b,c){d.call(this,a,c)},negy:function(a,b,c){d.call(this,a,c)},posz:function(a,
b,c){d.call(this,a,c)},negz:function(a,b,c){d.call(this,a,c)}};f[b]&&f[b].call(this,b,c,e)}});var a="posx negx posy negy posz negz".split(" ");return{StaticCubeMapComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.negz=this.posz=this.negy=this.posy=this.negx=this.posx=null;this.assets=[];this.cubemap=null},pc.fw.ComponentData);return{StaticCubeMapComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="light";this.description="Enables the Entity to emit light.";a.systems.add(this.id,this);this.ComponentType=pc.fw.LightComponent;this.DataType=pc.fw.LightComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the light",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of the light",type:"enumeration",options:{enumerations:[{name:"Directional",value:"directional"},{name:"Point",
value:"point"},{name:"Spot",value:"spot"}]},defaultValue:"directional"},{name:"color",displayName:"Color",description:"Light Color",type:"rgb",defaultValue:[1,1,1]},{name:"intensity",displayName:"Intensity",description:"The intensity of the light",type:"number",defaultValue:1,options:{min:0,max:10,step:0.05}},{name:"castShadows",displayName:"Cast Shadows",description:"Cast shadows from this light",type:"boolean",defaultValue:!1},{name:"shadowResolution",displayName:"Shadow Resolution",description:"Resolution of shadowmap generated by this light",
type:"enumeration",options:{enumerations:[{name:"128",value:128},{name:"256",value:256},{name:"512",value:512},{name:"1024",value:1024},{name:"2048",value:2048}]},defaultValue:1024,filter:{castShadows:!0}},{name:"range",displayName:"Range",description:"The distance from the light where its contribution falls to zero",type:"number",defaultValue:10,options:{min:0},filter:{type:["point","spot"]}},{name:"falloffMode",displayName:"Falloff mode",description:"Controls the rate at which a light attentuates from its position",
type:"enumeration",options:{enumerations:[{name:"Linear",value:pc.scene.LIGHTFALLOFF_LINEAR},{name:"Inverse squared",value:pc.scene.LIGHTFALLOFF_INVERSESQUARED}]},defaultValue:0,filter:{type:["point","spot"]}},{name:"innerConeAngle",displayName:"Inner Cone Angle",description:"Spotlight inner cone angle",type:"number",defaultValue:40,options:{min:0,max:90},filter:{type:"spot"}},{name:"outerConeAngle",displayName:"Outer Cone Angle",description:"Spotlight outer cone angle",type:"number",defaultValue:45,
options:{min:0,max:90},filter:{type:"spot"}},{name:"model",exposed:!1}];this.exposeProperties();this.implementations={};this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("toolsUpdate",this.toolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b.type||(b.type=a.data.type);a.data.type=b.type;b.color&&"array"===pc.type(b.color)&&(b.color=new pc.Color(b.color[0],b.color[1],b.color[2]));b.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),
b.enabled=b.enable);this._createImplementation(b.type).initialize(a,b);c="type model enabled color intensity range falloffMode innerConeAngle outerConeAngle castShadows shadowResolution".split(" ");d._super.initializeComponentData.call(this,a,b,c)},_createImplementation:function(a){var b=this.implementations[a];if(!b){switch(a){case "directional":b=new DirectionalLightImplementation(this);break;case "point":b=new PointLightImplementation(this);break;case "spot":b=new SpotLightImplementation(this);
break;default:throw Error("Invalid light type: "+a);}this.implementations[a]=b}return b},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},cloneComponent:function(a,b){this.addComponent(b,{type:a.light.type,enabled:a.light.enabled,color:[a.light.color.r,a.light.color.g,a.light.color.b],intensity:a.light.intensity,range:a.light.range,innerConeAngle:a.light.innerConeAngle,outerConeAngle:a.light.outerConeAngle,castShadows:a.light.castShadows,shadowResolution:a.light.shadowResolution,falloffMode:a.light.falloffMode})},
toolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].data,e=this.implementations[c.type];e&&e.toolsUpdate(c)}},changeType:function(a,b,c){this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).initialize(a,a.data)}});LightComponentImplementation=function(a){this.system=a};LightComponentImplementation.prototype={initialize:function(a,b){var c=this._createLightNode(a,b);this._createDebugShape(a,b,c)},_createLightNode:function(a,b){var c=new pc.scene.LightNode;
c.setName(b.type+"light");c.setType(this._getLightType());return c},_getLightType:function(){},_createDebugShape:function(a,b,c){var e=this.system.context,d=new pc.scene.Model;d.graph=c;d.lights=[c];e.designer&&(this.mesh=this._createDebugMesh(),this.material||(this.material=this._createDebugMaterial()),d.meshInstances=[new pc.scene.MeshInstance(c,this.mesh,this.material)]);e.scene.addModel(d);a.entity.addChild(c);b=b||{};b.model=d},_createDebugMesh:function(){},_createDebugMaterial:function(){},
remove:function(a,b){var c=this.system.context;a.removeChild(b.model.graph);c.scene.removeModel(b.model);delete b.model},toolsUpdate:function(){}};DirectionalLightImplementation=function(){};DirectionalLightImplementation=pc.inherits(DirectionalLightImplementation,LightComponentImplementation);DirectionalLightImplementation.prototype=pc.extend(DirectionalLightImplementation.prototype,{_getLightType:function(){return pc.scene.LIGHTTYPE_DIRECTIONAL},_createDebugMesh:function(){if(this.mesh)return this.mesh;
var a=this.system.context,b=new pc.gfx.VertexFormat(a.graphicsDevice,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]);vertexData=[0,0,0,0,-8,0,-0.5,-8,0,0.5,-8,0,0.5,-8,0,0,-10,0,0,-10,0,-0.5,-8,0,0,0,-2,0,-8,-2,-0.25,-8,-2,0.25,-8,-2,0.25,-8,-2,0,-10,-2,0,-10,-2,-0.25,-8,-2,0,0,2,0,-8,2,-0.25,-8,2,0.25,-8,2,0.25,-8,2,0,-10,2,0,-10,2,-0.25,-8,2];var c=(new pc.Mat4).setFromAxisAngle(pc.Vec3.UP,120),e;for(e=0;24>e;e++){var d=new pc.Vec3(vertexData[3*(e+8)],vertexData[3*
(e+8)+1],vertexData[3*(e+8)+2]),d=c.transformPoint(d,d);vertexData[3*(e+24)]=d[0];vertexData[3*(e+24)+1]=d[1];vertexData[3*(e+24)+2]=d[2]}a=new pc.gfx.VertexBuffer(a.graphicsDevice,b,32);b=new Float32Array(a.lock());for(e=0;e<vertexData.length;e++)b[e]=vertexData[e];a.unlock();e=new pc.scene.Mesh;e.vertexBuffer=a;e.indexBuffer[0]=null;e.primitive[0].type=pc.gfx.PRIMITIVE_LINES;e.primitive[0].base=0;e.primitive[0].count=a.getNumVertices();e.primitive[0].indexed=!1;return e},_createDebugMaterial:function(){var a=
new pc.scene.BasicMaterial;a.color=new pc.Color(1,1,0,1);a.update();return a}});PointLightImplementation=function(){};PointLightImplementation=pc.inherits(PointLightImplementation,LightComponentImplementation);PointLightImplementation.prototype=pc.extend(PointLightImplementation.prototype,{_getLightType:function(){return pc.scene.LIGHTTYPE_POINT},_createDebugMesh:function(){return this.mesh?this.mesh:pc.scene.procedural.createSphere(this.system.context.graphicsDevice,{radius:0.1})},_createDebugMaterial:function(){var a=
new pc.scene.BasicMaterial;a.color=new pc.Color(1,1,0,1);a.update();return a}});SpotLightImplementation=function(){};SpotLightImplementation=pc.inherits(SpotLightImplementation,LightComponentImplementation);SpotLightImplementation.prototype=pc.extend(SpotLightImplementation.prototype,{_getLightType:function(){return pc.scene.LIGHTTYPE_SPOT},_createDebugMesh:function(){var a=this.system.context,b=this.indexBuffer;if(!b){var b=new pc.gfx.IndexBuffer(a.graphicsDevice,pc.gfx.INDEXFORMAT_UINT8,88),c=new Uint8Array(b.lock());
c[0]=0;c[1]=1;c[2]=0;c[3]=11;c[4]=0;c[5]=21;c[6]=0;c[7]=31;for(var e=0;40>e;e++)c[2*e+8]=e+1,c[2*e+9]=e+2;b.unlock();this.indexBuffer=b}c=new pc.gfx.VertexFormat(a.graphicsDevice,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]);a=new pc.gfx.VertexBuffer(a.graphicsDevice,c,42,pc.gfx.BUFFER_DYNAMIC);c=new pc.scene.Mesh;c.vertexBuffer=a;c.indexBuffer[0]=b;c.primitive[0].type=pc.gfx.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=b.getNumIndices();c.primitive[0].indexed=
!0;return c},_createDebugMaterial:function(){return new pc.scene.BasicMaterial},toolsUpdate:function(a){var b=a.model.meshInstances[0].mesh.vertexBuffer,c=Math.PI*a.outerConeAngle/180,e=a.range,a=-e*Math.cos(c),c=e*Math.sin(c),e=new Float32Array(b.lock());e[0]=0;e[1]=0;e[2]=0;for(var d=b.getNumVertices(),f=0;f<d-1;f++){var h=2*Math.PI*(f/(d-2)),l=c*Math.cos(h),h=c*Math.sin(h);e[3*(f+1)+0]=l;e[3*(f+1)+1]=a;e[3*(f+1)+2]=h}b.unlock()}});return{LightComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_type",this.onSetType,this);this.on("set_color",this.onSetColor,this);this.on("set_intensity",this.onSetIntensity,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_shadowResolution",this.onSetShadowResolution,this);this.on("set_range",this.onSetRange,this);this.on("set_innerConeAngle",this.onSetInnerConeAngle,this);this.on("set_outerConeAngle",this.onSetOuterConeAngle,this);this.on("set_falloffMode",this.onSetFalloffMode,
this)},d=pc.inherits(d,pc.fw.Component);Object.defineProperty(d.prototype,"enable",{get:function(){console.warn("WARNING: enable: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");this.enabled=a}});pc.extend(d.prototype,{onSetType:function(a,b,c){b!==c&&(this.system.changeType(this,b,c),this.refreshProperties())},refreshProperties:function(){this.onSetCastShadows("castShadows",
this.castShadows,this.castShadows);this.onSetColor("color",this.color,this.color);this.onSetIntensity("intensity",this.intensity,this.intensity);this.onSetShadowResolution("shadowResolution",this.shadowResolution,this.shadowResolution);this.onSetRange("range",this.range,this.range);this.onSetInnerConeAngle("innerConeAngle",this.innerConeAngle,this.innerConeAngle);this.onSetOuterConeAngle("outerConeAngle",this.outerConeAngle,this.outerConeAngle);this.onSetFalloffMode("falloffMode",this.falloffMode,
this.falloffMode);if(this.enabled&&this.entity.enabled)this.onEnable()},onSetCastShadows:function(a,b,c){this.data.model.lights[0].setCastShadows(c)},onSetColor:function(a,b,c){this.data.model.lights[0].setColor(c)},onSetIntensity:function(a,b,c){this.data.model.lights[0].setIntensity(c)},onSetShadowResolution:function(a,b,c){this.data.model.lights[0].setShadowResolution(c)},onSetRange:function(a,b,c){("point"===this.data.type||"spot"===this.data.type)&&this.data.model.lights[0].setAttenuationEnd(c)},
onSetInnerConeAngle:function(a,b,c){"spot"===this.data.type&&this.data.model.lights[0].setInnerConeAngle(c)},onSetOuterConeAngle:function(a,b,c){"spot"===this.data.type&&this.data.model.lights[0].setOuterConeAngle(c)},onSetFalloffMode:function(a,b,c){("point"===this.data.type||"spot"===this.data.type)&&this.data.model.lights[0].setFalloffMode(c)},onEnable:function(){d._super.onEnable.call(this);var a=this.data.model;a.lights[0].setEnabled(!0);var b=this.system.context.scene;b.containsModel(a)||b.addModel(a)},
onDisable:function(){d._super.onDisable.call(this);var a=this.data.model;a.lights[0].setEnabled(!1);this.system.context.scene.removeModel(a)}});return{LightComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.type="directional";this.enabled=!0;this.color=new pc.Color(1,1,1);this.intensity=1;this.castShadows=!1;this.shadowResolution=1024;this.range=10;this.innerConeAngle=40;this.outerConeAngle=45;this.falloffMode=pc.scene.LIGHTFALLOFF_LINEAR;this.model=null},pc.fw.ComponentData);return{LightComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="script";this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.";a.systems.add(this.id,this);this.ComponentType=pc.fw.ScriptComponent;this.DataType=pc.fw.ScriptComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled components are not updated",type:"boolean",defaultValue:!0},{name:"scripts",displayName:"URLs",description:"Attach scripts to this Entity",type:"script",defaultValue:[]},
{name:"instances",exposed:!1},{name:"runInTools",description:"Allows scripts to be loaded and executed while in the tools",defaultValue:!1,exposed:!1}];this.exposeProperties();this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("beforeremove",this.onBeforeRemove,this);pc.fw.ComponentSystem.on("initialize",this.onInitialize,this);pc.fw.ComponentSystem.on("postInitialize",this.onPostInitialize,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this);pc.fw.ComponentSystem.on("fixedUpdate",this.onFixedUpdate,this);pc.fw.ComponentSystem.on("postUpdate",this.onPostUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["runInTools","enabled","scripts"];d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){var c=this.dataStore[a.getGuid()],c={runInTools:c.data.runInTools,scripts:pc.extend([],
c.data.scripts),enabled:c.data.enabled};return this.addComponent(b,c)},onBeforeRemove:function(a,b){b.enabled&&this._disableScriptComponent(b);this._destroyScriptComponent(b)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&a.script.enabled&&this._postInitializeScriptComponent(a.script);
var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onPostInitialize(a[b])}},_callInstancesMethod:function(a,b){var c=a.data.instances,e;for(e in c)if(c.hasOwnProperty(e)){var d=c[e].instance;d[b]&&d[b].call(d)}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,"onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,
"onDisable")},_destroyScriptComponent:function(a){var b,c=a.data.instances,e;for(e in c)if(c.hasOwnProperty(e)){var d=c[e].instance;d.destroy&&d.destroy();d.update&&(b=this.instancesWithUpdate.indexOf(d),0<=b&&this.instancesWithUpdate.splice(b,1));d.fixedUpdate&&(b=this.instancesWithFixedUpdate.indexOf(d),0<=b&&this.instancesWithFixedUpdate.splice(b,1));d.postUpdate&&(b=this.instancesWithPostUpdate.indexOf(d),0<=b&&this.instancesWithPostUpdate.splice(b,1));d.toolsUpdate&&(b=this.instancesWithToolsUpdate.indexOf(d),
0<=b&&this.instancesWithToolsUpdate.splice(b,1));a.instances[e].instance===a[e]&&delete a[e];delete a.instances[e]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,b,c){for(var e,d=0,f=b.length;d<f;d++)(e=b[d])&&(e.entity.script.enabled&&e.entity.enabled)&&e[a].call(e,c)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",
this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,b){var c=pc.makeArray(arguments).slice(2),e,d,f,h=this.store;for(e in h)h.hasOwnProperty(e)&&(d=h[e].data,d.instances[a]&&(f=d.instances[a].instance[b])&&f.apply(d.instances[a].instance,c))},_preRegisterInstance:function(a,b,c,e){if(a.script){a.script.data._instances=
a.script.data._instances||{};if(a.script.data._instances[c])throw Error(pc.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}",c,b,a.script.data._instances[c].url,a.getGuid()));a.script.data._instances[c]={url:b,name:c,instance:e}}},_registerInstances:function(a){var b,c,e;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(e in a.script.instances){b=a.script.instances[e];c=b.instance;pc.events.attach(c);c.update&&this.instancesWithUpdate.push(c);
c.fixedUpdate&&this.instancesWithFixedUpdate.push(c);c.postUpdate&&this.instancesWithPostUpdate.push(c);c.toolsUpdate&&this.instancesWithToolsUpdate.push(c);a.script.scripts&&this._createAccessors(a,b);if(a.script[e])throw Error(pc.string.format("Script with name '{0}' is already attached to Script Component",e));a.script[e]=c}delete a.script.data._instances}a=a.getChildren();c=a.length;for(b=0;b<c;b++)a[b]instanceof pc.fw.Entity&&this._registerInstances(a[b])},_createAccessors:function(a,b){var c=
this,e,d=a.script.scripts.length,f=b.url;for(e=0;e<d;e++){var h=a.script.scripts[e];if(h.url===f){e=h.attributes;h.name&&e&&(e.forEach(function(a){c._createAccessor(a,b)}),a.script.data.attributes[h.name]=pc.extend([],e));break}}},_createAccessor:function(a,b){var c=this;c._convertAttributeValue(a);Object.defineProperty(b.instance,a.name,{get:function(){return a.value},set:function(e){var d=a.value;a.value=e;c._convertAttributeValue(a);b.instance.fire("set",a.name,d,a.value)},configurable:!0})},_updateAccessors:function(a,
b){var c=this,e,d,f;f=a.script.scripts.length;var h=b.url,l,k,n,m;for(e=0;e<f;e++)if(l=a.script,d=l.scripts[e],d.url===h){e=d.name;h=d.attributes;if(e){h&&h.forEach(function(a){c._createAccessor(a,b)});if(k=l.data.attributes[e])for(d=k.length;d--;){n=k[d];m=null;for(f=h.length;f--;)if(n.name===h[f].name){m=h[f];break}if(m){if(n.value!==m.value&&b.instance.onAttributeChanged)b.instance.onAttributeChanged(n.name,n.value,m.value)}else delete b.instance[n.name]}h?l.data.attributes[e]=pc.extend([],h):
delete l.data.attributes[e]}break}},_convertAttributeValue:function(a){"rgb"===a.type||"rgba"===a.type?"array"===pc.type(a.value)&&(a.value=3===a.value.length?new pc.Color(a.value[0],a.value[1],a.value[2]):new pc.Color(a.value[0],a.value[1],a.value[2],a.value[3])):"vector"===a.type&&"array"===pc.type(a.value)&&(a.value=new pc.Vec3(a.value[0],a.value[1],a.value[2]))}});return{ScriptComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_scripts",this.onSetScripts,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{send:function(a,b){var c=pc.makeArray(arguments).slice(2),e=this.entity.script.instances,d;if(e&&e[a]&&(d=e[a].instance[b]))return d.apply(e[a].instance,c)},onEnable:function(){d._super.onEnable.call(this);this.data.areScriptsLoaded&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||
this.system._postInitializeScriptComponent(this))},onDisable:function(){d._super.onDisable.call(this);this.system._disableScriptComponent(this)},onSetScripts:function(a,b,c){if((!this.system._inTools||this.runInTools)&&!this._updateScriptAttributes(b,c))this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1,a=c.map(function(a){return a.url}),this._loadFromCache(a)||this._loadScripts(a)},_updateScriptAttributes:function(a,b){var c=
!0;if(a.length!==b.length)c=!1;else{var e;len=b.length;for(e=0;e<len;e++)if(a[e].url!==b[e].url){c=!1;break}}if(c)for(var d in this.instances)this.instances.hasOwnProperty(d)&&this.system._updateAccessors(this.entity,this.instances[d]);return c},_loadFromCache:function(a){for(var b=[],c=0,e=a.length;c<e;c++){var d=this.system.context.loader.getFromCache(a[c]);if(d)b.push(d);else return!1}c=0;for(e=b.length;c<e;c++)if(d=b[c],!0!=d&&d&&this.entity.script&&!this.entity.script.instances[d._pcScriptName]){var f=
new d(this.entity);this.system._preRegisterInstance(this.entity,a[c],d._pcScriptName,f)}this.data&&(this.data.areScriptsLoaded=!0);this.system.onInitialize(this.entity);this.system.onPostInitialize(this.entity);return!0},_loadScripts:function(a){var b=a.map(function(a){return new pc.resources.ScriptRequest(a)}),c={parent:this.entity.getRequest()};this.system.context.loader.request(b,c).then(function(b){b.forEach(function(b,c){if(b&&this.entity.script&&!this.entity.script.instances[b._pcScriptName]){var e=
new b(this.entity);this.system._preRegisterInstance(this.entity,a[c],b._pcScriptName,e)}},this);this.data&&(this.data.areScriptsLoaded=!0);c.parent||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity))}.bind(this)).then(null,function(a){setTimeout(function(){throw a;})})}});return{ScriptComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1},pc.fw.ComponentData);return{ScriptComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="pack";a.systems.add(this.id,this);this.ComponentType=pc.fw.PackComponent;this.DataType=pc.fw.PackComponentData;this.schema=[]},d=pc.inherits(d,pc.fw.ComponentSystem);return{PackComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);return{PackComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.ComponentData);return{PackComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="pick";a.systems.add(this.id,this);this.ComponentType=pc.fw.PickComponent;this.DataType=pc.fw.PickComponentData;this.schema=[{name:"layer",exposed:!1},{name:"shapes",exposed:!1},{name:"material",exposed:!1}];this.layers={"default":[]};this.display=!1;this.on("remove",this.onRemove,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b.material=new pc.scene.PhongMaterial;c=["material"];d._super.initializeComponentData.call(this,
a,b,c)},onRemove:function(a,b){this.deleteShapes(b.layer,b.shapes)},addShape:function(a,b){void 0===this.layers[a]&&(this.layers[a]=[]);this.layers[a].push(b.model);this.display&&this.context.scene.addModel(b.model)},deleteShapes:function(a,b){for(var c=this.layers[a],e=0;e<b.length;e++){var d=b[e].model,f=c.indexOf(d);-1!==f&&c.splice(f,1);this.display&&this.context.scene.removeModel(d)}},getLayerModels:function(a){return this.layers[a]}});return{PickComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);pc.extend(d.prototype,{addShape:function(a,b){var c=this.data.material,e=null;switch(a.type){case pc.shape.Type.BOX:e=pc.scene.procedural.createBox(this.system.context.graphicsDevice,{halfExtents:a.halfExtents});break;case pc.shape.Type.SPHERE:e=pc.scene.procedural.createSphere(this.system.context.graphicsDevice,{radius:a.radius});break;case pc.shape.Type.TORUS:e=pc.scene.procedural.createTorus(this.system.context.graphicsDevice,
{tubeRadius:a.iradius,ringRadius:a.oradius})}var d=new pc.scene.GraphNode,c=new pc.scene.MeshInstance(d,e,c);c._entity=this.entity;e=new pc.scene.Model;e.graph=d;e.meshInstances=[c];a={shape:a,shapeName:b,model:e};this.data.shapes.push(a);this.system.addShape(this.data.layer,a)},deleteShapes:function(){this.system.deleteShapes(this.data.layer,this.data.shapes);this.data.shapes=[]}});return{PickComponent:d}}());pc.extend(pc.fw,function(){function d(){this.layer="default";this.shapes=[];this.material=null}d=pc.inherits(d,pc.fw.ComponentData);return{PickComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.id="audiosource";this.description="Specifies audio assets that can be played at the position of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AudioSourceComponent;this.DataType=pc.fw.AudioSourceComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled audiosource components do not play any sounds",type:"boolean",defaultValue:!0},{name:"assets",displayName:"Assets",description:"Audio assets",type:"asset",
options:{max:100,type:"audio"},defaultValue:[]},{name:"volume",displayName:"Volume",description:"The sound volume",type:"number",options:{max:1,min:0,step:0.1},defaultValue:1},{name:"pitch",displayName:"Pitch",description:"The sound pitch",type:"number",defaultValue:1,options:{min:0.01,step:0.01}},{name:"loop",displayName:"Loop",description:"Set whether sound loops or not",type:"boolean",defaultValue:!1},{name:"activate",displayName:"Activate",description:"Play first audio sample when scene loads",
type:"boolean",defaultValue:!0},{name:"3d",displayName:"3d",description:"3d sounds are positioned in space, and their sound is dependent on listener position/orientation. Non-3d sounds are uniform across space",type:"boolean",defaultValue:!0},{name:"minDistance",displayName:"Min Distance",description:"Distance from listener under which the sound is at full volume",type:"number",defaultValue:1,options:{min:0}},{name:"maxDistance",displayName:"Max Distance",description:"Distance from listener over which the sound cannot be heard",
type:"number",defaultValue:1E4,options:{min:0}},{name:"rollOffFactor",displayName:"Roll-off factor",description:"Strength of the roll off",type:"number",defaultValue:1,options:{min:0}},{name:"sources",exposed:!1,readOnly:!0},{name:"currentSource",exposed:!1,readOnly:!0},{name:"channel",exposed:!1,readOnly:!0}];this.exposeProperties();this.manager=b;this.initialized=!1;pc.fw.ComponentSystem.on("initialize",this.onInitialize,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this)},d=pc.inherits(d,
pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="activate volume pitch loop 3d minDistance maxDistance rollOffFactor enabled assets".split(" ");d._super.initializeComponentData.call(this,a,b,c);a.paused=!(a.enabled&&a.activate)},onInitialize:function(a){a.audiosource&&(a.enabled&&a.audiosource.enabled&&a.audiosource.activate)&&a.audiosource.play(a.audiosource.currentSource);var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onInitialize(a[b]);
this.initialized=!0},onUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b],e=c.entity,c=c.data;c.enabled&&(e.enabled&&c.channel instanceof pc.audio.Channel3d)&&(e=e.getPosition(),c.channel.setPosition(e))}},setVolume:function(a){this.manager.setVolume(a)}});return{AudioSourceComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&
this.stop();var b,c=this.data;c.sources[a]&&(c.sources[a].isLoaded?(c["3d"]?(b=this.entity.getPosition(),b=this.system.manager.playSound3d(c.sources[a],b,c)):b=this.system.manager.playSound(c.sources[a],c),c.currentSource=a,c.channel=b):logWARNING(pc.string.format("Audio asset '{0}' is not loaded (probably an unsupported format) and will not be played",a)))}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&
(this.channel.stop(),this.channel=null)},onSetAssets:function(a,b,c){var a=[],e,d=c.length;if(d)for(e=0;e<d;e++)0>b.indexOf(c[e])&&a.push(c[e]);!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},onSetLoop:function(a,b,c){b!=c&&this.channel&&this.channel.setLoop(c)},onSetVolume:function(a,b,c){b!=c&&this.channel&&this.channel.setVolume(c)},onSetPitch:function(a,b,c){b!=c&&this.channel&&this.channel.setPitch(c)},onSetMaxDistance:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&
this.channel.setMaxDistance(c)},onSetMinDistance:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&this.channel.setMinDistance(c)},onSetRollOffFactor:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&this.channel.setRollOffFactor(c)},onEnable:function(){d._super.onEnable.call(this);this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){d._super.onDisable.call(this);this.pause()},loadAudioSourceAssets:function(a){var b=
{parent:this.entity.getRequest()},c=[],e=[],d={},f=null;a.map(function(a){return this.system.context.assets.getAssetById(a)},this).forEach(function(b){b?(f=f||b.name,b.resource?d[b.name]=b.resource:(c.push(new pc.resources.AudioRequest(b.getFileUrl())),e.push(b.name))):logERROR(pc.string.format("Trying to load audiosource component before assets {0} are loaded",a))});if(c.length)this.system.context.loader.request(c,b).then(function(a){for(var l=0;l<c.length;l++)d[e[l]]=a[l];this.data.sources=d;this.data.currentSource=
f;if(!b.parent&&this.enabled&&this.activate&&f)this.onEnable()}.bind(this));else if(this.data.sources=d,this.data.currentSource=f,this.enabled&&this.activate&&f)this.onEnable()}});return{AudioSourceComponent:d}}());pc.fw.AudioSourceComponentData=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.paused=!0;this.sources={};this.channel=this.currentSource=null};pc.extend(pc.fw,function(){var d=function(a,b){this.id="audiolistener";this.description="Specifies the location of the listener for 3D audio playback.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AudioListenerComponent;this.DataType=pc.fw.AudioListenerComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled audio listener components do not affect audiosources",type:"boolean",defaultValue:!0}];this.exposeProperties();this.manager=b;this.current=null;pc.fw.ComponentSystem.on("update",
this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["enabled"];d._super.initializeComponentData.call(this,a,b,c)},onUpdate:function(){if(this.current){var a=this.current.getPosition();this.manager.listener.setPosition(a);a=this.current.getWorldTransform();this.manager.listener.setOrientation(a)}}});return{AudioListenerComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},onEnable:function(){d._super.onEnable.call(this);this.setCurrentListener()},onDisable:function(){d._super.onDisable.call(this);this.system.current===this.entity&&(this.system.current=null)}});
return{AudioListenerComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0},pc.fw.ComponentData);return{AudioListenerComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){a.systems.add("designer",this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype.createComponent=function(a,b){var c=new pc.fw.DesignerComponentData;this.initializeComponent(a,c,b,["fillWindow","width","height"]);return c};return{DesignerComponentSystem:d}}());pc.extend(pc.fw,function(){DesignerComponentData=function(){this.fillWindow=!0;this.width=800;this.height=450};DesignerComponentData=pc.inherits(DesignerComponentData,pc.fw.ComponentData);return{DesignerComponentData:DesignerComponentData}}());pc.extend(pc.fw,function(){var d=new pc.Vec3,a=new pc.Vec3,b,c,e,g,f,h=function(a){"undefined"!==typeof Box2D&&!c&&(c=Box2D.Dynamics.b2World,e=Box2D.Common.Math.b2Vec2,g=Box2D.Dynamics.b2Body,f=Box2D.Dynamics.b2BodyDef,b=new e);this.id="body2d";a.systems.add(this.id,this);this.ComponentType=pc.fw.Body2dComponent;this.DataType=pc.fw.Body2dComponentData;this.schema=[{name:"static",displayName:"Static",description:"Static bodies are immovable and do not collide with other static bodies.",type:"boolean",
defaultValue:!0},{name:"body",exposed:!1,readOnly:!0},{name:"bodyDef",exposed:!1,readOnly:!0}];this.exposeProperties();this._rayStart=new pc.Vec3;this._rayEnd=new pc.Vec3;this.time=0;this.step=1/60;this.xi=0;this.yi=2;this.ri=1;c&&(this.b2World=new c(new e(0,0),!0),pc.fw.ComponentSystem.on("update",this.onUpdate,this));this.on("remove",this.onRemove,this)},h=pc.inherits(h,pc.fw.ComponentSystem);pc.extend(h.prototype,{initializeComponentData:function(a,b,c){c=["static"];h._super.initializeComponentData.call(this,
a,b,c);"undefined"!==typeof Box2D&&this.createBody(a)},createBody:function(b){if(b.entity.collisionrect||b.entity.collisioncircle){var c=new f;d.copy(b.entity.getPosition());a.copy(b.entity.getEulerAngles());c.type=b.static?g.b2_staticBody:g.b2_dynamicBody;c.position.Set(d.data[this.xi],d.data[this.yi]);var e=b._eulersToAngle(a);c.angle=-e*pc.math.DEG_TO_RAD;c.userData=b.entity;b.data.bodyDef=c}b.data.body&&this.removeBody(b.entity,b.data.body);b.data.body=b.entity.collisionrect?this.addBody(b.bodyDef,
b.entity.collisionrect.fixtureDef):b.entity.collisioncircle?this.addBody(b.bodyDef,b.entity.collisioncircle.fixtureDef):null},onRemove:function(a,b){b.body&&this.removeBody(a,b.body);b.body=null},to2d:function(a,b){b=b||new e;return b.Set(a[this.xi],a[this.yi])},addBody:function(a,b){var c=this.b2World.CreateBody(a);c.CreateFixture(b);return c},removeBody:function(a,b){this.b2World.DestroyBody(b);a.body2d.body&&(a.body2d.data.body=null)},setGravity:function(a,c){b.Set(a,c);this.b2World.SetGravity(b)},
raycast:function(a,b,c){var d=new e,f=new e;this.to2d(b,d);this.to2d(c,f);this._rayStart.vec3.copy(b);this._rayEnd.vec3.copy(c);this.b2World.RayCast(a,d,f)},raycastFirst:function(a,b,c){var e,d=1;this.raycast(function(a,b,f,g){a=a.GetUserData();a!==c&&g<d&&(e=a,d=g);return 1},a,b);return e},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var e=b[c].entity,d=b[c].data;d.body&&!d.static&&e.body2d.updateTransform(d.body)}for(this.time+=a;this.time>this.step;)this.b2World.Step(this.step,
6,2),this.time-=this.step}});return{Body2dComponentSystem:h}}());pc.extend(pc.fw,function(){new pc.Mat4;var d=new pc.Vec3,a=new pc.Vec3,b=function(a,b){this.on("set_static",this.onSetStatic,this);b.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this)},b=pc.inherits(b,pc.fw.Component);pc.extend(b.prototype,{applyForce:function(a,b){var g=this.entity.body2d.body;g&&(b||(b=d,b[this.system.xi]=g.GetPosition().x,b[this.system.yi]=g.GetPosition().y),g.ApplyForce({x:a[this.system.xi],y:a[this.system.yi]},{x:b[this.system.xi],y:b[this.system.yi]}))},applyImpulse:function(a,
b){var g=this.entity.body2d.body;g&&(b||(b=d,b[this.system.xi]=g.GetPosition().x,b[this.system.yi]=g.GetPosition().y),g.ApplyImpulse({x:a[this.system.xi],y:a[this.system.yi]},{x:b[this.system.xi],y:b[this.system.yi]}))},setLinearVelocity:function(a,b){var d=this.entity.body2d.body;if(d){var f=d.GetLinearVelocity();f.x=a;f.y=b;d.SetLinearVelocity(f)}},setAngularVelocity:function(a){var b=this.entity.body2d.body;b&&b.SetAngularVelocity(a)},setTransform:function(b){b.getTranslation(d);b.getEulerAngles(a);
b=this._eulersToAngle(a);this.setPositionAndAngle(d.data[this.system.xi],d.data[this.system.yi],-b)},setPosition:function(a,b){var d=this.entity.body2d.body;if(d){d.SetAwake(!0);var f=d.GetPosition();f.x=a;f.y=b;d.SetPosition(f);this.updateTransform(d)}},setAngle:function(a){var b=this.entity.body2d.body;b&&(b.SetAwake(!0),b.SetAngle(a*pc.math.DEG_TO_RAD),this.updateTransform(b))},setPositionAndAngle:function(a,b,d){var f=this.entity.body2d.body;if(f){f.SetAwake(!0);var h=f.GetPosition();h.x=a;h.y=
b;f.SetPositionAndAngle(h,d*pc.math.DEG_TO_RAD);this.updateTransform(f)}},getAngle:function(){return this.entity.body2d.body.GetAngle()*pc.math.RAD_TO_DEG},setLinearDamping:function(a,b){var d=this.entity.body2d.body;d&&d.SetLinearDamping(b)},updateTransform:function(b){var e=this.entity.getPosition();this.entity.getLocalEulerAngles();var g=b.GetPosition();d.data[this.system.xi]=g.x;d.data[this.system.ri]=e.y;d.data[this.system.yi]=g.y;a.data[this.system.xi]=0;a.data[this.system.ri]=-b.GetAngle()*
pc.math.RAD_TO_DEG;a.data[this.system.yi]=0;this.entity.setPosition(d);this.entity.setEulerAngles(a)},onSetStatic:function(a,b,d){(a=this.entity.body2d.body)&&(d?a.SetType((void 0).b2_staticBody):a.SetType((void 0).b2_dynamicBody))},onLiveLinkUpdateTransform:function(){this.setTransform(this.entity.getWorldTransform());this.setLinearVelocity(0,0);this.setAngularVelocity(0)},_eulersToAngle:function(a){var b=a[this.system.ri];179.9<a[this.system.xi]&&179.9<a[this.system.yi]&&(b=180-a[this.system.ri]);
return b}});return{Body2dComponent:b}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.static=!0;this.shape=pc.shape.Type.RECT;this.body=this.bodyDef=null},pc.fw.ComponentData);return{Body2dComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b,c=function(c){"undefined"!==typeof Box2D&&!d&&(d=Box2D.Dynamics.b2World,a=Box2D.Dynamics.b2FixtureDef,b=Box2D.Collision.Shapes.b2PolygonShape);this.id="collisionrect";c.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionRectComponent;this.DataType=pc.fw.CollisionRectComponentData;this.schema=[{name:"density",displayName:"Density",description:"The density of the body, this determine the mass",type:"number",options:{min:0,step:0.01},defaultValue:1},{name:"friction",
displayName:"Friction",description:"The friction when the body slides along another body",type:"number",options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object doesn't bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"x",displayName:"Size: X",description:"The size of the Rect in the x-axis",type:"number",options:{min:0,
step:0.1},defaultValue:0.5},{name:"y",displayName:"Size: Y",description:"The size of the Rect in the y-axis",type:"number",options:{min:0,step:0.1},defaultValue:0.5},{name:"model",expose:!1}];this.exposeProperties();var c=c.graphicsDevice,g=new pc.gfx.VertexFormat(c,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),g=new pc.gfx.VertexBuffer(c,g,4);(new Float32Array(g.lock())).set([-0.5,0,-0.5,-0.5,0,0.5,0.5,0,0.5,0.5,0,-0.5]);g.unlock();c=new pc.gfx.IndexBuffer(c,
pc.gfx.INDEXFORMAT_UINT8,8);(new Uint8Array(c.lock())).set([0,1,1,2,2,3,3,0]);c.unlock();this.mesh=new pc.scene.Mesh;this.mesh.vertexBuffer=g;this.mesh.indexBuffer[0]=c;this.mesh.primitive[0].type=pc.gfx.PRIMITIVE_LINES;this.mesh.primitive[0].base=0;this.mesh.primitive[0].count=c.getNumIndices();this.mesh.primitive[0].indexed=!0;this.material=new pc.scene.BasicMaterial;this.material.color=new pc.Color(0,0,1,1);this.material.update();this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},c=pc.inherits(c,pc.fw.ComponentSystem);c.prototype=pc.extend(c.prototype,{initializeComponentData:function(a,b,d){b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[new pc.scene.MeshInstance(b.model.graph,this.mesh,this.material)];d="density friction restitution x y model".split(" ");c._super.initializeComponentData.call(this,a,b,d);"undefined"!==typeof Box2D&&(a.fixtureDef=this.createFixtureDef(a.entity,
a),a.entity.body2d&&this.context.systems.body2d.createBody(a.entity.body2d))},createFixtureDef:function(c,d){var f=new a;f.density=d.density;f.friction=d.friction;f.restitution=d.restitution;f.shape=new b;f.shape.SetAsBox(d.x,d.y);f.userData=c;return f},onRemove:function(a,b){a.body2d&&a.body2d.body&&this.context.systems.body2d.removeBody(a,a.body2d.body);this.context.scene.containsModel(b.model)&&(this.context.scene.removeModel(b.model),this.context.root.removeChild(b.model.graph))},setDebugRender:function(a){this.debugRender=
a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b=this.context.systems.body2d.xi,c=this.context.systems.body2d.yi,d=this.context.systems.body2d.ri,l;for(l in a){var k=a[l].entity,n=a[l].data;this.context.scene.containsModel(n.model)||(this.context.scene.addModel(n.model),this.context.root.addChild(n.model.graph));var m=[];m[b]=2*n.x;m[c]=2*n.y;m[d]=1;n=n.model.graph;n.setPosition(k.getPosition());
n.setRotation(k.getRotation());n.setLocalScale(m[0],m[1],m[2])}}});return{CollisionRectComponentSystem:c}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_density",this.onSetDensity,this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_x",this.onSetX,this);this.on("set_y",this.onSetY,this)},pc.fw.Component);pc.extend(d.prototype,{onSetDensity:function(a,b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetDensity(c),this.entity.body2d.body.ResetMassData())},onSetFriction:function(a,
b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetFriction(c),this.entity.body2d.body.ResetMassData())},onSetRestitution:function(a,b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetRestitution(c),this.entity.body2d.body.ResetMassData())},onSetX:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().GetShape().SetAsBox(c,this.y),a.SetAwake(!0)},onSetY:function(a,b,c){if(this.entity.body2d&&
(a=this.entity.body2d.body))a.GetFixtureList().GetShape().SetAsBox(this.x,c),a.SetAwake(!0)}});return{CollisionRectComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.y=this.x=0.5},pc.fw.ComponentData);return{CollisionRectComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b,c=function(c){"undefined"!==typeof Box2D&&!d&&(d=Box2D.Dynamics.b2World,a=Box2D.Dynamics.b2FixtureDef,b=Box2D.Collision.Shapes.b2CircleShape);this.id="collisioncircle";c.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionCircleComponent;this.DataType=pc.fw.CollisionCircleComponentData;this.schema=[{name:"density",displayName:"Density",description:"The density of the body, this determine the mass",type:"number",options:{min:0,step:0.01},defaultValue:1},
{name:"friction",displayName:"Friction",description:"The friction when the body slides along another body",type:"number",options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object doesn't bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"radius",displayName:"Radius",description:"The size of the Rect in the x-axis",
type:"number",options:{min:0,step:0.1},defaultValue:1},{name:"model",exposed:!1}];this.exposeProperties();var g=c.graphicsDevice,c=new pc.gfx.VertexFormat(g,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),c=new pc.gfx.VertexBuffer(g,c,41),f=new Float32Array(c.lock()),h,l=c.getNumVertices();for(h=0;h<l-1;h++){var k=2*Math.PI*(h/(l-2)),n=0.5*Math.cos(k),k=0.5*Math.sin(k);f[3*h+0]=n;f[3*h+1]=0;f[3*h+2]=k}c.unlock();g=new pc.gfx.IndexBuffer(g,pc.gfx.INDEXFORMAT_UINT8,
80);f=new Uint8Array(g.lock());for(h=0;40>h;h++)f[2*h+0]=h,f[2*h+1]=h+1;g.unlock();this.mesh=new pc.scene.Mesh;this.mesh.vertexBuffer=c;this.mesh.indexBuffer[0]=g;this.mesh.primitive[0].type=pc.gfx.PRIMITIVE_LINES;this.mesh.primitive[0].base=0;this.mesh.primitive[0].count=g.getNumIndices();this.mesh.primitive[0].indexed=!0;this.material=new pc.scene.BasicMaterial;this.material.color=pc.Color(0,0,1,1);this.material.update();this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},c=pc.inherits(c,pc.fw.ComponentSystem);pc.extend(c.prototype,{initializeComponentData:function(a,b,d){b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[new pc.scene.MeshInstance(b.model.graph,this.mesh,this.material)];d=["density","friction","restitution","radius","model"];c._super.initializeComponentData.call(this,a,b,d);"undefined"!==typeof Box2D&&(a.fixtureDef=this.createFixtureDef(a.entity,
a),a.entity.body2d&&this.context.systems.body2d.createBody(a.entity.body2d))},createFixtureDef:function(c,d){var f=new a;f.density=d.density;f.friction=d.friction;f.restitution=d.restitution;f.shape=new b;f.shape.SetRadius(d.radius);f.userData=c;return f},onRemove:function(a,b){a.body2d&&a.body2d.body&&this.context.systems.body2d.removeBody(a,a.body2d.body);this.context.scene.containsModel(b.model)&&(this.context.scene.removeModel(b.model),this.context.root.removeChild(b.model.graph))},setDebugRender:function(a){this.debugRender=
a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b;for(b in a){var c=a[b].entity,d=a[b].data;this.context.scene.containsModel(d.model)||(this.context.scene.addModel(d.model),this.context.root.addChild(d.model.graph));var l=d.radius,d=d.model.graph;d.setPosition(c.getPosition());d.setRotation(c.getRotation());d.setLocalScale(l/0.5,l/0.5,l/0.5)}}});return{CollisionCircleComponentSystem:c}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_density",this.onSetDensity,this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_radius",this.onSetRadius,this)},pc.fw.Component);pc.extend(d.prototype,{onSetDensity:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetDensity(c),a.ResetMassData()},onSetFriction:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetFriction(c),
a.ResetMassData()},onSetRestitution:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetRestitution(c),a.ResetMassData()},onSetRadius:function(){if(this.entity.body2d){var a=this.entity.body2d.body;a&&(a.GetFixtureList().GetShape().SetRadius(this.radius),a.SetAwake(!0))}}});return{CollisionCircleComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.radius=1},pc.fw.ComponentData);return{CollisionCircleComponentData:d}}());pc.extend(pc.fw,function(){new pc.Mat4;new pc.Mat4;new pc.Vec3;new pc.Vec3;new pc.Vec3;var d,a,b={},c={},e=[],g=[],f=[[0,39,0],[39,39,24],[0,24,0]],h=function(a,b,c){this.entity=a;this.point=b;this.normal=c},l=function(a,b,c){this.a=a;this.b=b;this.localPointA=c.localPoint;this.localPointB=c.localPointOther;this.pointA=c.point;this.pointB=c.pointOther;this.normal=c.normal},k=function(a,b,c,d,e){this.localPoint=a;this.localPointOther=b;this.point=c;this.pointOther=d;this.normal=e},n=function(a,b){this.other=
a;this.contacts=b},m=function(a){this.id="rigidbody";this.description="Adds the entity to the scene's physical simulation.";a.systems.add(this.id,this);this.ComponentType=pc.fw.RigidBodyComponent;this.DataType=pc.fw.RigidBodyComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the rigid body",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of body determines how it moves and collides with other bodies. Dynamic is a normal body. Static will never move. Kinematic can be moved in code, but will not respond to collisions.",
type:"enumeration",options:{enumerations:[{name:"Static",value:pc.fw.RIGIDBODY_TYPE_STATIC},{name:"Dynamic",value:pc.fw.RIGIDBODY_TYPE_DYNAMIC},{name:"Kinematic",value:pc.fw.RIGIDBODY_TYPE_KINEMATIC}]},defaultValue:pc.fw.RIGIDBODY_TYPE_STATIC},{name:"mass",displayName:"Mass",description:"The mass of the body",type:"number",options:{min:0,step:1},defaultValue:1,filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"linearDamping",displayName:"Linear Damping",description:"The linear damping applied to the body",
type:"number",options:{min:0,step:1},defaultValue:0,filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"angularDamping",displayName:"Angular Damping",description:"The angular damping applied to the body",type:"number",options:{min:0,step:1},defaultValue:0,filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"linearFactor",displayName:"Linear Factor",description:"The linear factor applied to the linear motion of the body, used to contrain linear movement in each axis",
type:"vector",options:{min:0,step:0.1},defaultValue:[1,1,1],filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"angularFactor",displayName:"Angular Factor",description:"The angular factor applied to the angular motion of the body, used to contrain angular movement in each axis",type:"vector",options:{min:0,step:0.1},defaultValue:[1,1,1],filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"friction",displayName:"Friction",description:"The friction when the body slides along another body",
type:"number",options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object does not bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"body",exposed:!1}];this.exposeProperties();this.maxSubSteps=10;this.fixedTimeStep=1/60;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this)},
m=pc.inherits(m,pc.fw.ComponentSystem);pc.extend(m.prototype,{onLibraryLoaded:function(){if("undefined"!==typeof Ammo){var b=new Ammo.btDefaultCollisionConfiguration,c=new Ammo.btCollisionDispatcher(b),e=new Ammo.btDbvtBroadphase,f=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(c,e,f,b);this._ammoGravity=new Ammo.btVector3(0,-9.82,0);this.dynamicsWorld.setGravity(this._ammoGravity);d=new Ammo.btVector3;a=new Ammo.btVector3}else pc.fw.ComponentSystem.off("update",
this.onUpdate,this)},initializeComponentData:function(a,b,c){b.bodyType&&(b.type=b.bodyType,console.warn("WARNING: rigidbody.bodyType: Property is deprecated. Use type instead."));b.linearFactor&&"array"===pc.type(b.linearFactor)&&(b.linearFactor=new pc.Vec3(b.linearFactor[0],b.linearFactor[1],b.linearFactor[2]));b.angularFactor&&"array"===pc.type(b.angularFactor)&&(b.angularFactor=new pc.Vec3(b.angularFactor[0],b.angularFactor[1],b.angularFactor[2]));c="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type".split(" ");
m._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,type:a.rigidbody.type})},
onRemove:function(a,b){b.body&&(this.removeBody(b.body),Ammo.destroy(b.body));b.body=null},addBody:function(a){this.dynamicsWorld.addRigidBody(a);return a},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},addConstraint:function(a){this.dynamicsWorld.addConstraint(a);return a},removeConstraint:function(a){this.dynamicsWorld.removeConstraint(a)},setGravity:function(){var a,b,c;1===arguments.length?(a=arguments[0].x,b=arguments[0].y,c=arguments[0].z):(a=arguments[0],b=arguments[1],c=arguments[2]);
this._ammoGravity.setValue(a,b,c);this.dynamicsWorld.setGravity(this._ammoGravity)},raycastFirst:function(b,c,e){d.setValue(b.x,b.y,b.z);a.setValue(c.x,c.y,c.z);b=new Ammo.ClosestRayResultCallback(d,a);this.dynamicsWorld.rayTest(d,a,b);if(b.hasHit()){var c=b.get_m_collisionObject(),c=Ammo.castObject(c,Ammo.btRigidBody),f=b.get_m_hitPointWorld(),g=b.get_m_hitNormalWorld();c&&e(new h(c.entity,new pc.Vec3(f.x(),f.y(),f.z()),new pc.Vec3(g.x(),g.y(),g.z())))}Ammo.destroy(b)},_storeCollision:function(a,
d){var e=!1,f=a.getGuid();b[f]=b[f]||{others:[],entity:a};0>b[f].others.indexOf(d)&&(b[f].others.push(d),e=!0);c[f]=c[f]||{others:[],entity:a};c[f].others.push(d);return e},_handleEntityCollision:function(a,b,c,d){var e;d&1&&(e=new n(b,c),a.collision.fire("contact",e));d&30&&this._storeCollision(a,b)&&(d&2&&(e=e||new n(b,c),a.collision.fire("collisionstart",e)),d&8&&a.collision.fire("triggerenter",b))},_createContactPointFromAmmo:function(a){var b=new pc.Vec3(a.get_m_localPointA().x(),a.get_m_localPointA().y(),
a.get_m_localPointA().z()),c=new pc.Vec3(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z()),d=new pc.Vec3(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z()),e=new pc.Vec3(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z()),a=new pc.Vec3(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return new k(b,c,d,e,a)},_createReverseContactPointFromAmmo:function(a){var b=new pc.Vec3(a.get_m_localPointA().x(),
a.get_m_localPointA().y(),a.get_m_localPointA().z()),c=new pc.Vec3(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z()),d=new pc.Vec3(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z()),e=new pc.Vec3(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z()),a=new pc.Vec3(-a.get_m_normalWorldOnB().x(),-a.get_m_normalWorldOnB().y(),-a.get_m_normalWorldOnB().z());return new k(c,b,e,d,a)},_cleanOldCollisions:function(){for(var a in b)if(b.hasOwnProperty(a)){for(var d=
b[a].entity,e=d.collision,f=b[a].others,g=f.length;g--;){var h=f[g];if(!c[a]||0>c[a].others.indexOf(h))if(f.splice(g,1),e&&h.collision){var l=this._getCollisionFlags(d,h);l&4&&e.fire("collisionend",h);l&16&&e.fire("triggerleave",h)}}0===f.length&&delete b[a]}},_getCollisionFlags:function(a,b){var c=a.rigidbody,d=b.rigidbody,e=!c,g=!d;if(e&&g)return 0;var h=this.store,c=c&&h[a.getGuid()].data.type!==pc.fw.RIGIDBODY_TYPE_STATIC,d=d&&h[b.getGuid()].data.type!==pc.fw.RIGIDBODY_TYPE_STATIC,l=h=0;c?h=1:
e&&(h=2);d?l=1:g&&(l=2);if(e=f[h][l])g=a.collision,this.hasEvent("contact")||(e&=-33),g.hasEvent("contact")||(e&=-2),g.hasEvent("collisionstart")||(e&=-3),g.hasEvent("collisionend")||(e&=-5),g.hasEvent("triggerenter")||(e&=-9),g.hasEvent("triggerleave")||(e&=-17);return e},onUpdate:function(a){this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);var b=this.store,d;for(d in b)if(b.hasOwnProperty(d)){var f=b[d].entity,h=b[d].data;h.body&&(h.body.isActive()&&h.enabled&&f.enabled)&&
(h.type===pc.fw.RIGIDBODY_TYPE_DYNAMIC?f.rigidbody.syncBodyToEntity():h.type===pc.fw.RIGIDBODY_TYPE_KINEMATIC&&f.rigidbody.updateKinematic(a))}var a=this.dynamicsWorld.getDispatcher(),b=a.getNumManifolds(),k;c={};for(d=0;d<b;d++){f=a.getManifoldByIndexInternal(d);k=f.getBody0();h=f.getBody1();k=Ammo.castObject(k,Ammo.btRigidBody);var m=Ammo.castObject(h,Ammo.btRigidBody),h=k.entity,m=m.entity;if(h&&m){var n=this._getCollisionFlags(h,m),A=this._getCollisionFlags(m,h);if(n||A){var C=f.getNumContacts();
if(0<C){var H,E=n&2||n&1,I=A&2||A&1;e.length=0;for(k=g.length=0;k<C;k++){var y=f.getContactPoint(k);n&32&&(H=this._createContactPointFromAmmo(y),this.fire("contact",new l(h,m,H)));E&&(H=H||this._createContactPointFromAmmo(y),e.push(H));I&&g.push(this._createReverseContactPointFromAmmo(y))}this._handleEntityCollision(h,m,e,n);this._handleEntityCollision(m,h,g,A)}}}}this._cleanOldCollisions()}});return{RIGIDBODY_TYPE_STATIC:"static",RIGIDBODY_TYPE_DYNAMIC:"dynamic",RIGIDBODY_TYPE_KINEMATIC:"kinematic",
RIGIDBODY_CF_STATIC_OBJECT:1,RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:m}}());pc.extend(pc.fw,function(){var d,a,b,c,e,g=function(f,g){"undefined"!==typeof Ammo&&!d&&(d=new Ammo.btTransform,a=new Ammo.btVector3,b=new Ammo.btVector3,c=new Ammo.btQuaternion,e=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,this);this.on("set_friction",
this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_body",this.onSetBody,this);g.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this);this.system.on("beforeremove",this.onBeforeRemove,this);this._displacement=new pc.Vec3(0,0,0);this._linearVelocity=new pc.Vec3(0,0,0);this._angularVelocity=new pc.Vec3(0,0,0)},g=pc.inherits(g,pc.fw.Component);Object.defineProperty(g.prototype,"bodyType",{get:function(){console.warn("WARNING: bodyType: Function is deprecated. Query type property instead.");
return this.type},set:function(a){console.warn("WARNING: bodyType: Function is deprecated. Set type property instead.");this.type=a}});Object.defineProperty(g.prototype,"linearVelocity",{get:function(){if(this.isKinematic())return this._linearVelocity;if(this.body){var a=this.body.getLinearVelocity();this._linearVelocity.set(a.x(),a.y(),a.z());return this._linearVelocity}},set:function(b){this.activate();if(this.isKinematic())this._linearVelocity.copy(b);else{var c=this.body;c&&(a.setValue(b.x,b.y,
b.z),c.setLinearVelocity(a))}}});Object.defineProperty(g.prototype,"angularVelocity",{get:function(){if(this.isKinematic())return this._angularVelocity;if(this.body){var a=this.body.getAngularVelocity();this._angularVelocity.set(a.x(),a.y(),a.z());return this._angularVelocity}},set:function(b){this.activate();if(this.isKinematic())this._angularVelocity.copy(b);else{var c=this.body;c&&(a.setValue(b.x,b.y,b.z),c.setAngularVelocity(a))}}});pc.extend(g.prototype,{createBody:function(){var b=this.entity,
d;b.collision&&(d=b.collision.shape,b.trigger&&(b.trigger.destroy(),delete b.trigger));if(d){this.body&&(this.system.removeBody(this.body),Ammo.destroy(this.body));var e=this.isStaticOrKinematic(),g=e?0:this.mass,n=new Ammo.btVector3(0,0,0);e||d.calculateLocalInertia(g,n);var e=b.getPosition(),m=b.getRotation();c.setValue(m.x,m.y,m.z,m.w);m=new Ammo.btTransform;m.setIdentity();m.getOrigin().setValue(e.x,e.y,e.z);m.setRotation(c);e=new Ammo.btDefaultMotionState(m);d=new Ammo.btRigidBodyConstructionInfo(g,
e,d,n);d=new Ammo.btRigidBody(d);d.setRestitution(this.restitution);d.setFriction(this.friction);d.setDamping(this.linearDamping,this.angularDamping);g=this.linearFactor;a.setValue(g.x,g.y,g.z);d.setLinearFactor(a);g=this.angularFactor;a.setValue(g.x,g.y,g.z);d.setAngularFactor(a);d.entity=b;this.isKinematic()&&(d.setCollisionFlags(d.getCollisionFlags()|pc.fw.RIGIDBODY_CF_KINEMATIC_OBJECT),d.setActivationState(pc.fw.RIGIDBODY_DISABLE_DEACTIVATION));b.rigidbody.body=d;this.enabled&&this.entity.enabled&&
this.enableSimulation()}},isActive:function(){return this.body?this.body.isActive():!1},activate:function(){this.body&&this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;a&&(this.system.addBody(a),this.isKinematic()?(a.forceActivationState(pc.fw.RIGIDBODY_DISABLE_DEACTIVATION),a.activate()):(a.forceActivationState(pc.fw.RIGIDBODY_ACTIVE_TAG),this.syncEntityToBody()),this.data.simulationEnabled=!0)}},
disableSimulation:function(){var a=this.body;a&&this.data.simulationEnabled&&(this.system.removeBody(a),a.forceActivationState(pc.fw.RIGIDBODY_DISABLE_SIMULATION),this.data.simulationEnabled=!1)},applyForce:function(){var c,d,g,k,n,m;switch(arguments.length){case 1:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;break;case 2:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;k=arguments[1].x;n=arguments[1].y;m=arguments[1].z;break;case 3:c=arguments[0];d=arguments[1];g=arguments[2];break;case 6:c=
arguments[0],d=arguments[1],g=arguments[2],k=arguments[3],n=arguments[4],m=arguments[5]}var r=this.body;r&&(r.activate(),a.setValue(c,d,g),"undefined"!==typeof k?(b.setValue(k,n,m),r.applyForce(a,b)):r.applyForce(a,e))},applyTorque:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];break;default:console.error("ERROR: applyTorque: function takes 1 or 3 arguments");return}var e=this.body;e&&
(e.activate(),a.setValue(b,c,d),e.applyTorque(a))},applyImpulse:function(){var c,d,g,k,n,m;switch(arguments.length){case 1:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;break;case 2:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;k=arguments[1].x;n=arguments[1].y;m=arguments[1].z;break;case 3:c=arguments[0];d=arguments[1];g=arguments[2];break;case 6:c=arguments[0],d=arguments[1],g=arguments[2],k=arguments[0],n=arguments[1],m=arguments[2]}var r=this.body;r&&(r.activate(),a.setValue(c,d,g),
"undefined"!==typeof k?(b.setValue(k,n,m),r.applyImpulse(a,b)):r.applyImpulse(a,e))},applyTorqueImpulse:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];break;default:console.error("ERROR: applyTorqueImpulse: function takes 1 or 3 arguments");return}var e=this.body;e&&(e.activate(),a.setValue(b,c,d),e.applyTorqueImpulse(a))},isStatic:function(){return this.type===pc.fw.RIGIDBODY_TYPE_STATIC},
isStaticOrKinematic:function(){return this.type===pc.fw.RIGIDBODY_TYPE_STATIC||this.type===pc.fw.RIGIDBODY_TYPE_KINEMATIC},isKinematic:function(){return this.type===pc.fw.RIGIDBODY_TYPE_KINEMATIC},syncEntityToBody:function(){var a=this.body;if(a){var b=this.entity.getPosition(),d=this.entity.getRotation(),e=a.getWorldTransform();e.getOrigin().setValue(b.x,b.y,b.z);c.setValue(d.x,d.y,d.z,d.w);e.setRotation(c);a.activate()}},syncBodyToEntity:function(){var a=this.body;if(a.isActive()&&a.getMotionState()){a.getMotionState().getWorldTransform(d);
var a=d.getOrigin(),b=d.getRotation();this.entity.setPosition(a.x(),a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},updateKinematic:function(a){this._displacement.copy(this._linearVelocity).scale(a);this.entity.translate(this._displacement);this._displacement.copy(this._angularVelocity).scale(a);this.entity.rotate(this._displacement.x,this._displacement.y,this._displacement.z);if(this.body.getMotionState()){var a=this.entity.getPosition(),b=this.entity.getRotation();d.getOrigin().setValue(a.x,
a.y,a.z);c.setValue(b.x,b.y,b.z,b.w);d.setRotation(c);this.body.getMotionState().setWorldTransform(d)}},onEnable:function(){g._super.onEnable.call(this);this.body||this.createBody();this.enableSimulation()},onDisable:function(){g._super.onDisable.call(this);this.disableSimulation()},onSetMass:function(a,b,c){if(a=this.data.body){(b=this.enabled&&this.entity.enabled)&&this.disableSimulation();var d=new Ammo.btVector3(0,0,0);a.getCollisionShape().calculateLocalInertia(c,d);a.setMassProps(c,d);a.updateInertiaTensor();
b&&this.enableSimulation()}},onSetLinearDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(c,this.data.angularDamping)},onSetAngularDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(this.data.linearDamping,c)},onSetLinearFactor:function(b,c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setLinearFactor(a)},onSetAngularFactor:function(b,c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setAngularFactor(a)},onSetFriction:function(a,b,c){(a=this.data.body)&&a.setFriction(c)},onSetRestitution:function(a,
b,c){(a=this.data.body)&&a.setRestitution(c)},onSetType:function(a,b,c){c!==b&&(this.disableSimulation(),this.createBody())},onSetBody:function(){this.body&&this.data.simulationEnabled&&this.body.activate()},onLiveLinkUpdateTransform:function(){this.syncEntityToBody();this.angularVelocity=this.linearVelocity=pc.Vec3.ZERO},onBeforeRemove:function(a,b){this===b&&(a.off("livelink:updatetransform",this.onLiveLinkUpdateTransform,this),this.system.off("beforeremove",this.onBeforeRemove,this))}});return{RigidBodyComponent:g}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new pc.Vec3(1,1,1);this.angularFactor=new pc.Vec3(1,1,1);this.friction=0.5;this.restitution=0;this.type=pc.fw.RIGIDBODY_TYPE_STATIC;this.body=null;this.simulationEnabled=!1},pc.fw.ComponentData);return{RigidBodyComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b=function(b,e,g){this.entity=e.entity;this.component=e;this.context=b;"undefined"!==typeof Ammo&&(d=new Ammo.btVector3,a=new Ammo.btQuaternion);this.initialize(g)};b.prototype={initialize:function(b){var e=this.entity;if((b=b.shape)&&"undefined"!==typeof Ammo){e.trigger&&e.trigger.destroy();var g=new Ammo.btVector3(0,0,0);b.calculateLocalInertia(1,g);var f=e.getPosition(),h=e.getRotation();a.setValue(h.x,h.y,h.z,h.w);h=new Ammo.btTransform;h.setIdentity();h.getOrigin().setValue(f.x,
f.y,f.z);h.setRotation(a);f=new Ammo.btDefaultMotionState(h);b=new Ammo.btRigidBodyConstructionInfo(1,f,b,g);this.body=b=new Ammo.btRigidBody(b);b.setRestitution(0);b.setFriction(0);b.setDamping(0,0);d.setValue(0,0,0);b.setLinearFactor(d);b.setAngularFactor(d);b.setCollisionFlags(b.getCollisionFlags()|pc.fw.RIGIDBODY_CF_NORESPONSE_OBJECT);b.entity=e;this.component.enabled&&e.enabled&&this.enable()}},destroy:function(){this.body&&this.context.systems.rigidbody.removeBody(this.body)},syncEntityToBody:function(){var b=
this.body;if(b){var d=this.entity.getPosition(),g=this.entity.getRotation(),f=b.getWorldTransform();f.getOrigin().setValue(d.x,d.y,d.z);a.setValue(g.x,g.y,g.z,g.w);f.setRotation(a);b.activate()}},enable:function(){var a=this.body;this.context.systems.rigidbody.addBody(a);a.forceActivationState(pc.fw.RIGIDBODY_ACTIVE_TAG);a.activate()},disable:function(){var a=this.body;this.context.systems.rigidbody.removeBody(a);a.forceActivationState(pc.fw.RIGIDBODY_DISABLE_SIMULATION)}};return{Trigger:b}}());pc.extend(pc.fw,function(){var d=function(a){this.id="collision";this.description="Specifies a collision volume.";a.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionComponent;this.DataType=pc.fw.CollisionComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the collision",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of the collision volume",type:"enumeration",options:{enumerations:[{name:"Box",value:"box"},
{name:"Sphere",value:"sphere"},{name:"Capsule",value:"capsule"},{name:"Cylinder",value:"cylinder"},{name:"Mesh",value:"mesh"}]},defaultValue:"box"},{name:"halfExtents",displayName:"Half Extents",description:"The half-extents of the box",type:"vector",options:{min:0,step:0.1},defaultValue:[0.5,0.5,0.5],filter:{type:"box"}},{name:"radius",displayName:"Radius",description:"The radius of the collision volume",type:"number",options:{min:0,step:0.1},defaultValue:0.5,filter:{type:["sphere","capsule","cylinder"]}},
{name:"axis",displayName:"Axis",description:"Major axis of the volume",type:"enumeration",options:{enumerations:[{name:"X",value:0},{name:"Y",value:1},{name:"Z",value:2}]},defaultValue:1,filter:{type:["capsule","cylinder"]}},{name:"height",displayName:"Height",description:"Height of the volume",type:"number",options:{min:0,step:0.1},defaultValue:2,filter:{type:["capsule","cylinder"]}},{name:"asset",displayName:"Asset",description:"Collision mesh asset",type:"asset",options:{max:1,type:"model"},defaultValue:null,
filter:{type:"mesh"}},{name:"shape",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();this.implementations={};this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype=pc.extend(d.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.fw.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,
b,c){b.type||(b.type=a.data.type);a.data.type=b.type;b.halfExtents&&"array"===pc.type(b.halfExtents)&&(b.halfExtents=new pc.Vec3(b.halfExtents[0],b.halfExtents[1],b.halfExtents[2]));var e=this._createImplementation(b.type);e.beforeInitialize(a,b);c="type halfExtents radius axis height shape model asset enabled".split(" ");d._super.initializeComponentData.call(this.system,a,b,c);e.afterInitialize(a,b)},_createImplementation:function(a){if("undefined"===typeof this.implementations[a]){var b;switch(a){case "box":b=
new CollisionBoxSystemImpl(this);break;case "sphere":b=new CollisionSphereSystemImpl(this);break;case "capsule":b=new CollisionCapsuleSystemImpl(this);break;case "cylinder":b=new CollisionCylinderSystemImpl(this);break;case "mesh":b=new CollisionMeshSystemImpl(this);break;default:throw"Invalid collision system type: "+a;}this.implementations[a]=b}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,
b)},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},onUpdate:function(){var a,b,c,d=this.store;for(a in d)b=d[a].entity,c=d[a].data,c.enabled&&b.enabled&&(b.rigidbody||b.trigger.syncEntityToBody()),this.debugRender&&this.updateDebugShape(b,c,this._getImplementation(b))},updateDebugShape:function(a,b,c){var d=this.context;if("undefined"!==typeof c&&c.hasDebugShape){if(b.model)if(d.scene.containsModel(b.model)){if(!b.enabled||!a.enabled)d.root.removeChild(b.model.graph),d.scene.removeModel(b.model)}else a.enabled&&
b.enabled&&(d.scene.addModel(b.model),d.root.addChild(b.model.graph));b.enabled&&a.enabled&&c.updateDebugShape(a,b)}},onTransformChanged:function(a,b,c,d){this.implementations[a.data.type].updateTransform(a,b,c,d)},onToolsUpdate:function(){var a,b,c=this.store;for(a in c)b=c[a].entity,this.updateDebugShape(b,c[a].data,this._getImplementation(b))},setDebugRender:function(a){this.debugRender=a},changeType:function(a,b,c){this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).reset(a,
a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)}});CollisionSystemImpl=function(a){this.system=a;this.hasDebugShape=!0};CollisionSystemImpl.prototype={beforeInitialize:function(a,b){b.shape=this.createPhysicalShape(a.entity,b);b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[this.createDebugMesh(b)]},afterInitialize:function(a){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,
b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=a.entity,c=a.data;"undefined"!==typeof Ammo&&(c.shape=this.createPhysicalShape(a.entity,c),b.rigidbody?b.rigidbody.createBody():b.trigger?b.trigger.initialize(c):b.trigger=new pc.fw.Trigger(this.system.context,a,c))},createDebugMesh:function(){},createPhysicalShape:function(){},updateDebugShape:function(){},updateTransform:function(a){a.entity.trigger&&a.entity.trigger.syncEntityToBody()},remove:function(a,b){var c=this.system.context;
a.rigidbody&&a.rigidbody.body&&c.systems.rigidbody.removeBody(a.rigidbody.body);a.trigger&&(a.trigger.destroy(),delete a.trigger);c.scene.containsModel(b.model)&&(c.root.removeChild(b.model.graph),c.scene.removeModel(b.model))},clone:function(a,b){var c=this.system.dataStore[a.getGuid()];return this.system.addComponent(b,{enabled:c.data.enabled,type:c.data.type,halfExtents:[c.data.halfExtents.x,c.data.halfExtents.y,c.data.halfExtents.z],radius:c.data.radius,axis:c.data.axis,height:c.data.height,asset:c.data.asset,
model:c.data.model})}};CollisionBoxSystemImpl=function(){};CollisionBoxSystemImpl=pc.inherits(CollisionBoxSystemImpl,CollisionSystemImpl);CollisionBoxSystemImpl.prototype=pc.extend(CollisionBoxSystemImpl.prototype,{createDebugMesh:function(a){if(!this.mesh){var b=this.system.context.graphicsDevice,c=new pc.gfx.VertexFormat(b,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),c=new pc.gfx.VertexBuffer(b,c,8);(new Float32Array(c.lock())).set([-0.5,-0.5,-0.5,-0.5,-0.5,
0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,-0.5]);c.unlock();b=new pc.gfx.IndexBuffer(b,pc.gfx.INDEXFORMAT_UINT8,24);(new Uint8Array(b.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);b.unlock();var d=new pc.scene.Mesh;d.vertexBuffer=c;d.indexBuffer[0]=b;d.primitive[0].type=pc.gfx.PRIMITIVE_LINES;d.primitive[0].base=0;d.primitive[0].count=b.getNumIndices();d.primitive[0].indexed=!0;this.mesh=d}this.material||(c=new pc.scene.BasicMaterial,c.color=new pc.Color(0,
0,1,1),c.update(),this.material=c);return new pc.scene.MeshInstance(a.model.graph,this.mesh,this.material)},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo){var c=b.halfExtents,c=new Ammo.btVector3(c.x,c.y,c.z);return new Ammo.btBoxShape(c)}},updateDebugShape:function(a,b){var c=b.halfExtents,d=c.x,g=c.y,c=c.z,f=b.model.graph;f.setPosition(a.getPosition());f.setRotation(a.getRotation());f.setLocalScale(2*d,2*g,2*c)}});CollisionSphereSystemImpl=function(){};CollisionSphereSystemImpl=
pc.inherits(CollisionSphereSystemImpl,CollisionSystemImpl);CollisionSphereSystemImpl.prototype=pc.extend(CollisionSphereSystemImpl.prototype,{createDebugMesh:function(a){if(!this.mesh){for(var b=this.system.context.graphicsDevice,c=new pc.gfx.VertexFormat(b,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),b=new pc.gfx.VertexBuffer(b,c,240),c=new Float32Array(b.lock()),d,g=0,f,h=0;3>h;h++){var l=0,k=1,n=2;1===h?(l=1,k=0,n=2):2===h&&(l=0,k=2,n=1);for(d=0;40>d;d++)f=
2*Math.PI*(d/40),c[g+l]=0.5*Math.cos(f),c[g+k]=0,c[g+n]=0.5*Math.sin(f),g+=3,f=2*Math.PI*((d+1)/40),c[g+l]=0.5*Math.cos(f),c[g+k]=0,c[g+n]=0.5*Math.sin(f),g+=3}b.unlock();c=new pc.scene.Mesh;c.vertexBuffer=b;c.primitive[0].type=pc.gfx.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=b.getNumVertices();c.primitive[0].indexed=!1;this.mesh=c}this.material||(b=new pc.scene.BasicMaterial,b.color=new pc.Color(0,0,1,1),b.update(),this.material=b);return new pc.scene.MeshInstance(a.model.graph,
this.mesh,this.material)},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());var d=2*b.radius;c.setLocalScale(d,d,d)}});CollisionCapsuleSystemImpl=function(){};CollisionCapsuleSystemImpl=pc.inherits(CollisionCapsuleSystemImpl,CollisionSystemImpl);CollisionCapsuleSystemImpl.prototype=pc.extend(CollisionCapsuleSystemImpl.prototype,{createDebugMesh:function(a){if(a.model&&
a.model.meshInstances&&a.model.meshInstances.length)return a.model.meshInstances[0];var b=this.system.context.graphicsDevice,c=new pc.gfx.VertexFormat(b,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),c=new pc.gfx.VertexBuffer(b,c,328,pc.gfx.BUFFER_DYNAMIC);this.updateCapsuleShape(a,c);b=new pc.scene.Mesh;b.vertexBuffer=c;b.primitive[0].type=pc.gfx.PRIMITIVE_LINES;b.primitive[0].base=0;b.primitive[0].count=c.getNumVertices();b.primitive[0].indexed=!1;this.mesh=
b;this.material||(c=new pc.scene.BasicMaterial,c.color=new pc.Color(0,0,1,1),c.update(),this.material=c);return new pc.scene.MeshInstance(a.model.graph,b,this.material)},updateCapsuleShape:function(a,b){var c="undefined"!==typeof a.axis?a.axis:1,d=a.radius||0.5,g=Math.max((a.height||2)-2*d,0),f=new Float32Array(b.lock()),h=0,l=1,k=2;0===c?(h=1,l=0,k=2):2===c&&(h=0,l=2,k=1);var n=0,m;for(cap=-1;2>cap;cap+=2){for(c=0;40>c;c++)m=2*Math.PI*(c/40),f[n+h]=d*Math.cos(m),f[n+l]=0.5*cap*g,f[n+k]=d*Math.sin(m),
n+=3,m=2*Math.PI*((c+1)/40),f[n+h]=d*Math.cos(m),f[n+l]=0.5*cap*g,f[n+k]=d*Math.sin(m),n+=3;for(c=0;20>c;c++)m=Math.PI*(c/20)+1.5*Math.PI,f[n+h]=0,f[n+l]=cap*(0.5*g+d*Math.cos(m)),f[n+k]=cap*d*Math.sin(m),n+=3,m=Math.PI*((c+1)/20)+1.5*Math.PI,f[n+h]=0,f[n+l]=cap*(0.5*g+d*Math.cos(m)),f[n+k]=cap*d*Math.sin(m),n+=3;for(c=0;20>c;c++)m=Math.PI*(c/20)+1.5*Math.PI,f[n+h]=cap*d*Math.sin(m),f[n+l]=cap*(0.5*g+d*Math.cos(m)),f[n+k]=0,n+=3,m=Math.PI*((c+1)/20)+1.5*Math.PI,f[n+h]=cap*d*Math.sin(m),f[n+l]=cap*
(0.5*g+d*Math.cos(m)),f[n+k]=0,n+=3}for(c=0;4>c;c++)m=2*Math.PI*(c/4),f[n+h]=d*Math.cos(m),f[n+l]=0.5*g,f[n+k]=d*Math.sin(m),n+=3,m=2*Math.PI*(c/4),f[n+h]=d*Math.cos(m),f[n+l]=0.5*-g,f[n+k]=d*Math.sin(m),n+=3;b.unlock()},createPhysicalShape:function(a,b){var c=null,d="undefined"!==typeof b.axis?b.axis:1,g=b.radius||0.5,f=Math.max((b.height||2)-2*g,0);if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btCapsuleShapeX(g,f);break;case 1:c=new Ammo.btCapsuleShape(g,f);break;case 2:c=new Ammo.btCapsuleShapeZ(g,
f)}return c},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());c.setLocalScale(1,1,1)},recreatePhysicalShapes:function(a){if(a.data.model){var b=this.createDebugMesh(a.data).mesh.vertexBuffer;this.updateCapsuleShape(a.data,b);CollisionCapsuleSystemImpl._super.recreatePhysicalShapes.call(this,a)}}});CollisionCylinderSystemImpl=function(){};CollisionCylinderSystemImpl=pc.inherits(CollisionCylinderSystemImpl,CollisionSystemImpl);CollisionCylinderSystemImpl.prototype=
pc.extend(CollisionCylinderSystemImpl.prototype,{createDebugMesh:function(a){if(a.model&&a.model.meshInstances&&a.model.meshInstances.length)return a.model.meshInstances[0];var b=this.system.context.graphicsDevice,c=new pc.gfx.VertexFormat(b,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),c=new pc.gfx.VertexBuffer(b,c,168,pc.gfx.BUFFER_DYNAMIC);this.updateCylinderShape(a,c);b=new pc.scene.Mesh;b.vertexBuffer=c;b.primitive[0].type=pc.gfx.PRIMITIVE_LINES;b.primitive[0].base=
0;b.primitive[0].count=c.getNumVertices();b.primitive[0].indexed=!1;this.material||(c=new pc.scene.BasicMaterial,c.color=new pc.Color(0,0,1,1),c.update(),this.material=c);return new pc.scene.MeshInstance(a.model.graph,b,this.material)},updateCylinderShape:function(a,b){var c="undefined"!==typeof a.axis?a.axis:1,d="undefined"!==typeof a.radius?a.radius:0.5,g="undefined"!==typeof a.height?a.height:1,f=new Float32Array(b.lock()),h=0,l=1,k=2;0===c?(h=1,l=0,k=2):2===c&&(h=0,l=2,k=1);var n=0,m;for(cap=
-1;2>cap;cap+=2)for(c=0;40>c;c++)m=2*Math.PI*(c/40),f[n+h]=d*Math.cos(m),f[n+l]=0.5*cap*g,f[n+k]=d*Math.sin(m),n+=3,m=2*Math.PI*((c+1)/40),f[n+h]=d*Math.cos(m),f[n+l]=0.5*cap*g,f[n+k]=d*Math.sin(m),n+=3;for(c=0;4>c;c++)m=2*Math.PI*(c/4),f[n+h]=d*Math.cos(m),f[n+l]=0.5*g,f[n+k]=d*Math.sin(m),n+=3,m=2*Math.PI*(c/4),f[n+h]=d*Math.cos(m),f[n+l]=0.5*-g,f[n+k]=d*Math.sin(m),n+=3;b.unlock()},createPhysicalShape:function(a,b){var c=null,c=null,d="undefined"!==typeof b.axis?b.axis:1,g="undefined"!==typeof b.radius?
b.radius:0.5,f="undefined"!==typeof b.height?b.height:1;if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btVector3(0.5*f,g,g);c=new Ammo.btCylinderShapeX(c);break;case 1:c=new Ammo.btVector3(g,0.5*f,g);c=new Ammo.btCylinderShape(c);break;case 2:c=new Ammo.btVector3(g,g,0.5*f),c=new Ammo.btCylinderShapeZ(c)}return c},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());c.setLocalScale(1,1,1)},recreatePhysicalShapes:function(a){if(a.data.model){var b=
this.createDebugMesh(a.data).mesh.vertexBuffer;this.updateCylinderShape(a.data,b);CollisionCylinderSystemImpl._super.recreatePhysicalShapes.call(this,a)}}});CollisionMeshSystemImpl=function(){this.hasDebugShape=!1};CollisionMeshSystemImpl=pc.inherits(CollisionMeshSystemImpl,CollisionSystemImpl);CollisionMeshSystemImpl.prototype=pc.extend(CollisionMeshSystemImpl.prototype,{beforeInitialize:function(){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var c=b.model,d=new Ammo.btCompoundShape,
g,f;for(g=0;g<c.meshInstances.length;g++){var h=c.meshInstances[g],l=h.mesh,k=l.indexBuffer[pc.scene.RENDERSTYLE_SOLID],n=l.vertexBuffer,m=n.getFormat(),r=m.size/4,w;for(f=0;f<m.elements.length;f++){var s=m.elements[f];s.name===pc.gfx.SEMANTIC_POSITION&&(w=new Float32Array(n.lock(),s.offset))}var k=new Uint16Array(k.lock()),n=l.primitive[0].count/3,m=new Ammo.btVector3,s=new Ammo.btVector3,G=new Ammo.btVector3,x,u,v=l.primitive[0].base,z=new Ammo.btTriangleMesh;for(f=0;f<n;f++)l=k[v+3*f]*r,x=k[v+
3*f+1]*r,u=k[v+3*f+2]*r,m.setValue(w[l],w[l+1],w[l+2]),s.setValue(w[x],w[x+1],w[x+2]),G.setValue(w[u],w[u+1],w[u+2]),z.addTriangle(m,s,G,!0);f=new Ammo.btBvhTriangleMeshShape(z,!0);r=h.node.getWorldTransform().getScale();f.setLocalScaling(new Ammo.btVector3(r.x,r.y,r.z));r=h.node.getPosition();h=h.node.getRotation();k=new Ammo.btTransform;k.setIdentity();k.getOrigin().setValue(r.x,r.y,r.z);r=new Ammo.btQuaternion;r.setValue(h.x,h.y,h.z,h.w);k.setRotation(r);d.addChildShape(k,f)}c=a.getWorldTransform().getScale();
g=new Ammo.btVector3;g.setValue(c.x,c.y,c.z);d.setLocalScaling(g);return d}},recreatePhysicalShapes:function(a){var b=a.data;null!==b.asset?this.loadModelAsset(a):(b.model=null,this.doRecreatePhysicalShape(a))},loadModelAsset:function(a){var b=a.data.asset,c=a.data,d={parent:a.entity.getRequest()},g=this.system.context.assets.getAssetById(b);g?g.resource?(c.model=g.resource,this.doRecreatePhysicalShape(a)):this.system.context.assets.load(g,[],d).then(function(b){c.model=b[0];this.doRecreatePhysicalShape(a)}.bind(this)):
logERROR(pc.string.format("Trying to load model before asset {0} is loaded.",b))},doRecreatePhysicalShape:function(a){var b=a.entity,c=a.data;c.model?(c.shape&&Ammo.destroy(c.shape),c.shape=this.createPhysicalShape(b,c),b.rigidbody?b.rigidbody.createBody():b.trigger?b.trigger.initialize(c):b.trigger=new pc.fw.Trigger(this.system.context,a,c)):this.remove(b,c)},updateTransform:function(a,b,c,d){if(a.shape){var g=a.entity.getWorldTransform().getScale(),f=a.shape.getLocalScaling();(g.x!==f.x()||g.y!==
f.y()||g.z!==f.z())&&this.doRecreatePhysicalShape(a)}CollisionMeshSystemImpl._super.updateTransform.call(this,a,b,c,d)}});return{CollisionComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);b.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this);a.on("beforeremove",this.onBeforeRemove,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{onSetType:function(a,
b,c){b!==c&&this.system.changeType(this,b,c)},onSetHalfExtents:function(){this.data.initialized&&"box"===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(){this.data.initialized&&("sphere"===this.data.type||"capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetHeight:function(){this.data.initialized&&("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAxis:function(){this.data.initialized&&
("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAsset:function(){this.data.initialized&&"mesh"===this.data.type&&this.system.recreatePhysicalShapes(this)},onEnable:function(){d._super.onEnable.call(this);this.entity.trigger?this.entity.trigger.enable():this.entity.rigidbody&&this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation()},onDisable:function(){d._super.onDisable.call(this);this.entity.trigger?this.entity.trigger.disable():
this.entity.rigidbody&&this.entity.rigidbody.disableSimulation()},onLiveLinkUpdateTransform:function(a,b,c){if(this.enabled&&this.entity.enabled)this.system.onTransformChanged(this,a,b,c)},onBeforeRemove:function(a,b){this===b&&(a.off("livelink:updatetransform",this.onLiveLinkUpdateTransform,this),this.system.off("beforeremove",this.onBeforeRemove,this))}});return{CollisionComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.type="box";this.halfExtents=new pc.Vec3(0.5,0.5,0.5);this.radius=0.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1},pc.fw.ComponentData);return{CollisionComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="ballsocketjoint";a.systems.add(this.id,this);this.ComponentType=pc.fw.BallSocketJointComponent;this.DataType=pc.fw.BallSocketJointComponentData;this.schema=[{name:"pivot",displayName:"Pivot",description:"Local space pivot",type:"vector",options:{min:0,step:0.1},defaultValue:[0,0,0]},{name:"position",displayName:"Position",description:"World space joint position",type:"vector",options:{min:0,step:0.1},defaultValue:[0,0,0]},{name:"tau",displayName:"Tau",
description:"TBD",type:"number",defaultValue:0.001,options:{min:0,max:1}},{name:"damping",displayName:"Damping",description:"Damping",type:"number",defaultValue:1,options:{min:0,max:1}},{name:"impulseClamp",displayName:"Impulse Clamp",description:"Impulse Clamp",type:"number",defaultValue:0,options:{min:0,max:100}},{name:"constraint",exposed:!1}];this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,
this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype=pc.extend(d.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.fw.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){"undefined"!==typeof Ammo&&a.entity.rigidbody&&(b.pivot&&"array"===pc.type(b.pivot)&&(b.pivot=new pc.Vec3(b.pivot[0],b.pivot[1],b.pivot[2])),b.position&&"array"===pc.type(b.position)&&(b.position=new pc.Vec3(b.position[0],b.position[1],b.position[2])),c=new Ammo.btVector3(b.pivot.x,
b.pivot.y,b.pivot.z),b.constraint=new Ammo.btPoint2PointConstraint(a.entity.rigidbody.body,c),c=b.constraint.getPivotInB(),b.position=[c.x(),c.y(),c.z()],this.context.systems.rigidbody.addConstraint(b.constraint));c="constraint pivot position tau damping impulseClamp".split(" ");d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){return this.addComponent(b,{pivot:[a.ballsocketjoint.pivot.x,a.ballsocketjoint.pivot.y,a.ballsocketjoint.pivot.z],position:[a.ballsocketjoint.position.x,
a.ballsocketjoint.position.y,a.ballsocketjoint.position.z],tau:a.ballsocketjoint.tau,damping:a.ballsocketjoint.damping,impulseClamp:a.ballsocketjoint.impulseClamp})},onRemove:function(a,b){b.constraint&&this.context.systems.rigidbody.removeConstraint(b.constraint)},setDebugRender:function(a){this.debugRender=a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b;for(b in a);}});return{BallSocketJointComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_pivot",this.onSetPivot,this);this.on("set_position",this.onSetPosition,this);this.on("set_tau",this.onSetTau,this);this.on("set_damping",this.onSetDamping,this);this.on("set_impulseClamp",this.onSetImpulseClamp,this)},pc.fw.Component);pc.extend(d.prototype,{onSetPivot:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&(a=new Ammo.btVector3(c.x,c.y,c.z),this.data.constraint.setPivotA(a))},onSetPosition:function(a,
b,c){"undefined"!==typeof Ammo&&this.data.constraint&&(a=new Ammo.btVector3(c.x,c.y,c.z),this.data.constraint.setPivotB(a))},onSetTau:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_tau(c)},onSetDamping:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_damping(c)},onSetImpulseClamp:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_impulseClamp(c)}});
return{BallSocketJointComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.pivot=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.tau=0.3;this.damping=1;this.impulseClamp=0;this.constraint=null},pc.fw.ComponentData);return{BallSocketJointComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="particlesystem";this.description="Updates and renders particle system in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.fw.ParticleSystemComponent;this.DataType=pc.fw.ParticleSystemComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"numParticles",displayName:"Particle count",description:"Total number of particles allocated",type:"number",
defaultValue:30,options:{min:1,max:4096,step:1}},{name:"lifetime",displayName:"Lifetime",description:"The lifetime of each particle in seconds",type:"number",defaultValue:5,options:{min:0,step:0.01}},{name:"rate",displayName:"Emission Rate",description:"Delay between emission of each particle in seconds",type:"number",defaultValue:0.1,options:{min:0,step:0.01}},{name:"rate2",displayName:"Emission Rate 2",description:"Defines the random range of Emission Rate",type:"number",defaultValue:0.1,options:{min:0,
step:0.01}},{name:"startAngle",displayName:"Start Angle",description:"The starting angle of each particle in degrees",type:"number",defaultValue:0,options:{min:0,step:0.01}},{name:"startAngle2",displayName:"Start Angle 2",description:"Defines the random range of Start Angle",type:"number",defaultValue:0,options:{min:0,step:0.01}},{name:"oneShot",displayName:"One Shot",description:"Disables looping",type:"boolean",defaultValue:!1},{name:"preWarm",displayName:"Pre Warm",description:"Starts particles in the middle of simulation",
type:"boolean",defaultValue:!1,filter:{oneShot:!1}},{name:"lighting",displayName:"Lighting",description:"Enables particle lighting; Only ambient and directional lights are used",type:"boolean",defaultValue:!1},{name:"halfLambert",displayName:"Half-Lambert",description:"Uses Half-Lambert shading instead of Lambert, for softer lighting.",type:"boolean",defaultValue:!1,filter:{lighting:!0}},{name:"intensity",displayName:"Color intensity",description:"Controls the intensity of the colors for each particle",
type:"number",defaultValue:1,options:{min:0,max:10,step:0.1}},{name:"depthTest",displayName:"Depth Test",description:"Enables hardware depth testing; don't use it for semi-transparent particles",type:"boolean",defaultValue:!1},{name:"depthSoftening",displayName:"Depth Softening",description:"Softens particle intersections with scene geometry",type:"number",defaultValue:0,options:{min:0,max:1,step:0.01}},{name:"sort",displayName:"Sorting Mode",description:"How to sort particles; Any value other than None will force CPU mode",
type:"enumeration",options:{enumerations:[{name:"None",value:pc.scene.PARTICLES_SORT_NONE},{name:"Camera Distance",value:pc.scene.PARTICLES_SORT_DISTANCE},{name:"Newer First",value:pc.scene.PARTICLES_SORT_NEWER_FIRST},{name:"Older First",value:pc.scene.PARTICLES_SORT_OLDER_FIRST}]},defaultValue:0},{name:"blendType",displayName:"Blending Mode",description:"How to blend particles",type:"enumeration",options:{enumerations:[{name:"Alpha",value:pc.scene.BLEND_NORMAL},{name:"Add",value:pc.scene.BLEND_ADDITIVE},
{name:"Multiply",value:pc.scene.BLEND_MULTIPLICATIVE}]},defaultValue:pc.scene.BLEND_NORMAL},{name:"stretch",displayName:"Stretch",description:"Stretch particles in the direction of motion",type:"number",defaultValue:0,options:{min:0,max:32,step:0.25}},{name:"spawnBounds",displayName:"Spawn Bounds",description:"Defines an AABB in which particles are allowed to spawn",type:"vector",defaultValue:[0,0,0]},{name:"wrap",displayName:"Wrap",description:"Set to true to wrap particles around the camera. Used for infinite atmospheric effect like rain or mist.",
type:"boolean",defaultValue:!1},{name:"wrapBounds",displayName:"Wrap Bounds",description:"AABB around to camera to wrap particles. Used for infinite atmospheric effect like rain or mist.",type:"vector",filter:{wrap:!0},defaultValue:[0,0,0]},{name:"colorMapAsset",displayName:"Color Map",description:"Color map used for each particle, with alpha channel",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"normalMapAsset",displayName:"Normal map",description:"Normal map used for each particle",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"mesh",displayName:"Particle mesh",description:"Mesh to use as particle; Will be quad, if not set",type:"asset",options:{max:1,type:"model"},defaultValue:null},{name:"localVelocityGraph",displayName:"Local Velocity",description:"Curves that define the local velocity of particles over time.",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,0],[0,0],[0,0]],betweenCurves:!1},options:{curveNames:["X","Y","Z"],secondCurve:"localVelocityGraph2"}},
{name:"localVelocityGraph2",displayName:"Local Velocity 2",description:"Curves that define the range of the Local Velocity",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,0],[0,0],[0,0]]},filter:{always:!1}},{name:"velocityGraph",displayName:"Velocity",description:"Curves that define the world velocity of particles over time.",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,-1],[0,-1],[0,-1]],betweenCurves:!0},options:{curveNames:["X","Y","Z"],secondCurve:"velocityGraph2"}},
{name:"velocityGraph2",displayName:"Velocity 2",description:"Curves that define the range of the Velocity",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,1],[0,1],[0,1]]},options:{curveNames:["X","Y","Z"]},filter:{always:!1}},{name:"rotationSpeedGraph",displayName:"Rotation Speed",description:"Curve that defines how fast particles rotate over time.",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0],betweenCurves:!1},options:{curveNames:["Angle"],secondCurve:"rotationSpeedGraph2",
verticalAxisValue:360}},{name:"rotationSpeedGraph2",displayName:"Rotation Speed 2",description:"Curve that defines the range of Rotation Speed",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0]},options:{curveNames:["Angle"],verticalAxisValue:360},filter:{always:!1}},{name:"scaleGraph",displayName:"Scale",description:"Curve that defines the scale of particles over time",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0.1],betweenCurves:!1},options:{curveNames:["Scale"],verticalAxisValue:1,
secondCurve:"scaleGraph2",min:0}},{name:"scaleGraph2",displayName:"Scale 2",description:"Curve that defines the range of Scale",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0.1]},options:{curveNames:["Scale"],verticalAxisValue:1,min:0},filter:{always:!1}},{name:"colorGraph",displayName:"Color",description:"Curves that define the color of particles over time",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,1],[0,1],[0,1]],betweenCurves:!1},options:{curveNames:["R","G",
"B"],max:1,min:0}},{name:"colorGraph2",displayName:"Color 2",description:"Curves that define the range of Color",exposed:!1,type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,1,1,1],[0,1,1,1],[0,1,1,1]]},options:{curveNames:["R","G","B"],max:1,min:0}},{name:"alphaGraph",displayName:"Opacity",description:"Curve that defines the opacity of particles over time",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,1],betweenCurves:!1},options:{curveNames:["Opacity"],max:1,min:0,secondCurve:"alphaGraph2"}},
{name:"alphaGraph2",displayName:"Opacity 2",description:"Curve that defines the range of Opacity",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,1]},options:{curveNames:["Opacity"],max:1,min:0},filter:{always:!1}},{name:"camera",exposed:!1},{name:"colorMap",exposed:!1},{name:"normalMap",exposed:!1}];this.exposeProperties();this.propertyTypes={};for(a=0;a<this.schema.length;a++){var b=this.schema[a];this.propertyTypes[b.name]=b.type}this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){var c=[],e=this.propertyTypes,g,f;for(f in b)b.hasOwnProperty(f)&&c.push(f),"vector"===e[f]?"array"===pc.type(b[f])&&(b[f]=new pc.Vec3(b[f][0],b[f][1],b[f][2])):"curve"===e[f]?b[f]instanceof pc.Curve||(g=b[f].type,b[f]=new pc.Curve(b[f].keys),b[f].type=g):"curveset"===e[f]&&!(b[f]instanceof pc.CurveSet)&&(g=b[f].type,b[f]=new pc.CurveSet(b[f].keys),b[f].type=g);d._super.initializeComponentData.call(this,
a,b,c)},cloneComponent:function(a,b){for(var c=a.particlesystem.data,d=this.schema,g={},f=0,h=d.length;f<h;f++){var l=d[f],k=c[l.name];k instanceof pc.Vec3||k instanceof pc.Curve||k instanceof pc.CurveSet?(k=k.clone(),g[l.name]=k):k&&(g[l.name]=k)}return this.addComponent(b,g)},onUpdate:function(a){var b=this.store,c,d;for(d in b)if(b.hasOwnProperty(d)){var g=b[d],f=g.data;if(f.enabled&&g.entity.enabled){var h=f.model.emitter,l=(f=f.camera)?f.camera:null;if(!f||!l||!l.enabled){if(!c&&(c=this.context.systems.camera.cameras[0]))c=
c.entity;g.entity.particlesystem.camera=c}h.addTime(a)}}},onRemove:function(a,b){b.model&&(this.context.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null)}});return{ParticleSystemComponentSystem:d}}());pc.extend(pc.fw,function(){var d=["spawnBounds","colorMap","normalMap","oneShot"],a="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthTest depthSoftening sort stretch preWarm camera".split(" "),b="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2".split(" "),c=function(){this.on("set_colorMapAsset",this.onSetColorMapAsset,
this);this.on("set_normalMapAsset",this.onSetNormalMapAsset,this);this.on("set_mesh",this.onSetMesh,this);this.on("set_oneShot",this.onSetOneShot,this);this.on("set_blendType",this.onSetBlendType,this);d.forEach(function(a){this.on("set_"+a,this.onSetSimpleProperty,this)}.bind(this));a.forEach(function(a){this.on("set_"+a,this.onSetComplexProperty,this)}.bind(this));b.forEach(function(a){this.on("set_"+a,this.onSetGraphProperty,this)}.bind(this))},c=pc.inherits(c,pc.fw.Component);pc.extend(c.prototype,
{onSetColorMapAsset:function(a,b,c){c?this._loadAsset(c,function(a){this.colorMap=a}.bind(this)):this.colorMap=null},onSetNormalMapAsset:function(a,b,c){c?this._loadAsset(c,function(a){this.normalMap=a}.bind(this)):this.normalMap=null},_loadAsset:function(a,b){var c=a instanceof pc.asset.Asset?a:this.system.context.assets.getAssetById(a);if(c)if(c.resource)b(c.resource);else{var d={parent:this.entity.getRequest()};this.system.context.assets.load(c,[],d).then(function(a){b(a[0])})}else logERROR(pc.string.format("Trying to load particle system before asset {0} is loaded.",
a))},onSetMesh:function(a,b,c){c?c instanceof pc.asset.Asset||"number"===pc.type(c)?this._loadAsset(c,function(a){this._onMeshChanged(a)}.bind(this)):this._onMeshChanged(c):this._onMeshChanged(null)},_onMeshChanged:function(a){a&&(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onSetOneShot:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetTime(),b&&!c&&(this.reset(),this.emitter.resetMaterial(),
this.enabled=!0,this.rebuild()))},onSetBlendType:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.material.blendType=c,this.emitter.resetMaterial(),this.rebuild())},onSetSimpleProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial())},onSetComplexProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.reset(),this.emitter.resetMaterial(),this.rebuild())},onSetGraphProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.rebuildGraphs(),
this.emitter.resetMaterial())},onEnable:function(){if(!this.emitter&&!this.system._inTools){if(!this.data.camera){var a=this.system.context.systems.camera.cameras[0];a&&(this.data.camera=a.entity)}this.emitter=new pc.scene.ParticleEmitter2(this.system.context.graphicsDevice,{numParticles:this.data.numParticles,spawnBounds:this.data.spawnBounds,wrap:this.data.wrap,wrapBounds:this.data.wrapBounds,lifetime:this.data.lifetime,rate:this.data.rate,rate2:this.data.rate2,startAngle:this.data.startAngle,startAngle2:this.data.startAngle2,
scaleGraph:this.data.scaleGraph,scaleGraph2:this.data.scaleGraph2,colorGraph:this.data.colorGraph,colorGraph2:this.data.colorGraph2,alphaGraph:this.data.alphaGraph,alphaGraph2:this.data.alphaGraph2,localVelocityGraph:this.data.localVelocityGraph,localVelocityGraph2:this.data.localVelocityGraph2,velocityGraph:this.data.velocityGraph,velocityGraph2:this.data.velocityGraph2,rotationSpeedGraph:this.data.rotationSpeedGraph,rotationSpeedGraph2:this.data.rotationSpeedGraph2,colorMap:this.data.colorMap,normalMap:this.data.normalMap,
oneShot:this.data.oneShot,preWarm:this.data.preWarm,sort:this.data.sort,stretch:this.data.stretch,lighting:this.data.lighting,halfLambert:this.data.halfLambert,intensity:this.data.intensity,depthSoftening:this.data.depthSoftening,camera:this.data.camera,scene:this.system.context.scene,mesh:this.data.mesh,depthTest:this.data.depthTest,node:this.entity,blendType:this.data.blendType});this.emitter.meshInstance.node=this.entity;this.psys=new pc.scene.Model;this.psys.graph=this.entity;this.psys.emitter=
this.emitter;this.psys.meshInstances=[this.emitter.meshInstance];this.data.model=this.psys;this.emitter.psys=this.psys;this.emitter.onFinished=function(){this.enabled=!1}.bind(this)}c._super.onEnable.call(this);this.data.model&&(this.system.context.scene.containsModel(this.data.model)||this.emitter.colorMap&&this.system.context.scene.addModel(this.data.model))},onDisable:function(){c._super.onDisable.call(this);this.data.model&&this.system.context.scene.containsModel(this.data.model)&&this.system.context.scene.removeModel(this.data.model)},
reset:function(){this.emitter.reset()},rebuild:function(){var a=this.enabled;this.enabled=!1;this.emitter.rebuild();this.emitter.meshInstance.node=this.entity;this.data.model.meshInstances=[this.emitter.meshInstance];this.enabled=a}});return{ParticleSystemComponent:c}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.rate=this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.spawnBounds=new pc.Vec3;this.wrapBounds=new pc.Vec3;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.preWarm=this.oneShot=!1;this.sort=0;this.mode="GPU";this.scene=this.camera=null;this.halfLambert=this.lighting=!1;this.intensity=1;this.depthSoftening=this.stretch=0;this.mesh=null;this.depthTest=!1;this.rotationSpeedGraph2=
this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=pc.scene.BLEND_NORMAL;this.model=null;this.enabled=!0},pc.fw.ComponentData);return{ParticleSystemComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this._destinations=[];this._callbacks={};this._linkid=(a||"")+"-"+pc.guid.create();this._listener=null;this._handler=this._handleMessage.bind(this);window.addEventListener("message",this._handler,!1);pc.livelinks||(pc.livelinks=[]);pc.livelinks.push(this)};d.prototype.detach=function(){this._listener=null;window.removeEventListener("message",this._handler,!1)};d.prototype.addDestinationWindow=function(a){this._destinations.push(a)};d.prototype.removeDestinationWindow=
function(a){var b;for(b=0;b<this._destinations.length;++b)if(this._destinations[b]==a){this._destinations.splice(b,1);break}};d.prototype.send=function(a,b){var b=b||function(){},c,d=this._destinations.length,g=[];for(c=0;c<d;c++){var f=this._destinations[c];f.closed?g.push(f):this._send(a,b,f,f.location.protocol+"//"+f.location.host)}d=g.length;for(c=0;c<d;c++)this.removeDestinationWindow(g[c])};d.prototype._send=function(a,b,c,d){a.senderid=this._linkid;this._callbacks[a.id]?this._callbacks[a.id].count++:
this._callbacks[a.id]={count:1,callback:b?b.bind(this):function(){}};var g=pc.fw.LiveLinkMessage.serialize(a);c===window?pc.livelinks.forEach(function(a){a._handleMessage({source:window,data:g})}):c.postMessage(g,d)};d.prototype.listen=function(a){if(this._listener)throw Error("LiveLink already listening");this._listener=a};d.prototype._handleMessage=function(a){var b,c;if(b=pc.fw.LiveLinkMessage.deserialize(a.data))b=new pc.fw.LiveLinkMessage(b,a.source),this._linkid!==b.senderid&&(b.type==pc.fw.LiveLinkMessageType.RECEIVED?
b.content.received_from==this._linkid&&(this._callbacks[b.content.id].count--,0===this._callbacks[b.content.id].count&&(this._callbacks[b.content.id].callback(),delete this._callbacks[b.content.id])):this._listener&&(this._listener(b),c=new pc.fw.LiveLinkMessage,c.type=pc.fw.LiveLinkMessageType.RECEIVED,c.content={id:b.id,received_from:b.senderid},this._send(c,null,a.source,a.origin)))};return{LiveLink:d}}());pc.extend(pc.fw,function(){var d=function(a,b){a=a||{};this.type=a.type||pc.fw.LiveLinkMessageType.NO_TYPE;this.content=a.content||{};this.id=a.id||pc.guid.create();this.senderid=a.senderid||null;this.source=b||null};d.register=function(a){pc.fw.LiveLinkMessageType[a]=a};d.serialize=function(a){return JSON.stringify({type:a.type,content:a.content,id:a.id,senderid:a.senderid},function(a){return this[a]instanceof Float32Array?pc.makeArray(this[a]):this[a]})};d.deserialize=function(a){try{return JSON.parse(a)}catch(b){return null}};
return{LiveLinkMessage:d,LiveLinkMessageRegister:{},LiveLinkMessageType:{NO_TYPE:"NO_TYPE",RECEIVED:"RECEIVED"}}}());pc.extend(pc.fw,function(){var d=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.UPDATE_COMPONENT;this.content={id:a,component:b,attribute:c,value:d}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_COMPONENT");return{LiveLinkUpdateComponentMessage:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY;this.content={id:a,components:b}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY");var a=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_TRANSFORM;this.content={id:a,position:b,rotation:c,scale:d}},a=pc.inherits(a,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_TRANSFORM");var b=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_NAME;
this.content={id:a,name:b}},b=pc.inherits(b,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_NAME");var c=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_ENABLED;this.content={id:a,enabled:b}},c=pc.inherits(c,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_ENABLED");var e=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.REPARENT_ENTITY;this.content={id:a,oldParentId:b,newParentId:c,index:d}},e=pc.inherits(e,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("REPARENT_ENTITY");
return{LiveLinkUpdateEntityMessage:d,LiveLinkUpdateEntityNameMessage:b,LiveLinkUpdateEntityEnabledMessage:c,LiveLinkUpdateEntityTransformMessage:a,LiveLinkReparentEntityMessage:e}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.CLOSE_ENTITY;this.content={id:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("CLOSE_ENTITY");return{LiveLinkCloseEntityMessage:d}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.OPEN_ENTITY;this.content={entity:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("OPEN_ENTITY");var a=function(a,c){this.type=pc.fw.LiveLinkMessageType.OPEN_PACK;this.content={pack:pc.extend({},c.getData())};this.content.pack.hierarchy=PCD.model.Entity.toData(a)},a=pc.inherits(a,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("OPEN_PACK");return{LiveLinkOpenEntityMessage:d,LiveLinkOpenPackMessage:a}}());pc.extend(pc.fw,function(){var d=function(a,b,c){this.type=pc.fw.LiveLinkMessageType.UPDATE_ASSET;this.content={id:a,attribute:b,value:c}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ASSET");return{LiveLinkUpdateAssetMessage:d}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.UPDATE_PACK_SETTINGS;this.content={settings:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_PACK_SETTINGS");return{LiveLinkUpdatePackSettings:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ASSETCACHE;this.content={assets:a,deleted:b}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ASSETCACHE");return{LiveLinkUpdateAssetCacheMessage:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this._guid=pc.guid.create();this._batchHandle=null;this.c={};pc.events.attach(this)},pc.scene.GraphNode);d.prototype.getGuid=function(){return this._guid};d.prototype.setGuid=function(a){this._guid=a};d.prototype._onHierarchyStateChanged=function(a){pc.fw.Entity._super._onHierarchyStateChanged.call(this,a);var b,c=this.c;for(type in c)if(c.hasOwnProperty(type)&&(b=c[type],b.enabled))if(a)b.onEnable();else b.onDisable()};d.prototype.setRequest=
function(a){this._request=a};d.prototype.getRequest=function(){return this._request};d.prototype.addChild=function(a){if(a instanceof pc.fw.Entity&&this.getRoot().findOne("getGuid",a.getGuid()))throw Error("GUID already exists in graph");pc.scene.GraphNode.prototype.addChild.call(this,a)};d.prototype.findByGuid=function(a){if(this._guid===a)return this;for(var b=0;b<this._children.length;b++)if(this._children[b].findByGuid){var c=this._children[b].findByGuid(a);if(null!==c)return c}return null};d.prototype.destroy=
function(){var a=this.getParent(),b;for(b in this.c)this.c[b].enabled=!1;for(b in this.c)this.c[b].system.removeComponent(this);a&&a.removeChild(this);a=this.getChildren();for(b=a.shift();b;)b instanceof pc.fw.Entity&&b.destroy(),b=a.shift()};d.prototype.clone=function(){var a,b=new pc.fw.Entity;pc.fw.Entity._super._cloneInternal.call(this,b);for(a in this.c)this.c[a].system.cloneComponent(this,b);for(a=0;a<this.getChildren().length;a++){var c=this.getChildren()[a];c instanceof pc.fw.Entity&&b.addChild(c.clone())}return b};
d.deserialize=function(a){var b=pc.json.parse(a.template),c=pc.json.parse(a.parent),d=pc.json.parse(a.children),g=pc.json.parse(a.transform),f=pc.json.parse(a.components),h=pc.json.parse(a.labels);return{_id:a._id,resource_id:a.resource_id,_rev:a._rev,name:a.name,enabled:a.enabled,labels:h,template:b,parent:c,children:d,transform:g,components:f}};d.serialize=function(a){var b={_id:a._id,resource_id:a.resource_id,name:a.name,enabled:a.enabled,labels:pc.json.stringify(a.labels),template:pc.json.stringify(a.template),
parent:pc.json.stringify(a.parent),children:pc.json.stringify(a.children),transform:pc.json.stringify(a.transform),components:pc.json.stringify(a.components)};a._rev&&(b._rev=a._rev);return b};return{Entity:d}}());pc.asset={};
pc.extend(pc.asset,function(){var d=-1,a=function(a,c,e,g,f){this._id=++d;this.name=a;this.type=c;this.file=e?{filename:e.filename,size:e.size,hash:e.hash,url:e.url}:null;this.data=g||{};this.prefix=f||"";this.resource=null;pc.events.attach(this)};a.prototype={getFileUrl:function(){if(!this.file)return null;var a=this.file.url,c="";this.prefix&&(c=this.prefix);return pc.path.join(c,a)}};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},set:function(a){this._id=a;a>d&&(d=a)}});
return{Asset:a,ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture"}}());pc.extend(pc.asset,function(){var d=function(a,b){if(!a)throw Error("Must provide a ResourceLoader instance for AssetRegistry");this.loader=a;this._prefix=b||"";this._cache={};this._names={};this._urls={};this._groups={}};d.prototype={addGroup:function(a,b){this._groups[a]||(this._groups[a]=[]);for(var c in b.assets){var d=this.getAssetById(c);d?pc.extend(d,b.assets[c]):d=this.createAndAddAsset(c,b.assets[c]);this._groups[a].push(d.id)}},createAndAddAsset:function(a,b){var c=new pc.asset.Asset(b.name,
b.type,b.file,b.data,this._prefix);c.id=a;this.addAsset(c);c.file&&this.loader.registerHash(c.file.hash,c.getFileUrl());return c},all:function(){return Object.keys(this._cache).map(function(a){return this.getAssetById(a)},this)},list:function(a){if(a){if(this._groups[a])return this._groups[a].map(function(a){return this.getAssetById(a)},this)}else return Object.keys(this._cache).map(function(a){return this.getAssetById(a)},this)},addAsset:function(a){this._cache[a.id]=a;this._names[a.name]||(this._names[a.name]=
[]);this._names[a.name].push(a.id);a.file&&(this._urls[a.file.url]=a.id)},removeAsset:function(a){delete this._cache[a.id];delete this._names[a.name];a.file&&delete this._urls[a.file.url]},findAll:function(a,b){var c=this,d=this._names[a];return d?(d=d.map(function(a){return c._cache[a]}),b?d.filter(function(a){return a.type===b}):d):[]},find:function(a,b){var c=this.findAll(a,b);return c?c[0]:null},getAssetByResourceId:function(a){console.warn("WARNING: getAssetByResourceId: Function is deprecated. Use getAssetById() instead.");
return this._cache[a]},getAssetById:function(a){return this._cache[a]},getAssetByUrl:function(a){return this._cache[this._urls[a]]},getAssetByName:function(a){console.warn("WARNING: getAssetByName: Function is deprecated. Use find() or findAll() instead.");return this.find(a)},load:function(a,b,c){a&&!a.length&&(a=[a]);"undefined"===typeof c&&(c=b,b=[]);var d=[];a.forEach(function(a,c){this.getAssetById(a.id)||this.addAsset(a);switch(a.type){case pc.asset.ASSET_MODEL:d.push(this._createModelRequest(a));
break;case pc.asset.ASSET_TEXTURE:d.push(this._createTextureRequest(a,b[c]));break;case pc.asset.ASSET_MATERIAL:d.push(this._createMaterialRequest(a));break;default:d.push(this._createAssetRequest(a))}},this);return this.loader.request(d.filter(function(a){return null!==a}),c).then(function(b){return new pc.promise.Promise(function(c){var h=0;d.forEach(function(c,d){c&&(a[d].resource=b[h++])});c(b)})},function(a){setTimeout(function(){throw a;},0)})},loadFromUrl:function(a,b){if(!b)throw Error("type required");
if("model"===b)return this._loadModel(a);pc.path.getDirectory(a);var c=pc.path.getBasename(a).replace(".json",""),d=new pc.asset.Asset(c,b,{url:a});return new pc.promise.Promise(function(a){this.load(d).then(function(b){a({resource:b,asset:d})})}.bind(this))},_loadModel:function(a){var b=this,c=pc.path.getDirectory(a),d=pc.path.getBasename(a),g=d.replace(".json",""),d=pc.path.join(c,d.replace(".json",".mapping.json")),f=new pc.asset.Asset(g,"model",{url:a}),h=new pc.asset.Asset(g+".mapping","json",
{url:d});return new pc.promise.Promise(function(a){b.load([f,h]).then(function(d){var e=d[0],d=d[1];f.data=d;var g=[];d.mapping.forEach(function(a){g.push(new pc.asset.Asset(pc.path.getBasename(a.path),"material",{url:pc.path.join(c,a.path)}))});if(g.length)return d=b.load(g),d.then(function(b){for(var c=0,d=e.meshInstances.length;c<d;c++)e.meshInstances[c].material=b[c];a({resource:e,asset:f})}),d;a({resource:e,asset:f})})})},_createAssetRequest:function(a){var b=a.getFileUrl();return b?this.loader.createFileRequest(b,
a.type):null},_createModelRequest:function(a){var b=a.getFileUrl();return new pc.resources.ModelRequest(b,a.data&&a.data.mapping?a.data.mapping:[])},_createTextureRequest:function(a,b){return new pc.resources.TextureRequest(a.getFileUrl(),null,b)},_createMaterialRequest:function(a){var b=a.getFileUrl();return b?new pc.resources.MaterialRequest(b):new pc.resources.MaterialRequest("asset://"+a.id)}};return{AssetRegistry:d}}());!function(d){var a,b,c={},e={};a=function(a,b,d){c[a]={deps:b,callback:d}};b=function(a){function d(b){if("."!==b.charAt(0))return b;for(var b=b.split("/"),c=a.split("/").slice(0,-1),e=0,f=b.length;f>e;e++){var h=b[e];".."===h?c.pop():"."!==h&&c.push(h)}return c.join("/")}if(e[a])return e[a];if(e[a]={},!c[a])throw Error("Could not find module "+a);for(var h,l=c[a],k=l.deps,l=l.callback,n=[],m=0,r=k.length;r>m;m++)n.push("exports"===k[m]?h={}:b(d(k[m])));k=l.apply(this,n);return e[a]=h||k};b.entries=
c;!0;a("rsvp/all-settled",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isArray,n=b.isNonThenable;c["default"]=function(a,b){return new d(function(b){function c(a){return function(b){g(a,{state:"fulfilled",value:b})}}function f(a){return function(b){g(a,{state:"rejected",reason:b})}}function g(a,c){z[a]=c;0===--r&&b(z)}if(!e(a))throw new TypeError("You must pass an array to allSettled.");var h,r=a.length;if(0===r)return void b([]);for(var z=Array(r),A=0;A<a.length;A++)h=
a[A],n(h)?g(A,{state:"fulfilled",value:h}):d.resolve(h).then(c(A),f(A))},b)}});a("rsvp/all",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.all(a,b)}});a("rsvp/asap",["exports"],function(a){function b(){for(var a=0;a<d.length;a++){var c=d[a];(0,c[0])(c[1])}d.length=0}a["default"]=function(a,b){1===d.push([a,b])&&c()};var c,a="undefined"!=typeof window?window:{},a=a.MutationObserver||a.WebKitMutationObserver,d=[];if("undefined"!=typeof process&&"[object process]"===
{}.toString.call(process))a=function(){process.nextTick(b)};else if(a)var e=0,a=new a(b),n=document.createTextNode(""),a=(a.observe(n,{characterData:!0}),function(){n.data=e=++e%2});else a=function(){setTimeout(b,1)};c=a});a("rsvp/config",["./events","exports"],function(a,b){var c={instrument:!1};a["default"].mixin(c);b.config=c;b.configure=function(a,b){return"onerror"===a?void c.on("error",b):2!==arguments.length?c[a]:void(c[a]=b)}});a("rsvp/defer",["./promise","exports"],function(a,b){var c=a["default"];
b["default"]=function(a){var b={};return b.promise=new c(function(a,c){b.resolve=a;b.reject=c},a),b}});a("rsvp/events",["exports"],function(a){function b(a,c){for(var d=0,e=a.length;e>d;d++)if(a[d]===c)return d;return-1}function c(a){var b=a._promiseCallbacks;return b||(b=a._promiseCallbacks={}),b}a["default"]={mixin:function(a){return a.on=this.on,a.off=this.off,a.trigger=this.trigger,a._promiseCallbacks=void 0,a},on:function(a,d){var e,g=c(this);(e=g[a])||(e=g[a]=[]);-1===b(e,d)&&e.push(d)},off:function(a,
d){var e,g,r=c(this);return d?(e=r[a],g=b(e,d),void(-1!==g&&e.splice(g,1))):void(r[a]=[])},trigger:function(a,b){var d;if(d=c(this)[a])for(var e=0;e<d.length;e++)(0,d[e])(b)}}});a("rsvp/filter",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isFunction;c["default"]=function(a,b,c){return d.all(a,c).then(function(a){if(!e(b))throw new TypeError("You must pass a function as filter's second argument.");for(var f=a.length,g=Array(f),h=0;f>h;h++)g[h]=b(a[h]);return d.all(g,c).then(function(b){for(var c=
Array(f),d=0,e=0;f>e;e++)!0===b[e]&&(c[d]=a[e],d++);return c.length=d,c})})}});a("rsvp/hash-settled",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isNonThenable,n=b.keysOf;c["default"]=function(a){return new d(function(b){function c(a){return function(b){g(a,{state:"fulfilled",value:b})}}function f(a){return function(b){g(a,{state:"rejected",reason:b})}}function g(a,c){v[a]=c;0===--A&&b(v)}var h,u,v={},z=n(a),A=z.length;if(0===A)return void b(v);for(var C=0;C<z.length;C++)u=
z[C],h=a[u],e(h)?g(u,{state:"fulfilled",value:h}):d.resolve(h).then(c(u),f(u))})}});a("rsvp/hash",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isNonThenable,n=b.keysOf;c["default"]=function(a){return new d(function(b,c){function f(a){return function(c){v[a]=c;0===--A&&b(v)}}function g(a){A=0;c(a)}var h,u,v={},z=n(a),A=z.length;if(0===A)return void b(v);for(var C=0;C<z.length;C++)u=z[C],h=a[u],e(h)?(v[u]=h,0===--A&&b(v)):d.resolve(h).then(f(u),g)})}});a("rsvp/instrument",
["./config","./utils","exports"],function(a,b,c){var d=a.config,e=b.now;c["default"]=function(a,b,c){try{d.trigger(a,{guid:b._guidKey+b._id,eventName:a,detail:b._detail,childGuid:c&&b._guidKey+c._id,label:b._label,timeStamp:e(),stack:Error(b._label).stack})}catch(f){setTimeout(function(){throw f;},0)}}});a("rsvp/map",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=(b.isArray,b.isFunction);c["default"]=function(a,b,c){return d.all(a,c).then(function(a){if(!e(b))throw new TypeError("You must pass a function as map's second argument.");
for(var f=a.length,g=Array(f),h=0;f>h;h++)g[h]=b(a[h]);return d.all(g,c)})}});a("rsvp/node",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isArray;c["default"]=function(a,b){function c(){for(var e=arguments.length,h=Array(e),k=0;e>k;k++)h[k]=arguments[k];var r;return f||g||!b?r=this:(console.warn('Deprecation: RSVP.denodeify() doesn\'t allow setting the "this" binding anymore. Use yourFunction.bind(yourThis) instead.'),r=b),d.all(h).then(function(c){return new d(function(d,
e){c.push(function(){for(var a=arguments.length,c=Array(a),h=0;a>h;h++)c[h]=arguments[h];a=c[0];h=c[1];if(a)e(a);else if(f)d(c.slice(1));else if(g){for(var a={},k=c.slice(1),h=0;h<b.length;h++)c=b[h],a[c]=k[h];d(a)}else d(h)});a.apply(r,c)})})}var f=!0===b,g=e(b);return c.__proto__=a,c}});a("rsvp/promise","./config ./events ./instrument ./utils ./promise/cast ./promise/all ./promise/race ./promise/resolve ./promise/reject exports".split(" "),function(a,b,c,d,e,n,m,r,w,s){function G(){}function x(a,
b){if(!D(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof x))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._id=J++;this._label=b;this._subscribers=[];y.instrument&&B("created",this);if(G!==a){var c=this,d=function(a){A(c,a)},e=function(a){H(c,a)};try{a(d,e)}catch(f){e(f)}}}function u(a,b){var c,d,e=a._subscribers,f=a._detail;
y.instrument&&B(b===P?"fulfilled":"rejected",a);for(var g=0;g<e.length;g+=3)c=e[g],d=e[g+b],v(b,c,d,f);a._subscribers=null}function v(a,b,c,d){var e,f,g,h,k=D(c);if(k)try{e=c(d),g=!0}catch(l){h=!0,f=l}else e=d,g=!0;z(b,e)||(k&&g?A(b,e):h?H(b,f):a===P?A(b,e):a===M&&H(b,e))}function z(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(K(b)&&(d=b.then,D(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?A(a,d):C(a,d)))},function(b){return c?
!0:(c=!0,void H(a,b))},"Settle: "+(a._label||" unknown promise")),!0}catch(e){return c?!0:(H(a,e),!0)}return!1}function A(a,b){a===b?C(a,b):z(a,b)||C(a,b)}function C(a,b){a._state===F&&(a._state=L,a._detail=b,y.async(E,a))}function H(a,b){a._state===F&&(a._state=L,a._detail=b,y.async(I,a))}function E(a){u(a,a._state=P)}function I(a){a._onerror&&a._onerror(a._detail);u(a,a._state=M)}var y=a.config,B=(b["default"],c["default"]),K=d.objectOrFunction,D=d.isFunction,a=d.now,e=e["default"],n=n["default"],
m=m["default"],r=r["default"],w=w["default"],a="rsvp_"+a()+"-",J=0;s["default"]=x;x.cast=e;x.all=n;x.race=m;x.resolve=r;x.reject=w;var F=void 0,L=0,P=1,M=2;x.prototype={constructor:x,_id:void 0,_guidKey:a,_label:void 0,_state:void 0,_detail:void 0,_subscribers:void 0,_onerror:function(a){y.trigger("error",a)},then:function(a,b,c){var d=this;this._onerror=null;var e=new this.constructor(G,c);if(this._state){var f=arguments;y.async(function(){v(d._state,e,f[d._state-1],d._detail)})}else{var g=this._subscribers,
h=g.length;g[h]=e;g[h+P]=a;g[h+M]=b}return y.instrument&&B("chained",d,e),e},"catch":function(a,b){return this.then(null,a,b)},"finally":function(a,b){var c=this.constructor;return this.then(function(b){return c.resolve(a()).then(function(){return b})},function(b){return c.resolve(a()).then(function(){throw b;})},b)}}});a("rsvp/promise/all",["../utils","exports"],function(a,b){var c=a.isArray,d=a.isNonThenable;b["default"]=function(a,b){var e=this;return new e(function(b,f){function g(a){return function(c){v[a]=
c;0===--u&&b(v)}}function n(a){u=0;f(a)}if(!c(a))throw new TypeError("You must pass an array to all.");var x,u=a.length,v=Array(u);if(0===u)return void b(v);for(var z=0;z<a.length;z++)x=a[z],d(x)?(v[z]=x,0===--u&&b(v)):e.resolve(x).then(g(z),n)},b)}});a("rsvp/promise/cast",["exports"],function(a){a["default"]=function(a,b){return a&&"object"==typeof a&&a.constructor===this?a:new this(function(b){b(a)},b)}});a("rsvp/promise/race",["../utils","exports"],function(a,b){var c=a.isArray,d=(a.isFunction,
a.isNonThenable);b["default"]=function(a,b){var e,f=this;return new f(function(b,g){function n(a){u&&(u=!1,b(a))}function x(a){u&&(u=!1,g(a))}if(!c(a))throw new TypeError("You must pass an array to race.");for(var u=!0,v=0;v<a.length;v++){if(e=a[v],d(e))return u=!1,void b(e);f.resolve(e).then(n,x)}},b)}});a("rsvp/promise/reject",["exports"],function(a){a["default"]=function(a,b){return new this(function(b,c){c(a)},b)}});a("rsvp/promise/resolve",["exports"],function(a){a["default"]=function(a,b){return a&&
"object"==typeof a&&a.constructor===this?a:new this(function(b){b(a)},b)}});a("rsvp/race",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.race(a,b)}});a("rsvp/reject",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.reject(a,b)}});a("rsvp/resolve",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.resolve(a,b)}});a("rsvp/rethrow",["exports"],function(a){a["default"]=function(a){throw setTimeout(function(){throw a;
}),a;}});a("rsvp/utils",["exports"],function(a){function b(a){return"function"==typeof a||"object"==typeof a&&null!==a}a.objectOrFunction=b;a.isFunction=function(a){return"function"==typeof a};a.isNonThenable=function(a){return!b(a)};a.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};a.now=Date.now||function(){return(new Date).getTime()};a.keysOf=Object.keys||function(a){var b=[],c;for(c in a)b.push(c);return b}});a("rsvp","./rsvp/promise ./rsvp/events ./rsvp/node ./rsvp/all ./rsvp/all-settled ./rsvp/race ./rsvp/hash ./rsvp/hash-settled ./rsvp/rethrow ./rsvp/defer ./rsvp/config ./rsvp/map ./rsvp/resolve ./rsvp/reject ./rsvp/filter ./rsvp/asap exports".split(" "),
function(a,b,c,d,e,n,m,r,w,s,G,x,u,v,z,A,C){function H(){E.on.apply(E,arguments)}var a=a["default"],b=b["default"],c=c["default"],d=d["default"],e=e["default"],n=n["default"],m=m["default"],r=r["default"],w=w["default"],s=s["default"],E=G.config,G=G.configure,x=x["default"],u=u["default"],v=v["default"],z=z["default"];if(E.async=A["default"],"undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){A=window.__PROMISE_INSTRUMENTATION__;G("instrument",!0);for(var I in A)A.hasOwnProperty(I)&&
H(I,A[I])}C.Promise=a;C.EventTarget=b;C.all=d;C.allSettled=e;C.race=n;C.hash=m;C.hashSettled=r;C.rethrow=w;C.defer=s;C.denodeify=c;C.configure=G;C.on=H;C.off=function(){E.off.apply(E,arguments)};C.resolve=u;C.reject=v;C.async=function(a,b){E.async(a,b)};C.map=x;C.filter=z});d.RSVP=b("rsvp")}(window);pc.promise={Promise:window.RSVP.Promise,all:window.RSVP.all};
